<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Image - Crow&#039;s Sky</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Crow&#039;s Sky"><meta name="msapplication-TileImage" content="/img/avatarCircle.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Crow&#039;s Sky"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="内存所在位置Android 2.3 之前： 像素数据存在于native heap Android 3.0 ~ 7.1 之间： 存在于 java heap Android 8.0及之后： 存在于 native"><meta property="og:type" content="blog"><meta property="og:title" content="Image"><meta property="og:url" content="http://example.com/2021/04/01/Image/"><meta property="og:site_name" content="Crow&#039;s Sky"><meta property="og:description" content="内存所在位置Android 2.3 之前： 像素数据存在于native heap Android 3.0 ~ 7.1 之间： 存在于 java heap Android 8.0及之后： 存在于 native"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://example.com/2021/04/01/Image/image-20210930160022162.png"><meta property="og:image" content="http://example.com/2021/04/01/Image/image-20210410163522383.png"><meta property="og:image" content="http://example.com/2021/04/01/Image/image-20240304153838146.png"><meta property="og:image" content="http://example.com/2021/04/01/Image/399c21524077499b8b4c00f83f3f661e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp"><meta property="og:image" content="http://example.com/2021/04/01/Image/de2fdade2e8a4f2eb0b1214882399171~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp"><meta property="og:image" content="http://example.com/2021/04/01/Image/d66d017272944d00ac139e76cf248bf9~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp"><meta property="og:image" content="http://example.com/2021/04/01/Image/f77c83ea9be641a3980c1fbc8cdba29e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp"><meta property="og:image" content="http://example.com/2021/04/01/Image/21d875f249ed454c9093a8c022c25a68~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp"><meta property="og:image" content="http://example.com/2021/04/01/Image/f06b520447834d7db853af3c81294725~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp"><meta property="og:image" content="http://example.com/2021/04/01/Image/bb894daa906547cc9019736038850bd8~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp"><meta property="og:image" content="http://example.com/2021/04/01/Image/1643ee89153b6c59~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp"><meta property="og:image" content="http://example.com/2021/04/01/Image/gif_file_stream.gif"><meta property="og:image" content="http://example.com/2021/04/01/Image/sample_1.gif"><meta property="og:image" content="http://example.com/2021/04/01/Image/sample_1_enlarged.gif"><meta property="article:published_time" content="2021-04-01T13:52:19.000Z"><meta property="article:modified_time" content="2024-03-25T07:35:03.259Z"><meta property="article:author" content="White Crow"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2021/04/01/Image/image-20210930160022162.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/04/01/Image/"},"headline":"Image","image":["http://example.com/2021/04/01/Image/image-20210930160022162.png","http://example.com/2021/04/01/Image/image-20210410163522383.png","http://example.com/2021/04/01/Image/image-20240304153838146.png","http://example.com/2021/04/01/Image/gif_file_stream.gif","http://example.com/2021/04/01/Image/sample_1.gif","http://example.com/2021/04/01/Image/sample_1_enlarged.gif"],"datePublished":"2021-04-01T13:52:19.000Z","dateModified":"2024-03-25T07:35:03.259Z","author":{"@type":"Person","name":"white crow"},"publisher":{"@type":"Organization","name":"Crow's Sky","logo":{"@type":"ImageObject","url":"http://example.com/img/avatarCircle.png"}},"description":"内存所在位置Android 2.3 之前： 像素数据存在于native heap Android 3.0 ~ 7.1 之间： 存在于 java heap Android 8.0及之后： 存在于 native"}</script><link rel="canonical" href="http://example.com/2021/04/01/Image/"><link rel="icon" href="/img/avatarCircle.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/WhileCrow"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-10-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-04-01T13:52:19.000Z" title="4/1/2021, 9:52:19 PM">2021-04-01</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-03-25T07:35:03.259Z" title="3/25/2024, 3:35:03 PM">2024-03-25</time></span><span class="level-item"><a class="link-muted" href="/categories/Android/">Android</a><span> / </span><a class="link-muted" href="/categories/Android/Other/">Other</a></span><span class="level-item">25 minutes read (About 3775 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Image</h1><div class="content"><h1 id="内存所在位置"><a href="#内存所在位置" class="headerlink" title="内存所在位置"></a>内存所在位置</h1><p>Android 2.3 之前： 像素数据存在于native heap</p>
<p>Android 3.0 ~ 7.1 之间： 存在于 java heap</p>
<p>Android 8.0及之后： 存在于 native</p>
 <span id="more"></span>

<p>为什么 2.3.3 ~ 7.0 要放到 Java 堆? 直接放到 Native 中, 然后在 Java 对象 finalize 调用的时候释放不行吗?</p>
<ul>
<li>Java 层的 Bitmap 对象是一个壳, 非常小, 因此有可能会出现 Native 堆快到了 3G, Java 堆才 10 MB, 10MB 是无法触发 Dalvik GC 的, 因此这个 java 对象的 finalize 并非那么容易调用, 因此可能会出现 Native 堆 OOM 的情况, 故需要我们手动 recycle</li>
<li>像素数据直接放置到 Java 堆, Java 堆就能直接统计到真正的内存数据, 能够根据内存使用情况准确触发 GC 回收数据<ul>
<li>隐患便是 Java 堆内存空间比较小, 容器造成 Java 堆的 OOM</li>
</ul>
</li>
</ul>
<p>为什么 8.0 又放置到了 Native 堆中?</p>
<ul>
<li>使用 NativeAllocationRegistry 解决了这个问题, 触发 ART 堆 GC 的条件不仅仅是堆占用不足, 通过 VMRuntime.registerNativeAllocation 注册的 Native 内存累计超过了阈值(4MB)之后时也会触发 GC</li>
<li>而且 ART 的 GC 性能比 Dalvik 好的多, 不会轻易造成主线程卡顿</li>
</ul>
<h2 id="bitmap怎么释放："><a href="#bitmap怎么释放：" class="headerlink" title="bitmap怎么释放："></a>bitmap怎么释放：</h2><p>在 Android 2.3.3 之前开发者必须手动调用 recycle 方法去释放 Native 内存，因为那个时候管理<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Bitmap">Bitmap</a>内存比较复杂,需要手动维护引用计数器</p>
<p>android6及之前：Bitmap 的内存回收主要是通过 BitmapFinalizer 来完成的，通过覆盖**finalize()**中调用native的析构函数来释放native内存。</p>
<p>Android8及之后：会在 new Bitmap 时会注册 native 的 Finalizer 方法<code>NativeAllocationRegistry.registerNativeAllocation</code></p>
<p>其实无论是 Android M 前还是之后，释放 Native 层的 Bitmap 对象的思想都是去监听 Java 层的 Bitmap 是否被释放，一旦当 Java 层的 Bitmap 对象被释放则立即去释放 Native 层的 Bitmap 。只不过 Android M 前是基于 Java 的 GC 机制和finalize()，而 Android M 后是注册 native 的 Finalizer 方法。</p>
<p>其中 Fresco 可以留用匿名共享内存 ，在5.0之前像素存在于java heap上时，将像素优化至 <strong>Ashmem 匿名共享内存上（近似native）</strong></p>
<p><img src="/2021/04/01/Image/image-20210930160022162.png" alt="image-20210930160022162"></p>
<p> <strong>Android 哪个版本之前AS可以在profiler中预览图片</strong></p>
<p><strong>The “view bitmap” feature is still there (for Android 5.0 to 7.1)</strong></p>
<p>因为profiler 分析的 hprof 中，在8.0版本前，bitmap是存在java heap中的，但是由于8.0之后bitmap回到了native heap，而hprof只分析java heap，故而只能在<strong>Android 5.0 to 7.1中使用view bitmap</strong></p>
<h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h3><p>2.3之前的像素存储需要的内存是在native上分配的，并且生命周期不太可控，可能需要用户自己回收。 2.3-7.1之间，Bitmap的像素存储在Dalvik的Java堆上，</p>
<p>当然，4.4之前的甚至能在匿名共享内存上分配（Fresco采用），而8.0之后的像素内存又重新回到native上去分配，<strong>不需要用户主动回收</strong>，8.0之后图像资源的管理更加优秀，极大降低了OOM。</p>
<h1 id="图片内存尺寸"><a href="#图片内存尺寸" class="headerlink" title="图片内存尺寸"></a>图片内存尺寸</h1><h2 id="尺寸计算："><a href="#尺寸计算：" class="headerlink" title="尺寸计算："></a>尺寸计算：</h2><p><img src="/2021/04/01/Image/image-20210410163522383.png" alt="image-20210410163522383"></p>
<p>//PS： 小米8UD 系统赋的dpi为440（计算值401），density为2.75（计算值为2.5）</p>
<h2 id="mipmap图片资源计算"><a href="#mipmap图片资源计算" class="headerlink" title="mipmap图片资源计算"></a>mipmap图片资源计算</h2><blockquote>
<p>inDensity表示该资源来源于哪个密度的文件夹，该值从TypedValue获取；   </p>
<p>inTargetDensity表示该资源将要显示在哪个密度的设备上。</p>
</blockquote>
<p><strong>needSize = (int)(size * ((float)inTargetDensity / inDensity) + 0.5) （四舍五入）</strong></p>
<blockquote>
<p>不同目录对应的dpi具体为:</p>
<p><img src="/2021/04/01/Image/image-20240304153838146.png" alt="image-20240304153838146"></p>
<p>一张172*172的图片放在hdpi目录下，则在dpi为420的设备中尺寸是多少？</p>
<p>1、hdpi密度是240 因此Options.inDesnity = 240<br> 2、设备密度是420 因此Options.inTargetDensity = 420;<br> 3、设备返回bitmap大小=172 * 420 / 240 = 301px</p>
</blockquote>
<p>通过上面对dp的了解，我们知道在设定view大小、间距时使用dp能最大限度地屏蔽设备密度之间的差异。可能你就会问了，那bitmap展示的时候如何适配不同密度的设备呢？</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">scss</span><br><span class="line">复制代码    <span class="keyword">@Override</span></span><br><span class="line">    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">        setMeasuredDimension(bitmap.getWidth(), bitmap<span class="selector-class">.getHeight</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void init() &#123;</span><br><span class="line">        String path = Environment.getExternalStorageDirectory() + &quot;/Download/photo1.jpg&quot;;</span><br><span class="line">        bitmap = BitmapFactory.decodeFile(path);</span><br><span class="line">        paint = new Paint();</span><br><span class="line">        paint<span class="selector-class">.setAntiAlias</span>(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@Override</span></span><br><span class="line">    protected void onDraw(Canvas canvas) &#123;</span><br><span class="line">        super<span class="selector-class">.onDraw</span>(canvas);</span><br><span class="line"></span><br><span class="line">        Rect src = new Rect(0, 0, bitmap.getWidth(), bitmap.getHeight());</span><br><span class="line">        RectF rectF = new RectF(0, 0, bitmap.getWidth(), bitmap.getHeight());</span><br><span class="line">        <span class="selector-tag">canvas</span><span class="selector-class">.drawBitmap</span>(bitmap, src, rectF, paint);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>自定义view从磁盘上加载一张图片，并将之显示在view上，view的大小决定于bitmap大小。依旧以上述A、B设备为例，展示结果如下：</p>
<p><img src="/2021/04/01/Image/399c21524077499b8b4c00f83f3f661e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image.png"></p>
<p>左边是A设备，右边是B设备。<br> 明显地看出，在A设备显示比B设备大很多，实际上和我们之前用px来描述view的大小原理是一样的，bitmap的宽、高都是px在描述，而bitmap决定了view的宽、高，最终导致A设备和B设备上的view大小（宽、高像素）是一样的，而它们屏幕密度又不相同，因此产生了差异。<br> 那不会每次都需要我们自己根据屏幕密度来转换bitmap大小吧？幸运的是，Android已经为我们考虑到了。</p>
<p><img src="/2021/04/01/Image/de2fdade2e8a4f2eb0b1214882399171~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image.png"></p>
<p>如上图，在Android Studio创建工程的时候，默认在res下创建mipmap目录，这些mipmap目录按照密度分为mdpi/hdpi/xhdpi/xxhdpi/xxxhdpi，看起来都在“一个“mipmap”目录下，实际上分为不同的目录：</p>
<p><img src="/2021/04/01/Image/d66d017272944d00ac139e76cf248bf9~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image.png"></p>
<p>生成不同密度的目录有什么作用？<br> A设备dpi=240，根据dpi范围，属于hdpi<br> B设备dpi=420，根据dpi范围，属于xxhdpi<br> 图片原始尺寸：photo1.jpg(宽高 172px-172px)<br> 当我们想要在不同密度设备上显示同一张图片并且想要“看起来一样大时”。假设设计的时候以hdpi为准，放置photo1.jpg为172*172，那么根据计算规则在xxhdpi上需要设置photo1.jpg为:</p>
<blockquote>
<p>scale = 480 / 240 = 2<br> width = 172 * 2 = 344<br> height = 172 * 2= 344<br> 注：这里为什么要放大？可以这么理解，因为B设备密度大，通常来说密度越大单位尺寸内需要的像素越多，假设A设备上172*172占据1inch面积，那么为了能够在B设备上填充满相同的面积需要更多的像素，因此B设备上的图片分辨率应该更大（这里说的通常是因为真正决定设备单位尺寸内容纳的像素个数的因素是ppi，有些设备dpi比较大，但是ppi反而小）</p>
</blockquote>
<p>现在hdpi和xxhdpi目录下分别存放了同名图片：photo1.jpg，只是大小不同。当程序运行的时候：</p>
<blockquote>
<p>A设备发现自己密度属于hdpi，它会直接到hdpi下寻找对应的photo1.jpg并显示<br> B设备发现自己密度属于xxhdpi，它会直接到xxhdpi下寻找对应的photo1.jpg并显示</p>
</blockquote>
<p>来看看效果：</p>
<p><img src="/2021/04/01/Image/f77c83ea9be641a3980c1fbc8cdba29e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image.png"></p>
<p>左边A设备，右边B设备 针对不同的密度设计不同的图片大小，最大限度保证了同一图片在不同密度设备上表现“看起来差不多大”。<br> 来看看A、B设备上图片占内存大小：</p>
<blockquote>
<p>A设备 172 * 172 * 4 = 118336 ≈ 116k<br> B设备 344 * 344 * 4 = 473344 ≈ 462k<br> 注：解析bitmap时，默认inPreferredConfig=ARGB_8888，也就是每个像素有4个字节来存储</p>
</blockquote>
<p>说明在B设备上显示photo1.jpg需要更多的内存。<br> 上边只是列举了hdpi、xxhdipi，同理对于mdpi、xhdpi、xxxhdpi根据规则放入相应大小的图片，程序会根据不同的设备密度从对应的mipmap文件夹下加载资源。如此一来，我们无需关注bitmap在不同密度设备上显示问题了。</p>
<h3 id="只保留一套尺寸的资源"><a href="#只保留一套尺寸的资源" class="headerlink" title="只保留一套尺寸的资源"></a>只保留一套尺寸的资源</h3><p>在mipmap各个文件夹下都放置同一套资源的不同尺寸文件似乎有点太占apk大小，能否只放某个密度下图片，其余的靠系统自己适配呢？<br> 现在只保留hdpi下的photo1.jpg图片，看看在A、B设备上运行情况如何：</p>
<p><img src="/2021/04/01/Image/21d875f249ed454c9093a8c022c25a68~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image.png"></p>
<p>看起来和上张图差不多，说明系统会帮我们适配B设备上的图片。<br> 再来看看A、B设备上图片占内存大小：<br> 先看A设备：</p>
<p><img src="/2021/04/01/Image/f06b520447834d7db853af3c81294725~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image.png"></p>
<p>再看B设备：</p>
<p><img src="/2021/04/01/Image/bb894daa906547cc9019736038850bd8~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image.png"></p>
<blockquote>
<p>A设备 172 * 172 * 4 = 118336 ≈ 116k<br> B设备 301 * 301 * 4 = 362404 ≈ 354k</p>
</blockquote>
<p>对比photo1.jpg 分别放在hdpi、xxhdpi和只放在hdpi下可以看出：B设备上图片所占内存变小了。为什么呢？接下来从源码里寻找答案。</p>
<h2 id="构造Bitmap"><a href="#构造Bitmap" class="headerlink" title="构造Bitmap"></a>构造Bitmap</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini</span><br><span class="line">复制代码Bitmap bitmap = BitmapFactory.decodeResource(getContext().getResources(), R.mipmap.photo1);</span><br></pre></td></tr></table></figure>

<p>A、B设备同样加载hdpi/photo1.jpg，返回的bitmap大小不相同，我们从这方法开始一探究竟。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeResource</span><span class="params">(Resources res, <span class="keyword">int</span> id, BitmapFactory.Options opts)</span> </span>&#123;</span><br><span class="line">        validate(opts);</span><br><span class="line">        Bitmap bm = <span class="keyword">null</span>;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">final</span> TypedValue value = <span class="keyword">new</span> TypedValue();</span><br><span class="line">            <span class="comment">//根据资源id，构造Value对象，这里面需要关注的变量：density</span></span><br><span class="line">            is = res.openRawResource(id, value);</span><br><span class="line">            bm = decodeResourceStream(res, value, is, <span class="keyword">null</span>, opts);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">/*  do nothing.</span></span><br><span class="line"><span class="comment">                If the exception happened on open, bm will be null.</span></span><br><span class="line"><span class="comment">                If it happened on close, bm is still valid.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (is != <span class="keyword">null</span>) is.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bm == <span class="keyword">null</span> &amp;&amp; opts != <span class="keyword">null</span> &amp;&amp; opts.inBitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Problem decoding into existing bitmap&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeResourceStream</span><span class="params">(<span class="meta">@Nullable</span> Resources res, <span class="meta">@Nullable</span> TypedValue value,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@Nullable</span> InputStream is, <span class="meta">@Nullable</span> Rect pad, <span class="meta">@Nullable</span> BitmapFactory.Options opts)</span> </span>&#123;</span><br><span class="line">        validate(opts);</span><br><span class="line">        <span class="keyword">if</span> (opts == <span class="keyword">null</span>) &#123;</span><br><span class="line">            opts = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (opts.inDensity == <span class="number">0</span> &amp;&amp; value != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//通过value里的density给options里的inDensity赋值</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> density = value.density;</span><br><span class="line">            <span class="keyword">if</span> (density == TypedValue.DENSITY_DEFAULT) &#123;</span><br><span class="line">                opts.inDensity = DisplayMetrics.DENSITY_DEFAULT;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (density != TypedValue.DENSITY_NONE) &#123;</span><br><span class="line">                opts.inDensity = density;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (opts.inTargetDensity == <span class="number">0</span> &amp;&amp; res != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//获取设备屏幕密度并赋予opts.inTargetDensity</span></span><br><span class="line">            opts.inTargetDensity = res.getDisplayMetrics().densityDpi;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//确定option inDensity、inTargetDensity 后传入jni层加载bitmap</span></span><br><span class="line">        <span class="keyword">return</span> decodeStream(is, pad, opts);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面涉及到的关键点是density，分别是TypedValue的density和Options的density。<br> 先来看看TypedValue density:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If the Value came from a resource, this holds the corresponding pixel density.</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> density;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>简单解释：表示该资源从哪个密度文件夹下取的；比如A、B设备取hdpi下的photo1.jpg，那么此时density=240</p>
</blockquote>
<p>再来看看Options density</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* The pixel density to use <span class="keyword">for</span> the bitmap.  This will always result</span><br><span class="line">* in the returned bitmap having a density set <span class="keyword">for</span> it</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> inDensity;</span><br><span class="line"></span><br><span class="line">* The pixel density of the destination <span class="keyword">this</span> bitmap will be drawn to.</span><br><span class="line">* This is used in conjunction with &#123;@link #inDensity&#125; and</span><br><span class="line">* &#123;@link #inScaled&#125; to determine if and how to scale the bitmap before</span><br><span class="line">* returning it.</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> inTargetDensity;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>简单解释：inDensity表示该资源来源于哪个密度的文件夹，该值从TypedValue获取；   inTargetDensity表示该资源将要显示在哪个密度的设备上。在构造Bitmap时，会根据inDensity与inTargetDensity决定Bitmap放大缩写的倍数。<br> 计算公式如下：<br> needSize = (int)(size * ((float)inTargetDensity / inDensity) + 0.5) （四舍五入）</p>
</blockquote>
<p>现在分析B设备加载hdpi/photo1.jpg如何做的:</p>
<blockquote>
<p>1、hdpi密度是240 因此Options.inDesnity = 240<br> 2、B设备密度是420 因此Options.inTargetDensity = 420;<br> 3、B设备返回bitmap大小=172 * 420 / 240 = 301px</p>
</blockquote>
<p>链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/7015597280120176676">https://juejin.cn/post/7015597280120176676</a></p>
<h2 id="大图加载："><a href="#大图加载：" class="headerlink" title="大图加载："></a>大图加载：</h2><p>按比例采样缩小，参见<a target="_blank" rel="noopener" href="https://developer.android.com/topic/performance/graphics/load-bitmap?hl=zh-cn">https://developer.android.com/topic/performance/graphics/load-bitmap?hl=zh-cn</a></p>
<h2 id="巨图按区域显示："><a href="#巨图按区域显示：" class="headerlink" title="巨图按区域显示："></a>巨图按区域显示：</h2><p>BitmapRegionDecoder显示区域 + 手势移动显示中心</p>
<p>参见<a target="_blank" rel="noopener" href="https://blog.csdn.net/lmj623565791/article/details/49300989">https://blog.csdn.net/lmj623565791/article/details/49300989</a></p>
<h1 id="图片格式"><a href="#图片格式" class="headerlink" title="图片格式"></a>图片格式</h1><h2 id="图片格式-webp"><a href="#图片格式-webp" class="headerlink" title="图片格式-webp"></a>图片格式-webp</h2><blockquote>
<p> WEBP相较传统图片格式（jpg/png/gif）会有较大的文件体积优势（25%以上），但会导致解码时间提升1.5倍以上。即webp有更小的体积，节省带宽，apk体积，更快的加载速度（因为体积雄安），但会少许增加cpu压力</p>
<p> “编解码速度上，根据Google的测试，目前WebP与JPG相比较，毫秒级别上，编码速度慢10倍，解码速度慢1.5倍。编码速度即可被没影响，我们只是在上传时生成一份WebP图片。解码速度则需要客户端综合节省下的流量来综合考虑。总之带宽节省比cpu消耗更有价值”</p>
</blockquote>
<h2 id="图片格式-JPG-JPEG"><a href="#图片格式-JPG-JPEG" class="headerlink" title="图片格式-JPG/JPEG"></a>图片格式-JPG/JPEG</h2><p>JPG 和 JPEG是同一个东西，不过是因为window平台早期只支持三个字符的文件格式，将JPEG缩写为JPG。</p>
<p>JPG是有损压缩的，是1600万位颜色，不支持透明度的，存储体积较小的</p>
<h2 id="图片格式-PNG"><a href="#图片格式-PNG" class="headerlink" title="图片格式-PNG"></a>图片格式-PNG</h2><p>PNG文件利用特殊的编码方法标记重复出现的数据，因而对图像的颜色没有影响，也不可能产生颜色的损失，这样就可以重复保存而不降低图像质量。</p>
<p>PNG是无损压缩的，是1600万位颜色，支持透明度的，存储体积较大的</p>
<h2 id="图片格式-GIF"><a href="#图片格式-GIF" class="headerlink" title="图片格式-GIF"></a>图片格式-GIF</h2><p>目前使用范围最广的动图格式，具体为GIF87a版本</p>
<p>GIF 格式的文件按块存储，整体上分为三部分：</p>
<ul>
<li><p>文件头（Header）</p>
</li>
<li><p>GIF 数据流（GIF Data Stream）</p>
</li>
<li><p>文件结尾（Trailer）</p>
</li>
</ul>
<p>GIF是无损压缩的，是256位颜色，不支持透明度的，存储提交稍大的</p>
<table>
<thead>
<tr>
<th></th>
<th>PNG</th>
<th>JPEG</th>
<th>GIF</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>压缩算法</td>
<td>无损压缩</td>
<td>有损压缩</td>
<td>无损压缩</td>
</tr>
<tr>
<td>透明度</td>
<td>保持图像透明度</td>
<td>不保持图像透明度</td>
<td>不支持透明度</td>
</tr>
<tr>
<td>图片尺寸</td>
<td>大</td>
<td>更小</td>
<td>较大</td>
</tr>
<tr>
<td>画面质量</td>
<td>更好的</td>
<td>相比PNG不够好</td>
<td>较差</td>
</tr>
<tr>
<td>可用颜色</td>
<td>1600万  2^24</td>
<td>1600万  2^24</td>
<td>256  2^8</td>
</tr>
</tbody></table>
<p><img src="/2021/04/01/Image/1643ee89153b6c59~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp" alt="img"></p>
<p><img src="/2021/04/01/Image/gif_file_stream.gif" alt="GIF file stream diagram"></p>
<p>We will learn more by walking through a sample GIF file. You can see the sample file and its corresponding bytes below.</p>
<table>
<thead>
<tr>
<th>Actual Size</th>
<th>Enlarged</th>
<th>Bytes</th>
</tr>
</thead>
<tbody><tr>
<td><img src="/2021/04/01/Image/sample_1.gif" alt="sample gif, actual size"> (10x10)</td>
<td><img src="/2021/04/01/Image/sample_1_enlarged.gif" alt="sample gif, enlarged"> (100x100)</td>
<td>47 49 46 38 39 61 0A 00 0A 00 91 00 00 FF FF FF FF 00 00 00 00 FF 00 00 00 21 F9 04 00 00 00 00 00 2C 00 00 00 00 0A 00 0A 00 00 02 16 8C 2D 99 87 2A 1C DC 33 A0 02 75 EC 95 FA A8 DE 60 8C 04 91 4C 01 00 3B</td>
</tr>
</tbody></table>
<h3 id="Header-Block"><a href="#Header-Block" class="headerlink" title="Header Block"></a>Header Block</h3><p>From the sample file: <strong>47 49 46 38 39 61</strong>   ， ASCII解码即为 GIF89a</p>
<h3 id="Logical-Screen-Descriptor"><a href="#Logical-Screen-Descriptor" class="headerlink" title="Logical Screen Descriptor"></a>Logical Screen Descriptor</h3><p>From Sample File: 0A 00 0A 00 91 00 00</p>
<h3 id="Global-Color-Table"><a href="#Global-Color-Table" class="headerlink" title="Global Color Table"></a>Global Color Table</h3><p>From the sample file: FF FF FF FF 00 00 00 00 FF 00 00 00</p>
<h3 id="Graphics-Control-Extension"><a href="#Graphics-Control-Extension" class="headerlink" title="Graphics Control Extension"></a>Graphics Control Extension</h3><p>From the sample file: 21 F9 04 00 00 00 00 00</p>
<h3 id="Image-Descriptor"><a href="#Image-Descriptor" class="headerlink" title="Image Descriptor"></a>Image Descriptor</h3><p>From the sample file: 2C 00 00 00 00 0A 00 0A 00 00</p>
<h3 id="Local-Color-Table-Opetional"><a href="#Local-Color-Table-Opetional" class="headerlink" title="Local Color Table(Opetional)"></a>Local Color Table(Opetional)</h3><p>Null</p>
<h3 id="Image-Data"><a href="#Image-Data" class="headerlink" title="Image Data"></a>Image Data</h3><p>From the sample file: 02 16 8C 2D 99 87 2A 1C DC 33 A0 02 75 EC 95 FA A8 DE 60 8C 04 91 4C 01 00</p>
<h3 id="Plain-Text-Extension"><a href="#Plain-Text-Extension" class="headerlink" title="Plain Text Extension"></a>Plain Text Extension</h3><p>Example (not in the sample file): 21 01 0C 00 00 00 00 64 00 64 00 14 14 01 00 0B 68 65 6C 6C 6F 20 77 6F 72 6C 64 00</p>
<h3 id="Application-Extension"><a href="#Application-Extension" class="headerlink" title="Application Extension"></a>Application Extension</h3><p>Example (not in sample file): 21 FF 0B 4E 45 54 53 43 41 50 45 32 2E 30 03 01 05 00 00</p>
<h3 id="Comment-Extension"><a href="#Comment-Extension" class="headerlink" title="Comment Extension"></a>Comment Extension</h3><p>Example (not in sample file): 21 FE 09 62 6C 75 65 62 65 72 72 79 00</p>
<h3 id="Trailer"><a href="#Trailer" class="headerlink" title="Trailer"></a>Trailer</h3><p>From sample file: <strong>3B</strong>      //This is the end flag</p>
<p>The trailer block indicates when you’ve reached the end of the file. It is always a byte with a value of 3B.</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Image</p><p><a href="http://example.com/2021/04/01/Image/">http://example.com/2021/04/01/Image/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>white crow</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-04-01</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-03-25</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/04/02/Gradle/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Gradle</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/04/01/Serializable/"><span class="level-item">serializable</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatarPng.png" alt="White Crow"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">White Crow</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">78</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">4</p></a></div></div></nav></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a><p class="is-size-7"><span>&copy; 2024 white crow</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://github.com/WhileCrow"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>