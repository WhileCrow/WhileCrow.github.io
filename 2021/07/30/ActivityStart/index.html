<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>ActivityStart - Crow&#039;s Sky</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Crow&#039;s Sky"><meta name="msapplication-TileImage" content="/img/avatarCircle.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Crow&#039;s Sky"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="极简：桌面本身就是一个常驻的App，点击桌面图标的时候，其实也是一个正常的App唤起另一个App的过程； 那么首先处理点击事件，然后走到Activity.startActivity()，这一步会通过Instrument调用AIDL接口，AMS服务先发一个pause事务给调用方Activity，于是当前Activity的ActivityThread收到pause事务后调用自身的performPa"><meta property="og:type" content="blog"><meta property="og:title" content="ActivityStart"><meta property="og:url" content="http://example.com/2021/07/30/ActivityStart/"><meta property="og:site_name" content="Crow&#039;s Sky"><meta property="og:description" content="极简：桌面本身就是一个常驻的App，点击桌面图标的时候，其实也是一个正常的App唤起另一个App的过程； 那么首先处理点击事件，然后走到Activity.startActivity()，这一步会通过Instrument调用AIDL接口，AMS服务先发一个pause事务给调用方Activity，于是当前Activity的ActivityThread收到pause事务后调用自身的performPa"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://example.com/2021/07/30/ActivityStart/%E5%BD%93%E6%89%8B%E6%8C%87%E7%82%B9%E5%87%BB%E4%BA%86%E6%A1%8C%E9%9D%A2%E7%9A%84App%E5%9B%BE%E6%A0%87%E6%97%B6.jpg"><meta property="og:image" content="http://example.com/2021/07/30/ActivityStart/%E5%BD%93%E6%89%8B%E6%8C%87%E7%82%B9%E5%87%BB%E4%BA%86%E6%A1%8C%E9%9D%A2%E7%9A%84App%E5%9B%BE%E6%A0%87%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.jpg"><meta property="og:image" content="http://example.com/2021/07/30/ActivityStart/1929518181.jpg"><meta property="og:image" content="http://example.com/2021/07/30/ActivityStart/2f29ce566c214ca0949a343ce6f7a032tplv-k3u1fbpfcp-watermark.awebp"><meta property="og:image" content="http://example.com/2021/07/30/ActivityStart/0dc601d67fa34f27bf98ccd6e81006fctplv-k3u1fbpfcp-watermark.awebp"><meta property="og:image" content="http://example.com/2021/07/30/ActivityStart/85913c285f454ad7bb54b655cbb1630dtplv-k3u1fbpfcp-watermark-16288486303365.awebp"><meta property="og:image" content="http://example.com/2021/07/30/ActivityStart/549585-d67a6c7353b8af44.png"><meta property="og:image" content="http://example.com/2021/07/30/ActivityStart/start_app_process-20211019114037632.jpg"><meta property="og:image" content="http://example.com/2021/07/30/ActivityStart/b4b6932d6a8a47e49dbd489f3b4dcd5btplv-k3u1fbpfcp-watermark.awebp"><meta property="article:published_time" content="2021-07-30T09:32:40.000Z"><meta property="article:modified_time" content="2024-12-05T08:18:35.530Z"><meta property="article:author" content="White Crow"><meta property="article:tag" content="CoreProcess"><meta property="article:tag" content="Core"><meta property="article:tag" content="SystemService"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2021/07/30/ActivityStart/%E5%BD%93%E6%89%8B%E6%8C%87%E7%82%B9%E5%87%BB%E4%BA%86%E6%A1%8C%E9%9D%A2%E7%9A%84App%E5%9B%BE%E6%A0%87%E6%97%B6.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/07/30/ActivityStart/"},"headline":"ActivityStart","image":["http://example.com/2021/07/30/ActivityStart/%E5%BD%93%E6%89%8B%E6%8C%87%E7%82%B9%E5%87%BB%E4%BA%86%E6%A1%8C%E9%9D%A2%E7%9A%84App%E5%9B%BE%E6%A0%87%E6%97%B6.jpg","http://example.com/2021/07/30/ActivityStart/%E5%BD%93%E6%89%8B%E6%8C%87%E7%82%B9%E5%87%BB%E4%BA%86%E6%A1%8C%E9%9D%A2%E7%9A%84App%E5%9B%BE%E6%A0%87%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.jpg","http://example.com/2021/07/30/ActivityStart/1929518181.jpg","http://example.com/2021/07/30/ActivityStart/549585-d67a6c7353b8af44.png","http://example.com/2021/07/30/ActivityStart/start_app_process-20211019114037632.jpg"],"datePublished":"2021-07-30T09:32:40.000Z","dateModified":"2024-12-05T08:18:35.530Z","author":{"@type":"Person","name":"white crow"},"publisher":{"@type":"Organization","name":"Crow's Sky","logo":{"@type":"ImageObject","url":"http://example.com/img/avatarCircle.png"}},"description":"极简：桌面本身就是一个常驻的App，点击桌面图标的时候，其实也是一个正常的App唤起另一个App的过程； 那么首先处理点击事件，然后走到Activity.startActivity()，这一步会通过Instrument调用AIDL接口，AMS服务先发一个pause事务给调用方Activity，于是当前Activity的ActivityThread收到pause事务后调用自身的performPa"}</script><link rel="canonical" href="http://example.com/2021/07/30/ActivityStart/"><link rel="icon" href="/img/avatarCircle.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/WhileCrow"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-10-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-07-30T09:32:40.000Z" title="7/30/2021, 5:32:40 PM">2021-07-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-05T08:18:35.530Z" title="12/5/2024, 4:18:35 PM">2024-12-05</time></span><span class="level-item"><a class="link-muted" href="/categories/Android/">Android</a><span> / </span><a class="link-muted" href="/categories/Android/Framework/">Framework</a></span><span class="level-item">an hour read (About 7375 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">ActivityStart</h1><div class="content"><p><img src="/2021/07/30/ActivityStart/%E5%BD%93%E6%89%8B%E6%8C%87%E7%82%B9%E5%87%BB%E4%BA%86%E6%A1%8C%E9%9D%A2%E7%9A%84App%E5%9B%BE%E6%A0%87%E6%97%B6.jpg" alt="当手指点击了桌面的App图标时"></p>
<p><img src="/2021/07/30/ActivityStart/%E5%BD%93%E6%89%8B%E6%8C%87%E7%82%B9%E5%87%BB%E4%BA%86%E6%A1%8C%E9%9D%A2%E7%9A%84App%E5%9B%BE%E6%A0%87%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.jpg" alt="当手指点击了桌面的App图标时发生了什么"></p>
<p><strong>极简：桌面本身就是一个常驻的App，点击桌面图标的时候，其实也是一个正常的App唤起另一个App的过程；</strong></p>
<p><strong>那么首先处理点击事件，然后走到Activity.startActivity()，这一步会通过Instrument调用AIDL接口，AMS服务先发一个pause事务给调用方Activity，于是当前Activity的ActivityThread收到pause事务后调用自身的performPauseActivity，当前Activity进入暂停状态。</strong></p>
<p><strong>然后就是启动新App的流程，首先Zygote进程fork自身（fork所以会有runtime），之后在新进程中执行ActivityThread(App的执行入口)，ActivityThead就是一个常见的Java Main类一样，走到其main(String[] args)入口方法，其中包括： 1.  调用Looper.prepareMainLooper进行主线程looper初始化;  2. ActivityThead.acttach()进行Application初始化; 3. Loop.loop()进入消息循环</strong></p>
<p><strong>进程初始化完成并且主线程进入了循环，接下来就是往消息循环中提交Launch事务进行perforLaunchActivity初始化Activity，其中包括(顺序)：1. attach()初始化Window，并为其设置WindowManager;  2. onCreate()初始化DecorView并inflate布局添加到DecorView; 3. OnResume()中调用Window.addView，创建ViewRootImpl并调用其setView，setView中执行了reqeustLayout。</strong></p>
<p><strong>Activity的Window初始化并添加了DecorView后，setView意味着在OnResume执行完成后的下一个handler消息就是渲染页面了，也就是通过 渲染时通过编舞者，先post一个同步消息屏障到主线程消息循环中并注册Vsyn回调的异步消息，意在阻拦所有同步消息执行，继而使渲染的message优先执行，在屏幕发出Vsync之后，回调到编舞者中开始执行输入、动画、Traversal，其中Traversal会移除同步消息屏障后开始执行view的测量、布局、渲染。</strong></p>
<p><img src="/2021/07/30/ActivityStart/1929518181.jpg" alt="startActivity_onCreate.jpg"></p>
<span id="more"></span>

<p><a target="_blank" rel="noopener" href="https://www.processon.com/diagraming/61e7d27b7d9c0806a8b8fd93">当手指点击了桌面的App图标时发生了什么 - ProcessOn</a></p>
<p><img src="/2021/07/30/ActivityStart/2f29ce566c214ca0949a343ce6f7a032tplv-k3u1fbpfcp-watermark.awebp" alt="普通Activity启动整体流程.png"></p>
<p>AIDL：</p>
<ul>
<li><p>frameworks/base/core/java/android/app/IActivityManager.aidl    -&gt;    </p>
<p>本地进程获取system_server进程中的AMS服务</p>
</li>
<li><p>frameworks/base/core/java/android/app/IApplicationThread.aidl    -&gt;</p>
<p>system_server进程调用本地进程ActivtyThread执行 <u><em>(如LaunchActivityItem创建Activity与ResumeActivityItem走onResume生命周期)</em></u> 事务发送Handler消息</p>
</li>
</ul>
<h2 id="0x01-从activity-startActivity到onPuase"><a href="#0x01-从activity-startActivity到onPuase" class="headerlink" title="0x01: 从activity.startActivity到onPuase()"></a>0x01: 从activity.startActivity到onPuase()</h2><p><img src="/2021/07/30/ActivityStart/0dc601d67fa34f27bf98ccd6e81006fctplv-k3u1fbpfcp-watermark.awebp" alt="Activity请求AMS流程.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">android.app.Activity#startActivity(android.content.Intent)</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"></span><br><span class="line">android.app.Activity#startActivityForResult(android.content.Intent, int, android.os.Bundle)</span><br><span class="line">...</span><br><span class="line"> Instrumentation.ActivityResult ar =</span><br><span class="line">                mInstrumentation.execStartActivity(</span><br><span class="line">                    <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                    intent, requestCode, options);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"></span><br><span class="line">android.app.Instrumentation#execStartActivity(android.content.Context, android.os.IBinder, android.os.IBinder, android.app.Activity, android.content.Intent, int, android.os.Bundle)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Instrumentation#execStartActivity各个版本实现区别较大，Android8之前（不含）是用ActivityManagerProxy代理AMS，Android8及之后替换为直接以AIDL方法获取调用AMS服务，Android10及之后又将将该过程交给ActivityTaskMangerService(ATMS)执行startActivity流程</span></span><br><span class="line">          </span><br><span class="line"> <span class="keyword">int</span> result = ActivityManager.getService()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target, requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">            checkStartActivityResult(result, intent);</span><br><span class="line">-&gt;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">com.android.server.am.ActivityManagerService#startActivity(IApplicationThread caller, String callingPackage,Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode,int startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Android9.0即API28为例：经过上述IPC过程后，进入system_server进程，接下来在ActivityManagerService中执行startActivity</span></span><br></pre></td></tr></table></figure>

<hr>
<p>————— 应用进程与system_server进程切换的分割线 —————-<br>切换到system_server进程，由于system_server是隐藏的，故难以debug</p>
<hr>
<p><img src="/2021/07/30/ActivityStart/85913c285f454ad7bb54b655cbb1630dtplv-k3u1fbpfcp-watermark-16288486303365.awebp" alt="AMS处理启动Activity流程.png"></p>
<h3 id="一、ActivityManagerService"><a href="#一、ActivityManagerService" class="headerlink" title="一、ActivityManagerService"></a>一、ActivityManagerService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以下为system_server中进行的AMS startActivity的流程</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">com.android.server.am.ActivityManagerService#startActivity(IApplicationThread caller, String callingPackage,Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode,int startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span><br><span class="line"></span><br><span class="line">-&gt; </span><br><span class="line"></span><br><span class="line">com.android.server.am.ActivityManagerService#startActivity</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> startActivityAsUser(... , </span><br><span class="line">               UserHandle.getCallingUserId());</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"></span><br><span class="line">com.android.server.am.ActivityManagerService#startActivityAsUser(IApplicationThread, java.lang.String, android.content.Intent, java.lang.String, android.os.IBinder, java.lang.String, int, int, ProfilerInfo, android.os.Bundle, int)</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"></span><br><span class="line">com.android.server.am.ActivityManagerService#startActivityAsUser(IApplicationThread, java.lang.String, android.content.Intent, java.lang.String, android.os.IBinder, java.lang.String, int, int, ProfilerInfo, android.os.Bundle, int, boolean)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"> <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">        <span class="keyword">return</span> mActivityStartController.obtainStarter(intent, <span class="string">&quot;startActivityAsUser&quot;</span>)</span><br><span class="line">                .setCaller(caller)</span><br><span class="line">                .setCallingPackage(callingPackage)</span><br><span class="line">                .setResolvedType(resolvedType)</span><br><span class="line">                .setResultTo(resultTo)</span><br><span class="line">                .setResultWho(resultWho)</span><br><span class="line">                .setRequestCode(requestCode)</span><br><span class="line">                .setStartFlags(startFlags)</span><br><span class="line">                .setProfilerInfo(profilerInfo)</span><br><span class="line">                .setActivityOptions(bOptions)</span><br><span class="line">                .setMayWait(userId)</span><br><span class="line">                .execute();</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"></span><br><span class="line">com.android.server.am.ActivityStartController#obtainStarter</span><br><span class="line"></span><br><span class="line"><span class="comment">//工厂模式，制造一个核心启动类ActivityStarter，赋值startActivityAsUser入参给ActivityStarter，并叼调用其execute</span></span><br><span class="line"></span><br><span class="line">-&gt;</span><br></pre></td></tr></table></figure>

<h3 id="二、ActivityStarter"><a href="#二、ActivityStarter" class="headerlink" title="二、ActivityStarter"></a>二、ActivityStarter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityStarter.java </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">com.android.server.am.ActivityStarter#execute() &#123;</span><br><span class="line">    ...</span><br><span class="line"><span class="comment">//mRequest.mayWait == true</span></span><br><span class="line"><span class="keyword">return</span> startActivityMayWait(mRequest.caller, mRequest.callingUid,</span><br><span class="line">    mRequest.callingPackage, mRequest.intent, mRequest.resolvedType,</span><br><span class="line">    mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,</span><br><span class="line">    mRequest.resultWho, mRequest.requestCode, mRequest.startFlags,</span><br><span class="line">    mRequest.profilerInfo, mRequest.waitResult, mRequest.globalConfig,</span><br><span class="line">    mRequest.activityOptions, mRequest.ignoreTargetSecurity, mRequest.userId,</span><br><span class="line">    mRequest.inTask, mRequest.reason,</span><br><span class="line">    mRequest.allowPendingRemoteAnimationRegistryLookup);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ActivityStarter#startActivityMayWait 中new 一个ActivityRecord， ActivityRecord 为Activity 在AMS中的信息，然后在下面的startActivity中赋值。并且找到Activity 所在的ActivityStack.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProfilerInfo profilerInfo, WaitResult outResult,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration globalConfig, SafeActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> userId, TaskRecord inTask, String reason,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup)</span> </span>&#123;</span><br><span class="line">			<span class="comment">//...</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = mSupervisor.mFocusedStack;</span><br><span class="line">			<span class="comment">//... </span></span><br><span class="line">            <span class="keyword">final</span> ActivityRecord[] outRecord = <span class="keyword">new</span> ActivityRecord[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">int</span> res = startActivity(caller, intent, ephemeralIntent, resolvedType, aInfo, rInfo,</span><br><span class="line">                    voiceSession, voiceInteractor, resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                    callingUid, callingPackage, realCallingPid, realCallingUid, startFlags, options,</span><br><span class="line">                    ignoreTargetSecurity, componentSpecified, outRecord, inTask, reason,</span><br><span class="line">                    allowPendingRemoteAnimationRegistryLookup);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">-&gt; startActivity -&gt; startActivity -&gt; startActivity </span><br><span class="line">    </span><br><span class="line">-&gt;  </span><br><span class="line">    <span class="comment">//经过多个startACtivity重载方法套娃式调用（主要是Activity信息的组装）后，走到startActivityUnchecked</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//startActivityUnchecked 中调用ActivityStack#startActivityLocked 找到Activity 所在的TaskRecord, 把Activity 插入TaskRecord 合适的位置。调用ActivityStackSupervisor#resumeFocusedStackTopActivityLocked</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityRecord[] outActivity)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    	<span class="comment">//...</span></span><br><span class="line">   </span><br><span class="line">        mTargetStack.startActivityLocked(mStartActivity, topFocused, newTask, mKeepCurTransition,mOptions);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mTargetStack.isFocusable()</span><br><span class="line">                    || (topTaskActivity != <span class="keyword">null</span> &amp;&amp; topTaskActivity.mTaskOverlay</span><br><span class="line">                    &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity, mOptions);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mStartActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">//...</span></span><br><span class="line">        <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h3 id="三、ActivityStackSupervisor"><a href="#三、ActivityStackSupervisor" class="headerlink" title="三、ActivityStackSupervisor"></a>三、ActivityStackSupervisor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityStackSupervisor.java</span></span><br><span class="line"><span class="comment">//Activity 已经在进入ActivityStack， 然后从Activity 中查找这个Activity 然后调状态设置为resume.</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">resumeFocusedStackTopActivityLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!readyToResume()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">            <span class="keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、ActivityStack"><a href="#四、ActivityStack" class="headerlink" title="四、ActivityStack"></a>四、ActivityStack</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityStack.java</span></span><br><span class="line"><span class="comment">//继续回到 ActivityStack resume Activity.在resumeTopActivityInnerLocked 中先检查桌面的Activity 状态，桌面Activity 状态需要设置为pause, startPausingLocked 把桌面Activity设置为paused。 由于新的Activity 在另外一个进程中，另外一个进程还没有启动，mStackSupervisor.startSpecificActivityLocked 启动新的Activity 进程。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Protect against recursion.</span></span><br><span class="line">            mStackSupervisor.inResumeTopActivity = <span class="keyword">true</span>;</span><br><span class="line">            result = resumeTopActivityInnerLocked(prev, options);</span><br><span class="line"></span><br><span class="line">      	<span class="comment">//...</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev,ActivityOptions options)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">boolean</span> pausing = mStackSupervisor.pauseBackStacks(userLeaving, next, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STATES) Slog.d(TAG_STATES,</span><br><span class="line">                                 <span class="string">&quot;resumeTopActivityLocked: Pausing &quot;</span> + mResumedActivity);</span><br><span class="line">        <span class="comment">//启动方Activity 状态需要设置为pause</span></span><br><span class="line">        pausing |= startPausingLocked(userLeaving, <span class="keyword">false</span>, next, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//关于PauseActivityItem事务执行流程可参见</span></span><br><span class="line"><span class="comment">//@0x02——一、releaseStartActivityLocked——1、创建添加activity事务并通过binder将事务交予应用进程执行</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startPausingLocked</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> uiSleeping,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityRecord resuming, <span class="keyword">boolean</span> pauseImmediately)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (prev.app != <span class="keyword">null</span> &amp;&amp; prev.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mService.getLifecycleManager().scheduleTransaction(prev.app.thread, prev.appToken,PauseActivityItem.obtain(prev.finishing, userLeaving,  prev.configChangeFlags, pauseImmediately));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="小结"><a href="#小结" class="headerlink" title="小结:"></a>小结:</h3><p>从activity.startActivity()到Instrunmentaion中以Binder机制通过ActivityManager.getService().startActivity切换到system_server进程中的ActivityMangerService服务，再到ActivityMangerService中ActivityStarter、ActivityStatckSuperVisor、ActivityStack执行解析生成ActivityRecord(包含AMS、activityInfo、Configuration等信息)，最后由ActivityStack通过binder将”pause事务”从AMS传递到应用进程，应用进程handler机制处理该事务，旧Activity pause成功。开始AMS启动新Activity。</p>
<p><img src="/2021/07/30/ActivityStart/549585-d67a6c7353b8af44.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">至此的链路简述</span><br><span class="line">Activity.startActivity-&gt;</span><br><span class="line">Instrumentation.execStartActivity-&gt;</span><br><span class="line">ActivityManager.getService().startActivity-&gt;</span><br><span class="line">ActivityManagerService.startActivityAsUser-&gt;</span><br><span class="line">ActivityStarter.execute-&gt;</span><br><span class="line">ActivityStarter.startActivityMayWait -&gt;</span><br><span class="line">ActivityStarter.startActivity-&gt;ActivityStarter.startActivity重载套娃-&gt;</span><br><span class="line">ActivityStarter.startActivityUnchecked-&gt;</span><br><span class="line">ActivityStackSupervisor.resumeFocusedStackTopActivityLocked-&gt;</span><br><span class="line">ActivityStack.resumeTopActivityUncheckedLocked-&gt;</span><br><span class="line">    </span><br><span class="line">ActivityStack.resumeTopActivityInnerLocked</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">//startPausingLocked()</span></span><br><span class="line">   <span class="comment">//startSpecificActivityLocked(next, true, false);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，新Activity的ActivityRecord（AMS中的Activity信息，包括不限于ActivityInfo、ProcessRecord、Configuration，ActivityStackSupervisor、发起跳转的Activity的ActivityRecord和resultTo的ActivityRecord）创建解析完成，旧Activity的pause生命周期被调用执行（见附录ActivityStack#startPausingLocked），接下来就是通过AMS启动新的Activity</p>
<h2 id="0x02-AMS启动新的Activity"><a href="#0x02-AMS启动新的Activity" class="headerlink" title="0x02: AMS启动新的Activity"></a>0x02: AMS启动新的Activity</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">com.android.server.am.ActivityStackSupervisor#startSpecificActivityLocked (...) &#123;</span><br><span class="line">      ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">        r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">	getLaunchTimeTracker().setLaunchTime(r);</span><br><span class="line">	<span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// !!! 看这里，如果没有另开进程的标识，就走realStartActivityLocked，直接走普通Activity启动流程，然后retrun !!!</span></span><br><span class="line">            <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></span><br><span class="line">                    || !<span class="string">&quot;android&quot;</span>.equals(r.info.packageName)) &#123;</span><br><span class="line">                <span class="comment">// Don&#x27;t add this if it is a platform co mponent that is marked</span></span><br><span class="line">                <span class="comment">// to run in multiple processes, because this is actually</span></span><br><span class="line">                <span class="comment">// part of the framework so doesn&#x27;t make sense to track as a</span></span><br><span class="line">                <span class="comment">// separate apk in the process.</span></span><br><span class="line">                app.addPackage(r.info.packageName,r.info.applicationInfo.longVersionCode,</span><br><span class="line">                        mService.mProcessStats);</span><br><span class="line">            &#125;</span><br><span class="line">            realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Exception when starting activity &quot;</span></span><br><span class="line">                    + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If a dead object exception was thrown -- fall through to</span></span><br><span class="line">        <span class="comment">// restart the application.</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// !!!看这里，如果没有在前面被return掉，就会走新开进程启动Activity的流程</span></span><br><span class="line">	mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;activity&quot;</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="一、startProcessLocked"><a href="#一、startProcessLocked" class="headerlink" title="一、startProcessLocked"></a>一、startProcessLocked</h3><p><strong>简述：启动新的进程，即Zygote进程Process.start() fork出新的进程并反射调用其mian方法，走到ActivityThread.main，main方法中主要是初始化looper并启动循环，接着调用ActivityThread.attach()在该方法中初始化Application单例。接下来就是二、实质性启动Activity。</strong></p>
<p>启动新进程承载新Activity，之后继续走realStartActivityLocked常见同进程Activity启动的流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">com.android.server.am.ActivityManagerService#startProcessLocked(java.lang.String, android.content.pm.ApplicationInfo, boolean, int, java.lang.String, android.content.ComponentName, boolean, boolean, boolean) -&gt;</span><br><span class="line">    </span><br><span class="line">com.android.server.am.ActivityManagerService#startProcessLocked(java.lang.String, java.lang.String, java.lang.String, com.android.server.am.ProcessRecord, int, int[], int, int, java.lang.String, java.lang.String, java.lang.String, java.lang.String, long) -&gt;</span><br><span class="line">    </span><br><span class="line">com.android.server.am.ActivityManagerService#startProcess(...) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hostingType.equals(<span class="string">&quot;webview_service&quot;</span>)) &#123;</span><br><span class="line">        startResult = startWebView(entryPoint,</span><br><span class="line">                app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                app.info.dataDir, <span class="keyword">null</span>,</span><br><span class="line">                <span class="keyword">new</span> String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        startResult = Process.start(entryPoint,</span><br><span class="line">                app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                app.info.dataDir, invokeWith,</span><br><span class="line">                <span class="keyword">new</span> String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">		-&gt;</span><br><span class="line"><span class="comment">//android.os.Process.java</span></span><br><span class="line">            </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ZygoteProcess zygoteProcess =</span><br><span class="line">            <span class="keyword">new</span> ZygoteProcess(ZYGOTE_SOCKET, SECONDARY_ZYGOTE_SOCKET);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ProcessStartResult <span class="title">start</span><span class="params">(<span class="keyword">final</span> String processClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">final</span> String niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String abi,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String[] zygoteArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> zygoteProcess.start(processClass, niceName, uid, gid, gids,</span><br><span class="line">                runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">                abi, instructionSet, appDataDir, invokeWith, zygoteArgs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Process.<span class="function">ProcessStartResult <span class="title">start</span><span class="params">(<span class="keyword">final</span> String processClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> String niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String abi,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String[] zygoteArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</span><br><span class="line">                              runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">                              abi, instructionSet, appDataDir, invokeWith, <span class="keyword">false</span> <span class="comment">/* startChildZygote */</span>,</span><br><span class="line">                              zygoteArgs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ZygoteStartFailedEx ex) &#123;</span><br><span class="line">        Log.e(LOG_TAG,</span><br><span class="line">              <span class="string">&quot;Starting VM process through Zygote failed&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">&quot;Starting VM process through Zygote failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Process.<span class="function">ProcessStartResult <span class="title">startViaZygote</span><span class="params">(<span class="keyword">final</span> String processClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> String niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> gid,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String abi,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">boolean</span> startChildZygote,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String[] extraArgs)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    ArrayList&lt;String&gt; argsForZygote = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --runtime-args, --setuid=, --setgid=,</span></span><br><span class="line">    <span class="comment">// and --setgroups= must go first</span></span><br><span class="line">    argsForZygote.add(<span class="string">&quot;--runtime-args&quot;</span>);</span><br><span class="line">    argsForZygote.add(<span class="string">&quot;--setuid=&quot;</span> + uid);</span><br><span class="line">    argsForZygote.add(<span class="string">&quot;--setgid=&quot;</span> + gid);</span><br><span class="line">    argsForZygote.add(<span class="string">&quot;--runtime-flags=&quot;</span> + runtimeFlags);</span><br><span class="line">    <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_DEFAULT) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--mount-external-default&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_READ) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--mount-external-read&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_WRITE) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--mount-external-write&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    argsForZygote.add(<span class="string">&quot;--target-sdk-version=&quot;</span> + targetSdkVersion);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --setgroups is a comma-separated list</span></span><br><span class="line">    <span class="keyword">if</span> (gids != <span class="keyword">null</span> &amp;&amp; gids.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(<span class="string">&quot;--setgroups=&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> sz = gids.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                sb.append(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(gids[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        argsForZygote.add(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (niceName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--nice-name=&quot;</span> + niceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (seInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--seinfo=&quot;</span> + seInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (instructionSet != <span class="keyword">null</span>) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--instruction-set=&quot;</span> + instructionSet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (appDataDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--app-data-dir=&quot;</span> + appDataDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (invokeWith != <span class="keyword">null</span>) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--invoke-with&quot;</span>);</span><br><span class="line">        argsForZygote.add(invokeWith);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (startChildZygote) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--start-child-zygote&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    argsForZygote.add(processClass);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (extraArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String arg : extraArgs) &#123;</span><br><span class="line">            argsForZygote.add(arg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(mLock) &#123;</span><br><span class="line">        <span class="keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过socket 检查新进程的启动情况</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Process.<span class="function">ProcessStartResult <span class="title">zygoteSendArgsAndGetResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ZygoteState zygoteState, ArrayList&lt;String&gt; args)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> BufferedWriter writer = zygoteState.writer;</span><br><span class="line">        <span class="keyword">final</span> DataInputStream inputStream = zygoteState.inputStream;</span><br><span class="line"></span><br><span class="line">        writer.write(Integer.toString(args.size()));</span><br><span class="line">        writer.newLine();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</span><br><span class="line">            String arg = args.get(i);</span><br><span class="line">            writer.write(arg);</span><br><span class="line">            writer.newLine();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        writer.flush();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Should there be a timeout on this?</span></span><br><span class="line">        Process.ProcessStartResult result = <span class="keyword">new</span> Process.ProcessStartResult();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Always read the entire result from the input stream to avoid leaving</span></span><br><span class="line">        <span class="comment">// bytes in the stream for future process starts to accidentally stumble</span></span><br><span class="line">        <span class="comment">// upon.</span></span><br><span class="line">        result.pid = inputStream.readInt();</span><br><span class="line">        result.usingWrapper = inputStream.readBoolean();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result.pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        zygoteState.close();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1、-Zygote-进程fork"><a href="#1、-Zygote-进程fork" class="headerlink" title="1、 Zygote 进程fork"></a>1、 Zygote 进程fork</h4><p>Zygote 的fork 过程参考SystemService 的启动流程。Zygote fork 后也是通过反射的方法找到一个main 函数，这时候因为启动的是App 进程。所以这个main 函数为ActivityThread 的main函数。</p>
<p><img src="/2021/07/30/ActivityStart/start_app_process-20211019114037632.jpg" alt="start_app_process"></p>
<ol>
<li><strong>App发起进程</strong>：当从桌面启动应用，则发起进程便是Launcher所在进程；当从某App内启动远程进程，则发送进程便是该App所在进程。发起进程先通过binder发送消息给system_server进程；</li>
<li><strong>system_server进程</strong>：调用Process.start()方法，通过socket向zygote进程发送创建新进程的请求；</li>
<li><strong>zygote进程</strong>：在执行<code>ZygoteInit.main()</code>后便进入<code>runSelectLoop()</code>循环体内，当有客户端连接时便会执行ZygoteConnection.runOnce()方法，再经过层层调用后fork出新的应用进程；</li>
<li><strong>新进程</strong>：执行handleChildProc方法，最后调用ActivityThread.main()方法。</li>
</ol>
<h4 id="2、-fork-后的新进程的-ActivityThread"><a href="#2、-fork-后的新进程的-ActivityThread" class="headerlink" title="2、 fork 后的新进程的 ActivityThread"></a>2、 fork 后的新进程的 ActivityThread</h4><p>fork 以后启动ActivityThread 的main 函数，在Main 函数中完成Looper的初始化，最重要的一个调用就是 attach</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Process.setArgV0(<span class="string">&quot;&lt;pre-initialized&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>, startSeq);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line">    sCurrentActivityThread = <span class="keyword">this</span>;</span><br><span class="line">    mSystemThread = system;</span><br><span class="line">    <span class="keyword">if</span> (!system) &#123;</span><br><span class="line"></span><br><span class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">&quot;&lt;pre-initialized&gt;&quot;</span>,</span><br><span class="line">                                                UserHandle.myUserId());</span><br><span class="line">        RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">        <span class="keyword">final</span> IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mgr.attachApplication(mAppThread, startSeq);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AMS-的-attachApplication"><a href="#AMS-的-attachApplication" class="headerlink" title="AMS 的 attachApplication"></a>AMS 的 attachApplication</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">mgr.attachApplication(mAppThread, startSeq);</span><br></pre></td></tr></table></figure>



<p>AMS 的attachApplication 依次调用了ApplicationThread 的</p>
<ol>
<li>bindApplication   // 创建Application</li>
<li>scheduleTransaction(clientTransaction); // Resume Activity</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">ActivityMangerService.class:</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        attachApplicationLocked(thread, callingPid, callingUid, startSeq);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">int</span> pid, <span class="keyword">int</span> callingUid, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// It&#x27;s possible that process called attachApplication before we got a chance to</span></span><br><span class="line">    <span class="comment">// update the internal state.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (app.isolatedEntryPoint != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.instr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            thread.bindApplication(processName, appInfo, providers,</span><br><span class="line">                                   app.instr.mClass,</span><br><span class="line">                                   profilerInfo, app.instr.mArguments,</span><br><span class="line">                                   app.instr.mWatcher,</span><br><span class="line">                                   app.instr.mUiAutomationConnection, testMode,</span><br><span class="line">                                   mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                                   isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                                   <span class="keyword">new</span> Configuration(getGlobalConfiguration()), app.compat,</span><br><span class="line">                                   getCommonServicesLocked(app.isolated),</span><br><span class="line">                                   mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                                   buildSerial, isAutofillCompatEnabled);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            thread.bindApplication(processName, appInfo, providers, <span class="keyword">null</span>, profilerInfo,</span><br><span class="line">                                   <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, testMode,</span><br><span class="line">                                   mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                                   isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                                   <span class="keyword">new</span> Configuration(getGlobalConfiguration()), app.compat,</span><br><span class="line">                                   getCommonServicesLocked(app.isolated),</span><br><span class="line">                                   mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                                   buildSerial, isAutofillCompatEnabled);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// See if the top visible activity is waiting to run in this process...</span></span><br><span class="line">    <span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">                didSomething = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityDisplay display = mActivityDisplays.valueAt(displayNdx);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = display.getChildCount() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = display.getChildAt(stackNdx);</span><br><span class="line">            <span class="keyword">if</span> (!isFocusedStack(stack)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            stack.getAllRunningVisibleActivitiesLocked(mTmpActivityList);</span><br><span class="line">            <span class="keyword">final</span> ActivityRecord top = stack.topRunningActivityLocked();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> size = mTmpActivityList.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityRecord activity = mTmpActivityList.get(i);</span><br><span class="line">                <span class="keyword">if</span> (activity.app == <span class="keyword">null</span> &amp;&amp; app.uid == activity.info.applicationInfo.uid</span><br><span class="line">                    &amp;&amp; processName.equals(activity.processName)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (realStartActivityLocked(activity, app,</span><br><span class="line">                                                    top == activity <span class="comment">/* andResume */</span>, <span class="keyword">true</span> <span class="comment">/* checkConfig */</span>)) &#123;</span><br><span class="line">                            didSomething = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> e;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> didSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="realStartActivityLocked-见下"><a href="#realStartActivityLocked-见下" class="headerlink" title="realStartActivityLocked 见下"></a>realStartActivityLocked 见下</h4><h3 id="二、realStartActivityLocked"><a href="#二、realStartActivityLocked" class="headerlink" title="二、realStartActivityLocked"></a>二、realStartActivityLocked</h3><p><strong>简述：实质性启动Activity，首先AMS推动包含Launch事务和Resume生命周期事务的ClientTransaction，App进程在ActivityThread的handler中接受并处理，调用handleLaunchActivity()-&gt;perfomLaunchActivity()，此方法中，首先反射创建了Activity对象，并调用了activity.attach()，之后执行onCreate。</strong></p>
<h4 id="1、创建添加activity事务并通过binder将事务交予应用进程执行"><a href="#1、创建添加activity事务并通过binder将事务交予应用进程执行" class="headerlink" title="1、创建添加activity事务并通过binder将事务交予应用进程执行"></a>1、创建添加activity事务并通过binder将事务交予应用进程执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.android.server.am.ActivityStackSupervisor#realStartActivityLocked</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//主要创建事务交给本地执行</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//创建启动activity的事务ClientTransaction对象</span></span><br><span class="line">    <span class="comment">// Create activity launch transaction.</span></span><br><span class="line">    <span class="keyword">final</span> ClientTransaction clientTransaction = ClientTransaction.obtain(app.thread,</span><br><span class="line">            r.appToken);</span><br><span class="line">    <span class="comment">// 添加LaunchActivityItem，该类obtain入参都是应用进程中创建Activity需要的所有信息，到时候会将这些信息组装成ActivityClientRecord交给ActivityThread的performLaunchActivity使用</span></span><br><span class="line">    clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> Intent(r.intent),</span><br><span class="line">            System.identityHashCode(r), r.info,</span><br><span class="line">            mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">            mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">            r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle,</span><br><span class="line">            r.persistentState, results, newIntents, mService.isNextTransitionForward(),</span><br><span class="line">            profilerInfo));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set desired final state.</span></span><br><span class="line">    <span class="comment">//添加执行Resume事务ResumeActivityItem,后续会在本地被执行</span></span><br><span class="line">    <span class="keyword">final</span> ActivityLifecycleItem lifecycleItem;</span><br><span class="line">    <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">        lifecycleItem = ResumeActivityItem.obtain(mService.isNextTransitionForward());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">    &#125;</span><br><span class="line">    clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ClientLifecycleManager.scheduleTransaction就是调用clientTransaction的schedule启动事务然后回收clientTransaction</span></span><br><span class="line">    <span class="comment">// 这里的mService就是AMS</span></span><br><span class="line">    <span class="comment">// 记住上面两个item：LaunchActivityItem和ResumeActivityItem，这是事务的执行单位</span></span><br><span class="line">  mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">		-&gt;</span><br><span class="line"></span><br><span class="line">com.android.server.am.ClientLifecycleManager#scheduleTransaction(ClientTransaction) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把事务交给本地ActivityThread执行。这里通过本地ApplicationThread在服务端的接口IApplicationThread来进行跨进程通信。后面的逻辑就回到了应用程序进程了。</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> IApplicationThread client = transaction.getClient();</span><br><span class="line">        transaction.schedule();</span><br><span class="line">        <span class="keyword">if</span> (!(client <span class="keyword">instanceof</span> Binder)) &#123;</span><br><span class="line">            transaction.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">		-&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里的IApplicationThread是要启动进程的 IBinder 接口</span></span><br><span class="line"><span class="comment">//ApplicationThread是ActivityThread的内部类，IApplicationThread是IBinder代理接口</span></span><br><span class="line"><span class="comment">//这里将逻辑转到应用进程中执行</span></span><br><span class="line"><span class="keyword">private</span> IApplicationThread mClient;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    mClient.scheduleTransaction(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<hr>
<p>————— system_server进程与应用进程切换的分割线 —————-<br>通过AIDL方式又回到应用进程了，调用了IApplicationThread.scheduleTransaction()</p>
<hr>
<h4 id="2、回到应用进程后ActivityThread执行事务创建Activity"><a href="#2、回到应用进程后ActivityThread执行事务创建Activity" class="headerlink" title="2、回到应用进程后ActivityThread执行事务创建Activity"></a>2、回到应用进程后ActivityThread执行事务创建Activity</h4><p><img src="/2021/07/30/ActivityStart/b4b6932d6a8a47e49dbd489f3b4dcd5btplv-k3u1fbpfcp-watermark.awebp" alt="ActivityThread响应启动Activity流程.png"></p>
<p>ApplicationThread.class是 “AIDL接口—— IApplicationThread接口具体实现”，是ActivityThread的内部类，其定义了服务的远程过程调用 (RPC) 接口，即本地进程提供给其他进程通过IPC机制调用的接口：如更新进程状态updateProcessState，scheduleTransaction</p>
<blockquote>
<p>System private API for communicating with the application.   This is given to the activity manager by an application  when it starts up, for the activity manager to tell the application about things it needs to do.</p>
<p>用于与应用程序通信的系统私有API。 这是应用程序在启动时给AMS的，以便AMS告诉应用程序它需要做的事情。  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//ActivityThread#ApplicationThread.class</span></span><br><span class="line"><span class="comment">//ApplicationThread extends IApplicationThread.Stub</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">//ActivityThread 继承 ClientTransactionHandler 的scheduleTransaction方法</span></span><br><span class="line">	ActivityThread.<span class="keyword">this</span>.scheduleTransaction(transaction);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//abstract ClientTransactionHandler.class</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//主要是更新应用进程状态see@ LaunchActivityItem、ResumeActivityItem preExecute</span></span><br><span class="line">        transaction.preExecute(<span class="keyword">this</span>);</span><br><span class="line">    	</span><br><span class="line">    	<span class="comment">//通过Handler发送what为EXECUTE_TRANSACTION，obj为transaction的消息，即ActivityThread中Hanlder实现H.class处理</span></span><br><span class="line">        sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ActivityThread.class</span></span><br><span class="line"><span class="comment">/*  */</span></span><br><span class="line"><span class="keyword">final</span> H mH = <span class="keyword">new</span> H();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TransactionExecutor mTransactionExecutor = <span class="keyword">new</span> TransactionExecutor(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj)</span> </span>&#123;</span><br><span class="line">    sendMessage(what, obj, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, <span class="keyword">boolean</span> async)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(</span><br><span class="line">        TAG, <span class="string">&quot;SCHEDULE &quot;</span> + what + <span class="string">&quot; &quot;</span> + mH.codeToString(what)</span><br><span class="line">        + <span class="string">&quot;: &quot;</span> + arg1 + <span class="string">&quot; / &quot;</span> + obj);</span><br><span class="line">    Message msg = Message.obtain();</span><br><span class="line">    msg.what = what;</span><br><span class="line">    msg.obj = obj;</span><br><span class="line">    msg.arg1 = arg1;</span><br><span class="line">    msg.arg2 = arg2;</span><br><span class="line">    <span class="keyword">if</span> (async) &#123;</span><br><span class="line">        msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mH.sendMessage(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//class H extends Handler </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXECUTE_TRANSACTION = <span class="number">159</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">&quot;&gt;&gt;&gt; handling: &quot;</span> + codeToString(msg.what));</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> EXECUTE_TRANSACTION:</span><br><span class="line">            <span class="keyword">final</span> ClientTransaction transaction = (ClientTransaction) msg.obj;</span><br><span class="line">            mTransactionExecutor.execute(transaction);</span><br><span class="line">            <span class="keyword">if</span> (isSystem()) &#123;</span><br><span class="line">                transaction.recycle();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//其实还是那句话，事务(LaunchActivityItem与ResumeActivityItem)从system_server中通过AIDL的IPC方式，丢到应用进程中的ActivityThread的handler中执行事务的execute方法。</span></span><br></pre></td></tr></table></figure>


<h5 id="a-LaunchActivityItem-ResumeActivityItem-preExecute-execute"><a href="#a-LaunchActivityItem-ResumeActivityItem-preExecute-execute" class="headerlink" title="a. LaunchActivityItem/ResumeActivityItem preExecute/execute"></a>a. LaunchActivityItem/ResumeActivityItem preExecute/execute</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 见上</span></span><br><span class="line"><span class="comment">    ActivityStackSupervisor.realStartActivityLocked()中 &#123;</span></span><br><span class="line"><span class="comment">        ClientTransaction.addCallback(LaunchActivityItem...)</span></span><br><span class="line"><span class="comment">        clientTransaction.setLifecycleStateRequest(ResumeActivityItem实例lifecycleItem);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    //ClientTransaction.class</span></span><br><span class="line"><span class="comment">    public void setLifecycleStateRequest(ActivityLifecycleItem stateRequest) &#123;</span></span><br><span class="line"><span class="comment">        mLifecycleStateRequest = stateRequest;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    public void addCallback(ClientTransactionItem activityCallback) &#123;</span></span><br><span class="line"><span class="comment">        if (mActivityCallbacks == null) &#123;</span></span><br><span class="line"><span class="comment">            mActivityCallbacks = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        mActivityCallbacks.add(activityCallback);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ClientTransaction.java;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preExecute</span><span class="params">(android.app.ClientTransactionHandler clientTransactionHandler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mActivityCallbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> size = mActivityCallbacks.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">mActivityCallbacks.get(i).preExecute(clientTransactionHandler, mActivityToken);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mLifecycleStateRequest != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mLifecycleStateRequest.preExecute(clientTransactionHandler, mActivityToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//TransactionExecutor.class</span></span><br><span class="line"><span class="comment">//(其实就是ActivityThread，依赖倒置)</span></span><br><span class="line"><span class="keyword">private</span> ClientTransactionHandler mTransactionHandler;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TransactionExecutor</span><span class="params">(ClientTransactionHandler clientTransactionHandler)</span> </span>&#123;</span><br><span class="line">	mTransactionHandler = clientTransactionHandler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> IBinder token = transaction.getActivityToken();</span><br><span class="line">    log(<span class="string">&quot;Start resolving transaction for client: &quot;</span> + mTransactionHandler + <span class="string">&quot;, token: &quot;</span> + token);</span><br><span class="line"></span><br><span class="line">    executeCallbacks(transaction);</span><br><span class="line"></span><br><span class="line">    executeLifecycleState(transaction);</span><br><span class="line">    mPendingActions.clear();</span><br><span class="line">    log(<span class="string">&quot;End resolving transaction&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">		-&gt;</span><br><span class="line">		</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeCallbacks</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> size = callbacks.size();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">		<span class="keyword">final</span> ClientTransactionItem item = callbacks.get(i);</span><br><span class="line">		item.execute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">		item.postExecute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;          </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeLifecycleState</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> ActivityLifecycleItem lifecycleItem = transaction.getLifecycleStateRequest();</span><br><span class="line">	lifecycleItem.execute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">	lifecycleItem.postExecute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//preExecute在execute前准备客户端请求。这方面的一个例子可能是通知某些值的挂起更新。ps:更新进程状态</span></span><br><span class="line"><span class="comment">//execute执行请求</span></span><br><span class="line"><span class="comment">//postExecute执行execute后需要执行的所有操作，例如将结果报告给服务器。        </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//LaunchActivityItem.class extends ClientTransactionItem (Parcelable implementation)</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preExecute</span><span class="params">(ClientTransactionHandler client, IBinder token)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">    client.updateProcessState(mProcState, <span class="keyword">false</span>);</span><br><span class="line">    client.updatePendingConfiguration(mCurConfig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransactionHandler client, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityStart&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ActivityClientRecord就是应用进程中的Activity信息，与之对应的是system_server中ActivityRecord类，是系统进程中的Activity信息</span></span><br><span class="line">        ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord(token, mIntent, mIdent, mInfo,</span><br><span class="line">                mOverrideConfig, mCompatInfo, mReferrer, mVoiceInteractor, mState, 						mPersistentState,mPendingResults, mPendingNewIntents, 									mIsForward,mProfilerInfo, client);</span><br><span class="line">     </span><br><span class="line">     	<span class="comment">//这里的client其实ActivityThread</span></span><br><span class="line">        client.handleLaunchActivity(r, pendingActions, <span class="keyword">null</span> <span class="comment">/* customIntent */</span>);</span><br><span class="line">     </span><br><span class="line">        Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ResumeActivityItem.class  extends ClientTransactionItem ActivityLifecycleItem extends ClientTransactionItem (Parcelable implementation)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preExecute</span><span class="params">(ClientTransactionHandler client, IBinder token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mUpdateProcState) &#123;</span><br><span class="line">        client.updateProcessState(mProcState, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransactionHandler client, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">                    PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityResume&quot;</span>);</span><br><span class="line">    client.handleResumeActivity(token, <span class="keyword">true</span> <span class="comment">/* finalStateRequest */</span>, mIsForward,</span><br><span class="line">                                <span class="string">&quot;RESUME_ACTIVITY&quot;</span>);</span><br><span class="line">    Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以启动activity的LaunchActivityItem.execute()中<br><code>client.handleLaunchActivity(r, pendingActions, null /* customIntent */);</code><br>为核心分析应用进程中ActivityThread中启动Activity的流程。</p>
<h5 id="b-handleLaunchActivity"><a href="#b-handleLaunchActivity" class="headerlink" title="b. handleLaunchActivity()"></a>b. handleLaunchActivity()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityThread.class</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">      PendingTransactionActions pendingActions, Intent customIntent)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Initialize before creating the activity</span></span><br><span class="line">    <span class="keyword">if</span> (!ThreadedRenderer.sRendererDisabled) &#123; <span class="comment">//非系统进程才能渲染</span></span><br><span class="line">        GraphicsEnvironment.earlyInitEGL();</span><br><span class="line">    &#125;</span><br><span class="line">	WindowManagerGlobal.initialize();</span><br><span class="line">	<span class="keyword">final</span> Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line">&#125;</span><br><span class="line">		-&gt;</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//package信息</span></span><br><span class="line">	ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 获取activity的包名类型信息</span></span><br><span class="line">    ComponentName component = r.intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = r.intent.resolveActivity(</span><br><span class="line">            mInitialApplication.getPackageManager());</span><br><span class="line">        r.intent.setComponent(component);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                r.activityInfo.targetActivity);</span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 创建context上下文        </span></span><br><span class="line">    ContextImpl appContext = createBaseContextForActivity(r);</span><br><span class="line">            </span><br><span class="line">	<span class="comment">// 反射创建Activity对象(工厂模式)</span></span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess();</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">&quot;Unable to instantiate activity &quot;</span> + component</span><br><span class="line">                + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//获取Application单例（在ActivityThread.attach时创建）</span></span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">        </span><br><span class="line">       </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 为Activity添加window,之后移除对象</span></span><br><span class="line">            Window window = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="keyword">null</span> &amp;&amp; r.mPreserveWindow) &#123;</span><br><span class="line">                window = r.mPendingRemoveWindow;</span><br><span class="line">                r.mPendingRemoveWindow = <span class="keyword">null</span>;</span><br><span class="line">                r.mPendingRemoveWindowManager = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//onAttach</span></span><br><span class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                            r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                            r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                            r.referrer, r.voiceInteractor, window, r.configCallback);</span><br><span class="line">         	</span><br><span class="line">            <span class="comment">//onCreate</span></span><br><span class="line">            mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//LoadedApk.class</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass,Instrumentation 		      instrumentation)</span> </span>&#123;</span><br><span class="line">     <span class="comment">//只有一个application，在应用初始化时才会走到此方法后面的流程</span></span><br><span class="line">     <span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> mApplication;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     Application app = <span class="keyword">null</span>;</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">         ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</span><br><span class="line">         </span><br><span class="line">         <span class="comment">//newApplication反射创建Application(工厂模式)后会顺手调一下app.attach(context);</span></span><br><span class="line">         app = mActivityThread.mInstrumentation.newApplication(cl, appClass, appContext);</span><br><span class="line">         </span><br><span class="line">         appContext.setOuterContext(app);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         <span class="comment">//...</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (instrumentation != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="comment">//具体实现就app.onCreate();</span></span><br><span class="line">             instrumentation.callApplicationOnCreate(app);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             <span class="keyword">if</span> (!instrumentation.onException(app, e)) &#123;</span><br><span class="line">                 Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                 <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                     <span class="string">&quot;Unable to create application &quot;</span> + app.getClass().getName()</span><br><span class="line">                     + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h2 id="003：Activity-Attach"><a href="#003：Activity-Attach" class="headerlink" title="003：Activity.Attach()"></a>003：Activity.Attach()</h2><p><strong>简述：首先初始化Window，具体实现类是PhoneWindow。为其设置WindowManger（具体实现类为WindowManagerImpl）</strong></p>
<p>在Activity的attach方法中，很关键的一点就是初始化Window，从这里就能看到，Window的实现类，是PhoneWindow。PhoneWindow的创建对于我们后面的操作很重要。</p>
<p>mWindow是一个Window类型的变量，但实际上它是一个PhoneWindow对象，与Activity的内容显示相关。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">            Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration config)</span> </span>&#123;</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line"></span><br><span class="line">    mFragments.attachActivity(<span class="keyword">this</span>, mContainer, <span class="keyword">null</span>);</span><br><span class="line">    </span><br><span class="line">    mWindow = PolicyManager.makeNewWindow(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    ... <span class="comment">//将各种参数赋给Activity的成员变量</span></span><br><span class="line"></span><br><span class="line">    mWindow.setWindowManager(</span><br><span class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">            mToken, mComponent.flattenToString(),</span><br><span class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWindow.setContainer(mParent.getWindow());</span><br><span class="line">    &#125;</span><br><span class="line">    mWindowManager = mWindow.getWindowManager();</span><br><span class="line">    mCurrentConfig = config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="004：Activity-onCreate"><a href="#004：Activity-onCreate" class="headerlink" title="004：Activity.onCreate()"></a>004：Activity.onCreate()</h2><p><strong>简述：onCreate()-&gt;setContentView()-&gt;PhoneWindow.setContentView()，在这里初始化了最顶层View（FrameLayout）DecorView；并将layoutResID通过LayoutInflate填充后添加到DecorView中。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        installDecor();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mContentParent.removeAllViews();</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParent.addView(view, params);</span><br><span class="line">    <span class="keyword">final</span> Callback cb = getCallback();</span><br><span class="line">    <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">        cb.onContentChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="005：ActivityThread-handleResumeActivity"><a href="#005：ActivityThread-handleResumeActivity" class="headerlink" title="005：ActivityThread.handleResumeActivity()"></a>005：ActivityThread.handleResumeActivity()</h2><p><strong>简述：</strong></p>
<p><strong>核心就是先调用onResume()，</strong></p>
<p><strong>然后再调用Window#addView(Window也就是上面activity.attach()中初始化的PhoneWindow)。接下来就是走到WindowManager（具体实现在WindowManagerGlobal中）的addView()。首先创建ViewRootImpl然后调用它的setView，setView中最关键的就是就是调用了requestLayout()然后注册Vsync回调回来后ViewRootImpl.performTraversals()，其中先执行了dispatchAttachToWindow（View.post的缓存action执行），后走了performMeasure、performLayout、performDraw测绘三大流程</strong></p>
<ul>
<li><p>performResumeActivity</p>
</li>
<li><p>Window#addView</p>
<p>new ViewRootImpl()</p>
<p>ViewRootImpl.setView()</p>
<p>ViewRootImpl.requestLayout()</p>
<p>ViewRootImpl.scheduleTraversals()</p>
<p>ViewRootImpl.doTraversal();</p>
<p>ViewRootImpl.performTraversals();</p>
</li>
</ul>
<h2 id="0xFF-附录"><a href="#0xFF-附录" class="headerlink" title="0xFF: 附录"></a>0xFF: 附录</h2><h3 id="附录一-execStartActivity"><a href="#附录一-execStartActivity" class="headerlink" title="附录一 execStartActivity"></a>附录一 execStartActivity</h3><h3 id="Android-6-0-9-0-10-0-Instrumentation-execStartActivity"><a href="#Android-6-0-9-0-10-0-Instrumentation-execStartActivity" class="headerlink" title="Android 6.0/9.0/10.0  Instrumentation#execStartActivity"></a>Android 6.0/9.0/10.0  Instrumentation#execStartActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">//Android 6  </span></span><br><span class="line"><span class="comment">//ActivityManagerNative.getDefault()拿到的对象是ActivityManagerProxy，这个类初始化时即构造传入AMS（ServiceManager.getService(&quot;activity&quot;)），由ActivityManagerProxy代理AMS执行startActivity方法</span></span><br><span class="line"> ActivityManagerNative.getDefault()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                        requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">       </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve the system&#x27;s default/global activity manager.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gDefault.get();</span><br><span class="line">&#125;    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            IBinder b = ServiceManager.getService(<span class="string">&quot;activity&quot;</span>);</span><br><span class="line">    ...</span><br><span class="line">            IActivityManager am = asInterface(b);</span><br><span class="line">    ...</span><br><span class="line">            <span class="keyword">return</span> am;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//Android 9  ActivityManagerProxy类已经被去掉了， ActivityManger.getService 获取 AMS 的单例实例，然后调用其 startActivity 方法，实际上这里就是通过 AIDL 来调用 AMS 的 startActivity 方法。</span></span><br><span class="line"></span><br><span class="line">ActivityManager.getService()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                        requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">                        </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IActivityManager <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> IActivityManagerSingleton.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =</span><br><span class="line">            <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">final</span> IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE);</span><br><span class="line">                    <span class="keyword">final</span> IActivityManager am = IActivityManager.Stub.asInterface(b);</span><br><span class="line">                    <span class="keyword">return</span> am;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">                        </span><br><span class="line"><span class="comment">//Andorid 10 新增了一层ActivityTaskManager来管理activity任务，AIDL方式向ServiceManager获取ACTIVITY_TASK_SERVICE服务单例，其具有IActivityTaskManager的方法实现（包括startActivity）</span></span><br><span class="line"><span class="keyword">int</span> result = ActivityTaskManager.getService()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                        requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">android.app.ActivityTaskManager#getService</span><br><span class="line">...</span><br><span class="line">    <span class="meta">@UnsupportedAppUsage(trackingBug = 129726065)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityTaskManager&gt; IActivityTaskManagerSingleton =</span><br><span class="line">            <span class="keyword">new</span> Singleton&lt;IActivityTaskManager&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> IActivityTaskManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">final</span> IBinder b = ServiceManager.getService(Context.ACTIVITY_TASK_SERVICE);</span><br><span class="line">                    <span class="keyword">return</span> IActivityTaskManager.Stub.asInterface(b);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;  </span><br></pre></td></tr></table></figure>



<h3 id="附录二-startPausingLocked"><a href="#附录二-startPausingLocked" class="headerlink" title="附录二 startPausingLocked"></a>附录二 startPausingLocked</h3><h3 id="ActivityStack-startPausingLocked"><a href="#ActivityStack-startPausingLocked" class="headerlink" title="ActivityStack#startPausingLocked"></a>ActivityStack#startPausingLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ActivityStack#startPausingLocked</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//PauseActivityItem继承于ActivityLifecycleItem，又继承于ClientTransactionItem,是Activity负责暂停的事务类。同样继承于ActivityLifecycleItem的负责Activity生命周期的类还有ResumeActivityItem、StopActivityItem等。ActivityLifecycleItem相比其父类多了状态的请求（事务执行后客户端活动应该处于的最后生命周期状态）</span></span><br><span class="line">mService.getLifecycleManager().scheduleTransaction(prev.app.thread, 		prev.appToken, PauseActivityItem.obtain(prev.finishing, userLeaving, 	 prev.configChangeFlags, pauseImmediately));</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="ActivityManager-Display"><a href="#ActivityManager-Display" class="headerlink" title="ActivityManager : Display"></a>ActivityManager : Display</h2><p><strong>ActivityManager : Display / startActivity Android6/7</strong></p>
<p> 简单结论：display 只统计A onPause之后</p>
<p>AMS 启动新ActivityB 并 执行 B的onCreate、onstart、onresume 与 B向WMS注册窗口到编舞者发起的第一次测绘 完成</p>
<p>Activity的启动可以分为三个步骤，以ActivityA启动ActivityB为例，三步骤分别为：</p>
<ol>
<li><p>以ActivityA调用startActivity，到ActivityA成功pause为止</p>
<p>displayTimeStart</p>
</li>
<li><p>ActivityB成功初始化，到执行完resume为止</p>
</li>
<li><p>ActivityB向WSM注册窗口，到第一帧绘制完成为止<br>displayTimeEnd</p>
</li>
</ol>
<h3 id="ActiivtyA-Pause流程"><a href="#ActiivtyA-Pause流程" class="headerlink" title="ActiivtyA Pause流程"></a>ActiivtyA Pause流程</h3><p>当ActivityA使用startActivity方法启动ActivityB时，执行函数链路如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Android 6.0/7.0</span></span><br><span class="line">ActivityA.startActivity-&gt;</span><br><span class="line">Instrumentation.execStartActivity-&gt;</span><br><span class="line">ActivityManagerNative.getDefault.startActivity-&gt;</span><br><span class="line">ActivityManagerService.startActivityAsUser-&gt;</span><br><span class="line">ActivityStarter.startActivityMayWait -&gt;</span><br><span class="line">ActivityStarter.startActivityLocked -&gt;</span><br><span class="line">ActivityStarter.startActivityUnchecked-&gt;</span><br><span class="line">ActivityStackSupervisor.resumeFocusedStackTopActivityLocked-&gt;</span><br><span class="line">ActivityStack.resumeTopActivityUncheckedLocked</span><br><span class="line">    	-&gt;</span><br><span class="line">    </span><br><span class="line">ActivityStack.resumeTopActivityInnerLocked</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">//startPausingLocked()  暂停旧Activity</span></span><br><span class="line">   <span class="comment">//startSpecificActivityLocked(next, true, false);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        -&gt; </span><br><span class="line">ActivityStack.startPausingLocked</span><br><span class="line">        -&gt;</span><br><span class="line">        </span><br><span class="line">ActivityThread#ApplicationThread.schedulePauseActivity-&gt;</span><br><span class="line">ActivityThread.handlePauseActivity-&gt;</span><br><span class="line"> └ActivityA.onPause</span><br><span class="line">ActivityManagerNative.getDefault().activityPaused</span><br></pre></td></tr></table></figure>

<p>当App请求AMS要启动一个新页面的时候，AMS首先会pause掉当前正在显示的Activity，当然，这个Activity可能与请求要开启的Activity不在一个进程，比如点击桌面图标启动App,当前要暂停的Activity就是桌面程序Launcher。在onPause内执行耗时操作是一种很不推荐的做法，从上述调用链路可以看出，如果在onPause内执行了耗时操作，会直接影响到ActivityManagerNative.getDefault().activityPaused()方法的执行，而这个方法的作用就是通知AMS，“当前Activity已经已经成功暂停，可以启动新Activity了”。</p>
<h3 id="ActivityB-Launch流程"><a href="#ActivityB-Launch流程" class="headerlink" title="ActivityB Launch流程"></a>ActivityB Launch流程</h3><p>在AMS接收到App进程对于activityPaused方法的调用后，执行函数链路如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityStack.resumeTopActivityInnerLocked </span></span><br><span class="line">		-&gt;</span><br><span class="line">ActivityStackSupervisor.startSpecificActivityLocked-&gt;  </span><br><span class="line">    	-&gt;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//displayStartTime </span></span><br><span class="line"> └<span class="number">1.</span>启动新进程：ActivityManagerService.startProcessLocked 暂不展开</span><br><span class="line"> └<span class="number">2.</span>当前进程：ActivityStackSupervisor.realStartActivityLocked-&gt;</span><br><span class="line">ActivityThread?ApplicationThread.scheduleLaunchActivity-&gt;</span><br><span class="line">Activity.handleLaunchActivity-&gt;</span><br><span class="line"> └Activity.onCreate</span><br><span class="line"> └Activity.onRestoreInstanceState</span><br><span class="line"> └handleResumeActivity</span><br><span class="line">   └Activity.onStart-&gt;</span><br><span class="line">   └Activity.onResume-&gt;</span><br><span class="line">   └WindowManager.addView-&gt;</span><br></pre></td></tr></table></figure>

<p>AMS在经过一系列方法调用后，通知App进程正式启动一个Actviity，注意如果要启动Activity所在进程不存在，比如点击桌面图标第一次打开应用，或者App本身就是多进程的，要启动的新页面处于另外一个进程，那就需要走到ActivityManagerService.startProcessLocked流程，等新进程启动完毕后再通知AMS，这里不展开。按照正常流程，会依次走过Activity生命周期内的onCreate、onRestoreInstanceState、onStart、onResume方法，这一步的耗时基本也可以看成就是这四个方法的耗时，由于这四个方法是同步调用的，所以可以通过以onCreate方法为起点，onResume方法为终点，统计出这一步骤的总耗时。</p>
<h3 id="ActivityB-Render流程"><a href="#ActivityB-Render流程" class="headerlink" title="ActivityB Render流程"></a>ActivityB Render流程</h3><p>在ActivityB执行完onResume方法后，就可以显示该Activity了，调用流程如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WindowManager.addView-&gt;</span><br><span class="line">WindowManagerImpl.addView-&gt;</span><br><span class="line">ViewRootImpl.setView-&gt;</span><br><span class="line">ViewRootImpl.requestLayout-&gt;</span><br><span class="line"> └ViewRootImpl.scheduleTraversals-&gt;</span><br><span class="line"> └Choreographer.postCallback-&gt;</span><br><span class="line">WindowManagerSerivce.add</span><br></pre></td></tr></table></figure>

<p>这一步的核心实际上是Choreographer.postCallback，向Choreographer注册了一个回调，当Vsync事件到来时，就会执行下面的回调进行ui的渲染</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ViewRootImpl.doTraversal-&gt;</span><br><span class="line">ViewRootImpl.performTraversals-&gt;</span><br><span class="line"> └ViewRootImpl.relayoutWindow</span><br><span class="line"> └ViewRootImpl.performMeasure</span><br><span class="line"> └ViewRootImpl.performLayout</span><br><span class="line"> └ViewRootImpl.performDraw</span><br><span class="line">ViewRootImpl.reportDrawFinished...</span><br><span class="line"></span><br><span class="line">reportLaunchTimeLocked</span><br></pre></td></tr></table></figure>

<p>这里分别执行了performMeasure、performLayout、performDraw，实际上就是对应到DecorView的测量、布局、绘制三个流程。由于Android的UI是个树状结构，作为根View的DecorView的测量、布局、绘制，会调用到所有子View相应的方法，因此，这一步的总耗时就是所有子View在测量、布局、绘制中的耗时之和，如果某个子View在这三个方法中如果进行了耗时操作，就会拖慢整个UI的渲染，进而影响Activity第一帧的渲染速度。</p>
<h2 id="从Window视角看ActivityStart"><a href="#从Window视角看ActivityStart" class="headerlink" title="从Window视角看ActivityStart"></a>从Window视角看ActivityStart</h2><p>当从Window的角度看待Activity的启动过程时，可以看到以下流程：</p>
<ol>
<li><p>在目标进程中，执行Activity.handleLaunchActivity方法，会先获取AMS服务，之后调用Activity.performLaunchActivity</p>
</li>
<li><p>回调目标Activity的onAttach方法，初始化Window及Window相关对象，如PhoneWindow、Token等。<code>    mWindow = new PhoneWindow(this, window, activityConfigCallback);</code></p>
</li>
<li><p>之后回调目标Activity的onCreate方法，然后通过setContentView方法创建一个DecorView对象；</p>
</li>
<li><p>在目标进程中，执行Activity.handleResumeActivity方法，会回调目标Activity的onResume方法，然后调用目标Activity的makeVisible方法；在makeVisible方法中，会调用WindowManagerImpl.addView方法绘制View，并通过Binder远程调用WMS添加Window。<code>ViewManager wm = getWindowManager();wm.addView(mDecor, getWindow().getAttributes());</code></p>
</li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>ActivityStart</p><p><a href="http://example.com/2021/07/30/ActivityStart/">http://example.com/2021/07/30/ActivityStart/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>white crow</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-07-30</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-12-05</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/CoreProcess/">CoreProcess</a><a class="link-muted mr-2" rel="tag" href="/tags/Core/">Core</a><a class="link-muted mr-2" rel="tag" href="/tags/SystemService/">SystemService</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/09/30/Glide/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Glide</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/07/30/Emty/"><span class="level-item">empty</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#0x01-从activity-startActivity到onPuase"><span class="level-left"><span class="level-item">1</span><span class="level-item">0x01: 从activity.startActivity到onPuase()</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#一、ActivityManagerService"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">一、ActivityManagerService</span></span></a></li><li><a class="level is-mobile" href="#二、ActivityStarter"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">二、ActivityStarter</span></span></a></li><li><a class="level is-mobile" href="#三、ActivityStackSupervisor"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">三、ActivityStackSupervisor</span></span></a></li><li><a class="level is-mobile" href="#四、ActivityStack"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">四、ActivityStack</span></span></a></li><li><a class="level is-mobile" href="#小结"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">小结:</span></span></a></li></ul></li><li><a class="level is-mobile" href="#0x02-AMS启动新的Activity"><span class="level-left"><span class="level-item">2</span><span class="level-item">0x02: AMS启动新的Activity</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#一、startProcessLocked"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">一、startProcessLocked</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1、-Zygote-进程fork"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">1、 Zygote 进程fork</span></span></a></li><li><a class="level is-mobile" href="#2、-fork-后的新进程的-ActivityThread"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">2、 fork 后的新进程的 ActivityThread</span></span></a></li><li><a class="level is-mobile" href="#AMS-的-attachApplication"><span class="level-left"><span class="level-item">2.1.3</span><span class="level-item">AMS 的 attachApplication</span></span></a></li><li><a class="level is-mobile" href="#realStartActivityLocked-见下"><span class="level-left"><span class="level-item">2.1.4</span><span class="level-item">realStartActivityLocked 见下</span></span></a></li></ul></li><li><a class="level is-mobile" href="#二、realStartActivityLocked"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">二、realStartActivityLocked</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1、创建添加activity事务并通过binder将事务交予应用进程执行"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">1、创建添加activity事务并通过binder将事务交予应用进程执行</span></span></a></li><li><a class="level is-mobile" href="#2、回到应用进程后ActivityThread执行事务创建Activity"><span class="level-left"><span class="level-item">2.2.2</span><span class="level-item">2、回到应用进程后ActivityThread执行事务创建Activity</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#a-LaunchActivityItem-ResumeActivityItem-preExecute-execute"><span class="level-left"><span class="level-item">2.2.2.1</span><span class="level-item">a. LaunchActivityItem/ResumeActivityItem preExecute/execute</span></span></a></li><li><a class="level is-mobile" href="#b-handleLaunchActivity"><span class="level-left"><span class="level-item">2.2.2.2</span><span class="level-item">b. handleLaunchActivity()</span></span></a></li></ul></li></ul></li></ul></li><li><a class="level is-mobile" href="#003：Activity-Attach"><span class="level-left"><span class="level-item">3</span><span class="level-item">003：Activity.Attach()</span></span></a></li><li><a class="level is-mobile" href="#004：Activity-onCreate"><span class="level-left"><span class="level-item">4</span><span class="level-item">004：Activity.onCreate()</span></span></a></li><li><a class="level is-mobile" href="#005：ActivityThread-handleResumeActivity"><span class="level-left"><span class="level-item">5</span><span class="level-item">005：ActivityThread.handleResumeActivity()</span></span></a></li><li><a class="level is-mobile" href="#0xFF-附录"><span class="level-left"><span class="level-item">6</span><span class="level-item">0xFF: 附录</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#附录一-execStartActivity"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">附录一 execStartActivity</span></span></a></li><li><a class="level is-mobile" href="#Android-6-0-9-0-10-0-Instrumentation-execStartActivity"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">Android 6.0/9.0/10.0  Instrumentation#execStartActivity</span></span></a></li><li><a class="level is-mobile" href="#附录二-startPausingLocked"><span class="level-left"><span class="level-item">6.3</span><span class="level-item">附录二 startPausingLocked</span></span></a></li><li><a class="level is-mobile" href="#ActivityStack-startPausingLocked"><span class="level-left"><span class="level-item">6.4</span><span class="level-item">ActivityStack#startPausingLocked</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ActivityManager-Display"><span class="level-left"><span class="level-item">7</span><span class="level-item">ActivityManager : Display</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ActiivtyA-Pause流程"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">ActiivtyA Pause流程</span></span></a></li><li><a class="level is-mobile" href="#ActivityB-Launch流程"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">ActivityB Launch流程</span></span></a></li><li><a class="level is-mobile" href="#ActivityB-Render流程"><span class="level-left"><span class="level-item">7.3</span><span class="level-item">ActivityB Render流程</span></span></a></li></ul></li><li><a class="level is-mobile" href="#从Window视角看ActivityStart"><span class="level-left"><span class="level-item">8</span><span class="level-item">从Window视角看ActivityStart</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatarPng.png" alt="White Crow"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">White Crow</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">80</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">4</p></a></div></div></nav></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a><p class="is-size-7"><span>&copy; 2025 white crow</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://github.com/WhileCrow"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>