<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>MVXArchitecture - Crow&#039;s Sky</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Crow&#039;s Sky"><meta name="msapplication-TileImage" content="/img/avatarCircle.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Crow&#039;s Sky"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="MVC View：XML布局文件。 Model：实体模型（数据的获取、存储、数据状态变化）。 Controller：对应于Activity，处理数据、业务和UI。  从上面这个结构来看，Android本身的设计还是符合MVC架构的，但是Android中纯粹作为View的XML视图功能太弱，我们大量处理View的逻辑只能写在Activity中，这样Activity就充当了View和Controlle"><meta property="og:type" content="blog"><meta property="og:title" content="MVXArchitecture"><meta property="og:url" content="http://example.com/2021/11/09/MVXArchitecture/"><meta property="og:site_name" content="Crow&#039;s Sky"><meta property="og:description" content="MVC View：XML布局文件。 Model：实体模型（数据的获取、存储、数据状态变化）。 Controller：对应于Activity，处理数据、业务和UI。  从上面这个结构来看，Android本身的设计还是符合MVC架构的，但是Android中纯粹作为View的XML视图功能太弱，我们大量处理View的逻辑只能写在Activity中，这样Activity就充当了View和Controlle"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://example.com/2021/11/09/MVXArchitecture/640-20211125112856239"><meta property="og:image" content="http://example.com/2021/11/09/MVXArchitecture/640-20211125112856243"><meta property="article:published_time" content="2021-11-09T03:49:45.000Z"><meta property="article:modified_time" content="2024-12-16T09:20:03.650Z"><meta property="article:author" content="White Crow"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2021/11/09/MVXArchitecture/640-20211125112856239"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/11/09/MVXArchitecture/"},"headline":"MVXArchitecture","image":[],"datePublished":"2021-11-09T03:49:45.000Z","dateModified":"2024-12-16T09:20:03.650Z","author":{"@type":"Person","name":"white crow"},"publisher":{"@type":"Organization","name":"Crow's Sky","logo":{"@type":"ImageObject","url":"http://example.com/img/avatarCircle.png"}},"description":"MVC View：XML布局文件。 Model：实体模型（数据的获取、存储、数据状态变化）。 Controller：对应于Activity，处理数据、业务和UI。  从上面这个结构来看，Android本身的设计还是符合MVC架构的，但是Android中纯粹作为View的XML视图功能太弱，我们大量处理View的逻辑只能写在Activity中，这样Activity就充当了View和Controlle"}</script><link rel="canonical" href="http://example.com/2021/11/09/MVXArchitecture/"><link rel="icon" href="/img/avatarCircle.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/WhileCrow"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-10-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-11-09T03:49:45.000Z" title="11/9/2021, 11:49:45 AM">2021-11-09</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-16T09:20:03.650Z" title="12/16/2024, 5:20:03 PM">2024-12-16</time></span><span class="level-item"><a class="link-muted" href="/categories/Common/">Common</a></span><span class="level-item">23 minutes read (About 3463 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">MVXArchitecture</h1><div class="content"><h1 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h1><blockquote>
<p><strong>View：</strong>XML布局文件。 <strong>Model：</strong>实体模型（数据的获取、存储、数据状态变化）。 <strong>Controller：</strong>对应于Activity，处理数据、业务和UI。</p>
</blockquote>
<p>从上面这个结构来看，Android本身的设计还是符合MVC架构的，但是Android中纯粹作为View的XML视图功能太弱，我们大量处理View的逻辑只能写在Activity中，这样Activity就充当了View和Controller两个角色，直接导致Activity中的代码大爆炸。相信大多数Android开发者都遇到过一个Acitivty数以千行的代码情况吧！所以，更贴切的说法是，这个MVC结构最终其实只是一个Model-View（Activity:View&amp;Controller）的结构。</p>
<span id="more"></span>

<h1 id="MVP"><a href="#MVP" class="headerlink" title="MVP"></a>MVP</h1><blockquote>
<p>**View: **对应于Activity和XML，负责View的绘制以及与用户的交互。 **Model: **依然是实体模型。 **Presenter: **负责完成View与Model间的交互和业务逻辑。</p>
</blockquote>
<p>前面我们说，Activity充当了View和Controller两个角色，MVP就能很好地解决这个问题，其核心理念是通过一个抽象的View接口（不是真正的View层）将Presenter与真正的View层进行解耦。Persenter持有该View接口，对该接口进行操作，而不是直接操作View层。这样就可以把视图操作和业务逻辑解耦，从而让Activity成为真正的View层。</p>
<p>但MVP也存在一些弊端：</p>
<ul>
<li>Presenter（以下简称P）层与View（以下简称V）层是通过接口进行交互的，接口粒度不好控制。粒度太小，就会存在大量接口的情况，使代码太过碎版化；粒度太大，解耦效果不好。同时对于UI的输入和数据的变化，需要手动调用V层或者P层相关的接口，相对来说缺乏自动性、监听性。如果数据的变化能自动响应到UI、UI的输入能自动更新到数据，那该多好！</li>
<li>MVP是以UI为驱动的模型，更新UI都需要保证能获取到控件的引用，同时更新UI的时候要考虑当前是否是UI线程，也要考虑Activity的生命周期（是否已经销毁等）。</li>
<li>MVP是以UI和事件为驱动的传统模型，数据都是被动地通过UI控件做展示，但是由于数据的时变性，我们更希望数据能转被动为主动，希望数据能更有活性，由数据来驱动UI。</li>
<li>V层与P层还是有一定的耦合度。一旦V层某个UI元素更改，那么对应的接口就必须得改，数据如何映射到UI上、事件监听接口这些都需要转变，牵一发而动全身。如果这一层也能解耦就更好了。</li>
<li>复杂的业务同时也可能会导致P层太大，代码臃肿的问题依然不能解决。</li>
</ul>
<h1 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h1><blockquote>
<p>**View: **对应于Activity和XML，负责View的绘制以及与用户交互。 **Model: **实体模型。 **ViewModel: **负责完成View与Model间的交互，负责业务逻辑。</p>
</blockquote>
<p>MVVM的目标和思想与MVP类似，利用数据绑定(Data Binding)、依赖属性(Dependency Property)、命令(Command)、路由事件(Routed Event)等新特性，打造了一个更加灵活高效的架构。</p>
<h2 id="数据驱动"><a href="#数据驱动" class="headerlink" title="数据驱动"></a>数据驱动</h2><p>在常规的开发模式中，数据变化需要更新UI的时候，需要先获取UI控件的引用，然后再更新UI。获取用户的输入和操作也需要通过UI控件的引用。在MVVM中，这些都是通过数据驱动来自动完成的，数据变化后会自动更新UI，UI的改变也能自动反馈到数据层，数据成为主导因素。这样MVVM层在业务逻辑处理中只要关心数据，不需要直接和UI打交道，在业务处理过程中简单方便很多。</p>
<h2 id="低耦合度"><a href="#低耦合度" class="headerlink" title="低耦合度"></a>低耦合度</h2><p>MVVM模式中，数据是独立于UI的。</p>
<p>数据和业务逻辑处于一个独立的ViewModel中，ViewModel只需要关注数据和业务逻辑，不需要和UI或者控件打交道。UI想怎么处理数据都由UI自己决定，ViewModel不涉及任何和UI相关的事，也不持有UI控件的引用。即便是控件改变了（比如：TextView换成EditText），ViewModel也几乎不需要更改任何代码。它非常完美的解耦了View层和ViewModel，解决了上面我们所说的MVP的痛点。</p>
<h2 id="更新UI"><a href="#更新UI" class="headerlink" title="更新UI"></a>更新UI</h2><p>在MVVM中，数据发生变化后，我们在工作线程直接修改（在数据是线程安全的情况下）ViewModel的数据即可，不用再考虑要切到主线程更新UI了，这些事情相关框架都帮我们做了。</p>
<h2 id="团队协作"><a href="#团队协作" class="headerlink" title="团队协作"></a>团队协作</h2><p>MVVM的分工是非常明显的，由于View和ViewModel之间是松散耦合的：一个是处理业务和数据、一个是专门的UI处理。所以，完全由两个人分工来做，一个做UI（XML和Activity）一个写ViewModel，效率更高。</p>
<h2 id="可复用性"><a href="#可复用性" class="headerlink" title="可复用性"></a>可复用性</h2><p>一个ViewModel可以复用到多个View中。同样的一份数据，可以提供给不同的UI去做展示。对于版本迭代中频繁的UI改动，更新或新增一套View即可。如果想在UI上做A/B Testing，那MVVM是你不二选择。</p>
<p>MVVM：</p>
<h2 id="MVVM架构介绍"><a href="#MVVM架构介绍" class="headerlink" title="MVVM架构介绍"></a><strong>MVVM架构介绍</strong></h2><p>MVVM 模式将 Presenter 改名为 ViewModel，基本上与 MVP 模式完全一致。唯一的区别是，它采用双向数据绑定（data-binding）：View的变动，自动反映在 ViewModel，反之亦然。</p>
<p>MVVM架构图如下所示：</p>
<p><img src="/2021/11/09/MVXArchitecture/640-20211125112856239" alt="图片"></p>
<p>可以看出MVVM与MVP的主要区别在于,你不用去主动去刷新UI了，只要Model数据变了，会自动反映到UI上。换句话说，MVVM更像是自动化的MVP。</p>
<p>MVVM的双向数据绑定主要通过DataBinding实现，不过相信有很多人跟我一样，是不喜欢用DataBinding的，这样架构就变成了下面这样。</p>
<p><img src="/2021/11/09/MVXArchitecture/640-20211125112856243" alt="图片"></p>
<ol>
<li><p>View观察ViewModel的数据变化并自我更新，这其实是单一数据源而不是双向数据绑定，所以其实MVVM的这一大特性我其实并没有用到</p>
</li>
<li><p>View通过调用ViewModel提供的方法来与ViewModel交互</p>
</li>
</ol>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ol>
<li>MVC架构的主要问题在于Activity承担了View与Controller两层的职责，同时View层与Model层存在耦合</li>
<li>MVP引入Presenter层解决了MVC架构的两个问题，View只能与Presenter层交互，业务逻辑放在Presenter层</li>
<li>MVP的问题在于随着业务逻辑的增加，View的接口会很庞大，MVVM架构通过双向数据绑定可以解决这个问题</li>
<li>MVVM与MVP的主要区别在于，你不用去主动去刷新UI了，只要Model数据变了，会自动反映到UI上。换句话说，MVVM更像是自动化的MVP。</li>
<li><strong>MVVM的双向数据绑定主要通过DataBinding实现，但有很多人(比如我)不喜欢用DataBinding，而是View通过LiveData等观察ViewModle的数据变化并自我更新,这其实是单一数据源而不是双向数据绑定</strong></li>
</ol>
<h1 id="MVVM补充"><a href="#MVVM补充" class="headerlink" title="MVVM补充"></a>MVVM补充</h1><p>链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904176296673287">https://juejin.cn/post/6844904176296673287</a></p>
<h2 id="数据视图互绑-长生命周期数据"><a href="#数据视图互绑-长生命周期数据" class="headerlink" title="数据视图互绑 + 长生命周期数据"></a>数据视图互绑 + 长生命周期数据</h2><p>即使将访问数据的细节剥离出Presenter，它依然不单纯。因为它持有 View 层接口，这就要求<code>Presenter</code>需了解 <strong>该把哪个数据传递给哪个接口方法</strong>，这就是 <strong>数据绑定</strong>，它在构建视图时就已经确定（无需等到数据返回），所以这个细节可以从业务层剥离，归并到视图层。</p>
<p><code>Presenter</code>的实例被 Activity 持有，所以它的生命周期和 Activiy 同步，即业务数据和界面同生命周期。在某些场景下，这是一个缺点，比如横竖屏切换。此时，如果数据的生命周期不依赖界面，就可以免去重新获取数据的成本。这势必 <strong>需要一个生命周期更长的对象（ViewModel）持有数据。</strong></p>
<h3 id="生命周期更长的-ViewModel"><a href="#生命周期更长的-ViewModel" class="headerlink" title="生命周期更长的 ViewModel"></a>生命周期更长的 ViewModel</h3><blockquote>
<p><strong>最终的持有链如下：NonConfigurationInstances 持有 ViewModelStore 持有 ViewModel。</strong></p>
<p><strong>所以 ViewModel 生命周期比 Activity 更长。这样 ViewModel 中存放的业务数据就可以在 Activity 销毁重建时被复用。</strong></p>
</blockquote>
<p>上一节的例子中，构建 Presenter 是直接在 Activity 中 new，而构建<code>ViewModel</code>是通过<code>ViewModelProvider.get()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModelProvider</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ViewModel 实例商店</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ViewModelStore mViewModelStore;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">get</span><span class="params">(<span class="meta">@NonNull</span> String key, <span class="meta">@NonNull</span> Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 从商店获取 ViewModel实例</span></span><br><span class="line">        ViewModel viewModel = mViewModelStore.get(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (modelClass.isInstance(viewModel)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 若商店无 ViewModel 实例 则通过 Factory 构建</span></span><br><span class="line">        <span class="keyword">if</span> (mFactory <span class="keyword">instanceof</span> KeyedFactory) &#123;</span><br><span class="line">            viewModel = ((KeyedFactory) (mFactory)).create(key, modelClass);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            viewModel = (mFactory).create(modelClass);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将 ViewModel 实例存入商店</span></span><br><span class="line">        mViewModelStore.put(key, viewModel);</span><br><span class="line">        <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>ViewModel</code>实例通过<code>ViewModelStore</code>获取:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewModel 实例商店</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModelStore</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 存储 ViewModel 实例的 Map</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, ViewModel&gt; mMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, ViewModel viewModel)</span> </span>&#123;</span><br><span class="line">        ViewModel oldViewModel = mMap.put(key, viewModel);</span><br><span class="line">        <span class="keyword">if</span> (oldViewModel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            oldViewModel.onCleared();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> ViewModel <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>ViewModelStore</code>将<code>ViewModel</code>实例存储在<code>HashMap</code>中。</p>
<p>而<code>ViewModelStore</code>通过<code>ViewModelStoreOwner</code>获取:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModelProvider</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ViewModel 实例商店</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ViewModelStore mViewModelStore;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造 ViewModelProvider 时需传入 ViewModelStoreOwner 实例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewModelProvider</span><span class="params">(<span class="meta">@NonNull</span> ViewModelStoreOwner owner, <span class="meta">@NonNull</span> Factory factory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 通过 ViewModelStoreOwner 获取 ViewModelStore </span></span><br><span class="line">        <span class="keyword">this</span>(owner.getViewModelStore(), factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewModelProvider</span><span class="params">(<span class="meta">@NonNull</span> ViewModelStore store, <span class="meta">@NonNull</span> Factory factory)</span> </span>&#123;</span><br><span class="line">        mFactory = factory;</span><br><span class="line">        mViewModelStore = store;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那<code>ViewModelStoreOwner</code>实例又存储在哪？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Activity 基类实现了 ViewModelStoreOwner 接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComponentActivity</span> <span class="keyword">extends</span> <span class="title">androidx</span>.<span class="title">core</span>.<span class="title">app</span>.<span class="title">ComponentActivity</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">LifecycleOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ViewModelStoreOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">SavedStateRegistryOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">OnBackPressedDispatcherOwner</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Activity 持有 ViewModelStore 实例</span></span><br><span class="line">        <span class="keyword">private</span> ViewModelStore mViewModelStore;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> ViewModelStore <span class="title">getViewModelStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (mViewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 获取配置无关实例</span></span><br><span class="line">                NonConfigurationInstances nc =(NonConfigurationInstances) getLastNonConfigurationInstance();</span><br><span class="line">                <span class="keyword">if</span> (nc != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 从配置无关实例中恢复 ViewModel商店</span></span><br><span class="line">                    mViewModelStore = nc.viewModelStore;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mViewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mViewModelStore = <span class="keyword">new</span> ViewModelStore();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mViewModelStore;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 静态的配置无关实例</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonConfigurationInstances</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 持有 ViewModel商店实例</span></span><br><span class="line">            ViewModelStore viewModelStore;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Activity 就是<code>ViewModelStoreOwner</code>实例，且持有<code>ViewModelStore</code>实例，该实例还会被保存在一个静态类中。</p>
<p>最终的持有链如下：NonConfigurationInstances 持有 ViewModelStore 持有 ViewModel。</p>
<p>所以 ViewModel 生命周期比 Activity 更长。这样 ViewModel 中存放的业务数据就可以在 Activity 销毁重建时被复用。</p>
<h3 id="数据绑定"><a href="#数据绑定" class="headerlink" title="数据绑定"></a>数据绑定</h3><blockquote>
<p><strong>在 MVP 模式中，Presenter 持有 View 层接口并主动向界面推数据。</strong></p>
<p><strong>MVVM 模式中，ViewModel 不再持有 View 层接口，也不主动给界面推数据，而是界面被动地观察数据变化。</strong></p>
<p><strong>MVVM 这种更新界面的方式称为 “数据驱动”，即只需更新数据即可，因为界面会主动观察数据的变化并做出响应。</strong></p>
<p><strong>这使得 ViewModel 只需持有数据并根据业务逻辑更新之即可</strong></p>
</blockquote>
<p>MVVM中Activity 属于V层，布局构建以及数据绑定都在这层完成：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MvvmActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> rvNews: RecyclerView? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> newsAdapter = NewsAdapter()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建布局</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> rootView <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        ConstraintLayout &#123;</span><br><span class="line">            TextView &#123;</span><br><span class="line">                layout_id = <span class="string">&quot;tvTitle&quot;</span></span><br><span class="line">                layout_width = wrap_content</span><br><span class="line">                layout_height = wrap_content</span><br><span class="line">                textSize = <span class="number">25f</span></span><br><span class="line">                padding_start = <span class="number">20</span></span><br><span class="line">                padding_end = <span class="number">20</span></span><br><span class="line">                center_horizontal = <span class="literal">true</span></span><br><span class="line">                text = <span class="string">&quot;News&quot;</span></span><br><span class="line">                top_toTopOf = parent_id</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rvNews = RecyclerView &#123;</span><br><span class="line">                layout_id = <span class="string">&quot;rvNews&quot;</span></span><br><span class="line">                layout_width = match_parent</span><br><span class="line">                layout_height = wrap_content</span><br><span class="line">                top_toBottomOf = <span class="string">&quot;tvTitle&quot;</span></span><br><span class="line">                margin_top = <span class="number">10</span></span><br><span class="line">                center_horizontal = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建 ViewModel 实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> newsViewModel <span class="keyword">by</span> lazy &#123; </span><br><span class="line">        <span class="comment">// 构造 ViewModelProvider 实例, 通过其 get() 获得 ViewModel 实例</span></span><br><span class="line">        ViewModelProvider(<span class="keyword">this</span>, NewsFactory(applicationContext)).<span class="keyword">get</span>(NewsViewModel::<span class="keyword">class</span>.java) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(rootView)</span><br><span class="line">        initView()</span><br><span class="line">        bindData()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将数据绑定到视图</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">bindData</span><span class="params">()</span></span> &#123;</span><br><span class="line">        newsViewModel.newsLiveData.observe(<span class="keyword">this</span>, Observer &#123;</span><br><span class="line">            newsAdapter.news = it</span><br><span class="line">            rvNews?.adapter = newsAdapter</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initView</span><span class="params">()</span></span> &#123;</span><br><span class="line">        rvNews?.layoutManager = LinearLayoutManager(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中构建布局 DSL 的详细介绍可以点击<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904153068601357">这里</a>。它省去了原先<code>V</code>层( Activity + xml )中的 xml。</p>
<p>代码中的数据绑定是通过观察 ViewModel 中的 LiveData 实现的。这不是数据绑定的完全体，所以还需手动地观察 observe 数据变化（只有当引入<code>data-binding</code>包后，才能把视图和控件的绑定都静态化到 xml 中）。但至少它让 ViewModel 无需主动推数据了:</p>
<blockquote>
<p>在 MVP 模式中，Presenter 持有 View 层接口并主动向界面推数据。</p>
</blockquote>
<blockquote>
<p>MVVM 模式中，ViewModel 不再持有 View 层接口，也不主动给界面推数据，而是界面被动地观察数据变化。</p>
</blockquote>
<p>MVVM 这种更新界面的方式称为 <strong>“数据驱动”</strong>，即只需更新数据即可，因为界面会主动观察数据的变化并做出响应。</p>
<p>这使得 ViewModel 只需持有数据并根据业务逻辑更新之即可:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据访问接口在构造函数中注入</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewsViewModel</span></span>(<span class="keyword">var</span> newsRepository: NewsRepository) : ViewModel() &#123;</span><br><span class="line">    <span class="comment">// 持有业务数据</span></span><br><span class="line">    <span class="keyword">val</span> newsLiveData <span class="keyword">by</span> lazy &#123; newsRepository.fetchNewsLiveData() &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义构造 ViewModel 方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewsFactory</span></span>(context: Context) : ViewModelProvider.Factory &#123;</span><br><span class="line">    <span class="comment">// 构造 数据访问接口实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> newsRepository = NewsRepositoryImpl(context)</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel?&gt;</span> <span class="title">create</span><span class="params">(modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T &#123;</span><br><span class="line">        <span class="comment">// 将数据接口访问实例注入 ViewModel </span></span><br><span class="line">        <span class="keyword">return</span> NewsViewModel(newsRepository) <span class="keyword">as</span> T</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 然后就可以在 Activity 中这样构造 ViewModel 了</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MvvmActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="comment">// 构建 ViewModel 实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> newsViewModel <span class="keyword">by</span> lazy &#123; </span><br><span class="line">        ViewModelProvider(<span class="keyword">this</span>, NewsFactory(applicationContext)).<span class="keyword">get</span>(NewsViewModel::<span class="keyword">class</span>.java) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ViewModel只关心业务逻辑和数据，不关心获取数据的细节，所以它们都<strong>被数据访问接口</strong>隐藏了。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>MVXArchitecture</p><p><a href="http://example.com/2021/11/09/MVXArchitecture/">http://example.com/2021/11/09/MVXArchitecture/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>white crow</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-11-09</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-12-16</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/11/11/Socket/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Socket</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/11/02/ANR/"><span class="level-item">ANR</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#MVC"><span class="level-left"><span class="level-item">1</span><span class="level-item">MVC</span></span></a></li><li><a class="level is-mobile" href="#MVP"><span class="level-left"><span class="level-item">2</span><span class="level-item">MVP</span></span></a></li><li><a class="level is-mobile" href="#MVVM"><span class="level-left"><span class="level-item">3</span><span class="level-item">MVVM</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#数据驱动"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">数据驱动</span></span></a></li><li><a class="level is-mobile" href="#低耦合度"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">低耦合度</span></span></a></li><li><a class="level is-mobile" href="#更新UI"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">更新UI</span></span></a></li><li><a class="level is-mobile" href="#团队协作"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">团队协作</span></span></a></li><li><a class="level is-mobile" href="#可复用性"><span class="level-left"><span class="level-item">3.5</span><span class="level-item">可复用性</span></span></a></li><li><a class="level is-mobile" href="#MVVM架构介绍"><span class="level-left"><span class="level-item">3.6</span><span class="level-item">MVVM架构介绍</span></span></a></li><li><a class="level is-mobile" href="#小结"><span class="level-left"><span class="level-item">3.7</span><span class="level-item">小结</span></span></a></li></ul></li><li><a class="level is-mobile" href="#MVVM补充"><span class="level-left"><span class="level-item">4</span><span class="level-item">MVVM补充</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#数据视图互绑-长生命周期数据"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">数据视图互绑 + 长生命周期数据</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#生命周期更长的-ViewModel"><span class="level-left"><span class="level-item">4.1.1</span><span class="level-item">生命周期更长的 ViewModel</span></span></a></li><li><a class="level is-mobile" href="#数据绑定"><span class="level-left"><span class="level-item">4.1.2</span><span class="level-item">数据绑定</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatarPng.png" alt="White Crow"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">White Crow</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">81</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">4</p></a></div></div></nav></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a><p class="is-size-7"><span>&copy; 2025 white crow</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://github.com/WhileCrow"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>