<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Glide - Crow&#039;s Sky</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Crow&#039;s Sky"><meta name="msapplication-TileImage" content="/img/avatarCircle.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Crow&#039;s Sky"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Glide缓存： 三级缓存： 活动缓存(activeResources: Map&amp;lt;Key, ResourceWeakReference&amp;gt;) key为EngineKey对象，value为弱引用的图片缓存ResourceWeakReference实例 正在使用的图片缓存（被ImageView或Activity引用的），在ImageView移除或Activity销毁时被移到内存缓存  内存缓"><meta property="og:type" content="blog"><meta property="og:title" content="Glide"><meta property="og:url" content="http://example.com/2021/09/30/Glide/"><meta property="og:site_name" content="Crow&#039;s Sky"><meta property="og:description" content="Glide缓存： 三级缓存： 活动缓存(activeResources: Map&amp;lt;Key, ResourceWeakReference&amp;gt;) key为EngineKey对象，value为弱引用的图片缓存ResourceWeakReference实例 正在使用的图片缓存（被ImageView或Activity引用的），在ImageView移除或Activity销毁时被移到内存缓存  内存缓"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://example.com/2021/09/30/Glide/b784f4ad31217d419faedc0d0efc595f.jpg"><meta property="og:image" content="http://example.com/2021/09/30/Glide/Glide//image-20240709154704558.png"><meta property="og:image" content="http://example.com/2021/09/30/Glide/Glide//image-20240815114741925.png"><meta property="og:image" content="http://example.com/2021/09/30/Glide/Glide//image-20240815203503827.png"><meta property="article:published_time" content="2021-09-30T06:00:40.000Z"><meta property="article:modified_time" content="2024-09-10T07:17:39.663Z"><meta property="article:author" content="White Crow"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2021/09/30/Glide/b784f4ad31217d419faedc0d0efc595f.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/09/30/Glide/"},"headline":"Glide","image":["http://example.com/2021/09/30/Glide/b784f4ad31217d419faedc0d0efc595f.jpg","http://example.com/2021/09/30/Glide/Glide//image-20240709154704558.png","http://example.com/2021/09/30/Glide/Glide//image-20240815114741925.png","http://example.com/2021/09/30/Glide/Glide//image-20240815203503827.png"],"datePublished":"2021-09-30T06:00:40.000Z","dateModified":"2024-09-10T07:17:39.663Z","author":{"@type":"Person","name":"white crow"},"publisher":{"@type":"Organization","name":"Crow's Sky","logo":{"@type":"ImageObject","url":"http://example.com/img/avatarCircle.png"}},"description":"Glide缓存： 三级缓存： 活动缓存(activeResources: Map&lt;Key, ResourceWeakReference&gt;) key为EngineKey对象，value为弱引用的图片缓存ResourceWeakReference实例 正在使用的图片缓存（被ImageView或Activity引用的），在ImageView移除或Activity销毁时被移到内存缓存  内存缓"}</script><link rel="canonical" href="http://example.com/2021/09/30/Glide/"><link rel="icon" href="/img/avatarCircle.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/WhileCrow"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-10-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-09-30T06:00:40.000Z" title="9/30/2021, 2:00:40 PM">2021-09-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-10T07:17:39.663Z" title="9/10/2024, 3:17:39 PM">2024-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/Android/">Android</a></span><span class="level-item">33 minutes read (About 4919 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Glide</h1><div class="content"><p>Glide缓存：</p>
<h3 id="三级缓存："><a href="#三级缓存：" class="headerlink" title="三级缓存："></a>三级缓存：</h3><ul>
<li><p><strong>活动缓存(activeResources: Map&lt;Key, ResourceWeakReference&gt;)</strong></p>
<p><strong>key为EngineKey对象，value为弱引用的图片缓存ResourceWeakReference实例</strong></p>
<p>正在使用的图片缓存（被ImageView或Activity引用的），在ImageView移除或Activity销毁时被移到<strong>内存缓存</strong></p>
</li>
<li><p><strong>内存缓存(memoryCache: LruCache&lt;Key, Resource&lt;?&gt;&gt;)</strong></p>
<p><strong>key为EngineKey对象，value为图片缓存Resource实例</strong></p>
<p>当图片不再显示时，图片会从活动缓存移到内存缓存。存储的是暂时不用的图片缓存（依靠<strong>图片引用计数器acquired</strong>变量实现，当acquired大于0时存在于活动缓存中，为0是移到内存缓存中）</p>
</li>
<li><p><strong>磁盘缓存（diskLruCache: LinkedHashMap&lt;String, Entry&gt;）</strong></p>
<p><strong>key为使用EngineKey所有参数经过哈希算法加密后的字符串，value为File实例</strong></p>
<p>磁盘缓存大小默认250MB，根据缓存策略的不同可能存储原始图片或转换后的图片。磁盘缓存的存储顺序记录在journal文件中，有时该文件过大会导致glide初始过慢。</p>
<blockquote>
<p>DiskCacheStrategy.ALL ：     //表示既缓存原始图片，也缓存转换过后的图片。<br>DiskCacheStrategy.NONE：     //表示不缓存任何内容。<br>DiskCacheStrategy.RESOURCE： //表示只缓存原始图片。 (推荐)<br>DiskCacheStrategy.DATA：     //表示只缓存转换过后的图片。<br>DiskCacheStrategy.AUTOMATIC  //表示智能判断选择模式（默认选项）。</p>
</blockquote>
</li>
</ul>
<h2 id="Glide缓存"><a href="#Glide缓存" class="headerlink" title="Glide缓存"></a>Glide缓存</h2><p><strong>磁盘(DiskLruCache) -&gt; LRUCache(不活跃资源) -&gt; WeakReference(使用中资源)</strong></p>
<p><strong>内存缓存分为弱引用的和 LruCache ，其中正在使用的图片使用弱引用缓存，暂时不使用的图片用 LruCache缓存，这一点是通过 图片引用计数器（acquired变量）来实现的</strong></p>
<p><img src="/2021/09/30/Glide/b784f4ad31217d419faedc0d0efc595f.jpg" alt="b784f4ad31217d419faedc0d0efc595f"></p>
<p>Glide生成key（内存缓存Key类型为EngineKey）的方式远比我们想象的要复杂，决定缓存Key的参数有8种，其中包括图片URL、宽、高。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EngineKey key = keyFactory.buildKey(model, signature, width, height, transformations,</span><br><span class="line">        resourceClass, transcodeClass, options);</span><br></pre></td></tr></table></figure>

<p>这里可以得出一个结论，几乎任意配置的改变都会导致同一张图片生成多个缓存key。举个例子：同一张图片加载到2个不同大小的ImageView会生成2个缓存图片</p>
<h2 id="Glide-QA"><a href="#Glide-QA" class="headerlink" title="Glide QA"></a>Glide QA</h2><h3 id="glide是怎么拿到的width-height（view未测绘前拿不到宽高）"><a href="#glide是怎么拿到的width-height（view未测绘前拿不到宽高）" class="headerlink" title="glide是怎么拿到的width,height（view未测绘前拿不到宽高）"></a><strong>glide是怎么拿到的width,height（view未测绘前拿不到宽高）</strong></h3><p>width,height能拿到的原因是ViewTarget会为所持有的View注册view树绘制回调</p>
<p><code>addOnPreDrawListener(OnPreDrawListener listener)</code></p>
<p><img src="Glide//image-20240709154704558.png" alt="image-20240709154704558"></p>
<h3 id="Glide的缓存大小默认是多少"><a href="#Glide的缓存大小默认是多少" class="headerlink" title="Glide的缓存大小默认是多少"></a>Glide的缓存大小默认是多少</h3><p><strong>内存缓存最大空间(maxSize) = 每个进程可用的最大内存（activityManager.getMemoryClass()  *  0.4</strong></p>
<p><strong>(低配手机的话是: 每个进程可用的最大内存 * 0.33)</strong></p>
<blockquote>
<p>activityManager.getMemoryClass值：</p>
<ul>
<li>低端设备可能在 16-32 MB 范围内。</li>
<li>中档设备通常在 64-128 MB 范围内。</li>
<li>高端设备和新款设备可能在 256 MB 或更高。//当设置largeHeap时，最多可申请512M</li>
</ul>
</blockquote>
<p><strong>磁盘缓存大小: 默认250MB</strong></p>
<blockquote>
<p><strong>磁盘缓存目录: 项目/cache/image_manager_disk_cache</strong></p>
</blockquote>
<p><img src="Glide//image-20240815114741925.png" alt="image-20240815114741925"></p>
<p>这里有个点：随着图片磁盘缓存的存取，由于每次存取磁盘图片glide都会将存取操作记录到日志文件(journal文件)，日志文件会逐渐增大到可能几兆大小，导致glide初始化延迟（glide的初始化中，磁盘缓存初始化时会涉及到将日志文件读取到内存中操作）。</p>
<p>这里可以增加一个首页模块的磁盘缓存目录，比如<code>项目/cache/image_manager_disk_home_cache</code>，启动时先初始化首页的磁盘缓存(现为10m)再初始化主体的磁盘缓存，避免日志文件过大导致的初始化时间太长阻塞App启动。</p>
<p>//todo </p>
<h2 id="Glide"><a href="#Glide" class="headerlink" title="Glide"></a>Glide</h2><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ol>
<li>会根据控件大小进行下采样，以解码出符合需求的大小，对内存更友好</li>
<li>内存缓存+磁盘缓存</li>
<li>感知生命周期，取消任务，防止内存泄漏</li>
<li>感知内存吃紧，进行回收</li>
<li>BitmapPool，防止内存抖动的进行bitmap��换</li>
<li>定义请求优先级</li>
</ol>
<h3 id="手写一个图片库注意事项"><a href="#手写一个图片库注意事项" class="headerlink" title="手写一个图片库注意事项"></a>手写一个图片库注意事项</h3><ol>
<li>获取资源：异步并发下载图片，最大化利用cpu资源</li>
<li>资源解码：按实际需求异步解码，多线程并发是否能加快解码速度</li>
<li>资源变换：使用资源池，复用变换的资源，避免内存抖动</li>
<li>缓存：磁盘缓存原始图片，或变换的资源。内存缓存刚使用过的资源，使用lru策略控制大小</li>
<li>感知生命周期：避免内存泄漏</li>
<li>感知内存吃紧：清理缓存</li>
</ol>
<h3 id="Glide-数据加载流程"><a href="#Glide-数据加载流程" class="headerlink" title="Glide 数据加载流程"></a>Glide 数据加载流程</h3><ul>
<li>RequestBuilder 构建 Request和 Target，将请求委托给RequestManager，RequestManager触发Request.begin(),然后调用Engine.load()加载资源，若有内存缓存则返回，否则启动异步任务加载磁盘缓存，若无则从网络加载</li>
<li>DecodeJob 负责加载数据（可能从磁盘，或网络，onDataFetcherReady），再进行数据解码（onDataFetcherReady），再进行数据变换（Transformation），写ActiveResource，（将变换后的数据回调给Target），将变换后的资源写文件（ResourceEncoder）</li>
</ul>
<h3 id="预加载"><a href="#预加载" class="headerlink" title="预加载"></a>预加载</h3><p>preload，加载到一个PreloadTarget，等资源加载好了，就调用clear，将资源从ActiveResource移除存到Lrucache中</p>
<h3 id="感知内存吃紧"><a href="#感知内存吃紧" class="headerlink" title="感知内存吃紧"></a>感知内存吃紧</h3><p>注册ComponentCallbacks2，实现细粒度内存管理：</p>
<ol>
<li>onLowMemory(){清除内存}</li>
<li>onTrimMemory(){修剪内存}</li>
</ol>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memoryCache<span class="selector-class">.trimMemory</span>(level); <span class="comment">// 内存缓存</span></span><br><span class="line">bitmapPool<span class="selector-class">.trimMemory</span>(level); <span class="comment">// bitmap池</span></span><br><span class="line">arrayPool<span class="selector-class">.trimMemory</span>(level); <span class="comment">// 字节数组池</span></span><br></pre></td></tr></table></figure>

<p>可以设置在onTrimMemory时，取消所有正在进行的请求。</p>
<h3 id="BitmapPool"><a href="#BitmapPool" class="headerlink" title="BitmapPool"></a>BitmapPool</h3><ul>
<li>BitmatPool 是 Glide 维护了一个图片复用池，LruBitmapPool 使用 Lru 算法保留最近使用的尺寸的 Bitmap。</li>
<li>api19 后使用bitmap的字节数和config作为key，而之前使用宽高和congif，所以19以后复用度更高</li>
<li>用类似LinkedHashMap存储，键值对中的值是一组Bitmap，相同字节数的Bitmap 存在一个List中（这样设计的目的是，将Lru策略运用在Bitmap大小上，而不是单个Bitmap上），控制BitmapPool大小通过删除数据组中最后一个Bitmap。</li>
<li>BitmapPool 大部分用于Bitmap变换和gif加载时</li>
</ul>
<h3 id="ArrayPool"><a href="#ArrayPool" class="headerlink" title="ArrayPool"></a>ArrayPool</h3><ul>
<li>是一个采用Lru策略的数组池，用于解码时候的字节数组的复用。</li>
<li>清理内存意味着清理MemoryCache，BitmapPool,ArrayPool</li>
</ul>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>默认情况下，Glide 会在开始一个新的图片请求之前检查以下多级的缓存：</p>
<ul>
<li>活动资源 (Active Resources) - 现在是否有另一个 View 正在展示这张图片？</li>
<li>内存缓存 (Memory cache) - 该图片是否最近被加载过并仍存在于内存中？</li>
<li>资源类型（Resource） - 该图片是否之前曾被解码、转换并写入过磁盘缓存？</li>
<li><del>数据来源 (Data) - 构建这个图片的资源是否之前曾被写入过文件缓存？</del></li>
</ul>
<p>在 Glide v4 里，所有缓存键都包含至少两个元素 活动资源，内存缓存，资源磁盘缓存的缓存键还包含一些其他数据，包括： 必选：Model 可选：签名 宽度和高度 可选的变换（Transformation） 额外添加的任何 选项(Options) 请求的数据类型 (Bitmap, GIF, 或其他)</p>
<h3 id="磁盘缓存策略"><a href="#磁盘缓存策略" class="headerlink" title="磁盘缓存策略"></a>磁盘缓存策略</h3><ul>
<li>如果缓存策略是AUTOMATIC（默认），对于网络图片只缓存原始数据，加载本地资源是存储变换过的数据，如果加载不同尺寸的图片，则会获取原始缓存并在此基础上做变换。</li>
<li>如果缓存策略是ALL，会缓存原始图片以及每个尺寸的副本，</li>
<li>如果缓存策略是SOURCE,只会缓存变换过的资源，如果另一个界面换一个尺寸显示图片，则会重新拉取网络 可通过自定义Key实现操控缓存命中策略（混入自己的值，比如修改时间）</li>
</ul>
<h3 id="内存缓存"><a href="#内存缓存" class="headerlink" title="内存缓存"></a>内存缓存</h3><ul>
<li>内存缓存分为两级<ol>
<li>活跃图片 ActiveResource<ul>
<li>使用HashMap存储正在使用资源的弱引用</li>
<li>资源被包装成带引用计数的EngineResource，标记引用资源的次数（当引用数不为0时阻止被回收或降级，降级即是存储到LruCache中）</li>
<li>这一级缓存没有大小限制，所以使用了资源的弱引用</li>
<li>存：每当下载资源后会在onEngineJobComplete()中存入ActiveResource，或者LruCache命中后，将资源从中LruCache移除并存入ActiveResource。</li>
<li>取：每当资源释放时，会降级到LruCache中（请求对应的context onDestroy了或者被gc了）</li>
<li>开一个后台线程，监听ReferenceQueue，不停地从中获取被gc的资源，将其从ActiveResource中移除，并重新构建一个新资源将其降级为LruCache</li>
<li>ActiveResource是为了缓解LruCache中缓存造成压力，因为LruCache中没有命中的缓存只有等到容量超限时才会被清除，强引用即使内存吃紧也不会被gc，现在当LruCache命中后移到ActiveResource，弱引用持有，当内存吃紧时能被回收。</li>
</ul>
</li>
<li>LruCache<ul>
<li>使用 LinkedHashMap 存储从活跃图片降级的资源，使用Lru算法淘汰最近最少使用的</li>
<li>存：从活跃图片降级的资源（退出当前界面，或者ActiveResource资源被回收）</li>
<li>取：网络请求资源之前，从缓存中取，若命中则直接从LruCache中移除了。</li>
</ul>
</li>
</ol>
</li>
<li>内存缓存只会缓存经过转换后的图片</li>
<li>内存缓存键根据10多个参数生成，url，宽高</li>
</ul>
<h3 id="磁盘缓存"><a href="#磁盘缓存" class="headerlink" title="磁盘缓存"></a>磁盘缓存</h3><ul>
<li>会将源数据或经过变换的数据存储在磁盘，在内存中用LinkedHashMap记录一组Entry，Entry内部包含一组文件，文件名即是key，并且有开启后台线程执行删除文件操作以控制磁盘缓存大小。</li>
<li>写磁盘缓存即是触发Writer将数据写入磁盘，并在内存构建对应的File缓存在LinkedHashMap中</li>
<li>根据缓存策略的不同，可能存储源数据和经过变换的数据。</li>
</ul>
<h3 id="感知生命周期"><a href="#感知生命周期" class="headerlink" title="感知生命周期"></a>感知生命周期</h3><ul>
<li>构造RequestManager时传入context，可以是app的，activity的，或者是view的</li>
<li>向界面添加无界面Fragment（SupportRequestManagerFragment），Fragment把生命周期传递给Lifecycle，Fragment持有RequestManager，RequestManager监听Lifecycle，RequestManager向RequestTracker传递生命周期以暂停加载，RequestTracker遍历所有正在进行的请求，并暂停他们（移除回调resourceReady回调）</li>
<li>当绑定context destroy时，RequestManager会将该事件传递给RequestTracker，然后触发该请求Resource的clear，再调用Engine.release，将resource降级到LruCache</li>
<li>通过HashMap结构保存无界面Fragment以避免重复创建</li>
</ul>
<h3 id="取消请求"><a href="#取消请求" class="headerlink" title="取消请求"></a>取消请求</h3><p>通过移除回调，设置取消标志位实现：无法取消已经发出的请求，会在DecodeJob的异步任务的run()方法中判断，如果cancel，则返回。移除各种回调，会传递到DataFetcher，httpUrlConnection 读取数据后会判断是否cancel，如果是则返回null。并没有断开链接</p>
<h3 id="感知网络变化"><a href="#感知网络变化" class="headerlink" title="感知网络变化"></a>感知网络变化</h3><ul>
<li>通过 ConnectivityManager 监听网络变化，当网络恢复时，遍历请求列表，将没有完成的任务继续开始</li>
</ul>
<h3 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h3><ul>
<li>所有的BitmapTransformation 都是从BitmapPool 拿到一个bitmap，然后将在原有bitmap基础上应用一个matrix再画到新bitmap上。</li>
<li>变换也是一个key，用以在缓存的时候做区别</li>
</ul>
<h3 id="RecycleView图片错乱"><a href="#RecycleView图片错乱" class="headerlink" title="RecycleView图片错乱"></a>RecycleView图片错乱</h3><ul>
<li>异步任务+视图复用导致</li>
<li>解决方案：设置占位图+回收表项时取消图片加载（或者新得加载开始时取消旧的加载）+imageview加tag判断是否是自己的图片如果不是则先调用clear</li>
</ul>
<h3 id="Glide-缓存失效"><a href="#Glide-缓存失效" class="headerlink" title="Glide 缓存失效"></a>Glide 缓存失效</h3><ul>
<li>是因为 Key 发生变化，Url是生成key的依据，Url可能发生变化比如把token追加在后面</li>
<li>自定义生成key的方式，继承GlideUrl重写getCacheKey()</li>
</ul>
<h3 id="自定义加载"><a href="#自定义加载" class="headerlink" title="自定义加载"></a>自定义加载</h3><ul>
<li>定义一个Model类用于包装需要加载的数据</li>
<li>定义一个Key的实现类，用于实现第一步的Model中的数据的签名用于区分缓存</li>
<li>定义一个DataFetcher的实现类，用于告诉Glide音频封面如何加载，并把加载结果回调出去</li>
<li>定义一个ModelLoader的实现类用于包装DataFetcher</li>
<li>定义一个ModelLoaderFactory的实现类用于生成ModelLoader实例</li>
<li>将自定义加载配置到AppGlideModule中</li>
</ul>
<h3 id="Glide线程池"><a href="#Glide线程池" class="headerlink" title="Glide线程池"></a>Glide线程池</h3><ol>
<li>磁盘缓存线程池，一个核心线程：用于io图片编码</li>
<li>加载资源线程池，最多不超过4个核心线程数，用于处理网络请求，图片解码转码</li>
<li>动画线程池，最多不超过2个线程</li>
<li>磁盘缓存清理线程池</li>
<li>ActiveResource 开启一个后台线程监听ReferenceQueue 所有线程池都默认采用优先级队列</li>
</ol>
<h3 id="加载Gif流程"><a href="#加载Gif流程" class="headerlink" title="加载Gif流程"></a>加载Gif流程</h3><p>读取流的前三个字节，若判断是gif，则会命中gif解码器-将资源解码成GifDrawable，它持有GifFrameLoader会将资源解码成一张张Bitmap并且传递给DelayTarget的对象，该对象每次资源加载完毕都会通过handler发送延迟消息回调 onFrameReady() 以触发GifDrawable.invalidataSelf()重绘。加载下一帧时会重新构建DelayTarget</p>
<h3 id="请求优先级"><a href="#请求优先级" class="headerlink" title="请求优先级"></a>请求优先级</h3><p>通过给加载线程池配置优先级队列，加载任务DecodeJob 实现了 compareTo 方法，将priority相减</p>
<h3 id="图片加载优化"><a href="#图片加载优化" class="headerlink" title="图片加载优化"></a>图片加载优化</h3><ol>
<li>服务器存多种尺寸的图片</li>
<li>自定义 AppGlideModule，按设备性能好坏设定MemoryCategory.HIGH,LOW,NORMAL，内存缓存和bitmapPool的大小系数，以及图片解码格式，ARGB_8888，RGB_565</li>
<li>RecyclerView 在onViewRecycled 中调用clear ，因为recyclerView会默认会缓存5个同类表项，如果类型很多，内存中会持有表项，如果这些表项都包含图片，Glide 的ActiveResource会膨胀。导致gc</li>
<li>如果 RecyclerView 包含一个很长的itemView，超过一屏，其中包含很多照片，最好把长itemView拆成多个itemView</li>
<li>使用thumbnail，加载一个缩略图，最好是一个独立的链接，如果是本地的也不差</li>
<li>使用preload，将资源提前加载到内存中。</li>
<li>大部分情况下 RESOURCE ，即缓存经过变换的图片上是最好选择，节约内存和磁盘。对于gif资源只缓存原始资源DATA，因为gif是多张图每次编码解码反而耗时</li>
<li>使用Glide实现变换，因为有BitmapPool供复用</li>
</ol>
<p>核心代码</p>
<p>load可加载多种model的图片</p>
<p><img src="Glide//image-20240815203503827.png" alt="image-20240815203503827"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RequestBuilder.java</span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(<span class="meta">@Nullable</span> Object model)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> loadGeneric(model);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(<span class="meta">@Nullable</span> Object model)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.model = model;</span><br><span class="line">  isModelSet = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SingleRequest.java</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">  <span class="comment">//加载图片的View在viewTreeObserver的onPreDrawListener回调回来后拿到确定的View宽高</span></span><br><span class="line">   loadStatus =</span><br><span class="line">          engine.load(</span><br><span class="line">              glideContext,</span><br><span class="line">              model,</span><br><span class="line">              requestOptions.getSignature(),</span><br><span class="line">              <span class="keyword">this</span>.width,</span><br><span class="line">              <span class="keyword">this</span>.height,</span><br><span class="line">              requestOptions.getResourceClass(),</span><br><span class="line">              transcodeClass,</span><br><span class="line">              priority,</span><br><span class="line">              requestOptions.getDiskCacheStrategy(),</span><br><span class="line">              requestOptions.getTransformations(),</span><br><span class="line">              requestOptions.isTransformationRequired(),</span><br><span class="line">              requestOptions.isScaleOnlyOrNoTransform(),</span><br><span class="line">              requestOptions.getOptions(),</span><br><span class="line">              requestOptions.isMemoryCacheable(),</span><br><span class="line">              requestOptions.getUseUnlimitedSourceGeneratorsPool(),</span><br><span class="line">              requestOptions.getUseAnimationPool(),</span><br><span class="line">              requestOptions.getOnlyRetrieveFromCache(),</span><br><span class="line">              <span class="keyword">this</span>,</span><br><span class="line">              callbackExecutor);</span><br><span class="line"> 	<span class="comment">//...     </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">Engine.java</span><br><span class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">    Key signature,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;?&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    DiskCacheStrategy diskCacheStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isTransformationRequired,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isScaleOnlyOrNoTransform,</span></span></span><br><span class="line"><span class="function"><span class="params">    Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isMemoryCacheable,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> useUnlimitedSourceExecutorPool,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> useAnimationPool,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> onlyRetrieveFromCache,</span></span></span><br><span class="line"><span class="function"><span class="params">    ResourceCallback cb,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">	<span class="comment">//内存缓存Key的生成：由model（所加载的数据的模型：Uri/String/Bitmap等）、singature（请求SingleRequest的签名、ImageView的宽高、请求变换(Transformations）、resourceClass（资源解码类型，asBitmap是Bitmap.class，asGif是GifDrawable.class，没有指定是Drawable.class），transcodeClass（链式中调用.transcode()传入，一般为Drawable.class，是最后ImageView实际），options（一组存储如压缩质量、压缩格式、网络超时时间等选项的类）</span></span><br><span class="line">  <span class="comment">//这八者任意一个改变都会引起key的hashcode变化</span></span><br><span class="line">  EngineKey key =</span><br><span class="line">        keyFactory.buildKey(</span><br><span class="line">            model,</span><br><span class="line">            signature,</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            transformations,</span><br><span class="line">            resourceClass,</span><br><span class="line">            transcodeClass,</span><br><span class="line">            options);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    EngineResource&lt;?&gt; memoryResource;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="comment">//是否存在内存缓存（包括 activiteResource 和 cache）</span></span><br><span class="line">      memoryResource = loadFromMemory(key, isMemoryCacheable, startTime);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//没有内存缓存，就进行网络或者磁盘缓存解析</span></span><br><span class="line">      <span class="keyword">if</span> (memoryResource == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> waitForExistingOrStartNewJob(</span><br><span class="line">            glideContext,</span><br><span class="line">            model,</span><br><span class="line">            signature,</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            resourceClass,</span><br><span class="line">            transcodeClass,</span><br><span class="line">            priority,</span><br><span class="line">            diskCacheStrategy,</span><br><span class="line">            transformations,</span><br><span class="line">            isTransformationRequired,</span><br><span class="line">            isScaleOnlyOrNoTransform,</span><br><span class="line">            options,</span><br><span class="line">            isMemoryCacheable,</span><br><span class="line">            useUnlimitedSourceExecutorPool,</span><br><span class="line">            useAnimationPool,</span><br><span class="line">            onlyRetrieveFromCache,</span><br><span class="line">            cb,</span><br><span class="line">            callbackExecutor,</span><br><span class="line">            key,</span><br><span class="line">            startTime);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只有命中内存缓存才从这里返回</span></span><br><span class="line">    cb.onResourceReady(memoryResource, DataSource.MEMORY_CACHE);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">Engine.java &#123;</span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">private</span> EngineResource&lt;?&gt; loadFromMemory(</span><br><span class="line">      EngineKey key, <span class="keyword">boolean</span> isMemoryCacheable, <span class="keyword">long</span> startTime) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isMemoryCacheable) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该缓存key存在于activiteResource，是弱引用存在于内存中的</span></span><br><span class="line">    EngineResource&lt;?&gt; active = loadFromActiveResources(key);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">&quot;Loaded resource from active resources&quot;</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> active;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该缓存存在于cache</span></span><br><span class="line">    EngineResource&lt;?&gt; cached = loadFromCache(key);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">&quot;Loaded resource from cache&quot;</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> cached;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果该缓存key存在于activiteResource,对应的对象引用加1</span></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">private</span> EngineResource&lt;?&gt; loadFromActiveResources(Key key) &#123;</span><br><span class="line">    EngineResource&lt;?&gt; active = activeResources.get(key);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">      active.acquire();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> active;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果该缓存存在于cache，将其中cache中移除并存到activiteResource中并引用计数加1</span></span><br><span class="line">  <span class="keyword">private</span> EngineResource&lt;?&gt; loadFromCache(Key key) &#123;</span><br><span class="line">    EngineResource&lt;?&gt; cached = getEngineResourceFromCache(key);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cached.acquire();</span><br><span class="line">      activeResources.activate(key, cached);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cached;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"> 	<span class="keyword">private</span> EngineResource&lt;?&gt; getEngineResourceFromCache(Key key) &#123;</span><br><span class="line">    Resource&lt;?&gt; cached = cache.remove(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> EngineResource&lt;?&gt; result;</span><br><span class="line">    <span class="keyword">if</span> (cached == <span class="keyword">null</span>) &#123;</span><br><span class="line">      result = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cached <span class="keyword">instanceof</span> EngineResource) &#123;</span><br><span class="line">      <span class="comment">//一般情况都是从缓存cache中直接返回</span></span><br><span class="line">      <span class="comment">// Save an object allocation if we&#x27;ve cached an EngineResource (the typical case).</span></span><br><span class="line">      result = (EngineResource&lt;?&gt;) cached;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//兜底</span></span><br><span class="line">      result =</span><br><span class="line">          <span class="keyword">new</span> EngineResource&lt;&gt;(</span><br><span class="line">              cached, <span class="comment">/*isMemoryCacheable=*/</span> <span class="keyword">true</span>, <span class="comment">/*isRecyclable=*/</span> <span class="keyword">true</span>, key, <span class="comment">/*listener=*/</span> <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











<blockquote>
<h3 id="resourceClass-图片以什么类型解码图片资源"><a href="#resourceClass-图片以什么类型解码图片资源" class="headerlink" title="resourceClass //图片以什么类型解码图片资源"></a>resourceClass //图片以什么类型解码图片资源</h3><p>resourceClass 是指图像加载过程中，Glide 从源（如网络或本地存储）加载并解码后的资源类型。它表示 Glide 获取图像数据后将其解码成什么类型的资源。</p>
<p>常见的 resourceClass 类型包括：</p>
<ul>
<li>Bitmap：用于静态图像，如 JPEG、PNG。</li>
<li>GifDrawable：用于 GIF 动图。</li>
<li>Drawable：一个通用类型，可以表示 BitmapDrawable、GifDrawable 等。</li>
</ul>
<p>指定 resourceClass 可以确保 Glide 以指定的方式解码和处理图像资源。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line">Copy</span><br><span class="line">Glide.with(context)</span><br><span class="line">    .asBitmap()  &#x2F;&#x2F; 指定资源类型为 Bitmap</span><br><span class="line">    .load(&quot;https:&#x2F;&#x2F;example.com&#x2F;image.jpg&quot;)</span><br><span class="line">    .into(imageView);</span><br></pre></td></tr></table></figure>

<h3 id="transcodeClass-最终提供给-Target（如-ImageView）的数据类型"><a href="#transcodeClass-最终提供给-Target（如-ImageView）的数据类型" class="headerlink" title="transcodeClass // 最终提供给 Target（如 ImageView）的数据类型"></a>transcodeClass // 最终提供给 Target（如 ImageView）的数据类型</h3><p>transcodeClass 是指从 resourceClass 类型转换后的最终数据类型，它表示图像加载和解码后，最终提供给 Target（如 ImageView）的数据类型。</p>
<p>常见的 transcodeClass 类型包括：</p>
<ul>
<li>Drawable：Glide 默认使用 Drawable 作为最终显示的类型，因为它可以表示不同类型的图像资源。</li>
<li>Bitmap：如果你需要直接处理 Bitmap 对象，可以指定 transcodeClass 为 Bitmap。</li>
<li>自定义类型：你可以定义自己的转换器，将资源转换为自定义类型。</li>
</ul>
<p>通过自定义转换器（ResourceTranscoder），你可以将 resourceClass 类型转换为所需的 transcodeClass 类型。例如，如果你想将 GIF 转换为静态图像或者其他类型，可以使用自定义转换器。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><strong>resourceClass</strong>：表示 Glide 从源加载并解码后的资源类型（如 Bitmap、GifDrawable）。</li>
<li><strong>transcodeClass</strong>：表示从 resourceClass 类型转换后的最终数据类型，可以是 Drawable、Bitmap 或其他自定义类型。</li>
</ul>
</blockquote>
</div><div class="article-licensing box"><div class="licensing-title"><p>Glide</p><p><a href="http://example.com/2021/09/30/Glide/">http://example.com/2021/09/30/Glide/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>white crow</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-09-30</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-09-10</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/10/15/RecyclerView/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">recyclerView</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/07/30/ActivityStart/"><span class="level-item">ActivityStart</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><ul class="menu-list"><li><a class="level is-mobile" href="#三级缓存："><span class="level-left"><span class="level-item">1.1</span><span class="level-item">三级缓存：</span></span></a></li></ul><li><a class="level is-mobile" href="#Glide缓存"><span class="level-left"><span class="level-item">2</span><span class="level-item">Glide缓存</span></span></a></li><li><a class="level is-mobile" href="#Glide-QA"><span class="level-left"><span class="level-item">3</span><span class="level-item">Glide QA</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#glide是怎么拿到的width-height（view未测绘前拿不到宽高）"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">glide是怎么拿到的width,height（view未测绘前拿不到宽高）</span></span></a></li><li><a class="level is-mobile" href="#Glide的缓存大小默认是多少"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">Glide的缓存大小默认是多少</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Glide"><span class="level-left"><span class="level-item">4</span><span class="level-item">Glide</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#特点"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">特点</span></span></a></li><li><a class="level is-mobile" href="#手写一个图片库注意事项"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">手写一个图片库注意事项</span></span></a></li><li><a class="level is-mobile" href="#Glide-数据加载流程"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">Glide 数据加载流程</span></span></a></li><li><a class="level is-mobile" href="#预加载"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">预加载</span></span></a></li><li><a class="level is-mobile" href="#感知内存吃紧"><span class="level-left"><span class="level-item">4.5</span><span class="level-item">感知内存吃紧</span></span></a></li><li><a class="level is-mobile" href="#BitmapPool"><span class="level-left"><span class="level-item">4.6</span><span class="level-item">BitmapPool</span></span></a></li><li><a class="level is-mobile" href="#ArrayPool"><span class="level-left"><span class="level-item">4.7</span><span class="level-item">ArrayPool</span></span></a></li><li><a class="level is-mobile" href="#缓存"><span class="level-left"><span class="level-item">4.8</span><span class="level-item">缓存</span></span></a></li><li><a class="level is-mobile" href="#磁盘缓存策略"><span class="level-left"><span class="level-item">4.9</span><span class="level-item">磁盘缓存策略</span></span></a></li><li><a class="level is-mobile" href="#内存缓存"><span class="level-left"><span class="level-item">4.10</span><span class="level-item">内存缓存</span></span></a></li><li><a class="level is-mobile" href="#磁盘缓存"><span class="level-left"><span class="level-item">4.11</span><span class="level-item">磁盘缓存</span></span></a></li><li><a class="level is-mobile" href="#感知生命周期"><span class="level-left"><span class="level-item">4.12</span><span class="level-item">感知生命周期</span></span></a></li><li><a class="level is-mobile" href="#取消请求"><span class="level-left"><span class="level-item">4.13</span><span class="level-item">取消请求</span></span></a></li><li><a class="level is-mobile" href="#感知网络变化"><span class="level-left"><span class="level-item">4.14</span><span class="level-item">感知网络变化</span></span></a></li><li><a class="level is-mobile" href="#Transformation"><span class="level-left"><span class="level-item">4.15</span><span class="level-item">Transformation</span></span></a></li><li><a class="level is-mobile" href="#RecycleView图片错乱"><span class="level-left"><span class="level-item">4.16</span><span class="level-item">RecycleView图片错乱</span></span></a></li><li><a class="level is-mobile" href="#Glide-缓存失效"><span class="level-left"><span class="level-item">4.17</span><span class="level-item">Glide 缓存失效</span></span></a></li><li><a class="level is-mobile" href="#自定义加载"><span class="level-left"><span class="level-item">4.18</span><span class="level-item">自定义加载</span></span></a></li><li><a class="level is-mobile" href="#Glide线程池"><span class="level-left"><span class="level-item">4.19</span><span class="level-item">Glide线程池</span></span></a></li><li><a class="level is-mobile" href="#加载Gif流程"><span class="level-left"><span class="level-item">4.20</span><span class="level-item">加载Gif流程</span></span></a></li><li><a class="level is-mobile" href="#请求优先级"><span class="level-left"><span class="level-item">4.21</span><span class="level-item">请求优先级</span></span></a></li><li><a class="level is-mobile" href="#图片加载优化"><span class="level-left"><span class="level-item">4.22</span><span class="level-item">图片加载优化</span></span></a></li><li><a class="level is-mobile" href="#resourceClass-图片以什么类型解码图片资源"><span class="level-left"><span class="level-item">4.23</span><span class="level-item">resourceClass //图片以什么类型解码图片资源</span></span></a></li><li><a class="level is-mobile" href="#transcodeClass-最终提供给-Target（如-ImageView）的数据类型"><span class="level-left"><span class="level-item">4.24</span><span class="level-item">transcodeClass // 最终提供给 Target（如 ImageView）的数据类型</span></span></a></li><li><a class="level is-mobile" href="#总结"><span class="level-left"><span class="level-item">4.25</span><span class="level-item">总结</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatarPng.png" alt="White Crow"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">White Crow</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">78</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">4</p></a></div></div></nav></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a><p class="is-size-7"><span>&copy; 2024 white crow</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://github.com/WhileCrow"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>