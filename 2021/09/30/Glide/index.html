<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Glide - Crow&#039;s Sky</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Crow&#039;s Sky"><meta name="msapplication-TileImage" content="/img/avatarCircle.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Crow&#039;s Sky"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Glide加载图片流程Glide.with(context).load(String).into(xx) 这一行代码干了多少事，其完整的流程： With()Glide.with(context) 生成感知生命周期的requestManager； 1231 with(context)  	调用getRetriever(activity).get(activity);  	通过获取RequestMan"><meta property="og:type" content="blog"><meta property="og:title" content="Glide"><meta property="og:url" content="http://example.com/2021/09/30/Glide/"><meta property="og:site_name" content="Crow&#039;s Sky"><meta property="og:description" content="Glide加载图片流程Glide.with(context).load(String).into(xx) 这一行代码干了多少事，其完整的流程： With()Glide.with(context) 生成感知生命周期的requestManager； 1231 with(context)  	调用getRetriever(activity).get(activity);  	通过获取RequestMan"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://example.com/2021/09/30/Glide/Glide//image-20241017165028811.png"><meta property="og:image" content="http://example.com/2021/09/30/Glide/FE66410C-8835-49F6-B432-0E8356D01A95.png"><meta property="og:image" content="http://example.com/2021/09/30/Glide/20241009145727.jpg"><meta property="og:image" content="http://example.com/2021/09/30/Glide/Glide//image-20241009174652194.png"><meta property="og:image" content="http://example.com/2021/09/30/Glide/Glide//image-20240815114741925.png"><meta property="og:image" content="http://example.com/2021/09/30/Glide/Glide//image-20240709154704558.png"><meta property="og:image" content="http://example.com/2021/09/30/Glide/Glide//image-20240815203503827.png"><meta property="article:published_time" content="2021-09-30T06:00:40.000Z"><meta property="article:modified_time" content="2024-10-18T08:46:18.487Z"><meta property="article:author" content="White Crow"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="Glide//image-20241017165028811.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/09/30/Glide/"},"headline":"Glide","image":["http://example.com/2021/09/30/Glide/Glide//image-20241017165028811.png","http://example.com/2021/09/30/Glide/FE66410C-8835-49F6-B432-0E8356D01A95.png","http://example.com/2021/09/30/Glide/20241009145727.jpg","http://example.com/2021/09/30/Glide/Glide//image-20241009174652194.png","http://example.com/2021/09/30/Glide/Glide//image-20240815114741925.png","http://example.com/2021/09/30/Glide/Glide//image-20240709154704558.png","http://example.com/2021/09/30/Glide/Glide//image-20240815203503827.png"],"datePublished":"2021-09-30T06:00:40.000Z","dateModified":"2024-10-18T08:46:18.487Z","author":{"@type":"Person","name":"white crow"},"publisher":{"@type":"Organization","name":"Crow's Sky","logo":{"@type":"ImageObject","url":"http://example.com/img/avatarCircle.png"}},"description":"Glide加载图片流程Glide.with(context).load(String).into(xx) 这一行代码干了多少事，其完整的流程： With()Glide.with(context) 生成感知生命周期的requestManager； 1231 with(context)  \t调用getRetriever(activity).get(activity);  \t通过获取RequestMan"}</script><link rel="canonical" href="http://example.com/2021/09/30/Glide/"><link rel="icon" href="/img/avatarCircle.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/WhileCrow"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-10-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-09-30T06:00:40.000Z" title="9/30/2021, 2:00:40 PM">2021-09-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-18T08:46:18.487Z" title="10/18/2024, 4:46:18 PM">2024-10-18</time></span><span class="level-item"><a class="link-muted" href="/categories/Android/">Android</a></span><span class="level-item">an hour read (About 7398 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Glide</h1><div class="content"><h1 id="Glide加载图片流程"><a href="#Glide加载图片流程" class="headerlink" title="Glide加载图片流程"></a>Glide加载图片流程</h1><p><strong>Glide.with(context).load(String).into(xx)</strong></p>
<p>这一行代码干了多少事，其完整的流程：</p>
<h2 id="With"><a href="#With" class="headerlink" title="With()"></a>With()</h2><p>Glide.with(context) 生成感知生命周期的requestManager；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> with(context) </span><br><span class="line"> 	调用getRetriever(activity).get(activity); </span><br><span class="line"> 	通过获取RequestManagerRetriever，拿到其fragmentManager（如果context是fragment的话拿其宿主Activity的fragmentManager），向其中塞一个隐性fragment，用于监听生命周期的变化，并在暂停、停止、销毁时执行对应的行为</span><br></pre></td></tr></table></figure>





<h2 id="Load"><a href="#Load" class="headerlink" title="Load()"></a>Load()</h2><p>RequestManager.load()确定解码类型并构建requestBuilder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span> load(string)多个重载，以String为例(没有手动调用asXXX()的情况下)</span><br><span class="line">	<span class="number">2.1</span> 调用asDrawable().load(string)，先asDrawable设定resourceClass类型为Drawable.class，再调用</span><br><span class="line">	load(String) &#123;    </span><br><span class="line">		<span class="keyword">this</span>.model = model;</span><br><span class="line">	    isModelSet = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    设定load模型 (model)</span><br></pre></td></tr></table></figure>



<h2 id="Into"><a href="#Into" class="headerlink" title="Into()"></a>Into()</h2><p><img src="Glide//image-20241017165028811.png" alt="image-20241017165028811"></p>
<p>RequestBuilder.into()确定transformations、构建ViewTarget、主线程Handler的Executor后，构建SingleRequest对象，将request对象保存到ViewTarget中，之后调用requestManager.track(target, request)中执行request.begin()开始正式加载流程。</p>
<h3 id="Into-ImageView"><a href="#Into-ImageView" class="headerlink" title="Into(ImageView)"></a>Into(ImageView)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span> into(ImageView) 多个重载，以ImageView为例</span><br><span class="line">	<span class="number">3.0</span><span class="number">.1</span> clone一份当前的requestOption，根据scaleType(默认为FIT_CENTER)通过requestOptions.clone().optionalFitCenter()保存一些transformations和Options</span><br><span class="line"></span><br><span class="line">	<span class="number">3.0</span><span class="number">.2</span> </span><br><span class="line">		into(</span><br><span class="line">        glideContext.buildImageViewTarget(view, transcodeClass),  <span class="comment">// transcodeClass为Drawable.class(默认)，构建一个DrawableImageViewTarget对象(extends ImageViewTarget extends ViewTarget)，ViewTarget会持有ImageView</span></span><br><span class="line">        <span class="comment">/*targetListener=*/</span> <span class="keyword">null</span>,</span><br><span class="line">        requestOptions, 										  <span class="comment">// 3.0.1中clone出来的requestOptions对象，其中保存了一些transformation配置</span></span><br><span class="line">        Executors.mainThreadExecutor());  <span class="comment">// 主线程Handler的Executor，传递给engine使用，在job完成时callback回主线程</span></span><br><span class="line"></span><br><span class="line">	<span class="number">3.1</span> buildRequest(target, targetListener, options, callbackExecutor); <span class="comment">//根据3.0.2构建的Target、requestOptions、targetListener为null、主线程回调的Executor，构建SingleRequest对象</span></span><br><span class="line"></span><br><span class="line">	<span class="number">3.2</span> target.setRequest(request);  							  <span class="comment">// target.setTag() 调用View.Tag，将3.1构建的request存到View中</span></span><br><span class="line"></span><br><span class="line">	<span class="number">3.3</span> requestManager.track(target, request);					<span class="comment">// 主要是调用requestTracker.runRequest(request) -&gt; request.begin();开始加载流程</span></span><br><span class="line"></span><br><span class="line">	<span class="number">3.4</span> request.begin() </span><br><span class="line">		<span class="number">3.4</span><span class="number">.0</span> 如果model为空，直接set error（优先）或者Placeholder返回</span><br><span class="line">		<span class="number">3.4</span><span class="number">.1</span> 如果这时候能拿到target(ImageView)的宽高就走onSizeReady()开始engine.load()</span><br><span class="line">		<span class="number">3.4</span><span class="number">.2</span> 如果这时候宽高还未测量完成，则走target.getSize(<span class="keyword">this</span>)注册一个ViewTreeObserver，在addOnPreDrawListener回调回来后再掉onSizeReady()</span><br><span class="line">		<span class="number">3.4</span><span class="number">.3</span> 置状态为RUNNING,status = Status.RUNNING; </span><br><span class="line">		<span class="number">3.4</span><span class="number">.4</span> engine.load()启动 尝试读取缓存、下载、解码等步骤，见<span class="number">4</span>详解</span><br><span class="line">	<span class="number">3.5</span> target.onLoadStarted(getPlaceholderDrawable()); 加载占位图</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Engine-load"><a href="#Engine-load" class="headerlink" title="Engine.load()"></a>Engine.load()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span> engine.load()</span><br><span class="line"></span><br><span class="line">	<span class="number">4.1</span> 先读内存缓存</span><br><span class="line">	内存缓存：先读 activeResource，再读memoryCache</span><br><span class="line"></span><br><span class="line">	<span class="number">4.2</span> 内存缓存都没有,就走Engine job启动decode job的流程：engineJob.start(decodeJob);</span><br><span class="line">		<span class="number">4.2</span><span class="number">.1</span> engineJob和decodeJob都是通过池化技术（实现Poolable接口）获取，减少创建带来的内存和时间消耗</span><br><span class="line"></span><br><span class="line">	<span class="number">4.3</span> engineJob.start会在磁盘线程池diskCacheExecutor中执行decodeJob的run()方法（允许磁盘缓存情况下RESOURCE_CACHE/DATA_CACHE)</span><br><span class="line">		<span class="number">4.3</span><span class="number">.1</span> run()-&gt;runWrapped()中通过runGenerators()执行状态机</span><br><span class="line">			将根据缓存策略依次执行</span><br><span class="line">			ResourceCacheGenerator  (缓存策略为ALL、AUTOMATIC、RESOURCE，即该策略下decodeCachedResource()返回为<span class="keyword">true</span>)</span><br><span class="line">			-&gt; DataCacheGenerator   (缓存策略为ALL、AUTOMATIC、DATA，即该策略下decodeCachedData()返回为<span class="keyword">true</span>)</span><br><span class="line">			 -&gt; SourceGenerator （若当前禁止磁盘缓存或磁盘缓存不存在）</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runGenerators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			    currentThread = Thread.currentThread();</span><br><span class="line">			    startFetchTime = LogTime.getLogTime();</span><br><span class="line">			    <span class="keyword">boolean</span> isStarted = <span class="keyword">false</span>;</span><br><span class="line">			    <span class="keyword">while</span> (!isCancelled</span><br><span class="line">			        &amp;&amp; currentGenerator != <span class="keyword">null</span></span><br><span class="line">			        &amp;&amp; !(isStarted = currentGenerator.startNext())) &#123;</span><br><span class="line">			      stage = getNextStage(stage);</span><br><span class="line">			      currentGenerator = getNextGenerator();</span><br><span class="line">	</span><br><span class="line">			      <span class="keyword">if</span> (stage == Stage.SOURCE) &#123;</span><br><span class="line">			        reschedule();</span><br><span class="line">			        <span class="keyword">return</span>;</span><br><span class="line">			      &#125;</span><br><span class="line">			    &#125;</span><br><span class="line">			    <span class="comment">// We&#x27;ve run out of stages and generators, give up.</span></span><br><span class="line">			    <span class="keyword">if</span> ((stage == Stage.FINISHED || isCancelled) &amp;&amp; !isStarted) &#123;</span><br><span class="line">			      notifyFailed();</span><br><span class="line">			    &#125;</span><br><span class="line">	</span><br><span class="line">			    <span class="comment">// Otherwise a generator started a new load and we expect to be called back in</span></span><br><span class="line">			    <span class="comment">// onDataFetcherReady.</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="function"><span class="keyword">private</span> Stage <span class="title">getNextStage</span><span class="params">(Stage current)</span> </span>&#123;</span><br><span class="line">			    <span class="keyword">switch</span> (current) &#123;</span><br><span class="line">			      <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">			        <span class="keyword">return</span> diskCacheStrategy.decodeCachedResource()</span><br><span class="line">			            ? Stage.RESOURCE_CACHE</span><br><span class="line">			            : getNextStage(Stage.RESOURCE_CACHE);</span><br><span class="line">			      <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">			        <span class="keyword">return</span> diskCacheStrategy.decodeCachedData()</span><br><span class="line">			            ? Stage.DATA_CACHE</span><br><span class="line">			            : getNextStage(Stage.DATA_CACHE);</span><br><span class="line">			      <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">			        <span class="comment">// Skip loading from source if the user opted to only retrieve the resource from cache.</span></span><br><span class="line">			        <span class="keyword">return</span> onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE;</span><br><span class="line">			      <span class="keyword">case</span> SOURCE:</span><br><span class="line">			      <span class="keyword">case</span> FINISHED:</span><br><span class="line">			        <span class="keyword">return</span> Stage.FINISHED;</span><br><span class="line">			      <span class="keyword">default</span>:</span><br><span class="line">			        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unrecognized stage: &quot;</span> + current);</span><br><span class="line">			    &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		    <span class="function"><span class="keyword">private</span> DataFetcherGenerator <span class="title">getNextGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			    <span class="keyword">switch</span> (stage) &#123;</span><br><span class="line">			      <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">			        <span class="keyword">return</span> <span class="keyword">new</span> ResourceCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">			      <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">			        <span class="keyword">return</span> <span class="keyword">new</span> DataCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">			      <span class="keyword">case</span> SOURCE:</span><br><span class="line">			        <span class="keyword">return</span> <span class="keyword">new</span> SourceGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">			      <span class="keyword">case</span> FINISHED:</span><br><span class="line">			        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			      <span class="keyword">default</span>:</span><br><span class="line">			        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unrecognized stage: &quot;</span> + stage);</span><br><span class="line">			    &#125;</span><br><span class="line">			 &#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">		<span class="number">4.3</span><span class="number">.2</span> DataFetcherGenerator的执行流程</span><br><span class="line">			FE66410C-<span class="number">8835</span>-49F6-B432-0E8356D01A95.png（见下）</span><br><span class="line">			</span><br><span class="line">			没有缓存的情况举例：</span><br><span class="line">			<span class="number">4.3</span><span class="number">.2</span><span class="number">.1</span> 通过状态机初始状态下，第一次进到DataCacheGenerator，由于不存在缓存，decodeJob会被重新加到sourceExecutor中执行，来到SourceGenerator.</span><br><span class="line">	</span><br><span class="line">			<span class="number">4.3</span><span class="number">.2</span><span class="number">.2</span> SourceGenerator.startNext()中遍历当前注册表已注册的loader，glideContext.getRegistry().getModelLoaders，依次尝试寻找对应的ModelLoader:</span><br><span class="line">					匹配到的是GlideUrl.class对应的 OkHttpUrlLoader -&gt; OkHttpStreamFetcher，调用okhttp3</span><br><span class="line">					(默认其实是 HttpGlideUrlLoader -&gt; HttpUrlFetcher，调用HttpURLConnection的API)</span><br><span class="line">	</span><br><span class="line">	    <span class="number">4.3</span><span class="number">.2</span><span class="number">.2</span><span class="number">.1</span> 请求接口返回回来之后，赋值变量 dataToCache 同时调用cb(DecodeJob).reschedule();</span><br><span class="line">	</span><br><span class="line">	    <span class="number">4.3</span><span class="number">.2</span><span class="number">.2</span><span class="number">.2</span> 赋值runReason为SWITCH_TO_SOURCE_SERVICE 同时调用callback(EngineJob).reschedule(<span class="keyword">this</span>)<span class="comment">//decodeJob，将解析任务decodejob加入getActiveSourceExecutor中执行。</span></span><br><span class="line">	</span><br><span class="line">			<span class="number">4.3</span><span class="number">.2</span><span class="number">.3</span> 之后就又走到了SourceGenerator.startNext()，</span><br><span class="line">					区别是这次runWrapped()中runReason是SWITCH_TO_SOURCE_SERVICE同时SourceGenerator的dataToCache不为空。</span><br><span class="line">					于是又走SourceGenerator.startNext()中cacheData(data);的逻辑，将接口返回源数据后写入磁盘缓存</span><br><span class="line">	      </span><br><span class="line">	  <span class="number">4.3</span><span class="number">.2</span><span class="number">.4</span> 之后主动执行DataCacheGenerator.startNext()进行源数据磁盘缓存操作，此时通过匹配到的					ByteBufferFileLoader.loadData进行文件随机读取操作从磁盘文件中读取出数据。</span><br><span class="line">	      </span><br><span class="line">	  <span class="number">4.3</span><span class="number">.2</span><span class="number">.5</span> 读取到源数据之后通过DecodeJob.onDataFetcherReady将源数据回到到DecodeJob中执行Decode</span><br><span class="line">	     解码操作</span><br><span class="line">			<span class="number">4.3</span><span class="number">.2</span><span class="number">.6</span> 解码后又通过EngineJob的回调，执行activeResouce缓存写入和任务资源之类的回收操作</span><br><span class="line">	  <span class="number">4.3</span><span class="number">.2</span><span class="number">.7</span> 同时通过SingleRequest的回调，调用Target的setResource即最后调用ImageView.setImageDrawable</span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/30/Glide/FE66410C-8835-49F6-B432-0E8356D01A95.png" alt="FE66410C-8835-49F6-B432-0E8356D01A95"></p>
<h3 id="Generator具体执行流程"><a href="#Generator具体执行流程" class="headerlink" title="Generator具体执行流程"></a>Generator具体执行流程</h3><blockquote>
<p>在DecodeJob的getNextGenerator被执行到时，Generator会被初始化，初始化时，Generator会通过调用decodeHelper.getCacheKeys -&gt; decodeHelper.getLoadData -&gt; glideContext.getRegistry().getModelLoaders(model);<br>对 MultiModelLoaderFactory 中对 Register 注册表中已注册的所有entries的遍历，寻找与model类型匹配的Entry(包含modelClass、dataClass、具体loader的factory类)。<br>//注：此处的Register中可以是自己注册 model -&gt; factory 的映射，也可能是Glide默认注册的那些。默认的model为String，启用okhttp的情况下映射到的是 OkHttpUrlLoader 的factory类。最后走OkHttpStreamFetcher请求网络<br>//注： String类型的model 在 StringLoader 中会先被解析成Uri，然后包装成 GlideUrl 类然后重新寻找对应的loader，也就是OkHttpUrlLoader<br>//注： 注册表 Register中，注册时 Key 为model的类型，value为 ModelLoaderFactory，ModelLoaderFactory build -&gt; ModelLoader buildLoadData -&gt; LoadData</p>
</blockquote>
<p>以磁盘缓存模式为DATA_CACHE为例：<br>generator的执行顺序是 ResourceCacheGenerator（若有） -&gt; DataCacheGenerator（若有） -&gt; SourceGenerator（若不存在磁盘缓存）</p>
<p>第一次 decodejob 执行是在 diskCacheExecutor 线程池中<br>此时，首次进入runWrapped -&gt; case INITIALIZE -&gt; runGenerators() 时，执行的是 DataCacheGenerator.startNext()，由于此时磁盘缓存还不存在（所以也没法helper.getModelLoaders(cacheFile)），startNext返回false，走到下一个stage和generator，也就是 stageStage.SOURCE 并currentGenerator为SourceGenerator，当 stage == stageStage.SOURCE ，走到decodeJob的 reschedule(RunReason.SWITCH_TO_SOURCE_SERVICE)，此时decodejob会被加入到 sourceExecutor 线程池中重新执行。</p>
<p>第二次 decodejob 执行是在 sourceExecutor 线程池中<br>此时，重新进入runWrapped -&gt; case SWITCH_TO_SOURCE_SERVICE -&gt; runGenerators() 时，执行的是 SourceGenerator.startNext()，遍历当前符合的所有 ModelLoader.LoadData（其实就是一个，fetcher为OkHttpStreamFetcher的LoadData对象），最后执行loadData.fetcher.loadData() 走到 OkHttpStreamFetcher.loadData() 调用okhttp下载数据，并监听 onDataReady() 和 onLoadFaild() 回调<br>onDataReady()下载完成后，数据赋值给 SourceGenerator.dataToCache ，之后又 reschedule(RunReason.SWITCH_TO_SOURCE_SERVICE) 到sourceExecutor线程池中重新执行。</p>
<p>第三次 decodejob 执行依然是在 sourceExecutor 线程池中<br>此时，依然是runWrapped -&gt; case SWITCH_TO_SOURCE_SERVICE -&gt; runGenerators() ，SourceGenerator.startNext()，由于此时dataToCache不为空，走 SourceGenerator.startNext() 中存储磁盘缓存数据的逻辑，即调用 SourceGenerator.cacheData() 将源数据通过decodeHelper.getDiskCache.put(key = new DataCacheKey(loadData.sourceKey, helper.getSignature(), value = new DataCacheWriter&lt;&gt;(encoder, data, helper.getOptions()))写入磁盘缓存。同时构建一个 DataCacheGenerator执行其 startNext()。<br>DataCacheGenerator.startNext()中，此时由于已经写过磁盘缓存了，cacheFile不为空，于是走到helper.getModelLoaders(cacheFile)得到缓存文件的读取modelLoaders（此时有四个ByteBufferFileLoader，FileLoader$StreamFactory、 FileLoader$FileDescriptorFactory、UnitModelLoader）<br>根据当前的resourceClass和transcodeClass，以及loadData的dataClass(ByteBuffer)确定为由ByteBufferFileLoader处理，执行ByteBufferFileLoader.loadData。之后借助ByteBufferUtil类随机读取的方式，从磁盘文件中读取出源数据的ByteBuffer，之后数据回调到 DecodeJob.onDataFetcherReady()，然后执行 decodeFromRetrievedData()解析源数据 （注，此时还在sourceExecutor线程池中）。<br>通过 <img src="/2021/09/30/Glide/20241009145727.jpg" alt="20241009145727"> 这一串调用之后，走到遍历 decodePaths 尝试解析的步骤，此时一般有（AnimatedImageDecoder, ByteBufferGifDecoder, BitmapDrawableDecoder以及自定义的比如AvifBufferBitmapDecoder），任何一个decoder解码成功后即结束这段逻辑(decode时会执行Downsampler类的逻辑进行采样缩放并且解码)，</p>
<p><img src="Glide//image-20241009174652194.png" alt="image-20241009174652194"></p>
<p>重新走到 DecodeJob: decodeFromRetrievedData() -&gt; notifyEncodeAndRelease() -&gt; notifyComplete() -&gt;</p>
<ol>
<li><p>EngineJob: onResourceReady() -&gt; notifyCallbacksOfResult() -&gt; onEngineJobComplete()<br> 此处执行活动缓存的写入逻辑，activeResources.activate(key, resource); 之后就是资源回收任务结束移除之类的收尾工作。</p>
</li>
<li><p>CallResourceReady.run() -&gt;  engineResource.acquire();callCallbackOnResourceReady(cb); -&gt; SingleRequest.onResourceReady() -&gt; ImageViewTarget.onResourceReady() -&gt; ImageViewTarget.setResourceInternal() -&gt; DrawableImageViewTarget.setResource() -&gt; view.setImageDrawable();<br> 此处是将解码后的图片资源直接通过view.setImageDrawable显示出来。</p>
</li>
</ol>
<h3 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h3><ul>
<li>Glide是先下载到磁盘，然后再从磁盘中读取。</li>
</ul>
<h1 id="Glide缓存"><a href="#Glide缓存" class="headerlink" title="Glide缓存"></a>Glide缓存</h1><h2 id="三级缓存："><a href="#三级缓存：" class="headerlink" title="三级缓存："></a>三级缓存：</h2><p><strong>磁盘(DiskLruCache) -&gt; LRUCache(不活跃资源) -&gt; ActiveResources(使用中资源WeakReference)</strong></p>
<p><strong>内存缓存分为 ActiveResources弱引用 的和 LruCache ，其中正在使用的图片使用弱引用缓存，暂时不使用的图片用 LruCache缓存，这一点是通过 图片引用计数器（acquired变量）来实现的</strong></p>
<h3 id="活动缓存"><a href="#活动缓存" class="headerlink" title="活动缓存"></a>活动缓存</h3><p><strong>活动缓存(activeResources: Map&lt;Key, ResourceWeakReference&gt;)</strong></p>
<p><strong>key为EngineKey<u>对象</u>，value为<u>弱引用</u>的图片缓存ResourceWeakReference实例</strong></p>
<p>正在使用的图片缓存（被ImageView或Activity引用的），在<strong>ImageView移除或Activity销毁时被移到内存缓存</strong></p>
<p>（为什么这一层缓存要用弱引用缓存的方式：一个是这一层缓存因为没有限制缓存大小，用弱引用万一遇到gc即可降级；一个是）</p>
<ul>
<li>资源被包装成带引用计数的EngineResource，标记引用资源的次数（当引用数<strong>acquired</strong>不为0时阻止被回收或降级，降级即是存储到LruCache中）</li>
<li>这一级缓存<strong>没有大小限制</strong>，所以使用了资源的弱引用</li>
<li>存：每当<strong>下载资源后会在onEngineJobComplete()中存入ActiveResource</strong>，或者<strong>LruCache命中后，将资源从中LruCache移除并存入ActiveResource。</strong></li>
<li>取：<strong>每当资源释放时，会降级到LruCache中（请求对应的context onDestroy了或者被gc了）</strong></li>
<li>开一个<strong>后台线程</strong>，监听ReferenceQueue，不停地从中获取<strong>被gc的缓存</strong>，将其从ActiveResource中移除，并重新构建一个新资源将其<strong>降级为LruCache</strong>（这一步并不会影响页面展示，图片内存没有销毁，只是被降级到有大小限制的LruCache中）</li>
<li>ActiveResource是为了缓解LruCache中缓存造成压力，因为LruCache中没有命中的缓存只有等到容量超限时才会被清除，强引用即使内存吃紧也不会被gc，现在当LruCache命中后移到ActiveResource，弱引用持有，当内存吃紧时能被回收。</li>
</ul>
<h5 id="活动缓存是感知生命周期的"><a href="#活动缓存是感知生命周期的" class="headerlink" title="活动缓存是感知生命周期的"></a>活动缓存是感知生命周期的</h5><p>​    当绑定的context<strong>销毁onDestory时</strong>，RequestManager会将该事件传递给RequestTracker，然后触发该请求Resource的clear，再调用Engine.release，将改activiteResource降级到LruCache</p>
<h3 id="内存缓存LRUCache"><a href="#内存缓存LRUCache" class="headerlink" title="内存缓存LRUCache"></a>内存缓存LRUCache</h3><p><strong>内存缓存LRUCache(memoryCache: LruCache&lt;Key, Resource&lt;?&gt;&gt;)</strong></p>
<p><strong>key为EngineKey<u>对象</u>，value为图片缓存Resource实例</strong></p>
<p>当图片不再显示时，图片会从活动缓存移到内存缓存。存储的是暂时不用的图片缓存（依靠<strong>图片引用计数器acquired</strong>变量实现，当acquired大于0时存在于活动缓存中，为0是移到内存缓存中）</p>
<ul>
<li><p>使用 <strong>LinkedHashMap实现</strong>， 存储从活跃图片降级的资源，使用Lru算法淘汰最近最少使用的</p>
<p><code>Map&lt;T, Y&gt; cache = new LinkedHashMap&lt;&gt;(100, 0.75f, true);</code></p>
</li>
<li><p>存：从活跃图片<strong>降级的资源</strong>（退出当前界面，或者ActiveResource资源被回收）</p>
</li>
<li><p>取：网络请求资源之前，从缓存中取，如没命中活动资源则取活动资源，没命中活动资源则取内存缓存LRUCache，若命中则直接从LruCache中移除了，没命中则走磁盘或网络。</p>
</li>
<li><p><strong>内存缓存最大空间(maxSize) = 每个进程可用的最大内存（activityManager.getMemoryClass()  *  0.4</strong></p>
<p><strong>(低配手机的话是: 每个进程可用的最大内存 * 0.33)</strong></p>
<blockquote>
<p>activityManager.getMemoryClass值：</p>
<ul>
<li>低端设备可能在 16-32 MB 范围内。</li>
<li>中档设备通常在 64-128 MB 范围内。</li>
<li>高端设备和新款设备可能在 256 MB 或更高。//当设置largeHeap时，最多可申请512M</li>
</ul>
</blockquote>
</li>
</ul>
<h3 id="磁盘缓存（已证）"><a href="#磁盘缓存（已证）" class="headerlink" title="磁盘缓存（已证）"></a>磁盘缓存（已证）</h3><p><strong>磁盘缓存（diskLruCache: LinkedHashMap&lt;String, Entry&gt;）</strong></p>
<p><strong>key为使用EngineKey所有参数经过哈希算法加密后的<u>字符串</u>，value为File实例</strong></p>
<p>磁盘缓存大小默认250MB，根据缓存策略的不同可能存储原始图片或解码后的图片。</p>
<p><strong>磁盘缓存的存储顺序记录在journal文件中，有时该文件过大会导致glide初始过慢。</strong></p>
<blockquote>
<p>DiskCacheStrategy.ALL ：     //表示既缓存原始图片，也缓存decode过后的图片。</p>
<p>DiskCacheStrategy.NONE：     //表示不缓存任何内容。</p>
<p><strong>DiskCacheStrategy.RESOURCE： //表示只缓存decode过后的图片，依然编码为jpeg/png等格式存储</strong></p>
<p><strong>DiskCacheStrategy.DATA：     //表示只缓存原图片(decode前)。 如webp/avif</strong></p>
<p><strong>DiskCacheStrategy.AUTOMATIC  //Remote资源下走DiskCacheStrategy.DATA，Local资源下走DiskCacheStrategy.RESOURCE（默认选项）。</strong></p>
</blockquote>
<ul>
<li>根据<strong>缓存策略的不同</strong>，可能存储原数据和经过解码的数据。</li>
<li>在内存中用<strong>LinkedHashMap实现的LruCache</strong>记录一组Entry，Entry内部包含一组文件，文件名即是key，并且有开启<strong>后台线程执行删除文件操作以控制磁盘缓存大小</strong>。</li>
<li>写磁盘缓存即是触发Writer将数据写入磁盘，并在内存构建对应的File缓存在LinkedHashMap中</li>
<li>磁盘缓存的存储顺序记录在journal文件中，有时该文件过大会导致glide初始过慢。</li>
</ul>
<h4 id="磁盘-RESOURCE"><a href="#磁盘-RESOURCE" class="headerlink" title="磁盘-RESOURCE"></a>磁盘-RESOURCE</h4><p><strong>实际是内存中解码后的Bitmap对象，编码成磁盘需要的文件格式，jpeg/png，之后再存磁盘</strong></p>
<p><strong>解码后的资源的磁盘缓存</strong>（<strong>经过转换，解压之后的体积较大，解码速度较快的，由bitmap直接编码成的JPEG/PNG等未压缩格式</strong>）</p>
<p>此时存储的文件是文件头为<code>ffd8 ffe0 0010 4a46 4946 0001 0100 0001</code>的jpeg格式。</p>
<p>Resource 代表了解码后的资源，即已经从原始数据（如网络图片的字节流）解码并转换为可直接使用的数据形式，之后还是需要编码成文件格式jpeg/png等decode格式。Resource 封装了解码后的资源，并提供了一些管理功能，如引用计数和资源回收。</p>
<h4 id="磁盘-DATA"><a href="#磁盘-DATA" class="headerlink" title="磁盘-DATA"></a>磁盘-DATA</h4><p><strong>原资源的直接数据缓存（未解码，转换，磁盘体积较小，解码速度较慢）</strong>(<strong>AVIF/WEBP等压缩格式</strong>)</p>
<p>此时存储的文件是文件头为<code>0000 0020 6674 7970 6176 6966 0000 0000</code>的avif格式。</p>
<p>DataCache 是指数据缓存，主要用于缓存原始数据（例如，通过网络请求获取的图片字节流）。数据缓存可以加速后续的解码过程，因为原始数据已经被缓存下来，不需要再次从网络或其他源获取。</p>
<h4 id="磁盘-AUTOMATIC"><a href="#磁盘-AUTOMATIC" class="headerlink" title="磁盘-AUTOMATIC"></a>磁盘-AUTOMATIC</h4><p><strong>Remote资源下走DiskCacheStrategy.DATA，Local资源下走DiskCacheStrategy.RESOURCE</strong>。</p>
<h4 id="Tips-1"><a href="#Tips-1" class="headerlink" title="Tips"></a>Tips</h4><ul>
<li><p><strong>对于远程的资源，DATA和AUTOMATIC是一样的。</strong></p>
</li>
<li><p><strong>想缩短解码时间可以考虑使用RESOURCE模式，本质上是用磁盘空间 换 解码时间：decode后的资源存储空间更大，但解码时间更短。</strong></p>
</li>
<li><p><strong>对于webp，avif等模式，RESOURCE缓存的是.jpeg格式，其内容是decode后内存中使用的bitmap对象直接，不带压缩的二进制内容。DATA缓存的则是原始的图片格式</strong></p>
</li>
<li><p>**那么对于.jpg文件，RESOURCE跟DATA模式的区别是啥：jpg本身也是有压缩的，RESOURCE模式下存储的文件格式仍为jpg，但是其内容是decode后的，尺寸更大而解码时间更短 **</p>
</li>
<li><p><strong>那么对于.gif文件，不管什么模式都一样，就是缓存gif图原始文件</strong></p>
</li>
<li><p>互联网早期图片现在看到很多事绿色且模糊，其实就是由于jpeg的压缩是有损的，每次存到磁盘中可能经过一次压缩，并且上传时会再压缩一次，重复多次后就会质量下降</p>
</li>
</ul>
<h2 id="Glide缓存Key"><a href="#Glide缓存Key" class="headerlink" title="Glide缓存Key"></a>Glide缓存Key</h2><p><strong>Glide生成key（两级内存缓存Key类型为同一个EngineKey对象，磁盘缓存Key类型为EngineKey的哈希字符串）的方式涉及的参数有8种，其中包括图片URL、宽、高。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EngineKey key = keyFactory.buildKey(model, signature, width, height, transformations,</span><br><span class="line">        resourceClass, transcodeClass, options);</span><br></pre></td></tr></table></figure>



<p>宽高一定是明确有值的。即使wrap_content也会用屏幕最长的一边作为兜底宽高。</p>
<h2 id="Glide的缓存大小默认是多少"><a href="#Glide的缓存大小默认是多少" class="headerlink" title="Glide的缓存大小默认是多少"></a>Glide的缓存大小默认是多少</h2><h3 id="内存缓存大小"><a href="#内存缓存大小" class="headerlink" title="内存缓存大小"></a>内存缓存大小</h3><p><strong>内存缓存最大空间(maxSize) = 每个进程可用的最大内存（activityManager.getMemoryClass()  *  0.4</strong></p>
<p><strong>(低配手机的话是: 每个进程可用的最大内存 * 0.33)</strong></p>
<blockquote>
<p>activityManager.getMemoryClass值：</p>
<ul>
<li>低端设备可能在 16-32 MB 范围内。</li>
<li>中档设备通常在 64-128 MB 范围内。</li>
<li>高端设备和新款设备可能在 256 MB 或更高。//当设置largeHeap时，最多可申请512M</li>
</ul>
</blockquote>
<h3 id="磁盘缓存大小"><a href="#磁盘缓存大小" class="headerlink" title="磁盘缓存大小"></a>磁盘缓存大小</h3><p><strong>磁盘缓存大小: 默认250MB</strong></p>
<blockquote>
<p><strong>磁盘缓存目录: 项目/cache/image_manager_disk_cache</strong></p>
</blockquote>
<p><img src="Glide//image-20240815114741925.png" alt="image-20240815114741925"></p>
<p>这里有个点：随着图片磁盘缓存的存取，由于每次存取磁盘图片glide都会将存取操作记录到日志文件(journal文件)，日志文件会逐渐增大到可能几兆大小，导致glide初始化延迟（glide的初始化中，磁盘缓存初始化时会涉及到将日志文件读取到内存中操作）。</p>
<p>这里可以增加一个首页模块的磁盘缓存目录，比如<code>项目/cache/image_manager_disk_home_cache</code>，启动时先初始化首页的磁盘缓存(现为10m)再初始化主体的磁盘缓存，避免日志文件过大导致的初始化时间太长阻塞App启动。</p>
<h1 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h1><h2 id="感知生命周期"><a href="#感知生命周期" class="headerlink" title="感知生命周期"></a>感知生命周期</h2><p><strong>通过链式调用中with(xxx)传入的activity或Fragment，Glide实现了对所属activity或者fragment生命周期监听：通过new一个隐形的fragment(SupportRequestManagerFragment.class)，嵌入到所要监听的fragment或者activity所在的Activity中，这样当宿主Acitivity的生命周期变化时，可以通过嵌入的fragment监听回调，并在RequestManager中执行：</strong></p>
<p>**onStart():  继续请求resumeRequests() **</p>
<p><strong>onStop():  暂停请求pauseRequests()</strong></p>
<p><strong>onDestory():  销毁请求、对应页面的活动缓存降级到内存缓存LRUCache，移除监听等操作</strong></p>
<p>// ps:当 Activity时，Glide 会清理相关资源，移除 Fragment 不会立即触发 ActiveResources 缓存降级，只有宿主 Activity 销毁时才会。</p>
<p>//com/bumptech/glide/request/target/CustomViewTarget.java 中保留了一个没打开的接口clearOnDetach()，可以实现当ImageView detachedFromWindow的时候释放图片缓存。但由于考虑到太激进的释放可能导致缓存复用效率</p>
<h2 id="glide是怎么拿到的width-height（view未测绘前拿不到宽高）"><a href="#glide是怎么拿到的width-height（view未测绘前拿不到宽高）" class="headerlink" title="glide是怎么拿到的width,height（view未测绘前拿不到宽高）"></a><strong>glide是怎么拿到的width,height（view未测绘前拿不到宽高）</strong></h2><p><strong>如果view的布局宽高有值，或view本身的宽高有值，会直接返回布局宽高或view宽高。如果没有：</strong></p>
<p><strong>ViewTarget会为所持有的View注册view树绘制回调，待到经过测量布局之后回调onSizeReady()了，才会发起engine.load。(如果wrap_content则会用getMaxDisplayLength()屏幕长的一边作为宽高返回)</strong></p>
<p><code>addOnPreDrawListener(OnPreDrawListener listener)</code></p>
<p><img src="Glide//image-20240709154704558.png" alt="image-20240709154704558"></p>
<h3 id="如果是Wrap-content？"><a href="#如果是Wrap-content？" class="headerlink" title="如果是Wrap_content？"></a>如果是Wrap_content？</h3><p><strong>那么会返回 屏幕高（长的一边） * 屏幕高，比如 1080 * 1920 屏幕会返回 1920 * 1920兜底，在后续流程比如内存缓存Key生成时候，也是用的这个兜底宽高。</strong></p>
<p>具体见ViewTarget.getMaxDisplayLength()</p>
<h2 id="感知内存吃紧"><a href="#感知内存吃紧" class="headerlink" title="感知内存吃紧"></a>感知内存吃紧</h2><p>注册ComponentCallbacks2，实现细粒度内存管理：</p>
<ol>
<li>onLowMemory(){清除内存}</li>
<li>onTrimMemory(){修剪内存}</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memoryCache.trimMemory(level); <span class="comment">// 内存缓存</span></span><br><span class="line">bitmapPool.trimMemory(level); <span class="comment">// bitmap池</span></span><br><span class="line">arrayPool.trimMemory(level); <span class="comment">// 字节数组池</span></span><br></pre></td></tr></table></figure>

<p>可以设置在onTrimMemory时，取消所有正在进行的请求。</p>
<h2 id="Glide线程池"><a href="#Glide线程池" class="headerlink" title="Glide线程池"></a>Glide线程池</h2><h3 id="源线程池sourceExecutor"><a href="#源线程池sourceExecutor" class="headerlink" title="源线程池sourceExecutor"></a>源线程池sourceExecutor</h3><p><strong>(执行从decode源数据的decodeJob的线程池，非下载线程池，下载包给okhttp/httpurlconnection了)：</strong></p>
<p><strong>定长为 cpu数量（最大4）（核心线程和工作线程数量都最大为4）的线程池</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> GlideExecutor <span class="title">getActiveSourceExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> useUnlimitedSourceGeneratorPool</span><br><span class="line">       ? sourceUnlimitedExecutor</span><br><span class="line">       : (useAnimationPool ? animationExecutor : sourceExecutor);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//bestThreadCount = Math.min(MAXIMUM_AUTOMATIC_THREAD_COUNT, RuntimeCompat.availableProcessors());</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GlideExecutor <span class="title">newSourceExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> newSourceExecutor(</span><br><span class="line">    calculateBestThreadCount(),</span><br><span class="line">    DEFAULT_SOURCE_EXECUTOR_NAME,</span><br><span class="line">    UncaughtThrowableStrategy.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="磁盘缓存diskCacheExecutor"><a href="#磁盘缓存diskCacheExecutor" class="headerlink" title="磁盘缓存diskCacheExecutor"></a>磁盘缓存diskCacheExecutor</h3><p><strong>（从Resource或DataCache中加载图片）线程池：定长为1（核心线程和工作线程数量都为1）的线程池</strong></p>
<pre><code>    //diskCacheExecutor

    //DEFAULT_DISK_CACHE_EXECUTOR_THREADS = 1

    public static GlideExecutor newDiskCacheExecutor() &#123;
    return newDiskCacheExecutor(
        DEFAULT_DISK_CACHE_EXECUTOR_THREADS,
        DEFAULT_DISK_CACHE_EXECUTOR_NAME,
        UncaughtThrowableStrategy.DEFAULT);
    &#125;
</code></pre>
<h2 id="加载Gif流程"><a href="#加载Gif流程" class="headerlink" title="加载Gif流程"></a>加载Gif流程</h2><p>读取流的前三个字节，若判断是gif，则会命中gif解码器-将资源解码成GifDrawable，它持有GifFrameLoader会将资源解码成一张张Bitmap并且传递给DelayTarget的对象，该对象每次资源加载完毕都会通过handler发送延迟消息回调 onFrameReady() 以触发GifDrawable.invalidataSelf()重绘。加载下一帧时会重新构建DelayTarget</p>
<h2 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h2><h2 id="ActiveResources弱引用问题"><a href="#ActiveResources弱引用问题" class="headerlink" title="ActiveResources弱引用问题"></a>ActiveResources弱引用问题</h2><p>Q: glide 当前页面的图片缓存是存在activiteResource的弱引用的，也就是说当gc时当前页面的图片缓存会被回收？那岂不是当前页面会空白</p>
<p>A: 不会啊，因为实际的资源被页面的view持有着，而ActiveResources只是一层弱引用而已。而已经不被view持有（没显示出来的图片）但仍在活动缓存中的弱引用会被降级到LRU内存缓存中。</p>
<blockquote>
<p>活动资源缓存的存在以较小的代价减小Lru缓存的压力，提升Lru缓存的效率。</p>
<p>原因是活动资源缓存通过缓存的对象本身就是在内存中进行使用，缓存是只是建立一个弱引用关系。如果过没有活动资源缓存，每一次使用的资源都加入内存缓存，极有可能因为放入Lru缓存的数据过多，导致正在使用资源从Lru缓存中移除，等到下次来进行加载的时候因为没有对应的引用关系，找不到原来内存中正在使用的那个资源，从而需要再次从文件或者网络进行数据加载。这样同一份资源需要使用两处或者多处内存。大大的提高了内存消耗。总而言之，活动资源缓存以较小的代价提高了Lru缓存的使用效率，防止加载中的资源被lru回收。</p>
</blockquote>
<h1 id="相关源码"><a href="#相关源码" class="headerlink" title="相关源码"></a>相关源码</h1><h2 id="load可加载多种model的图片"><a href="#load可加载多种model的图片" class="headerlink" title="load可加载多种model的图片"></a>load可加载多种model的图片</h2><p><img src="Glide//image-20240815203503827.png" alt="image-20240815203503827"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RequestBuilder.java</span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(<span class="meta">@Nullable</span> Object model)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> loadGeneric(model);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(<span class="meta">@Nullable</span> Object model)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.model = model;</span><br><span class="line">  isModelSet = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="获得View宽高"><a href="#获得View宽高" class="headerlink" title="获得View宽高"></a>获得View宽高</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SingleRequest.java</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">  <span class="comment">//加载图片的View在viewTreeObserver的onPreDrawListener回调回来后拿到确定的View宽高</span></span><br><span class="line">   loadStatus =</span><br><span class="line">          engine.load(</span><br><span class="line">              glideContext,</span><br><span class="line">              model,</span><br><span class="line">              requestOptions.getSignature(),</span><br><span class="line">              <span class="keyword">this</span>.width,</span><br><span class="line">              <span class="keyword">this</span>.height,</span><br><span class="line">              requestOptions.getResourceClass(),</span><br><span class="line">              transcodeClass,</span><br><span class="line">              priority,</span><br><span class="line">              requestOptions.getDiskCacheStrategy(),</span><br><span class="line">              requestOptions.getTransformations(),</span><br><span class="line">              requestOptions.isTransformationRequired(),</span><br><span class="line">              requestOptions.isScaleOnlyOrNoTransform(),</span><br><span class="line">              requestOptions.getOptions(),</span><br><span class="line">              requestOptions.isMemoryCacheable(),</span><br><span class="line">              requestOptions.getUseUnlimitedSourceGeneratorsPool(),</span><br><span class="line">              requestOptions.getUseAnimationPool(),</span><br><span class="line">              requestOptions.getOnlyRetrieveFromCache(),</span><br><span class="line">              <span class="keyword">this</span>,</span><br><span class="line">              callbackExecutor);</span><br><span class="line"> 	<span class="comment">//...     </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="内存缓存Key的生成"><a href="#内存缓存Key的生成" class="headerlink" title="内存缓存Key的生成"></a>内存缓存Key的生成</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">Engine.java</span><br><span class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">    Key signature,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;?&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    DiskCacheStrategy diskCacheStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isTransformationRequired,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isScaleOnlyOrNoTransform,</span></span></span><br><span class="line"><span class="function"><span class="params">    Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isMemoryCacheable,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> useUnlimitedSourceExecutorPool,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> useAnimationPool,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> onlyRetrieveFromCache,</span></span></span><br><span class="line"><span class="function"><span class="params">    ResourceCallback cb,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">	<span class="comment">//内存缓存Key的生成：由model（所加载的数据的模型：Uri/String/Bitmap等）、singature（请求SingleRequest的签名、ImageView的宽高、请求变换(Transformations）、resourceClass（资源解码类型，asBitmap是Bitmap.class，asGif是GifDrawable.class，没有指定是Drawable.class），transcodeClass（链式中调用.transcode()传入，一般为Drawable.class，是最后ImageView实际），options（一组存储如压缩质量、压缩格式、网络超时时间等选项的类）</span></span><br><span class="line">  <span class="comment">//这八者任意一个改变都会引起key的hashcode变化</span></span><br><span class="line">  EngineKey key =</span><br><span class="line">        keyFactory.buildKey(</span><br><span class="line">            model,</span><br><span class="line">            signature,</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            transformations,</span><br><span class="line">            resourceClass,</span><br><span class="line">            transcodeClass,</span><br><span class="line">            options);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    EngineResource&lt;?&gt; memoryResource;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="comment">//是否存在内存缓存（包括 activiteResource 和 cache）</span></span><br><span class="line">      memoryResource = loadFromMemory(key, isMemoryCacheable, startTime);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//没有内存缓存，就进行网络或者磁盘缓存解析</span></span><br><span class="line">      <span class="keyword">if</span> (memoryResource == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> waitForExistingOrStartNewJob(</span><br><span class="line">            glideContext,</span><br><span class="line">            model,</span><br><span class="line">            signature,</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            resourceClass,</span><br><span class="line">            transcodeClass,</span><br><span class="line">            priority,</span><br><span class="line">            diskCacheStrategy,</span><br><span class="line">            transformations,</span><br><span class="line">            isTransformationRequired,</span><br><span class="line">            isScaleOnlyOrNoTransform,</span><br><span class="line">            options,</span><br><span class="line">            isMemoryCacheable,</span><br><span class="line">            useUnlimitedSourceExecutorPool,</span><br><span class="line">            useAnimationPool,</span><br><span class="line">            onlyRetrieveFromCache,</span><br><span class="line">            cb,</span><br><span class="line">            callbackExecutor,</span><br><span class="line">            key,</span><br><span class="line">            startTime);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只有命中内存缓存才从这里返回</span></span><br><span class="line">    cb.onResourceReady(memoryResource, DataSource.MEMORY_CACHE);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="请求缓存流程"><a href="#请求缓存流程" class="headerlink" title="请求缓存流程"></a>请求缓存流程</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">Engine.java &#123;</span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">private</span> EngineResource&lt;?&gt; loadFromMemory(</span><br><span class="line">      EngineKey key, <span class="keyword">boolean</span> isMemoryCacheable, <span class="keyword">long</span> startTime) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isMemoryCacheable) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该缓存key存在于activiteResource，是弱引用存在于内存中的</span></span><br><span class="line">    EngineResource&lt;?&gt; active = loadFromActiveResources(key);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">&quot;Loaded resource from active resources&quot;</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> active;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该缓存存在于cache</span></span><br><span class="line">    EngineResource&lt;?&gt; cached = loadFromCache(key);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">&quot;Loaded resource from cache&quot;</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> cached;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果该缓存key存在于activiteResource,对应的对象引用加1</span></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">private</span> EngineResource&lt;?&gt; loadFromActiveResources(Key key) &#123;</span><br><span class="line">    EngineResource&lt;?&gt; active = activeResources.get(key);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">      active.acquire();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> active;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果该缓存存在于cache，将其中cache中移除并存到activiteResource中并引用计数加1</span></span><br><span class="line">  <span class="keyword">private</span> EngineResource&lt;?&gt; loadFromCache(Key key) &#123;</span><br><span class="line">    EngineResource&lt;?&gt; cached = getEngineResourceFromCache(key);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cached.acquire();</span><br><span class="line">      activeResources.activate(key, cached);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cached;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"> 	<span class="keyword">private</span> EngineResource&lt;?&gt; getEngineResourceFromCache(Key key) &#123;</span><br><span class="line">    Resource&lt;?&gt; cached = cache.remove(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> EngineResource&lt;?&gt; result;</span><br><span class="line">    <span class="keyword">if</span> (cached == <span class="keyword">null</span>) &#123;</span><br><span class="line">      result = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cached <span class="keyword">instanceof</span> EngineResource) &#123;</span><br><span class="line">      <span class="comment">//一般情况都是从缓存cache中直接返回</span></span><br><span class="line">      <span class="comment">// Save an object allocation if we&#x27;ve cached an EngineResource (the typical case).</span></span><br><span class="line">      result = (EngineResource&lt;?&gt;) cached;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//兜底</span></span><br><span class="line">      result =</span><br><span class="line">          <span class="keyword">new</span> EngineResource&lt;&gt;(</span><br><span class="line">              cached, <span class="comment">/*isMemoryCacheable=*/</span> <span class="keyword">true</span>, <span class="comment">/*isRecyclable=*/</span> <span class="keyword">true</span>, key, <span class="comment">/*listener=*/</span> <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h1 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h1><ol>
<li><h2 id="Resource"><a href="#Resource" class="headerlink" title="Resource"></a>Resource</h2></li>
</ol>
<p>  Resource 代表了解码后的资源，即已经从原始数据（如网络图片的字节流，一般为AVIF、WEBP）解码并转换为可直接使用的数据形式（如 Bitmap、Drawable 等，如果存到磁盘会encode成jpeg/png格式）。Resource 封装了解码后的资源，并提供了一些管理功能，如引用计数和资源回收。</p>
<ol start="2">
<li><h2 id="DataCache"><a href="#DataCache" class="headerlink" title="DataCache"></a>DataCache</h2></li>
</ol>
<p>  DataCache 是指数据缓存，主要用于缓存原始数据（例如，通过网络请求获取的图片字节流）。数据缓存可以加速后续的解码过程，因为原始数据已经被缓存下来，不需要再次从网络或其他源获取。</p>
<ol start="3">
<li><h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2></li>
</ol>
<p>  Source 代表数据的源头，即原始数据的来源。常见的源包括网络（主要）、文件系统、资源文件、内容提供者等。<br>  网络源：从 URL 或网络地址加载数据。<br>  文件源：从本地文件系统加载数据。<br>  资源源：从应用的资源文件中加载数据。<br>  内容提供者：通过内容提供者（ContentProvider）加载数据。</p>
<ul>
<li>URL：主要用于标识网络上的资源。示例：<a href="https://example.com/image.jpg">https://example.com/image.jpg</a></li>
<li>URI：是一个更广泛的概念，可以标识任意一种资源，包括本地文件和网络资源。示例：file:///storage/emulated/0/Download/image.jpg 和 content://media/external/images/media/12345</li>
</ul>
<blockquote>
<h2 id="resourceClass-图片以什么类型解码图片资源"><a href="#resourceClass-图片以什么类型解码图片资源" class="headerlink" title="resourceClass //图片以什么类型解码图片资源"></a>resourceClass //图片以什么类型解码图片资源</h2><p>resourceClass 是指图像加载过程中，Glide 从源（如网络或本地存储）加载并解码后的资源类型。它表示 Glide 获取图像数据后将其解码成什么类型的资源。</p>
<p>常见的 resourceClass 类型包括：</p>
<ul>
<li>Bitmap：用于静态图像，如 JPEG、PNG。</li>
<li>GifDrawable：用于 GIF 动图。</li>
<li>Drawable：一个通用类型，可以表示 BitmapDrawable、GifDrawable 等。</li>
</ul>
<p>指定 resourceClass 可以确保 Glide 以指定的方式解码和处理图像资源。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line">Copy</span><br><span class="line">Glide.with(context)</span><br><span class="line">    .asBitmap()  &#x2F;&#x2F; 指定resourceClass为 Bitmap。不指定时默认asDrawable为drawable</span><br><span class="line">    .load(&quot;https:&#x2F;&#x2F;example.com&#x2F;image.jpg&quot;)</span><br><span class="line">    .into(imageView);</span><br></pre></td></tr></table></figure>

<h2 id="transcodeClass-最终提供给-Target（如-ImageView）的数据类型"><a href="#transcodeClass-最终提供给-Target（如-ImageView）的数据类型" class="headerlink" title="transcodeClass // 最终提供给 Target（如 ImageView）的数据类型"></a>transcodeClass // 最终提供给 Target（如 ImageView）的数据类型</h2><p>transcodeClass 是指从 resourceClass 类型转换后的最终数据类型，它表示图像加载和解码后，最终提供给 Target（如 ImageView）的数据类型。</p>
<p>常见的 transcodeClass 类型包括：</p>
<ul>
<li>Drawable：Glide 默认使用 Drawable 作为最终显示的类型，因为它可以表示不同类型的图像资源。</li>
<li>Bitmap：如果你需要直接处理 Bitmap 对象，可以指定 transcodeClass 为 Bitmap。</li>
<li>自定义类型：你可以定义自己的转换器，将资源转换为自定义类型。</li>
</ul>
<p>通过自定义转换器（ResourceTranscoder），你可以将 resourceClass 类型转换为所需的 transcodeClass 类型。例如，如果你想将 GIF 转换为静态图像或者其他类型，可以使用自定义转换器。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><strong>resourceClass</strong>：表示 Glide 从源加载并解码后的资源类型（如 Bitmap、GifDrawable）。</li>
<li><strong>transcodeClass</strong>：表示从 resourceClass 类型转换后的最终数据类型，可以是 Drawable、Bitmap 或其他自定义类型。</li>
</ul>
</blockquote>
<p>相关参考<a target="_blank" rel="noopener" href="https://juejin.cn/post/7129306281650683935#heading-92">https://juejin.cn/post/7129306281650683935#heading-92</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Glide</p><p><a href="http://example.com/2021/09/30/Glide/">http://example.com/2021/09/30/Glide/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>white crow</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-09-30</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-10-18</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/10/15/RecyclerView/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">recyclerView</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/07/30/ActivityStart/"><span class="level-item">ActivityStart</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Glide加载图片流程"><span class="level-left"><span class="level-item">1</span><span class="level-item">Glide加载图片流程</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#With"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">With()</span></span></a></li><li><a class="level is-mobile" href="#Load"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">Load()</span></span></a></li><li><a class="level is-mobile" href="#Into"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">Into()</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Into-ImageView"><span class="level-left"><span class="level-item">1.3.1</span><span class="level-item">Into(ImageView)</span></span></a></li><li><a class="level is-mobile" href="#Engine-load"><span class="level-left"><span class="level-item">1.3.2</span><span class="level-item">Engine.load()</span></span></a></li><li><a class="level is-mobile" href="#Generator具体执行流程"><span class="level-left"><span class="level-item">1.3.3</span><span class="level-item">Generator具体执行流程</span></span></a></li><li><a class="level is-mobile" href="#Tips"><span class="level-left"><span class="level-item">1.3.4</span><span class="level-item">Tips</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#Glide缓存"><span class="level-left"><span class="level-item">2</span><span class="level-item">Glide缓存</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#三级缓存："><span class="level-left"><span class="level-item">2.1</span><span class="level-item">三级缓存：</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#活动缓存"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">活动缓存</span></span></a><ul class="menu-list"><ul class="menu-list"><li><a class="level is-mobile" href="#活动缓存是感知生命周期的"><span class="level-left"><span class="level-item">2.1.1.1.1</span><span class="level-item">活动缓存是感知生命周期的</span></span></a></li></ul></ul></li><li><a class="level is-mobile" href="#内存缓存LRUCache"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">内存缓存LRUCache</span></span></a></li><li><a class="level is-mobile" href="#磁盘缓存（已证）"><span class="level-left"><span class="level-item">2.1.3</span><span class="level-item">磁盘缓存（已证）</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#磁盘-RESOURCE"><span class="level-left"><span class="level-item">2.1.3.1</span><span class="level-item">磁盘-RESOURCE</span></span></a></li><li><a class="level is-mobile" href="#磁盘-DATA"><span class="level-left"><span class="level-item">2.1.3.2</span><span class="level-item">磁盘-DATA</span></span></a></li><li><a class="level is-mobile" href="#磁盘-AUTOMATIC"><span class="level-left"><span class="level-item">2.1.3.3</span><span class="level-item">磁盘-AUTOMATIC</span></span></a></li><li><a class="level is-mobile" href="#Tips-1"><span class="level-left"><span class="level-item">2.1.3.4</span><span class="level-item">Tips</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#Glide缓存Key"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">Glide缓存Key</span></span></a></li><li><a class="level is-mobile" href="#Glide的缓存大小默认是多少"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">Glide的缓存大小默认是多少</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#内存缓存大小"><span class="level-left"><span class="level-item">2.3.1</span><span class="level-item">内存缓存大小</span></span></a></li><li><a class="level is-mobile" href="#磁盘缓存大小"><span class="level-left"><span class="level-item">2.3.2</span><span class="level-item">磁盘缓存大小</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#Other"><span class="level-left"><span class="level-item">3</span><span class="level-item">Other</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#感知生命周期"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">感知生命周期</span></span></a></li><li><a class="level is-mobile" href="#glide是怎么拿到的width-height（view未测绘前拿不到宽高）"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">glide是怎么拿到的width,height（view未测绘前拿不到宽高）</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#如果是Wrap-content？"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">如果是Wrap_content？</span></span></a></li></ul></li><li><a class="level is-mobile" href="#感知内存吃紧"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">感知内存吃紧</span></span></a></li><li><a class="level is-mobile" href="#Glide线程池"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">Glide线程池</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#源线程池sourceExecutor"><span class="level-left"><span class="level-item">3.4.1</span><span class="level-item">源线程池sourceExecutor</span></span></a></li><li><a class="level is-mobile" href="#磁盘缓存diskCacheExecutor"><span class="level-left"><span class="level-item">3.4.2</span><span class="level-item">磁盘缓存diskCacheExecutor</span></span></a></li></ul></li><li><a class="level is-mobile" href="#加载Gif流程"><span class="level-left"><span class="level-item">3.5</span><span class="level-item">加载Gif流程</span></span></a></li><li><a class="level is-mobile" href="#QA"><span class="level-left"><span class="level-item">3.6</span><span class="level-item">QA</span></span></a></li><li><a class="level is-mobile" href="#ActiveResources弱引用问题"><span class="level-left"><span class="level-item">3.7</span><span class="level-item">ActiveResources弱引用问题</span></span></a></li></ul></li><li><a class="level is-mobile" href="#相关源码"><span class="level-left"><span class="level-item">4</span><span class="level-item">相关源码</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#load可加载多种model的图片"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">load可加载多种model的图片</span></span></a></li><li><a class="level is-mobile" href="#获得View宽高"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">获得View宽高</span></span></a></li><li><a class="level is-mobile" href="#内存缓存Key的生成"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">内存缓存Key的生成</span></span></a></li><li><a class="level is-mobile" href="#请求缓存流程"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">请求缓存流程</span></span></a></li></ul></li><li><a class="level is-mobile" href="#相关概念"><span class="level-left"><span class="level-item">5</span><span class="level-item">相关概念</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Resource"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">Resource</span></span></a></li><li><a class="level is-mobile" href="#DataCache"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">DataCache</span></span></a></li><li><a class="level is-mobile" href="#Source"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">Source</span></span></a></li><li><a class="level is-mobile" href="#resourceClass-图片以什么类型解码图片资源"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">resourceClass //图片以什么类型解码图片资源</span></span></a></li><li><a class="level is-mobile" href="#transcodeClass-最终提供给-Target（如-ImageView）的数据类型"><span class="level-left"><span class="level-item">5.5</span><span class="level-item">transcodeClass // 最终提供给 Target（如 ImageView）的数据类型</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#总结"><span class="level-left"><span class="level-item">5.5.1</span><span class="level-item">总结</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatarPng.png" alt="White Crow"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">White Crow</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">78</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">4</p></a></div></div></nav></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a><p class="is-size-7"><span>&copy; 2024 white crow</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://github.com/WhileCrow"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>