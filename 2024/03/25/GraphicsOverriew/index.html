<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Graphics - Crow&#039;s Sky</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Crow&#039;s Sky"><meta name="msapplication-TileImage" content="/img/avatarCircle.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Crow&#039;s Sky"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="移动端渲染"><meta property="og:type" content="blog"><meta property="og:title" content="Graphics"><meta property="og:url" content="http://example.com/2024/03/25/GraphicsOverriew/"><meta property="og:site_name" content="Crow&#039;s Sky"><meta property="og:description" content="移动端渲染"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://example.com/2024/03/25/GraphicsOverriew/3d5bf360cf944e2ab413b60b93c31515~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp"><meta property="og:image" content="http://example.com/2024/03/25/GraphicsOverriew/ape-fwk-graphics-20210830134540808.png"><meta property="og:image" content="http://example.com/2024/03/25/GraphicsOverriew/graphics-pipeline-20210830134540921.png"><meta property="og:image" content="http://example.com/2024/03/25/GraphicsOverriew/bufferqueue-20210830134540592.png"><meta property="article:published_time" content="2024-03-25T07:35:03.229Z"><meta property="article:modified_time" content="2024-05-14T09:49:26.170Z"><meta property="article:author" content="White Crow"><meta property="article:tag" content="Graphic"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2024/03/25/GraphicsOverriew/3d5bf360cf944e2ab413b60b93c31515~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2024/03/25/GraphicsOverriew/"},"headline":"Graphics","image":["http://example.com/2024/03/25/GraphicsOverriew/ape-fwk-graphics-20210830134540808.png","http://example.com/2024/03/25/GraphicsOverriew/graphics-pipeline-20210830134540921.png","http://example.com/2024/03/25/GraphicsOverriew/bufferqueue-20210830134540592.png"],"datePublished":"2024-03-25T07:35:03.229Z","dateModified":"2024-05-14T09:49:26.170Z","author":{"@type":"Person","name":"white crow"},"publisher":{"@type":"Organization","name":"Crow's Sky","logo":{"@type":"ImageObject","url":"http://example.com/img/avatarCircle.png"}},"description":"移动端渲染"}</script><link rel="canonical" href="http://example.com/2024/03/25/GraphicsOverriew/"><link rel="icon" href="/img/avatarCircle.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/WhileCrow"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-10-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-03-25T07:35:03.229Z" title="3/25/2024, 3:35:03 PM">2024-03-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-05-14T09:49:26.170Z" title="5/14/2024, 5:49:26 PM">2024-05-14</time></span><span class="level-item"><a class="link-muted" href="/categories/Android/">Android</a></span><span class="level-item">13 minutes read (About 1991 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Graphics</h1><div class="content"><h3 id="移动端渲染"><a href="#移动端渲染" class="headerlink" title="移动端渲染"></a><strong>移动端渲染</strong></h3><p><img src="/2024/03/25/GraphicsOverriew/3d5bf360cf944e2ab413b60b93c31515~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="img"></p>
<span id="more"></span>

<p>移动App的整体UI框架大致分成下面4个层次：</p>
<p>1）UI库</p>
<p>跟Android、iOS原生开发类似，Flutter用dart语言实现一整套UI控件。Flutter先将控件树转成渲染树，然后交由skia库绘制界面。</p>
<p>2）图形库</p>
<p>Skia图形库跟iOS平台的CoreAnimation等库功能类似，不仅提供了图形渲染功能，还提供文字绘制和图片显示功能。高级图形图像库将需要绘制的图形转成点、线、三角形等图元，再调用底层图形接口实现绘制。</p>
<p>3）低级图形接口</p>
<p>OpenGL是使用最广的低级图形接口，兼容性最好，基本上支持市面上的所有GPU。Vulkan是最近几年新推出的图形API，除了iPhone的GPU，其他厂家的GPU基本都支持。Metal是苹果新推出的图形API，只支持自家GPU。</p>
<p>4）硬件设备层</p>
<p>目前的移动设备出于性能考虑，大部分图形都是通过GPU渲染，少数情况也会使用CPU渲染，后文会介绍skia使用CPU和GPU渲染的具体场景。</p>
<p>iPhone 在A11芯片以前使用power vr系列GPU，之后采用自研GPU。安卓手机大部分采用高通Adreno GPU或ARM mail GPU。GPU渲染完一帧图像后送FrameBuffer，最后在合适的时机展示在屏幕上。</p>
<p>Skia应用广泛并且跨平台，不仅用于Flutter和Android操作系统，还用于Google Chrome浏览器，同时支持windows、Mac、iOS操作系统。Skia由C++编写，代码开源，通过研究skia有助于理解图形图像的绘制原理，为UI性能优化提供思路。</p>
<h1 id="图形"><a href="#图形" class="headerlink" title="图形"></a>图形</h1><p>Android 框架提供了各种用于 2D 和 3D 图形渲染的 API，可与制造商的图形驱动程序实现代码交互，因此，务必更好地了解这些 API 的工作原理。本页介绍了在其上构建这些驱动程序的 图形硬件抽象层 (HAL)。</p>
<p>应用开发者可通过三种方式将图像绘制到屏幕上：使用<a target="_blank" rel="noopener" href="https://source.android.com/devices/graphics/arch-sh#canvas">canvas</a>、<a target="_blank" rel="noopener" href="https://source.android.com/devices/graphics/arch-egl-opengl">OpenGL ES</a> 或 <a target="_blank" rel="noopener" href="https://source.android.com/devices/graphics/arch-vulkan">Vulkan(UE4支持)</a>。</p>
<h2 id="Android-图形组件"><a href="#Android-图形组件" class="headerlink" title="Android 图形组件"></a>Android 图形组件</h2><p>无论开发者使用什么渲染 API，一切内容都会渲染到 <strong>Surface</strong> 上。Surface 表示缓冲区队列中的生产方，而缓冲区队列通常会被 SurfaceFlinger 消耗。在 Android 平台上创建的每个窗口都由 Surface 提供支持。所有被渲染的可见 Surface 都被 SurfaceFlinger 合成到屏幕。</p>
<p>下图显示了关键组件如何协同工作：</p>
<p><img src="/2024/03/25/GraphicsOverriew/ape-fwk-graphics-20210830134540808.png" alt="图像渲染组件"></p>
<p><strong>图 1.</strong> Surface 如何被渲染</p>
<p>主要组件如下所述：</p>
<h3 id="图像流生产方-IMAGE-STREAM-PRODUCERS"><a href="#图像流生产方-IMAGE-STREAM-PRODUCERS" class="headerlink" title="图像流生产方 IMAGE STREAM PRODUCERS"></a>图像流生产方 IMAGE STREAM PRODUCERS</h3><p>图像流生产方可以是生成图形缓冲区以供消耗的任何内容。例如 OpenGL ES、Canvas 2D 和 mediaserver 视频解码器。</p>
<h3 id="图像流消耗方-IMAGE-STREAM-CONSUMERS"><a href="#图像流消耗方-IMAGE-STREAM-CONSUMERS" class="headerlink" title="图像流消耗方 IMAGE STREAM CONSUMERS"></a>图像流消耗方 IMAGE STREAM CONSUMERS</h3><p>图像流的最常见消耗方是 SurfaceFlinger，该系统服务会消耗当前可见的 Surface，并使用窗口管理器中提供的信息将它们合成到屏幕。SurfaceFlinger 是可以修改所显示部分内容的唯一服务。SurfaceFlinger 使用 OpenGL 和 Hardware Composer 来合成一组 Surface。</p>
<p>其他 OpenGL ES 应用也可以消耗图像流，例如相机应用会消耗相机预览图像流。非 GL 应用也可以是使用方，例如 ImageReader 类。</p>
<h3 id="硬件作曲家-Hardware-Composer-简称HWC"><a href="#硬件作曲家-Hardware-Composer-简称HWC" class="headerlink" title="硬件作曲家 Hardware Composer (简称HWC)"></a>硬件作曲家 Hardware Composer (简称HWC)</h3><p>显示子系统的硬件抽象实现。SurfaceFlinger 可以将某些合成工作委托给Hardware Composer，以分担 OpenGL 和 GPU 上的工作量。SurfaceFlinger 只是充当另一个 OpenGL ES 客户端。因此，在 SurfaceFlinger 将一个或两个缓冲区合成到第三个缓冲区中的过程中，它会使用 OpenGL ES。这会让合成的功耗比通过 GPU 执行所有计算时更低。</p>
<p><a target="_blank" rel="noopener" href="https://source.android.com/devices/graphics/hwc">硬件作曲家 Hardware Composer HAL</a> 则进行另一半的工作，是所有 Android 图形渲染的中心点。Hardware Composer 必须支持事件，其中之一是 VSYNC（另一个是支持即插即用 HDMI 的热插拔）。</p>
<h3 id="Gralloc"><a href="#Gralloc" class="headerlink" title="Gralloc"></a>Gralloc</h3><p>需要使用图形内存分配器 (Gralloc) 来分配图像生产方请求的内存。有关详情，请参阅 <a target="_blank" rel="noopener" href="https://source.android.com/devices/graphics/arch-bq-gralloc">Gralloc HAL</a>。</p>
<h2 id="数据流"><a href="#数据流" class="headerlink" title="数据流"></a>数据流</h2><p>有关 Android 图形管道的描述，请参见下图：</p>
<p><img src="/2024/03/25/GraphicsOverriew/graphics-pipeline-20210830134540921.png" alt="图形数据流"></p>
<p><strong>图 2.</strong> 流经 Android 的图形数据流</p>
<p>左侧的对象是生成图形缓冲区的渲染器，如主屏幕、状态栏和系统界面。SurfaceFlinger 是合成器，而硬件混合渲染器是制作器。</p>
<h3 id="BufferQueue"><a href="#BufferQueue" class="headerlink" title="BufferQueue"></a>BufferQueue</h3><p>BufferQueues 是 Android 图形组件之间的粘合剂。它们是一对队列，可以调解缓冲区从生产方到消耗方的固定周期。一旦生产方移交其缓冲区，SurfaceFlinger 便会负责将所有内容合成到显示部分。</p>
<p>有关 BufferQueue 通信过程，请参见下图。</p>
<p><img src="/2024/03/25/GraphicsOverriew/bufferqueue-20210830134540592.png" alt="BufferQueue 通信过程"></p>
<p><strong>图 3.</strong> BufferQueue 通信过程</p>
<p>BufferQueue 包含将图像流生产方与图像流消耗方结合在一起的逻辑。图像生产方的一些示例包括由相机 HAL 或 OpenGL ES 游戏生成的相机预览。图像消耗方的一些示例包括 SurfaceFlinger 或显示 OpenGL ES 流的另一个应用，如显示相机取景器的相机应用。</p>
<p>BufferQueue 是将缓冲区池与队列相结合的数据结构，它使用 Binder IPC 在进程之间传递缓冲区。生产方接口，或者您传递给想要生成图形缓冲区的某个人的内容，即是 IGraphicBufferProducer（<a target="_blank" rel="noopener" href="http://developer.android.com/reference/android/graphics/SurfaceTexture.html">SurfaceTexture</a> 的一部分）。BufferQueue 通常用于渲染到 Surface，并且与 GL 消耗方及其他任务一起消耗内容。</p>
<p>BufferQueue 可以在三种不同的模式下运行：</p>
<p>类同步模式 - 默认情况下，BufferQueue 在类同步模式下运行，在该模式下，从生产方进入的每个缓冲区都在消耗方那退出。在此模式下不会舍弃任何缓冲区。如果生产方速度太快，创建缓冲区的速度比消耗缓冲区的速度更快，它将阻塞并等待可用的缓冲区。</p>
<p>非阻塞模式 - BufferQueue 还可以在非阻塞模式下运行，在此类情况下，它会生成错误，而不是等待缓冲区。在此模式下也不会舍弃缓冲区。这有助于避免可能不了解图形框架的复杂依赖项的应用软件出现潜在死锁现象。</p>
<p>舍弃模式 - 最后，BufferQueue 可以配置为丢弃旧缓冲区，而不是生成错误或进行等待。例如，如果对纹理视图执行 GL 渲染并尽快绘制，则必须丢弃缓冲区。</p>
<p>为了执行这项工作的大部分环节，SurfaceFlinger 就像另一个 OpenGL ES 客户端一样工作。例如，当 SurfaceFlinger 正在积极地将一个缓冲区或两个缓冲区合成到第三个缓冲区中时，它使用的是 OpenGL ES。</p>
<p>Hardware Composer HAL 执行另一半工作。该 HAL 充当所有 Android 图形渲染的中心点。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Graphics</p><p><a href="http://example.com/2024/03/25/GraphicsOverriew/">http://example.com/2024/03/25/GraphicsOverriew/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>white crow</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2024-03-25</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-05-14</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Graphic/">Graphic</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/04/19/JMM/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">JvmMemoryStructure</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/03/25/CodeOptimization/"><span class="level-item">CodeOptimization</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><ul class="menu-list"><ul class="menu-list"><li><a class="level is-mobile" href="#移动端渲染"><span class="level-left"><span class="level-item">1.1.1</span><span class="level-item">移动端渲染</span></span></a></li></ul></ul><li><a class="level is-mobile" href="#图形"><span class="level-left"><span class="level-item">2</span><span class="level-item">图形</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Android-图形组件"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">Android 图形组件</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#图像流生产方-IMAGE-STREAM-PRODUCERS"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">图像流生产方 IMAGE STREAM PRODUCERS</span></span></a></li><li><a class="level is-mobile" href="#图像流消耗方-IMAGE-STREAM-CONSUMERS"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">图像流消耗方 IMAGE STREAM CONSUMERS</span></span></a></li><li><a class="level is-mobile" href="#硬件作曲家-Hardware-Composer-简称HWC"><span class="level-left"><span class="level-item">2.1.3</span><span class="level-item">硬件作曲家 Hardware Composer (简称HWC)</span></span></a></li><li><a class="level is-mobile" href="#Gralloc"><span class="level-left"><span class="level-item">2.1.4</span><span class="level-item">Gralloc</span></span></a></li></ul></li><li><a class="level is-mobile" href="#数据流"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">数据流</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#BufferQueue"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">BufferQueue</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatarPng.png" alt="White Crow"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">White Crow</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">81</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">4</p></a></div></div></nav></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatarCircle.png" alt="Crow&#039;s Sky" height="28"></a><p class="is-size-7"><span>&copy; 2025 white crow</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://github.com/WhileCrow"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>