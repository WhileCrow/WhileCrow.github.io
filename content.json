{"pages":[{"title":"categories","text":"","link":"/categories/index.html"},{"title":"tags","text":"","link":"/tags/index.html"}],"posts":[{"title":"ANR","text":"æœºåˆ¶æè¿°ï¼š ï¼ˆ//psï¼šAOSPæºç ä¸­Serviceçš„å‰å°Serviceçš„TIMEOUTæ—¶é—´æ˜¯20sï¼Œåå°Serviceçš„TIMEOUTæ—¶é—´æ˜¯200sï¼‰ android-10 // How long we wait for a service to finish executing. â€‹ static final int SERVICE_TIMEOUT = 20*1000; â€‹ // How long we wait for a service to finish executing. â€‹ static final int SERVICE_BACKGROUND_TIMEOUT = SERVICE_TIMEOUT * 10;åŸç†ï¼š Serviceï¼šå‰å°Serviceå¯åŠ¨è¶…è¿‡20sæ²¡æœ‰å¯åŠ¨å®Œæˆï¼šåœ¨Serviceå¯åŠ¨æ—¶å‘é€ä¸€ä¸ªå»¶è¿Ÿ20sçš„æ¶ˆæ¯ï¼ˆè¯¥æ¶ˆæ¯å†…éƒ¨å³ä¸º æŠ¥ANRå¹¶åˆ†æANRæ ˆï¼‰ï¼Œä¹‹ååœ¨Serviceçš„å¯åŠ¨å®Œæˆæ—¶å°†è¿™ä¸ªæ¶ˆæ¯removeæ‰ã€‚å¦‚æœæˆåŠŸremoveé‚£å°±å•¥äº‹æ²¡æœ‰ï¼Œå¦‚æœè¶…è¿‡20sæ²¡æœ‰removeå°±æ¶ˆæ¯è§¦å‘ï¼Œæ‰§è¡Œæ¶ˆæ¯ä½“å†…çš„ANRåŠ¨ä½œã€‚ï¼ˆåå°æ¶ˆæ¯ï¼‰ https://segmentfault.com/a/1190000022967452 https://mp.weixin.qq.com/s/fWoXprt2TFL1tTapt7esYg https://mp.weixin.qq.com/s/ApNSEWxQdM19QoCNijagtg","link":"/2021/11/02/ANR/"},{"title":"Android Build","text":"Apkæ€»æ„å»ºæµç¨‹ç®€è¿°Aapt ä¼šå°†ä¸»å·¥ç¨‹ã€ä¾èµ–åº“ä¸­çš„èµ„æº(resã€assets)å’ŒandroidManifestéƒ½åˆå¹¶ï¼Œäº§å‡ºR.javaã€èµ„æºåŠèµ„æºç´¢å¼•resources.arscï¼› ä¹‹åjavacç¼–è¯‘åŒ…æ‹¬R.javaæ–‡ä»¶ã€ä¸»å·¥ç¨‹çš„javaæ–‡ä»¶ã€aidläº§ç”Ÿçš„javaæ–‡ä»¶ï¼Œäº§å‡ºclassæ–‡ä»¶ï¼›å¦‚æœéœ€è¦æ’æ¡©çš„è¯å°±æ’æ¡© ä¹‹åä½¿ç”¨Proguard/R8æ··æ·†å·¥å…·å¯¹.classæ–‡ä»¶è„±ç³–ã€å‹ç¼©ã€æ··æ·†ç­‰ï¼Œäº§å‡ºæ–°çš„classæ–‡ä»¶ï¼› ä¹‹åä½¿ç”¨Dx/D8ç¼–è¯‘å·¥å…·å°†æ–°çš„classæ–‡ä»¶å†è½¬æ¢æˆdexæ–‡ä»¶ï¼Œ ä¹‹åæ‰“åŒ…æˆapkï¼Œç„¶åç­¾åã€zipalignä¼˜åŒ–ã€‚ å·¥å…·ï¼šaapt/aapt2ã€javacã€Proguard/R8ã€Dx/D8ã€ApkBuilderã€zipalign å…¸å‹çš„APKä¸­å†…å®¹ AndroidManifest.xml ç¨‹åºå…¨å±€é…ç½®æ–‡ä»¶ classes.dex Dalvikå­—èŠ‚ç  resources.arsc èµ„æºç´¢å¼•è¡¨ META-INFè¯¥ç›®å½•ä¸‹å­˜æ”¾çš„æ˜¯ç­¾åä¿¡æ¯ res è¯¥ç›®å½•å­˜æ”¾èµ„æºæ–‡ä»¶ assetsè¯¥ç›®å½•å¯ä»¥å­˜æ”¾ä¸€äº›é…ç½®æˆ–èµ„æºæ–‡ä»¶ æµç¨‹å¤§è‡´æ€»ç»“ä¸ºï¼š 1ã€èµ„æºç¼–è¯‘ï¼šä¸»å·¥ç¨‹å’Œä¸‰æ–¹åº“ä¸­çš„Mainifestã€èµ„æºï¼ˆreså’Œassetsï¼‰çš„åˆå¹¶ï¼Œè€Œåç”±aaptç¼–è¯‘æ„å»ºåäº§ç”ŸR.javaã€resources.arscï¼ˆèµ„æºç´¢å¼•è¡¨ï¼‰ã€‚å¦‚æœæ˜¯AAPT2çš„è¯ä¼šå°†èµ„æºç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶.flat 2ã€**.aidlç¼–è¯‘ç”Ÿæˆ.javaæ–‡ä»¶** 3ã€javaæºç ç¼–è¯‘ï¼šAIDLäº§ç”Ÿçš„.javaæ–‡ä»¶ã€ä¸»å·¥ç¨‹ä¸­çš„javaæ–‡ä»¶ã€ä¸Šè¿°çš„R.javaæ–‡ä»¶ ä¸€èµ·ç»è¿‡javacå·¥å…·ç¼–è¯‘åï¼Œäº§ç”Ÿ.classæ–‡ä»¶ 3åˆ1/2ã€ Tramformæ’æ¡© &amp; ASMä¿®æ”¹å­—èŠ‚ç  4ã€Proguard/æ–°ä¸ºR8ï¼šè„±ç³–ã€å‹ç¼©ã€ä¼˜åŒ–ã€æ··æ·† 5ã€è½¬åŒ–ä¸ºdexï¼šè°ƒç”¨dx.batï¼ˆæ–°ä¸ºD8ï¼‰å°†æ‰€æœ‰çš„classæ–‡ä»¶ï¼ˆä¸Šä¸€ä¸ªTransformçš„ç»“æœï¼ŒåŒ…æ‹¬3ã€javaæºç ç¼–è¯‘å’Œç¬¬ä¸‰æ–¹åº“ä¸­çš„.classï¼‰è½¬åŒ–ä¸º classes.dexæ–‡ä»¶ï¼ˆå¦‚æœæ˜¯multiDexçš„è¯å°±æ˜¯classesN.dexï¼‰ï¼Œdxä¼šå°†classè½¬æ¢ä¸ºDalvikå­—èŠ‚ç  6ã€æ‰“åŒ…ç”Ÿæˆapkï¼šé€šè¿‡sdklib.jarçš„ApkBuilderç±»è¿›è¡Œæ‰“åŒ…ï¼Œç”Ÿæˆapk 7ã€ç­¾åï¼šç­¾åè¿‡ç¨‹ä¸»è¦åˆ©ç”¨apksign.jaræˆ–è€…jarsinger.jarä¸¤ä¸ªå·¥å…· 8ã€zipalignä¼˜åŒ–ï¼šé€šè¿‡ zipalignå·¥å…·è¿›è¡Œå†…å­˜å¯¹é½å·¥ä½œã€‚ èµ„æºæ–‡ä»¶ç¼–è¯‘ï¼ˆAAPT2ï¼‰resourceï¼ˆ/resï¼‰ç›®å½• ï¼šres/ ç›®å½•ä¸‹çš„æ‰€æœ‰èµ„æºæ–‡ä»¶ å’Œ AndroidManifest.xml éƒ½ä¼šè¢«ç¼–è¯‘æˆ .flat çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä½“ç§¯æ›´å°ï¼Œè§£æé€Ÿåº¦æ›´å¿«ï¼‰ï¼ŒåŒæ—¶ä¼šè¢«æ˜ å°„åˆ°R.javaæ–‡ä»¶ï¼Œresource.arscæ–‡ä»¶ï¼Œè®¿é—®çš„æ—¶å€™ç›´æ¥ä½¿ç”¨èµ„æºIDå³ R.id.filename ï¼ˆå¦å¤–ï¼Œä¾èµ–åº“ä¸­çš„resourceä¹Ÿä¼šè¢«å¼•å…¥è€Œassetsä¸ä¼šï¼‰ //å¦‚æœæ˜¯AAPTåˆ™æ˜¯ç›´æ¥åˆå¹¶AndroidMenifestï¼Œç›´æ¥ä½¿ç”¨resã€‚è€Œä¸ä¼šå°†è¿™ä¸¤è€…ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶ã€‚ assetsï¼ˆ /assetsï¼‰ç›®å½•ï¼šä¼šè¢«åŸå°ä¸åŠ¨æ‰“åŒ…è¿›apkä¸­ï¼Œæ²¡æœ‰Ræ–‡ä»¶æ˜ å°„ï¼Œè®¿é—®çš„æ—¶å€™éœ€è¦AssetManagerç±»ã€‚ javaæ–‡ä»¶ç¼–è¯‘javac æ˜¯å°† .java æ–‡ä»¶ç¼–è¯‘æˆ .classæ–‡ä»¶çš„å·¥å…·ï¼Œæ˜¯JREæä¾›çš„å·¥å…·ã€‚ Tramformæ’æ¡© &amp; ASMä¿®æ”¹å­—èŠ‚ç åœ¨javacæ‰§è¡Œå®Œæˆï¼Œç”Ÿæˆ.classæ–‡ä»¶ä¹‹åï¼Œä¼šç»è¿‡desugarè„±ç³–ã€shrinkerå‹ç¼©ã€optimizerä¼˜åŒ–ã€ç­‰transformï¼Œè€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰Transformï¼Œè‡ªå®šä¹‰Transformä¼šæ’åˆ°æ•´ä¸ªTransformé“¾æ¡çš„æœ€å‰é¢ï¼Œå¹¶ä¸”é™¤äº†ä¸»å·¥ç¨‹javaæ–‡ä»¶ç¼–è¯‘åçš„classæ–‡ä»¶ï¼Œä¹Ÿèƒ½æ‹‰å»åˆ°ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…jar/aarï¼ŒåŠassetæ–‡ä»¶ã€‚ ç„¶åæˆ‘ä»¬åœ¨è‡ªå®šä¹‰Transformä¸­æ‹¿åˆ°çš„å­—èŠ‚ç ï¼ˆä¸»å·¥ç¨‹å’Œä¸‰æ–¹åº“ï¼‰å¯ä»¥ç”¨ASMè¿›è¡Œä¿®æ”¹ï¼Œæœ€åç»“æœäº§ç‰©åˆä¼šä¼ é€’ç»™Transformé“¾åé¢çš„è„±ç³–ã€å‹ç¼©ã€ä¼˜åŒ–ç­‰Transformç»§ç»­å¤„ç†ã€‚ æ··æ·†(Proguard-&gt;R8)ç®€è¿°ï¼š R8ä¹‹åï¼š.classæ–‡ä»¶ä¼šåœ¨ä¸€ä¸ªæ­¥éª¤ä¸­æ‰§è¡Œï¼šè„±ç³–ã€æ‘‡æ ‘ã€æ··æ·†ã€Dexå¤„ç† è„±ç³–(Desugar)ï¼šå»é™¤è¯­æ³•ç³–ï¼Œè¿˜åŸåŸæœ‰ä»£ç ï¼Œktå¾ˆå¤šè¯­æ³•ç³–æ¯”å¦‚æ‹“å±•å‡½æ•°ä¹‹ç±»ï¼› æ‘‡æ ‘(Code shrinking)ï¼štree shakingï¼Œä»AndroidMainifestä¸­çš„æ‰€æœ‰å…¥å£(Activityã€Serivceç­‰)å…¥æ‰‹ï¼Œæ„å»ºè¿è¡Œæ‰€éœ€è¦çš„æ‰€æœ‰ç±»ï¼Œå½¢æˆä¸€å¼ å›¾ï¼Œä¸åœ¨å›¾ä¸Šçš„ç±»éƒ½å¯èƒ½è¢«ç§»é™¤ï¼› èµ„æºç¼©å‡(Resource shrinking)ï¼šåªæœ‰åœ¨æ‰“å¼€äº†minifyEnabledæ‰æœ‰æ•ˆï¼Œé…åˆæ‘‡æ ‘ï¼Œåˆ é™¤æ‰€æœ‰ä¸è¢«å¼•ç”¨çš„èµ„æºï¼ŒåŒ…æ‹¬ä¾èµ–çš„åº“èµ„æºã€‚ æ··æ·†(Obfuscation)ï¼šç¼©çŸ­åº”ç”¨çš„æ‰€æœ‰éä¿ç•™ä»£ç (@Keep)ä¸­çš„ç±»åã€æ–¹æ³•åã€å­—æ®µå Dexå¤„ç†ï¼š.classè½¬.dex ä¼˜åŒ–(Optimization)ï¼š å¦‚æœæ‚¨çš„ä»£ç ä»æœªé‡‡ç”¨è¿‡ç»™å®š if/else è¯­å¥çš„ else {} åˆ†æ”¯ï¼ŒR8 å¯èƒ½ä¼šç§»é™¤ else {} åˆ†æ”¯çš„ä»£ç ã€‚ å¦‚æœæ‚¨çš„ä»£ç åªåœ¨ä¸€ä¸ªä½ç½®è°ƒç”¨æŸä¸ªæ–¹æ³•ï¼ŒR8 å¯èƒ½ä¼šç§»é™¤è¯¥æ–¹æ³•å¹¶å°†å…¶å†…åµŒåœ¨è¿™ä¸€ä¸ªè°ƒç”¨ç‚¹ã€‚ å¦‚æœ R8 ç¡®å®šæŸä¸ªç±»åªæœ‰ä¸€ä¸ªå”¯ä¸€å­ç±»ä¸”è¯¥ç±»æœ¬èº«æœªå®ä¾‹åŒ–ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªä»…ç”±ä¸€ä¸ªå…·ä½“å®ç°ç±»ä½¿ç”¨çš„æŠ½è±¡åŸºç±»ï¼‰ï¼Œå®ƒå°±å¯ä»¥å°†è¿™ä¸¤ä¸ªç±»ç»„åˆåœ¨ä¸€èµ·å¹¶ä»åº”ç”¨ä¸­ç§»é™¤ä¸€ä¸ªç±»ã€‚ ç®€è¿°ï¼š å¼•å…¥R8å‰ï¼Œ.classæ–‡ä»¶å¾—å…ˆç”±Proguardå‹ç¼©ã€æ‘‡æ ‘ã€æ··æ·†ã€é¢„æ ¡éªŒåç”Ÿæˆæ–°çš„.classæ–‡ä»¶ï¼Œå†ç»è¿‡D8ç¼–è¯‘æˆ.dex å¼•å…¥R8åï¼Œ.classæ–‡ä»¶ä¼šåœ¨ä¸€ä¸ªæ­¥éª¤ä¸­å‹ç¼©ã€æ‘‡æ ‘ã€æ··æ·†ã€é¢„æ ¡éªŒã€D8ç¼–è¯‘åç›´æ¥ç”Ÿæˆ.dex Proguard å¦‚æœæ‰“å¼€äº†æ··æ·†ï¼ˆminifyEnabled = trueï¼‰ é‚£ä¹ˆåœ¨ä¸Šè¿°ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œ å·¥ç¨‹é¡¹ç›®å’ŒR.java æ–‡ä»¶ç¼–æˆ .class æ–‡ä»¶åï¼ŒR8ï¼ˆæ—§Progurad æ–°R8ï¼‰å³ä¼šå¯¹ .classæ–‡ä»¶è¿›è¡Œ è„±ç³–ã€å‹ç¼©ã€æ··æ·†ã€ä¼˜åŒ–ã€‚ ä¹‹åå½¢æˆ æ–°çš„ .classæ–‡ä»¶åå†äº¤ç»™ D8 ç¼–è¯‘å™¨ ç¼–è¯‘æˆ.dexæ–‡ä»¶ ï¼Œä¹‹åç»§ç»­èµ°ä¸‹ä¸€æ­¥æ„å»ºæµç¨‹ã€‚ ProGuard ä¸ R8 éƒ½æä¾›äº†å‹ç¼©ï¼ˆshrinkerï¼‰ã€ä¼˜åŒ–ï¼ˆoptimizerï¼‰ã€æ··æ·†ï¼ˆobfuscatorï¼‰ã€é¢„æ ¡éªŒï¼ˆpreverifierï¼‰å››å¤§åŠŸèƒ½ï¼š å‹ç¼©ï¼ˆä¹Ÿç§°ä¸ºæ‘‡æ ‘ä¼˜åŒ–ï¼Œtree shakingï¼‰ï¼šä» åº”ç”¨åŠä¾èµ–é¡¹ ä¸­ç§»é™¤ æœªä½¿ç”¨ çš„ç±»ã€æ–¹æ³•å’Œå­—æ®µï¼Œæœ‰åŠ©äºè§„é¿ 64 æ–¹æ³•æ•°çš„ç“¶é¢ˆ ä¼˜åŒ–ï¼šé€šè¿‡ä»£ç åˆ†æç§»é™¤æ›´å¤šæœªä½¿ç”¨çš„ä»£ç ï¼Œç”šè‡³é‡å†™ä»£ç  æ··æ·†ï¼šä½¿ç”¨æ— æ„ä¹‰çš„ç®€çŸ­åç§° é‡å‘½å ç±»/æ–¹æ³•/å­—æ®µï¼Œå¢åŠ é€†å‘éš¾åº¦ é¢„æ ¡éªŒï¼šå¯¹äºé¢å‘ Java 6 æˆ–è€… Java 7 JVM çš„ class æ–‡ä»¶ï¼Œç¼–è¯‘æ—¶å¯ä»¥æŠŠ é¢„æ ¡éªŒä¿¡æ¯ æ·»åŠ åˆ°ç±»æ–‡ä»¶ä¸­ï¼ˆStackMap å’Œ StackMapTableå±æ€§ï¼‰ï¼Œä»è€ŒåŠ å¿«ç±»åŠ è½½æ•ˆç‡ã€‚é¢„æ ¡éªŒå¯¹äº Java 7 JVM æ¥è¯´æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯å¯¹äº Android å¹³å° æ— æ•ˆ minifyEnabledåªå¯¹ä»£ç è¿›è¡Œå‹ç¼©ã€ä¼˜åŒ–ã€æ··æ·† shrinkResourcesPs:shrink ç¾ [ÊƒrÉªÅ‹k] å¦‚éœ€å¯ç”¨èµ„æºç¼©å‡åŠŸèƒ½ï¼Œè¯·å°† build.gradle æ–‡ä»¶ä¸­çš„ shrinkResources å±æ€§ï¼ˆè‹¥ä¸ºä»£ç ç¼©å‡ï¼Œåˆ™è¿˜åŒ…æ‹¬ minifyEnabledï¼‰è®¾ä¸º trueã€‚ 123456789101112android { ... buildTypes { release { shrinkResources true minifyEnabled true proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro' } }} èµ„æºç¼©å‡åªæœ‰åœ¨ä¸ä»£ç ç¼©å‡é…åˆä½¿ç”¨æ—¶æ‰èƒ½å‘æŒ¥ä½œç”¨ã€‚åœ¨ä»£ç ç¼©å‡å™¨ç§»é™¤æ‰€æœ‰ä¸ä½¿ç”¨çš„ä»£ç åï¼Œèµ„æºç¼©å‡å™¨ä¾¿å¯ç¡®å®šåº”ç”¨ä»è¦ä½¿ç”¨çš„èµ„æºï¼Œå½“æ‚¨æ·»åŠ åŒ…å«èµ„æºçš„ä»£ç åº“æ—¶å°¤å…¶å¦‚æ­¤ã€‚æ‚¨å¿…é¡»ç§»é™¤ä¸ä½¿ç”¨çš„åº“ä»£ç ï¼Œä½¿åº“èµ„æºå˜ä¸ºæœªå¼•ç”¨èµ„æºï¼Œå› è€Œå¯ç”±èµ„æºç¼©å‡å™¨ç§»é™¤ã€‚ .classæ–‡ä»¶ç¼–è¯‘(DX-&gt;D8)DXå’ŒD8å°±æ˜¯å°† .class æ–‡ä»¶è½¬æˆ .dexæ–‡ä»¶çš„å·¥å…· èµ„æºæ–‡ä»¶ç¼–è¯‘åäº§å‡ºçš„R.java å’Œ å·¥ç¨‹ä¸­çš„å…¶ä»–.java æ–‡ä»¶ä¸€èµ·ï¼Œå…ˆé€šè¿‡ javacå‘½ä»¤ç¼–è¯‘æˆ**.class**æ–‡ä»¶ï¼Œç„¶åæ‰€æœ‰äº§å‡ºçš„ .class æ–‡ä»¶å†é€šè¿‡ dxæŒ‡ä»¤ï¼ˆç°é»˜è®¤D8ç¼–è¯‘å™¨ï¼‰ ç¼–è¯‘æˆ .dexæ–‡ä»¶ ï¼Œ classè½¬æ¢ä¸ºDalvikå­—èŠ‚ç ï¼Œç”Ÿæˆå¸¸é‡æ± ï¼Œæ¶ˆé™¤å†—ä½™æ•°æ®ç­‰ï¼Œç›®çš„æ˜¯å…¶ä¸­å„ä¸ªç±»èƒ½å¤Ÿå…±äº«æ•°æ®ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†å†—ä½™ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ–‡ä»¶ç»“æ„æ›´åŠ ç»å‡‘ï¼Œå®éªŒè¡¨æ˜ï¼Œdexæ–‡ä»¶æ˜¯ä¼ ç»Ÿjaræ–‡ä»¶å¤§å°çš„50%å·¦å³ã€‚classæ–‡ä»¶ç»“æ„å’Œdexæ–‡ä»¶ç»“æ„æ¯”å¯¹ã€‚ æ‰“åŒ…æˆApkæ‰“åŒ…ç”ŸæˆAPKæ–‡ä»¶ã€‚æ—§çš„apkbuilderè„šæœ¬å·²ç»åºŸå¼ƒï¼Œç°åœ¨éƒ½å·²ç»é€šè¿‡sdklib.jarçš„ApkBuilderç±»è¿›è¡Œæ‰“åŒ…äº†ã€‚è¾“å…¥ä¸ºæˆ‘ä»¬ä¹‹å‰ç”Ÿæˆçš„åŒ…å«resources.arcsçš„.ap_æ–‡ä»¶ï¼Œä¸Šä¸€æ­¥ç”Ÿæˆçš„dexæ–‡ä»¶ï¼Œä»¥åŠå…¶ä»–èµ„æºå¦‚jniã€jaråŒ…å†…çš„èµ„æºã€‚ å¤§è‡´æ­¥éª¤ä¸ºä»¥åŒ…å«resources.arcsçš„.ap_æ–‡ä»¶ä¸ºåŸºç¡€ï¼Œnewä¸€ä¸ªApkBuilderï¼Œè®¾ç½®debugModeapkBuilder.addZipFile(f);apkBuilder.addSourceFolder(f);apkBuilder.addResourcesFromJar(f);apkBuilder.addNativeLibraries(nativeFileList);apkBuilder.sealApk(); // å…³é—­apkæ–‡ä»¶generateDependencyFile(depFile, inputPaths, outputFile.getAbsolutePath()); ç­¾åå¯¹ä¸€ä¸ªAPKæ–‡ä»¶ç­¾åä¹‹åï¼ŒAPKæ–‡ä»¶æ ¹ç›®å½•ä¸‹ä¼šå¢åŠ META-INFç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹å¢åŠ ä¸‰ä¸ªæ–‡ä»¶ï¼š MANIFEST.MF [CERT].RSA [CERT] Androidç³»ç»Ÿå°±æ˜¯æ ¹æ®è¿™ä¸‰ä¸ªæ–‡ä»¶çš„å†…å®¹å¯¹APKæ–‡ä»¶è¿›è¡Œç­¾åæ£€éªŒçš„ã€‚ zipalignä¼˜åŒ–è°ƒç”¨buildtoolszipalignï¼Œå¯¹ç­¾ååçš„apkæ–‡ä»¶è¿›è¡Œå¯¹é½å¤„ç†ï¼Œä½¿apkä¸­æ‰€æœ‰èµ„æºæ–‡ä»¶è·ç¦»æ–‡ä»¶èµ·å§‹åç§»ä¸º4å­—èŠ‚çš„æ•´æ•°å€ï¼Œä»è€Œåœ¨é€šè¿‡å†…å­˜æ˜ å°„è®¿é—®apkæ–‡ä»¶æ—¶ä¼šæ›´å¿«ã€‚åŒæ—¶ä¹Ÿå‡å°‘äº†åœ¨è®¾å¤‡ä¸Šè¿è¡Œæ—¶çš„å†…å­˜æ¶ˆè€—ã€‚ é™„å½•ï¼šç‰ˆæœ¬è¿­ä»£ï¼ŒR8ã€D8å¼•å…¥ å®‰è£…å®‰è£…æ–¹å¼ç³»ç»Ÿç¨‹åºå®‰è£…ï¼Œå¼€æœºæ—¶å®‰è£…ï¼Œæ²¡æœ‰å®‰è£…ç•Œé¢ã€‚ç¬¬ä¸€æ­¥ï¼Œå°†apkæ–‡ä»¶è§£å‹å¤åˆ¶åˆ°ç¨‹åºç›®å½•ä¸‹ï¼ˆ/data/app/ï¼‰ï¼›ç¬¬äºŒæ­¥ï¼Œä¸ºåº”ç”¨åˆ›å»ºæ•°æ®ç›®å½•ï¼ˆ/data/data/package name/ï¼‰ã€æå–dexæ–‡ä»¶åˆ°æŒ‡å®šç›®å½•ï¼ˆ/data/dalvik-cache/ï¼‰ã€ä¿®æ”¹ç³»ç»ŸåŒ…ç®¡ç†ä¿¡æ¯ã€‚ç”±å¼€æœºæ—¶å¯åŠ¨çš„PackageManagerServiceæœåŠ¡å®Œæˆï¼Œä¼šåœ¨å¯åŠ¨æ—¶æ‰«æ/system/app, vender/app, /data/app, /data/app-privateå¹¶å®‰è£…ã€‚PackageInstallerActivityå½“Androidç³»ç»Ÿè¯·æ±‚å®‰è£…apkç¨‹åºæ—¶ï¼Œä¼šå¯åŠ¨è¿™ä¸ªActivityï¼Œå¹¶é€šè¿‡Intentè¯»å–ä¼ æ¥çš„apkä¿¡æ¯ã€‚ä¸‹é¢æ˜¯apkå®‰è£…çš„å…·ä½“è¿‡ç¨‹ã€‚ è§£æè¿‡ç¨‹ä¼šé¦–å…ˆè¯»å–AndroidManifest.xmlè·å–ç¨‹åºåŒ…åä»¥æ„å»ºPackageå¯¹è±¡ï¼Œç„¶åå†å¤„ç†manifestçš„å…¶ä»–æ ‡ç­¾åŒ…æ‹¬å››å¤§ç»„ä»¶ï¼Œå¹¶æŠŠä¿¡æ¯å…¨éƒ½å­˜åˆ°Packageå¯¹è±¡é‡Œé¢ã€‚ é¦–å…ˆæ£€æµ‹è¯¥ç¨‹åºæ˜¯å¦å·²å®‰è£…ï¼Œæ˜¯åˆ™å¼¹æ¡†æç¤ºæ˜¯å¦æ›¿æ¢ç¨‹åºï¼Œå¦åˆ™ç›´æ¥è°ƒç”¨startInstallConfirm()ï¼ŒåšUIåˆå§‹åŒ–å’Œäº‹ä»¶ç»‘å®šï¼Œäºæ˜¯å½“æˆ‘ä»¬ç‚¹å‡»å®‰è£…çš„æ—¶å€™åˆ™ä¼šè§¦å‘onClickä¸‹çš„OKæŒ‰é’®äº‹ä»¶: æ— è®ºæ˜¯æ›¿æ¢è¿˜æ˜¯æ–°å®‰è£…ï¼Œéƒ½ä¼šè°ƒç”¨scanPackageLI()ï¼Œç„¶åè·‘å»scanPackageDirtyLIï¼Œå®ƒä¼šåˆ¤æ–­æ˜¯å¦ä¸ºç³»ç»Ÿç¨‹åºï¼Œè§£æapkç¨‹åºåŒ…ï¼Œæ£€æŸ¥ä¾èµ–åº“ï¼ŒéªŒè¯ç­¾åï¼Œæ£€æŸ¥sharedUserç­¾åã€æƒé™å†²çªã€ContentProviderå†²çªï¼Œæ›´æ–°nativeåº“ç›®å½•æ–‡ä»¶ï¼ˆæ£€æµ‹abiï¼‰ï¼Œè¿›è¡Œdexoptï¼Œæ€æ‰ç°æœ‰è¿›ç¨‹ï¼ˆä»…å¯¹è¦†ç›–å®‰è£…çš„åœºæ™¯ï¼‰ç­‰ç­‰ï¼Œæœ€åè°ƒç”¨createDataDirsLI()è¿›è¡Œå®é™…å®‰è£…:4.æ‰§è¡Œå®Œæ¯•åï¼Œé€šè¿‡socketå›ä¼ ç»“æœï¼Œè€ŒPackageInstalleræ ¹æ®è¿”å›ç»“æœåšå¯¹åº”å¤„ç†å¹¶æ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œè‡³æ­¤ä¸ºæ­¢ï¼Œæ•´ä¸ªapkå®‰è£…è¿‡ç¨‹ç»“æŸã€‚ åŒ…åç­¾åç›¸å…³androidç³»ç»Ÿä½¿ç”¨åŒ…å(package name)æ¥åˆ¤å®šåº”ç”¨ç¨‹åºçš„åŒä¸€æ€§ï¼Œä½†æ˜¯ç”±äºåŒ…åå¯ä»¥ç”±å¼€å‘è€…è‡ªç”±è®¾ç½®ï¼Œä¸ºäº†ä¿æŠ¤åº”ç”¨ç¨‹åºä¸è¢«å…¶ä»–å¼€å‘è€…å¼€å‘çš„åŒåŒ…ååº”ç”¨è¦†ç›–ï¼Œç”¨äºå‘å¸ƒçš„Androidåº”ç”¨ç¨‹åºéœ€è¦åŠ ä¸Šå¼€å‘è€…ç­¾åã€‚åœ¨åº”ç”¨ç¨‹åºè¢«å‡çº§çš„æ—¶å€™ï¼ŒAndroidç³»ç»Ÿå°†ä¼šéªŒè¯è¢«å‡çº§çš„åº”ç”¨ç¨‹åºåŒ…ä¸å‡çº§åçš„åº”ç”¨ç¨‹åºåŒ…æ˜¯å¦ä½¿ç”¨äº†åŒæ ·çš„å¼€å‘è€…ç­¾åï¼Œå¦‚æœä¸€è‡´ï¼Œè¯¥åº”ç”¨ç¨‹åºå¯ä»¥è¢«å‡çº§ï¼›å¦‚æœä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°†è¢«è§†ä¸ºéåŒä¸€å¼€å‘è€…å¼€å‘çš„åº”ç”¨ç¨‹åºï¼Œç”¨æˆ·éœ€è¦å…ˆå¸è½½å·²ç»å®‰è£…çš„åº”ç”¨ç„¶åå†å®‰è£…æ–°åº”ç”¨ï¼Œåœ¨å¸è½½çš„è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨åœ¨androidç³»ç»Ÿä¸­æ‰€ä¿å­˜çš„è®¾ç½®ä¿¡æ¯ï¼ˆSavedPreferencesï¼‰å°†è¢«åˆ é™¤ï¼Œä»¥ä¿æŠ¤åº”ç”¨æœ¬åœ°ä¿å­˜çš„èµ„æ–™ä¸è¢«ç›—å–ã€‚ç»¼ä¸Šï¼Œåº”ç”¨æ˜¯å¦å¯ä»¥è¦†ç›–çš„æ–¹å¼æ˜¯å¯¹äºåŒ…åçš„åˆ¤æ–­ï¼Œç„¶åæ˜¯å¯¹äºè¯¥APKç­¾åçš„åˆ¤æ–­ã€‚ AOPåŸç† åœ¨ç¡®å®šå¥½æŠ€æœ¯é€‰å‹ä»¥åæˆ‘ä»¬æ¥çœ‹ä¸‹ASMçš„ç›¸å…³åŸç†ã€‚å…¶å®é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å·²ç»èƒ½å¤Ÿå¤§æ¦‚äº†è§£å…¶å¤§è‡´çš„åŸç†ã€‚AS Gradleçš„ç¼–è¯‘ä¼šå°†æˆ‘ä»¬çš„java classæ–‡ä»¶ã€jaråŒ…ä»¥åŠresourceèµ„æºæ–‡ä»¶æ‰“åŒ…æœ€ä¸ºæœ€åŸå§‹çš„æ•°æ®è¾“å‡ºç»™ç¬¬ä¸€ä¸ªTransformï¼Œç¬¬ä¸€ä¸ªtransformå¤„ç†å®Œçš„äº§ç‰©å†è¾“å‡ºç»™ç¬¬äºŒä¸ªtransformï¼Œä»¥æ­¤ç±»æ¨å½¢æˆå®Œæ•´çš„é“¾è·¯ã€‚è€ŒASMå°±æ˜¯ä½œç”¨äºå›¾ä¸­çš„ç¬¬ä¸€ä¸ªçº¢è‰²TransformAã€‚å®ƒä¼šæ‹¿åˆ°ä¸€å¼€å§‹çš„åŸå§‹æ•°æ®ä»¥åä¼šè¿›è¡Œä¸€å®šçš„åˆ†æã€‚å¹¶ä¸”æŒ‰ç…§JVMå­—èŠ‚ç çš„æ ¼å¼é’ˆå¯¹ç±»ã€å˜é‡ã€æ–¹æ³•ç­‰ç±»å‹è°ƒç”¨ç›¸å…³çš„å›è°ƒæ–¹æ³•ã€‚åœ¨ç›¸åº”çš„å›è°ƒæ–¹æ³•ä¸­æˆ‘ä»¬å¯ä»¥å¯¹ç›¸å…³çš„å­—èŠ‚ç æŒ‡ä»¤è¿›è¡Œæ“ä½œã€‚æ¯”å¦‚æ–°å¢ã€åˆ é™¤ç­‰ç­‰ã€‚ä¸­é—´çš„å›¾ç‰‡å°±æ˜¯å®ƒå…·ä½“çš„è¿è¡Œæ—¶åºå›¾ã€‚æœ€åä¸¤è€…ç»“åˆç¼–è¯‘ æ‰‹åŠ¨æ„å»º APK(aapt2)æœ€åæˆ‘ä»¬é€šè¿‡å‘½ä»¤è¡Œæ¥æ‰‹åŠ¨æ‰“åŒ…ä¸€ä¸ªå¯æ‰§è¡Œçš„ APKï¼Œèƒ½è®©æˆ‘ä»¬å¯¹ APK æ„å»ºçš„ç†è§£æ›´åŠ æ·±å…¥ã€‚é¦–å…ˆéœ€è¦å‡†å¤‡ä¸‹ ä»£ç ã€èµ„æºæ–‡ä»¶ã€AndroidManifest è¿™äº›æ„å»º APK çš„å¿…è¦æ–‡ä»¶ã€‚ â‘  é€šè¿‡ aapt2 compile å°† res èµ„æºç¼–è¯‘æˆ .flat çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š 1aapt2 compile -o build/res.zip --dir res â‘¡ é€šè¿‡ aapt2 link å°† .flat å’Œ AndroidManifest è¿›è¡Œè¿æ¥ï¼Œè½¬åŒ–æˆä¸åŒ…å« dex çš„ apk å’Œ R.javaï¼š 1aapt2 link build/res.zip -I $ANDROID_HOME/platforms/android-30/android.jar --java build --manifest AndroidManifest.xml -o build/app-debug.apk â‘¢ é€šè¿‡ javac å°† Java æ–‡ä»¶ç¼–è¯‘æˆ .class æ–‡ä»¶ï¼š 1javac -d build -cp $ANDROID_HOME/platforms/android-30/android.jar com/**/**/**/*.java â‘£ é€šè¿‡ d8 å°† .class æ–‡ä»¶è½¬åŒ–æˆ dex æ–‡ä»¶ï¼š 1d8 --output build/ --lib $ANDROID_HOME/platforms/android-30/android.jar build/com/tencent/hockeyli/androidbuild/*.class â‘¤ åˆå¹¶ dex â½‚ä»¶å’Œèµ„æºâ½‚ä»¶ï¼š 1zip -j build/app-debug.apk build/classes.dex â‘¥ å¯¹ apk é€šè¿‡ apksigner è¿›è¡Œç­¾åï¼š 1apksigner sign -ks ~/.android/debug.keystore build/appdebug.apk å‚è€ƒ10åˆ†é’Ÿäº†è§£Androidé¡¹ç›®æ„å»ºæµç¨‹ - æ˜é‡‘ (juejin.cn) APKæ‰“åŒ…å®‰è£…è¿‡ç¨‹ - SegmentFault æ€å¦","link":"/2021/04/01/AndroidBuild/"},{"title":"APM","text":"ä¸»çº¿ç¨‹å¡é¡¿ç›‘æ§æ–¹æ¡ˆä¸€ã€Looper Printerç›‘æ§æ¯æ¬¡ dispatchMessage çš„æ‰§è¡Œè€—æ—¶ï¼šDoKit &amp; BlockCanary &amp; Matrixæ»´æ»´çš„å“†å•¦Aæ¢¦çš„å¡é¡¿æ£€æµ‹å…¶å®å°±æ˜¯blockCanaryï¼Œå’ŒMatrix çš„EvilMethodTracerå’ŒAnrTracer ï¼ˆå½“ç„¶åæ¥Matrixè¿˜å¢åŠ äº†nativeçš„Signalä¿¡å·ç›‘å¬ï¼‰ä½¿ç”¨çš„ æ–¹æ¡ˆä¹Ÿå°±æ˜¯Looperè®¾ç½®Printerç›‘å¬å¡é¡¿ éƒ½æ˜¯æ ¹æ®handleråŸç†ï¼Œé€šè¿‡ç»™Looper.loop() ä¸­è®¾ç½®printer(æ— è®ºæ˜¯é€šè¿‡åå°„æ›¿æ¢Looperçš„mLoggingè¿˜æ˜¯é€šè¿‡setMessageLoggingè®¾ç½®printer)ï¼Œç›‘æ§è¶…è¿‡ è®¾å®šé˜ˆå€¼(matrix700ms) çš„ä¸»çº¿ç¨‹æ¶ˆæ¯ï¼ˆè¶…è¿‡5sæŠ¥ä¸ºANRï¼‰ï¼Œprinter ä¸­åˆ¤æ–­startå’Œendï¼Œæ¥è·å–ä¸»çº¿ç¨‹dispatchè¯¥messageçš„å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œå¹¶åˆ¤å®šè¯¥æ—¶é—´è¶…è¿‡é˜ˆå€¼ä¸ºä¸»çº¿ç¨‹å¡æ…¢å‘ç”Ÿï¼Œå¹¶ æ‰“å°å½“æ—¶å †æ ˆ + æ–¹æ³•è€—æ—¶(matrix/dokit) 123456789101112131415161718192021222324252627282930Looper.loop() { for (;;) { Message msg = queue.next(); // might block if (msg == null) { ... // æ‰§è¡ŒdispatchMessageå‰ï¼Œæ‰§è¡ŒPrinterçš„printlnæ–¹æ³• final Printer logging = me.mLogging; if (logging != null) { logging.println(&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot; + msg.target + &quot; &quot; + msg.callback + &quot;: &quot; + msg.what); } ... try { msg.target.dispatchMessage(msg); dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : 0; } finally { ... } ... // æ‰§è¡ŒdispatchMessageåï¼Œæ‰§è¡ŒPrinterçš„printlnæ–¹æ³• if (logging != null) { logging.println(&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot; + msg.target + &quot; &quot; + msg.callback); } ... }} Matrixï¼šæ— è®ºæ˜¯é€šè¿‡åå°„æ›¿æ¢Looperçš„mLoggingè¿˜æ˜¯é€šè¿‡setMessageLoggingè®¾ç½®printerï¼Œæˆ‘ä»¬åªéœ€è¦æ›¿æ¢ä¸»çº¿ç¨‹Looperçš„printerå¯¹è±¡ï¼Œé€šè¿‡è®¡ç®—æ‰§è¡ŒdispatchMessageæ–¹æ³•ä¹‹åå’Œä¹‹å‰æ‰“å°å­—ç¬¦ä¸²çš„æ—¶é—´çš„å·®å€¼ï¼Œå°±å¯ä»¥æ‹¿åˆ°åˆ°dispatchMessageæ–¹æ³•æ‰§è¡Œçš„æ—¶é—´ã€‚è€Œå¤§éƒ¨åˆ†çš„ä¸»çº¿ç¨‹çš„æ“ä½œæœ€ç»ˆéƒ½ä¼šæ‰§è¡Œåˆ°è¿™ä¸ªdispatchMessageæ–¹æ³•ä¸­ã€‚ printerç›‘æ§æ–¹æ¡ˆå­˜åœ¨é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼šç®€è¿°ï¼šä¸€æ˜¯ä¸»çº¿ç¨‹ç©ºé—²æ—¶message.next()ä¼šé˜»å¡å¹¶ä¸”Touchäº‹ä»¶ä¹Ÿæ˜¯æ‰§è¡Œåœ¨nextä¸­çš„natviePollOnceé‡Œé¢çš„ï¼ŒäºŒæ˜¯IdleHandlerç©ºé—²handlerçš„queueIdleå›è°ƒ Qï¼šå¦‚æœæ’é™¤ä¸»çº¿ç¨‹ç©ºé—²çš„æƒ…å†µï¼Œç©¶ç«Ÿä¼šæ˜¯ä»€ä¹ˆåŸå› ä¼šå¡åœ¨MessageQueueçš„nextæ–¹æ³•ä¸­å‘¢ï¼Ÿä¸‹å›¾æ˜¯nextæ–¹æ³•ç®€åŒ–è¿‡åçš„æºç ï¼Œ*frameworks/base/core/java/android/os/MessageQueue.java:* 1234567891011121314151617181920212223242526272829303132333435for (;;) { if (nextPollTimeoutMillis != 0) { Binder.flushPendingCommands(); } nativePollOnce(ptr, nextPollTimeoutMillis); //...... // Run the idle handlers. // We only ever reach this code block during the first iteration. for (int i = 0; i &lt; pendingIdleHandlerCount; i++) { final IdleHandler idler = mPendingIdleHandlers[i]; mPendingIdleHandlers[i] = null; // release the reference to the handler boolean keep = false; try { keep = idler.queueIdle(); } catch (Throwable t) { Log.wtf(TAG, &quot;IdleHandler threw exception&quot;, t); } if (!keep) { synchronized (this) { mIdleHandlers.remove(idler); } } } //......}/*1. å¦‚æœæœ¬æ¬¡å¾ªç¯æ‹¿åˆ°çš„Messageä¸ºç©ºï¼Œæˆ–è€…ï¼è¿™ä¸ªMessageæ˜¯ä¸€ä¸ªå»¶æ—¶çš„æ¶ˆæ¯è€Œä¸”è¿˜æ²¡åˆ°æŒ‡å®šçš„è§¦å‘æ—¶é—´ï¼Œé‚£ä¹ˆï¼Œå°±è®¤å®šå½“å‰çš„é˜Ÿåˆ—ä¸ºç©ºé—²çŠ¶æ€ï¼Œ2. æ¥ç€å°±ä¼šéå†mPendingIdleHandlersæ•°ç»„(è¿™ä¸ªæ•°ç»„é‡Œé¢çš„å…ƒç´ æ¯æ¬¡éƒ½ä¼šåˆ°mIdleHandlersä¸­å»æ‹¿)æ¥è°ƒç”¨æ¯ä¸€ä¸ªIdleHandlerå®ä¾‹çš„queueIdleæ–¹æ³•ï¼Œ3. æœè¿™ä¸ªæ–¹æ³•è¿”å›falseçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå®ä¾‹å°±ä¼šä»mIdleHandlersä¸­ç§»é™¤ï¼Œä¹Ÿå°±æ˜¯å½“ä¸‹æ¬¡é˜Ÿåˆ—ç©ºé—²çš„æ—¶å€™ï¼Œä¸ä¼šç»§ç»­å›è°ƒå®ƒçš„queueIdleæ–¹æ³•äº†ã€‚*/ å› ä¸ºæœ‰äº›æƒ…å†µçš„å¡é¡¿ï¼Œè¿™ç§æ–¹æ¡ˆä»åŸç†ä¸Šå°±æ— æ³•ç›‘æ§åˆ°ã€‚çœ‹åˆ°ä¸Šé¢çš„queue.next()ï¼Œè¿™é‡Œç»™äº†æ³¨é‡Šï¼šmight blockï¼Œç›´æ¥è·Ÿä½ è¯´è¿™é‡Œæ˜¯å¯èƒ½ä¼šå¡ä½çš„ï¼Œè¿™æ—¶å€™å†è®¡ç®—dispatchMessageæ–¹æ³•çš„è€—æ—¶æ˜¾ç„¶å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚æœ‰çš„åŒå­¦å¯èƒ½ä¼šæƒ³ï¼Œé‚£æˆ‘æ”¹æˆè®¡ç®—ç›¸é‚»ä¸¤æ¬¡dispatchMessageæ‰§è¡Œä¹‹å‰æ‰“å°å­—ç¬¦ä¸²çš„æ—¶é—´å·®å€¼ä¸å°±å¥½äº†ï¼Ÿè¿™æ ·å°±å¯ä»¥æŠŠnextæ–¹æ³•çš„è€—æ—¶ä¹Ÿè®¡ç®—åœ¨å†…ã€‚ 1ã€ä¸»çº¿ç¨‹ç©ºé—²ä¹Ÿå°±æ˜¯queue.next()é˜»å¡çš„æ—¶å€™ï¼ŒåŒæ—¶ä¹Ÿæ˜¯åº”ç”¨çš„Touchäº‹ä»¶ã€‚ä¸å¹¸çš„æ˜¯ï¼Œä¸»çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¹Ÿä¼šé˜»å¡åœ¨MessageQueueçš„nextæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¾ˆéš¾åŒºåˆ†ç©¶ç«Ÿæ˜¯å‘ç”Ÿäº†å¡é¡¿è¿˜æ˜¯ä¸»çº¿ç¨‹ç©ºé—²ï¼Œé™¤äº†ä¸»çº¿ç¨‹ç©ºé—²æ—¶å°±æ˜¯é˜»å¡åœ¨nativePollOnceä¹‹å¤–ï¼Œéå¸¸é‡è¦çš„æ˜¯ï¼Œåº”ç”¨çš„Touchäº‹ä»¶ä¹Ÿæ˜¯åœ¨è¿™é‡Œè¢«å¤„ç†çš„ã€‚è¿™å°±æ„å‘³ç€ï¼ŒViewçš„TouchEventä¸­çš„å¡é¡¿è¿™ç§æ–¹æ¡ˆæ˜¯æ— æ³•ç›‘æ§çš„ã€‚ï¼ˆå¾®ä¿¡ä¸­æœ‰å¤§é‡çš„è‡ªå®šä¹‰Viewï¼Œè¿™äº›Viewä¸­å……æ»¡äº†å„ç§å„æ ·å¾ˆå¤šçš„onTouchå›è°ƒï¼Œå¡åœ¨è¿™é‡Œé¢çš„æƒ…å†µéå¸¸æ™®éï¼Œè¿™ç§æƒ…å†µçš„å¡é¡¿ç›‘æ§ä¸åˆ°æ˜¯å¾ˆéš¾æ¥å—çš„ï¼‰ 2ã€IdleHandlerçš„queueIdle()å›è°ƒæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šåœ¨ä¸»çº¿ç¨‹ç©ºé—²çš„æ—¶å€™è¢«è°ƒç”¨ã€‚ç„¶è€Œå®é™…ä¸Šï¼Œå¾ˆå¤šå¼€å‘åŒå­¦éƒ½å…ˆå…¥ä¸ºä¸»çš„è®¤ä¸ºè¿™ä¸ªæ—¶å€™åæ­£ä¸»çº¿ç¨‹ç©ºé—²ï¼Œåšä¸€äº›è€—æ—¶æ“ä½œä¹Ÿæ²¡æ‰€è°“ã€‚å…¶å®ä¸»çº¿ç¨‹MessageQueueçš„queueIdleé»˜è®¤å½“ç„¶ä¹Ÿæ˜¯æ‰§è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œçš„è€—æ—¶æ“ä½œå…¶å®æ˜¯å¾ˆå®¹æ˜“å¼•èµ·å¡é¡¿å’ŒANRçš„ã€‚ï¼ˆä¾‹å¦‚å¾®ä¿¡ä¹‹å‰å°±ä½¿ç”¨IdleHandleråœ¨è¿›å…¥å¾®ä¿¡çš„ä¸»ç•Œé¢åï¼Œåšä¸€äº›è¯»å†™æ–‡ä»¶çš„IOæ“ä½œï¼Œå°±é€ æˆäº†ä¸€äº›å¡é¡¿å’ŒANRé—®é¢˜ï¼‰ 3ã€SyncBarrieræ³„éœ²ã€‚è¿˜æœ‰ä¸€ç±»ç›¸å¯¹å°‘è§çš„é—®é¢˜æ˜¯SyncBarrierï¼ˆåŒæ­¥å±éšœï¼‰çš„æ³„æ¼åŒæ ·æ— æ³•è¢«ç›‘æ§åˆ° Aï¼šA.1. ç›‘æ§IdleHandlerå¡é¡¿é¦–å…ˆä»ç®€å•çš„ä¸‹æ‰‹ï¼Œå¯¹äºIdleHandlerçš„queueIdleå›è°ƒæ–¹æ³•çš„ç›‘æ§ã€‚æˆ‘ä»¬æƒŠå–œçš„å‘ç°MessageQueueä¸­çš„mIdleHandlersæ˜¯å¯ä»¥è¢«åå°„çš„ï¼Œè¿™ä¸ªå˜é‡ä¿å­˜äº†æ‰€æœ‰å°†è¦æ‰§è¡Œçš„IdleHandlerï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠArrayListç±»å‹çš„mIdleHandlersï¼Œé€šè¿‡åå°„ï¼Œæ›¿æ¢ä¸ºMyArrayListï¼Œåœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„MyArrayListä¸­é‡å†™addæ–¹æ³•ï¼Œå†å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„MyIdleHandleræ·»åŠ åˆ°MyArrayListä¸­ï¼Œå°±å®Œæˆäº†â€œå·å¤©æ¢æ—¥â€ã€‚ä»æ­¤ä¹‹åMessageQueueæ¯æ¬¡æ‰§è¡ŒqueueIdleå›è°ƒæ–¹æ³•ï¼Œéƒ½ä¼šæ‰§è¡Œåˆ°æˆ‘ä»¬çš„MyIdleHandlerä¸­çš„çš„queueIdleæ–¹æ³•ï¼Œå°±å¯ä»¥åœ¨è¿™é‡Œç›‘æ§queueIdleçš„æ‰§è¡Œæ—¶é—´äº†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940private static void detectIdleHandler() { try { MessageQueue mainQueue = Looper.getMainLooper().getQueue(); Field field = MessageQueue.class.getDeclaredField(&quot;mIdleHandlers&quot;); field.setAccessible(true); MyArrayList&lt;MessageQueue.IdleHandler&gt; myIdleHandlerArrayList = new MyArrayList&lt;&gt;(); field.set(mainQueue, myIdleHandlerArrayList); } catch (Throwable t) { t.printStackTrace(); }}static class MyArrayList&lt;T&gt; extends ArrayList { Map&lt;MessageQueue.IdleHandler, MyIdleHandler&gt; map = new HashMap&lt;&gt;(); @Override public boolean add(Object o) { if (o instanceof MessageQueue.IdleHandler) { MyIdleHandler myIdleHandler = new MyIdleHandler((MessageQueue.IdleHandler) o); map.put((MessageQueue.IdleHandler) o, myIdleHandler); return super.add(myIdleHandler); } return super.add(o); } @Override public boolean remove(@Nullable Object o) { if (o instanceof MyIdleHandler) { MessageQueue.IdleHandler idleHandler = ((MyIdleHandler) o).idleHandler; map.remove(idleHandler); return super.remove(o); } else { MyIdleHandler myIdleHandler = map.remove(o); if (myIdleHandler != null) { return super.remove(myIdleHandler); } return super.remove(o); } }} A.2. ç›‘æ§TouchEventå¡é¡¿é‚£ä¹ˆTouchEventæˆ‘ä»¬æœ‰ä»€ä¹ˆåŠæ³•ç›‘æ§å—ï¼Ÿé¦–å…ˆæƒ³åˆ°çš„å¯èƒ½æ˜¯åå°„Viewçš„mListenerInfoï¼Œç„¶åè¿›ä¸€æ­¥æ›¿æ¢å…¶ä¸­çš„mTouchListenrï¼Œä½†æ˜¯è¿™éœ€è¦æˆ‘ä»¬æšä¸¾æ‰€æœ‰éœ€è¦è¢«ç›‘æ§çš„Viewï¼Œå…¨éƒ¨åå°„æ›¿æ¢ä¸€éï¼Œè¿™å®Œå…¨æ˜¯æ†¨æ†¨è¡Œä¸ºã€‚é‚£æœ‰æ²¡æœ‰æ›´åŠ æ ¹æœ¬ï¼Œå…¨å±€æ€§çš„æ–¹æ³•å‘¢ï¼Ÿ ç†Ÿæ‚‰inputç³»ç»Ÿçš„åŒå­¦åº”è¯¥çŸ¥é“ï¼ŒTouchäº‹ä»¶æœ€ç»ˆæ˜¯é€šè¿‡serverç«¯çš„InputDispatcherçº¿ç¨‹ä¼ é€’ç»™Clientç«¯çš„UIçº¿ç¨‹çš„ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ˜¯ä¸€å¯¹Socketè¿›è¡Œé€šè®¯çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡PLT Hookï¼Œå»Hookè¿™å¯¹Socketçš„sendå’Œrecvæ–¹æ³•æ¥ç›‘æ§Touchäº‹ä»¶å•Šï¼æˆ‘ä»¬å…ˆæ‹ä¸€ä¸‹ä¸€æ¬¡Touchäº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ï¼š æˆ‘ä»¬é€šè¿‡PLT Hookï¼ŒæˆåŠŸhookåˆ°libinput.soä¸­çš„recvfromå’Œsendtoæ–¹æ³•ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„æ–¹æ³•è¿›è¡Œæ›¿æ¢ã€‚å½“è°ƒç”¨åˆ°äº†recvfromæ—¶ï¼Œè¯´æ˜æˆ‘ä»¬çš„åº”ç”¨æ¥æ”¶åˆ°äº†Touchäº‹ä»¶ï¼Œå½“è°ƒç”¨åˆ°äº†sendtoæ—¶ï¼Œè¯´æ˜è¿™ä¸ªTouchäº‹ä»¶å·²ç»è¢«æˆåŠŸæ¶ˆè´¹æ‰äº†ï¼Œå½“ä¸¤è€…çš„æ—¶é—´ç›¸å·®è¿‡å¤§æ—¶å³è¯´æ˜äº§ç”Ÿäº†ä¸€æ¬¡Touchäº‹ä»¶çš„å¡é¡¿ã€‚è¿™ç§æ–¹æ¡ˆç»è¿‡éªŒè¯æ˜¯å¯è¡Œçš„ï¼ A.3. ç›‘æ§SyncBarrieræ³„æ¼æœ€åï¼ŒSyncBarrieræ³„æ¼çš„é—®é¢˜ï¼Œæœ‰ä»€ä¹ˆå¥½åŠæ³•èƒ½ç›‘æ§åˆ°å—ï¼Ÿç›®å‰æˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯ä¸æ–­è½®è¯¢ä¸»çº¿ç¨‹Looperçš„MessageQueueçš„mMessage(ä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹å½“å‰æ­£åœ¨å¤„ç†çš„Message)ã€‚è€ŒSyncBarrieræœ¬èº«ä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„Messageï¼Œå…¶ç‰¹æ®Šåœ¨å®ƒçš„targetæ˜¯nullã€‚å¦‚æœæˆ‘ä»¬é€šè¿‡åå°„mMessageï¼Œå‘ç°å½“å‰çš„Messageçš„targetä¸ºnullï¼Œå¹¶ä¸”é€šè¿‡è¿™ä¸ªMessageçš„whenå‘ç°å…¶å·²ç»å­˜åœ¨å¾ˆä¹…äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆç†æ€€ç–‘äº§ç”Ÿäº†SyncBarrierçš„æ³„æ¼ï¼ˆä½†è¿˜ä¸èƒ½å®Œå…¨ç¡®å®šï¼Œå› ä¸ºå¦‚æœå½“æ—¶å› ä¸ºå…¶ä»–åŸå› å¯¼è‡´ä¸»çº¿ç¨‹å¡æ­»ï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´è¿™ç§ç°è±¡ï¼‰ï¼Œç„¶åå†å‘é€ä¸€ä¸ªåŒæ­¥æ¶ˆæ¯å’Œä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œå¦‚æœå¼‚æ­¥æ¶ˆæ¯è¢«å¤„ç†äº†ï¼Œä½†æ˜¯åŒæ­¥æ¶ˆæ¯ä¸€ç›´æ— æ³•è¢«å¤„ç†ï¼Œè¿™æ—¶å€™å°±è¯´æ˜äº§ç”Ÿäº†SyncBarrierçš„æ³„æ¼ã€‚å¦‚æœæ¿€è¿›ä¸€äº›ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ç”šè‡³å¯ä»¥åå°„è°ƒç”¨*MessageQueue*çš„*removeSyncBarrier*æ–¹æ³•ï¼Œæ‰‹åŠ¨æŠŠè¿™ä¸ªSyncBarrierç§»é™¤æ‰ï¼Œä»è€Œä»é”™è¯¯çŠ¶æ€ä¸­æ¢å¤ã€‚ åæ¶ˆæ¯æ˜¯ï¼Œè¿™ç§æ–¹æ¡ˆåªèƒ½ç›‘æ§åˆ°é—®é¢˜çš„äº§ç”Ÿï¼Œä¹Ÿå¯ä»¥ç›´æ¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯æ— æ³•æº¯æºé—®é¢˜ç©¶ç«Ÿæ˜¯å“ªä¸ªViewå¯¼è‡´çš„ã€‚å…¶å®æˆ‘ä»¬ä¹Ÿå°è¯•è¿‡ï¼Œé€šè¿‡æ’æ¡©æˆ–è€…Java hookçš„æ–¹æ³•ï¼Œç›‘æ§invalidateæ–¹æ³•æ˜¯å¦åœ¨éä¸»çº¿ç¨‹ä¸­è¿›è¡Œï¼Œä½†æ˜¯è€ƒè™‘åˆ°é£é™©ä»¥åŠå¯¹æ€§èƒ½å½±å“éƒ½æ¯”è¾ƒå¤§ï¼Œæ²¡æœ‰åœ¨çº¿ä¸Šä½¿ç”¨ã€‚æ‰€å¹¸ï¼Œé€šè¿‡ç›‘æ§å‘ç°ï¼Œè¿™ä¸ªé—®é¢˜å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œå‘ç”Ÿçš„æ¦‚ç‡å¹¶ä¸é«˜ã€‚å¦‚æœå‘ç°æŸä¸ªåœºæ™¯ä¸‹è¯¥é—®é¢˜ç¡®å®è¾ƒä¸ºä¸¥é‡ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ’æ¡©æˆ–è€…Java hookåœ¨æµ‹è¯•ç¯å¢ƒä¸‹debugè¯¥é—®é¢˜ã€‚ æ–¹æ¡ˆäºŒã€ä¾èµ– Choreographer æ¨¡å—ï¼Œç›‘æ§ç›¸é‚»ä¸¤æ¬¡ Vsync äº‹ä»¶é€šçŸ¥çš„æ—¶é—´å·®åˆ©ç”¨ç³»ç»Ÿ Choreographer æ¨¡å—ï¼Œå‘è¯¥æ¨¡å—æ³¨å†Œä¸€ä¸ª FrameCallback ç›‘å¬å¯¹è±¡ï¼ŒåŒæ—¶é€šè¿‡å¦å¤–ä¸€æ¡çº¿ç¨‹å¾ªç¯è®°å½•ä¸»çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼Œå¹¶åœ¨æ¯æ¬¡ Vsync äº‹ä»¶ doFrame é€šçŸ¥å›æ¥æ—¶ï¼Œå¾ªç¯æ³¨å†Œè¯¥ç›‘å¬å¯¹è±¡ï¼Œé—´æ¥ç»Ÿè®¡ä¸¤æ¬¡ Vsync äº‹ä»¶çš„æ—¶é—´é—´éš”ï¼Œå½“è¶…å‡ºé˜ˆå€¼æ—¶ï¼Œå–å‡ºè®°å½•çš„å †æ ˆè¿›è¡Œåˆ†æä¸ŠæŠ¥ã€‚ 12345678910Choreographer.getInstance().postFrameCallback(new Choreographer.FrameCallback() { @Override public void doFrame(long frameTimeNanos) { if(frameTimeNanos - mLastFrameNanos &gt; 100) { ... } mLastFrameNanos = frameTimeNanos; Choreographer.getInstance().postFrameCallback(this); }}); å¡é¡¿å‘ç”Ÿæ—¶å †æ ˆçš„æ”¶é›†BlocakCanaryï¼šåœ¨æ‰§è¡Œå‰åˆ©ç”¨å¦å¤–ä¸€æ¡çº¿ç¨‹ï¼Œé€šè¿‡ Thread#getStackTrace æ¥å£ï¼Œä»¥è½®è¯¢çš„æ–¹å¼è·å–ä¸»çº¿ç¨‹æ‰§è¡Œå †æ ˆä¿¡æ¯å¹¶è®°å½•èµ·æ¥ï¼ŒåŒæ—¶ç»Ÿè®¡æ¯æ¬¡ dispatchMessage æ–¹æ³•æ‰§è¡Œè€—æ—¶ï¼Œå½“è¶…å‡ºé˜ˆå€¼æ—¶ï¼Œå°†è¯¥æ¬¡è·å–çš„å †æ ˆè¿›è¡Œåˆ†æä¸ŠæŠ¥ï¼Œä»è€Œæ¥æ•æ‰å¡é¡¿ä¿¡æ¯ï¼Œå¦åˆ™ä¸¢å¼ƒæ­¤æ¬¡è®°å½•çš„å †æ ˆä¿¡æ¯ã€‚ Matrixï¼šæ ¹æ®ç¼–è¯‘æœŸæ’æ¡©è®°å½•å‡½æ•°è€—æ—¶ï¼Œåœ¨å¡é¡¿å‘ç”Ÿæ—¶è·å–ä¹‹å‰ä¸€æ®µæ—¶é—´çš„å‡½æ•°è¿›è¡Œå½’å †ï¼Œæ€§èƒ½æ›´ä½³ï¼Œ ä¸ä»…åœ¨ç¼–è¯‘æœŸæ—¶å¯¹ç‰¹æ®Šæ— éœ€æ’æ¡©å‡½æ•°æ’é™¤ï¼ˆæ–¹æ³•å­—èŠ‚ç ä¸­æ˜¯å¦åªåŒ…å«PUT/READ FIELDç­‰ç®€å•æŒ‡ä»¤ã€é»˜è®¤æˆ–åŒ¿åæ„é€ å‡½æ•°ï¼‰ã€æ’æ¡©å‡½æ•°ç”¨IDæ˜ å°„ è¿˜åœ¨è¿è¡ŒæœŸæ—¶ç”¨long[]æ•°ç»„è®°å½•å‡½æ•°idå’Œå‡½æ•°å‡½æ•°ï¼Œæå¤§ç¨‹åº¦çš„å‡å°‘å ç”¨å†…å­˜ã€å¦ä¸€ä¸ªçº¿ç¨‹æ¯5msæ›´æ–°æ—¶é—´å‡å°‘è°ƒç”¨System.nanoTimeçš„è€—æ—¶ Dokitï¼šä¹Ÿæ˜¯æ’æ¡©ï¼Œä½†ä¼˜åŒ–ä¸ç»†ã€‚ å‡½æ•°è€—æ—¶ç»Ÿè®¡ï¼šDoKitï¼šä¸Šé¢è¯´çš„æ’æ¡© Matrixï¼šä¸Šé¢è¯´çš„æ’æ¡© ä¸€äº›ç»†èŠ‚ä¸Šçš„åŒºåˆ«ï¼š","link":"/2021/10/19/APM/"},{"title":"bidi ç®—æ³•","text":"é€»è¾‘é¡ºåºä¸è§†è§‰é¡ºåº[I] é€»è¾‘é¡ºåºï¼šæŒ‡äººä»¬é˜…è¯»å’Œä»é”®ç›˜ä¸Šè¾“å…¥çš„æ–‡å­—é¡ºåºï¼Œæ–‡æœ¬åœ¨å†…å­˜é‡Œä¹Ÿæ˜¯ä»¥é€»è¾‘é¡ºåºå­˜å‚¨çš„ã€‚[II] è§†è§‰é¡ºåºï¼šåˆ™æ˜¯æ–‡æœ¬åœ¨å±å¹•æˆ–æ˜¯æ‰“å°æœºä¸­æ˜¾ç¤ºçš„é¡ºåºã€‚ å­—ç¬¦ç±»å‹[I] é˜¿æ‹‰ä¼¯æ–‡ã€å¸Œä¼¯æ¥æ–‡åŠå…¶æ´¾ç”Ÿè¯­è¨€çš„æœ¬åœŸå­—ç¬¦ä¸ºâ€œå¼ºRTLå­—ç¬¦â€[II] æˆ‘ä»¬é€šå¸¸è§åˆ°çš„ä¸­æ–‡ã€è‹±æ–‡ç­‰è¯­è¨€çš„æœ¬åœŸå­—ç¬¦ä¸ºâ€œå¼ºLTRå­—ç¬¦â€[III] æ¬§æ´²æ•°å­—ã€ä¸œæ–¹é˜¿æ‹‰ä¼¯ï¼Œæ•°å­—ï¼Œé€—å·ï¼Œå†’å·ï¼Œå¥å·ï¼ˆå³å°æ•°ç‚¹ï¼‰ç­‰ä¸ºâ€œå¼±å­—ç¬¦â€[IV] æ‹¬å·ï¼Œä¸­æ‹¬å·ï¼Œå°–æ‹¬å·ï¼Œç©ºæ ¼ç¬¦ï¼Œå¤§å¤šæ•°æ ‡ç‚¹ç¬¦å·ä¸ºâ€œä¸­æ€§å­—ç¬¦â€ è§„åˆ™bidiç®—æ³•å…·ä½“è§„åˆ™ååˆ†å¤æ‚ï¼Œ ä½†å…¶åŸºæœ¬è§„åˆ™åº”åšäº†è§£ï¼š æ–‡æœ¬çš„å…¨å±€æ–¹å‘å–å†³äºå¥å­ä¸­é¦–ä¸ªå¼ºå­—ç¬¦ ç¡®å®šäº†æ–‡æœ¬çš„å…¨å±€æ˜¾ç¤ºæ–¹å‘åï¼Œè‹¥å±€éƒ¨å‡ºç°äº†åå‘å­—ç¬¦ï¼Œåˆ™è¿ç»­çš„åå‘å­—ç¬¦ä¿æŒå…¶å±€éƒ¨é¡ºåºe.g: è‹¥åœ¨è¿ç»­çš„é˜¿æ‹‰ä¼¯æ–‡ä¸­å‡ºç°äº†ä¸­æ–‡å•è¯ï¼Œå¦‚â€å¥”è·‘å§â€ï¼Œåˆ™å…¶ä»æŒ‰ç…§ä¸­æ–‡é¡ºåºæ˜¾ç¤ºï¼Œä¸ä¼šæ˜¾ç¤ºä¸ºâ€å§è·‘å¥”â€ å¼±å­—ç¬¦ä¿æŒè‡ªèº«æ–¹å‘ æ²¡æœ‰è¢«å¼ºå­—ç¬¦åŒ…è£¹çš„ä¸­æ€§å­—ç¬¦è¿½éšå…¨å±€æ–¹å‘ æœ‰æ—¶ï¼Œè¿™ä¼šå¯¼è‡´æ„å¤–æ˜¾ç¤ºé”™è¯¯ï¼Œè¿™äº›é”™è¯¯å¯ä»¥é€šè¿‡ä½¿ç”¨â€œå®šå‘æ ¼å¼åŒ–å­—ç¬¦â€æ¥é¢„é˜²ã€‚ å‚è€ƒï¼šhttps://zhuanlan.zhihu.com/p/392525771 æ–¹å‘ä¸²æ–¹å‘ä¸²æ˜¯æŒ‡åœ¨ä¸€æ®µæ–‡å­—ä¸­å…·æœ‰ç›¸åŒæ–¹å‘æ€§çš„è¿ç»­å­—ç¬¦ï¼Œå¹¶ä¸”å…¶å‰åæ²¡æœ‰ç›¸åŒæ–¹å‘æ€§çš„å…¶å®ƒæ–¹å‘ä¸²ã€‚å¦‚ä»¥ä¸‹ä¾‹å­ï¼š 1234&lt;p&gt;phone:(415)555-3695&lt;/p&gt;&lt;p&gt;Ù‡Ø§ØªÙ:(415)555-3695&lt;/p&gt;&lt;p dir=&quot;ltr&quot;&gt;Ù‡Ø§ØªÙ:(415)555-3695&lt;/p&gt;&lt;p dir=&quot;rtl&quot;&gt;Ù‡Ø§ØªÙ:(415)555-3695&lt;/p&gt; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå«æœ‰é˜¿æ‹‰ä¼¯æ–‡å­—çš„æ®µè½ï¼Œç”µè¯å·ç å¥½åƒæŒ‰ç¬¦å·åˆ†å‰²åˆ†ç»„åæ–¹å‘æ˜¾ç¤ºäº†ã€‚ä½†å®é™…ä¸Šå¹¶éæ•…æ„è¿™æ ·è¾“å…¥çš„ï¼Œè€Œæ˜¯ç”µè¯å·ç è¾“å…¥å®Œæˆåå†åœ¨ç”µè¯å·ç å‰åŠ ä¸Šé˜¿æ‹‰ä¼¯æ–‡å­—ä¹‹åå°±å˜æˆè¿™æ ·äº†ã€‚ æ–‡ä¸­é¦–ä¸ªå¼ºç±»å‹å­—ç¬¦æ˜¯é˜¿æ‹‰ä¼¯æ–‡å­—ï¼Œå› æ­¤å…¶æ‰€åœ¨çš„æ–‡æœ¬åŒºåŸŸçš„å…¨å±€æ–¹å‘ä¸ºRTLï¼Œä½†å¼±ç±»å‹çš„æ•°å­—åˆ™ä¿æŒäº†åŸæ–¹å‘LTRï¼Œè€Œä¸­æ€§å­—ç¬¦â€ğŸ˜¦)-â€œæ²¡æœ‰è¢«å¼ºå­—ç¬¦åŒ…å›´åˆ™è·Ÿéšäº†å…¨å±€æ–¹å‘ã€‚ å¯¹äºä»¥ä¸Šå«æœ‰é˜¿æ‹‰ä¼¯æ–‡å­—çš„æ®µè½ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°6ä¸ªä¸åŒçš„æ–¹å‘ä¸²ã€‚æ­£æ˜¯å› ä¸ºä¸­æ€§ç¬¦å·è¢«å…¨å±€æ–¹å‘å½±å“ï¼Œä½¿å¾—åŸæœ¬çš„å·ç è¢«æ‹†åˆ†æˆä¸åŒçš„æ–¹å‘ä¸²ï¼Œä»è€Œé‡æ–°æ’åˆ—ã€‚ åŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/qq_40834030/article/details/105111971","link":"/2023/07/12/BIDI-%E7%AE%97%E6%B3%95/"},{"title":"AndroidVm","text":"çƒ­çŸ¥è¯†ï¼šjavaå¸¸è§çš„è™šæ‹Ÿæœºå¦‚Hotspotè™šæ‹Ÿæœºæ˜¯åŸºäºæ ˆç»“æ„çš„ï¼Œè€ŒDalvikæ˜¯åŸºäºå¯„å­˜å™¨ç»“æ„çš„ã€‚ å¸¸è§çš„javaè™šæ‹Ÿæœºè·‘çš„æ˜¯.classæ–‡ä»¶ï¼Œè€ŒDalvikè·‘çš„æ˜¯.dexï¼ˆ.odexï¼‰æ–‡ä»¶ã€‚ BoostMultiDexä¼˜åŒ–Dalvikè™šæ‹Ÿæœºå¤šDexå¯åŠ¨é€Ÿåº¦ Android 4.4 åŠä»¥ä¸‹é‡‡ç”¨çš„æ˜¯ Dalvik è™šæ‹Ÿæœºï¼Œåœ¨é€šå¸¸æƒ…å†µä¸‹ï¼ŒDalvik è™šæ‹Ÿæœºåªèƒ½æ‰§è¡Œåšè¿‡ OPT ä¼˜åŒ–çš„ DEX æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ ODEX æ–‡ä»¶ã€‚ ä¸€ä¸ª APK åœ¨å®‰è£…çš„æ—¶å€™ï¼Œå…¶ä¸­çš„classes.dexä¼šè‡ªåŠ¨åš ODEX ä¼˜åŒ–ï¼Œå¹¶åœ¨å¯åŠ¨çš„æ—¶å€™ç”±ç³»ç»Ÿé»˜è®¤ç›´æ¥åŠ è½½åˆ° APP çš„PathClassLoaderé‡Œé¢ï¼Œå› æ­¤classes.dexä¸­çš„ç±»è‚¯å®šèƒ½ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦æˆ‘ä»¬æ“å¿ƒã€‚ é™¤å®ƒä¹‹å¤–çš„ DEX æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯classes2.dexã€classes3.dexã€classes4.dexç­‰ DEX æ–‡ä»¶ï¼ˆè¿™é‡Œæˆ‘ä»¬ç»Ÿç§°ä¸º Secondary DEX æ–‡ä»¶ï¼‰ï¼Œè¿™äº›æ–‡ä»¶éƒ½éœ€è¦é æˆ‘ä»¬è‡ªå·±è¿›è¡Œ ODEX ä¼˜åŒ–ï¼Œå¹¶åŠ è½½åˆ° ClassLoader é‡Œï¼Œæ‰èƒ½æ­£å¸¸ä½¿ç”¨å…¶ä¸­çš„ç±»ã€‚å¦åˆ™åœ¨è®¿é—®è¿™äº›ç±»çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å‡ºClassNotFoundå¼‚å¸¸ä»è€Œå¼•èµ·å´©æºƒã€‚ å› æ­¤ï¼ŒAndroid å®˜æ–¹æ¨å‡ºäº† MultiDex æ–¹æ¡ˆã€‚åªéœ€è¦åœ¨ APP ç¨‹åºæ‰§è¡Œæœ€æ—©çš„å…¥å£ï¼Œä¹Ÿå°±æ˜¯Application.attachBaseContexté‡Œé¢ç›´æ¥è°ƒMultiDex.installï¼Œå®ƒä¼šè§£å¼€ APK åŒ…ï¼Œå¯¹ç¬¬äºŒä¸ªä»¥åçš„ DEX æ–‡ä»¶åš ODEX ä¼˜åŒ–å¹¶åŠ è½½ã€‚è¿™æ ·ï¼Œå¸¦æœ‰å¤šä¸ª DEX æ–‡ä»¶çš„ APK å°±å¯ä»¥é¡ºåˆ©æ‰§è¡Œä¸‹å»äº†ã€‚ è¿™ä¸ªæ“ä½œä¼šåœ¨ APP å®‰è£…æˆ–è€…æ›´æ–°åé¦–æ¬¡å†·å¯åŠ¨çš„æ—¶å€™å‘ç”Ÿï¼Œæ­£æ˜¯ç”±äºè¿™ä¸ªè¿‡ç¨‹è€—æ—¶æ¼«é•¿ï¼Œæ‰å¯¼è‡´äº†æˆ‘ä»¬æœ€å¼€å§‹æåˆ°çš„è€—æ—¶é»‘å±é—®é¢˜ã€‚ 12345if (Build.VERSION.SDK_INT &lt;= 19) { BoostMultiDex.install(this); } else { MultiDex.install(this); } Tips: é™¤ä»¥ 2 ï¼Œå³ç§» 1ï¼Œè°æ›´å¥½Aï¼šæ²¡åŒºåˆ«ï¼ˆARTæœ‰ä¼˜åŒ–ï¼‰ ART ä½¿ç”¨å·¦ç§»/å³ç§»é‡å†™äº†äºŒæ¬¡å¹‚çš„ä¹˜æ³•/é™¤æ³•(å¤„ç†è´Ÿæ•°æ—¶ä¼šæœ‰å¢åŠ é¢å¤–çš„æŒ‡ä»¤)ã€‚ å³ç§»å’ŒäºŒæ¬¡å¹‚é™¤æ³•ä¹‹é—´å¹¶æ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½å·®è·ã€‚ ç§»ä½å’Œä¹˜é™¤æ³•çš„ Dalvik å­—èŠ‚ç å¤§å°æ˜¯ä¸€æ ·çš„ã€‚ æ²¡æœ‰äººä¼˜åŒ–äº†æ— ç¬¦å·é™¤æ³•(è‡³å°‘ç°åœ¨æ²¡æœ‰)ï¼Œä½†æ˜¯ä½ åº”è¯¥ä¹Ÿæ²¡æœ‰ç”¨è¿‡ã€‚","link":"/2021/04/10/AndroidVm/"},{"title":"ByteCode","text":"ç¾å›¢æ–‡ç«  javaå­—èŠ‚ç æ“ä½œç æ‰‹å†Œ","link":"/2021/04/10/ByteCode/"},{"title":"Animation","text":"AndroidåŠ¨ç”»åˆ†ä¸‰ç§ï¼šViewåŠ¨ç”»ã€å¸§åŠ¨ç”»ã€å±æ€§åŠ¨ç”» æ˜¯çš„ï¼Œ checkï¼Œ âˆš ViewåŠ¨ç”»ViewåŠ¨ç”»å®šä¹‰äº†æ¸å˜Alphaã€æ—‹è½¬Rotateã€ç¼©æ”¾Scaleã€å¹³ç§»Translateå››ç§åŸºæœ¬åŠ¨ç”»ï¼Œå¹¶ä¸”é€šè¿‡è¿™å››ç§åŸºæœ¬åŠ¨ç”»çš„ç»„åˆä½¿ç”¨ï¼Œå¯ä»¥å®ç°å¤šç§äº¤äº’æ•ˆæœã€‚ViewåŠ¨ç”»ä½¿ç”¨éå¸¸ç®€å•ï¼Œä¸ä»…å¯ä»¥é€šè¿‡XMLæ–‡ä»¶æ¥å®šä¹‰åŠ¨ç”»ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡Javaä»£ç æ¥å®ç°åŠ¨ç”»è¿‡ç¨‹ã€‚ åŸç†ï¼š é¦–å…ˆviewçš„ç»˜åˆ¶æ˜¯ drawBackground() -&gt; onDraw() -&gt; dispatchDraw() -&gt; onDrawForeground() çš„é¡ºåºï¼Œ //android/view/View.javaä¸­çš„boolean draw(Canvas canvas, ViewGroup parent, long drawingTime)æ–¹æ³• View.setAnimationä¼šå°†æ—‹è½¬ã€ç¼©æ”¾ã€å¹³ç§»ç­‰åŠ¨ç”»å­˜ä¸‹æ¥ï¼ŒåŠ¨ç”»å¯åŠ¨åé€šè¿‡invalidate() ï¼Œæ¯ä¸€å¸§ä¸­åœ¨drawçš„æ—¶å€™é€šè¿‡canvas.translateã€canvas.scaleã€cavas.setLayerAlphaç­‰æ–¹å¼ï¼Œæ‰§è¡ŒåŠ¨ç”»ã€‚ æ•…è€ŒviewåŠ¨ç”»åªä¼šå½±å“viewçš„è§†è§‰æ•ˆæœï¼Œè€Œä¸å½±å“èµ·äº‹ä»¶å“åº”åŒºåŸŸï¼Œå› ä¸ºåªæœ‰drawä¸­å¤„ç†äº†ï¼Œmeasureå’Œlayoutéƒ½æ²¡åŠ¨ Xmlæ–‡ä»¶å®ç°é€šè¿‡xmlæ¥å®šä¹‰ViewåŠ¨ç”»æ¶‰åŠåˆ°ä¸€äº›å…¬æœ‰çš„å±æ€§ï¼ˆåœ¨AndroidStudioä¸Šä¸èƒ½æç¤ºï¼‰ï¼š 1234567android:duration åŠ¨ç”»æŒç»­æ—¶é—´android:fillAfter ä¸ºtrueåŠ¨ç”»ç»“æŸæ—¶ï¼ŒViewå°†ä¿æŒåŠ¨ç”»ç»“æŸæ—¶çš„çŠ¶æ€android:fillBefore ä¸ºtrueåŠ¨ç”»ç»“æŸæ—¶ï¼ŒViewå°†è¿˜åŸåˆ°å¼€å§‹å¼€å§‹æ—¶çš„çŠ¶æ€android:repeatCount åŠ¨ç”»é‡å¤æ‰§è¡Œçš„æ¬¡æ•°android:repeatMode åŠ¨ç”»é‡å¤æ¨¡å¼ ï¼Œé‡å¤æ’­æ”¾æ—¶restarté‡å¤´å¼€å§‹ï¼Œreverseé‡å¤æ’­æ”¾æ—¶å€’å™å›æ”¾ï¼Œè¯¥å±æ€§éœ€è¦å’Œandroid:repeatCountä¸€èµ·ä½¿ç”¨android:repeatCount é»˜è®¤æ˜¯0ï¼Œ-1æ˜¯æ— é™å¾ªç¯android:interpolator æ’å€¼å™¨ï¼Œç›¸å½“äºå˜é€Ÿå™¨ï¼Œæ”¹å˜åŠ¨ç”»çš„ä¸åŒé˜¶æ®µçš„æ‰§è¡Œé€Ÿåº¦ è¿™äº›å±æ€§æ˜¯ä»Animationä¸­ç»§æ‰¿ä¸‹æ¥çš„ï¼Œåœ¨alphaã€rotateã€scaleã€translateæ ‡ç­¾ä¸­éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚åˆ©ç”¨xmlæ–‡ä»¶å®šä¹‰ViewåŠ¨ç”»éœ€è¦åœ¨å·¥ç¨‹çš„resç›®å½•ä¸‹åˆ›å»ºanimæ–‡ä»¶å¤¹ï¼Œæ‰€æœ‰çš„xmlå®šä¹‰çš„ViewåŠ¨ç”»éƒ½è¦æ”¾åœ¨animç›®å½•ä¸‹ã€‚å…¶ä¸­æ ‡ç­¾ translateã€scaleã€alphaã€rotateï¼Œå°±æ˜¯å¯¹åº”å››ç§åŠ¨ç”»ã€‚setæ ‡ç­¾æ˜¯åŠ¨ç”»é›†åˆï¼Œå¯¹åº”AnimationSetç±»ï¼Œæœ‰å¤šä¸ªåŠ¨ç”»æ„æˆã€‚ å…¶ä¸­android:durationæ˜¯æŒ‡åŠ¨ç”»æ—¶é—´ï¼ŒfillAfterä¸ºtrueæ˜¯åŠ¨ç”»ç»“æŸåä¿æŒï¼Œfalseä¼šå›åˆ°åˆå§‹çŠ¶æ€ã€‚interpolatoræ˜¯æŒ‡åŠ¨ç”»çš„æ‰§è¡Œé€Ÿåº¦ï¼Œé»˜è®¤æ˜¯å…ˆåŠ é€Ÿåå‡é€Ÿã€‚å…¶ä»–æ ‡ç­¾åŠå±æ€§è¾ƒç®€å•å¯è‡ªè¡Œç ”ç©¶éªŒè¯ã€‚ 1234567891011121314151617181920212223242526&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;set xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:duration=&quot;5000&quot; android:fillAfter=&quot;true&quot; android:interpolator=&quot;@android:anim/accelerate_decelerate_interpolator&quot;&gt; &lt;!--seté‡Œé¢çš„durationå¦‚æœæœ‰å€¼ï¼Œä¼šè¦†ç›–å­æ ‡ç­¾çš„duration--&gt; &lt;translate android:duration=&quot;1000&quot; android:fromXDelta=&quot;0&quot; android:toXDelta=&quot;400&quot; /&gt; &lt;scale android:duration=&quot;2000&quot; android:fromXScale=&quot;0.5&quot; android:fromYScale=&quot;0.5&quot; android:toXScale=&quot;1&quot; android:toYScale=&quot;1&quot; /&gt; &lt;alpha android:duration=&quot;3000&quot; android:fromAlpha=&quot;0.2&quot; android:toAlpha=&quot;1&quot; /&gt; &lt;rotate android:fromDegrees=&quot;0&quot; android:toDegrees=&quot;90&quot; /&gt;&lt;/set&gt; å®šä¹‰å¥½åŠ¨ç”»åï¼Œä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œè°ƒç”¨viewçš„startAnimationæ–¹æ³•å³å¯ã€‚ 123//viewåŠ¨ç”»ä½¿ç”¨ï¼Œæ–¹å¼ä¸€ï¼šxmlï¼Œå»ºè®®ä½¿ç”¨ã€‚ Animation animation = AnimationUtils.loadAnimation(this, R.anim.animation_test); textView1.startAnimation(animation); rotateã€scaleåŠ¨ç”»çš„android:pivotXå’Œandroid:pivotYå±æ€§ã€translateåŠ¨ç”»çš„android:toXDeltaå’Œandroid:toYDeltaå±æ€§çš„å–å€¼éƒ½å¯ä»¥æ˜¯éƒ½å¯ä»¥æ•°å€¼ã€ç™¾åˆ†æ•°ã€ç™¾åˆ†æ•°pï¼Œæ¯”å¦‚ï¼š50ã€50%ã€50%pï¼Œä»–ä»¬å–å€¼çš„ä»£è¡¨çš„æ„ä¹‰å„ä¸ç›¸åŒï¼š50è¡¨ç¤ºä»¥Viewå·¦ä¸Šè§’ä¸ºåŸç‚¹æ²¿åæ ‡è½´æ­£æ–¹å‘(xè½´å‘å³ï¼Œyè½´å‘ä¸‹)åç§»50pxçš„ä½ç½®ï¼›50%è¡¨ç¤ºä»¥Viewå·¦ä¸Šè§’ä¸ºåŸç‚¹æ²¿åæ ‡è½´æ­£æ–¹å‘(xè½´å‘å³ï¼Œyè½´å‘ä¸‹)åç§»Viewå®½åº¦æˆ–é«˜åº¦çš„50%å¤„çš„ä½ç½®ï¼›50%pè¡¨ç¤ºä»¥Viewå·¦ä¸Šè§’ä¸ºåŸç‚¹æ²¿åæ ‡è½´æ­£æ–¹å‘(xè½´å‘å³ï¼Œyè½´å‘ä¸‹)åç§»çˆ¶æ§ä»¶å®½åº¦æˆ–é«˜åº¦çš„50%å¤„çš„ä½ç½®ï¼ˆpè¡¨ç¤ºç›¸å¯¹äºParentViewçš„ä½ç½®ï¼‰ã€‚ â€œ50â€ï¼š ï¼› â€œ50%â€ï¼› â€œ50%pâ€ ä»£ç åŠ¨æ€å®ç°åœ¨å¹³å¸¸çš„ä¸šåŠ¡é€»è¾‘ä¸­ä¹Ÿå¯ä»¥ç›´æ¥ç”¨Javaä»£ç æ¥å®ç°VeiwåŠ¨ç”»ï¼ŒAndroidç³»ç»Ÿç»™æˆ‘ä»¬æä¾›äº†AlphaAnimationã€RotateAnimationã€ScaleAnimationã€TranslateAnimationå››ä¸ªåŠ¨ç”»ç±»åˆ†åˆ«æ¥å®ç°Viewçš„æ¸å˜ã€æ—‹è½¬ã€ç¼©æ”¾ã€å¹³ç§»åŠ¨ç”»ã€‚ 1234567891011121314151617181920212223242526272829//viewåŠ¨ç”»ä½¿ç”¨ï¼Œæ–¹å¼äºŒï¼šnew åŠ¨ç”»å¯¹è±¡ AnimationSet animationSet = new AnimationSet(false); animationSet.setDuration(3000); animationSet.addAnimation(new TranslateAnimation(0, 100, 0, 0)); animationSet.addAnimation(new ScaleAnimation(0.1f, 1f, 0.1f, 1f)); animationSet.setFillAfter(true); textView2.startAnimation(animationSet); //viewåŠ¨ç”»ä½¿ç”¨ï¼Œæ–¹å¼äºŒï¼šnew åŠ¨ç”»å¯¹è±¡,ä½¿ç”¨setAnimation AnimationSet animationSet2 = new AnimationSet(false); animationSet2.setDuration(3000); animationSet2.addAnimation(new TranslateAnimation(0, 100, 0, 0)); animationSet2.addAnimation(new ScaleAnimation(0.1f, 1f, 0.1f, 1f)); animationSet2.setFillAfter(true); animationSet2.setAnimationListener(new Animation.AnimationListener() { @Override public void onAnimationStart(Animation animation) { } @Override public void onAnimationEnd(Animation animation) { MyToast.showMsg(AnimationTestActivity.this, &quot;ViewåŠ¨ç”»ï¼šä»£ç  setï¼šViewåŠ¨ç”»ç»“æŸ~&quot;); } @Override public void onAnimationRepeat(Animation animation) { } }); textView3.setAnimation(animationSet2); æ³¨æ„ç‚¹ï¼š startAnimationæ–¹æ³•æ˜¯ç«‹åˆ»æ’­æ”¾åŠ¨ç”»ï¼›setAnimationæ˜¯è®¾ç½®è¦æ’­æ”¾çš„ä¸‹ä¸€ä¸ªåŠ¨ç”»ã€‚ setAnimationListenerå¯ä»¥ç›‘å¬åŠ¨ç”»çš„å¼€å§‹ã€ç»“æŸã€é‡å¤ã€‚ è‡ªå®šä¹‰åŠ¨ç”»[3Dæ—‹è½¬åŠ¨ç”»] Like:ProgressBarAnimation 12345678class ProgressBarAnimation(private val progressBar: ProgressBar, private val from: Int, private val to: Int) : Animation() { override fun applyTransformation(interpolatedTime: Float, t: Transformation?) { super.applyTransformation(interpolatedTime, t) val value = from + (to - from) * interpolatedTime progressBar.progress = value.toInt() }} å¸ƒå±€åŠ¨ç”»LayoutTransitionä½¿ç”¨LayoutAnimationç»™ViewGroupæŒ‡å®šchildçš„å‡ºåœºåŠ¨ç”»ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š 1.å…ˆç”¨xmlå®šä¹‰æ ‡ç­¾LayoutAnimationï¼š android:animationè®¾ç½®childçš„å‡ºåœºåŠ¨ç”» android:animationOrderè®¾ç½®childçš„å‡ºåœºé¡ºåºï¼Œnormalå°±æ˜¯é¡ºåº delayæ˜¯æŒ‡ï¼šæ¯ä¸ªchildå»¶è¿Ÿï¼ˆåœ¨android:animationä¸­æŒ‡å®šçš„åŠ¨ç”»æ—¶é—´ï¼‰0.8å€åæ’­æ”¾åŠ¨ç”»ã€‚å¦‚æœandroid:animationä¸­çš„åŠ¨ç”»æ—¶é—´æ˜¯100msï¼Œé‚£ä¹ˆæ¯ä¸ªchildéƒ½ä¼šå»¶è¿Ÿ800msåæ’­æ”¾åŠ¨ç”»ã€‚ å¦‚æœä¸è®¾ç½®delayï¼Œé‚£ä¹ˆæ‰€æœ‰childåŒæ—¶æ‰§è¡ŒåŠ¨ç”»ã€‚ 12345678910111213141516&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;layoutAnimation xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:animation=&quot;@anim/enter_from_left_for_child_of_group&quot; android:animationOrder=&quot;normal&quot; android:delay=&quot;0.8&quot;&gt;&lt;/layoutAnimation&gt;R.anim.enter_from_left_for_child_of_group&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;set xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt; &lt;translate android:duration=&quot;1000&quot; android:fromXDelta=&quot;-100%p&quot; android:toXDelta=&quot;0&quot;/&gt;&lt;/set&gt; 2.æŠŠLayoutAnimationè®¾ç½®ç»™ViewGroup 1234567891011121314151617181920212223&lt;LinearLayout android:id=&quot;@+id/ll_layout_animation&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;wrap_content&quot; android:orientation=&quot;horizontal&quot; android:layoutAnimation=&quot;@anim/layout_animation&quot;&gt; &lt;TextView android:layout_width=&quot;50dp&quot; android:layout_height=&quot;wrap_content&quot; android:textColor=&quot;#ff0000&quot; android:text=&quot;å‘µå‘µå‘µ&quot;/&gt; &lt;TextView android:layout_width=&quot;60dp&quot; android:layout_height=&quot;wrap_content&quot; android:textColor=&quot;#ff0000&quot; android:text=&quot;qq&quot; android:background=&quot;@color/colorPrimary&quot;/&gt; &lt;TextView android:layout_width=&quot;30dp&quot; android:layout_height=&quot;wrap_content&quot; android:textColor=&quot;#ff0000&quot; android:text=&quot;å•Šå•Š&quot;/&gt;&lt;/LinearLayout&gt; é™¤äº†xmlï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨LayoutAnimationController æŒ‡å®šï¼š 123456//ä»£ç è®¾ç½®LayoutAnimationï¼Œå®ç°ViewGroupçš„childçš„å‡ºåœºåŠ¨ç”»Animation enterAnim = AnimationUtils.loadAnimation(this, R.anim.enter_from_left_for_child_of_group);LayoutAnimationController controller = new LayoutAnimationController(enterAnim);controller.setDelay(0.8f);controller.setOrder(LayoutAnimationController.ORDER_NORMAL);llLayoutAnimation.setLayoutAnimation(controller); animateLayoutChangesç”¨å¤„åŠåŸç†1android:animateLayoutChanges=&quot;true&quot; animateLayoutChangesçš„å®é™…å®ç°å°±æ˜¯LayoutTransitionï¼Œ android.view.ViewGroup.java Dialog/Activityè½¬åœºåŠ¨ç”»Activityè½¬åœºoverridePendingTransition 123456789class XXActivity : Activity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContentView(R.layout.activity_checkout_rec) overridePendingTransition( R.anim.slide_in_down, R.anim.slide_in_down ) }} 1234567&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;set xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:interpolator=&quot;@android:anim/decelerate_interpolator&quot; &gt; &lt;translate android:duration=&quot;200&quot; android:fromYDelta=&quot;100%p&quot; android:toYDelta=&quot;0%p&quot; /&gt;&lt;/set&gt; 1234567&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;set xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:interpolator=&quot;@android:anim/decelerate_interpolator&quot; &gt; &lt;translate android:duration=&quot;200&quot; android:fromYDelta=&quot;0%p&quot; android:toYDelta=&quot;100%p&quot; /&gt;&lt;/set&gt; Dialogè½¬åœºWindow?.setWindowAnimatinos() 123456789class XXDialog(context: Context, val anim: PointBean.PointAnimation) :Dialog(context) { init { setContentView(R.layout.threshold_dialog) setCanceledOnTouchOutside(true) window?.setGravity(Gravity.CENTER) window?.setLayout(MATCH_PARENT, AndroidUtil.getScreenWidth(context)) window?.setBackgroundDrawable(ColorDrawable(Color.TRANSPARENT)); window?.setWindowAnimations(R.style.XXDialogAnim)} 1234&lt;style name=&quot;XXDialogAnim&quot; mce_bogus=&quot;1&quot; parent=&quot;android:Animation&quot;&gt; &lt;item name=&quot;android:windowEnterAnimation&quot;&gt;@anim/cart_threshold_dialog_enter_anim&lt;/item&gt; &lt;item name=&quot;android:windowExitAnimation&quot;&gt;@anim/cart_threshold_dialog_exit_anim&lt;/item&gt; &lt;/style&gt; å±æ€§åŠ¨ç”»å±æ€§åŠ¨ç”»æœ¬è´¨ä¸Šæ˜¯ ä½¿ç”¨åå°„è°ƒç”¨å¯¹è±¡çš„setXX()ã€getXX()æ–¹æ³•ï¼Œæ ¹æ®æ’å€¼å™¨çš„å€¼å˜åŒ–æ›²çº¿ä¿®æ”¹å¯¹è±¡å±æ€§ï¼Œæ‰€ä»¥æ˜¯è§†å›¾å®å®åœ¨åœ¨çš„ä½ç½®ã€å°ºå¯¸ç­‰å±æ€§å‘ç”Ÿå˜åŒ–å¹¶ä¼šè§¦å‘measureã€layoutï¼Œå› æ­¤ç‚¹å‡»åŒºåŸŸä¹Ÿå°±å‘ç”Ÿå˜åŒ–ã€‚ å±æ€§åŠ¨ç”»å¯å¯¹ä»»æ„å¯¹è±¡åšåŠ¨ç”»ï¼Œä¸ä»…ä»…æ˜¯Viewã€‚é»˜è®¤åŠ¨ç”»æ—¶é—´æ˜¯300msï¼Œ10ms/å¸§ã€‚å…·ä½“ç†è§£å°±æ˜¯ï¼šå¯åœ¨ç»™å®šçš„æ—¶é—´é—´éš”å†… å®ç° å¯¹è±¡çš„æŸå±æ€§å€¼ ä» value1 åˆ° value2çš„æ”¹å˜ã€‚ ä½¿ç”¨å¾ˆç®€å•ï¼Œå¯ä»¥ç›´æ¥ä»£ç å®ç°ï¼ˆæ¨èï¼‰ï¼Œä¹Ÿå¯xmlå®ç°ï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657//å±æ€§åŠ¨ç”»ä½¿ç”¨ï¼Œæ–¹å¼ä¸€ï¼šä»£ç ï¼Œå»ºè®®ä½¿ç”¨ã€‚ æ¨ªç§» ObjectAnimator translationX = ObjectAnimator .ofFloat(textView6, &quot;translationX&quot;, 0, 200) .setDuration(1000); translationX.setInterpolator(new LinearInterpolator()); setAnimatorListener(translationX); //å±æ€§åŠ¨ç”»ä½¿ç”¨ï¼Œæ–¹å¼äºŒï¼šxmlã€‚ ç«–ç§» Animator animatorUpAndDown = AnimatorInflater.loadAnimator(this, R.animator.animator_test); animatorUpAndDown.setTarget(textView6); //æ–‡å­—é¢œè‰²å˜åŒ– ObjectAnimator textColor = ObjectAnimator .ofInt(textView6, &quot;textColor&quot;, 0xffff0000, 0xff00ffff) .setDuration(1000); textColor.setRepeatCount(ValueAnimator.INFINITE); textColor.setRepeatMode(ValueAnimator.REVERSE); //æ³¨æ„ï¼Œè¿™é‡Œå¦‚æœä¸è®¾ç½® é‚£ä¹ˆé¢œè‰²å°±æ˜¯è·³è·ƒçš„ï¼Œè®¾ç½®ArgbEvaluator å°±æ˜¯è¿ç»­è¿‡åº¦çš„é¢œè‰²å˜åŒ– textColor.setEvaluator(new ArgbEvaluator()); //animatorSet mAnimatorSet = new AnimatorSet(); mAnimatorSet .play(animatorUpAndDown) .with(textColor) .after(translationX); mAnimatorSet.start(); /** * è®¾ç½®å±æ€§åŠ¨ç”»çš„ç›‘å¬ * @param translationX */ private void setAnimatorListener(ObjectAnimator translationX) { translationX.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() { @Override public void onAnimationUpdate(ValueAnimator animation) { //æ¯æ’­æ”¾ä¸€å¸§ï¼Œéƒ½ä¼šè°ƒç”¨ } }); if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) { translationX.addPauseListener(new AnimatorListenerAdapter() { @Override public void onAnimationResume(Animator animation) { super.onAnimationResume(animation); } }); } translationX.addListener(new AnimatorListenerAdapter() { @Override public void onAnimationEnd(Animator animation) { super.onAnimationEnd(animation); } }); } R.animator.animator_testï¼Œæ˜¯æ”¾åœ¨res/animatorä¸­ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;!--å±æ€§åŠ¨ç”»test,ä¸€èˆ¬å»ºè®®é‡‡ç”¨ä»£ç å®ç°ï¼Œä¸ç”¨xml--&gt;&lt;set xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:ordering=&quot;sequentially&quot;&gt; &lt;!--repeatCountï¼šé»˜è®¤æ˜¯0ï¼Œ-1æ˜¯æ— é™å¾ªç¯--&gt; &lt;!--repeatModeï¼šé‡å¤æ¨¡å¼ï¼šrestart-ä»å¤´æ¥ä¸€éã€reverse-åå‘æ¥ä¸€é--&gt; &lt;!--valueTypeï¼šæŒ‡å®špropertyNameçš„ç±»å‹å¯é€‰intTypeã€floatType--&gt; &lt;!--android:pathData=&quot;&quot; android:propertyXName=&quot;&quot; android:propertyYName=&quot;&quot;--&gt; &lt;objectAnimator android:propertyName=&quot;translationY&quot; android:duration=&quot;1000&quot; android:valueFrom=&quot;0&quot; android:valueTo=&quot;120&quot; android:startOffset=&quot;0&quot; android:repeatCount=&quot;0&quot; android:repeatMode=&quot;reverse&quot; android:valueType=&quot;floatType&quot; android:interpolator=&quot;@android:interpolator/accelerate_decelerate&quot; /&gt; &lt;!--animatorå¯¹ç”¨vueAnimatorï¼Œæ¯”objectAnimatorå°‘äº†propertyName--&gt; &lt;!--&lt;animator--&gt; &lt;!--android:duration=&quot;2000&quot;--&gt; &lt;!--android:valueFrom=&quot;&quot;--&gt; &lt;!--android:valueTo=&quot;&quot;--&gt; &lt;!--android:startOffset=&quot;&quot;--&gt; &lt;!--android:repeatCount=&quot;&quot;--&gt; &lt;!--android:repeatMode=&quot;&quot;--&gt; &lt;!--android:valueType=&quot;&quot;--&gt; &lt;!--android:interpolator=&quot;&quot;--&gt; &lt;!--android:pathData=&quot;&quot;--&gt; &lt;!--android:propertyXName=&quot;&quot;--&gt; &lt;!--android:propertyYName=&quot;&quot;/&gt;--&gt;&lt;/set&gt; translationXæ˜¯å®ç°æ¨ªç§»ï¼ŒanimatorUpAndDownæ˜¯å®ç°ç«–ç§»ã€textColoræ˜¯å®ç°æ–‡å­—é¢œè‰²å˜åŒ–ã€‚å…¶ä¸­animatorUpAndDownæ˜¯ä½¿ç”¨xmlå®šä¹‰ï¼Œæ ‡ç­¾å«ä¹‰ä¹Ÿå¾ˆå¥½ç†è§£ã€‚ æœ€åä½¿ç”¨AnimatorSetçš„playã€withã€after å®ç° å…ˆæ¨ªç§»ï¼Œç„¶å ç«–ç§»å’Œé¢œè‰²å˜åŒ– åŒæ—¶çš„åŠ¨ç”»é›†åˆæ•ˆæœã€‚ æ³¨æ„ç‚¹ï¼š å…³äºViewåŠ¨ç”»å’Œå±æ€§åŠ¨ç”»çš„å¹³ç§»ï¼Œå±æ€§åŠ¨ç”»æ”¹å˜å±æ€§å€¼setTranslationX çš„è§†å›¾æ•ˆæœåƒviewåŠ¨ç”»çš„å¹³ç§»ä¸€æ ·ï¼Œéƒ½æ˜¯viewå®é™…çš„layoutä½ç½®æ²¡å˜ï¼Œåªæ”¹å˜äº†è§†å›¾ä½ç½®ï¼›ä¸åŒç‚¹æ˜¯å±æ€§åŠ¨ç”» ç»™è§¦æ‘¸ç‚¹ç”Ÿæ•ˆåŒºåŸŸå¢åŠ äº†ä½ç§»ï¼ˆè€ŒviewåŠ¨ç”»ä»…æ”¹å˜äº†è§†å›¾ä½ç½®ï¼‰ã€‚ æ’å€¼å™¨ï¼šInterpolatorï¼Œæ ¹æ® æ—¶é—´æµé€çš„ç™¾åˆ†æ¯”ï¼Œè®¡ç®—å½“å‰å±æ€§å€¼æ”¹å˜çš„ç™¾åˆ†æ¯”ã€‚ ä¾‹å¦‚durationæ˜¯1000ï¼Œstartåè¿‡äº†200ï¼Œé‚£ä¹ˆæ—¶é—´ç™¾åˆ†æ¯”æ˜¯0.2ï¼Œé‚£ä¹ˆå¦‚æœå·®å€¼å™¨æ˜¯LinearInterpolatorçº¿æ€§å·®å€¼å™¨ï¼Œé‚£ä¹ˆå±æ€§å€¼æ”¹å˜çš„ç™¾åˆ†æ¯”ä¹Ÿæ˜¯0.2 ä¼°å€¼å™¨ï¼šEvaluatorï¼Œå°±æ˜¯æ ¹æ® å·®å€¼å™¨è·å–çš„ å±æ€§å€¼ç™¾åˆ†æ¯”ï¼Œè®¡ç®—æ”¹å˜åçš„å±æ€§å€¼ã€‚ ofIntã€onFloatå†…éƒ¨ä¼šè‡ªåŠ¨è®¾ç½®IntEvaluatorã€FloatEvaluatorã€‚å¦‚æœä½¿ç”¨ofIntä¸”æ˜¯é¢œè‰²ç›¸å…³çš„å±æ€§ï¼Œå°±è¦è®¾ç½®ArgbEvaluatorã€‚ ä¸Šé¢ä¾‹å­ä¸­ æ–‡å­—é¢œè‰²å˜åŒ–åŠ¨ç”» è®¾ç½®äº†ArgbEvaluatorï¼štextColor.setEvaluator(new ArgbEvaluator())ã€‚ åŠ¨ç”»ç›‘å¬ï¼šä¸»è¦æ˜¯ä¸¤ä¸ªç›‘å¬æ¥å£ï¼ŒAnimatorUpdateListenerã€AnimatorListenerAdapterã€‚AnimatorUpdateListenerçš„å›è°ƒæ–¹æ³•åœ¨æ¯å¸§æ›´æ–°æ—¶éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡ï¼›AnimatorListenerAdapterå¯ä»¥ç›‘å¬å¼€å§‹ã€ç»“æŸã€æš‚åœã€ç»§ç»­ã€é‡å¤ã€å–æ¶ˆï¼Œé‡å†™ä½ è¦å…³æ³¨çš„æ–¹æ³•å³å¯ã€‚ å¯¹ä»»æ„å±æ€§åšåŠ¨ç”»ä¸€ä¸ªé—®é¢˜ï¼Œé’ˆå¯¹ä¸‹é¢çš„Buttonï¼Œå¦‚ä½•å®ç° çš„å®½åº¦é€æ¸æ‹‰é•¿çš„åŠ¨ç”»ï¼Œå³æ–‡å­—ä¸å˜ï¼Œä»…æ‹‰é•¿èƒŒæ™¯å®½åº¦ï¼Ÿ 12345&lt;Button android:id=&quot;@+id/button_animator_test&quot; android:layout_width=&quot;180dp&quot; android:layout_height=&quot;wrap_content&quot; android:text=&quot;ä»»æ„å±æ€§åŠ¨ç”»-å®½åº¦æ‹‰é•¿&quot;/&gt; é¦–å…ˆï¼ŒViewåŠ¨ç”»çš„ScaleAnimationæ˜¯æ— æ³•å®ç°çš„ï¼Œå› ä¸ºviewçš„scaleæ˜¯æŠŠviewçš„è§†å›¾æ”¾å¤§ï¼Œè¿™æ ·æ–‡å­—ä¹Ÿä¼šæ‹‰é•¿å˜å½¢ã€‚é‚£ä¹ˆå±æ€§åŠ¨ç”»å‘¢ï¼Ÿè¯•è¯•~ 123ObjectAnimator width1 = ObjectAnimator.ofInt(button, &quot;width&quot;, 1000);width1.setDuration(2000);width1.start(); ä½†æ˜¯å‘ç°ï¼Œæ²¡æœ‰æ•ˆæœï¼è¿™æ˜¯ä¸ºå•¥å‘¢ï¼Ÿè§£é‡Šå¦‚ä¸‹. å¯¹object çš„ä»»æ„å±æ€§åšåŠ¨ç”» è¦æ±‚ä¸¤ä¸ªæ¡ä»¶ï¼š objectæœ‰ å¯¹åº”å±æ€§ çš„setæ–¹æ³•ï¼ŒåŠ¨ç”»ä¸­æ²¡è®¾ç½®åˆå§‹å€¼ è¿˜è¦æœ‰getæ–¹æ³•ï¼Œç³»ç»Ÿè¦å»å–åˆå§‹å€¼ï¼ˆä¸æ»¡è¶³åˆ™ä¼šcrashï¼‰ã€‚ setæ–¹æ³•è¦å¯¹objectæœ‰æ‰€æ”¹å˜ï¼Œå¦‚UIçš„å˜åŒ–ã€‚ä¸æ»¡è¶³åˆ™ä¼šæ²¡æœ‰åŠ¨ç”»æ•ˆæœ ä¸Šé¢Buttonæ²¡æœ‰åŠ¨ç”»æ•ˆæœï¼Œå°±æ˜¯æ²¡æœ‰æ»¡è¶³ç¬¬äºŒæ¡ã€‚çœ‹ä¸‹Buttonçš„setWidthæ–¹æ³•ï¼š 123456public void setWidth(int pixels) { mMaxWidth = mMinWidth = pixels; mMaxWidthMode = mMinWidthMode = PIXELS; requestLayout(); invalidate();} å®é™…å°±æ˜¯TextViewçš„setWidthæ–¹æ³•ï¼Œçœ‹åˆ°è®¾ç½®è¿›å»çš„å€¼ä»…å½±å“äº†å®½åº¦æœ€å¤§å€¼å’Œæœ€å°å€¼ã€‚æŒ‰ç…§å®˜æ–¹æ³¨é‡Šå’Œå®æµ‹ï¼Œå‘ç°åªæœ‰å½“Button/TextViewåœ¨xmlä¸­è®¾ç½®android:layout_widthä¸ºâ€wrap_contentâ€æ—¶ï¼Œæ‰ä¼šsetWidthæ”¹å˜å®½åº¦ï¼›è€Œå½“Button/TextViewåœ¨xmlä¸­è®¾ç½®android:layout_widthä¸ºå›ºå®šdpå€¼æ—¶ï¼ŒsetWidthæ— æ•ˆã€‚ è€Œæˆ‘ä»¬ä¸Šé¢ç»™å‡ºçš„Button xmlä¸­ç¡®å®æ˜¯å›ºå®šå€¼180dpï¼Œæ‰€ä»¥æ˜¯å±æ€§â€widthâ€çš„setWidthæ˜¯æ— æ•ˆçš„ï¼Œå³ä¸æ»¡è¶³ç¬¬äºŒæ¡è¦æ±‚ï¼Œå°±æ²¡æœ‰åŠ¨ç”»æ•ˆæœäº†ã€‚ï¼ˆå½“ä¿®æ”¹Button xmlä¸­è®¾ç½®android:layout_widthä¸ºâ€wrap_contentâ€æ—¶ï¼Œä¸Šé¢æ‰§è¡Œçš„å±æ€§åŠ¨ç”»æ˜¯ç”Ÿæ•ˆçš„ã€‚ï¼‰ é‚£ä¹ˆï¼Œå½“ä¸æ»¡è¶³æ¡ä»¶æ—¶ï¼Œå¦‚ä½•è§£å†³æ­¤é—®é¢˜å‘¢ï¼Ÿ æœ‰å¦‚ä¸‹å¤„ç†æ–¹æ³•ï¼š ç»™objectæ·»åŠ setã€getæ–¹æ³•ï¼Œå¦‚æœæœ‰æƒé™ã€‚ï¼ˆä¸€èˆ¬ä¸è¡Œï¼Œå¦‚TextViewæ˜¯SDKé‡Œé¢çš„ä¸èƒ½ç›´æ¥æ”¹ï¼‰ ç»™ObjectåŒ…è£…ä¸€å±‚ï¼Œåœ¨åŒ…è£…ç±»ä¸­æä¾›setã€getæ–¹æ³•ã€‚ ä½¿ç”¨ValueAnimatorï¼Œç›‘å¬Valueå˜åŒ–è¿‡ç¨‹ï¼Œè‡ªå·±å®ç°å±æ€§çš„æ”¹å˜ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162 private void testAnimatorAboutButtonWidth() { //Button width å±æ€§åŠ¨ç”»ï¼šå¦‚æœxmlä¸­å®½åº¦æ˜¯wrap_contentï¼Œé‚£ä¹ˆåŠ¨ç”»æœ‰æ•ˆã€‚ // å¦‚æœè®¾ç½®buttonç¡®åˆ‡çš„dpå€¼ï¼Œé‚£ä¹ˆæ— æ•ˆï¼Œå› ä¸ºå¯¹åº”å±æ€§&quot;width&quot;çš„setWidth()æ–¹æ³•å°±æ˜¯ åœ¨wrap_contentæ˜¯æ‰æœ‰æ•ˆã€‚ ObjectAnimator width1 = ObjectAnimator.ofInt(button, &quot;width&quot;, 1000); width1.setDuration(2000);// width1.start(); //é‚£ä¹ˆï¼Œæƒ³è¦åœ¨buttonåŸæœ¬æœ‰ç¡®åˆ‡dpå€¼æ—¶ï¼Œè¦èƒ½å¯¹widthåŠ¨ç”»ï¼Œæ€ä¹ˆåšå‘¢ï¼Ÿ //æ–¹æ³•ä¸€ï¼ŒåŒ…ä¸€å±‚ï¼Œç„¶åç”¨layoutParams ViewWrapper wrapper = new ViewWrapper(button); ObjectAnimator width2 = ObjectAnimator.ofInt(wrapper, &quot;width&quot;, 1000); width2.setDuration(2000);// width2.start(); //æ–¹æ³•äºŒï¼Œä½¿ç”¨ValueAnimatorï¼Œæ¯ä¸€å¸§è‡ªå·±æ˜¾ç¤ºå®½åº¦çš„å˜åŒ– ValueAnimator valueAnimator = ValueAnimator.ofInt(button.getLayoutParams().width, 1000); valueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() { @Override public void onAnimationUpdate(ValueAnimator animation) { int animatedValue = (Integer) animation.getAnimatedValue(); Log.i(&quot;hfy&quot;, &quot;onAnimationUpdate: animatedValue=&quot; + animatedValue);// IntEvaluator intEvaluator = new IntEvaluator();//// è·å–å±æ€§å€¼æ”¹å˜æ¯”ä¾‹ã€è®¡ç®—å±æ€§å€¼// float animatedFraction = animation.getAnimatedFraction();// Integer evaluate = intEvaluator.evaluate(animatedFraction, 300, 600);// Log.i(&quot;hfy&quot;, &quot;onAnimationUpdate: evaluate=&quot;+evaluate); if (button != null) { button.getLayoutParams().width = animatedValue; button.requestLayout(); } } }); valueAnimator.setDuration(4000).start(); } /** * åŒ…ä¸€å±‚ï¼Œæä¾›å¯¹åº”å±æ€§çš„setã€getæ–¹æ³• */ private class ViewWrapper { private final View mView; public ViewWrapper(View view) { mView = view; } public int getWidth() { return mView.getLayoutParams().width; } public void setWidth(int width) { ViewGroup.LayoutParams layoutParams = mView.getLayoutParams(); layoutParams.width = width; mView.setLayoutParams(layoutParams); mView.requestLayout(); } } å±æ€§åŠ¨ç”»çš„åŸç†å±æ€§åŠ¨ç”»ï¼Œè¦æ±‚å¯¹è±¡æœ‰è¿™ä¸ªå±æ€§çš„setæ–¹æ³•ï¼Œæ‰§è¡Œæ—¶ä¼šæ ¹æ®ä¼ å…¥çš„ å±æ€§åˆå§‹å€¼ã€æœ€ç»ˆå€¼ï¼Œåœ¨æ¯å¸§æ›´æ–°æ—¶è°ƒç”¨setæ–¹æ³•è®¾ç½®å½“å‰æ—¶åˆ»çš„ å±æ€§å€¼ã€‚éšç€æ—¶é—´æ¨ç§»ï¼Œsetçš„å±æ€§å€¼ä¼šæ¥è¿‘æœ€ç»ˆå€¼ï¼Œä»è€Œè¾¾åˆ°åŠ¨ç”»æ•ˆæœã€‚å¦‚æœæ²¡ä¼ å…¥åˆå§‹å€¼ï¼Œé‚£ä¹ˆå¯¹è±¡è¿˜è¦æœ‰getæ–¹æ³•ï¼Œç”¨äºè·å–åˆå§‹å€¼ã€‚ åœ¨è·å–åˆå§‹å€¼ã€setå±æ€§å€¼æ—¶ï¼Œéƒ½æ˜¯ä½¿ç”¨ åå°„ çš„æ–¹å¼ï¼Œè¿›è¡Œ getã€setæ–¹æ³•çš„è°ƒç”¨ã€‚ è§PropertyValuesHolderçš„setupValueã€setAnimatedValueæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738private void setupValue(Object target, Keyframe kf) { if (mProperty != null) { Object value = convertBack(mProperty.get(target)); kf.setValue(value); } else { try { if (mGetter == null) { Class targetClass = target.getClass(); setupGetter(targetClass); if (mGetter == null) { // Already logged the error - just return to avoid NPE return; } } Object value = convertBack(mGetter.invoke(target)); kf.setValue(value); } catch (InvocationTargetException e) { Log.e(&quot;PropertyValuesHolder&quot;, e.toString()); } catch (IllegalAccessException e) { Log.e(&quot;PropertyValuesHolder&quot;, e.toString()); } }}void setAnimatedValue(Object target) { if (mProperty != null) { mProperty.set(target, getAnimatedValue()); } if (mSetter != null) { try { mTmpValueArray[0] = getAnimatedValue(); mSetter.invoke(target, mTmpValueArray); } catch (InvocationTargetException e) { Log.e(&quot;PropertyValuesHolder&quot;, e.toString()); } catch (IllegalAccessException e) { Log.e(&quot;PropertyValuesHolder&quot;, e.toString()); } }} ä»¥ä¸Šæ•ˆæœå›¾ï¼š ä½¿ç”¨åŠ¨ç”»çš„æ³¨æ„äº‹é¡¹ ä½¿ç”¨å¸§åŠ¨ç”»ï¼Œé¿å…OOMã€‚å› ä¸ºå›¾ç‰‡å¤šã€‚ å±æ€§åŠ¨ç”» å¦‚æœæœ‰å¾ªç¯åŠ¨ç”»ï¼Œåœ¨é¡µé¢é€€å‡ºæ—¶è¦åŠæ—¶åœæ­¢ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚ ä½¿ç”¨ViewåŠ¨ç”»åï¼Œè°ƒç”¨setVisibility(View.GONE)å¤±æ•ˆæ—¶ï¼Œä½¿ç”¨view.clearAnimation()å¯è§£å†³ã€‚ å±æ€§åŠ¨ç”»ï¼Œå¯èƒ½ä¼šç”±äºViewå±æ€§å˜åŒ–å¯¼è‡´é¢‘ç¹è§¦å‘é‡æ–°measure layoutï¼Œæ³¨æ„æ€§èƒ½","link":"/2023/10/26/Animation/"},{"title":"Binder","text":"ä¸ºä»€ä¹ˆæ˜¯Binder å…·ä½“è§QAã€‚ ä¸€æ¬¡å®Œæ•´çš„ Binder IPC é€šä¿¡è¿‡ç¨‹é€šå¸¸æ˜¯è¿™æ ·ï¼š å…¶å†…å­˜æµå‘æ˜¯è¿™æ ·çš„ï¼š é¦–å…ˆ Binder é©±åŠ¨åœ¨å†…æ ¸ç©ºé—´åˆ›å»ºä¸€ä¸ªæ•°æ®æ¥æ”¶ç¼“å­˜åŒºï¼› æ¥ç€åœ¨å†…æ ¸ç©ºé—´å¼€è¾Ÿä¸€å—å†…æ ¸ç¼“å­˜åŒºï¼Œå»ºç«‹å†…æ ¸ç¼“å­˜åŒºå’Œå†…æ ¸ä¸­æ•°æ®æ¥æ”¶ç¼“å­˜åŒºä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œä»¥åŠå†…æ ¸ä¸­æ•°æ®æ¥æ”¶ç¼“å­˜åŒºå’Œæ¥æ”¶è¿›ç¨‹ç”¨æˆ·ç©ºé—´åœ°å€çš„æ˜ å°„å…³ç³»ï¼› å‘é€æ–¹è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ copy_from_user() å°†æ•°æ® copy åˆ°å†…æ ¸ä¸­çš„å†…æ ¸ç¼“å­˜åŒºï¼Œç”±äºå†…æ ¸ç¼“å­˜åŒºå’Œæ¥æ”¶è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´å­˜åœ¨å†…å­˜æ˜ å°„ï¼Œå› æ­¤ä¹Ÿå°±ç›¸å½“äºæŠŠæ•°æ®å‘é€åˆ°äº†æ¥æ”¶è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·ä¾¿å®Œæˆäº†ä¸€æ¬¡è¿›ç¨‹é—´çš„é€šä¿¡ã€‚ å¦‚ä¸‹å›¾ï¼š Serveråˆ›å»ºBinderå®ä¾‹ï¼Œå¹¶è°ƒç”¨ServiceManager.addService(String name, IBinder service)å‘ServiceManageræ³¨å†Œ ServiceManageræ ¹æ®ä¼ å…¥çš„æœåŠ¡åä¸æœåŠ¡å®ä½“ï¼Œåœ¨svclistä¸­å¢åŠ è¯¥æœåŠ¡å¯¹åº”çš„handleå’Œnameæ˜ å°„ Clientå‘èµ·é€šä¿¡ï¼Œå…ˆå‘ServiceManageræŸ¥è¯¢è¯¥æœåŠ¡åï¼Œå‘½ä¸­åè¿”å› Binder ç»“æ„å›¾ è¦è¿ä½œBinderï¼Œéœ€è¦4ä¸ªè§’è‰²é€šåŠ›åˆä½œï¼š å®¢æˆ·ç«¯ï¼šè·å–æœåŠ¡ç«¯åœ¨Binderé©±åŠ¨ä¸­å¯¹åº”çš„å¼•ç”¨ï¼Œç„¶åè°ƒç”¨å®ƒçš„transactæ–¹æ³•å³å¯å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ã€‚ æœåŠ¡ç«¯ï¼šæŒ‡Binderå®ç°ç±»æ‰€åœ¨çš„è¿›ç¨‹ï¼Œè¯¥å¯¹è±¡ä¸€æ—¦åˆ›å»ºï¼Œå†…éƒ¨åˆ™ä¼šå¯åŠ¨ä¸€ä¸ªéšè—çº¿ç¨‹ï¼Œä¼šæ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼Œç„¶åæ‰§è¡ŒBinderå¯¹è±¡ä¸­çš„onTransact()å‡½æ•°ã€‚ Binderé©±åŠ¨ï¼šå½“æœåŠ¡ç«¯Binderå¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œä¼šåœ¨Binderé©±åŠ¨ä¸­åˆ›å»ºä¸€ä¸ªmRemoteå¯¹è±¡ã€‚ Service Manager:ä½œç”¨ç›¸å½“äºDNSï¼Œå°±æƒ³å¹³æ—¶æˆ‘ä»¬é€šè¿‡ç½‘å€ï¼Œç„¶åDNSå¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°å¯¹åº”çš„IPåœ°å€ä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨BinderæœåŠ¡ç«¯åˆ›å»ºçš„Binderï¼Œä¼šæ³¨å†Œåˆ°Service Managerï¼ŒåŒç†ï¼Œå½“å®¢æˆ·ç«¯éœ€è¦è¯¥Binderçš„æ—¶å€™ï¼Œä¹Ÿä¼šå»Service ManageræŸ¥æ‰¾ã€‚ æ‰€ä»¥ä»¥ä¸Š4è€…çš„è¿ä½œåŸºæœ¬ä¸Šæ˜¯: æœåŠ¡ç«¯åˆ›å»ºå¯¹åº”Binderå®ä¾‹å¯¹è±¡ï¼Œç„¶åå¼€å¯éšè—Binderçº¿ç¨‹ï¼Œæ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼ŒåŒæ—¶ï¼Œå°†è‡ªèº«çš„Binderæ³¨å†Œåˆ°Service Managerï¼Œåœ¨Binderé©±åŠ¨åˆ›å»ºmRemoteå¯¹è±¡ã€‚ å®¢æˆ·ç«¯æƒ³å’ŒæœåŠ¡ç«¯é€šä¿¡ï¼Œé€šè¿‡Service ManageræŸ¥æ‰¾åˆ°æœåŠ¡ç«¯çš„Binderï¼Œç„¶åBinderé©±åŠ¨å°†å¯¹åº”çš„mRemoteå¯¹è±¡è¿”å› è‡³æ­¤ï¼Œæ•´ä¸ªé€šä¿¡è¿æ¥å»ºç«‹å®Œæ¯• åœ¨å»ºç«‹å®Œæ¯•é€šä¿¡ä¹‹åï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è·å–åˆ°çš„mRemoteå¯¹è±¡å‘ç”Ÿæ¶ˆæ¯ç»™è¿œç¨‹æœåŠ¡ç«¯äº†ï¼Œå®¢æˆ·ç«¯é€šè¿‡è°ƒç”¨transact()æ–¹æ³•ï¼Œå°†è¦è¯·æ±‚çš„å†…å®¹å‘é€åˆ°æœåŠ¡æ®µï¼Œç„¶åæŒ‚èµ·è‡ªå·±å½“å‰çš„çº¿ç¨‹ï¼Œç­‰å¾…å›å¤ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°æ•°æ®ååœ¨è‡ªå·±çš„onTransact()æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œç„¶åå°†å¯¹åº”çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°æ•°æ®ï¼Œé‡æ–°æ‹‰èµ·çº¿ç¨‹ï¼Œè‡³æ­¤è¿›ç¨‹é—´äº¤äº’æ•°æ®å®Œæ¯•ã€‚ Binder é€šä¿¡æ¨¡å‹ä»‹ç»å®Œ Binder IPC çš„åº•å±‚é€šä¿¡åŸç†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å®ç°å±‚é¢æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚ ä¸€æ¬¡å®Œæ•´çš„è¿›ç¨‹é—´é€šä¿¡å¿…ç„¶è‡³å°‘åŒ…å«ä¸¤ä¸ªè¿›ç¨‹ï¼Œé€šå¸¸æˆ‘ä»¬ç§°é€šä¿¡çš„åŒæ–¹åˆ†åˆ«ä¸ºå®¢æˆ·ç«¯è¿›ç¨‹ï¼ˆClientï¼‰å’ŒæœåŠ¡ç«¯è¿›ç¨‹ï¼ˆServerï¼‰ï¼Œç”±äºè¿›ç¨‹éš”ç¦»æœºåˆ¶çš„å­˜åœ¨ï¼Œé€šä¿¡åŒæ–¹å¿…ç„¶éœ€è¦å€ŸåŠ© Binder æ¥å®ç°ã€‚ 5.1 Client/Server/ServiceManager/é©±åŠ¨å‰é¢æˆ‘ä»¬ä»‹ç»è¿‡ï¼ŒBinder æ˜¯åŸºäº C/S æ¶æ„çš„ã€‚ç”±ä¸€ç³»åˆ—çš„ç»„ä»¶ç»„æˆï¼ŒåŒ…æ‹¬ Clientã€Serverã€ServiceManagerã€Binder é©±åŠ¨ã€‚å…¶ä¸­ Clientã€Serverã€Service Manager è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼ŒBinder é©±åŠ¨è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ã€‚å…¶ä¸­ Service Manager å’Œ Binder é©±åŠ¨ç”±ç³»ç»Ÿæä¾›ï¼Œè€Œ Clientã€Server ç”±åº”ç”¨ç¨‹åºæ¥å®ç°ã€‚Clientã€Server å’Œ ServiceManager å‡æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ openã€mmap å’Œ ioctl æ¥è®¿é—®è®¾å¤‡æ–‡ä»¶ /dev/binderï¼Œä»è€Œå®ç°ä¸ Binder é©±åŠ¨çš„äº¤äº’æ¥é—´æ¥çš„å®ç°è·¨è¿›ç¨‹é€šä¿¡ã€‚ Clientã€Serverã€ServiceManagerã€Binder é©±åŠ¨è¿™å‡ ä¸ªç»„ä»¶åœ¨é€šä¿¡è¿‡ç¨‹ä¸­æ‰®æ¼”çš„è§’è‰²å°±å¦‚åŒäº’è”ç½‘ä¸­æœåŠ¡å™¨ï¼ˆServerï¼‰ã€å®¢æˆ·ç«¯ï¼ˆClientï¼‰ã€DNSåŸŸåæœåŠ¡å™¨ï¼ˆServiceManagerï¼‰ä»¥åŠè·¯ç”±å™¨ï¼ˆBinder é©±åŠ¨ï¼‰ä¹‹å‰çš„å…³ç³»ã€‚ é€šå¸¸æˆ‘ä»¬è®¿é—®ä¸€ä¸ªç½‘é¡µçš„æ­¥éª¤æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆåœ¨æµè§ˆå™¨è¾“å…¥ä¸€ä¸ªåœ°å€ï¼Œå¦‚ http://www.google.com ç„¶åæŒ‰ä¸‹å›è½¦é”®ã€‚ä½†æ˜¯å¹¶æ²¡æœ‰åŠæ³•é€šè¿‡åŸŸååœ°å€ç›´æ¥æ‰¾åˆ°æˆ‘ä»¬è¦è®¿é—®çš„æœåŠ¡å™¨ï¼Œå› æ­¤éœ€è¦é¦–å…ˆè®¿é—® DNS åŸŸåæœåŠ¡å™¨ï¼ŒåŸŸåæœåŠ¡å™¨ä¸­ä¿å­˜äº† http://www.google.com å¯¹åº”çš„ ip åœ°å€ 10.249.23.13ï¼Œç„¶åé€šè¿‡è¿™ä¸ª ip åœ°å€æ‰èƒ½æ”¾åˆ°åˆ° http://www.google.com å¯¹åº”çš„æœåŠ¡å™¨ã€‚ Android Binder è®¾è®¡ä¸å®ç°ä¸€æ–‡ä¸­å¯¹ Clientã€Serverã€ServiceManagerã€Binder é©±åŠ¨æœ‰å¾ˆè¯¦ç»†çš„æè¿°ï¼Œä»¥ä¸‹æ˜¯éƒ¨åˆ†æ‘˜å½•ï¼š Binder é©±åŠ¨Binder é©±åŠ¨å°±å¦‚åŒè·¯ç”±å™¨ä¸€æ ·ï¼Œæ˜¯æ•´ä¸ªé€šä¿¡çš„æ ¸å¿ƒï¼›é©±åŠ¨è´Ÿè´£è¿›ç¨‹ä¹‹é—´ Binder é€šä¿¡çš„å»ºç«‹ï¼ŒBinder åœ¨è¿›ç¨‹ä¹‹é—´çš„ä¼ é€’ï¼ŒBinder å¼•ç”¨è®¡æ•°ç®¡ç†ï¼Œæ•°æ®åŒ…åœ¨è¿›ç¨‹ä¹‹é—´çš„ä¼ é€’å’Œäº¤äº’ç­‰ä¸€ç³»åˆ—åº•å±‚æ”¯æŒã€‚ ServiceManager ä¸å®å BinderServiceManager å’Œ DNS ç±»ä¼¼ï¼Œä½œç”¨æ˜¯å°†å­—ç¬¦å½¢å¼çš„ Binder åå­—è½¬åŒ–æˆ Client ä¸­å¯¹è¯¥ Binder çš„å¼•ç”¨ï¼Œä½¿å¾— Client èƒ½å¤Ÿé€šè¿‡ Binder çš„åå­—è·å¾—å¯¹ Binder å®ä½“çš„å¼•ç”¨ã€‚æ³¨å†Œäº†åå­—çš„ Binder å«å®å Binderï¼Œå°±åƒç½‘ç«™ä¸€æ ·é™¤äº†é™¤äº†æœ‰ IP åœ°å€æ„å¤–è¿˜æœ‰è‡ªå·±çš„ç½‘å€ã€‚Server åˆ›å»ºäº† Binderï¼Œå¹¶ä¸ºå®ƒèµ·ä¸€ä¸ªå­—ç¬¦å½¢å¼ï¼Œå¯è¯»æ˜“è®°å¾—åå­—ï¼Œå°†è¿™ä¸ª Binder å®ä½“è¿åŒåå­—ä¸€èµ·ä»¥æ•°æ®åŒ…çš„å½¢å¼é€šè¿‡ Binder é©±åŠ¨å‘é€ç»™ ServiceManager ï¼Œé€šçŸ¥ ServiceManager æ³¨å†Œä¸€ä¸ªåä¸ºâ€œå¼ ä¸‰â€çš„ Binderï¼Œå®ƒä½äºæŸä¸ª Server ä¸­ã€‚é©±åŠ¨ä¸ºè¿™ä¸ªç©¿è¶Šè¿›ç¨‹è¾¹ç•Œçš„ Binder åˆ›å»ºä½äºå†…æ ¸ä¸­çš„å®ä½“èŠ‚ç‚¹ä»¥åŠ ServiceManager å¯¹å®ä½“çš„å¼•ç”¨ï¼Œå°†åå­—ä»¥åŠæ–°å»ºçš„å¼•ç”¨æ‰“åŒ…ä¼ ç»™ ServiceManagerã€‚ServiceManger æ”¶åˆ°æ•°æ®åä»ä¸­å–å‡ºåå­—å’Œå¼•ç”¨å¡«å…¥æŸ¥æ‰¾è¡¨ã€‚ ç»†å¿ƒçš„è¯»è€…å¯èƒ½ä¼šå‘ç°ï¼ŒServierManager æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼ŒServer æ˜¯å¦ä¸€ä¸ªè¿›ç¨‹ï¼ŒServer å‘ ServiceManager ä¸­æ³¨å†Œ Binder å¿…ç„¶æ¶‰åŠåˆ°è¿›ç¨‹é—´é€šä¿¡ã€‚å½“å‰å®ç°è¿›ç¨‹é—´é€šä¿¡åˆè¦ç”¨åˆ°è¿›ç¨‹é—´é€šä¿¡ï¼Œè¿™å°±å¥½åƒè›‹å¯ä»¥å­µå‡ºé¸¡çš„å‰æå´æ˜¯è¦å…ˆæ‰¾åªé¸¡ä¸‹è›‹ï¼Binder çš„å®ç°æ¯”è¾ƒå·§å¦™ï¼Œå°±æ˜¯é¢„å…ˆåˆ›é€ ä¸€åªé¸¡æ¥ä¸‹è›‹ã€‚ServiceManager å’Œå…¶ä»–è¿›ç¨‹åŒæ ·é‡‡ç”¨ Bidner é€šä¿¡ï¼ŒServiceManager æ˜¯ Server ç«¯ï¼Œæœ‰è‡ªå·±çš„ Binder å®ä½“ï¼Œå…¶ä»–è¿›ç¨‹éƒ½æ˜¯ Clientï¼Œéœ€è¦é€šè¿‡è¿™ä¸ª Binder çš„å¼•ç”¨æ¥å®ç° Binder çš„æ³¨å†Œï¼ŒæŸ¥è¯¢å’Œè·å–ã€‚ServiceManager æä¾›çš„ Binder æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæ²¡æœ‰åå­—ä¹Ÿä¸éœ€è¦æ³¨å†Œã€‚å½“ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ BINDERSETCONTEXT_MGR å‘½ä»¤å°†è‡ªå·±æ³¨å†Œæˆ ServiceManager æ—¶ Binder é©±åŠ¨ä¼šè‡ªåŠ¨ä¸ºå®ƒåˆ›å»º Binder å®ä½“ï¼ˆè¿™å°±æ˜¯é‚£åªé¢„å…ˆé€ å¥½çš„é‚£åªé¸¡ï¼‰ã€‚å…¶æ¬¡è¿™ä¸ª Binder å®ä½“çš„å¼•ç”¨åœ¨æ‰€æœ‰ Client ä¸­éƒ½å›ºå®šä¸º 0 è€Œæ— éœ€é€šè¿‡å…¶å®ƒæ‰‹æ®µè·å¾—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ª Server æƒ³è¦å‘ ServiceManager æ³¨å†Œè‡ªå·±çš„ Binder å°±å¿…é¡»é€šè¿‡è¿™ä¸ª 0 å·å¼•ç”¨å’Œ ServiceManager çš„ Binder é€šä¿¡ã€‚ç±»æ¯”äº’è”ç½‘ï¼Œ0 å·å¼•ç”¨å°±å¥½æ¯”æ˜¯åŸŸåæœåŠ¡å™¨çš„åœ°å€ï¼Œä½ å¿…é¡»é¢„å…ˆåŠ¨æ€æˆ–è€…æ‰‹å·¥é…ç½®å¥½ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œè¯´çš„ Client æ˜¯ç›¸å¯¹äº ServiceManager è€Œè¨€çš„ï¼Œä¸€ä¸ªè¿›ç¨‹æˆ–è€…åº”ç”¨ç¨‹åºå¯èƒ½æ˜¯æä¾›æœåŠ¡çš„ Serverï¼Œä½†å¯¹äº ServiceManager æ¥è¯´å®ƒä»ç„¶æ˜¯ä¸ª Clientã€‚ Client è·å¾—å®å Binder çš„å¼•ç”¨Server å‘ ServiceManager ä¸­æ³¨å†Œäº† Binder ä»¥åï¼Œ Client å°±èƒ½é€šè¿‡åå­—è·å¾— Binder çš„å¼•ç”¨äº†ã€‚Client ä¹Ÿåˆ©ç”¨ä¿ç•™çš„ 0 å·å¼•ç”¨å‘ ServiceManager è¯·æ±‚è®¿é—®æŸä¸ª Binder: æˆ‘ç”³è¯·è®¿é—®åå­—å«å¼ ä¸‰çš„ Binder å¼•ç”¨ã€‚ServiceManager æ”¶åˆ°è¿™ä¸ªè¯·æ±‚åä»è¯·æ±‚æ•°æ®åŒ…ä¸­å–å‡º Binder åç§°ï¼Œåœ¨æŸ¥æ‰¾è¡¨é‡Œæ‰¾åˆ°å¯¹åº”çš„æ¡ç›®ï¼Œå–å‡ºå¯¹åº”çš„ Binder å¼•ç”¨ä½œä¸ºå›å¤å‘é€ç»™å‘èµ·è¯·æ±‚çš„ Clientã€‚ä»é¢å‘å¯¹è±¡çš„è§’åº¦çœ‹ï¼ŒServer ä¸­çš„ Binder å®ä½“ç°åœ¨æœ‰ä¸¤ä¸ªå¼•ç”¨ï¼šä¸€ä¸ªä½äº ServiceManager ä¸­ï¼Œä¸€ä¸ªä½äºå‘èµ·è¯·æ±‚çš„ Client ä¸­ã€‚å¦‚æœæ¥ä¸‹æ¥æœ‰æ›´å¤šçš„ Client è¯·æ±‚è¯¥ Binderï¼Œç³»ç»Ÿä¸­å°±ä¼šæœ‰æ›´å¤šçš„å¼•ç”¨æŒ‡å‘è¯¥ Binder ï¼Œå°±åƒ Java ä¸­ä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªå¼•ç”¨ä¸€æ ·ã€‚ 5.2 Binder é€šä¿¡è¿‡ç¨‹è‡³æ­¤ï¼Œæˆ‘ä»¬å¤§è‡´èƒ½æ€»ç»“å‡º Binder é€šä¿¡è¿‡ç¨‹ï¼š é¦–å…ˆï¼Œä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ BINDERSETCONTEXT_MGR å‘½ä»¤é€šè¿‡ Binder é©±åŠ¨å°†è‡ªå·±æ³¨å†Œæˆä¸º ServiceManagerï¼› Server é€šè¿‡é©±åŠ¨å‘ ServiceManager ä¸­æ³¨å†Œ Binderï¼ˆServer ä¸­çš„ Binder å®ä½“ï¼‰ï¼Œè¡¨æ˜å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡ã€‚é©±åŠ¨ä¸ºè¿™ä¸ª Binder åˆ›å»ºä½äºå†…æ ¸ä¸­çš„å®ä½“èŠ‚ç‚¹mRemoteå¯¹è±¡ä»¥åŠ ServiceManager å¯¹mRemoteçš„å¼•ç”¨ï¼Œå°†åå­—ä»¥åŠæ–°å»ºçš„å¼•ç”¨æ‰“åŒ…ä¼ ç»™ ServiceManagerï¼ŒServiceManger å°†å…¶å¡«å…¥æŸ¥æ‰¾è¡¨ã€‚ Client é€šè¿‡åå­—ï¼Œåœ¨ Binder é©±åŠ¨çš„å¸®åŠ©ä¸‹ä» ServiceManager ä¸­è·å–åˆ°å¯¹ Binder å®ä½“çš„å¼•ç”¨ï¼Œé€šè¿‡è¿™ä¸ªå¼•ç”¨å°±èƒ½å®ç°å’Œ Server è¿›ç¨‹çš„é€šä¿¡ã€‚ æˆ‘ä»¬çœ‹åˆ°æ•´ä¸ªé€šä¿¡è¿‡ç¨‹éƒ½éœ€è¦ Binder é©±åŠ¨çš„æ¥å…¥ã€‚ä¸‹å›¾èƒ½æ›´åŠ ç›´è§‚çš„å±•ç°æ•´ä¸ªé€šä¿¡è¿‡ç¨‹(ä¸ºäº†è¿›ä¸€æ­¥æŠ½è±¡é€šä¿¡è¿‡ç¨‹ä»¥åŠå‘ˆç°ä¸Šçš„æ–¹ä¾¿ï¼Œä¸‹å›¾æˆ‘ä»¬å¿½ç•¥äº† Binder å®ä½“åŠå…¶å¼•ç”¨çš„æ¦‚å¿µ)ï¼š 5.3 Binder é€šä¿¡ä¸­çš„ä»£ç†æ¨¡å¼æˆ‘ä»¬å·²ç»è§£é‡Šæ¸…æ¥š Clientã€Server å€ŸåŠ© Binder é©±åŠ¨å®Œæˆè·¨è¿›ç¨‹é€šä¿¡çš„å®ç°æœºåˆ¶äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸ªé—®é¢˜ä¼šè®©æˆ‘ä»¬å›°æƒ‘ã€‚A è¿›ç¨‹æƒ³è¦ B è¿›ç¨‹ä¸­æŸä¸ªå¯¹è±¡ï¼ˆobjectï¼‰æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæ¯•ç«Ÿå®ƒä»¬åˆ†å±ä¸åŒçš„è¿›ç¨‹ï¼ŒA è¿›ç¨‹ æ²¡æ³•ç›´æ¥ä½¿ç”¨ B è¿›ç¨‹ä¸­çš„ objectã€‚ å‰é¢æˆ‘ä»¬ä»‹ç»è¿‡è·¨è¿›ç¨‹é€šä¿¡çš„è¿‡ç¨‹éƒ½æœ‰ Binder é©±åŠ¨çš„å‚ä¸ï¼Œå› æ­¤åœ¨æ•°æ®æµç» Binder é©±åŠ¨çš„æ—¶å€™é©±åŠ¨ä¼šå¯¹æ•°æ®åšä¸€å±‚è½¬æ¢ã€‚å½“ A è¿›ç¨‹æƒ³è¦è·å– B è¿›ç¨‹ä¸­çš„ object æ—¶ï¼Œé©±åŠ¨å¹¶ä¸ä¼šçœŸçš„æŠŠ object è¿”å›ç»™ Aï¼Œè€Œæ˜¯è¿”å›äº†ä¸€ä¸ªè·Ÿ object çœ‹èµ·æ¥ä¸€æ¨¡ä¸€æ ·çš„ä»£ç†å¯¹è±¡ objectProxyï¼Œè¿™ä¸ª objectProxy å…·æœ‰å’Œ object ä¸€æ‘¸ä¸€æ ·çš„æ–¹æ³•ï¼Œä½†æ˜¯è¿™äº›æ–¹æ³•å¹¶æ²¡æœ‰ B è¿›ç¨‹ä¸­ object å¯¹è±¡é‚£äº›æ–¹æ³•çš„èƒ½åŠ›ï¼Œè¿™äº›æ–¹æ³•åªéœ€è¦æŠŠæŠŠè¯·æ±‚å‚æ•°äº¤ç»™é©±åŠ¨å³å¯ã€‚å¯¹äº A è¿›ç¨‹æ¥è¯´å’Œç›´æ¥è°ƒç”¨ object ä¸­çš„æ–¹æ³•æ˜¯ä¸€æ ·çš„ã€‚ å½“ Binder é©±åŠ¨æ¥æ”¶åˆ° A è¿›ç¨‹çš„æ¶ˆæ¯åï¼Œå‘ç°è¿™æ˜¯ä¸ª objectProxy å°±å»æŸ¥è¯¢è‡ªå·±ç»´æŠ¤çš„è¡¨å•ï¼Œä¸€æŸ¥å‘ç°è¿™æ˜¯ B è¿›ç¨‹ object çš„ä»£ç†å¯¹è±¡ã€‚äºæ˜¯å°±ä¼šå»é€šçŸ¥ B è¿›ç¨‹è°ƒç”¨ object çš„æ–¹æ³•ï¼Œå¹¶è¦æ±‚ B è¿›ç¨‹æŠŠè¿”å›ç»“æœå‘ç»™è‡ªå·±ã€‚å½“é©±åŠ¨æ‹¿åˆ° B è¿›ç¨‹çš„è¿”å›ç»“æœåå°±ä¼šè½¬å‘ç»™ A è¿›ç¨‹ï¼Œä¸€æ¬¡é€šä¿¡å°±å®Œæˆäº†ã€‚ 5.4 Binder çš„å®Œæ•´å®šä¹‰ç°åœ¨æˆ‘ä»¬å¯ä»¥å¯¹ Binder åšä¸ªæ›´åŠ å…¨é¢çš„å®šä¹‰äº†ï¼š ä»è¿›ç¨‹é—´é€šä¿¡çš„è§’åº¦çœ‹ï¼ŒBinder æ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡çš„æœºåˆ¶ï¼› ä» Server è¿›ç¨‹çš„è§’åº¦çœ‹ï¼ŒBinder æŒ‡çš„æ˜¯ Server ä¸­çš„ Binder å®ä½“å¯¹è±¡ï¼› ä» Client è¿›ç¨‹çš„è§’åº¦çœ‹ï¼ŒBinder æŒ‡çš„æ˜¯å¯¹ Binder ä»£ç†å¯¹è±¡ï¼Œæ˜¯ Binder å®ä½“å¯¹è±¡çš„ä¸€ä¸ªè¿œç¨‹ä»£ç† ä»ä¼ è¾“è¿‡ç¨‹çš„è§’åº¦çœ‹ï¼ŒBinder æ˜¯ä¸€ä¸ªå¯ä»¥è·¨è¿›ç¨‹ä¼ è¾“çš„å¯¹è±¡ï¼›Binder é©±åŠ¨ä¼šå¯¹è¿™ä¸ªè·¨è¶Šè¿›ç¨‹è¾¹ç•Œçš„å¯¹è±¡å¯¹ä¸€ç‚¹ç‚¹ç‰¹æ®Šå¤„ç†ï¼Œè‡ªåŠ¨å®Œæˆä»£ç†å¯¹è±¡å’Œæœ¬åœ°å¯¹è±¡ä¹‹é—´çš„è½¬æ¢ã€‚ Binderçš„æ­»äº¡é€šçŸ¥ä¸‰ç§æ–¹å¼æ¥æ£€æµ‹è¿œç¨‹å¯¹è±¡æ˜¯å¦å­˜æ´»ï¼š è°ƒç”¨è¿œç¨‹æ–¹æ³•çš„æ—¶å€™æ•è·RemoteException(DeadObjectException)ï¼› è°ƒç”¨IBinderçš„pingBinder()è¿›è¡Œæ£€æµ‹ï¼› è°ƒç”¨linkToDeathæ³¨å†ŒIBinder.DeathRecipientæ¥å£å›è°ƒï¼Œæ¥å£ä¼šåœ¨Ibinderæ­»äº¡æ—¶å›è°ƒbinderDied()ï¼› ServiceManageré“¾æ¥ï¼šhttps://juejin.cn/post/6855904885976924173 ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ BINDERSETCONTEXT_MGR å‘½ä»¤é€šè¿‡ Binder é©±åŠ¨å°†è‡ªå·±æ³¨å†Œæˆä¸º ServiceManagerï¼ŒåŒæ—¶æƒ³Binderé©±åŠ¨æ³¨å†ŒServiceManagerçš„Binderå®ä½“ï¼Œæ­¤æ—¶å…¶ä»–ç›¸å¯¹äºSMçš„Clientå¯ä»¥é€šè¿‡0å·å¼•ç”¨è·å–SMçš„Binderå¼•ç”¨ã€‚ ServiceManagerçš„Binderå¼•ç”¨ï¼š0å·å¼•ç”¨ServiceManageræ˜¯å®‰å“ä¸­ä¸€ä¸ªé‡è¦çš„ç±»ï¼Œæ­£å¦‚å®ƒçš„åå­—æ‰€è¡¨è¾¾çš„æ„æ€ï¼Œç”¨äºç®¡ç†æ‰€æœ‰çš„ç³»ç»ŸæœåŠ¡ï¼Œç»´æŠ¤ç€ç³»ç»ŸæœåŠ¡å’Œå®¢æˆ·ç«¯çš„binderé€šä¿¡ã€‚ é‚£ServiceManagerå’ŒBinderæ˜¯ä»€ä¹ˆæ ·çš„å…³ç³»å‘¢ï¼Ÿ ç®€å•ç‚¹è¯´ï¼ŒServiceManagerä½œç”¨æ˜¯å°†å­—ç¬¦å½¢å¼çš„ Binder åå­—è½¬åŒ–æˆ Client ä¸­å¯¹è¯¥ Binder çš„å¼•ç”¨ï¼Œä½¿å¾— Client èƒ½å¤Ÿé€šè¿‡ Binder çš„åå­—è·å¾—å¯¹ Binder å®ä½“çš„å¼•ç”¨ã€‚ï¼ˆè¿™ä¸ªæ³¨å†Œäº†åå­—çš„ Binder å«å®å Binderï¼‰ ä½†ç°åœ¨å°±æœ‰ä¸ªé—®é¢˜ï¼ŒService Manager æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼ŒServer æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼ŒServer å‘ Service Manager ä¸­æ³¨å†Œ Binderå°±æ¶‰åŠåˆ°è¿›ç¨‹é—´é€šä¿¡ã€‚ä½†å½“å‰è¿›ç¨‹é—´é€šä¿¡åˆè¦ç”¨åˆ°è¿›ç¨‹é—´é€šä¿¡ï¼Œè¿™å°±å¥½åƒè›‹å¯ä»¥å­µå‡ºé¸¡çš„å‰æå´æ˜¯è¦å…ˆæ‰¾åªé¸¡ä¸‹è›‹ã€‚é‚£å¦‚ä½•è§£å†³è¿™ä¸ªæ²¡æœ‰é¸¡ç”Ÿè›‹çš„é—®é¢˜å‘¢ï¼Ÿ å·§å¦™çš„å®ç°ï¼š è¦æ‰“ç ´è¿™ä¸ªé—®é¢˜ï¼Œå°±è¦é¢„å…ˆåˆ›é€ ä¸€åªé¸¡å»ç”Ÿè›‹ï¼Œè¿™åªé¸¡å°±æ˜¯ServiceManagerçš„Binderå®ä½“ã€‚ServiceManager æä¾›çš„ Binder æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæ²¡æœ‰åå­—ä¹Ÿä¸éœ€è¦æ³¨å†Œã€‚å½“ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ BINDER_SET_CONTEXT_MGR å‘½ä»¤å°±ä¼šå°†è‡ªå·±æ³¨å†Œæˆ ServiceManager æ—¶ï¼Œ Binder é©±åŠ¨ä¼šè‡ªåŠ¨ä¸ºå®ƒåˆ›å»º Binder å®ä½“ï¼ˆè¿™å°±æ˜¯é‚£åªé¢„å…ˆé€ å¥½çš„é‚£åªé¸¡ï¼‰ Serverç«¯çš„æ³¨å†Œæ–¹å¼è¿™ä¸ª Binder å®ä½“çš„å¼•ç”¨åœ¨æ‰€æœ‰ Client ä¸­éƒ½å›ºå®šä¸º 0 è€Œæ— éœ€é€šè¿‡å…¶å®ƒæ‰‹æ®µè·å¾—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ª Server æƒ³è¦å‘ ServiceManager æ³¨å†Œè‡ªå·±çš„ Binder å°±å¿…é¡»é€šè¿‡è¿™ä¸ª 0 å·å¼•ç”¨å’Œ ServiceManager çš„ Binder é€šä¿¡ã€‚ æ•´ä¸ªè¿‡ç¨‹å¤§è‡´æ˜¯ï¼š å½“ä¸€ä¸ªBinder Serviceåˆ›å»ºåï¼Œå®ƒä»¬å°±å°†è‡ªå·±çš„[åç§°ã€Binderå¥æŸ„]å¯¹åº”å…³ç³»å‘ŠçŸ¥SMè¿›è¡Œå¤‡æ¡ˆï¼Œå®Œæˆæ³¨å†Œã€‚ Clientç«¯è·å–Serviceçš„Binderå¼•ç”¨Server å‘ ServiceManager ä¸­æ³¨å†Œäº† Binder åï¼Œ Client å°±èƒ½é€šè¿‡åå­—è·å¾— Binder çš„å¼•ç”¨äº†ã€‚ç”±äº Client å’Œ SM é€šä¿¡ä¹Ÿéœ€è¦Binderï¼Œæ‰€ä»¥Client ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ª0å·å¼•ç”¨å»å‘SMè·å–æŸä¸ªServiceçš„Binderã€‚ å› ä¸ºServiceManagerå¯¹äºClientç«¯æ¥è¯´Handleå¥æŸ„æ˜¯å›ºå®šçš„ï¼Œéƒ½æ˜¯0ï¼Œæ‰€ä»¥ServiceManageræœåŠ¡å¹¶ä¸éœ€è¦æŸ¥è¯¢ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚ æ•´ä¸ªè¿‡ç¨‹å¤§è‡´æ˜¯ï¼š Clientå‘é€æ•°æ®åŒ…å‘SMè¯·æ±‚æŸä¸ªåå­—çš„Binderå¼•ç”¨ SM æ”¶åˆ°è¿™ä¸ªè¯·æ±‚åï¼Œä»è¯·æ±‚æ•°æ®åŒ…ä¸­å»æ‰¾åç§°ï¼Œåœ¨æŸ¥æ‰¾è¡¨é‡Œæ‰¾åˆ°å¯¹åº”çš„Binderçš„å¼•ç”¨ å°†æ‰¾åˆ°çš„Binder å¼•ç”¨ä½œä¸ºå›å¤å‘é€ç»™è¯·æ±‚çš„Client QAä¸ºä»€ä¹ˆå†…æ ¸ç©ºé—´é‡Œæœ‰ä¸¤ä¸ªç¼“å­˜åŒºï¼Œâ€œå†…æ ¸ç¼“å­˜åŒºâ€å’Œâ€œæ•°æ®æ¥æ”¶ç¼“å­˜åŒºâ€https://blog.csdn.net/carson_ho/article/details/73560642?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165363401516782425141792%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=165363401516782425141792&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2 ä¸¾ä¸ªè°ƒç”¨WindoManagerServiceçš„Binderä¾‹å­ï¼Ÿ ä¸ºä»€ä¹ˆæ˜¯ Binderï¼Œå…·ä½“è¯´è¯´Client-Serveræ–¹å¼çš„å¹¿æ³›é‡‡ç”¨å¯¹è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚ç›®å‰linuxæ”¯æŒçš„IPCåŒ…æ‹¬ä¼ ç»Ÿçš„ç®¡é“ï¼ŒSystem V IPCï¼Œå³æ¶ˆæ¯é˜Ÿåˆ—/å…±äº«å†…å­˜/ä¿¡å·é‡ï¼Œä»¥åŠsocketä¸­åªæœ‰socketæ”¯æŒClient-Serverçš„é€šä¿¡æ–¹å¼ã€‚å½“ç„¶ä¹Ÿå¯ä»¥åœ¨è¿™äº›åº•å±‚æœºåˆ¶ä¸Šæ¶è®¾ä¸€å¥—åè®®æ¥å®ç°Client-Serveré€šä¿¡ï¼Œä½†è¿™æ ·å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œåœ¨æ‰‹æœºè¿™ç§æ¡ä»¶å¤æ‚ï¼Œèµ„æºç¨€ç¼ºçš„ç¯å¢ƒä¸‹å¯é æ€§ä¹Ÿéš¾ä»¥ä¿è¯ã€‚ å¦ä¸€æ–¹é¢æ˜¯ä¼ è¾“æ€§èƒ½ã€‚socketä½œä¸ºä¸€æ¬¾é€šç”¨æ¥å£ï¼Œå…¶ä¼ è¾“æ•ˆç‡ä½ï¼Œå¼€é”€å¤§ï¼Œä¸»è¦ç”¨åœ¨è·¨ç½‘ç»œçš„è¿›ç¨‹é—´é€šä¿¡å’Œæœ¬æœºä¸Šè¿›ç¨‹é—´çš„ä½é€Ÿé€šä¿¡ã€‚æ¶ˆæ¯é˜Ÿåˆ—å’Œç®¡é“é‡‡ç”¨å­˜å‚¨-è½¬å‘æ–¹å¼ï¼Œå³æ•°æ®å…ˆä»å‘é€æ–¹ç¼“å­˜åŒºæ‹·è´åˆ°å†…æ ¸å¼€è¾Ÿçš„ç¼“å­˜åŒºä¸­ï¼Œç„¶åå†ä»å†…æ ¸ç¼“å­˜åŒºæ‹·è´åˆ°æ¥æ”¶æ–¹ç¼“å­˜åŒºï¼Œè‡³å°‘æœ‰ä¸¤æ¬¡æ‹·è´è¿‡ç¨‹ã€‚å…±äº«å†…å­˜è™½ç„¶æ— éœ€æ‹·è´ï¼Œä½†æ§åˆ¶å¤æ‚ï¼Œéš¾ä»¥ä½¿ç”¨ã€‚ è¡¨ 1 å„ç§IPCæ–¹å¼æ•°æ®æ‹·è´æ¬¡æ•° è¿˜æœ‰ä¸€ç‚¹æ˜¯å‡ºäºå®‰å…¨æ€§è€ƒè™‘ã€‚Androidä½œä¸ºä¸€ä¸ªå¼€æ”¾å¼ï¼Œæ‹¥æœ‰ä¼—å¤šå¼€å‘è€…çš„çš„å¹³å°ï¼Œåº”ç”¨ç¨‹åºçš„æ¥æºå¹¿æ³›ï¼Œç¡®ä¿æ™ºèƒ½ç»ˆç«¯çš„å®‰å…¨æ˜¯éå¸¸é‡è¦çš„ã€‚ç»ˆç«¯ç”¨æˆ·ä¸å¸Œæœ›ä»ç½‘ä¸Šä¸‹è½½çš„ç¨‹åºåœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å·çª¥éšç§æ•°æ®ï¼Œè¿æ¥æ— çº¿ç½‘ç»œï¼Œé•¿æœŸæ“ä½œåº•å±‚è®¾å¤‡å¯¼è‡´ç”µæ± å¾ˆå¿«è€—å°½ç­‰ç­‰ã€‚ä¼ ç»ŸIPCæ²¡æœ‰ä»»ä½•å®‰å…¨æªæ–½ï¼Œå®Œå…¨ä¾èµ–ä¸Šå±‚åè®®æ¥ç¡®ä¿ã€‚é¦–å…ˆä¼ ç»ŸIPCçš„æ¥æ”¶æ–¹æ— æ³•è·å¾—å¯¹æ–¹è¿›ç¨‹å¯é çš„UID/PIDï¼ˆç”¨æˆ·ID/è¿›ç¨‹IDï¼‰ï¼Œä»è€Œæ— æ³•é‰´åˆ«å¯¹æ–¹èº«ä»½ã€‚Androidä¸ºæ¯ä¸ªå®‰è£…å¥½çš„åº”ç”¨ç¨‹åºåˆ†é…äº†è‡ªå·±çš„UIDï¼Œæ•…è¿›ç¨‹çš„UIDæ˜¯é‰´åˆ«è¿›ç¨‹èº«ä»½çš„é‡è¦æ ‡å¿—ã€‚ä½¿ç”¨ä¼ ç»ŸIPCåªèƒ½ç”±ç”¨æˆ·åœ¨æ•°æ®åŒ…é‡Œå¡«å…¥UID/PIDï¼Œä½†è¿™æ ·ä¸å¯é ï¼Œå®¹æ˜“è¢«æ¶æ„ç¨‹åºåˆ©ç”¨ã€‚å¯é çš„èº«ä»½æ ‡è®°åªæœ‰ç”±IPCæœºåˆ¶æœ¬èº«åœ¨å†…æ ¸ä¸­æ·»åŠ ã€‚å…¶æ¬¡ä¼ ç»ŸIPCè®¿é—®æ¥å…¥ç‚¹æ˜¯å¼€æ”¾çš„ï¼Œæ— æ³•å»ºç«‹ç§æœ‰é€šé“ã€‚æ¯”å¦‚å‘½åç®¡é“çš„åç§°ï¼Œsystem Vçš„é”®å€¼ï¼Œsocketçš„ipåœ°å€æˆ–æ–‡ä»¶åéƒ½æ˜¯å¼€æ”¾çš„ï¼Œåªè¦çŸ¥é“è¿™äº›æ¥å…¥ç‚¹çš„ç¨‹åºéƒ½å¯ä»¥å’Œå¯¹ç«¯å»ºç«‹è¿æ¥ï¼Œä¸ç®¡æ€æ ·éƒ½æ— æ³•é˜»æ­¢æ¶æ„ç¨‹åºé€šè¿‡çŒœæµ‹æ¥æ”¶æ–¹åœ°å€è·å¾—è¿æ¥ã€‚ é™„å½•-Binderç¤ºä¾‹Server 12345678910111213141516171819202122232425262728293031323334353637383940414243public class GameService extends Service { private Binder mBinder = new Binder() { @Override protected boolean onTransact(int code, Parcel data, Parcel reply, int flags) throws RemoteException { if (code == 1) { String _arg0; _arg0 = data.readString(); int _result = getGamePrice(_arg0); reply.writeInt(_result); return true; } return super.onTransact(code, data, reply, flags); } public int getGamePrice(String name) { int price = -1; if (&quot;é€ƒç”Ÿ2&quot;.equals(name)) { price = 88; } else if (&quot;é¥¥è’&quot;.equals(name)) { price = 24; } return price; } }; @Nullable @Override public IBinder onBind(Intent intent) { return mBinder; } @Override public void onCreate() { super.onCreate(); // åœ¨æœåŠ¡åˆ›å»ºæ—¶ï¼Œå°†Binderå¯¹è±¡æ³¨å†Œåˆ°ServiceManager try { ServiceManager.addService(&quot;my_service&quot;, mBinder); } catch (RemoteException e) { e.printStackTrace(); } }} Client 1234567891011121314151617181920212223242526272829303132333435363738394041private IBinder mRemote = null;private ServiceConnection mServiceConnection = new ServiceConnection() { @Override public void onServiceConnected(ComponentName name, IBinder service) { mRemote = service; Toast.makeText(MainActivity.this, &quot;ç»‘å®šæˆåŠŸ&quot;, Toast.LENGTH_SHORT).show(); service?.linkToDeath(object : IBinder.DeathRecipient{ override fun binderDied() { } }, 0) } @Override public void onServiceDisconnected(ComponentName name) { mRemote = null; Toast.makeText(MainActivity.this, &quot;è¿œç¨‹æœåŠ¡é“¾æ¥å·²æ–­&quot;, Toast.LENGTH_SHORT).show(); }};private void init() { String action = &quot;android.intent.action.bind.gameservice&quot;; Intent intent = new Intent(action); intent.setPackage(&quot;com.smartwork.bindertest&quot;); bindService(intent, mServiceConnection, BIND_AUTO_CREATE);}private int invokeRemoteService(String name) throws RemoteException { android.os.Parcel _data = android.os.Parcel.obtain(); android.os.Parcel _reply = android.os.Parcel.obtain(); int _result; try { _data.writeString(name); mRemote.transact(1, _data, _reply, 0); _result = _reply.readInt(); } finally { _reply.recycle(); _data.recycle(); } return _result;}","link":"/2022/08/08/Binder/"},{"title":"Coroutines_Principle","text":"Kotlinåç¨‹ä½¿ç”¨ Dispatchersåç¨‹è°ƒåº¦å™¨æ˜¯ç”¨æ¥æŒ‡å®šåç¨‹ä½“åœ¨å“ªä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œï¼ŒKotlinæä¾›äº†å‡ ä¸ªè°ƒåº¦å™¨ï¼š Default é»˜è®¤é€‰é¡¹ï¼ŒæŒ‡å®šåç¨‹ä½“åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼š 123456789101112GlobalScope.launch(Dispatchers.Default) { println(&quot;1: ${Thread.currentThread().name}&quot;) launch(Dispatchers.Default) { println(&quot;2: ${Thread.currentThread().name}&quot;) } println(&quot;3: ${Thread.currentThread().name}&quot;)}--&gt;output1: DefaultDispatcher-worker-13: DefaultDispatcher-worker-12: DefaultDispatcher-worker-2 Main æŒ‡å®šåç¨‹ä½“åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚ IO åŸºäº Default è°ƒåº¦å™¨èƒŒåçš„çº¿ç¨‹æ± (designed for offloading blocking IO tasks)ï¼Œå› æ­¤ä» Default åˆ‡æ¢åˆ° IO ä¸ä¼šè§¦å‘çº¿ç¨‹åˆ‡æ¢ï¼š 123456789101112GlobalScope.launch(Dispatchers.Default) { println(&quot;1: ${Thread.currentThread().name}&quot;) launch(Dispatchers.IO) { println(&quot;2: ${Thread.currentThread().name}&quot;) } println(&quot;3: ${Thread.currentThread().name}&quot;)}--&gt;output1: DefaultDispatcher-worker-13: DefaultDispatcher-worker-12: DefaultDispatcher-worker-1 Unconfined åç¨‹ä½“è¿è¡Œåœ¨çˆ¶åç¨‹æ‰€åœ¨çš„çº¿ç¨‹ï¼š 123456789101112GlobalScope.launch(Dispatchers.Default) { println(&quot;1: ${Thread.currentThread().name}&quot;) launch(Dispatchers.Unconfined) { println(&quot;2: ${Thread.currentThread().name}&quot;) } println(&quot;3: ${Thread.currentThread().name}&quot;)}--&gt;output1: DefaultDispatcher-worker-12: DefaultDispatcher-worker-13: DefaultDispatcher-worker-1 CoroutineScope1234public interface CoroutineScope { public val coroutineContext: CoroutineContext}å¤åˆ¶ä»£ç  GlobeScope GlobeScope å¯åŠ¨çš„åç¨‹æ˜¯ä¸€ä¸ªå•ç‹¬çš„ä½œç”¨åŸŸï¼Œä¸ä¼šç»§æ‰¿ä¸Šå±‚åç¨‹çš„ä½œç”¨åŸŸï¼Œå…¶å†…éƒ¨çš„å­åç¨‹éµå®ˆé»˜è®¤çš„ä½œç”¨åŸŸè§„åˆ™ã€‚ coroutineScope coroutineScope å¯åŠ¨çš„åç¨‹ cancel æ—¶ä¼š cancel æ‰€æœ‰å­åç¨‹ï¼Œä¹Ÿä¼š cancel çˆ¶åç¨‹ï¼Œå­åç¨‹æœªæ•è·çš„å¼‚å¸¸ä¹Ÿä¼šå‘ä¸Šä¼ é€’ç»™çˆ¶åç¨‹ã€‚ supervisorScope supervisorScope å¯åŠ¨çš„åç¨‹ cancel å’Œä¼ é€’å¼‚å¸¸æ—¶ï¼Œåªä¼šç”±çˆ¶åç¨‹å‘å­åç¨‹å•å‘ä¼ æ’­ã€‚MainScope æ˜¯ supervisorScope ä½œç”¨åŸŸã€‚ Android-Kotlinåç¨‹ä½¿ç”¨MainScopeAndroid ä¸­ä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨ GlobalScope, å› ä¸ºå®ƒä¼šåˆ›å»ºä¸€ä¸ªé¡¶å±‚åç¨‹ï¼Œéœ€è¦ä¿æŒæ‰€æœ‰å¯¹ GlobalScope å¯åŠ¨çš„åç¨‹çš„å¼•ç”¨ï¼Œç„¶ååœ¨ Activity destory ç­‰åœºæ™¯çš„æ—¶å€™ cancel æ‰è¿™äº›çš„åç¨‹ï¼Œå¦åˆ™å°±ä¼šé€ æˆå†…å­˜æ³„éœ²ç­‰é—®é¢˜ã€‚å¯ä»¥ä½¿ç”¨ MainScope: 12345678910111213141516class CoroutineActivity : AppCompatActivity() { private val mainScope = MainScope() fun request1() { mainScope.launch { // ... } } // request2, 3, ... override fun onDestroy() { super.onDestroy() mainScope.cancel() }} MainScope çš„å®šä¹‰ï¼š 1public fun MainScope(): CoroutineScope = ContextScope(SupervisorJob() + Dispatchers.Main) Lifecycleåç¨‹å…³äº Lifecycle å¯ä»¥å‚è€ƒ Android-Jetpackç»„ä»¶ä¹‹Lifecycleã€‚ æ·»åŠ ä¾èµ–ï¼š 1implementation &quot;androidx.lifecycle:lifecycle-runtime-ktx:2.2.0&quot; æºç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940val LifecycleOwner.lifecycleScope: LifecycleCoroutineScope get() = lifecycle.coroutineScopeval Lifecycle.coroutineScope: LifecycleCoroutineScope get() { while (true) { val existing = mInternalScopeRef.get() as LifecycleCoroutineScopeImpl? if (existing != null) { return existing } val newScope = LifecycleCoroutineScopeImpl( this, SupervisorJob() + Dispatchers.Main.immediate ) if (mInternalScopeRef.compareAndSet(null, newScope)) { newScope.register() return newScope } } }abstract class LifecycleCoroutineScope internal constructor() : CoroutineScope { internal abstract val lifecycle: Lifecycle // å½“ activity created çš„æ—¶å€™æ‰§è¡Œåç¨‹ä½“ fun launchWhenCreated(block: suspend CoroutineScope.() -&gt; Unit): Job = launch { lifecycle.whenCreated(block) } // // å½“ activity started çš„æ—¶å€™æ‰§è¡Œåç¨‹ä½“ fun launchWhenStarted(block: suspend CoroutineScope.() -&gt; Unit): Job = launch { lifecycle.whenStarted(block) } // // å½“ activity resumed çš„æ—¶å€™æ‰§è¡Œåç¨‹ä½“ fun launchWhenResumed(block: suspend CoroutineScope.() -&gt; Unit): Job = launch { lifecycle.whenResumed(block) }}å¤åˆ¶ä»£ç  ä½¿ç”¨ï¼š 12345678910// AppCompatActivity å®ç°äº† LifecycleOwner æ¥å£class MainActivity : AppCompatActivity() { fun test() { lifecycleScope.launchWhenCreated { // ... } }}å¤åˆ¶ä»£ç  LiveDataåç¨‹å…³äº LiveData å¯ä»¥å‚è€ƒ Android-Jetpackç»„ä»¶ä¹‹LiveData-ViewModelã€‚ æ·»åŠ ä¾èµ–ï¼š 1implementation &quot;androidx.lifecycle:lifecycle-livedata-ktx:2.2.0&quot; æºç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051fun &lt;T&gt; liveData( context: CoroutineContext = EmptyCoroutineContext, timeoutInMs: Long = DEFAULT_TIMEOUT, @BuilderInference block: suspend LiveDataScope&lt;T&gt;.() -&gt; Unit): LiveData&lt;T&gt; = CoroutineLiveData(context, timeoutInMs, block)internal class CoroutineLiveData&lt;T&gt;( context: CoroutineContext = EmptyCoroutineContext, timeoutInMs: Long = DEFAULT_TIMEOUT, block: Block&lt;T&gt;) : MediatorLiveData&lt;T&gt;() { private var blockRunner: BlockRunner&lt;T&gt;? private var emittedSource: EmittedSource? = null init { val supervisorJob = SupervisorJob(context[Job]) val scope = CoroutineScope(Dispatchers.Main.immediate + context + supervisorJob) blockRunner = BlockRunner( liveData = this, block = block, timeoutInMs = timeoutInMs, scope = scope ) { blockRunner = null } } internal suspend fun emitSource(source: LiveData&lt;T&gt;): DisposableHandle { clearSource() val newSource = addDisposableSource(source) emittedSource = newSource return newSource } internal suspend fun clearSource() { emittedSource?.disposeNow() emittedSource = null } // å¯åŠ¨åç¨‹ override fun onActive() { super.onActive() blockRunner?.maybeRun() } // å–æ¶ˆåç¨‹ override fun onInactive() { super.onInactive() blockRunner?.cancel() }} ä½¿ç”¨ï¼š 12345678910111213141516// AppCompatActivity å®ç°äº† LifecycleOwner æ¥å£class MainActivity : AppCompatActivity() { fun test() { liveData { try { // ... emit(&quot;success&quot;) } catch(e: Exception) { emit(&quot;error&quot;) } }.observe(this, Observer { Log.d(&quot;LLL&quot;, it) }) }} ViewModelåç¨‹å…³äº ViewModel å¯ä»¥å‚è€ƒ Android-Jetpackç»„ä»¶ä¹‹LiveData-ViewModelã€‚ æ·»åŠ ä¾èµ–ï¼š 1implementation &quot;androidx.lifecycle:lifecycle-viewmodel-ktx:2.2.0&quot; æºç å¦‚ä¸‹ï¼š 1234567891011121314151617val ViewModel.viewModelScope: CoroutineScope get() { val scope: CoroutineScope? = this.getTag(JOB_KEY) if (scope != null) { return scope } return setTagIfAbsent(JOB_KEY, CloseableCoroutineScope(SupervisorJob() + Dispatchers.Main.immediate)) }internal class CloseableCoroutineScope(context: CoroutineContext) : Closeable, CoroutineScope { override val coroutineContext: CoroutineContext = context override fun close() { coroutineContext.cancel() }} åç¨‹åŸç†suspend çš„åŸç†ç®€è¿°ï¼šsuspendå…¶å®ä¹Ÿæ˜¯å›è°ƒï¼Œå®ç°suspendçš„æ–¹æ³•ä¼šè¢«ç¼–è¯‘å™¨æ›¿æ¢ä¸º å¤šä¸€ä¸ªContinuationå‚æ•° çš„æ–¹æ³•ï¼ŒContinuationå®ç°äº†ä¸€ä¸ªçŠ¶æ€æœºï¼Œå…¶ä¸­æ¯ä¸ªæŒ‚èµ·ç‚¹(suspendæ–¹æ³•)éƒ½æ˜¯ä¸€ä¸ªçŠ¶æ€ï¼Œä¿å­˜äº†ä¸‹ä¸€æ­¥æ‰§è¡Œçš„CoroutineContextã€‚ å…·ä½“è€Œè¨€ï¼Œ æ¯”å¦‚mainä¸­è°ƒç”¨äº†suspend a(), suspend b()ï¼Œé‚£ä¹ˆå®é™…ä¸Šç¼–è¯‘å™¨ä¼šæ„é€ è¿™ä¹ˆä¸€ä¸ªçŠ¶æ€æœºï¼šinvokeSuspend() ä¸­æ ¹æ®æ¯ä¸ªæ–¹æ³•çš„æ‰§è¡Œç»“æœï¼Œå¦‚a()å¦‚æœè€—æ—¶ã€å³withContext(Dispatchers)/runBlockingä¹‹ç±»çš„ã€‘åˆ™ä¼šreturn COROUTINE_SUSPENDED (å³åç»­æ“ä½œå…ˆä¸æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æŒ‚èµ·äº†)ï¼Œç­‰è€—æ—¶æ‰§è¡Œå®ŒæˆåinvokeSuspend()å†è¢«è°ƒç”¨ï¼Œæ­¤æ—¶çŠ¶æ€æ”¹å˜ï¼Œbreakèµ°ä¸‹ä¸€æ­¥b()ï¼›å¦‚æœa()ä¸è€—æ—¶åˆ™ç«‹å³breakï¼Œèµ°åˆ°ä¸‹ä¸€æ­¥b()ï¼› å¦‚æ­¤å¾€å¤ï¼Œç›´åˆ°æ‰€æœ‰suspendæ–¹æ³•æ‰§è¡Œå®Œæˆï¼Œåæ­£å¸¸æ‰§è¡Œå…¶ä»–ä»£ç  suspend æ˜¯å›è°ƒï¼ˆCallbackï¼‰ç†è§£ suspend å…¶å®ä¸éœ€è¦çº ç»“ç¥å¥‡çš„ã€ŒæŒ‚èµ·ã€æ˜¯ä»€ä¹ˆæ„æ€æˆ–è€…æ‹˜æ³¥äºçº¿ç¨‹æ˜¯æ€ä¹ˆåˆ‡æ¢çš„ã€‚å®é™…ä¸Š suspend çš„èƒŒåæ˜¯å¤§å®¶éå¸¸ç†Ÿæ‚‰çš„å›è°ƒã€‚ å‡è®¾ postItem ç”±ä¸‰ä¸ªæœ‰ä¾èµ–å…³ç³»çš„å¼‚æ­¥å­ä»»åŠ¡ç»„æˆï¼š requestTokenï¼ŒcreatePost å’Œ processPost ï¼Œè¿™ä¸‰ä¸ªå‡½æ•°éƒ½æ˜¯åŸºäºå›è°ƒçš„ APIï¼š 12345678910111213141516// ä¸‰ä¸ªåŸºäºå›è°ƒçš„ APIfun requestToken(block: (String) -&gt; Unit)fun createPost( token: String, item: Item, block: (Post) -&gt; Unit))fun processPost(post: Post)fun postItem(item: Item) { requestToken { token -&gt; createPost(token, item) { post -&gt; processPost(post) } }} å¯ä»¥çœ‹åˆ°åŸºäºå›è°ƒçš„ API å¾ˆå®¹æ˜“é€ æˆå¤§é‡ç¼©è¿›ã€‚å¦‚æœä»£ç ä¸­å†åŠ ä¸Šä¸€äº›æ¡ä»¶ã€å¾ªç¯çš„é€»è¾‘ï¼Œé‚£ä¹ˆä»£ç å¯è¯»æ€§ä¼šå¤§å¤§é™ä½ã€‚Promise (Future) ç­‰ API ä»¥åŠ Android ç¤¾åŒºå¾ˆæµè¡Œçš„ RxJava é€šè¿‡é“¾å¼è°ƒç”¨åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ¶ˆé™¤äº†åµŒå¥—çš„é—®é¢˜ã€‚æ¯”å¦‚ä¸Šé¢è¿™ä¸ªä¾‹å­ç”¨ RxJava å®ç°çš„è¯ï¼š 1234567fun requestToken(): Observable&lt;String&gt;fun createPost(token: String, item: Item): Observable&lt;Post&gt;fun processPost(post: Post)fun postItem(item: Item) = requestToken() .flatMap { createPost(it, item) } .flatMap { processPost(it) } ä½†æ˜¯ RxJava è¿™æ ·çš„æ–¹æ¡ˆéœ€è¦ä½¿ç”¨è€…æŒæ¡å¤§é‡æ“ä½œç¬¦ï¼Œå†™å¤æ‚é€»è¾‘ä¹Ÿå¾ˆéº»çƒ¦ï¼Œä¼šæœ‰ä¸€ç§è¢«ã€Œå›°åœ¨ã€è¿™ä¸ªè°ƒç”¨é“¾é‡Œé¢çš„æ„Ÿè§‰ã€‚ kotlin çš„ suspend å…³é”®å­—å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ¶ˆé™¤å›è°ƒï¼Œç”¨åŒæ­¥çš„å†™æ³•å†™å¼‚æ­¥ï¼š ğŸ¹ä»£è¡¨æŒ‚èµ·ç‚¹ï¼ˆsuspension pointï¼‰ 123456789suspend fun requestToken(): Stringsuspend fun createPost(token: String, item: Item): Postsuspend fun processPost(post)suspend fun postItem(item: Item) { val token = ğŸ¹ requestToken() val post = ğŸ¹ createPost(token, item) ğŸ¹ processPost(post)} ç”±äº createPost è¿™äº›æ–¹æ³•å®é™…ä¸Šæ˜¯è€—æ—¶çš„ IO å¼‚æ­¥æ“ä½œï¼Œéœ€è¦ç­‰åˆ°æ‹¿åˆ°è¿”å›å€¼æ‰èƒ½æ‰§è¡Œåé¢çš„é€»è¾‘ï¼Œä½†æˆ‘ä»¬åˆä¸å¸Œæœ›é˜»å¡å½“å‰çº¿ç¨‹ï¼ˆé€šå¸¸æ˜¯ä¸»çº¿ç¨‹ï¼‰ï¼Œå› æ­¤æœ€ç»ˆå¿…é¡»å®ç°æŸç§æ¶ˆæ¯ä¼ é€’çš„æœºåˆ¶ï¼Œè®©åå°çº¿ç¨‹åšå®Œè€—æ—¶æ“ä½œä»¥åæŠŠç»“æœä¼ ç»™ä¸»çº¿ç¨‹ã€‚ å‡è®¾æˆ‘ä»¬æœ‰äº†å‰é¢æåˆ°çš„ä¸‰ä¸ªåŸºäºå›è°ƒçš„ APIï¼Œå®ç° suspend å¯ä»¥åœ¨ç¼–è¯‘çš„æ—¶å€™æŠŠæ¯ä¸ªæŒ‚èµ·ç‚¹ ğŸ¹ åé¢çš„é€»è¾‘åŒ…åœ¨ä¸€ä¸ª lambda é‡Œé¢ï¼Œç„¶åå»è°ƒç”¨å›è°ƒ APIï¼Œæœ€ç»ˆç”Ÿæˆç±»ä¼¼åµŒå¥—çš„ä»£ç ã€‚ä½†è¿™æ ·æ¯ä¸€ä¸ªæŒ‚èµ·ç‚¹åœ¨è¿è¡Œæ—¶éƒ½éœ€è¦å¼€é”€ä¸€ä¸ª lambda å¯¹è±¡ã€‚Kotlin å’Œè®¸å¤šå…¶ä»–è¯­è¨€éƒ½é‡‡ç”¨ç”ŸæˆçŠ¶æ€æœºçš„æ–¹å¼ï¼Œæ€§èƒ½æ›´å¥½ã€‚ å…·ä½“æ¥è¯´ï¼Œç¼–è¯‘å™¨çœ‹åˆ° suspend å…³é”®å­—ä¼šå»æ‰ suspend ï¼Œç»™å‡½æ•°æ·»åŠ ä¸€ä¸ªé¢å¤–çš„ Continuation å‚æ•°ã€‚è¿™ä¸ª Continuation å°±ä»£è¡¨äº†ä¸€ä¸ªå›è°ƒï¼š 12345public interface Continuation&lt;in T&gt; { public val context: CoroutineContext // ç”¨æ¥å›è°ƒçš„æ–¹æ³• public fun resumeWith(result: Result&lt;T&gt;)} Kotlin ç¼–è¯‘å™¨ä¼šç»™æ¯ä¸ª suspend çš„å—ç”Ÿæˆä¸€ä¸ª Continuation çš„å®ç°ç±»ï¼Œè¿™ä¸ªå®ç°ç±»æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œå…¶ä¸­çš„çŠ¶æ€å¯¹åº”äºæ¯ä¸ªæŒ‚èµ·ç‚¹ï¼Œä¿å­˜äº†éœ€è¦ä¸‹ä¸€æ­¥ç»§ç»­æ‰§è¡Œæ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ï¼ˆå³ä¾èµ–çš„å±€éƒ¨å˜é‡ï¼‰ï¼Œç±»ä¼¼ä¸‹é¢çš„ä¼ªä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748suspend fun postItem(item: Item) { val token = ğŸ¹ requestToken() val post = ğŸ¹ createPost(token, item) ğŸ¹ processPost(post)}// ç¼–è¯‘å™¨å˜æ¢åçš„ä¼ªä»£ç // 1.è„±æ‰äº† suspend å…³é”®å­—// 2.å¢åŠ äº†ä¸€ä¸ª Continuation å¯¹è±¡fun postItem(item: Item, cont: Continuation) { // åˆ¤æ–­ä¼ å…¥çš„æ˜¯å¦æ˜¯ postItem çš„ `ContiuationImpl` // * false: åˆå§‹åŒ–ä¸€ä¸ªå¯¹åº”æœ¬æ¬¡è°ƒç”¨ postItem çš„çŠ¶æ€æœº // * true: å¯¹åº” postItem å†…å…¶ä»– suspend å‡½æ•°å›è°ƒå›æ¥æƒ…å†µ // å…¶ä¸­ ThisSM æŒ‡çš„ object: ContinuationImpl è¿™ä¸ªåŒ¿åç±» val sm = (cont as? ThisSM) ?: object: ContinuationImpl { // å®é™…æºç ä¸­ override çš„æ˜¯ // kotlin.coroutine.jvm.internal.BaseContinuationImpl // çš„ invokeSuspend æ–¹æ³• override fun resume(..) { // é€šè¿‡ ContinuationImpl.resume // é‡æ–°å›è°ƒå›è¿™ä¸ªæ–¹æ³• postItem(null, this) } } switch (sm.label) { case 0: // æ•è·åç»­æ­¥éª¤éœ€è¦çš„å±€éƒ¨å˜é‡ sm.item = item // è®¾ç½®ä¸‹ä¸€æ­¥çš„ label sm.label = 1 // å½“ requestToken é‡Œçš„è€—æ—¶æ“ä½œå®Œæˆåä¼šæ›´æ–°çŠ¶æ€æœº // å¹¶é€šè¿‡ sm.resume å†æ¬¡è°ƒç”¨è¿™ä¸ª postItem å‡½æ•° // ã€Œæˆ‘ä»¬åœ¨å‰é¢æä¾›äº† sm.resume çš„å®ç°ï¼Œå³å†æ¬¡è°ƒç”¨ postItemã€ requestToken(sm) case 1: val item = sm.item // å‰ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœ val token = sm.result as Token sm.label = 2 createPost(token, item, sm) case 2: procesPost(post) // ... }} ç¼–è¯‘å™¨å°† suspend ç¼–è¯‘æˆå¸¦æœ‰ continuation å‚æ•°çš„æ–¹æ³•å«åš CPS (Continuation-Passing-Style) å˜æ¢ã€‚ ä½¿ç”¨ suspend å‡½æ•°æ— é¡»å…³å¿ƒçº¿ç¨‹åˆ‡æ¢suspend æä¾›äº†è¿™æ ·ä¸€ä¸ª**çº¦å®š(Convention)**ï¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ä¸ä¼šé˜»å¡å½“å‰è°ƒç”¨çš„çº¿ç¨‹ã€‚ ä½†å‰ææ˜¯è¿™ä¸ª suspend å‡½æ•°å®ç°æ­£ç¡®ï¼ŒçœŸæ­£åšåˆ°äº†ä¸é˜»å¡å½“å‰çº¿ç¨‹ã€‚å•çº¯åœ°ç»™å‡½æ•°åŠ ä¸Š suspend å…³é”®å­—å¹¶ä¸ä¼šç¥å¥‡åœ°è®©å‡½æ•°å˜æˆéé˜»å¡çš„ è¿™å¯¹ UI ç¼–ç¨‹æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå› ä¸º UI çš„ä¸»çº¿ç¨‹éœ€è¦ä¸æ–­ç›¸åº”å„ç§å›¾å½¢ç»˜åˆ¶ã€ç”¨æˆ·æ“ä½œçš„è¯·æ±‚ï¼Œå¦‚æœä¸»çº¿ç¨‹ä¸Šæœ‰è€—æ—¶æ“ä½œä¼šè®©å…¶ä»–è¯·æ±‚æ— æ³•åŠæ—¶å“åº”ï¼Œé€ æˆ UI å¡é¡¿ã€‚ Android ç¤¾åŒºæµè¡Œçš„ç½‘ç»œè¯·æ±‚åº“ Retrofitã€å®˜æ–¹å‡ºå“çš„æ•°æ®åº“ ORM Room éƒ½å·²ç»é€šè¿‡æä¾› suspend API çš„å½¢å¼æ”¯æŒäº†åç¨‹ã€‚Android å®˜æ–¹ä¹Ÿåˆ©ç”¨ Kotlin æ‰©å±•å±æ€§çš„æ–¹å¼ç»™ Activity ç­‰å…·æœ‰ç”Ÿå‘½å‘¨æœŸçš„ç»„ä»¶æä¾›äº†å¼€å¯åç¨‹æ‰€éœ€çš„ CoroutineScope ï¼Œå…¶ä¸­çš„ context æŒ‡å®šäº†ä½¿ç”¨ Dispatchers.Main ï¼Œå³é€šè¿‡ lifecycleScope å¼€å¯çš„åç¨‹éƒ½ä¼šè¢«è°ƒåº¦åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨è°ƒç”¨ suspend å‡½æ•°ï¼Œæ‹¿åˆ°ç»“æœåç›´æ¥æ›´æ–° UIï¼Œæ— é¡»åšä»»ä½•çº¿ç¨‹åˆ‡æ¢çš„åŠ¨ä½œã€‚è¿™æ ·çš„ suspend å‡½æ•°å«ä½œã€Œmain å®‰å…¨ã€çš„ã€‚ 1234lifecycleScope.launch { val posts = ğŸ¹ retrofit.get&lt;PostService&gt;().fetchPosts(); // ç”±äºåœ¨ä¸»çº¿ç¨‹ï¼Œå¯ä»¥æ‹¿ç€ posts æ›´æ–° UI} è¿™ç›¸æ¯” callback å’Œ RxJava çš„ API æ˜¯è¦å¥½å¾ˆå¤šçš„ã€‚è¿™äº›å¼‚æ­¥çš„ API æœ€ç»ˆéƒ½å¾—ä¾é å›è°ƒï¼Œä½†å›è°ƒå›æ¥åœ¨å“ªä¸ªçº¿ç¨‹éœ€è¦è°ƒç”¨æ–¹è‡ªå·±ææ¸…æ¥šï¼Œå¾—çœ‹è¿™äº›å‡½æ•°é‡Œé¢æ˜¯æ€ä¹ˆå®ç°çš„ã€‚è€Œæœ‰äº† suspend ä¸é˜»å¡å½“å‰çº¿ç¨‹çš„çº¦å®šï¼Œè°ƒç”¨æ–¹å…¶å®æ— é¡»å…³å¿ƒè¿™ä¸ªå‡½æ•°å†…éƒ¨æ˜¯åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œçš„ã€‚ 12lifecycleScope.launch(Dispatchers.Main) { ğŸ¹ foo()} æ¯”å¦‚ä¸Šé¢è¿™ä¸ªä»£ç å—ï¼Œæˆ‘ä»¬æŒ‡å®šè¿™ä¸ªåç¨‹å—è°ƒåº¦åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œé‡Œé¢è°ƒç”¨äº†ä¸€ä¸ªä¸çŸ¥é“å“ªé‡Œæ¥çš„ suspend foo æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å†…éƒ¨å¯èƒ½æ˜¯è€—æ—¶çš„ CPU è®¡ç®—ï¼Œå¯èƒ½æ˜¯è€—æ—¶çš„ IO è¯·æ±‚ï¼Œä½†æ˜¯æˆ‘åœ¨å†™è¿™ä¸ªåç¨‹å—çš„æ—¶å€™ï¼Œå…¶å®å¹¶ä¸éœ€è¦å…³å¿ƒè¿™é‡Œé¢åˆ°åº•æ˜¯æ€ä¹ˆå›äº‹ï¼Œè¿è¡Œåœ¨å“ªä¸ªçº¿ç¨‹ã€‚ç±»ä¼¼åœ°ï¼Œåœ¨é˜…è¯»è¿™æ®µåç¨‹å—çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çŸ¥é“çœ¼å‰çš„è¿™æ®µä»£ç ä¼šåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œsuspend foo é‡Œé¢çš„ä»£ç æ˜¯ä¸€ä¸ªæ½œåœ¨çš„è€—æ—¶æ“ä½œï¼Œå…·ä½“åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œæ˜¯è¿™ä¸ªå‡½æ•°çš„å®ç°ç»†èŠ‚ï¼Œå¯¹äºå½“å‰ä»£ç çš„é€»è¾‘æ˜¯ã€Œé€æ˜ã€çš„ã€‚ ä½†å‰ææ˜¯è¿™ä¸ª suspend å‡½æ•°å®ç°æ­£ç¡®ï¼ŒçœŸæ­£åšåˆ°äº†ä¸é˜»å¡å½“å‰çº¿ç¨‹ã€‚å•çº¯åœ°ç»™å‡½æ•°åŠ ä¸Š suspend å…³é”®å­—å¹¶ä¸ä¼šç¥å¥‡åœ°è®©å‡½æ•°å˜æˆéé˜»å¡çš„ï¼Œæ¯”å¦‚å‡è®¾ suspend foo é‡Œé¢çš„å®ç°æ˜¯è¿™æ ·çš„ï¼š 12// ğŸ˜–suspend fun foo() = BigInteger.probablePrime(4096, Random()) è¿™é‡Œè¿™ä¸ª suspend å‡½æ•°çš„å†…éƒ¨å®ç°æ˜¯ä¸€æ®µè€—æ—¶çš„ CPU æ“ä½œï¼Œç±»ä¼¼åœ°ä¹Ÿå¯ä»¥æƒ³è±¡æˆæ˜¯ä¸€æ®µæ—¶é—´å¤æ‚åº¦ç‰¹åˆ«é«˜çš„ä»£ç ã€‚æˆ‘ä»¬å¦‚æœåœ¨ä¸»çº¿ç¨‹è°ƒç”¨è¿™ä¸ªå‡½æ•°è¿˜æ˜¯ä¼šé˜»å¡ UIã€‚é—®é¢˜å‡ºåœ¨è¿™ä¸ª foo å‡½æ•°çš„å®ç°æ²¡æœ‰éµå®ˆ suspend çš„è¯­ä¹‰ï¼Œæ˜¯é”™è¯¯çš„ã€‚æ­£ç¡®çš„åšæ³•åº”è¯¥ä¿®æ”¹è¿™ä¸ª foo å‡½æ•°ï¼š 123suspend fun findBigPrime(): BigInteger = withContext(Dispatchers.Default) { BigInteger.probablePrime(4096, Random()) } å€ŸåŠ© withContext æˆ‘ä»¬æŠŠè€—æ—¶æ“ä½œä»å½“å‰ä¸»çº¿ç¨‹æŒªåˆ°äº†ä¸€ä¸ªé»˜è®¤çš„åå°çº¿ç¨‹æ± ã€‚å› æ­¤æœ‰äººè¯´ï¼Œå³ä½¿æ˜¯ç”¨äº†åç¨‹ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šã€Œé˜»å¡ã€æŸä¸ªçº¿ç¨‹ï¼Œã€Œæ‰€æœ‰çš„ä»£ç æœ¬è´¨ä¸Šéƒ½æ˜¯é˜»å¡å¼çš„ã€ã€‚è¿™ç§ç†è§£å¯ä»¥å¸®åŠ©æˆ‘ä»¬è®¤è¯†åˆ° Android / JVM ä¸Šæœ€ç»ˆéœ€è¦çº¿ç¨‹ä½œä¸ºæ‰§è¡Œåç¨‹çš„è½½ä½“ï¼Œä½†å¿½ç•¥äº†é˜»å¡å’Œéé˜»å¡ IO ä¹‹åˆ†ã€‚CPU æ‰§è¡Œçº¿ç¨‹ï¼Œè€Œä¸Šé¢ BigInteger.probablePrime æ˜¯ä¸€ä¸ªè€—æ—¶çš„ CPU è®¡ç®—ï¼Œåªèƒ½ç­‰å¾… CPU æŠŠç»“æœç®—å‡ºæ¥ï¼Œä½† IO é€ æˆçš„ç­‰å¾…å¹¶ä¸ä¸€å®šè¦é˜»å¡ CPUã€‚ é“¾æ¥æŠ½ä¸å‰¥èŒ§kotlin-åç¨‹ Kotlinç¬”è®°ä¹‹åç¨‹å·¥ä½œåŸç† ç†è§£ Kotlin çš„ suspend å‡½æ•° https://blog.yujinyan.me/posts/understanding-kotlin-suspend-functions/ Otherä»¥GlobalScope.launch{ â€¦ } ä¸ºä¾‹ï¼Œç¼–è¯‘æœŸé€šè¿‡ç¼–è¯‘æ—¶æ’å…¥ä»£ç ï¼Œå°†â€â€¦â€åç¨‹ä½“åŒ…è£¹å°è£…æˆä¸€ä¸ªç»§æ‰¿ä¸SuspendLambda,è€ŒSuspendLambdaæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç»§æ‰¿äºContinuationImplã€‚ ContinuationImplå°±æ˜¯æ ¸å¿ƒåç¨‹ç±»Continuationæ¥å£çš„å®ç°ï¼ˆä¸€ä¸ªContinuationå°±ä»£è¡¨äº†ä¸€ä¸ªåç¨‹ï¼‰\\ åç¨‹çš„å¯åŠ¨æ˜¯é€šè¿‡ BaseContinuationImpl.resumeWith æ–¹æ³•è°ƒç”¨åˆ°äº†å­ç±» SuspendLambda.invokeSuspend æ–¹æ³•ï¼Œç„¶åé€šè¿‡çŠ¶æ€æœºæ¥æ§åˆ¶é¡ºåºè¿è¡Œã€‚ Kotlin ç¼–è¯‘å™¨ä¼šä¸º åç¨‹ä½“ ç”Ÿæˆç»§æ‰¿è‡ª SuspendLambda çš„å­ç±»ï¼Œåç¨‹çš„çœŸæ­£è¿ç®—é€»è¾‘éƒ½åœ¨å…¶ invokeSuspend æ–¹æ³•ä¸­ã€‚","link":"/2021/11/02/Coroutines-Principle/"},{"title":"ActivityStart","text":"å½“æ‰‹æŒ‡ç‚¹å‡»äº†æ¡Œé¢çš„Appå›¾æ ‡æ—¶å‘ç”Ÿäº†ä»€ä¹ˆ - ProcessOn AIDLï¼š frameworks/base/core/java/android/app/IActivityManager.aidl -&gt; æœ¬åœ°è¿›ç¨‹è·å–system_serverè¿›ç¨‹ä¸­çš„AMSæœåŠ¡ frameworks/base/core/java/android/app/IApplicationThread.aidl -&gt; system_serverè¿›ç¨‹è°ƒç”¨æœ¬åœ°è¿›ç¨‹ActivtyThreadæ‰§è¡Œ (å¦‚LaunchActivityItemåˆ›å»ºActivityä¸ResumeActivityItemèµ°onResumeç”Ÿå‘½å‘¨æœŸ) äº‹åŠ¡å‘é€Handleræ¶ˆæ¯ 0x01: ä»activity.startActivityåˆ°onPuase() 1234567891011121314151617181920212223242526272829android.app.Activity#startActivity(android.content.Intent)-&gt;android.app.Activity#startActivityForResult(android.content.Intent, int, android.os.Bundle)... Instrumentation.ActivityResult ar = mInstrumentation.execStartActivity( this, mMainThread.getApplicationThread(), mToken, this, intent, requestCode, options);...-&gt;android.app.Instrumentation#execStartActivity(android.content.Context, android.os.IBinder, android.os.IBinder, android.app.Activity, android.content.Intent, int, android.os.Bundle)// Instrumentation#execStartActivityå„ä¸ªç‰ˆæœ¬å®ç°åŒºåˆ«è¾ƒå¤§ï¼ŒAndroid8ä¹‹å‰ï¼ˆä¸å«ï¼‰æ˜¯ç”¨ActivityManagerProxyä»£ç†AMSï¼ŒAndroid8åŠä¹‹åæ›¿æ¢ä¸ºç›´æ¥ä»¥AIDLæ–¹æ³•è·å–è°ƒç”¨AMSæœåŠ¡ï¼ŒAndroid10åŠä¹‹ååˆå°†å°†è¯¥è¿‡ç¨‹äº¤ç»™ActivityTaskMangerService(ATMS)æ‰§è¡ŒstartActivityæµç¨‹ int result = ActivityManager.getService() .startActivity(whoThread, who.getBasePackageName(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target, requestCode, 0, null, options); checkStartActivityResult(result, intent);-&gt; com.android.server.am.ActivityManagerService#startActivity(IApplicationThread caller, String callingPackage,Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode,int startFlags, ProfilerInfo profilerInfo, Bundle bOptions)//Android9.0å³API28ä¸ºä¾‹ï¼šç»è¿‡ä¸Šè¿°IPCè¿‡ç¨‹åï¼Œè¿›å…¥system_serverè¿›ç¨‹ï¼Œæ¥ä¸‹æ¥åœ¨ActivityManagerServiceä¸­æ‰§è¡ŒstartActivity â€”â€”â€”â€”â€” åº”ç”¨è¿›ç¨‹ä¸system_serverè¿›ç¨‹åˆ‡æ¢çš„åˆ†å‰²çº¿ â€”â€”â€”â€”â€”-åˆ‡æ¢åˆ°system_serverè¿›ç¨‹ï¼Œç”±äºsystem_serveræ˜¯éšè—çš„ï¼Œæ•…éš¾ä»¥debug ä¸€ã€ActivityManagerService12345678910111213141516171819202122232425262728293031323334353637383940414243//ä»¥ä¸‹ä¸ºsystem_serverä¸­è¿›è¡Œçš„AMS startActivityçš„æµç¨‹com.android.server.am.ActivityManagerService#startActivity(IApplicationThread caller, String callingPackage,Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode,int startFlags, ProfilerInfo profilerInfo, Bundle bOptions)-&gt; com.android.server.am.ActivityManagerService#startActivityreturn startActivityAsUser(... , UserHandle.getCallingUserId());-&gt;com.android.server.am.ActivityManagerService#startActivityAsUser(IApplicationThread, java.lang.String, android.content.Intent, java.lang.String, android.os.IBinder, java.lang.String, int, int, ProfilerInfo, android.os.Bundle, int)-&gt;com.android.server.am.ActivityManagerService#startActivityAsUser(IApplicationThread, java.lang.String, android.content.Intent, java.lang.String, android.os.IBinder, java.lang.String, int, int, ProfilerInfo, android.os.Bundle, int, boolean)... // TODO: Switch to user app stacks here. return mActivityStartController.obtainStarter(intent, &quot;startActivityAsUser&quot;) .setCaller(caller) .setCallingPackage(callingPackage) .setResolvedType(resolvedType) .setResultTo(resultTo) .setResultWho(resultWho) .setRequestCode(requestCode) .setStartFlags(startFlags) .setProfilerInfo(profilerInfo) .setActivityOptions(bOptions) .setMayWait(userId) .execute();...-&gt;com.android.server.am.ActivityStartController#obtainStarter//å·¥å‚æ¨¡å¼ï¼Œåˆ¶é€ ä¸€ä¸ªæ ¸å¿ƒå¯åŠ¨ç±»ActivityStarterï¼Œèµ‹å€¼startActivityAsUserå…¥å‚ç»™ActivityStarterï¼Œå¹¶å¼è°ƒç”¨å…¶execute-&gt; äºŒã€ActivityStarter1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768//ActivityStarter.java com.android.server.am.ActivityStarter#execute() { ...//mRequest.mayWait == truereturn startActivityMayWait(mRequest.caller, mRequest.callingUid, mRequest.callingPackage, mRequest.intent, mRequest.resolvedType, mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo, mRequest.resultWho, mRequest.requestCode, mRequest.startFlags, mRequest.profilerInfo, mRequest.waitResult, mRequest.globalConfig, mRequest.activityOptions, mRequest.ignoreTargetSecurity, mRequest.userId, mRequest.inTask, mRequest.reason, mRequest.allowPendingRemoteAnimationRegistryLookup); ...}//ActivityStarter#startActivityMayWait ä¸­new ä¸€ä¸ªActivityRecordï¼Œ ActivityRecord ä¸ºActivity åœ¨AMSä¸­çš„ä¿¡æ¯ï¼Œç„¶ååœ¨ä¸‹é¢çš„startActivityä¸­èµ‹å€¼ã€‚å¹¶ä¸”æ‰¾åˆ°Activity æ‰€åœ¨çš„ActivityStack.private int startActivityMayWait(IApplicationThread caller, int callingUid, String callingPackage, Intent intent, String resolvedType, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, WaitResult outResult, Configuration globalConfig, SafeActivityOptions options, boolean ignoreTargetSecurity, int userId, TaskRecord inTask, String reason, boolean allowPendingRemoteAnimationRegistryLookup) { //... synchronized (mService) { final ActivityStack stack = mSupervisor.mFocusedStack; //... final ActivityRecord[] outRecord = new ActivityRecord[1]; int res = startActivity(caller, intent, ephemeralIntent, resolvedType, aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode, callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity, componentSpecified, outRecord, inTask, reason, allowPendingRemoteAnimationRegistryLookup); } -&gt; startActivity -&gt; startActivity -&gt; startActivity -&gt; //ç»è¿‡å¤šä¸ªstartACtivityé‡è½½æ–¹æ³•å¥—å¨ƒå¼è°ƒç”¨ï¼ˆä¸»è¦æ˜¯Activityä¿¡æ¯çš„ç»„è£…ï¼‰åï¼Œèµ°åˆ°startActivityUnchecked //startActivityUnchecked ä¸­è°ƒç”¨ActivityStack#startActivityLocked æ‰¾åˆ°Activity æ‰€åœ¨çš„TaskRecord, æŠŠActivity æ’å…¥TaskRecord åˆé€‚çš„ä½ç½®ã€‚è°ƒç”¨ActivityStackSupervisor#resumeFocusedStackTopActivityLocked private int startActivityUnchecked(final ActivityRecord r, ActivityRecord sourceRecord, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, int startFlags, boolean doResume, ActivityOptions options, TaskRecord inTask, ActivityRecord[] outActivity) { //... mTargetStack.startActivityLocked(mStartActivity, topFocused, newTask, mKeepCurTransition,mOptions); //... if (mDoResume) { if (!mTargetStack.isFocusable() || (topTaskActivity != null &amp;&amp; topTaskActivity.mTaskOverlay &amp;&amp; mStartActivity != topTaskActivity)) { } else { mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity, mOptions); } } else if (mStartActivity != null) { } //... return START_SUCCESS; } ä¸‰ã€ActivityStackSupervisor123456789101112131415//ActivityStackSupervisor.java//Activity å·²ç»åœ¨è¿›å…¥ActivityStackï¼Œ ç„¶åä»Activity ä¸­æŸ¥æ‰¾è¿™ä¸ªActivity ç„¶åè°ƒçŠ¶æ€è®¾ç½®ä¸ºresume. boolean resumeFocusedStackTopActivityLocked( ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions) { if (!readyToResume()) { return false; } if (targetStack != null &amp;&amp; isFocusedStack(targetStack)) { return targetStack.resumeTopActivityUncheckedLocked(target, targetOptions); } return false; } å››ã€ActivityStack123456789101112131415161718192021222324252627282930313233343536373839404142434445464748//ActivityStack.java//ç»§ç»­å›åˆ° ActivityStack resume Activity.åœ¨resumeTopActivityInnerLocked ä¸­å…ˆæ£€æŸ¥æ¡Œé¢çš„Activity çŠ¶æ€ï¼Œæ¡Œé¢Activity çŠ¶æ€éœ€è¦è®¾ç½®ä¸ºpause, startPausingLocked æŠŠæ¡Œé¢Activityè®¾ç½®ä¸ºpausedã€‚ ç”±äºæ–°çš„Activity åœ¨å¦å¤–ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹è¿˜æ²¡æœ‰å¯åŠ¨ï¼ŒmStackSupervisor.startSpecificActivityLocked å¯åŠ¨æ–°çš„Activity è¿›ç¨‹ã€‚boolean resumeTopActivityUncheckedLocked(ActivityRecord prev, ActivityOptions options) { //... try { // Protect against recursion. mStackSupervisor.inResumeTopActivity = true; result = resumeTopActivityInnerLocked(prev, options); //... return result; } private boolean resumeTopActivityInnerLocked(ActivityRecord prev,ActivityOptions options) { //... boolean pausing = mStackSupervisor.pauseBackStacks(userLeaving, next, false); if (mResumedActivity != null) { if (DEBUG_STATES) Slog.d(TAG_STATES, &quot;resumeTopActivityLocked: Pausing &quot; + mResumedActivity); //å¯åŠ¨æ–¹Activity çŠ¶æ€éœ€è¦è®¾ç½®ä¸ºpause pausing |= startPausingLocked(userLeaving, false, next, false); } //... if (next.app != null &amp;&amp; next.app.thread != null) { //... } else { //... mStackSupervisor.startSpecificActivityLocked(next, true, true); } return true;}//å…³äºPauseActivityItemäº‹åŠ¡æ‰§è¡Œæµç¨‹å¯å‚è§//@0x02â€”â€”ä¸€ã€releaseStartActivityLockedâ€”â€”1ã€åˆ›å»ºæ·»åŠ activityäº‹åŠ¡å¹¶é€šè¿‡binderå°†äº‹åŠ¡äº¤äºˆåº”ç”¨è¿›ç¨‹æ‰§è¡Œfinal boolean startPausingLocked(boolean userLeaving, boolean uiSleeping, ActivityRecord resuming, boolean pauseImmediately) { //... if (prev.app != null &amp;&amp; prev.app.thread != null) { mService.getLifecycleManager().scheduleTransaction(prev.app.thread, prev.appToken,PauseActivityItem.obtain(prev.finishing, userLeaving, prev.configChangeFlags, pauseImmediately)); } catch (Exception e) { } } else { }} å°ç»“:ä»activity.startActivity()åˆ°Instrunmentaionä¸­ä»¥Binderæœºåˆ¶é€šè¿‡ActivityManager.getService().startActivityåˆ‡æ¢åˆ°system_serverè¿›ç¨‹ä¸­çš„ActivityMangerServiceæœåŠ¡ï¼Œå†åˆ°ActivityMangerServiceä¸­ActivityStarterã€ActivityStatckSuperVisorã€ActivityStackæ‰§è¡Œè§£æç”ŸæˆActivityRecord(åŒ…å«AMSã€activityInfoã€Configurationç­‰ä¿¡æ¯)ï¼Œæœ€åç”±ActivityStacké€šè¿‡binderå°†â€pauseäº‹åŠ¡â€ä»AMSä¼ é€’åˆ°åº”ç”¨è¿›ç¨‹ï¼Œåº”ç”¨è¿›ç¨‹handleræœºåˆ¶å¤„ç†è¯¥äº‹åŠ¡ï¼Œæ—§Activity pauseæˆåŠŸã€‚å¼€å§‹AMSå¯åŠ¨æ–°Activityã€‚ 1234567891011121314151617è‡³æ­¤çš„é“¾è·¯ç®€è¿°Activity.startActivity-&gt;Instrumentation.execStartActivity-&gt;ActivityManager.getService().startActivity-&gt;ActivityManagerService.startActivityAsUser-&gt;ActivityStarter.execute-&gt;ActivityStarter.startActivityMayWait -&gt;ActivityStarter.startActivity-&gt;ActivityStarter.startActivityé‡è½½å¥—å¨ƒ-&gt;ActivityStarter.startActivityUnchecked-&gt;ActivityStackSupervisor.resumeFocusedStackTopActivityLocked-&gt;ActivityStack.resumeTopActivityUncheckedLocked-&gt; ActivityStack.resumeTopActivityInnerLocked{ //startPausingLocked() //startSpecificActivityLocked(next, true, false);} è‡³æ­¤ï¼Œæ–°Activityçš„ActivityRecordï¼ˆAMSä¸­çš„Activityä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸é™äºActivityInfoã€ProcessRecordã€Configurationï¼ŒActivityStackSupervisorã€å‘èµ·è·³è½¬çš„Activityçš„ActivityRecordå’ŒresultToçš„ActivityRecordï¼‰åˆ›å»ºè§£æå®Œæˆï¼Œæ—§Activityçš„pauseç”Ÿå‘½å‘¨æœŸè¢«è°ƒç”¨æ‰§è¡Œï¼ˆè§é™„å½•ActivityStack#startPausingLockedï¼‰ï¼Œæ¥ä¸‹æ¥å°±æ˜¯é€šè¿‡AMSå¯åŠ¨æ–°çš„Activity 0x02: AMSå¯åŠ¨æ–°çš„Activity1234567891011121314151617181920212223242526272829com.android.server.am.ActivityStackSupervisor#startSpecificActivityLocked (...) { ProcessRecord app = mService.getProcessRecordLocked(r.processName, r.info.applicationInfo.uid, true); getLaunchTimeTracker().setLaunchTime(r); if (app != null &amp;&amp; app.thread != null) { try { // !!! çœ‹è¿™é‡Œï¼Œå¦‚æœæ²¡æœ‰å¦å¼€è¿›ç¨‹çš„æ ‡è¯†ï¼Œå°±èµ°realStartActivityLockedï¼Œç›´æ¥èµ°æ™®é€šActivityå¯åŠ¨æµç¨‹ï¼Œç„¶åretrun !!! if ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == 0 || !&quot;android&quot;.equals(r.info.packageName)) { // Don't add this if it is a platform co mponent that is marked // to run in multiple processes, because this is actually // part of the framework so doesn't make sense to track as a // separate apk in the process. app.addPackage(r.info.packageName,r.info.applicationInfo.longVersionCode, mService.mProcessStats); } realStartActivityLocked(r, app, andResume, checkConfig); return; } catch (RemoteException e) { Slog.w(TAG, &quot;Exception when starting activity &quot; + r.intent.getComponent().flattenToShortString(), e); } // If a dead object exception was thrown -- fall through to // restart the application. } // !!!çœ‹è¿™é‡Œï¼Œå¦‚æœæ²¡æœ‰åœ¨å‰é¢è¢«returnæ‰ï¼Œå°±ä¼šèµ°æ–°å¼€è¿›ç¨‹å¯åŠ¨Activityçš„æµç¨‹ mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0, &quot;activity&quot;, r.intent.getComponent(), false, false, true);} ä¸€ã€startProcessLockedç®€è¿°ï¼šå¯åŠ¨æ–°çš„è¿›ç¨‹ï¼Œå³Zygoteè¿›ç¨‹Process.start() forkå‡ºæ–°çš„è¿›ç¨‹å¹¶åå°„è°ƒç”¨å…¶mianæ–¹æ³•ï¼Œèµ°åˆ°ActivityThread.mainï¼Œmainæ–¹æ³•ä¸­ä¸»è¦æ˜¯åˆå§‹åŒ–looperå¹¶å¯åŠ¨å¾ªç¯ï¼Œæ¥ç€è°ƒç”¨ActivityThread.attach()åœ¨è¯¥æ–¹æ³•ä¸­åˆå§‹åŒ–Applicationå•ä¾‹ã€‚æ¥ä¸‹æ¥å°±æ˜¯äºŒã€å®è´¨æ€§å¯åŠ¨Activityã€‚ å¯åŠ¨æ–°è¿›ç¨‹æ‰¿è½½æ–°Activityï¼Œä¹‹åç»§ç»­èµ°realStartActivityLockedå¸¸è§åŒè¿›ç¨‹Activityå¯åŠ¨çš„æµç¨‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189com.android.server.am.ActivityManagerService#startProcessLocked(java.lang.String, android.content.pm.ApplicationInfo, boolean, int, java.lang.String, android.content.ComponentName, boolean, boolean, boolean) -&gt; com.android.server.am.ActivityManagerService#startProcessLocked(java.lang.String, java.lang.String, java.lang.String, com.android.server.am.ProcessRecord, int, int[], int, int, java.lang.String, java.lang.String, java.lang.String, java.lang.String, long) -&gt; com.android.server.am.ActivityManagerService#startProcess(...) { if (hostingType.equals(&quot;webview_service&quot;)) { startResult = startWebView(entryPoint, app.processName, uid, uid, gids, runtimeFlags, mountExternal, app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet, app.info.dataDir, null, new String[] {PROC_START_SEQ_IDENT + app.startSeq}); } else { startResult = Process.start(entryPoint, app.processName, uid, uid, gids, runtimeFlags, mountExternal, app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet, app.info.dataDir, invokeWith, new String[] {PROC_START_SEQ_IDENT + app.startSeq}); }} -&gt;//android.os.Process.java public static final ZygoteProcess zygoteProcess = new ZygoteProcess(ZYGOTE_SOCKET, SECONDARY_ZYGOTE_SOCKET);public static final ProcessStartResult start(final String processClass, final String niceName, int uid, int gid, int[] gids, int runtimeFlags, int mountExternal, int targetSdkVersion, String seInfo, String abi, String instructionSet, String appDataDir, String invokeWith, String[] zygoteArgs) { return zygoteProcess.start(processClass, niceName, uid, gid, gids, runtimeFlags, mountExternal, targetSdkVersion, seInfo, abi, instructionSet, appDataDir, invokeWith, zygoteArgs);}public final Process.ProcessStartResult start(final String processClass, final String niceName, int uid, int gid, int[] gids, int runtimeFlags, int mountExternal, int targetSdkVersion, String seInfo, String abi, String instructionSet, String appDataDir, String invokeWith, String[] zygoteArgs) { try { return startViaZygote(processClass, niceName, uid, gid, gids, runtimeFlags, mountExternal, targetSdkVersion, seInfo, abi, instructionSet, appDataDir, invokeWith, false /* startChildZygote */, zygoteArgs); } catch (ZygoteStartFailedEx ex) { Log.e(LOG_TAG, &quot;Starting VM process through Zygote failed&quot;); throw new RuntimeException( &quot;Starting VM process through Zygote failed&quot;, ex); }}private Process.ProcessStartResult startViaZygote(final String processClass, final String niceName, final int uid, final int gid, final int[] gids, int runtimeFlags, int mountExternal, int targetSdkVersion, String seInfo, String abi, String instructionSet, String appDataDir, String invokeWith, boolean startChildZygote, String[] extraArgs) throws ZygoteStartFailedEx { ArrayList&lt;String&gt; argsForZygote = new ArrayList&lt;String&gt;(); // --runtime-args, --setuid=, --setgid=, // and --setgroups= must go first argsForZygote.add(&quot;--runtime-args&quot;); argsForZygote.add(&quot;--setuid=&quot; + uid); argsForZygote.add(&quot;--setgid=&quot; + gid); argsForZygote.add(&quot;--runtime-flags=&quot; + runtimeFlags); if (mountExternal == Zygote.MOUNT_EXTERNAL_DEFAULT) { argsForZygote.add(&quot;--mount-external-default&quot;); } else if (mountExternal == Zygote.MOUNT_EXTERNAL_READ) { argsForZygote.add(&quot;--mount-external-read&quot;); } else if (mountExternal == Zygote.MOUNT_EXTERNAL_WRITE) { argsForZygote.add(&quot;--mount-external-write&quot;); } argsForZygote.add(&quot;--target-sdk-version=&quot; + targetSdkVersion); // --setgroups is a comma-separated list if (gids != null &amp;&amp; gids.length &gt; 0) { StringBuilder sb = new StringBuilder(); sb.append(&quot;--setgroups=&quot;); int sz = gids.length; for (int i = 0; i &lt; sz; i++) { if (i != 0) { sb.append(','); } sb.append(gids[i]); } argsForZygote.add(sb.toString()); } if (niceName != null) { argsForZygote.add(&quot;--nice-name=&quot; + niceName); } if (seInfo != null) { argsForZygote.add(&quot;--seinfo=&quot; + seInfo); } if (instructionSet != null) { argsForZygote.add(&quot;--instruction-set=&quot; + instructionSet); } if (appDataDir != null) { argsForZygote.add(&quot;--app-data-dir=&quot; + appDataDir); } if (invokeWith != null) { argsForZygote.add(&quot;--invoke-with&quot;); argsForZygote.add(invokeWith); } if (startChildZygote) { argsForZygote.add(&quot;--start-child-zygote&quot;); } argsForZygote.add(processClass); if (extraArgs != null) { for (String arg : extraArgs) { argsForZygote.add(arg); } } synchronized(mLock) { return zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote); }}// é€šè¿‡socket æ£€æŸ¥æ–°è¿›ç¨‹çš„å¯åŠ¨æƒ…å†µprivate static Process.ProcessStartResult zygoteSendArgsAndGetResult( ZygoteState zygoteState, ArrayList&lt;String&gt; args) throws ZygoteStartFailedEx { try { final BufferedWriter writer = zygoteState.writer; final DataInputStream inputStream = zygoteState.inputStream; writer.write(Integer.toString(args.size())); writer.newLine(); for (int i = 0; i &lt; sz; i++) { String arg = args.get(i); writer.write(arg); writer.newLine(); } writer.flush(); // Should there be a timeout on this? Process.ProcessStartResult result = new Process.ProcessStartResult(); // Always read the entire result from the input stream to avoid leaving // bytes in the stream for future process starts to accidentally stumble // upon. result.pid = inputStream.readInt(); result.usingWrapper = inputStream.readBoolean(); if (result.pid &lt; 0) { throw new ZygoteStartFailedEx(&quot;fork() failed&quot;); } return result; } catch (IOException ex) { zygoteState.close(); throw new ZygoteStartFailedEx(ex); }} 1ã€ Zygote è¿›ç¨‹forkZygote çš„fork è¿‡ç¨‹å‚è€ƒSystemService çš„å¯åŠ¨æµç¨‹ã€‚Zygote fork åä¹Ÿæ˜¯é€šè¿‡åå°„çš„æ–¹æ³•æ‰¾åˆ°ä¸€ä¸ªmain å‡½æ•°ï¼Œè¿™æ—¶å€™å› ä¸ºå¯åŠ¨çš„æ˜¯App è¿›ç¨‹ã€‚æ‰€ä»¥è¿™ä¸ªmain å‡½æ•°ä¸ºActivityThread çš„mainå‡½æ•°ã€‚ Appå‘èµ·è¿›ç¨‹ï¼šå½“ä»æ¡Œé¢å¯åŠ¨åº”ç”¨ï¼Œåˆ™å‘èµ·è¿›ç¨‹ä¾¿æ˜¯Launcheræ‰€åœ¨è¿›ç¨‹ï¼›å½“ä»æŸAppå†…å¯åŠ¨è¿œç¨‹è¿›ç¨‹ï¼Œåˆ™å‘é€è¿›ç¨‹ä¾¿æ˜¯è¯¥Appæ‰€åœ¨è¿›ç¨‹ã€‚å‘èµ·è¿›ç¨‹å…ˆé€šè¿‡binderå‘é€æ¶ˆæ¯ç»™system_serverè¿›ç¨‹ï¼› system_serverè¿›ç¨‹ï¼šè°ƒç”¨Process.start()æ–¹æ³•ï¼Œé€šè¿‡socketå‘zygoteè¿›ç¨‹å‘é€åˆ›å»ºæ–°è¿›ç¨‹çš„è¯·æ±‚ï¼› zygoteè¿›ç¨‹ï¼šåœ¨æ‰§è¡ŒZygoteInit.main()åä¾¿è¿›å…¥runSelectLoop()å¾ªç¯ä½“å†…ï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶ä¾¿ä¼šæ‰§è¡ŒZygoteConnection.runOnce()æ–¹æ³•ï¼Œå†ç»è¿‡å±‚å±‚è°ƒç”¨åforkå‡ºæ–°çš„åº”ç”¨è¿›ç¨‹ï¼› æ–°è¿›ç¨‹ï¼šæ‰§è¡ŒhandleChildProcæ–¹æ³•ï¼Œæœ€åè°ƒç”¨ActivityThread.main()æ–¹æ³•ã€‚ 2ã€ fork åçš„æ–°è¿›ç¨‹çš„ ActivityThreadfork ä»¥åå¯åŠ¨ActivityThread çš„main å‡½æ•°ï¼Œåœ¨Main å‡½æ•°ä¸­å®ŒæˆLooperçš„åˆå§‹åŒ–ï¼Œæœ€é‡è¦çš„ä¸€ä¸ªè°ƒç”¨å°±æ˜¯ attach 123456789101112131415161718192021222324252627282930313233343536public static void main(String[] args) { Process.setArgV0(&quot;&lt;pre-initialized&gt;&quot;); Looper.prepareMainLooper(); ActivityThread thread = new ActivityThread(); thread.attach(false, startSeq); if (sMainThreadHandler == null) { sMainThreadHandler = thread.getHandler(); } Looper.loop(); throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);}private void attach(boolean system, long startSeq) { sCurrentActivityThread = this; mSystemThread = system; if (!system) { android.ddm.DdmHandleAppName.setAppName(&quot;&lt;pre-initialized&gt;&quot;, UserHandle.myUserId()); RuntimeInit.setApplicationObject(mAppThread.asBinder()); final IActivityManager mgr = ActivityManager.getService(); try { mgr.attachApplication(mAppThread, startSeq); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } } else { }} AMS çš„ attachApplication12IActivityManager mgr = ActivityManager.getService();mgr.attachApplication(mAppThread, startSeq); AMS çš„attachApplication ä¾æ¬¡è°ƒç”¨äº†ApplicationThread çš„ bindApplication // åˆ›å»ºApplication scheduleTransaction(clientTransaction); // Resume Activity 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091ActivityMangerService.class:@Overridepublic final void attachApplication(IApplicationThread thread, long startSeq) { synchronized (this) { attachApplicationLocked(thread, callingPid, callingUid, startSeq); }}@GuardedBy(&quot;this&quot;)private final boolean attachApplicationLocked(IApplicationThread thread, int pid, int callingUid, long startSeq) { // It's possible that process called attachApplication before we got a chance to // update the internal state. try { if (app.isolatedEntryPoint != null) { } else if (app.instr != null) { thread.bindApplication(processName, appInfo, providers, app.instr.mClass, profilerInfo, app.instr.mArguments, app.instr.mWatcher, app.instr.mUiAutomationConnection, testMode, mBinderTransactionTrackingEnabled, enableTrackAllocation, isRestrictedBackupMode || !normalMode, app.persistent, new Configuration(getGlobalConfiguration()), app.compat, getCommonServicesLocked(app.isolated), mCoreSettingsObserver.getCoreSettingsLocked(), buildSerial, isAutofillCompatEnabled); } else { thread.bindApplication(processName, appInfo, providers, null, profilerInfo, null, null, null, testMode, mBinderTransactionTrackingEnabled, enableTrackAllocation, isRestrictedBackupMode || !normalMode, app.persistent, new Configuration(getGlobalConfiguration()), app.compat, getCommonServicesLocked(app.isolated), mCoreSettingsObserver.getCoreSettingsLocked(), buildSerial, isAutofillCompatEnabled); } } catch (Exception e) { } // See if the top visible activity is waiting to run in this process... if (normalMode) { try { if (mStackSupervisor.attachApplicationLocked(app)) { didSomething = true; } } catch (Exception e) { } } return true;}boolean attachApplicationLocked(ProcessRecord app) throws RemoteException { final String processName = app.processName; boolean didSomething = false; for (int displayNdx = mActivityDisplays.size() - 1; displayNdx &gt;= 0; --displayNdx) { final ActivityDisplay display = mActivityDisplays.valueAt(displayNdx); for (int stackNdx = display.getChildCount() - 1; stackNdx &gt;= 0; --stackNdx) { final ActivityStack stack = display.getChildAt(stackNdx); if (!isFocusedStack(stack)) { continue; } stack.getAllRunningVisibleActivitiesLocked(mTmpActivityList); final ActivityRecord top = stack.topRunningActivityLocked(); final int size = mTmpActivityList.size(); for (int i = 0; i &lt; size; i++) { final ActivityRecord activity = mTmpActivityList.get(i); if (activity.app == null &amp;&amp; app.uid == activity.info.applicationInfo.uid &amp;&amp; processName.equals(activity.processName)) { try { if (realStartActivityLocked(activity, app, top == activity /* andResume */, true /* checkConfig */)) { didSomething = true; } } catch (RemoteException e) { throw e; } } } } } return didSomething;} realStartActivityLocked è§ä¸‹äºŒã€realStartActivityLockedç®€è¿°ï¼šå®è´¨æ€§å¯åŠ¨Activityï¼Œé¦–å…ˆAMSæ¨åŠ¨åŒ…å«Launchäº‹åŠ¡å’ŒResumeç”Ÿå‘½å‘¨æœŸäº‹åŠ¡çš„ClientTransactionï¼ŒAppè¿›ç¨‹åœ¨ActivityThreadçš„handlerä¸­æ¥å—å¹¶å¤„ç†ï¼Œè°ƒç”¨handleLaunchActivity()-&gt;perfomLaunchActivity()ï¼Œæ­¤æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåå°„åˆ›å»ºäº†Activityå¯¹è±¡ï¼Œå¹¶è°ƒç”¨äº†activity.attach()ï¼Œä¹‹åæ‰§è¡ŒonCreateã€‚ 1ã€åˆ›å»ºæ·»åŠ activityäº‹åŠ¡å¹¶é€šè¿‡binderå°†äº‹åŠ¡äº¤äºˆåº”ç”¨è¿›ç¨‹æ‰§è¡Œ1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859//com.android.server.am.ActivityStackSupervisor#realStartActivityLocked//ä¸»è¦åˆ›å»ºäº‹åŠ¡äº¤ç»™æœ¬åœ°æ‰§è¡Œfinal boolean realStartActivityLocked(ActivityRecord r, ProcessRecord app, boolean andResume, boolean checkConfig) throws RemoteException { ... //åˆ›å»ºå¯åŠ¨activityçš„äº‹åŠ¡ClientTransactionå¯¹è±¡ // Create activity launch transaction. final ClientTransaction clientTransaction = ClientTransaction.obtain(app.thread, r.appToken); // æ·»åŠ LaunchActivityItemï¼Œè¯¥ç±»obtainå…¥å‚éƒ½æ˜¯åº”ç”¨è¿›ç¨‹ä¸­åˆ›å»ºActivityéœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼Œåˆ°æ—¶å€™ä¼šå°†è¿™äº›ä¿¡æ¯ç»„è£…æˆActivityClientRecordäº¤ç»™ActivityThreadçš„performLaunchActivityä½¿ç”¨ clientTransaction.addCallback(LaunchActivityItem.obtain(new Intent(r.intent), System.identityHashCode(r), r.info, mergedConfiguration.getGlobalConfiguration(), mergedConfiguration.getOverrideConfiguration(), r.compat, r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results, newIntents, mService.isNextTransitionForward(), profilerInfo)); // Set desired final state. //æ·»åŠ æ‰§è¡ŒResumeäº‹åŠ¡ResumeActivityItem,åç»­ä¼šåœ¨æœ¬åœ°è¢«æ‰§è¡Œ final ActivityLifecycleItem lifecycleItem; if (andResume) { lifecycleItem = ResumeActivityItem.obtain(mService.isNextTransitionForward()); } else { lifecycleItem = PauseActivityItem.obtain(); } clientTransaction.setLifecycleStateRequest(lifecycleItem); // ClientLifecycleManager.scheduleTransactionå°±æ˜¯è°ƒç”¨clientTransactionçš„scheduleå¯åŠ¨äº‹åŠ¡ç„¶åå›æ”¶clientTransaction // è¿™é‡Œçš„mServiceå°±æ˜¯AMS // è®°ä½ä¸Šé¢ä¸¤ä¸ªitemï¼šLaunchActivityItemå’ŒResumeActivityItemï¼Œè¿™æ˜¯äº‹åŠ¡çš„æ‰§è¡Œå•ä½ mService.getLifecycleManager().scheduleTransaction(clientTransaction);} -&gt;com.android.server.am.ClientLifecycleManager#scheduleTransaction(ClientTransaction) { //æŠŠäº‹åŠ¡äº¤ç»™æœ¬åœ°ActivityThreadæ‰§è¡Œã€‚è¿™é‡Œé€šè¿‡æœ¬åœ°ApplicationThreadåœ¨æœåŠ¡ç«¯çš„æ¥å£IApplicationThreadæ¥è¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡ã€‚åé¢çš„é€»è¾‘å°±å›åˆ°äº†åº”ç”¨ç¨‹åºè¿›ç¨‹äº†ã€‚ void scheduleTransaction(ClientTransaction transaction) throws RemoteException { final IApplicationThread client = transaction.getClient(); transaction.schedule(); if (!(client instanceof Binder)) { transaction.recycle(); } }} -&gt;//è¿™é‡Œçš„IApplicationThreadæ˜¯è¦å¯åŠ¨è¿›ç¨‹çš„ IBinder æ¥å£//ApplicationThreadæ˜¯ActivityThreadçš„å†…éƒ¨ç±»ï¼ŒIApplicationThreadæ˜¯IBinderä»£ç†æ¥å£//è¿™é‡Œå°†é€»è¾‘è½¬åˆ°åº”ç”¨è¿›ç¨‹ä¸­æ‰§è¡Œprivate IApplicationThread mClient;public void schedule() throws RemoteException { mClient.scheduleTransaction(this);} â€”â€”â€”â€”â€” system_serverè¿›ç¨‹ä¸åº”ç”¨è¿›ç¨‹åˆ‡æ¢çš„åˆ†å‰²çº¿ â€”â€”â€”â€”â€”-é€šè¿‡AIDLæ–¹å¼åˆå›åˆ°åº”ç”¨è¿›ç¨‹äº†ï¼Œè°ƒç”¨äº†IApplicationThread.scheduleTransaction() 2ã€å›åˆ°åº”ç”¨è¿›ç¨‹åActivityThreadæ‰§è¡Œäº‹åŠ¡åˆ›å»ºActivity ApplicationThread.classæ˜¯ â€œAIDLæ¥å£â€”â€” IApplicationThreadæ¥å£å…·ä½“å®ç°â€ï¼Œæ˜¯ActivityThreadçš„å†…éƒ¨ç±»ï¼Œå…¶å®šä¹‰äº†æœåŠ¡çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ (RPC) æ¥å£ï¼Œå³æœ¬åœ°è¿›ç¨‹æä¾›ç»™å…¶ä»–è¿›ç¨‹é€šè¿‡IPCæœºåˆ¶è°ƒç”¨çš„æ¥å£ï¼šå¦‚æ›´æ–°è¿›ç¨‹çŠ¶æ€updateProcessStateï¼ŒscheduleTransaction System private API for communicating with the application. This is given to the activity manager by an application when it starts up, for the activity manager to tell the application about things it needs to do. ç”¨äºä¸åº”ç”¨ç¨‹åºé€šä¿¡çš„ç³»ç»Ÿç§æœ‰APIã€‚ è¿™æ˜¯åº”ç”¨ç¨‹åºåœ¨å¯åŠ¨æ—¶ç»™AMSçš„ï¼Œä»¥ä¾¿AMSå‘Šè¯‰åº”ç”¨ç¨‹åºå®ƒéœ€è¦åšçš„äº‹æƒ…ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162//ActivityThread#ApplicationThread.class//ApplicationThread extends IApplicationThread.Stubpublic void scheduleTransaction(ClientTransaction transaction) throws RemoteException { //ActivityThread ç»§æ‰¿ ClientTransactionHandler çš„scheduleTransactionæ–¹æ³• ActivityThread.this.scheduleTransaction(transaction);}//abstract ClientTransactionHandler.classvoid scheduleTransaction(ClientTransaction transaction) { //ä¸»è¦æ˜¯æ›´æ–°åº”ç”¨è¿›ç¨‹çŠ¶æ€see@ LaunchActivityItemã€ResumeActivityItem preExecute transaction.preExecute(this); //é€šè¿‡Handlerå‘é€whatä¸ºEXECUTE_TRANSACTIONï¼Œobjä¸ºtransactionçš„æ¶ˆæ¯ï¼Œå³ActivityThreadä¸­Hanlderå®ç°H.classå¤„ç† sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);}abstract void sendMessage(int what, Object obj);//ActivityThread.class/* */final H mH = new H();private final TransactionExecutor mTransactionExecutor = new TransactionExecutor(this);void sendMessage(int what, Object obj) { sendMessage(what, obj, 0, 0, false);}private void sendMessage(int what, Object obj, int arg1, int arg2, boolean async) { if (DEBUG_MESSAGES) Slog.v( TAG, &quot;SCHEDULE &quot; + what + &quot; &quot; + mH.codeToString(what) + &quot;: &quot; + arg1 + &quot; / &quot; + obj); Message msg = Message.obtain(); msg.what = what; msg.obj = obj; msg.arg1 = arg1; msg.arg2 = arg2; if (async) { msg.setAsynchronous(true); } mH.sendMessage(msg);}//class H extends Handler public static final int EXECUTE_TRANSACTION = 159;public void handleMessage(Message msg) { if (DEBUG_MESSAGES) Slog.v(TAG, &quot;&gt;&gt;&gt; handling: &quot; + codeToString(msg.what)); switch (msg.what) { case EXECUTE_TRANSACTION: final ClientTransaction transaction = (ClientTransaction) msg.obj; mTransactionExecutor.execute(transaction); if (isSystem()) { transaction.recycle(); } break; }}//å…¶å®è¿˜æ˜¯é‚£å¥è¯ï¼Œäº‹åŠ¡(LaunchActivityItemä¸ResumeActivityItem)ä»system_serverä¸­é€šè¿‡AIDLçš„IPCæ–¹å¼ï¼Œä¸¢åˆ°åº”ç”¨è¿›ç¨‹ä¸­çš„ActivityThreadçš„handlerä¸­æ‰§è¡Œäº‹åŠ¡çš„executeæ–¹æ³•ã€‚ a. LaunchActivityItem/ResumeActivityItem preExecute/execute123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106/* è§ä¸Š ActivityStackSupervisor.realStartActivityLocked()ä¸­ { ClientTransaction.addCallback(LaunchActivityItem...) clientTransaction.setLifecycleStateRequest(ResumeActivityItemå®ä¾‹lifecycleItem); } //ClientTransaction.class public void setLifecycleStateRequest(ActivityLifecycleItem stateRequest) { mLifecycleStateRequest = stateRequest; } public void addCallback(ClientTransactionItem activityCallback) { if (mActivityCallbacks == null) { mActivityCallbacks = new ArrayList&lt;&gt;(); } mActivityCallbacks.add(activityCallback); }*///ClientTransaction.java;public void preExecute(android.app.ClientTransactionHandler clientTransactionHandler) { if (mActivityCallbacks != null) { final int size = mActivityCallbacks.size(); for (int i = 0; i &lt; size; ++i) {mActivityCallbacks.get(i).preExecute(clientTransactionHandler, mActivityToken); } } if (mLifecycleStateRequest != null) { mLifecycleStateRequest.preExecute(clientTransactionHandler, mActivityToken); }}//TransactionExecutor.class//(å…¶å®å°±æ˜¯ActivityThreadï¼Œä¾èµ–å€’ç½®)private ClientTransactionHandler mTransactionHandler;public TransactionExecutor(ClientTransactionHandler clientTransactionHandler) { mTransactionHandler = clientTransactionHandler;}public void execute(ClientTransaction transaction) { final IBinder token = transaction.getActivityToken(); log(&quot;Start resolving transaction for client: &quot; + mTransactionHandler + &quot;, token: &quot; + token); executeCallbacks(transaction); executeLifecycleState(transaction); mPendingActions.clear(); log(&quot;End resolving transaction&quot;);} -&gt; public void executeCallbacks(ClientTransaction transaction) { final int size = callbacks.size(); for (int i = 0; i &lt; size; ++i) { final ClientTransactionItem item = callbacks.get(i); item.execute(mTransactionHandler, token, mPendingActions); item.postExecute(mTransactionHandler, token, mPendingActions); }} private void executeLifecycleState(ClientTransaction transaction) { final ActivityLifecycleItem lifecycleItem = transaction.getLifecycleStateRequest(); lifecycleItem.execute(mTransactionHandler, token, mPendingActions); lifecycleItem.postExecute(mTransactionHandler, token, mPendingActions);}//preExecuteåœ¨executeå‰å‡†å¤‡å®¢æˆ·ç«¯è¯·æ±‚ã€‚è¿™æ–¹é¢çš„ä¸€ä¸ªä¾‹å­å¯èƒ½æ˜¯é€šçŸ¥æŸäº›å€¼çš„æŒ‚èµ·æ›´æ–°ã€‚ps:æ›´æ–°è¿›ç¨‹çŠ¶æ€//executeæ‰§è¡Œè¯·æ±‚//postExecuteæ‰§è¡Œexecuteåéœ€è¦æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œï¼Œä¾‹å¦‚å°†ç»“æœæŠ¥å‘Šç»™æœåŠ¡å™¨ã€‚ //LaunchActivityItem.class extends ClientTransactionItem (Parcelable implementation) @Overridepublic void preExecute(ClientTransactionHandler client, IBinder token) { // client.updateProcessState(mProcState, false); client.updatePendingConfiguration(mCurConfig);} public void execute(ClientTransactionHandler client, IBinder token, PendingTransactionActions pendingActions) { Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, &quot;activityStart&quot;); //ActivityClientRecordå°±æ˜¯åº”ç”¨è¿›ç¨‹ä¸­çš„Activityä¿¡æ¯ï¼Œä¸ä¹‹å¯¹åº”çš„æ˜¯system_serverä¸­ActivityRecordç±»ï¼Œæ˜¯ç³»ç»Ÿè¿›ç¨‹ä¸­çš„Activityä¿¡æ¯ ActivityClientRecord r = new ActivityClientRecord(token, mIntent, mIdent, mInfo, mOverrideConfig, mCompatInfo, mReferrer, mVoiceInteractor, mState, mPersistentState,mPendingResults, mPendingNewIntents, mIsForward,mProfilerInfo, client); //è¿™é‡Œçš„clientå…¶å®ActivityThread client.handleLaunchActivity(r, pendingActions, null /* customIntent */); Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);}//ResumeActivityItem.class extends ClientTransactionItem ActivityLifecycleItem extends ClientTransactionItem (Parcelable implementation)@Overridepublic void preExecute(ClientTransactionHandler client, IBinder token) { if (mUpdateProcState) { client.updateProcessState(mProcState, false); }}@Overridepublic void execute(ClientTransactionHandler client, IBinder token, PendingTransactionActions pendingActions) { Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, &quot;activityResume&quot;); client.handleResumeActivity(token, true /* finalStateRequest */, mIsForward, &quot;RESUME_ACTIVITY&quot;); Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);} ä»¥å¯åŠ¨activityçš„LaunchActivityItem.execute()ä¸­client.handleLaunchActivity(r, pendingActions, null /* customIntent */);ä¸ºæ ¸å¿ƒåˆ†æåº”ç”¨è¿›ç¨‹ä¸­ActivityThreadä¸­å¯åŠ¨Activityçš„æµç¨‹ã€‚ b. handleLaunchActivity()123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117//ActivityThread.class@Overridepublic Activity handleLaunchActivity(ActivityClientRecord r, PendingTransactionActions pendingActions, Intent customIntent) { // Initialize before creating the activity if (!ThreadedRenderer.sRendererDisabled) { //éç³»ç»Ÿè¿›ç¨‹æ‰èƒ½æ¸²æŸ“ GraphicsEnvironment.earlyInitEGL(); } WindowManagerGlobal.initialize(); final Activity a = performLaunchActivity(r, customIntent);} -&gt; private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) { //packageä¿¡æ¯ ActivityInfo aInfo = r.activityInfo; if (r.packageInfo == null) { r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo, Context.CONTEXT_INCLUDE_CODE); } // è·å–activityçš„åŒ…åç±»å‹ä¿¡æ¯ ComponentName component = r.intent.getComponent(); if (component == null) { component = r.intent.resolveActivity( mInitialApplication.getPackageManager()); r.intent.setComponent(component); } if (r.activityInfo.targetActivity != null) { component = new ComponentName(r.activityInfo.packageName, r.activityInfo.targetActivity); } // åˆ›å»ºcontextä¸Šä¸‹æ–‡ ContextImpl appContext = createBaseContextForActivity(r); // åå°„åˆ›å»ºActivityå¯¹è±¡(å·¥å‚æ¨¡å¼) Activity activity = null; try { java.lang.ClassLoader cl = appContext.getClassLoader(); activity = mInstrumentation.newActivity( cl, component.getClassName(), r.intent); StrictMode.incrementExpectedActivityCount(activity.getClass()); r.intent.setExtrasClassLoader(cl); r.intent.prepareToEnterProcess(); if (r.state != null) { r.state.setClassLoader(cl); } } catch (Exception e) { if (!mInstrumentation.onException(activity, e)) { throw new RuntimeException( &quot;Unable to instantiate activity &quot; + component + &quot;: &quot; + e.toString(), e); } try { //è·å–Applicationå•ä¾‹ï¼ˆåœ¨ActivityThread.attachæ—¶åˆ›å»ºï¼‰ Application app = r.packageInfo.makeApplication(false, mInstrumentation); if(activity != null) { // ä¸ºActivityæ·»åŠ window,ä¹‹åç§»é™¤å¯¹è±¡ Window window = null; if (r.mPendingRemoveWindow != null &amp;&amp; r.mPreserveWindow) { window = r.mPendingRemoveWindow; r.mPendingRemoveWindow = null; r.mPendingRemoveWindowManager = null; } //onAttach activity.attach(appContext, this, getInstrumentation(), r.token, r.ident, app, r.intent, r.activityInfo, title, r.parent, r.embeddedID, r.lastNonConfigurationInstances, config, r.referrer, r.voiceInteractor, window, r.configCallback); //onCreate mInstrumentation.callActivityOnCreate(activity, r.state); } }}//LoadedApk.class public Application makeApplication(boolean forceDefaultAppClass,Instrumentation instrumentation) { //åªæœ‰ä¸€ä¸ªapplicationï¼Œåœ¨åº”ç”¨åˆå§‹åŒ–æ—¶æ‰ä¼šèµ°åˆ°æ­¤æ–¹æ³•åé¢çš„æµç¨‹ if (mApplication != null) { return mApplication; } Application app = null; try { java.lang.ClassLoader cl = getClassLoader(); ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, this); //newApplicationåå°„åˆ›å»ºApplication(å·¥å‚æ¨¡å¼)åä¼šé¡ºæ‰‹è°ƒä¸€ä¸‹app.attach(context); app = mActivityThread.mInstrumentation.newApplication(cl, appClass, appContext); appContext.setOuterContext(app); } catch (Exception e) { //... } if (instrumentation != null) { try { //å…·ä½“å®ç°å°±app.onCreate(); instrumentation.callApplicationOnCreate(app); } catch (Exception e) { if (!instrumentation.onException(app, e)) { Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); throw new RuntimeException( &quot;Unable to create application &quot; + app.getClass().getName() + &quot;: &quot; + e.toString(), e); } } }} 003ï¼šActivity.Attach()ç®€è¿°ï¼šé¦–å…ˆåˆå§‹åŒ–Windowï¼Œå…·ä½“å®ç°ç±»æ˜¯PhoneWindowã€‚ä¸ºå…¶è®¾ç½®WindowMangerï¼ˆå…·ä½“å®ç°ç±»ä¸ºWindowManagerImplï¼‰ åœ¨Activityçš„attachæ–¹æ³•ä¸­ï¼Œå¾ˆå…³é”®çš„ä¸€ç‚¹å°±æ˜¯åˆå§‹åŒ–Windowï¼Œä»è¿™é‡Œå°±èƒ½çœ‹åˆ°ï¼ŒWindowçš„å®ç°ç±»ï¼Œæ˜¯PhoneWindowã€‚PhoneWindowçš„åˆ›å»ºå¯¹äºæˆ‘ä»¬åé¢çš„æ“ä½œå¾ˆé‡è¦ã€‚ mWindowæ˜¯ä¸€ä¸ªWindowç±»å‹çš„å˜é‡ï¼Œä½†å®é™…ä¸Šå®ƒæ˜¯ä¸€ä¸ªPhoneWindowå¯¹è±¡ï¼Œä¸Activityçš„å†…å®¹æ˜¾ç¤ºç›¸å…³ã€‚ 123456789101112131415161718192021222324final void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config) { attachBaseContext(context); mFragments.attachActivity(this, mContainer, null); mWindow = PolicyManager.makeNewWindow(this); ... //å°†å„ç§å‚æ•°èµ‹ç»™Activityçš„æˆå‘˜å˜é‡ mWindow.setWindowManager( (WindowManager)context.getSystemService(Context.WINDOW_SERVICE), mToken, mComponent.flattenToString(), (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0); if (mParent != null) { mWindow.setContainer(mParent.getWindow()); } mWindowManager = mWindow.getWindowManager(); mCurrentConfig = config;} 004ï¼šActivity.onCreate()ç®€è¿°ï¼šonCreate()-&gt;setContentView()-&gt;PhoneWindow.setContentView()ï¼Œåœ¨è¿™é‡Œåˆå§‹åŒ–äº†æœ€é¡¶å±‚Viewï¼ˆFrameLayoutï¼‰DecorViewï¼›å¹¶å°†layoutResIDé€šè¿‡LayoutInflateå¡«å……åæ·»åŠ åˆ°DecorViewä¸­ã€‚ 123456789101112public void setContentView(View view, ViewGroup.LayoutParams params) { if (mContentParent == null) { installDecor(); } else { mContentParent.removeAllViews(); } mContentParent.addView(view, params); final Callback cb = getCallback(); if (cb != null &amp;&amp; !isDestroyed()) { cb.onContentChanged(); }} 005ï¼šActivityThread.handleResumeActivity()ç®€è¿°ï¼š æ ¸å¿ƒå°±æ˜¯å…ˆè°ƒç”¨onResume()ï¼Œ ç„¶åå†è°ƒç”¨Window#addView(Windowä¹Ÿå°±æ˜¯ä¸Šé¢activity.attach()ä¸­åˆå§‹åŒ–çš„PhoneWindow)ã€‚æ¥ä¸‹æ¥å°±æ˜¯èµ°åˆ°WindowManagerï¼ˆå…·ä½“å®ç°åœ¨WindowManagerGlobalä¸­ï¼‰çš„addView()ã€‚é¦–å…ˆåˆ›å»ºViewRootImplç„¶åè°ƒç”¨å®ƒçš„setViewï¼ŒsetViewä¸­æœ€å…³é”®çš„å°±æ˜¯å°±æ˜¯è°ƒç”¨äº†requestLayout()ç„¶åæ³¨å†ŒVsyncå›è°ƒå›æ¥åViewRootImpl.performTraversals()ï¼Œå…¶ä¸­å…ˆæ‰§è¡Œäº†dispatchAttachToWindowï¼ˆView.postçš„ç¼“å­˜actionæ‰§è¡Œï¼‰ï¼Œåèµ°äº†performMeasureã€performLayoutã€performDrawæµ‹ç»˜ä¸‰å¤§æµç¨‹ performResumeActivity Window#addView new ViewRootImpl() ViewRootImpl.setView() ViewRootImpl.requestLayout() ViewRootImpl.scheduleTraversals() ViewRootImpl.doTraversal(); ViewRootImpl.performTraversals(); 0xFF: é™„å½•é™„å½•ä¸€ execStartActivityAndroid 6.0/9.0/10.0 Instrumentation#execStartActivity123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566...//Android 6 //ActivityManagerNative.getDefault()æ‹¿åˆ°çš„å¯¹è±¡æ˜¯ActivityManagerProxyï¼Œè¿™ä¸ªç±»åˆå§‹åŒ–æ—¶å³æ„é€ ä¼ å…¥AMSï¼ˆServiceManager.getService(&quot;activity&quot;)ï¼‰ï¼Œç”±ActivityManagerProxyä»£ç†AMSæ‰§è¡ŒstartActivityæ–¹æ³• ActivityManagerNative.getDefault() .startActivity(whoThread, who.getBasePackageName(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target != null ? target.mEmbeddedID : null, requestCode, 0, null, options); /** * Retrieve the system's default/global activity manager. */static public IActivityManager getDefault() { return gDefault.get();} private static final Singleton&lt;IActivityManager&gt; gDefault = new Singleton&lt;IActivityManager&gt;() { protected IActivityManager create() { IBinder b = ServiceManager.getService(&quot;activity&quot;); ... IActivityManager am = asInterface(b); ... return am; } }; //Android 9 ActivityManagerProxyç±»å·²ç»è¢«å»æ‰äº†ï¼Œ ActivityManger.getService è·å– AMS çš„å•ä¾‹å®ä¾‹ï¼Œç„¶åè°ƒç”¨å…¶ startActivity æ–¹æ³•ï¼Œå®é™…ä¸Šè¿™é‡Œå°±æ˜¯é€šè¿‡ AIDL æ¥è°ƒç”¨ AMS çš„ startActivity æ–¹æ³•ã€‚ActivityManager.getService() .startActivity(whoThread, who.getBasePackageName(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target != null ? target.mEmbeddedID : null, requestCode, 0, null, options); public static IActivityManager getService() { return IActivityManagerSingleton.get(); }private static final Singleton&lt;IActivityManager&gt; IActivityManagerSingleton = new Singleton&lt;IActivityManager&gt;() { @Override protected IActivityManager create() { final IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE); final IActivityManager am = IActivityManager.Stub.asInterface(b); return am; } }; //Andorid 10 æ–°å¢äº†ä¸€å±‚ActivityTaskManageræ¥ç®¡ç†activityä»»åŠ¡ï¼ŒAIDLæ–¹å¼å‘ServiceManagerè·å–ACTIVITY_TASK_SERVICEæœåŠ¡å•ä¾‹ï¼Œå…¶å…·æœ‰IActivityTaskManagerçš„æ–¹æ³•å®ç°ï¼ˆåŒ…æ‹¬startActivityï¼‰int result = ActivityTaskManager.getService() .startActivity(whoThread, who.getBasePackageName(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target != null ? target.mEmbeddedID : null, requestCode, 0, null, options);android.app.ActivityTaskManager#getService... @UnsupportedAppUsage(trackingBug = 129726065) private static final Singleton&lt;IActivityTaskManager&gt; IActivityTaskManagerSingleton = new Singleton&lt;IActivityTaskManager&gt;() { @Override protected IActivityTaskManager create() { final IBinder b = ServiceManager.getService(Context.ACTIVITY_TASK_SERVICE); return IActivityTaskManager.Stub.asInterface(b); } }; é™„å½•äºŒ startPausingLockedActivityStack#startPausingLocked1234567891011ActivityStack#startPausingLocked{//...//PauseActivityItemç»§æ‰¿äºActivityLifecycleItemï¼Œåˆç»§æ‰¿äºClientTransactionItem,æ˜¯Activityè´Ÿè´£æš‚åœçš„äº‹åŠ¡ç±»ã€‚åŒæ ·ç»§æ‰¿äºActivityLifecycleItemçš„è´Ÿè´£Activityç”Ÿå‘½å‘¨æœŸçš„ç±»è¿˜æœ‰ResumeActivityItemã€StopActivityItemç­‰ã€‚ActivityLifecycleItemç›¸æ¯”å…¶çˆ¶ç±»å¤šäº†çŠ¶æ€çš„è¯·æ±‚ï¼ˆäº‹åŠ¡æ‰§è¡Œåå®¢æˆ·ç«¯æ´»åŠ¨åº”è¯¥å¤„äºçš„æœ€åç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼‰mService.getLifecycleManager().scheduleTransaction(prev.app.thread, prev.appToken, PauseActivityItem.obtain(prev.finishing, userLeaving, prev.configChangeFlags, pauseImmediately));//...}-&gt; ActivityManager : DisplayActivityManager : Display / startActivity Android6/7 ç®€å•ç»“è®ºï¼šdisplay åªç»Ÿè®¡A onPauseä¹‹å AMS å¯åŠ¨æ–°ActivityB å¹¶ æ‰§è¡Œ Bçš„onCreateã€onstartã€onresume ä¸ Bå‘WMSæ³¨å†Œçª—å£åˆ°ç¼–èˆè€…å‘èµ·çš„ç¬¬ä¸€æ¬¡æµ‹ç»˜ å®Œæˆ Activityçš„å¯åŠ¨å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼Œä»¥ActivityAå¯åŠ¨ActivityBä¸ºä¾‹ï¼Œä¸‰æ­¥éª¤åˆ†åˆ«ä¸ºï¼š ä»¥ActivityAè°ƒç”¨startActivityï¼Œåˆ°ActivityAæˆåŠŸpauseä¸ºæ­¢ displayTimeStart ActivityBæˆåŠŸåˆå§‹åŒ–ï¼Œåˆ°æ‰§è¡Œå®Œresumeä¸ºæ­¢ ActivityBå‘WSMæ³¨å†Œçª—å£ï¼Œåˆ°ç¬¬ä¸€å¸§ç»˜åˆ¶å®Œæˆä¸ºæ­¢displayTimeEnd ActiivtyA Pauseæµç¨‹å½“ActivityAä½¿ç”¨startActivityæ–¹æ³•å¯åŠ¨ActivityBæ—¶ï¼Œæ‰§è¡Œå‡½æ•°é“¾è·¯å¦‚ä¸‹ 1234567891011121314151617181920212223242526//Android 6.0/7.0ActivityA.startActivity-&gt;Instrumentation.execStartActivity-&gt;ActivityManagerNative.getDefault.startActivity-&gt;ActivityManagerService.startActivityAsUser-&gt;ActivityStarter.startActivityMayWait -&gt;ActivityStarter.startActivityLocked -&gt;ActivityStarter.startActivityUnchecked-&gt;ActivityStackSupervisor.resumeFocusedStackTopActivityLocked-&gt;ActivityStack.resumeTopActivityUncheckedLocked -&gt; ActivityStack.resumeTopActivityInnerLocked{ //startPausingLocked() æš‚åœæ—§Activity //startSpecificActivityLocked(next, true, false);} -&gt; ActivityStack.startPausingLocked -&gt; ActivityThread#ApplicationThread.schedulePauseActivity-&gt;ActivityThread.handlePauseActivity-&gt; â””ActivityA.onPauseActivityManagerNative.getDefault().activityPaused å½“Appè¯·æ±‚AMSè¦å¯åŠ¨ä¸€ä¸ªæ–°é¡µé¢çš„æ—¶å€™ï¼ŒAMSé¦–å…ˆä¼špauseæ‰å½“å‰æ­£åœ¨æ˜¾ç¤ºçš„Activityï¼Œå½“ç„¶ï¼Œè¿™ä¸ªActivityå¯èƒ½ä¸è¯·æ±‚è¦å¼€å¯çš„Activityä¸åœ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œæ¯”å¦‚ç‚¹å‡»æ¡Œé¢å›¾æ ‡å¯åŠ¨App,å½“å‰è¦æš‚åœçš„Activityå°±æ˜¯æ¡Œé¢ç¨‹åºLauncherã€‚åœ¨onPauseå†…æ‰§è¡Œè€—æ—¶æ“ä½œæ˜¯ä¸€ç§å¾ˆä¸æ¨èçš„åšæ³•ï¼Œä»ä¸Šè¿°è°ƒç”¨é“¾è·¯å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœåœ¨onPauseå†…æ‰§è¡Œäº†è€—æ—¶æ“ä½œï¼Œä¼šç›´æ¥å½±å“åˆ°ActivityManagerNative.getDefault().activityPaused()æ–¹æ³•çš„æ‰§è¡Œï¼Œè€Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯é€šçŸ¥AMSï¼Œâ€œå½“å‰Activityå·²ç»å·²ç»æˆåŠŸæš‚åœï¼Œå¯ä»¥å¯åŠ¨æ–°Activityäº†â€ã€‚ ActivityB Launchæµç¨‹åœ¨AMSæ¥æ”¶åˆ°Appè¿›ç¨‹å¯¹äºactivityPausedæ–¹æ³•çš„è°ƒç”¨åï¼Œæ‰§è¡Œå‡½æ•°é“¾è·¯å¦‚ä¸‹ 12345678910111213141516//ActivityStack.resumeTopActivityInnerLocked -&gt;ActivityStackSupervisor.startSpecificActivityLocked-&gt; -&gt; //displayStartTime â””1.å¯åŠ¨æ–°è¿›ç¨‹ï¼šActivityManagerService.startProcessLocked æš‚ä¸å±•å¼€ â””2.å½“å‰è¿›ç¨‹ï¼šActivityStackSupervisor.realStartActivityLocked-&gt;ActivityThread?ApplicationThread.scheduleLaunchActivity-&gt;Activity.handleLaunchActivity-&gt; â””Activity.onCreate â””Activity.onRestoreInstanceState â””handleResumeActivity â””Activity.onStart-&gt; â””Activity.onResume-&gt; â””WindowManager.addView-&gt; AMSåœ¨ç»è¿‡ä¸€ç³»åˆ—æ–¹æ³•è°ƒç”¨åï¼Œé€šçŸ¥Appè¿›ç¨‹æ­£å¼å¯åŠ¨ä¸€ä¸ªActviityï¼Œæ³¨æ„å¦‚æœè¦å¯åŠ¨Activityæ‰€åœ¨è¿›ç¨‹ä¸å­˜åœ¨ï¼Œæ¯”å¦‚ç‚¹å‡»æ¡Œé¢å›¾æ ‡ç¬¬ä¸€æ¬¡æ‰“å¼€åº”ç”¨ï¼Œæˆ–è€…Appæœ¬èº«å°±æ˜¯å¤šè¿›ç¨‹çš„ï¼Œè¦å¯åŠ¨çš„æ–°é¡µé¢å¤„äºå¦å¤–ä¸€ä¸ªè¿›ç¨‹ï¼Œé‚£å°±éœ€è¦èµ°åˆ°ActivityManagerService.startProcessLockedæµç¨‹ï¼Œç­‰æ–°è¿›ç¨‹å¯åŠ¨å®Œæ¯•åå†é€šçŸ¥AMSï¼Œè¿™é‡Œä¸å±•å¼€ã€‚æŒ‰ç…§æ­£å¸¸æµç¨‹ï¼Œä¼šä¾æ¬¡èµ°è¿‡Activityç”Ÿå‘½å‘¨æœŸå†…çš„onCreateã€onRestoreInstanceStateã€onStartã€onResumeæ–¹æ³•ï¼Œè¿™ä¸€æ­¥çš„è€—æ—¶åŸºæœ¬ä¹Ÿå¯ä»¥çœ‹æˆå°±æ˜¯è¿™å››ä¸ªæ–¹æ³•çš„è€—æ—¶ï¼Œç”±äºè¿™å››ä¸ªæ–¹æ³•æ˜¯åŒæ­¥è°ƒç”¨çš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä»¥onCreateæ–¹æ³•ä¸ºèµ·ç‚¹ï¼ŒonResumeæ–¹æ³•ä¸ºç»ˆç‚¹ï¼Œç»Ÿè®¡å‡ºè¿™ä¸€æ­¥éª¤çš„æ€»è€—æ—¶ã€‚ ActivityB Renderæµç¨‹åœ¨ActivityBæ‰§è¡Œå®ŒonResumeæ–¹æ³•åï¼Œå°±å¯ä»¥æ˜¾ç¤ºè¯¥Activityäº†ï¼Œè°ƒç”¨æµç¨‹å¦‚ä¸‹ 1234567WindowManager.addView-&gt;WindowManagerImpl.addView-&gt;ViewRootImpl.setView-&gt;ViewRootImpl.requestLayout-&gt; â””ViewRootImpl.scheduleTraversals-&gt; â””Choreographer.postCallback-&gt;WindowManagerSerivce.add è¿™ä¸€æ­¥çš„æ ¸å¿ƒå®é™…ä¸Šæ˜¯Choreographer.postCallbackï¼Œå‘Choreographeræ³¨å†Œäº†ä¸€ä¸ªå›è°ƒï¼Œå½“Vsyncäº‹ä»¶åˆ°æ¥æ—¶ï¼Œå°±ä¼šæ‰§è¡Œä¸‹é¢çš„å›è°ƒè¿›è¡Œuiçš„æ¸²æŸ“ 123456789ViewRootImpl.doTraversal-&gt;ViewRootImpl.performTraversals-&gt; â””ViewRootImpl.relayoutWindow â””ViewRootImpl.performMeasure â””ViewRootImpl.performLayout â””ViewRootImpl.performDrawViewRootImpl.reportDrawFinished...reportLaunchTimeLocked è¿™é‡Œåˆ†åˆ«æ‰§è¡Œäº†performMeasureã€performLayoutã€performDrawï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹åº”åˆ°DecorViewçš„æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶ä¸‰ä¸ªæµç¨‹ã€‚ç”±äºAndroidçš„UIæ˜¯ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œä½œä¸ºæ ¹Viewçš„DecorViewçš„æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶ï¼Œä¼šè°ƒç”¨åˆ°æ‰€æœ‰å­Viewç›¸åº”çš„æ–¹æ³•ï¼Œå› æ­¤ï¼Œè¿™ä¸€æ­¥çš„æ€»è€—æ—¶å°±æ˜¯æ‰€æœ‰å­Viewåœ¨æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶ä¸­çš„è€—æ—¶ä¹‹å’Œï¼Œå¦‚æœæŸä¸ªå­Viewåœ¨è¿™ä¸‰ä¸ªæ–¹æ³•ä¸­å¦‚æœè¿›è¡Œäº†è€—æ—¶æ“ä½œï¼Œå°±ä¼šæ‹–æ…¢æ•´ä¸ªUIçš„æ¸²æŸ“ï¼Œè¿›è€Œå½±å“Activityç¬¬ä¸€å¸§çš„æ¸²æŸ“é€Ÿåº¦ã€‚ ä»Windowè§†è§’çœ‹ActivityStartå½“ä»Windowçš„è§’åº¦çœ‹å¾…Activityçš„å¯åŠ¨è¿‡ç¨‹æ—¶ï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹æµç¨‹ï¼š åœ¨ç›®æ ‡è¿›ç¨‹ä¸­ï¼Œæ‰§è¡ŒActivity.handleLaunchActivityæ–¹æ³•ï¼Œä¼šå…ˆè·å–AMSæœåŠ¡ï¼Œä¹‹åè°ƒç”¨Activity.performLaunchActivity å›è°ƒç›®æ ‡Activityçš„onAttachæ–¹æ³•ï¼Œåˆå§‹åŒ–WindowåŠWindowç›¸å…³å¯¹è±¡ï¼Œå¦‚PhoneWindowã€Tokenç­‰ã€‚ mWindow = new PhoneWindow(this, window, activityConfigCallback); ä¹‹åå›è°ƒç›®æ ‡Activityçš„onCreateæ–¹æ³•ï¼Œç„¶åé€šè¿‡setContentViewæ–¹æ³•åˆ›å»ºä¸€ä¸ªDecorViewå¯¹è±¡ï¼› åœ¨ç›®æ ‡è¿›ç¨‹ä¸­ï¼Œæ‰§è¡ŒActivity.handleResumeActivityæ–¹æ³•ï¼Œä¼šå›è°ƒç›®æ ‡Activityçš„onResumeæ–¹æ³•ï¼Œç„¶åè°ƒç”¨ç›®æ ‡Activityçš„makeVisibleæ–¹æ³•ï¼›åœ¨makeVisibleæ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨WindowManagerImpl.addViewæ–¹æ³•ç»˜åˆ¶Viewï¼Œå¹¶é€šè¿‡Binderè¿œç¨‹è°ƒç”¨WMSæ·»åŠ Windowã€‚ViewManager wm = getWindowManager();wm.addView(mDecor, getWindow().getAttributes());","link":"/2021/07/30/ActivityStart/"},{"title":"CodeOptimization","text":"# ä»£ç ä¼˜åŒ–1ï¼šçº¯å‡½æ•°çº¯å‡½æ•°æ˜¯å‡½æ•°ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯ä¸€ä¸ªæ–¹æ³•å‡½æ•°ï¼Œå°±åƒä¸€ä¸ªæ•°å­¦çš„å‡½æ•°å¼ä¸€æ ·ï¼ŒåŒæ ·çš„å‚æ•°è¾“å…¥ä¼šå¾—åˆ°åŒæ ·çš„è¾“å‡ºã€‚å¯ä»¥è¿‘ä¼¼ç†è§£ä¸ºå‡½æ•°å†…éƒ¨ä¸ä¾èµ–ä»»ä½•çš„å¤–éƒ¨çŠ¶æ€ï¼Œå¤–éƒ¨å˜é‡ã€‚ 2ï¼šç©ºå®‰å…¨javaæ˜¯å¼ºå¯¹è±¡ç±»å‹è¯­è¨€ï¼Œæ•…å¯¹äºjavaæ¥è¯´æˆ‘ä»¬å¾ˆå®¹æ˜“å…³æ³¨åˆ°ç±»å‹å¼ºè½¬çš„é”™è¯¯ è¿™é‡Œå¼•è¿›ä¸€ä¸ªæ¦‚å¿µï¼Œç¨‹åºå…¶å®æ˜¯ä¸€ä¸ªç”±å‡½æ•°ç»„æˆçš„æ ‘å‹æˆ–è€…å›¾å‹ç»“æ„ï¼Œè¿™å…¶å®æ„å‘³ç€æˆ‘ä»¬éœ€è¦åœ¨æ¥è¿‘æ ¹èŠ‚ç‚¹çš„åœ°æ–¹ï¼Œå¯¹ä¼ å…¥çš„ ä¸åº”ä¸ºç©ºçš„å‚æ•°æˆ–å˜é‡è¿›è¡Œæ ¡éªŒï¼Œä»è€Œé¿å…å‚æ•°å¾€åä¼ é€’è€Œé€ æˆåœ¨åé¢å¶å­èŠ‚ç‚¹è¿›è¡Œç©ºåˆ¤æ–­çš„ç°è±¡ã€‚è¿™ä¸€è¡Œä¸ºé€šå¸¸å¯ä»¥é€šè¿‡å¯¹å‡½æ•°å…¥å‚åŠ å…¥æ³¨è§£ï¼š@Nullable/@NonNull åœ¨javaä¸­ï¼Œè¦å°½é‡ä¿è¯ä»£ç è´¨é‡ï¼Œæ’é™¤ç©ºå®‰å…¨è€Œæ‰€è°“çš„ç©ºå®‰å…¨çš„è¯­è¨€ï¼Œå®é™…ä¸Šä¹Ÿæ²¡æœ‰è§£å†³ç©ºå®‰å…¨çš„é—®é¢˜ï¼Œå› ä¸ºç©ºè¿™ä¸ªæ¦‚å¿µæ˜¯è¢«éœ€è¦çš„ï¼Œæ‰€ä»¥å¦‚kotlinä¹‹ç±»çš„ç©ºå®‰å…¨è¯­è¨€åªæ˜¯æŠŠç©ºæ ¡éªŒä»è¿è¡Œæ—¶æå‰åˆ°ç¼–è¯‘æ—¶ 3ï¼šæ§åˆ¶é€»è¾‘å¯¹äº åµŒå¥—å¾ªç¯æˆ–if æ˜¯å¦è¦é€šè¿‡continue/break/returnç­‰æ“ä½œï¼Œç®€åŒ–åµŒå¥—çš„é—®é¢˜ã€‚å…¶å®æ˜¯å­˜åœ¨åˆ†æ­§çš„ï¼Œåˆ†æ­§ç‚¹åœ¨äºï¼šcontinue/break/returnæ“ä½œè™½ç„¶å¯ä»¥ç®€åŒ–åµŒå¥—ä½†åŒæ—¶ä¹Ÿä¼šå¢åŠ ä»£ç å¤æ‚åº¦ï¼Œç›´è§‚åº¦ã€‚ æ‰€ä»¥ï¼ŒåµŒå¥—æ˜¯å¦è¦continue/break/retrunï¼Œè¿˜æ˜¯éœ€è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡æƒ…å†µæ‰èƒ½å†³å®šï¼Œå¤§è‡´ä¸Šæœ‰è¿™ä¹ˆå‡ ç§è€ƒè™‘ï¼š å¯¹äºå¼‚å¸¸æƒ…å†µå¼•èµ·çš„ifåµŒå¥—ï¼Œå¯ä»¥é€šè¿‡åœ¨æå‰returnçš„æ–¹å¼ï¼Œå‡ä½åµŒå¥— å¦‚æœä¸šåŠ¡ç¡®å®éœ€è¦ï¼Œä¸éœ€ä¸ºä½ çš„ åµŒå¥—çš„æ§åˆ¶é€»è¾‘ æ„Ÿåˆ°ä¸å¥½æ„æ€ã€‚å¦‚æœåµŒå¥—ç¡®å®èƒ½è¾¾åˆ°ç›´è§‚çš„ä¸šåŠ¡è¡¨è¾¾æ•ˆæœï¼Œé‚£å°±ç”¨å®ƒ continue/break/returnæ“ä½œï¼Œå°½é‡ä¸è¦åœ¨æ§åˆ¶é€»è¾‘çš„ä¸­æˆ–è€…å°¾é€»è¾‘å‡ºç°ï¼Œè¿™ä¼šå¾ˆå¤§ç¨‹åº¦çš„ä½¿é€»è¾‘å¯è¯»æ€§é™ä½ã€‚å¦‚æœè¦ç”¨ï¼Œå°½é‡æå‰ä½¿ç”¨å®ƒä»¬ã€‚","link":"/2024/03/25/CodeOptimization/"},{"title":"CpuArch","text":"â€˜armeabi-v7aâ€™è¡¨ç¤º32ä½cpuæ¶æ„, â€˜arm64-v8aâ€™è¡¨ç¤º64ä½, â€˜x86â€™æ˜¯åªæ¨¡æ‹Ÿå™¨æˆ–ç‰¹å®šromã€‚ æ¡Œé¢ç«¯å¤„ç†å™¨æ¶æ„ï¼ˆIntel é…·ç¿core i3 - i9/Xeon Eã€Amd é”é¾™ryzen/éœ„é¾™epycï¼‰éƒ½æ˜¯x86æ¶æ„ã€‚åŸºäºå¤æ‚æŒ‡ä»¤é›†ï¼ˆCISCï¼‰ã€‚é«˜åŠŸè€—ï¼Œé«˜æ€§èƒ½ å¯åˆ†ä¸ºï¼šx86-32(åˆåx86);x86-64(åˆåx64)ï¼› å…³äºx86çš„32ä½æ¶æ„ï¼ˆå¸¸è¢«ç§°ä¸ºi386ã€x86ï¼‰ï¼Œè¯·è§â€œ**IA-32**â€ã€‚ å…³äºåŸºäºx86çš„64ä½å¤„ç†å™¨ï¼ˆx64ï¼‰æ¶æ„ï¼ˆå‘å‰å…¼å®¹äº16ä½åŠ32ä½çš„x86æ¶æ„ï¼Œå¸¸ç§°AMD64æˆ– Intel 64ï¼‰ï¼Œè¯·è§â€œ**x86-64**â€ã€‚ ç§»åŠ¨ç«¯å¤„ç†å™¨æ¶æ„ï¼ˆios Axxï¼Œéªé¾™ï¼Œéº’éºŸï¼Œä¸‰æ˜ŸExynosï¼‰åˆ™æ˜¯åŸºäºARMæ¶æ„çš„ã€‚åŸºäºç²¾ç®€æŒ‡ä»¤é›†(RISC) ä½åŠŸè€—ï¼Œæ€§èƒ½ä¸Šé™ä¸å¦‚å¤æ‚æŒ‡ä»¤é›†çš„x86æ¶æ„ å¯åˆ†ä¸ºv7ç‰ˆæœ¬åŠä»¥å‰ï¼Œä¸º32ä½ï¼›v8åŠä»¥åï¼Œä¸º64ä½ï¼› æ¶æ„æ”¯æŒAndroidç³»ç»Ÿç›®å‰æ”¯æŒä»¥ä¸‹ä¸ƒç§ä¸åŒçš„CPUæ¶æ„ï¼š æ¯ä¸€ä¸ªCPUæ¶æ„å¯¹åº”ä¸€ä¸ªABIï¼š CPUæ¶æ„ï¼š ARMv5 ARMv7 (ä»2010å¹´èµ·) x86 (ä»2011å¹´èµ·) MIPS (ä»2012å¹´èµ·) ARMv8 MIPS64 x86_64 (ä»2014å¹´èµ·) ABIï¼š armeabi armeabi-v7a x86 mips arm64-v8a mips64 x86_64 æ‰€æœ‰çš„x86ã€x8664ã€armeabi-v7aã€arm64-v8aè®¾å¤‡éƒ½æ”¯æŒarmeabiæ¶æ„çš„.soæ–‡ä»¶ï¼Œx86è®¾å¤‡èƒ½å¤Ÿå¾ˆå¥½çš„è¿è¡ŒARMç±»å‹å‡½æ•°åº“ï¼Œä½†å¹¶ä¸ä¿è¯100%ä¸å‘ç”Ÿcrashï¼Œç‰¹åˆ«æ˜¯å¯¹æ—§è®¾å¤‡ã€‚ 64ä½è®¾å¤‡ï¼ˆarm64-v8a, x8664, mips64ï¼‰èƒ½å¤Ÿè¿è¡Œ32ä½çš„å‡½æ•°åº“ï¼Œä½†æ˜¯ä»¥32ä½æ¨¡å¼è¿è¡Œï¼Œåœ¨64ä½å¹³å°ä¸Šè¿è¡Œ32ä½ç‰ˆæœ¬çš„ARTå’ŒAndroidç»„ä»¶ï¼Œå°†ä¸¢å¤±ä¸“ä¸º64ä½ä¼˜åŒ–è¿‡çš„æ€§èƒ½ï¼ˆARTï¼Œwebviewï¼Œmediaç­‰ç­‰ï¼‰ï¼Œå¹¶åªèƒ½æœ€å¤§ä½¿ç”¨4Gè™šæ‹Ÿå†…å­˜ é˜¿é‡ŒPatron ã€‚ ç›®å‰å›½å†…çš„ Android App å¤§å¤šæ•°è¿˜æ˜¯32ä½æ¶æ„ï¼Œä»…æä¾›äº† arm-v7a çš„åŠ¨æ€é“¾æ¥åº“(åŒ…å¤§å°ã€ç»´æŠ¤æˆæœ¬ç­‰ç­‰)ï¼Œå¸‚é¢ä¸Šå¤§å¤šæ•°æ‰‹æœºéƒ½æ˜¯64ä½çš„ CPUï¼ŒApp é€šå¸¸éƒ½è¿è¡Œåœ¨å…¼å®¹æ¨¡å¼ä¸‹ï¼Œåªå¯ä»¥ä½¿ç”¨å®Œæ•´çš„ 4GB è™šæ‹Ÿå†…å­˜ï¼Œä¸”ä¸¢å¤±ä¸“ä¸º64ä½ä¼˜åŒ–æ€§èƒ½ã€‚ å¯ä»¥é€šè¿‡gradleé…ç½® 1234567android { defaultconfig { ndk { abiFilters &quot;armeabi-v7a&quot; } }} æ¯”å¦‚ï¼šå›½å†…æ‹¼å¤šå¤šã€äº¬å–œéƒ½æ˜¯åªä¿ç•™äº† armeabi_v7aï¼Œå¾®ä¿¡ arm64_v8aï¼Œ å›½å¤–facebookã€instagramç­‰åˆ™å·²æ˜¯ arm64_v8aäº†","link":"/2021/06/15/CpuArch/"},{"title":"CustomView","text":"Measure public void onMeasure(int widthMeasureSpec, int heightMeasureSpec) ç®€è¿°ï¼šæµ‹é‡æ˜¯ä»ViewRootImplè°ƒç”¨performMeasureä¹‹åï¼Œç”±DecorViewï¼ˆFramelayoutï¼‰çš„onMeasureå¼€å§‹ï¼Œå¾€å­Viewä¸€å±‚ä¸€å±‚é€’å½’è°ƒç”¨å…¶onMeasureæµ‹é‡å®½é«˜ï¼Œå¦‚é‡å­Viewä¸ºViewGroupï¼Œåˆ™åˆ†å‘æµ‹é‡ç»™ä¸‹ä¸€çº§ç›´åˆ°éViewGroupï¼Œæœ€åå†ä»æœ€ä½å±‚Viewç¡®å®šå®½é«˜ä¸€å±‚å±‚è¿”å›ç¡®å®šä¸Šä¸€çº§çš„å®½é«˜ã€‚ MeasureSpec MeasureSpec çš„å®Œæ•´è‹±æ–‡æ˜¯ Measure Specificationæµ‹é‡è§„èŒƒï¼Œå…¶ä¸­ Measure è¡¨ç¤ºæµ‹é‡ï¼ŒSpecification è¡¨ç¤ºè§„èŒƒ MeasureSpec å°±ç”¨æ¥å°è£… View çš„ size å’Œ mode è¿™ä¸¤ä¸ªå±æ€§ï¼Œå®ƒæ˜¯ View çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œç”¨ä¸€ä¸ª int ç±»å‹çš„ä¸‰åäºŒä½æ•´æ•°æ¥è¡¨ç¤ºè¿™ä¸¤ä¸ªå±æ€§ï¼Œå‰ä¸¤ä½è¡¨ç¤º modeï¼Œåä¸‰åä½è¡¨ç¤º sizeã€‚ä¸¤ä¸ªäºŒè¿›åˆ¶ä½è¶³å¤Ÿè¡¨ç¤ºå››ç§å¯èƒ½å€¼ï¼Œå®é™…ä¸Š View åªç”¨åˆ°äº†ä¸‰ç§ï¼šUNSPECIFIEDã€EXACTLYã€AT_MOSTã€‚makeMeasureSpec æ–¹æ³•å°±ç”¨äºæ‰“åŒ…å°è£… size å’Œ mode è¿™ä¸¤ä¸ªå±æ€§å€¼æ¥ç”Ÿæˆ MeasureSpec mode å«ä¹‰ UNSPECIFIEDï¼ˆå°‘è§ï¼‰ ViewGroup å¯¹äº View æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼ŒView å¯ä»¥æ‹¿åˆ°ä»»æ„æƒ³è¦çš„ size EXACTLY View æœ¬èº«è®¾å®šäº†ç¡®åˆ‡å¤§å°çš„ sizeã€‚ä¾‹å¦‚ï¼ŒView çš„å®½åº¦è®¾ç½®ä¸ºäº† match_parent æˆ–è€…å…·ä½“çš„ dp å€¼ï¼Œmatch_parent å³å æ»¡çˆ¶å®¹å™¨ï¼Œå¯¹äº View æ¥è¯´ä¹Ÿå±äºç²¾å‡†å€¼ AT_MOST size æ˜¯ View èƒ½å¤Ÿå æ®çš„æœ€å¤§ç©ºé—´ï¼ŒView çš„æœ€ç»ˆå¤§å°ä¸èƒ½è¶…å‡ºè¯¥èŒƒå›´ã€‚å¯¹åº” wrap_contentï¼ŒView å¯ä»¥åœ¨çˆ¶å®¹å™¨å¯ä»¥å®¹çº³çš„èŒƒå›´å†…ç”³è¯·ç©ºé—´ ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒMeasureSpecMode çš„å–å€¼ç”± View çš„çˆ¶å®¹å™¨å†³å®šï¼Œå½“çˆ¶å®¹å™¨å¸Œæœ›å­ View æŒ‰ç…§å›ºå®šçš„å¤§å°æ¥æµ‹é‡æ—¶ï¼ŒMeasureSpecMode å– EXACTLYï¼›å½“çˆ¶å®¹å™¨å¸Œæœ›å­ View ä¸è¶…è¿‡ä¸€å®šçš„å¤§å°æ—¶ï¼ŒMeasureSpecMode å– AT_MOSTã€‚ UNSPECIFIED æ¨¡å¼ç›¸å¯¹è¾ƒå°‘ç”¨åˆ°ï¼Œå®ƒè¡¨ç¤º View å¯ä»¥ä»»æ„å¤§å°ï¼Œä¸€èˆ¬ç”¨äºä¸€äº›ç‰¹æ®Šçš„åœºæ™¯ï¼Œä¾‹å¦‚ ListView ä¸­çš„å­é¡¹ï¼Œç”±äº ListView çš„é«˜åº¦å¯ä»¥æ ¹æ®å­é¡¹çš„æ•°é‡åŠ¨æ€è°ƒæ•´ï¼Œæ‰€ä»¥ ListView åœ¨æµ‹é‡å­é¡¹æ—¶ï¼Œä¼šå°† MeasureSpecMode è®¾ç½®ä¸º UNSPECIFIEDã€‚å½“ MeasureSpecMode ä¸º UNSPECIFIED æ—¶ï¼ŒMeasureSpecSize çš„å€¼é€šå¸¸æ˜¯ 0ï¼Œä½†è¿™å¹¶ä¸å½±å“ View çš„æµ‹é‡ï¼Œå› ä¸º View å¯ä»¥æ ¹æ®è‡ªèº«çš„éœ€è¦è‡ªç”±è°ƒæ•´å¤§å°ã€‚ getChildMeasureSpec æ–¹æ³•æ˜¯ View çš„ MeasureSpec æ˜¯ç”±å…¶çˆ¶å®¹å™¨ ViewGroup çš„ MeasureSpec å’Œ View è‡ªèº«çš„ LayoutParams æ¥å…±åŒå†³å®šçš„ è¿™å¥è¯æœ€ç›´æ¥çš„ä½“ç°ã€‚ï¼ˆè§é™„å½•ä»£ç getChildMeasureSpecï¼‰ æµ‹é‡è¿‡ç¨‹å¯¹äº View æ¥è¯´ï¼Œå…¶ MeasureSpec æ˜¯ç”±å…¶çˆ¶å®¹å™¨ ViewGroup çš„ MeasureSpec å’Œ View è‡ªèº«çš„ LayoutParams æ¥å…±åŒå†³å®šçš„ã€‚æ­¤å¤„æ‰€è¯´çš„ View ä¹ŸåŒ…å« ViewGroup ç±»å‹ï¼Œå› ä¸ºçˆ¶å®¹å™¨ ViewGroup åœ¨æµ‹é‡ childView çš„æ—¶å€™å¹¶ä¸å…³å¿ƒä¸‹ä¸€çº§çš„å…·ä½“ç±»å‹ï¼Œè€Œåªæ˜¯è´Ÿè´£ä¸‹å‘æµ‹é‡è¦æ±‚å¹¶æ¥æ”¶æµ‹é‡ç»“æœï¼Œä¸‹ä¸€çº§å¦‚æœæ˜¯ View ç±»å‹é‚£ä¹ˆå°±åªéœ€è¦æµ‹é‡è‡ªèº«å¹¶è¿”å›ç»“æœï¼Œä¸‹ä¸€çº§å¦‚æœæ˜¯ ViewGroup ç±»å‹é‚£ä¹ˆå°±é‡å¤ä»¥ä¸Šæ­¥éª¤å¹¶è¿”å›ç»“æœï¼Œæ•´ä¸ªè§†å›¾æ ‘çš„ç»˜åˆ¶æµç¨‹å°±é€šè¿‡è¿™ç§å±‚å±‚é€’å½’è°ƒç”¨çš„æ–¹å¼æ¥å®Œæˆæµ‹é‡ï¼Œå’Œ View çš„äº‹ä»¶åˆ†å‘æœºåˆ¶éå¸¸ç›¸ä¼¼ Viewé€šè¿‡é‡å†™ public void onMeasure(int widthMeasureSpec, int heightMeasureSpec)æ–¹æ³•æ¥è¿”å›è‡ªèº«çš„æµ‹é‡å®½é«˜ç»“æœï¼ŒwidthMeasureSpecã€heightMeasureSpecè¿™ä¸¤ä¸ªå‚æ•°çš„å€¼ç”± View çš„çˆ¶å®¹å™¨ä¼ é€’è¿›æ¥ï¼Œå› æ­¤å®ƒä»¬å®é™…ä¸Šæ˜¯çˆ¶å®¹å™¨ä¼ é€’ç»™å­ View çš„è§„æ ¼è¦æ±‚ã€‚åœ¨ onMeasure() æ–¹æ³•ä¸­ï¼Œå­ View éœ€è¦æ ¹æ®è¿™ä¸¤ä¸ªå‚æ•°è®¡ç®—å‡ºè‡ªå·±çš„æµ‹é‡å®½åº¦å’Œæµ‹é‡é«˜åº¦ï¼Œå¹¶å°†å®ƒä»¬ä¿å­˜èµ·æ¥(setMeasuredDimension)ï¼Œä»¥ä¾¿åç»­çš„å¸ƒå±€å’Œç»˜åˆ¶è¿‡ç¨‹ä½¿ç”¨(getMeasureHeight/getMeasureWidth)ã€‚ Layoutprotected abstract void onLayout(boolean changed,int l, int t, int r, int b); ç®€è¿°ï¼šç»§performMeasureæ‰§è¡Œå®Œæˆä¹‹åï¼Œæ¯ä¸ªViewæœ‰äº†è‡ªå·±çš„æµ‹é‡å®½é«˜(getMeasureWidth)ï¼Œæ¥ä¸‹æ¥å°±ç”±ViewRootImplæ‰§è¡ŒperformLayoutåèµ°åˆ°DecorViewçš„layoutæ–¹æ³•ï¼Œå†³å®šè‡ªèº«çš„left,top,right,buttomç­‰å±æ€§ï¼Œå®šä¸‹æ¥è‡ªèº«çš„ä½ç½®ã€‚ View çš„ layout èµ·å§‹ç‚¹ä¹Ÿæ˜¯ä» ViewRootImpl å¼€å§‹çš„ï¼ŒViewRootImpl çš„ performLayout æ–¹æ³•ä¼šè°ƒç”¨ DecorView çš„ layout æ–¹æ³•æ¥å¯åŠ¨ layout æµç¨‹ï¼Œä¼ å…¥çš„åä¸¤ä¸ªå‚æ•°å³å±å¹•çš„å®½é«˜å¤§å° 12345678910111213private void performLayout(WindowManager.LayoutParams lp, int desiredWindowWidth, int desiredWindowHeight) { //... Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;layout&quot;); try { //å¯åŠ¨ layout æµç¨‹ hostæ­¤æ—¶ä¸ºDecorView host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight()); Â·Â·Â· } finally { Trace.traceEnd(Trace.TRACE_TAG_VIEW); } mInLayout = false; } layout(int l, int t, int r, int b) æ˜¯ View ç±»ä¸­çš„æ–¹æ³•ï¼Œä¼ å…¥çš„å››ä¸ªå‚æ•°å³æˆ‘ä»¬ç†ŸçŸ¥çš„ leftã€topã€rightã€bottomï¼Œè¿™å››ä¸ªå€¼éƒ½æ˜¯ View ç›¸å¯¹çˆ¶å®¹å™¨ ViewGroup çš„åæ ‡å€¼ã€‚å¯¹äº DecorView æ¥è¯´è¿™å››ä¸ªå€¼å°±åˆ†åˆ«æ˜¯ 0ã€0ã€screenWidthã€screenHeight 123456789101112131415public void layout(int l, int t, int r, int b) { Â·Â·Â· //é‡ç‚¹ boolean changed = isLayoutModeOptical(mParent) ? setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b); if (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) { //é‡ç‚¹ onLayout(changed, l, t, r, b); Â·Â·Â· } Â·Â·Â·}protected void onLayout(boolean changed, int left, int top, int right, int bottom) {} setFrame æ–¹æ³•åˆä¼šå°† leftã€topã€rightã€bottom ç­‰å››ä¸ªå€¼ä¿å­˜åˆ° View ç›¸åº”çš„å‡ ä¸ªå…¨å±€å˜é‡ä¸Šï¼Œè‡³æ­¤ View çš„ width å’Œ height æ‰çœŸæ­£ç¡®å®šä¸‹æ¥ï¼ŒView çš„ getWidth() å’Œ getHeight()æ–¹æ³•éƒ½æ˜¯ä¾é è¿™å››ä¸ªå€¼åšå‡æ³•è¿ç®—å¾—åˆ°çš„ã€‚æ­¤å¤–ï¼Œè¿™é‡Œä¹Ÿä¼šå›è°ƒ onSizeChanged æ–¹æ³•ï¼Œåœ¨è‡ªå®šä¹‰ View æ—¶æˆ‘ä»¬å¾€å¾€å°±é€šè¿‡è¯¥æ–¹æ³•æ¥å¾—åˆ° View çš„å‡†ç¡®å®½é«˜å¤§å°ï¼Œå¹¶åœ¨è¿™é‡Œæ¥æ”¶å®½é«˜å¤§å°å˜åŒ–çš„é€šçŸ¥ 123456789101112131415161718192021protected boolean setFrame(int left, int top, int right, int bottom) { Â·Â·Â· if (mLeft != left || mRight != right || mTop != top || mBottom != bottom) { changed = true; Â·Â·Â· mLeft = left; mTop = top; mRight = right; mBottom = bottom; mRenderNode.setLeftTopRightBottom(mLeft, mTop, mRight, mBottom); mPrivateFlags |= PFLAG_HAS_BOUNDS; if (sizeChanged) { sizeChange(newWidth, newHeight, oldWidth, oldHeight); } Â·Â·Â· } return changed; } e.g FrameLayoutè¯¦è§ä»£ç (FrameLayout.onLayout) layout æ–¹æ³•åˆä¼šè°ƒç”¨è‡ªèº«çš„ onLayout æ–¹æ³•ã€‚onLayout æ–¹æ³•åœ¨ View ç±»ä¸­æ˜¯ç©ºå®ç°ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ View éƒ½æ— éœ€é‡å†™è¯¥æ–¹æ³•ã€‚è€Œ ViewGroup åˆå°†å…¶æ”¹ä¸ºäº†æŠ½è±¡æ–¹æ³•ï¼Œå³æ¯ä¸ª ViewGroup å­ç±»éƒ½éœ€è¦é€šè¿‡å®ç°è¯¥æ–¹æ³•æ¥ç®¡ç†è‡ªå·±çš„æ‰€æœ‰ childView çš„æ‘†æ”¾ä½ç½®ï¼ŒFrameLayout å’Œ LinearLayout ç­‰å®¹å™¨ç±»å°±é€šè¿‡å®ç°è¯¥æ–¹æ³•æ¥å®ç°ä¸åŒçš„å¸ƒå±€æ•ˆæœ è¿˜æ˜¯ä»¥ FrameLayout ä¸ºä¾‹å­ã€‚FrameLayout çš„å¸ƒå±€ç‰¹ç‚¹å°±æ˜¯ä¼šå°†æ‰€æœ‰çš„ childView è¿›è¡Œå åŠ è¦†ç›–æ˜¾ç¤ºï¼Œæ¯ä¸ª childView ä¹‹é—´å¹¶ä¸ä¼šå½¢æˆç›¸äº’çº¦æŸï¼ŒchildView ä¸»è¦æ˜¯é€šè¿‡ layout_gravity å’Œ layout_margin æ¥å£°æ˜è‡ªå·±åœ¨ FrameLayout ä¸­çš„ä½ç½®ã€‚FrameLayout çš„ padding ä¹Ÿä¼šå æ®ä¸€éƒ¨åˆ†ç©ºé—´ï¼Œä»è€Œå½±å“ childView çš„å¯ç”¨ç©ºé—´ FrameLayout çš„ layoutChildren æ–¹æ³•å°±éœ€è¦è€ƒè™‘ä»¥ä¸Šå› ç´ ï¼Œè®¡ç®—å¾—å‡º childView ç›¸å¯¹ FrameLayout çš„ leftã€topã€rightã€bottom ç­‰å€¼çš„å¤§å°ï¼Œç„¶åè°ƒç”¨ childView çš„ layout æ–¹æ³•ï¼Œä½¿å¾— childView èƒ½å¤Ÿå¾—åˆ°è‡ªå·±çš„çœŸå®å®½é«˜ã€‚å¦‚æœ childView ä¹Ÿå±äº ViewGroup ç±»å‹çš„è¯ï¼Œå°±åˆä¼šå±‚å±‚è°ƒç”¨é‡å¤ä»¥ä¸Šæ­¥éª¤å®Œæˆæ•´ä¸ªè§†å›¾æ ‘çš„ layout æ“ä½œ Drawç®€è¿°ï¼šç»§performMeasureã€performLayoutç›¸ç»§æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ¯ä¸ªViewæœ‰äº†è‡ªå·±çš„ç¡®å®šå®½é«˜(getWidth)ã€ä½ç½®(getLeftï¼Œè¿™æ—¶å€™ç”±ViewRootImplçš„performDrawå¼€å§‹ï¼Œèµ°åˆ°DecordViewçš„Drawå¼€å§‹ï¼ŒviewGroup dispatchDrawå‘ä¸‹åˆ†å‘ï¼ŒView æ“ä½œcanvasè¿›è¡Œç»˜åˆ¶ã€‚ draw ä»£è¡¨çš„æ˜¯ç»˜åˆ¶è§†å›¾çš„è¿‡ç¨‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ View éœ€è¦é€šè¿‡æ“ä½œ Canvas æ¥å®ç°è‡ªå·± UI æ•ˆæœ View çš„ draw èµ·å§‹ç‚¹ä¹Ÿæ˜¯ä» ViewRootImpl å¼€å§‹çš„ï¼ŒViewRootImpl çš„ performDraw æ–¹æ³•ä¼šè°ƒç”¨ drawSoftware æ–¹æ³•ï¼Œå†é€šè¿‡è°ƒç”¨ DecorView çš„ draw æ–¹æ³•æ¥å¯åŠ¨ draw æµç¨‹ 12345678private boolean drawSoftware(Surface surface, AttachInfo attachInfo, int xoff, int yoff, boolean scalingRequired, Rect dirty, Rect surfaceInsets) { // Draw with software renderer. final Canvas canvas; Â·Â·Â· mView.draw(canvas); Â·Â·Â·} View çš„drawæ–¹æ³•çš„é‡ç‚¹çœ‹å…¶è°ƒç”¨çš„ onDraw å’Œ dispatchDraw è¿™ä¸¤ä¸ªæ–¹æ³•å³å¯ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åœ¨ View ç±»ä¸­éƒ½æ˜¯ç©ºå®ç° å¯¹äºè‡ªå®šä¹‰ Viewï¼Œæˆ‘ä»¬éœ€è¦é‡å†™onDrawæ–¹æ³•æ¥å®ç°è‡ªå·±çš„ç‰¹å®š UIï¼Œæ— éœ€å…³å¿ƒdispatchDrawæ–¹æ³• å¯¹äº ViewGroupï¼Œé™¤äº†éœ€è¦ç»˜åˆ¶èƒŒæ™¯è‰²å‰æ™¯è‰²ç­‰å¤–ï¼Œæ— éœ€ç»˜åˆ¶è‡ªèº«ï¼Œæ‰€ä»¥ ViewGroup æ— éœ€é‡å†™onDrawæ–¹æ³•ã€‚è€Œ dispatchDrawæ–¹æ³•å°±æ˜¯ä¸º ViewGroup å‡†å¤‡çš„ï¼Œç”¨äºå‘æ‰€æœ‰ childView ä¸‹å‘ draw è¯·æ±‚ 123456789 public void draw(Canvas canvas) { Â·Â·Â· // Step 3, draw the content onDraw(canvas); // Step 4, draw the children dispatchDraw(canvas); Â·Â·Â· }å¤åˆ¶ä»£ç  ViewGroup çš„ dispatchDraw æ–¹æ³•ä¼šå¾ªç¯éå†æ‰€æœ‰ childViewï¼Œä½¿ç”¨åŒä¸ª Canvas å¯¹è±¡æ¥è°ƒç”¨æ¯ä¸ª childView çš„ drawæ–¹æ³•ï¼Œå±‚å±‚è°ƒç”¨å®Œæˆæ•´ä¸ªè§†å›¾æ ‘çš„ç»˜åˆ¶ 12345678910111213141516171819202122232425262728293031 @Override protected void dispatchDraw(Canvas canvas) { Â·Â·Â· for (int i = 0; i &lt; childrenCount; i++) { while (transientIndex &gt;= 0 &amp;&amp; mTransientIndices.get(transientIndex) == i) { final View transientChild = mTransientViews.get(transientIndex); if ((transientChild.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || transientChild.getAnimation() != null) { //é‡ç‚¹ more |= drawChild(canvas, transientChild, drawingTime); } transientIndex++; if (transientIndex &gt;= transientCount) { transientIndex = -1; } } final int childIndex = getAndVerifyPreorderedIndex(childrenCount, i, customOrder); final View child = getAndVerifyPreorderedView(preorderedList, children, childIndex); if ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != null) { //é‡ç‚¹ more |= drawChild(canvas, child, drawingTime); } } Â·Â·Â· } protected boolean drawChild(Canvas canvas, View child, long drawingTime) { return child.draw(canvas, this, drawingTime); }å¤åˆ¶ä»£ç  é™„å½•getChildMeasureSpecspec å³ Parent çš„ MeasureSpec childDimension æ˜¯ å­Viewï¼ˆè‡ªèº«ï¼‰ åœ¨å¸ƒå±€æ–‡ä»¶ä¸­å£°æ˜çš„å°ºå¯¸å€¼ï¼Œ&gt;= 0æ—¶ä¸ºåƒç´ å€¼ï¼Œ-1ä¸ºMATCH_PARENTï¼Œ-2ä¸ºWRAP_CONTENT 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768public static int getChildMeasureSpec(int spec, int padding, int childDimension) { int specMode = MeasureSpec.getMode(spec); int specSize = MeasureSpec.getSize(spec); int size = Math.max(0, specSize - padding); int resultSize = 0; int resultMode = 0; switch (specMode) { // Parent has imposed an exact size on us case MeasureSpec.EXACTLY: if (childDimension &gt;= 0) { resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // Child wants to be our size. So be it. resultSize = size; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // Child wants to determine its own size. It can't be // bigger than us. resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // Parent has imposed a maximum size on us case MeasureSpec.AT_MOST: if (childDimension &gt;= 0) { // Child wants a specific size... so be it resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // Child wants to be our size, but our size is not fixed. // Constrain child to not be bigger than us. resultSize = size; resultMode = MeasureSpec.AT_MOST; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // Child wants to determine its own size. It can't be // bigger than us. resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // Parent asked to see how big we want to be case MeasureSpec.UNSPECIFIED: if (childDimension &gt;= 0) { // Child wants a specific size... let him have it resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // Child wants to be our size... find out how big it should // be resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size; resultMode = MeasureSpec.UNSPECIFIED; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // Child wants to determine its own size.... find out how // big it should be resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size; resultMode = MeasureSpec.UNSPECIFIED; } break; } //noinspection ResourceType return MeasureSpec.makeMeasureSpec(resultSize, resultMode);} FrameLayout.onLayout()12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970@Override protected void onLayout(boolean changed, int left, int top, int right, int bottom) { layoutChildren(left, top, right, bottom, false /* no force left gravity */); } void layoutChildren(int left, int top, int right, int bottom, boolean forceLeftGravity) { final int count = getChildCount(); final int parentLeft = getPaddingLeftWithForeground(); final int parentRight = right - left - getPaddingRightWithForeground(); final int parentTop = getPaddingTopWithForeground(); final int parentBottom = bottom - top - getPaddingBottomWithForeground(); for (int i = 0; i &lt; count; i++) { final View child = getChildAt(i); if (child.getVisibility() != GONE) { final LayoutParams lp = (LayoutParams) child.getLayoutParams(); final int width = child.getMeasuredWidth(); final int height = child.getMeasuredHeight(); int childLeft; int childTop; int gravity = lp.gravity; if (gravity == -1) { gravity = DEFAULT_CHILD_GRAVITY; } final int layoutDirection = getLayoutDirection(); final int absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection); final int verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK; //è€ƒè™‘æ°´å¹³æ–¹å‘ä¸Šçš„çº¦æŸæ¡ä»¶ switch (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) { case Gravity.CENTER_HORIZONTAL: childLeft = parentLeft + (parentRight - parentLeft - width) / 2 + lp.leftMargin - lp.rightMargin; break; case Gravity.RIGHT: if (!forceLeftGravity) { childLeft = parentRight - width - lp.rightMargin; break; } case Gravity.LEFT: default: childLeft = parentLeft + lp.leftMargin; } //è€ƒè™‘ç«–ç›´æ–¹å‘ä¸Šçš„çº¦æŸæ¡ä»¶ switch (verticalGravity) { case Gravity.TOP: childTop = parentTop + lp.topMargin; break; case Gravity.CENTER_VERTICAL: childTop = parentTop + (parentBottom - parentTop - height) / 2 + lp.topMargin - lp.bottomMargin; break; case Gravity.BOTTOM: childTop = parentBottom - height - lp.bottomMargin; break; default: childTop = parentTop + lp.topMargin; } child.layout(childLeft, childTop, childLeft + width, childTop + height); } } }","link":"/2023/03/06/CustomView/"},{"title":"DNS","text":"ç®€è¿°ï¼š æµè§ˆå™¨ä¸­è®¿é—®ä¸€ä¸ªwww.baidu.comï¼Œé¦–å…ˆä¼šè®¿é—®æµè§ˆå™¨ç¼“å­˜ï¼Œå¦‚æœªå‘½ä¸­åˆ™è¿›ä¸€æ­¥è®¿é—®æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œå¦‚æœªå‘½ä¸­åˆ™è®¿é—®hostsæ–‡ä»¶ã€‚å¦‚æœªå‘½ä¸­ï¼Œåˆ™å®¢æˆ·ç«¯æƒ³æœ¬åœ°DNSæœåŠ¡å™¨å‘èµ·é€’å½’æŸ¥è¯¢ï¼ˆæœ¬åœ°DNSä¼šå°†ç»“æœä¹Ÿå°±æ˜¯ipç›´æ¥è¿”å›ï¼‰ï¼Œå¦‚æœ¬åœ°DNSè§£ææœåŠ¡å™¨æœªå‘½ä¸­ï¼Œåˆ™ç”±æœ¬åœ°DNSè§£ææœåŠ¡å™¨å‘æ ¹åŸŸåæœåŠ¡å™¨ã€é¡¶çº§åŸŸåæœåŠ¡å™¨ã€ç®¡ç†æ–¹åŸŸåæœåŠ¡å™¨ç­‰ä¾æ¬¡è¿›è¡Œè¿­ä»£æŸ¥è¯¢ï¼ˆæ¯æœ‰ä¸€ä¸ªæœªå‘½ä¸­åˆ™è¿”å›ä¸‹ä¸€ä¸ªåŸŸåæœåŠ¡å™¨åœ°å€ç»™æœ¬åœ°åŸŸåæœåŠ¡å™¨ï¼Œæ¯”å¦‚local dns serverå‘æ ¹åŸŸåæœåŠ¡å™¨æŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æ ¹åŸŸåæœåŠ¡å™¨è¿”å›é¡¶çº§åŸŸåæœåŠ¡å™¨åœ°å€ç»™local dns serverï¼Œç„¶ålocal dns serverå‘æ”¶åˆ°çš„è¿™ä¸ªåœ°å€è¿­ä»£å‘èµ·æŸ¥è¯¢ï¼‰ è¿­ä»£ä¸é€’å½’æŸ¥è¯¢åŒºåˆ«ï¼šå®¢æˆ·ç«¯å‘æœ¬åœ°dnsæœåŠ¡å™¨å‘èµ·çš„æ˜¯é€’å½’æŸ¥è¯¢ï¼Œå®¢æˆ·ç«¯æ‹¿åˆ°çš„ipæ˜¯ç”±æœ¬åœ°dnsæœåŠ¡å™¨ç›´æ¥è¿”å›ï¼›æœ¬åœ°dnsæœåŠ¡å™¨å‘å¤–ç½‘æŸ¥è¯¢æ—¶æ˜¯ç”¨çš„è¿­ä»£æŸ¥è¯¢ï¼Œå³å‘æ ¹åŸŸåæœåŠ¡å™¨æŸ¥è¯¢æœªå‘½ä¸­è¿”å›ç»™æœ¬åœ°dnsæœåŠ¡å™¨çš„æ˜¯ä¸‹ä¸€ä¸ªåŸŸåæœåŠ¡å™¨çš„åœ°å€è€Œéæ ¹åŸŸåå»è®¿é—®ä¸‹ä¸€ä¸ªåŸŸåæœåŠ¡å™¨è¿”å›ç»“æœipã€‚ è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæƒå¨æ€§çš„é—®é¢˜ï¼šå¦‚æœå®¢æˆ·ç«¯å‘æœ¬åœ°dnsæœåŠ¡å™¨å‘èµ·é€’å½’æŸ¥è¯¢æ—¶ï¼Œæœ¬åœ°dnså­˜åœ¨ç¼“å­˜ï¼Œå¹¶å°†ç»“æœè¿”å›å®¢æˆ·ç«¯ï¼Œåˆ™è¯¥ç»“æœä¸å…·æƒå¨æ€§ï¼ˆå³ç¼“å­˜å¯èƒ½å·²ç»å¤±æ•ˆï¼‰ï¼›åä¹‹å¦‚æœç”±æœ¬åœ°dnsæœåŠ¡å™¨è§£æå‘½ä¸­åè¿”å›ï¼Œåˆ™å…·æœ‰æƒå¨æ€§ åŸŸåçš„çº§åˆ«ï¼š .ä»£è¡¨æ ¹åŸŸåï¼Œ .comè¿™ç§æ˜¯é¡¶çº§åŸŸåï¼Œä¹Ÿå«ä¸€çº§åŸŸåï¼Œbaidu.comè¿™ç§å«äºŒçº§åŸŸåï¼Œ www.baidu.comè¿™ç§å«ä¸‰çº§åŸŸåï¼Œä¾æ¬¡ç±»æ¨ã€‚ æ³¨ï¼šä¹Ÿæœ‰å…¶ä»–å«æ³•çš„ï¼Œåæ­£ä½ çŸ¥é“è¿™ä¸ªæ„æ€å°±å¯ä»¥äº†ã€‚ å†ä»‹ç»ä¸€ä¸‹æœ€å¸¸è§çš„ä¸¤ç§åŸŸåæœåŠ¡å™¨ï¼š æƒå¨DNSï¼šè´Ÿè´£å¯¹è¯·æ±‚ä½œå‡ºæƒå¨çš„å›ç­”ã€‚æƒå¨DNSä¸­å­˜å‚¨ç€è®°å½•ï¼Œæœ€å¸¸è§çš„3ç§ï¼šAè®°å½•ï¼ˆè®°å½•æŸåŸŸåå’Œå…¶IPçš„å¯¹åº”ï¼‰ï¼ŒNSè®°å½•ï¼ˆè®°å½•æŸåŸŸåå’Œè´Ÿè´£è§£æè¯¥åŸŸçš„æƒå¨DNSï¼‰ï¼ŒCNAMEè®°å½•ï¼ˆè´Ÿè´£è®°å½•æŸåŸŸååŠå…¶åˆ«åï¼‰ã€‚æƒå¨èƒ½ç›´æ¥å›ç­”çš„ï¼Œå°±å›Aè®°å½•ï¼›éœ€è¦å…¶ä»–æƒå¨DNSå›ç­”çš„ï¼Œå°±å›NSè®°å½•ï¼Œç„¶åLDNSå†å»æ‰¾å…¶ä»–æƒå¨DNSé—®ï¼›å¦‚æœè¯¥è®°å½•æ˜¯åˆ«åç±»å‹çš„ï¼Œå°±å›CNAMEï¼ŒLDNSå°±ä¼šå†å»è§£æåˆ«åã€‚ é€’å½’DNSï¼šé€šå¸¸å°±æ˜¯LDNSï¼Œå®ƒæ¥å—ç»ˆç«¯çš„åŸŸåæŸ¥è¯¢è¯·æ±‚ï¼Œè´Ÿè´£åœ¨ç½‘ä¸Šé—®ä¸€åœˆåï¼Œå°†ç­”æ¡ˆè¿”å›ç»ˆç«¯ã€‚ ç°åœ¨ä¸¾ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼šæ¯”å¦‚ç»ˆç«¯è¯·æ±‚www.baidu.comè¿™ä¸ªåŸŸåçš„IPã€‚ åœ¨æ²¡æœ‰ç¼“å­˜æ—¶ï¼ŒLDNSä¼šä»æ ¹DNSé—®èµ·ï¼š 1ã€LDNSé—®æ ¹DNSè¯´ï¼šâ€œwww.baidu.comçš„IPæ˜¯å¤šå°‘å•Šï¼Ÿâ€ã€‚ 2ã€æ ¹DNSè¯´ï¼šâ€œæˆ‘å“ªæœ‰æ—¶é—´ç®¡ä½ è¿™ä¹ˆç»†çš„é—®é¢˜ï¼Œä½ å»é—®comé¡¶çº§åŸŸçš„DNSå§ï¼Œæˆ‘åªç®¡åˆ°é¡¶çº§åŸŸï¼Œå–ï¼Œè¿™äº›æ˜¯comé¡¶çº§åŸŸDNSçš„åå­—å’ŒIPï¼Œä½ å»é—®å®ƒä»¬å§â€ã€‚ï¼ˆä»¥NSè®°å½•å›åº”ï¼‰ 3ã€LDNSåˆå¿™é—®comçš„æƒå¨DNSï¼Œcomæƒå¨DNSè¯´ï¼šâ€œä½ é—®çš„è¿™æ˜¯ä¸‰çº§åŸŸåï¼Œæˆ‘ä¸ç®¡è¿™ä¹ˆå¤šï¼Œä½ å»é—®baidu.comçš„æƒå¨DNSå§ï¼Œå®ƒçš„åå­—æ˜¯ns.baidu.comï¼Œä»–çš„IPæ˜¯XXXï¼ˆè¿™é‡Œå¯èƒ½ç»™å‡ºå¤šä¸ªæƒå¨DNSï¼‰â€ã€‚ 4ã€LDNSç»§ç»­é—®baidu.comçš„æƒå¨DNSï¼Œè¿™æ¬¡ç—›å¿«ï¼Œå› ä¸ºwww.baidu.comæ­£æ˜¯å®ƒç®¡çš„ï¼Œå®ƒå¯èƒ½ç›´æ¥ç»™å‡ºAè®°å½•ï¼Œä¹Ÿå¯èƒ½ç»™å‡ºCNAMEè®°å½•ï¼Œå¦‚æœæ˜¯å‰è€…ï¼Œå°±ç›´æ¥å¾—åˆ°IPï¼Œå¦‚æœæ˜¯åè€…ï¼Œå°±éœ€è¦å¯¹åˆ«åå†åšæŸ¥è¯¢ã€‚ 5ã€æœ€ç»ˆï¼ŒLDNSå¾—åˆ°www.baidu.comçš„IPï¼Œå¹¶å°†å…¶è¿”å›ç»™ç»ˆç«¯ã€‚ ç»†å¿ƒçš„äººä¼šé—®ï¼Œåœ¨ç¬¬1æ­¥ä¸­ï¼ŒLDNSé—®æ ¹DNSçš„æ—¶å€™ï¼Œä»–æ˜¯æ€ä¹ˆçŸ¥é“æ ¹DNSçš„IPçš„ï¼Ÿ è¿™13ä¸ªIPé€šå¸¸æ˜¯é¢„å…ˆé…ç½®åœ¨LDNSé‡Œé¢çš„ã€‚åœ¨LDNSåˆå§‹åŒ–DNSç¼“å­˜æˆ–è€…ç¼“å­˜å¤±æ•ˆçš„æ—¶å€™ï¼ŒLDNSå‘è‡ªå·±è¢«é¢„å…ˆé…ç½®çš„è¿™äº›IPä¸­çš„ä¸€ä¸ªï¼Œå‘èµ·å¯¹æ ¹çš„æŸ¥è¯¢ï¼ˆä¹Ÿå³è¯¢é—®.çš„NSè®°å½•ï¼‰ï¼Œè·å¾—æœ€æ–°çš„æ ¹DNSçš„ä¿¡æ¯_ï¼ˆ6ï¼‰_ã€‚ å¯¹äºDNSæœåŠ¡å™¨è½¯ä»¶è€Œè¨€ï¼Œè¿™13ä¸ªIPï¼Œé…ç½®åœ¨æ ¹æç¤ºæ–‡ä»¶ï¼ˆroot hints fileï¼‰ä¸­ï¼Œå¯èƒ½æ˜¯named.cacheæˆ–root.caæˆ–root.hintsç­‰ç­‰ä¹‹ç±»çš„æ–‡ä»¶ã€‚ ä¸Šé¢å°±æ˜¯å„ç§æ•™ç§‘ä¹¦ä¸­éƒ½ä¼šè®²åˆ°çš„DNSæŸ¥è¯¢è¿‡ç¨‹ï¼Œä½†å®é™…ä¸Šï¼Œæ²¡æœ‰è¿™ä¹ˆéº»çƒ¦ï¼Œå› ä¸ºå„ä¸ªå±‚é¢éƒ½æ˜¯æœ‰ç¼“å­˜çš„ã€‚ å®é™…DNSæŸ¥è¯¢çš„è¿‡ç¨‹ï¼Œæ˜¯è¿™æ ·çš„ï¼š ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­è¾“å…¥è¿™ä¸ªåŸŸåï¼š123.abc.qq.com.cn 1ã€æµè§ˆå™¨ä¼šå…ˆçœ‹è‡ªèº«æœ‰æ²¡æœ‰å¯¹è¿™ä¸ªåŸŸåçš„ç¼“å­˜ï¼Œå¦‚æœæœ‰ï¼Œå°±ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±å»é—®æ“ä½œç³»ç»Ÿï¼Œæ“ä½œç³»ç»Ÿä¹Ÿä¼šå»çœ‹è‡ªå·±çš„ç¼“å­˜ï¼Œå¦‚æœæœ‰ï¼Œå°±ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å»hostsæ–‡ä»¶çœ‹ï¼Œä¹Ÿæ²¡æœ‰ï¼Œæ‰ä¼šå»é—®LDNSã€‚ 2ã€LDNSä¼šå»å…ˆçœ‹çœ‹è‡ªå·±æœ‰æ²¡æœ‰123.abc.qq.com.cnçš„Aè®°å½•ï¼Œè¦æœ‰å°±ç›´æ¥è¿”å›ï¼Œè¦æ²¡æœ‰ï¼Œå°±å»çœ‹æœ‰æ²¡æœ‰abc.qq.com.cnçš„NSè®°å½•ï¼Œå¦‚æœæœ‰ï¼Œå°±å»é—®å®ƒè¦ç­”æ¡ˆï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±å»çœ‹æœ‰æ— qq.com.cnçš„NSçš„è®°å½•ï¼Œå¦‚æœæœ‰ï¼Œå°±å»é—®å®ƒï¼Œæ²¡æœ‰å°±å»çœ‹æœ‰æ— com.cnçš„DNSï¼Œè¿˜æ²¡æœ‰å°±å»çœ‹æœ‰æ— cnçš„DNSï¼Œå¦‚æœè¿cnçš„NSè®°å½•éƒ½æ²¡æœ‰ï¼Œæ‰å»é—®æ ¹ã€‚ æ‰€ä»¥ï¼Œæœ‰äº†ç¼“å­˜ä»¥åï¼Œæ•™ç§‘ä¹¦ä¸Šé‚£ç§ä»æ ¹é—®èµ·çš„æƒ…å†µï¼Œå®é™…ä¸Šå¾ˆå°‘å‘ç”Ÿã€‚ åªæœ‰åœ¨å„å¤„éƒ½æ²¡æœ‰ç¼“å­˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰ä¼šé—®æ ¹ã€‚ åŸºç¡€çŸ¥è¯†1.åŸŸåç³»ç»Ÿ 2.åŸŸåæœåŠ¡å™¨ åŸŸåè§£æè¿‡ç¨‹1.åœ¨æµè§ˆå™¨ä¸­è¾“å…¥www.qq.comåŸŸåï¼Œä¼šä¼˜å…ˆè®¿é—®æµè§ˆå™¨ç¼“å­˜ï¼Œå¦‚æœæœªå‘½ä¸­åˆ™è®¿é—®OSç¼“å­˜ï¼Œåˆ™è®¿é—®æœ¬åœ°hostsæ–‡ä»¶ 2.å¦‚æœhostsé‡Œæ²¡æœ‰è¿™ä¸ªåŸŸåçš„æ˜ å°„ï¼Œåˆ™æŸ¥æ‰¾æœ¬åœ°DNSè§£æå™¨ç¼“å­˜ï¼Œæ˜¯å¦æœ‰è¿™ä¸ªç½‘å€æ˜ å°„å…³ç³»ï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥è¿”å›ï¼Œå®ŒæˆåŸŸåè§£æã€‚ 3.å¦‚æœhostsä¸æœ¬åœ°DNSè§£æå™¨ç¼“å­˜éƒ½æ²¡æœ‰ç›¸åº”çš„ç½‘å€æ˜ å°„å…³ç³»ï¼Œé¦–å…ˆä¼šæ‰¾TCP/IPå‚æ•°ä¸­è®¾ç½®çš„é¦–é€‰DNSæœåŠ¡å™¨ï¼Œåœ¨æ­¤æˆ‘ä»¬å«å®ƒæœ¬åœ°DNSæœåŠ¡å™¨ï¼Œ æ­¤æœåŠ¡å™¨æ”¶åˆ°æŸ¥è¯¢æ—¶ï¼Œå¦‚æœè¦æŸ¥è¯¢çš„åŸŸåï¼ŒåŒ…å«åœ¨æœ¬åœ°é…ç½®åŒºåŸŸèµ„æºä¸­ï¼Œåˆ™è¿”å›è§£æç»“æœç»™å®¢æˆ·æœºï¼Œå®ŒæˆåŸŸåè§£æï¼Œæ­¤è§£æå…·æœ‰æƒå¨æ€§ã€‚ 4.å¦‚æœè¦æŸ¥è¯¢çš„åŸŸåï¼Œä¸ç”±æœ¬åœ°DNSæœåŠ¡å™¨åŒºåŸŸè§£æï¼Œä½†è¯¥æœåŠ¡å™¨å·²ç¼“å­˜äº†æ­¤ç½‘å€æ˜ å°„å…³ç³»ï¼Œåˆ™è°ƒç”¨è¿™ä¸ªIPåœ°å€æ˜ å°„ï¼Œå®ŒæˆåŸŸåè§£æï¼Œæ­¤è§£æä¸å…·æœ‰æƒå¨æ€§ã€‚ 5.å¦‚æœæœ¬åœ°DNSæœåŠ¡å™¨æœ¬åœ°åŒºåŸŸæ–‡ä»¶ä¸ç¼“å­˜è§£æéƒ½å¤±æ•ˆï¼Œåˆ™æ ¹æ®æœ¬åœ°DNSæœåŠ¡å™¨çš„è®¾ç½®ï¼ˆæ˜¯å¦è®¾ç½®è½¬å‘å™¨ï¼‰è¿›è¡ŒæŸ¥è¯¢ï¼Œ å¦‚æœæœªç”¨è½¬å‘æ¨¡å¼ï¼Œæœ¬åœ°DNSå°±æŠŠè¯·æ±‚å‘è‡³ â€œæ ¹DNSæœåŠ¡å™¨â€ï¼Œâ€œæ ¹DNSæœåŠ¡å™¨â€æ”¶åˆ°è¯·æ±‚åä¼šåˆ¤æ–­è¿™ä¸ªåŸŸå(.com)æ˜¯è°æ¥æˆæƒç®¡ç†ï¼Œå¹¶ä¼šè¿”å›ä¸€ä¸ªè´Ÿè´£è¯¥é¡¶çº§åŸŸåæœåŠ¡å™¨çš„ä¸€ä¸ªIPã€‚ æœ¬åœ°DNSæœåŠ¡å™¨æ”¶åˆ°IPä¿¡æ¯åï¼Œå°†ä¼šè”ç³»è´Ÿè´£.comåŸŸçš„è¿™å°æœåŠ¡å™¨ã€‚è¿™å°è´Ÿè´£.comåŸŸçš„æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œå¦‚æœè‡ªå·±æ— æ³•è§£æï¼Œ å®ƒå°±ä¼šæ‰¾ä¸€ä¸ªç®¡ç†.comåŸŸçš„ä¸‹ä¸€çº§DNSæœåŠ¡å™¨åœ°å€(qq.com)ç»™æœ¬åœ°DNSæœåŠ¡å™¨ã€‚å½“æœ¬åœ°DNSæœåŠ¡å™¨æ”¶åˆ°è¿™ä¸ªåœ°å€åï¼Œå°±ä¼šæ‰¾qq.comåŸŸæœåŠ¡å™¨ï¼Œé‡å¤ä¸Šé¢çš„åŠ¨ä½œï¼Œè¿›è¡ŒæŸ¥è¯¢ï¼Œç›´è‡³æ‰¾åˆ°www.qq.comä¸»æœºã€‚ 6.å¦‚æœç”¨çš„æ˜¯è½¬å‘æ¨¡å¼ï¼Œæ­¤DNSæœåŠ¡å™¨å°±ä¼šæŠŠè¯·æ±‚è½¬å‘è‡³ä¸Šä¸€çº§DNSæœåŠ¡å™¨ï¼Œç”±ä¸Šä¸€çº§æœåŠ¡å™¨è¿›è¡Œè§£æï¼Œä¸Šä¸€çº§æœåŠ¡å™¨å¦‚æœä¸èƒ½è§£æï¼Œæˆ–æ‰¾æ ¹DNSæˆ–æŠŠè½¬è¯·æ±‚è½¬è‡³ä¸Šä¸Šçº§ï¼Œä»¥æ­¤å¾ªç¯ã€‚ ä¸ç®¡æ˜¯æœ¬åœ°DNSæœåŠ¡å™¨ç”¨æ˜¯æ˜¯è½¬å‘ï¼Œè¿˜æ˜¯æ ¹æç¤ºï¼Œæœ€åéƒ½æ˜¯æŠŠç»“æœè¿”å›ç»™æœ¬åœ°DNSæœåŠ¡å™¨ï¼Œç”±æ­¤DNSæœåŠ¡å™¨å†è¿”å›ç»™å®¢æˆ·æœºã€‚ é€’å½’æŸ¥è¯¢ä¸è¿­ä»£æŸ¥è¯¢ ä¸€ã€ä¸»æœºå‘æœ¬åœ°åŸŸåæœåŠ¡å™¨çš„æŸ¥è¯¢ä¸€èˆ¬éƒ½æ˜¯é‡‡ç”¨é€’å½’æŸ¥è¯¢ã€‚ â€‹ æ‰€è°“é€’å½’æŸ¥è¯¢å°±æ˜¯ï¼šå¦‚æœä¸»æœºæ‰€è¯¢é—®çš„æœ¬åœ°åŸŸåæœåŠ¡å™¨ä¸çŸ¥é“è¢«æŸ¥è¯¢çš„åŸŸåçš„IPåœ°å€ï¼Œé‚£ä¹ˆæœ¬åœ°åŸŸåæœåŠ¡å™¨å°±ä»¥DNSå®¢æˆ·çš„èº«ä»½ï¼Œ â€‹ å‘å…¶å®ƒæ ¹åŸŸåæœåŠ¡å™¨ç»§ç»­å‘å‡ºæŸ¥è¯¢è¯·æ±‚æŠ¥æ–‡(å³æ›¿ä¸»æœºç»§ç»­æŸ¥è¯¢)ï¼Œè€Œä¸æ˜¯è®©ä¸»æœºè‡ªå·±è¿›è¡Œä¸‹ä¸€æ­¥æŸ¥è¯¢ã€‚ â€‹ å› æ­¤ï¼Œé€’å½’æŸ¥è¯¢è¿”å›çš„æŸ¥è¯¢ç»“æœæˆ–è€…æ˜¯æ‰€è¦æŸ¥è¯¢çš„IPåœ°å€ï¼Œæˆ–è€…æ˜¯æŠ¥é”™ï¼Œè¡¨ç¤ºæ— æ³•æŸ¥è¯¢åˆ°æ‰€éœ€çš„IPåœ°å€ã€‚ äºŒã€æœ¬åœ°åŸŸåæœåŠ¡å™¨å‘æ ¹åŸŸåæœåŠ¡å™¨çš„æŸ¥è¯¢çš„è¿­ä»£æŸ¥è¯¢ã€‚ â€‹ è¿­ä»£æŸ¥è¯¢çš„ç‰¹ç‚¹ï¼šå½“æ ¹åŸŸåæœåŠ¡å™¨æ”¶åˆ°æœ¬åœ°åŸŸåæœåŠ¡å™¨å‘å‡ºçš„è¿­ä»£æŸ¥è¯¢è¯·æ±‚æŠ¥æ–‡æ—¶ï¼Œè¦ä¹ˆç»™å‡ºæ‰€è¦æŸ¥è¯¢çš„IPåœ°å€ï¼Œè¦ä¹ˆå‘Šè¯‰æœ¬åœ°æœåŠ¡å™¨ï¼šâ€œä½ ä¸‹ä¸€æ­¥åº”å½“å‘å“ªä¸€ä¸ªåŸŸåæœåŠ¡å™¨è¿›è¡ŒæŸ¥è¯¢â€ã€‚ â€‹ ç„¶åè®©æœ¬åœ°æœåŠ¡å™¨è¿›è¡Œåç»­çš„æŸ¥è¯¢ã€‚æ ¹åŸŸåæœåŠ¡å™¨é€šå¸¸æ˜¯æŠŠè‡ªå·±çŸ¥é“çš„é¡¶çº§åŸŸåæœåŠ¡å™¨çš„IPåœ°å€å‘Šè¯‰æœ¬åœ°åŸŸåæœåŠ¡å™¨ï¼Œè®©æœ¬åœ°åŸŸåæœåŠ¡å™¨å†å‘é¡¶çº§åŸŸåæœåŠ¡å™¨æŸ¥è¯¢ã€‚ â€‹ é¡¶çº§åŸŸåæœåŠ¡å™¨åœ¨æ”¶åˆ°æœ¬åœ°åŸŸåæœåŠ¡å™¨çš„æŸ¥è¯¢è¯·æ±‚åï¼Œè¦ä¹ˆç»™å‡ºæ‰€è¦æŸ¥è¯¢çš„IPåœ°å€ï¼Œè¦ä¹ˆå‘Šè¯‰æœ¬åœ°æœåŠ¡å™¨ä¸‹ä¸€æ­¥åº”å½“å‘å“ªä¸€ä¸ªæƒé™åŸŸåæœåŠ¡å™¨è¿›è¡ŒæŸ¥è¯¢ã€‚ â€‹ æœ€åï¼ŒçŸ¥é“äº†æ‰€è¦è§£æçš„IPåœ°å€æˆ–æŠ¥é”™ï¼Œç„¶åæŠŠè¿™ä¸ªç»“æœè¿”å›ç»™å‘èµ·æŸ¥è¯¢çš„ä¸»æœº é€’å½’ï¼šå®¢æˆ·ç«¯åªå‘ä¸€æ¬¡è¯·æ±‚ï¼Œè¦æ±‚å¯¹æ–¹ç»™å‡ºæœ€ç»ˆç»“æœã€‚ è¿­ä»£ï¼šå®¢æˆ·ç«¯å‘å‡ºä¸€æ¬¡è¯·æ±‚ï¼Œå¯¹æ–¹å¦‚æœæ²¡æœ‰æˆæƒå›ç­”ï¼Œå®ƒå°±ä¼šè¿”å›ä¸€ä¸ªèƒ½è§£ç­”è¿™ä¸ªæŸ¥è¯¢çš„å…¶å®ƒåç§°æœåŠ¡å™¨åˆ—è¡¨ï¼Œ â€‹ å®¢æˆ·ç«¯ä¼šå†å‘è¿”å›çš„åˆ—è¡¨ä¸­å‘å‡ºè¯·æ±‚ï¼Œç›´åˆ°æ‰¾åˆ°æœ€ç»ˆè´Ÿè´£æ‰€æŸ¥åŸŸåçš„åç§°æœåŠ¡å™¨ï¼Œä»å®ƒå¾—åˆ°æœ€ç»ˆç»“æœã€‚ æˆæƒå›ç­”ï¼šå‘dnsæœåŠ¡å™¨æŸ¥è¯¢ä¸€ä¸ªåŸŸåï¼Œåˆšå¥½è¿™ä¸ªåŸŸåæ˜¯æœ¬æœåŠ¡å™¨è´Ÿè´£ï¼Œè¿”å›çš„ç»“æœå°±æ˜¯æˆæƒå›ç­”ã€‚ ä»é€’å½’å’Œè¿­ä»£æŸ¥è¯¢å¯ä»¥çœ‹å‡ºï¼š å®¢æˆ·ç«¯-æœ¬åœ°dnsæœåŠ¡ç«¯ï¼šè¿™éƒ¨åˆ†å±äºé€’å½’æŸ¥è¯¢ã€‚ æœ¬åœ°dnsæœåŠ¡ç«¯â€”å¤–ç½‘ï¼šè¿™éƒ¨åˆ†å±äºè¿­ä»£æŸ¥è¯¢ã€‚ é€’å½’æŸ¥è¯¢æ—¶ï¼Œè¿”å›çš„ç»“æœåªæœ‰ä¸¤ç§:æŸ¥è¯¢æˆåŠŸæˆ–æŸ¥è¯¢å¤±è´¥. è¿­ä»£æŸ¥è¯¢ï¼Œåˆç§°ä½œé‡æŒ‡å¼•,è¿”å›çš„æ˜¯æœ€ä½³çš„æŸ¥è¯¢ç‚¹æˆ–è€…ä¸»æœºåœ°å€. DNSç¼“å­˜æœºåˆ¶å…³äºDNSç¼“å­˜çš„æœºåˆ¶ï¼Œæœ‰ä¸€ç¯‡éå¸¸è¯¦ç»†çš„æ–‡ç« What really happens when you navigate to a URLã€‚ ç®€å•æ¥è¯´ï¼Œä¸€æ¡åŸŸåçš„DNSè®°å½•ä¼šåœ¨æœ¬åœ°æœ‰ä¸¤ç§ç¼“å­˜ï¼šæµè§ˆå™¨ç¼“å­˜å’Œæ“ä½œç³»ç»Ÿ(OS)ç¼“å­˜ã€‚åœ¨æµè§ˆå™¨ä¸­è®¿é—®çš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆè®¿é—®æµè§ˆå™¨ç¼“å­˜ï¼Œ å¦‚æœæœªå‘½ä¸­åˆ™è®¿é—®OSç¼“å­˜ï¼Œåˆ™è®¿é—®æœ¬åœ°hostsæ–‡ä»¶ï¼Œè‹¥æœªå‘½ä¸­æœ€åå†è®¿é—®DNSæœåŠ¡å™¨(ä¸€èˆ¬æ˜¯ISPæä¾›)ï¼Œç„¶åDNSæœåŠ¡å™¨ä¼šé€’å½’å¼çš„æŸ¥æ‰¾åŸŸåè®°å½•ï¼Œç„¶åè¿”å›ã€‚ DNSè®°å½•ä¼šæœ‰ä¸€ä¸ªttlå€¼(time to live)ï¼Œå•ä½æ˜¯ç§’ï¼Œæ„æ€æ˜¯è¿™ä¸ªè®°å½•æœ€å¤§æœ‰æ•ˆæœŸæ˜¯å¤šå°‘ã€‚ç»è¿‡å®éªŒï¼ŒOSç¼“å­˜ä¼šå‚è€ƒttlå€¼ï¼Œä½†æ˜¯ä¸å®Œå…¨ç­‰äºttlå€¼ï¼Œ è€Œæµè§ˆå™¨DNSç¼“å­˜çš„æ—¶é—´è·Ÿttlå€¼æ— å…³ï¼Œæ¯ç§æµè§ˆå™¨éƒ½ä½¿ç”¨ä¸€ä¸ªå›ºå®šå€¼ã€‚ è¿™é‡Œæœ‰ä¸€ç¯‡æ–‡ç« ï¼Œåšè¿‡è¯¦ç»†çš„æµ‹è¯•Why Web Browser DNS Caching Can Be A Bad Thingï¼š Windowsè®¿é—®DNSåä¼šæŠŠè®°å½•ä¿å­˜ä¸€æ®µçŸ­æš‚çš„æ—¶é—´ï¼Œ å¯é€šè¿‡ipconfig /displaydns æŸ¥çœ‹windowsçš„DNSç¼“å­˜ã€é€šè¿‡ipconfig /flushdnsæ¥æ¸…é™¤ã€‚ å·¥å…·å’Œå‘½ä»¤ç›¸å…³çš„å·¥å…·å’Œå‘½ä»¤: dig,nslookup,hostç­‰.å…¶ä¸­ä»¥digå‘½ä»¤çš„åŠŸèƒ½æœ€ä¸ºå¼ºå¤§å’Œçµæ´». digå‘½ä»¤å…¸å‹åº”ç”¨å½¢å¦‚ï¼š dig @server name type @server: æŒ‡å®šåŸŸåæœåŠ¡å™¨ **name:**æŒ‡å®šæŸ¥è¯¢è¯·æ±‚èµ„æºçš„åŸŸå **type:**æŒ‡å®šæŸ¥è¯¢ç±»å‹ï¼Œå¦‚Aã€CNAMEã€SRVã€MXã€SIGç­‰ï¼Œå¦‚æœä¸æŒ‡å®štypeï¼Œé»˜è®¤ä¸ºA æŸ¥è¯¢æŸä¸ªåŸŸåè§£æçš„å…¨è¿‡ç¨‹:(æ­¤æ—¶ä¸ºè¿­ä»£æŸ¥è¯¢) 1$ dig @8.8.8.8 163.com +trace å‚è€ƒèµ„æ–™ï¼š DNSé€’å½’æŸ¥è¯¢ä¸è¿­ä»£æŸ¥è¯¢ - çšˆä¾ä¹‹è·¯ - åšå®¢å›­ (cnblogs.com) http://blog.csdn.net/wyq_tc25/article/details/51679520 http://blog.csdn.net/wytheonly/article/details/37925067 http://www.cnblogs.com/Juntaran/p/5827110.html http://magic3.blog.51cto.com/1146917/1354084 http://blog.csdn.net/realmeh/article/details/22663807","link":"/2022/01/06/DNS/"},{"title":"Design Pattrens","text":"è®¾è®¡æ¨¡å¼çš„å…­ä¸ªåŸåˆ™ å•ä¸€åŸåˆ™æ¯ä¸ªç±»æˆ–æ–¹æ³•éƒ½åº”è¯¥åªè¢«ä¸€ä¸ªåŸå› å½±å“ å¼€é—­åŸåˆ™ç±»æˆ–æ–¹æ³•åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾, å¯¹ä¿®æ”¹å°é—­ é‡Œæ°æ›¿æ¢åŸåˆ™å­ç±»å‡ºç°çš„åœ°æ–¹ä¸€å®šå¯ä»¥è¢«çˆ¶ç±»æ›¿æ¢ æ¥å£éš”ç¦»åŸåˆ™æ¥å£çš„ç²’åº¦è¦å°½é‡çš„å° ä¾èµ–å€’ç½®åŸåˆ™æŠ½è±¡ä¾èµ–æŠ½è±¡, å…·ä½“ä¾èµ–æŠ½è±¡ è¿ªç±³ç‰¹åŸåˆ™å°½é‡æ— çŸ¥, æœ‹å‹çš„æœ‹å‹ä¸æ˜¯æˆ‘çš„æœ‹å‹ äºŒåä¸‰ç§è®¾è®¡æ¨¡å¼å…±æœ‰ä¸‰ç±»23ç§è®¾è®¡æ¨¡å¼ é¦–å…ˆï¼Œç®€å•å·¥å‚ä¸æ˜¯æ ‡å‡†çš„GoFè®¾è®¡æ¨¡å¼ï¼Œä½†ä¾ç„¶æ˜¯å¸¸è§çš„åˆ›å»ºå¯¹è±¡æ–¹å¼ã€‚ ç®€å•å·¥å‚æ¨¡å¼ï¼š å…³æ³¨ç‚¹ï¼š ç®€å•å·¥å‚æ¨¡å¼å…³æ³¨äºé€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„å·¥å‚ç±»åˆ›å»ºä¸åŒçš„å¯¹è±¡ã€‚ ç®€å•å·¥å‚é€šå¸¸æ²¡æœ‰å­ç±»ã€‚ ä½†å½“ä»ä¸€ä¸ªç®€å•å·¥å‚ä¸­æŠ½å–å‡ºå­ç±»åï¼Œ å®ƒçœ‹ä¸Šå»å°±ä¼šæ›´åƒç»å…¸çš„å·¥å‚æ–¹æ³•æ¨¡å¼äº†ã€‚ é¡ºä¾¿æä¸€å¥ï¼Œ å¦‚æœä½ å°†ä¸€ä¸ªç®€å•å·¥å‚å£°æ˜ä¸º abstractç±»å‹ï¼Œ å®ƒå¹¶ä¸ä¼šç¥å¥‡åœ°å˜æˆæŠ½è±¡å·¥å‚æ¨¡å¼ã€‚ e.g: ChoiceBarFactory ç¬¬ä¸€ç±»æ˜¯åˆ›å»ºå‹: å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆè™šæ‹Ÿæ„é€ å‡½æ•°ã€Factory Methodï¼‰å…³æ³¨ç‚¹ï¼š å·¥å‚æ–¹æ³•æ¨¡å¼ä¾§é‡äºå•ä¸ªå¯¹è±¡çš„åˆ›å»ºï¼Œæ¯ä¸ªå…·ä½“å·¥å‚è´Ÿè´£åˆ›å»ºä¸€ä¸ªå…·ä½“äº§å“ã€‚ å¦‚æœåœ¨åŸºç±»åŠå…¶æ‰©å±•çš„å­ç±»ä¸­éƒ½æœ‰ä¸€ä¸ªæ„å»ºæ–¹æ³•çš„è¯ï¼Œ é‚£å®ƒå¯èƒ½å°±æ˜¯å·¥å‚æ–¹æ³•ã€‚ e.g NumberFormat.getInstance() æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract Factoryï¼‰å…³æ³¨ç‚¹ï¼š æŠ½è±¡å·¥å‚æ¨¡å¼å…³æ³¨ä¸€ç»„ç›¸å…³å¯¹è±¡çš„åˆ›å»ºï¼Œæ¯ä¸ªå…·ä½“å·¥å‚è´Ÿè´£åˆ›å»ºä¸€ç»„ç›¸å…³çš„äº§å“å¯¹è±¡ã€‚ å¦‚æœä½ çš„ç¨‹åºä¸­å¹¶ä¸æ¶‰åŠäº§å“ç³»åˆ—çš„è¯ï¼Œ é‚£å°±ä¸éœ€è¦æŠ½è±¡å·¥å‚ã€‚ å†æ¬¡é‡ç”³ï¼Œ è®¸å¤šäººåˆ†ä¸æ¸…æŠ½è±¡å·¥å‚æ¨¡å¼å’Œå£°æ˜ä¸º abstractçš„ç®€å•å·¥å‚ã€‚ ä¸è¦çŠ¯è¿™ä¸ªé”™è¯¯ï¼ ç”Ÿæˆå™¨æ¨¡å¼ï¼ˆæ„å»ºè€…æ¨¡å¼ã€Buideræ¨¡å¼ï¼‰ç”Ÿæˆå™¨å…³æ³¨äºå¦‚ä½•åˆ†æ­¥ç”Ÿæˆå¯¹è±¡ï¼Œé€šå¸¸æ”¯æŒæ–¹æ³•é“¾e.gï¼š StringBuilder OkHttpçš„Request.Builder() åŸå‹æ¨¡å¼ï¼ˆå…‹éš†æ¨¡å¼ã€ProtoTypeï¼‰ç”±è¢«å¤åˆ¶æ–¹è‡ªå·±æä¾›clone() or copy()æ–¹æ³•ï¼Œæ•…è€Œè°ƒç”¨æ–¹å¯ä¸æ„ŸçŸ¥å†…éƒ¨å®ç°çš„æƒ…å†µä¸‹è·å–å…¶å¤‡ä»½ åŸå‹å¯ä»¥ç®€å•åœ°é€šè¿‡ cloneæˆ– copyç­‰æ–¹æ³•æ¥è¯†åˆ«ã€‚ e.gï¼šJava çš„ Cloneable ï¼ˆå¯å…‹éš†ï¼‰ æ¥å£å°±æ˜¯ç«‹å³å¯ç”¨çš„åŸå‹æ¨¡å¼ã€‚ å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰å•ä¾‹æ¨¡å¼è®©ä½ èƒ½å¤Ÿä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œ å¹¶æä¾›ä¸€ä¸ªè®¿é—®è¯¥å®ä¾‹çš„å…¨å±€èŠ‚ç‚¹ã€‚ e.g kotlinçš„object classï¼Œé¥¿æ±‰å¼å•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§åœ¨ç±»åŠ è½½æ—¶å°±åˆ›å»ºå®ä¾‹çš„å•ä¾‹æ¨¡å¼ã€‚åœ¨ Kotlin ä¸­ï¼Œä½¿ç”¨ object å…³é”®å­—å£°æ˜çš„å¯¹è±¡åœ¨é¦–æ¬¡è¢«è®¿é—®æ—¶å°±ä¼šè¢«åˆ›å»ºï¼Œå› æ­¤å®ƒæ˜¯ä¸€ç§çº¿ç¨‹å®‰å…¨çš„å•ä¾‹å®ç°æ–¹å¼ã€‚ ç¬¬äºŒç±»æ˜¯ç»“æ„å‹æ¨¡å¼ é€‚é…å™¨æ¨¡å¼ï¼ˆAdaptï¼‰ä½¿ä¸å…¼å®¹çš„å¯¹è±¡èƒ½ç›¸äº’åˆä½œï¼Œæ¥æ”¶ä¸€ä¸ªå¯¹è±¡çš„è°ƒç”¨ï¼Œå°†å…¶è½¬åŒ–ä¸ºå¦ä¸€ä¸ªå¯¹è±¡å¯è¯†åˆ«çš„æ ¼å¼å’Œæ¥å£e.gï¼š RecyclerView.Adapter java.util.Arrays#asList() ä»£ç†æ¨¡å¼ ï¼ˆProxyï¼‰å…³æ³¨å°† é‡é‡çº§/è¿œç¨‹/ç¼“å­˜ ç”¨ä»£ç†çš„æ–¹å¼ï¼Œä¸ºå…¶æä¾›å ä½ç¬¦æˆ–æ›¿ä»£å“ ä»£ç†ä¸å…¶æœåŠ¡å¯¹è±¡éµå¾ªåŒä¸€æ¥å£ï¼Œ ä½¿å¾—è‡ªå·±å’ŒæœåŠ¡å¯¹è±¡å¯ä»¥äº’æ¢ e.gï¼š binderProxy Binder å’Œ BinderProxy åœ¨ Android ä¸­å¯ä»¥è¢«è§†ä¸ºä»£ç†æ¨¡å¼çš„ä¸€ç§å®ç°ã€‚ åœ¨ Android ä¸­ï¼ŒBinder æ˜¯ç”¨äºå®ç°è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼ŒInter-Process Communicationï¼‰çš„æœºåˆ¶ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ Binder å®ä¾‹ï¼Œç”¨äºå¤„ç†æœ¬åœ°è¿›ç¨‹å†…éƒ¨çš„é€šä¿¡ï¼Œä»¥åŠä¸å…¶ä»–è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚BinderProxy åˆ™æ˜¯ç”¨äºåœ¨å®¢æˆ·ç«¯è¿›ç¨‹ä¸­ä»£ç†æœåŠ¡ç«¯è¿›ç¨‹ä¸­çš„ Binder å¯¹è±¡ã€‚ è¿™ç§æƒ…å†µä¸‹ï¼ŒBinderProxy å¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ç§ä»£ç†ï¼Œç”¨äºä»£è¡¨æœåŠ¡ç«¯è¿›ç¨‹ä¸­çš„ Binder å¯¹è±¡ã€‚å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡è°ƒç”¨ BinderProxy çš„æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯åœ¨å‘èµ·è·¨è¿›ç¨‹è°ƒç”¨ï¼Œè¿™ä¸ªè°ƒç”¨ä¼šè¢«ä¼ é€åˆ°æœåŠ¡ç«¯è¿›ç¨‹ä¸­çš„å¯¹åº” Binder å¯¹è±¡ã€‚è¿™ä¸ªè¿‡ç¨‹ç¬¦åˆä»£ç†æ¨¡å¼çš„åŸºæœ¬æ€æƒ³ï¼Œä¸€ä¸ªå¯¹è±¡ï¼ˆBinderProxyï¼‰ä»£ç†å¦ä¸€ä¸ªå¯¹è±¡ï¼ˆæœåŠ¡ç«¯è¿›ç¨‹ä¸­çš„ Binder å¯¹è±¡ï¼‰æ‰§è¡Œä¸€äº›æ“ä½œã€‚ æ€»ä¹‹ï¼ŒBinder å’Œ BinderProxy åœ¨ Android ä¸­å¯ä»¥è¢«è§†ä¸ºä»£ç†æ¨¡å¼çš„ä¸€ç§åº”ç”¨ï¼Œç”¨äºå®ç°è¿›ç¨‹é—´é€šä¿¡ã€‚ RetrofitåŠ¨æ€ä»£ç† äº«å…ƒæ¨¡å¼ï¼ˆç¼“å­˜æ¨¡å¼ï¼‰åˆ©ç”¨å¦‚Integerç¼“å­˜æ± çš„æŠ€æœ¯èˆ¬ï¼Œå°†å¯å¤ç”¨çš„å¯¹è±¡é€šè¿‡å…±äº«çš„æ–¹å¼ï¼Œè®©æœ‰é™çš„å†…å­˜å¯å®¹çº³æ›´å¤šçš„å¯¹è±¡e.gï¼š ç¼“å­˜äº†[-128, 127]çš„Integerç±»ï¼Œ å¤–è§‚æ¨¡å¼ è£…é¥°æ¨¡å¼ æ¡¥æ¥æ¨¡å¼ä¸é€‚é…å™¨æ¨¡å¼å¾ˆåƒï¼ŒåŒºåˆ†äºé€‚é…å™¨æ¨¡å¼çš„å¯èƒ½å°±æ˜¯æ¡¥æ¥æ¨¡å¼æ›´å¤šç”¨äºå‰æœŸè®¾è®¡ï¼Œæœ‰é¢„è°‹ã€‚ æ¡¥æ¥æ¨¡å¼é€šå¸¸ä¼šäºå¼€å‘å‰æœŸè¿›è¡Œè®¾è®¡ï¼Œ ä½¿ä½ èƒ½å¤Ÿå°†ç¨‹åºçš„å„ä¸ªéƒ¨åˆ†ç‹¬ç«‹å¼€æ¥ä»¥ä¾¿å¼€å‘ã€‚ å¦ä¸€æ–¹é¢ï¼Œ é€‚é…å™¨æ¨¡å¼é€šå¸¸åœ¨å·²æœ‰ç¨‹åºä¸­ä½¿ç”¨ï¼Œ è®©ç›¸äº’ä¸å…¼å®¹çš„ç±»èƒ½å¾ˆå¥½åœ°åˆä½œã€‚ e.gï¼šå¦‚okhttp3.internal.http.BridgeInterceptorï¼Œæ¶‰åŠäº†headerï¼Œè¯·æ±‚å’Œå“åº”çš„è½¬æ¢ã€å¤„ç†å’Œä¼ è¾“ï¼Œä½†å¹¶ä¸æ˜¯æ ‡å‡†çš„æ¡¥æ¥æ¨¡å¼ï¼Œæ¡¥æ¥æ¨¡å¼æ›´å¤šåœ°æ¶‰åŠåˆ°å°†æŠ½è±¡å’Œå®ç°åˆ†ç¦»ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥ç‹¬ç«‹åœ°å˜åŒ–ã€‚BridgeInterceptor æ›´å¤šåœ°å…³æ³¨åœ¨è¯·æ±‚å’Œå“åº”ä¹‹é—´è¿›è¡Œæ•°æ®çš„è½¬æ¢å’Œåè°ƒï¼Œä»¥ä¾¿è¿›è¡Œæœ‰æ•ˆçš„ç½‘ç»œé€šä¿¡ã€‚ ç»„åˆæ¨¡å¼ ç¬¬ä¸‰ç±»æ˜¯è¡Œä¸ºæ¨¡å¼ è´£ä»»é“¾æ¨¡å¼å…è®¸ä½ å°†è¯·æ±‚æ²¿ç€å¤„ç†è€…é“¾è¿›è¡Œå‘é€ã€‚æ”¶åˆ°è¯·æ±‚åï¼Œæ¯ä¸ªå¤„ç†è€…å‡å¯å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œæˆ–å°†å…¶ä¼ é€’ç»™é“¾ä¸Šçš„ä¸‹ä¸ªå¤„ç†è€…ã€‚ æ¯ä¸ªå¤„ç†è€…éƒ½å¯å¤„ç†æˆ–ç»“æŸè¯·æ±‚ï¼Œç”±äºæ¯ä¸ªå¤„ç†è€…éƒ½æŒæœ‰ä¸‹ä¸€ä¸ªå¤„ç†èŠ‚ç‚¹ï¼Œæ•…è€Œè¯·æ±‚å°†æŒ‰é¡ºåºæ²¿ç€é“¾æ¡ä¼ é€’ã€‚ï¼ˆå¯èƒ½ä¼šæœ‰å¤„ç†è€…å› ä¸ºå‰é¢èŠ‚ç‚¹çš„æå‰è¿”å›è€Œæ²¡æœ‰å¤„ç†ï¼‰ e.gï¼š OkHttpä¸­RealCall.getResponseWithInterceptorChain()å³æ˜¯ä¸€ä¸ªè´£ä»»é“¾æ¨¡å¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯éƒ½ä¼šè¿½åŠ å¯¹è¯·æ±‚æˆ–å“åº”çš„å¤„ç†ï¼› Androidçš„äº‹ä»¶åˆ†å‘æœºåˆ¶ä¹Ÿæ˜¯ä¸€ç§è´£ä»»é“¾ï¼Œäº‹ä»¶åˆ†å‘ä¸­ï¼Œå¦‚æœäº‹ä»¶è¢«å¤„ç†äº†å°±ä¼šç›´æ¥è¿”å›ï¼› è¿™äº›å…¶å®éƒ½æ˜¯è´£ä»»é“¾ï¼Œæ— è®ºè¯·æ±‚æ˜¯å¦å¯è¢«æ‰€æœ‰å¤„ç†è€…å¤„ç†è¿‡ã€‚ å‘½ä»¤æ¨¡å¼å°†è¯·æ±‚è½¬æ¢ä¸ºä¸€ä¸ªåŒ…å«ä¸è¯·æ±‚ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯çš„ç‹¬ç«‹å¯¹è±¡ã€‚ è¯¥è½¬æ¢è®©ä½ èƒ½æ ¹æ®ä¸åŒçš„è¯·æ±‚å°†æ–¹æ³•å‚æ•°åŒ–ã€ å»¶è¿Ÿè¯·æ±‚æ‰§è¡Œæˆ–å°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œ ä¸”èƒ½å®ç°å¯æ’¤é”€æ“ä½œã€‚ è¿­ä»£å™¨æ¨¡å¼ ä¸­ä»‹è€…æ¨¡å¼ å¤‡å¿˜å½•æ¨¡å¼ è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆ äº‹ä»¶è®¢é˜…è€…ã€ç›‘å¬è€…ã€Event-Subscriberã€Listenerã€Observerï¼‰å‘å¸ƒè€…å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªè®¢é˜…è€…å¯¹è±¡åˆ—è¡¨ e.gï¼š Animator.addListener() View.setOnClickListener çŠ¶æ€æ¨¡å¼e.gï¼škotlinçš„åç¨‹çŠ¶æ€æœº ç­–ç•¥æ¨¡å¼æœ‰ä¸€ç§è¯´æ³•ï¼šï¼ˆå°¤å…¶é’ˆå¯¹ç­–ç•¥æ¨¡å¼ï¼‰ä¸€ç§é’ˆå¯¹ä¸å®Œå–„ç¼–ç¨‹è¯­è¨€çš„è¹©è„šè§£å†³æ–¹æ¡ˆé€šå¸¸å½“æ‰€é€‰ç¼–ç¨‹è¯­è¨€æˆ–æŠ€æœ¯ç¼ºå°‘å¿…è¦çš„æŠ½è±¡åŠŸèƒ½æ—¶ï¼Œ äººä»¬æ‰éœ€è¦è®¾è®¡æ¨¡å¼ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ æ¨¡å¼æ˜¯ä¸€ç§å¯ä¸ºè¯­è¨€æä¾›æ›´ä¼˜åŠŸèƒ½çš„è¹©è„šè§£å†³æ–¹æ¡ˆã€‚ ä¾‹å¦‚ï¼Œ ç­–ç•¥æ¨¡å¼åœ¨ç»å¤§éƒ¨åˆ†ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸­å¯ä»¥ç®€å•åœ°ä½¿ç”¨åŒ¿å ï¼ˆlambdaï¼‰ å‡½æ•°æ¥å®ç°ã€‚ e.gï¼š Collections.sort()ï¼šCollections.sort()æœ€ç»ˆè°ƒç”¨çš„Listï¼ˆç­–ç•¥åŸºç±»ï¼‰çš„å­ç±»(ArrayList/Vector).sortï¼› lambda æ¨¡æ¿è®¿é—®æ¨¡å¼ è®¿é—®è€…æ¨¡å¼ è§£é‡Šå™¨æ¨¡å¼","link":"/2023/08/17/Design-Pattrens/"},{"title":"Concurrent","text":"https://www.wwwbuild.net/JavaAmazing/112187.html å¹¶å‘æ“ä½œï¼šåŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§1ã€åŸå­æ€§å³ä¸€ä¸ªæ“ä½œæˆ–è€…å¤šä¸ªæ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¹¶ä¸”æ‰§è¡Œçš„è¿‡ç¨‹ä¸ä¼šè¢«ä»»ä½•å› ç´ æ‰“æ–­ï¼Œè¦ä¹ˆå°±éƒ½ä¸æ‰§è¡Œã€‚ å¦‚java.util.concurrent.atomicåŒ…ä¸‹çš„åŸå­ç±»ï¼Œå°±æ˜¯ç”¨CAS(Compare And Swap)ä¿è¯åŸå­æ€§å’Œå¯è§æ€§ï¼ˆå†…å­˜å±éšœï¼‰ è™½ç„¶ java.util.concurrent.atomic æä¾›äº†åŸå­æ“ä½œï¼Œä½†è¿™äº›è§£å†³æ–¹æ¡ˆä¸»è¦é’ˆå¯¹å•ä¸€å˜é‡ã€‚å¯¹äºæ¶‰åŠå¤šä¸ªå˜é‡æ—¶çš„åŸå­æ€§æ“ä½œï¼Œä»ç„¶éœ€è¦ä½¿ç”¨é«˜çº§åŒæ­¥æœºåˆ¶ï¼ˆå¦‚ synchronized å—æˆ– ReentrantLockï¼‰ã€‚ Java å†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰ç¡®ä¿åœ¨ä½¿ç”¨åŸå­ç±»å’Œ CAS æ“ä½œæ—¶ï¼Œæ•°å€¼çš„æ›´æ–°å¯¹å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ã€‚è¿™æ˜¯é€šè¿‡å†…å­˜å±éšœæ¥å®ç°çš„ã€‚ 2ã€å¯è§æ€§å¯è§æ€§æ˜¯æŒ‡å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼ã€‚ å¦‚volatileèƒ½ä¿è¯è¢«ä¿®é¥°å˜é‡çš„å¯è§æ€§ã€æœ‰åºæ€§ï¼›åŸå­ç±»å¯ä»¥ä¿è¯åŸå­æ€§å’Œå¯è§æ€§ï¼› å¯è§æ€§ï¼švolatile å…³é”®å­—ç¡®ä¿å˜é‡çš„æ›´æ–°å¯¹æ‰€æœ‰çº¿ç¨‹ç«‹å³å¯è§ï¼Œé¿å…çº¿ç¨‹è¯»å–åˆ°å˜é‡çš„è¿‡æœŸå€¼ã€‚ ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ï¼šç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶ä¸ä¼šæŠŠ volatile å˜é‡çš„å†™æ“ä½œä¸ä¹‹å‰çš„å†…å­˜æ“ä½œé‡æ’åºï¼Œä¹Ÿä¸ä¼šæŠŠ volatile å˜é‡çš„è¯»æ“ä½œä¸ä¹‹åçš„å†…å­˜æ“ä½œé‡æ’åºã€‚ 3ã€æœ‰åºæ€§å³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚ï¼ˆæŒ‡ä»¤ç¼–æ’å¯èƒ½ä¼šå¯¼è‡´å¤šçº¿ç¨‹ä¸‹æ‰§è¡Œç»“æœä¸ä¸€è‡´ï¼‰ å¦‚volatileèƒ½ä¿è¯è¢«ä¿®é¥°å˜é‡çš„å¯è§æ€§ã€æœ‰åºæ€§ synchronizedå…³é”®å­—ä¸‰è€…éƒ½èƒ½ä¿è¯ã€‚ Volatile å’Œsynchronizedçš„åŒºåˆ«ï¼šjava.util.concurrent.atomicåŒ…çš„åŸå­ç±»å¯ä»¥ä¿è¯æ•°æ®çš„åŸå­æ€§ã€å¯è§æ€§ï¼›volatileå…³é”®å­—èƒ½ä¿è¯æ•°æ®çš„å¯è§æ€§ã€æœ‰åºæ€§ï¼Œä½†ä¸èƒ½ä¿è¯æ•°æ®çš„åŸå­æ€§ã€‚synchronizedå…³é”®å­—ä¸‰è€…éƒ½èƒ½ä¿è¯ã€‚ 1ï¼šå¹¶å‘ç‰¹æ€§æ¯”è¾ƒï¼švolatileå…³é”®å­—èƒ½ä¿è¯æ•°æ®çš„å¯è§æ€§ã€æœ‰åºæ€§ï¼Œä½†ä¸èƒ½ä¿è¯æ•°æ®çš„åŸå­æ€§ï¼ˆå³volatile int x; x++ æ˜¯ä¸‰æ­¥æ“ä½œï¼šä¸€å–xå€¼ï¼ŒäºŒåŠ ä¸€ï¼Œä¸‰èµ‹å€¼å›xï¼‰ã€‚synchronizedå…³é”®å­—ä¸¤è€…éƒ½èƒ½ä¿è¯ã€‚ æœ‰åºæ€§åˆ™volatileå’Œsynchronizedéƒ½èƒ½ä¿è¯ï¼Œvolatileå…³é”®å­—ç¦æ­¢JVMç¼–è¯‘å™¨å·²åŠå¤„ç†å™¨å¯¹å…¶è¿›è¡Œé‡æ’åº, synchronizedä¿è¯é¡ºåºæ€§æ˜¯ä¸²è¡ŒåŒ–çš„ç»“æœï¼Œä½†åŒæ­¥å—é‡Œçš„è¯­å¥æ˜¯ä¼šå‘ç”ŸæŒ‡ä»¤ä»æ’ã€‚ 2ï¼švolatile çš„åŸç† 1). ä¿®æ”¹volatileå˜é‡æ—¶ä¼šå¼ºåˆ¶å°†ä¿®æ”¹åçš„å€¼åˆ·æ–°çš„ä¸»å†…å­˜ä¸­ã€‚ 2). ä¿®æ”¹volatileå˜é‡åä¼šå¯¼è‡´å…¶ä»–çº¿ç¨‹å·¥ä½œå†…å­˜ä¸­å¯¹åº”çš„å˜é‡å€¼å¤±æ•ˆã€‚å› æ­¤ï¼Œå†è¯»å–è¯¥å˜é‡å€¼çš„æ—¶å€™å°±éœ€è¦é‡æ–°ä»è¯»å–ä¸»å†…å­˜ä¸­çš„å€¼ã€‚ 3). ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ï¼šç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶ä¸ä¼šæŠŠ volatile å˜é‡çš„å†™æ“ä½œä¸ä¹‹å‰çš„å†…å­˜æ“ä½œé‡æ’åºï¼Œä¹Ÿä¸ä¼šæŠŠ volatile å˜é‡çš„è¯»æ“ä½œä¸ä¹‹åçš„å†…å­˜æ“ä½œé‡æ’åºã€‚ ï¼ˆIntel çš„MESIåè®®ï¼šå½“CPUå†™æ•°æ®æ—¶ï¼Œå¦‚æœå‘ç°æ“ä½œçš„å˜é‡æ˜¯å…±äº«å˜é‡ï¼Œå³åœ¨å…¶ä»–CPUä¸­ä¹Ÿå­˜åœ¨è¯¥å˜é‡çš„å‰¯æœ¬ï¼Œä¼šå‘å‡ºä¿¡å·é€šçŸ¥å…¶ä»–CPUå°†è¯¥å˜é‡çš„é«˜é€Ÿç¼“å­˜ç½®ä¸ºæ— æ•ˆçŠ¶æ€ï¼Œå› æ­¤å½“å…¶ä»–CPUéœ€è¦è¯»å–è¿™ä¸ªå˜é‡æ—¶ï¼Œå‘ç°è‡ªå·±ç¼“å­˜ä¸­ç¼“å­˜è¯¥å˜é‡çš„ç¼“å­˜è¡Œæ˜¯æ— æ•ˆçš„ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šä»å†…å­˜é‡æ–°è¯»å–é‡æ–°åŠ è½½åˆ°é«˜é€Ÿç¼“å­˜ã€‚ï¼‰ 3ï¼šé˜»å¡ä¸å¦å¤šçº¿ç¨‹è®¿é—®volatileå…³é”®å­—ä¸ä¼šå‘ç”Ÿé˜»å¡ï¼ˆ2æ‰€è¿°åŸç†ï¼‰ï¼Œè€Œsynchronizedå…³é”®å­—å¯èƒ½ä¼šå‘ç”Ÿé˜»å¡(é‡é‡çº§é”æ—¶ä¼šé˜»å¡) 4ï¼šæ€§èƒ½volatileå…³é”®å­—æ˜¯çº¿ç¨‹åŒæ­¥çš„è½»é‡çº§å®ç°ï¼Œæ‰€ä»¥volatileæ€§èƒ½è‚¯å®šæ¯”synchronizedå…³é”®å­—è¦å¥½ã€‚ä½†æ˜¯volatileå…³é”®å­—åªèƒ½ç”¨äºå˜é‡è€Œsynchronizedå…³é”®å­—å¯ä»¥ä¿®é¥°æ–¹æ³•ä»¥åŠä»£ç å—ã€‚synchronizedå…³é”®å­—åœ¨JavaSE1.6ä¹‹åè¿›è¡Œäº†ä¸»è¦åŒ…æ‹¬ä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—è€Œå¼•å…¥çš„åå‘é”å’Œè½»é‡çº§é”ä»¥åŠå…¶å®ƒå„ç§ä¼˜åŒ–ä¹‹åæ‰§è¡Œæ•ˆç‡æœ‰äº†æ˜¾è‘—æå‡ï¼Œå®é™…å¼€å‘ä¸­ä½¿ç”¨synchronizedå…³é”®å­—çš„åœºæ™¯è¿˜æ˜¯æ›´å¤šä¸€äº›ã€‚ å¯é‡å…¥é”å’Œä¸å¯é‡å…¥çš„åŒºåˆ«å¯é‡å…¥é”ä¹Ÿå«é€’å½’é”ï¼Œæ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹è·å–é”åï¼Œå†…éƒ¨å¦‚æœè¿˜éœ€è¦è·å–é”ï¼Œå¯ä»¥ç›´æ¥è·å–çš„é”ï¼ˆå‰æé”å¯¹è±¡å¾—æ˜¯åŒä¸€ä¸ªå¯¹è±¡æˆ–è€…classï¼‰ã€‚ä¸å¯é‡å…¥é”ä¹Ÿå°±æ˜¯ç›¸åï¼Œçº¿ç¨‹è·å–é”åï¼Œå†…éƒ¨ä¸èƒ½å†è·å–é”ï¼Œç”±äºä¹‹å‰å·²ç»è·å–è¿‡è¿˜æ²¡é‡Šæ”¾è€Œé˜»å¡ï¼Œä¼šå¯¼è‡´çº¿ç¨‹æ­»é”ã€‚æ‰€ä»¥å¯é‡å…¥é”çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä¸€å®šç¨‹åº¦é¿å…æ­»é”ã€‚å¯é‡å…¥é”æœ‰ReentrantLockå’Œsynchronizedã€‚éå¯é‡å…¥é”æœ‰NonReentrantLockï¼ˆNettyæ¡†æ¶ï¼‰ã€‚ å¯é‡å…¥é”çš„å®ç°åŸç†ï¼šäºŒè€…ç±»ä¼¼ synchronizedï¼šsynchronizedåº•å±‚çš„å®ç°åŸç†æ˜¯åˆ©ç”¨è®¡ç®—æœºç³»ç»Ÿçš„mutex Lockå®ç°ã€‚æ¯ä¸€ä¸ªå¯é‡å…¥é”éƒ½ä¼šå…³è”ä¸€ä¸ªçº¿ç¨‹IDå’Œä¸€ä¸ªé”çŠ¶æ€statusã€‚å½“ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚æ–¹æ³•æ—¶ï¼Œä¼šå»æ£€æŸ¥é”çŠ¶æ€ï¼Œå¦‚æœé”çŠ¶æ€æ˜¯0ï¼Œä»£è¡¨è¯¥é”æ²¡æœ‰è¢«å ç”¨ï¼Œç›´æ¥è¿›è¡ŒCASæ“ä½œè·å–é”ï¼Œå°†çº¿ç¨‹IDæ›¿æ¢æˆè‡ªå·±çš„çº¿ç¨‹IDã€‚å¦‚æœé”çŠ¶æ€ä¸æ˜¯0ï¼Œä»£è¡¨æœ‰çº¿ç¨‹åœ¨è®¿é—®è¯¥æ–¹æ³•ã€‚æ­¤æ—¶ï¼Œå¦‚æœçº¿ç¨‹IDæ˜¯è‡ªå·±çš„çº¿ç¨‹IDï¼Œå¦‚æœæ˜¯å¯é‡å…¥é”ï¼Œä¼šå°†statusè‡ªå¢1ï¼Œç„¶åè·å–åˆ°è¯¥é”ï¼Œè¿›è€Œæ‰§è¡Œç›¸åº”çš„æ–¹æ³•ã€‚å¦‚æœæ˜¯éé‡å…¥é”ï¼Œå°±ä¼šè¿›å…¥é˜»å¡é˜Ÿåˆ—ç­‰å¾…ã€‚é‡Šæ”¾é”æ—¶ï¼Œå¯é‡å…¥é”ï¼Œæ¯ä¸€æ¬¡é€€å‡ºæ–¹æ³•ï¼Œå°±ä¼šå°†statuså‡1ï¼Œç›´è‡³statusçš„å€¼ä¸º0ï¼Œæœ€åé‡Šæ”¾è¯¥é”ã€‚é‡Šæ”¾é”æ—¶ï¼Œéå¯é‡å…¥é”ï¼Œçº¿ç¨‹é€€å‡ºæ–¹æ³•ï¼Œç›´æ¥å°±ä¼šé‡Šæ”¾è¯¥é”ã€‚ ReentrantLockï¼šReentrantLockçš„å¯é‡å…¥åŠŸèƒ½åŸºäºAQSçš„åŒæ­¥çŠ¶æ€ï¼šstateã€‚ å…¶åŸç†å¤§è‡´ä¸ºï¼šå½“æŸä¸€çº¿ç¨‹è·å–é”åï¼Œå°†stateå€¼+1ï¼Œå¹¶è®°å½•ä¸‹å½“å‰æŒæœ‰é”çš„çº¿ç¨‹ï¼Œå†æœ‰çº¿ç¨‹æ¥è·å–é”æ—¶ï¼Œåˆ¤æ–­è¿™ä¸ªçº¿ç¨‹ä¸æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œå°†stateå€¼å†+1ï¼Œå¦‚æœä¸æ˜¯ï¼Œé˜»å¡çº¿ç¨‹ã€‚ å½“çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œå°†stateå€¼-1ï¼Œå½“stateå€¼å‡ä¸º0æ—¶ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹å½»åº•é‡Šæ”¾äº†é”ï¼Œç„¶åå°†è®°å½•å½“å‰æŒæœ‰é”çš„çº¿ç¨‹çš„é‚£ä¸ªå­—æ®µè®¾ç½®ä¸ºnullï¼Œå¹¶å”¤é†’å…¶ä»–çº¿ç¨‹ï¼Œä½¿å…¶é‡æ–°ç«äº‰é”ã€‚ åŸå­ç±»&amp;CASç®—æ³•&amp;ä¹è§‚é”&amp;æ‚²è§‚é”ç®€è¿°ï¼š ä¹è§‚é”æ˜¯æ— é”çš„ï¼Œå› ä¸ºå®ƒè®¤ä¸ºè‡ªå·±ä½¿ç”¨æ•°æ®æ—¶ä¸ä¼šæœ‰åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹æ•°æ®ï¼Œæ‰€ä»¥ä¸ä¼šå¯¹èµ„æºåŠ é”ã€‚å®ç°ä¹è§‚é”çš„ä»£è¡¨æ˜¯åŸå­ç±»ï¼ˆjava.util.concurrent.atomicåŒ…ï¼‰ï¼ŒåŸå­ç±»ä¸­çš„é€’å¢æ“ä½œå°±æ˜¯ç”±CASè‡ªæ—‹å®ç°çš„ã€‚ æ‚²è§‚é”åˆ™æ˜¯åœ¨ä½¿ç”¨æ•°æ®å‰æ‚²è§‚çš„è®¤ä¸ºä¸€å®šä¼šæœ‰åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹æ•°æ®ï¼Œæ‰€ä»¥åœ¨æ¯æ¬¡ä½¿ç”¨æ•°æ®æ—¶éƒ½ä¼šå¯¹èµ„æºåŠ é”ï¼Œæœªæ‹¿åˆ°é”çš„éƒ½éœ€è¦æ’é˜Ÿé˜»å¡ç­‰å€™ã€‚ ä¹è§‚é”&amp;æ‚²è§‚é”å¯¹äºåŒä¸€ä¸ªæ•°æ®çš„å¹¶å‘æ“ä½œï¼Œæ‚²è§‚é”è®¤ä¸ºè‡ªå·±åœ¨ä½¿ç”¨æ•°æ®çš„æ—¶å€™ä¸€å®šæœ‰åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹æ•°æ®ï¼Œå› æ­¤åœ¨è·å–æ•°æ®çš„æ—¶å€™ä¼šå…ˆåŠ é”ï¼Œç¡®ä¿æ•°æ®ä¸ä¼šè¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹ã€‚Javaä¸­ï¼Œsynchronizedå…³é”®å­—å’ŒLockçš„å®ç°ç±»éƒ½æ˜¯æ‚²è§‚é”ã€‚ è€Œä¹è§‚é”è®¤ä¸ºè‡ªå·±åœ¨ä½¿ç”¨æ•°æ®æ—¶ä¸ä¼šæœ‰åˆ«çš„çº¿ç¨‹ä¿®æ”¹æ•°æ®ï¼Œæ‰€ä»¥ä¸ä¼šæ·»åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™å»åˆ¤æ–­ä¹‹å‰æœ‰æ²¡æœ‰åˆ«çš„çº¿ç¨‹æ›´æ–°äº†è¿™ä¸ªæ•°æ®ã€‚å¦‚æœè¿™ä¸ªæ•°æ®æ²¡æœ‰è¢«æ›´æ–°ï¼Œå½“å‰çº¿ç¨‹å°†è‡ªå·±ä¿®æ”¹çš„æ•°æ®æˆåŠŸå†™å…¥ã€‚å¦‚æœæ•°æ®å·²ç»è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°ï¼Œåˆ™æ ¹æ®ä¸åŒçš„å®ç°æ–¹å¼æ‰§è¡Œä¸åŒçš„æ“ä½œï¼ˆä¾‹å¦‚æŠ¥é”™æˆ–è€…è‡ªåŠ¨é‡è¯•ï¼‰ã€‚ ä¹è§‚é”åœ¨Javaä¸­æ˜¯é€šè¿‡ä½¿ç”¨æ— é”ç¼–ç¨‹æ¥å®ç°ï¼Œæœ€å¸¸é‡‡ç”¨çš„æ˜¯CASç®—æ³•ï¼ŒJavaåŸå­ç±»ä¸­çš„é€’å¢æ“ä½œå°±é€šè¿‡CASè‡ªæ—‹å®ç°çš„ã€‚ æ‚²è§‚é”é€‚åˆå†™æ“ä½œå¤šçš„åœºæ™¯ï¼Œå…ˆåŠ é”å¯ä»¥ä¿è¯å†™æ“ä½œæ—¶æ•°æ®æ­£ç¡®ã€‚ ä¹è§‚é”é€‚åˆè¯»æ“ä½œå¤šçš„åœºæ™¯ï¼Œä¸åŠ é”çš„ç‰¹ç‚¹èƒ½å¤Ÿä½¿å…¶è¯»æ“ä½œçš„æ€§èƒ½å¤§å¹…æå‡ã€‚ CASåŸç†CASç®—æ³•å…¨ç¨‹ Compare And Swapï¼Œåœ¨ä¸åŠ é”çš„è¯·å†µä¸‹å®ç°å¤šçº¿ç¨‹å˜é‡åŒæ­¥ï¼š ç®€è¿°ï¼šå½“ä¸”ä»…å½“å†…å­˜å€¼ï¼ˆå†…å­˜åœ°å€ï¼‰ç­‰äºé¢„ä¼°å€¼ï¼ˆå¤‡ä»½çš„æ—§æ•°æ®ï¼‰æ—¶ï¼Œå°†æ›´æ–°å€¼ï¼ˆæ–°æ•°æ®ï¼‰å†™å…¥å†…å­˜ï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åš CAS åŒ…å«äº†ä¸‰ä¸ªæ“ä½œæ•°ï¼š å†…å­˜å€¼ V é¢„ä¼°å€¼ A æ›´æ–°å€¼ B å½“ä¸”ä»…å½“ V == A æ—¶ï¼ŒV å°†è¢«èµ‹å€¼ä¸º Bï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œ è‡ªæ—‹é”ï¼šå¾ªç¯çš„CASç®—æ³•ï¼šå½“ç„¶å¦‚æœéœ€è¦çš„è¯ï¼Œå¯ä»¥è®¾è®¡æˆè‡ªæ—‹é”çš„æ¨¡å¼,å¾ªç¯ç€ä¸æ–­è¿›è¡Œåˆ¤æ–­ V ä¸ A æ˜¯å¦ç›¸ç­‰ã€‚ CASæ¯”è¾ƒä¸äº¤æ¢çš„ä¼ªä»£ç å¯ä»¥è¡¨ç¤ºä¸ºï¼š 1234do{ å¤‡ä»½æ—§æ•°æ®ï¼› åŸºäºæ—§æ•°æ®æ„é€ æ–°æ•°æ®ï¼›}while(!CAS( å†…å­˜åœ°å€ï¼Œå¤‡ä»½çš„æ—§æ•°æ®ï¼Œæ–°æ•°æ® )) CASå­˜åœ¨çš„é—®é¢˜CASè™½ç„¶å¾ˆé«˜æ•ˆï¼Œä½†æ˜¯å®ƒä¹Ÿå­˜åœ¨ä¸‰å¤§é—®é¢˜: ABAé—®é¢˜ CASéœ€è¦åœ¨æ“ä½œå€¼çš„æ—¶å€™æ£€æŸ¥å†…å­˜å€¼æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œæ²¡æœ‰å‘ç”Ÿå˜åŒ–æ‰ä¼šæ›´æ–°å†…å­˜å€¼ã€‚ä½†æ˜¯å¦‚æœå†…å­˜å€¼åŸæ¥æ˜¯Aï¼Œåæ¥å˜æˆäº†Bï¼Œç„¶ååˆå˜æˆäº†Aï¼Œé‚£ä¹ˆCASè¿›è¡Œæ£€æŸ¥æ—¶ä¼šå‘ç°å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯æœ‰å˜åŒ–çš„ã€‚ABAé—®é¢˜çš„è§£å†³æ€è·¯å°±æ˜¯åœ¨å˜é‡å‰é¢æ·»åŠ ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°çš„æ—¶å€™éƒ½æŠŠç‰ˆæœ¬å·åŠ ä¸€ï¼Œè¿™æ ·å˜åŒ–è¿‡ç¨‹å°±ä»â€œAï¼Bï¼Aâ€å˜æˆäº†â€œ1Aï¼2Bï¼3Aâ€ã€‚ JDKä»1.5å¼€å§‹æä¾›äº†AtomicStampedReferenceç±»æ¥è§£å†³ABAé—®é¢˜ï¼Œå…·ä½“æ“ä½œå°è£…åœ¨compareAndSet()ä¸­ã€‚compareAndSet()é¦–å…ˆæ£€æŸ¥å½“å‰å¼•ç”¨å’Œå½“å‰æ ‡å¿—ä¸é¢„æœŸå¼•ç”¨å’Œé¢„æœŸæ ‡å¿—æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœéƒ½ç›¸ç­‰ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†å¼•ç”¨å€¼å’Œæ ‡å¿—çš„å€¼è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚ å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§ã€‚CASæ“ä½œå¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šå¯¼è‡´å…¶ä¸€ç›´è‡ªæ—‹ï¼Œç»™CPUå¸¦æ¥éå¸¸å¤§çš„å¼€é”€ã€‚ åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼ŒCASèƒ½å¤Ÿä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼ŒCASæ˜¯æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§çš„ã€‚ Javaä»1.5å¼€å§‹JDKæä¾›äº†AtomicReferenceç±»æ¥ä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ï¼Œå¯ä»¥æŠŠå¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œæ¥è¿›è¡ŒCASæ“ä½œã€‚ synchronizedåŸç†åŠé”å‡çº§è¿‡ç¨‹ç®€è¿°ï¼š æ— é”&amp;åå‘é”ï¼šå¯¹è±¡å¤´ä¸­çš„MarkWordçš„æ ‡å¿—ä½éƒ½æ˜¯01ï¼Œåå‘æ¨¡å¼ä½ ä¸º0åˆ™æ— é”ï¼Œä¸º1åˆ™åå‘é”ï¼›æ— é”ä¹Ÿå°±æ˜¯CASåŸç†åŠåº”ç”¨ï¼Œä¸åŠ é”ï¼Œå¯¹ä¿®æ”¹èµ„æºè¿›è¡Œå¾ªç¯çš„CASæ“ä½œã€‚åå‘é”åˆ™æ˜¯å› ä¸ºåŒæ­¥ä»£ç ä¸€ç›´è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šè‡ªåŠ¨è·å–åå‘é”ï¼Œè·å–é”çš„çº¿ç¨‹çš„idè¢«å¯¹è±¡MarkWordè®°å½•ï¼Œåä¸å†é€šè¿‡CASåŠ è§£åå‘é”ï¼Œè€Œæ˜¯é€šè¿‡æ£€æµ‹idæ˜¯å¦ç›¸ç¬¦ï¼ˆä¹Ÿå°±æ˜¯ä¸é‡Šæ”¾åå‘é”ç›´åˆ°æœ‰å…¶ä»–çº¿ç¨‹å°è¯•ç«äº‰é”æ—¶å‡çº§è½»é‡çº§é”ï¼‰ è½»é‡çº§é”ï¼šMarkWordçš„æ ‡å¿—ä½00ï¼Œä¸€æ—¦æœ‰ç¬¬äºŒä¸ªçº¿ç¨‹åŠ å…¥é”ç«äº‰ï¼Œåå‘é”å°±å‡çº§ä¸ºè½»é‡çº§é”ï¼ˆè‡ªæ—‹é”ï¼‰ï¼Œå…¶ä»–çº¿ç¨‹é€šè¿‡è‡ªæ—‹CASæ“ä½œå°è¯•è·å–è½»é‡çº§é” é‡é‡çº§é”ï¼šMarkWordçš„æ ‡å¿—ä½10ï¼Œä¸€æ—¦å°è¯•è¶…è¿‡10æ¬¡ä¸æˆåŠŸæˆ–æœ‰ä¸‰ä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰ï¼Œå‡çº§é‡é‡çº§é”ã€‚æ­¤æ—¶ï¼Œsynchronizedé€šè¿‡Monitoræ¥å®ç°çº¿ç¨‹åŒæ­¥ï¼ŒMonitoræ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„Mutex Lockï¼ˆäº’æ–¥é”ï¼‰æ¥å®ç°çš„çº¿ç¨‹åŒæ­¥ã€‚åŠ é”çš„è¿‡ç¨‹å…¶å®å°±æ˜¯ç«äº‰ monitor çš„è¿‡ç¨‹ï¼Œå½“çº¿ç¨‹è¿›å…¥å­—èŠ‚ç  monitorenter æŒ‡ä»¤ï¼ˆsychronizedå‰åæ’å…¥monitorenter&amp;monitorentexitï¼‰ä¹‹åï¼Œçº¿ç¨‹å°†æŒæœ‰ monitor å¯¹è±¡ï¼Œ æ‰§è¡Œ monitorexit æ—¶é‡Šæ”¾ monitor å¯¹è±¡ï¼Œå½“å…¶ä»–çº¿ç¨‹æ²¡æœ‰æ‹¿åˆ° monitor å¯¹è±¡æ—¶ï¼Œåˆ™éœ€è¦é˜»å¡ ç­‰å¾…è·å–è¯¥å¯¹è±¡ï¼Œé˜»å¡ç”±äºæ¶‰åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œçº¿ç¨‹çš„é˜»å¡å’Œæ¢å¤ï¼Œæ•…è¾ƒä¸ºè€—æ—¶ å››ç§é”çŠ¶æ€å¯¹åº”çš„çš„Mark Wordå†…å®¹ï¼š é”çŠ¶æ€ å­˜å‚¨å†…å®¹ å­˜å‚¨å†…å®¹ æ— é” å¯¹è±¡çš„hashCodeã€ å¯¹è±¡åˆ†ä»£å¹´é¾„ã€æ˜¯å¦æ˜¯åå‘é”ï¼ˆ0ï¼‰ 01 åå‘é” åå‘çº¿ç¨‹IDã€åå‘æ—¶é—´æˆ³ã€å¯¹è±¡åˆ†ä»£å¹´é¾„ã€æ˜¯å¦æ˜¯åå‘é”ï¼ˆ1ï¼‰ 01 è½»é‡çº§é” æŒ‡å‘æ ˆä¸­é”è®°å½•(lock_record)çš„æŒ‡é’ˆ 00 é‡é‡çº§é” æŒ‡å‘Monitorçš„æŒ‡é’ˆ 10 å¯¹è±¡å¤´ å¯¹è±¡å¤´ä¸­çš„markWordMark Wordï¼šé»˜è®¤å­˜å‚¨å¯¹è±¡çš„HashCodeï¼Œåˆ†ä»£å¹´é¾„å’Œé”æ ‡å¿—ä½ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯éƒ½æ˜¯ä¸å¯¹è±¡è‡ªèº«å®šä¹‰æ— å…³çš„æ•°æ®ï¼Œæ‰€ä»¥Mark Wordè¢«è®¾è®¡æˆä¸€ä¸ªéå›ºå®šçš„æ•°æ®ç»“æ„ä»¥ä¾¿åœ¨æå°çš„ç©ºé—´å†…å­˜å­˜å‚¨å°½é‡å¤šçš„æ•°æ®ã€‚å®ƒä¼šæ ¹æ®å¯¹è±¡çš„çŠ¶æ€å¤ç”¨è‡ªå·±çš„å­˜å‚¨ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿è¡ŒæœŸé—´Mark Wordé‡Œå­˜å‚¨çš„æ•°æ®ä¼šéšç€é”æ ‡å¿—ä½çš„å˜åŒ–è€Œå˜åŒ–ã€‚ 32ä½æ ‡è®°å­—æ®µè¯¦æƒ…12345678910111213|-------------------------------------------------------|--------------------|| Mark Word (32 bits) | State ||-------------------------------------------------------|--------------------|| identity_hashcode:25 | age:4 | biased_lock:1 | lock:2 | Normal ||-------------------------------------------------------|--------------------|| thread:23 | epoch:2 | age:4 | biased_lock:1 | lock:2 | Biased ||-------------------------------------------------------|--------------------|| ptr_to_lock_record:30 | lock:2 | Lightweight Locked ||-------------------------------------------------------|--------------------|| ptr_to_heavyweight_monitor:30 | lock:2 | Heavyweight Locked ||-------------------------------------------------------|--------------------|| | lock:2 | Marked for GC ||-------------------------------------------------------|--------------------| lock:2ä½çš„é”çŠ¶æ€æ ‡è®°ä½ï¼Œç”±äºå¸Œæœ›ç”¨å°½å¯èƒ½å°‘çš„äºŒè¿›åˆ¶ä½è¡¨ç¤ºå°½å¯èƒ½å¤šçš„ä¿¡æ¯ï¼Œæ‰€ä»¥è®¾ç½®äº†lockæ ‡è®°ã€‚ biased_lockï¼šå¯¹è±¡æ˜¯å¦å¯ç”¨åå‘é”æ ‡è®°ï¼Œåªå 1ä¸ªäºŒè¿›åˆ¶ä½ã€‚ä¸º1æ—¶è¡¨ç¤ºå¯¹è±¡å¯ç”¨åå‘é”ï¼Œä¸º0æ—¶è¡¨ç¤ºå¯¹è±¡æ²¡æœ‰åå‘é”ã€‚ ageï¼š4ä½çš„Javaå¯¹è±¡å¹´é¾„ã€‚åœ¨GCä¸­ï¼Œå¦‚æœå¯¹è±¡åœ¨SurvivoråŒºå¤åˆ¶ä¸€æ¬¡ï¼Œå¹´é¾„å¢åŠ 1ã€‚å½“å¯¹è±¡è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼æ—¶ï¼Œå°†ä¼šæ™‹å‡åˆ°è€å¹´ä»£ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¹¶è¡ŒGCçš„å¹´é¾„é˜ˆå€¼ä¸º15ï¼Œå¹¶å‘GCçš„å¹´é¾„é˜ˆå€¼ä¸º6ã€‚ç”±äºageåªæœ‰4ä½ï¼Œæ‰€ä»¥æœ€å¤§å€¼ä¸º15ï¼Œè¿™å°±æ˜¯-XX:MaxTenuringThresholdé€‰é¡¹æœ€å¤§å€¼ä¸º15çš„åŸå› ã€‚ identity_hashcodeï¼š25ä½çš„å¯¹è±¡æ ‡è¯†Hashç ï¼Œé‡‡ç”¨å»¶è¿ŸåŠ è½½æŠ€æœ¯ã€‚è°ƒç”¨æ–¹æ³•System.identityHashCode()è®¡ç®—ï¼Œå¹¶ä¼šå°†ç»“æœå†™åˆ°è¯¥å¯¹è±¡å¤´ä¸­ã€‚å½“å¯¹è±¡è¢«é”å®šæ—¶ï¼Œè¯¥å€¼ä¼šç§»åŠ¨åˆ°ç®¡ç¨‹Monitorä¸­ã€‚ threadï¼šæŒæœ‰åå‘é”çš„çº¿ç¨‹IDã€‚ epochï¼šåå‘æ—¶é—´æˆ³ã€‚ ptr_to_lock_recordï¼šæŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆã€‚ ptr_to_heavyweight_monitorï¼šæŒ‡å‘ç®¡ç¨‹Monitorçš„æŒ‡é’ˆã€‚ å¯¹è±¡å¤´ä¸­çš„Klass PointKlass Pointï¼šå¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚ MonitorMonitorå®ç°åœ¨Javaè™šæ‹Ÿæœº(HotSpot)ä¸­ï¼ŒMonitoræ˜¯åŸºäºC++å®ç°çš„ï¼Œç”±ObjectMonitorå®ç°çš„ï¼Œå…¶ä¸»è¦æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š 123456789101112131415161718ObjectMonitor() { _header = NULL; _count = 0; _waiters = 0, _recursions = 0; _object = NULL; _owner = NULL; _WaitSet = NULL; _WaitSetLock = 0 ; _Responsible = NULL ; _succ = NULL ; _cxq = NULL ; FreeNext = NULL ; _EntryList = NULL ; _SpinFreq = 0 ; _SpinClock = 0 ; OwnerIsThread = 0 ;} æºç åœ°å€ï¼šobjectMonitor.hpp ObjectMonitorä¸­æœ‰å‡ ä¸ªå…³é”®å±æ€§ï¼š _ownerï¼šæŒ‡å‘æŒæœ‰ObjectMonitorå¯¹è±¡çš„çº¿ç¨‹_WaitSetï¼šå­˜æ”¾å¤„äºwaitçŠ¶æ€çš„çº¿ç¨‹é˜Ÿåˆ—_EntryListï¼šå­˜æ”¾å¤„äºç­‰å¾…é”blockçŠ¶æ€çš„çº¿ç¨‹é˜Ÿåˆ—_recursionsï¼šé”çš„é‡å…¥æ¬¡æ•°_countï¼šç”¨æ¥è®°å½•è¯¥çº¿ç¨‹è·å–é”çš„æ¬¡æ•° å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€æ®µåŒæ­¥ä»£ç æ—¶ï¼Œé¦–å…ˆä¼šè¿›å…¥_EntryListé˜Ÿåˆ—ä¸­ï¼Œå½“æŸä¸ªçº¿ç¨‹è·å–åˆ°å¯¹è±¡çš„monitoråè¿›å…¥_OwneråŒºåŸŸå¹¶æŠŠmonitorä¸­çš„_ownerå˜é‡è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼ŒåŒæ—¶monitorä¸­çš„è®¡æ•°å™¨_countåŠ 1ã€‚å³è·å¾—å¯¹è±¡é”ã€‚ Monitorå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªåŒæ­¥å·¥å…·æˆ–ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œé€šå¸¸è¢«æè¿°ä¸ºä¸€ä¸ªå¯¹è±¡ã€‚æ¯ä¸€ä¸ªJavaå¯¹è±¡å°±æœ‰ä¸€æŠŠçœ‹ä¸è§çš„é”ï¼Œç§°ä¸ºå†…éƒ¨é”æˆ–è€…Monitoré”ã€‚ Monitoræ˜¯çº¿ç¨‹ç§æœ‰çš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå¯ç”¨monitor recordåˆ—è¡¨ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªå…¨å±€çš„å¯ç”¨åˆ—è¡¨ã€‚æ¯ä¸€ä¸ªè¢«é”ä½çš„å¯¹è±¡éƒ½ä¼šå’Œä¸€ä¸ªmonitorå…³è”ï¼ŒåŒæ—¶monitorä¸­æœ‰ä¸€ä¸ªOwnerå­—æ®µå­˜æ”¾æ‹¥æœ‰è¯¥é”çš„çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ï¼Œè¡¨ç¤ºè¯¥é”è¢«è¿™ä¸ªçº¿ç¨‹å ç”¨ã€‚ synchronizedé”å‡çº§è¿‡ç¨‹æ— é”ä¹Ÿå°±æ˜¯CASåŸç†åŠåº”ç”¨ï¼Œä¸åŠ é”ï¼Œå¯¹ä¿®æ”¹èµ„æºè¿›è¡Œå¾ªç¯çš„CASæ“ä½œ æ— é”æ²¡æœ‰å¯¹èµ„æºè¿›è¡Œé”å®šï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½èƒ½è®¿é—®å¹¶ä¿®æ”¹åŒä¸€ä¸ªèµ„æºï¼Œä½†åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½ä¿®æ”¹æˆåŠŸã€‚ æ— é”çš„ç‰¹ç‚¹å°±æ˜¯ä¿®æ”¹æ“ä½œåœ¨å¾ªç¯å†…è¿›è¡Œï¼Œçº¿ç¨‹ä¼šä¸æ–­çš„å°è¯•ä¿®æ”¹å…±äº«èµ„æºã€‚å¦‚æœæ²¡æœ‰å†²çªå°±ä¿®æ”¹æˆåŠŸå¹¶é€€å‡ºï¼Œå¦åˆ™å°±ä¼šç»§ç»­å¾ªç¯å°è¯•ã€‚å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹ä¿®æ”¹åŒä¸€ä¸ªå€¼ï¼Œå¿…å®šä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½ä¿®æ”¹æˆåŠŸï¼Œè€Œå…¶ä»–ä¿®æ”¹å¤±è´¥çš„çº¿ç¨‹ä¼šä¸æ–­é‡è¯•ç›´åˆ°ä¿®æ”¹æˆåŠŸã€‚ä¸Šé¢æˆ‘ä»¬ä»‹ç»çš„CASåŸç†åŠåº”ç”¨å³æ˜¯æ— é”çš„å®ç°ã€‚æ— é”æ— æ³•å…¨é¢ä»£æ›¿æœ‰é”ï¼Œä½†æ— é”åœ¨æŸäº›åœºåˆä¸‹çš„æ€§èƒ½æ˜¯éå¸¸é«˜çš„ã€‚ åå‘é”åŒæ­¥ä»£ç ä¸€ç›´è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šè‡ªåŠ¨è·å–é”ï¼Œè·å–é”çš„çº¿ç¨‹çš„idè¢«å¯¹è±¡MarkWordè®°å½•ï¼Œåä¸å†é€šè¿‡CASåŠ è§£é”ï¼ˆä¹Ÿå°±æ˜¯ä¸é‡Šæ”¾é”ç›´åˆ°æœ‰å…¶ä»–çº¿ç¨‹å°è¯•ç«äº‰é”æ—¶å‡çº§è½»é‡çº§é”ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡æ£€æµ‹idæ˜¯å¦ç›¸ç¬¦ åå‘é”æ˜¯æŒ‡ä¸€æ®µåŒæ­¥ä»£ç ä¸€ç›´è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šè‡ªåŠ¨è·å–é”ï¼Œé™ä½è·å–é”çš„ä»£ä»·ã€‚ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”æ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—ï¼Œä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œæ‰€ä»¥å‡ºç°äº†åå‘é”ã€‚å…¶ç›®æ ‡å°±æ˜¯åœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç å—æ—¶èƒ½å¤Ÿæé«˜æ€§èƒ½ã€‚ å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥ä»£ç å—å¹¶è·å–é”æ—¶ï¼Œä¼šåœ¨Mark Wordé‡Œå­˜å‚¨é”åå‘çš„çº¿ç¨‹IDã€‚åœ¨çº¿ç¨‹è¿›å…¥å’Œé€€å‡ºåŒæ­¥å—æ—¶ä¸å†é€šè¿‡CASæ“ä½œæ¥åŠ é”å’Œè§£é”ï¼Œè€Œæ˜¯æ£€æµ‹Mark Wordé‡Œæ˜¯å¦å­˜å‚¨ç€æŒ‡å‘å½“å‰çº¿ç¨‹çš„åå‘é”ã€‚å¼•å…¥åå‘é”æ˜¯ä¸ºäº†åœ¨æ— å¤šçº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹å°½é‡å‡å°‘ä¸å¿…è¦çš„è½»é‡çº§é”æ‰§è¡Œè·¯å¾„ï¼Œå› ä¸ºè½»é‡çº§é”çš„è·å–åŠé‡Šæ”¾ä¾èµ–å¤šæ¬¡CASåŸå­æŒ‡ä»¤ï¼Œè€Œåå‘é”åªéœ€è¦åœ¨ç½®æ¢ThreadIDçš„æ—¶å€™ä¾èµ–ä¸€æ¬¡CASåŸå­æŒ‡ä»¤å³å¯ã€‚ åå‘é”åªæœ‰é‡åˆ°å…¶ä»–çº¿ç¨‹å°è¯•ç«äº‰åå‘é”æ—¶ï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹æ‰ä¼šé‡Šæ”¾é”ï¼Œçº¿ç¨‹ä¸ä¼šä¸»åŠ¨é‡Šæ”¾åå‘é”ã€‚åå‘é”çš„æ’¤é”€ï¼Œéœ€è¦ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹ï¼ˆåœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šæ²¡æœ‰å­—èŠ‚ç æ­£åœ¨æ‰§è¡Œï¼‰ï¼Œå®ƒä¼šé¦–å…ˆæš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œåˆ¤æ–­é”å¯¹è±¡æ˜¯å¦å¤„äºè¢«é”å®šçŠ¶æ€ã€‚æ’¤é”€åå‘é”åæ¢å¤åˆ°æ— é”ï¼ˆæ ‡å¿—ä½ä¸ºâ€œ01â€ï¼‰æˆ–è½»é‡çº§é”ï¼ˆæ ‡å¿—ä½ä¸ºâ€œ00â€ï¼‰çš„çŠ¶æ€ã€‚ åå‘é”åœ¨JDK 6åŠä»¥åçš„JVMé‡Œæ˜¯é»˜è®¤å¯ç”¨çš„ã€‚å¯ä»¥é€šè¿‡JVMå‚æ•°å…³é—­åå‘é”ï¼š-XX:-UseBiasedLocking=falseï¼Œå…³é—­ä¹‹åç¨‹åºé»˜è®¤ä¼šè¿›å…¥è½»é‡çº§é”çŠ¶æ€ã€‚ è½»é‡çº§é”ä¸€æ—¦æœ‰ç¬¬äºŒä¸ªçº¿ç¨‹åŠ å…¥é”ç«äº‰ï¼Œåå‘é”å°±å‡çº§ä¸ºè½»é‡çº§é”ï¼ˆè‡ªæ—‹é”ï¼‰ï¼Œå…¶ä»–çº¿ç¨‹é€šè¿‡è‡ªæ—‹CASæ“ä½œå°è¯•è·å–é”ã€‚ä¸€æ—¦å°è¯•è¶…è¿‡10æ¬¡ä¸æˆåŠŸæˆ–è€…æœ‰ä¸‰ä¸ªåŠä»¥ä¸Šçš„é”ç«äº‰ï¼Œå‡çº§é‡é‡çº§é” æ˜¯æŒ‡å½“é”æ˜¯åå‘é”çš„æ—¶å€™ï¼Œè¢«å¦å¤–çš„çº¿ç¨‹æ‰€è®¿é—®ï¼Œåå‘é”å°±ä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Œå…¶ä»–çº¿ç¨‹ä¼šé€šè¿‡è‡ªæ—‹çš„å½¢å¼å°è¯•è·å–é”ï¼Œä¸ä¼šé˜»å¡ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚ åœ¨ä»£ç è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ï¼Œå¦‚æœåŒæ­¥å¯¹è±¡é”çŠ¶æ€ä¸ºæ— é”çŠ¶æ€ï¼ˆé”æ ‡å¿—ä½ä¸ºâ€œ01â€çŠ¶æ€ï¼Œæ˜¯å¦ä¸ºåå‘é”ä¸ºâ€œ0â€ï¼‰ï¼Œè™šæ‹Ÿæœºé¦–å…ˆå°†åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•ï¼ˆLock Recordï¼‰çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„Mark Wordçš„æ‹·è´ï¼Œç„¶åæ‹·è´å¯¹è±¡å¤´ä¸­çš„Mark Wordå¤åˆ¶åˆ°é”è®°å½•ä¸­ã€‚ æ‹·è´æˆåŠŸåï¼Œè™šæ‹Ÿæœºå°†ä½¿ç”¨CASæ“ä½œå°è¯•å°†å¯¹è±¡çš„Mark Wordæ›´æ–°ä¸ºæŒ‡å‘Lock Recordçš„æŒ‡é’ˆï¼Œå¹¶å°†Lock Recordé‡Œçš„owneræŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„Mark Wordã€‚ å¦‚æœè¿™ä¸ªæ›´æ–°åŠ¨ä½œæˆåŠŸäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”ï¼Œå¹¶ä¸”å¯¹è±¡Mark Wordçš„é”æ ‡å¿—ä½è®¾ç½®ä¸ºâ€œ00â€ï¼Œè¡¨ç¤ºæ­¤å¯¹è±¡å¤„äºè½»é‡çº§é”å®šçŠ¶æ€ã€‚ å¦‚æœè½»é‡çº§é”çš„æ›´æ–°æ“ä½œå¤±è´¥äº†ï¼Œè™šæ‹Ÿæœºé¦–å…ˆä¼šæ£€æŸ¥å¯¹è±¡çš„Mark Wordæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯å°±è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œé‚£å°±å¯ä»¥ç›´æ¥è¿›å…¥åŒæ­¥å—ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™è¯´æ˜å¤šä¸ªçº¿ç¨‹ç«äº‰é”ã€‚ è‹¥å½“å‰åªæœ‰ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼Œåˆ™è¯¥çº¿ç¨‹é€šè¿‡è‡ªæ—‹è¿›è¡Œç­‰å¾…ã€‚ä½†æ˜¯å½“è‡ªæ—‹è¶…è¿‡ä¸€å®šçš„æ¬¡æ•°ï¼Œæˆ–è€…ä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰é”ï¼Œä¸€ä¸ªåœ¨è‡ªæ—‹ï¼Œåˆæœ‰ç¬¬ä¸‰ä¸ªæ¥è®¿æ—¶ï¼Œè½»é‡çº§é”å‡çº§ä¸ºé‡é‡çº§é”ã€‚ é‡é‡çº§é”ç­‰å¾…é”çš„çº¿ç¨‹éƒ½è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾åçº¿ç¨‹å”¤é†’ç«äº‰é” ï¼Œè¿‡ç¨‹æ¶‰åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œè¾ƒè€—æ—¶ å‡çº§ä¸ºé‡é‡çº§é”æ—¶ï¼Œé”æ ‡å¿—çš„çŠ¶æ€å€¼å˜ä¸ºâ€œ10â€ï¼Œæ­¤æ—¶Mark Wordä¸­å­˜å‚¨çš„æ˜¯æŒ‡å‘é‡é‡çº§é”çš„æŒ‡é’ˆï¼Œæ­¤æ—¶ç­‰å¾…é”çš„çº¿ç¨‹éƒ½ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ã€‚ æ•´ä½“çš„é”çŠ¶æ€å‡çº§æµç¨‹å¦‚ä¸‹ï¼š ç»¼ä¸Šï¼Œåå‘é”é€šè¿‡å¯¹æ¯”Mark Wordè§£å†³åŠ é”é—®é¢˜ï¼Œé¿å…æ‰§è¡ŒCASæ“ä½œã€‚è€Œè½»é‡çº§é”æ˜¯é€šè¿‡ç”¨CASæ“ä½œå’Œè‡ªæ—‹æ¥è§£å†³åŠ é”é—®é¢˜ï¼Œé¿å…çº¿ç¨‹é˜»å¡å’Œå”¤é†’è€Œå½±å“æ€§èƒ½ã€‚é‡é‡çº§é”æ˜¯å°†é™¤äº†æ‹¥æœ‰é”çš„çº¿ç¨‹ä»¥å¤–çš„çº¿ç¨‹éƒ½é˜»å¡ã€‚ æ€»ç»“ synchronizedç‰¹ç‚¹ï¼šä¿è¯å†…å­˜å¯è§æ€§ã€æ“ä½œåŸå­æ€§ synchronizedå½±å“æ€§èƒ½çš„åŸå› ï¼š 1ã€åŠ é”è§£é”æ“ä½œéœ€è¦é¢å¤–æ“ä½œï¼› 2ã€äº’æ–¥åŒæ­¥å¯¹æ€§èƒ½æœ€å¤§çš„å½±å“æ˜¯é˜»å¡çš„å®ç°ï¼Œå› ä¸ºé˜»å¡æ¶‰åŠåˆ°çš„æŒ‚èµ·çº¿ç¨‹å’Œæ¢å¤çº¿ç¨‹çš„æ“ä½œéƒ½éœ€è¦è½¬å…¥å†…æ ¸æ€ä¸­å®Œæˆï¼ˆç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢çš„æ€§èƒ½ä»£ä»·æ˜¯æ¯”è¾ƒå¤§çš„ï¼‰ synchronizedé”ï¼šå¯¹è±¡å¤´ä¸­çš„Mark Wordæ ¹æ®é”æ ‡å¿—ä½çš„ä¸åŒè€Œè¢«å¤ç”¨ åå‘é”ï¼šåœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥å—æ—¶æé«˜æ€§èƒ½ã€‚Mark Wordå­˜å‚¨é”åå‘çš„çº¿ç¨‹IDï¼Œä»¥åè¯¥çº¿ç¨‹åœ¨è¿›å…¥å’Œé€€å‡ºåŒæ­¥å—æ—¶ä¸éœ€è¦è¿›è¡ŒCASæ“ä½œæ¥åŠ é”å’Œè§£é”ï¼Œåªéœ€ç®€å•æ¯”è¾ƒThreadIDã€‚ç‰¹ç‚¹ï¼šåªæœ‰ç­‰åˆ°çº¿ç¨‹ç«äº‰å‡ºç°æ‰é‡Šæ”¾åå‘é”ï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹ä¸ä¼šä¸»åŠ¨é‡Šæ”¾åå‘é”ã€‚ä¹‹åçš„çº¿ç¨‹ç«äº‰åå‘é”ï¼Œä¼šå…ˆæ£€æŸ¥æŒæœ‰åå‘é”çš„çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœä¸å­˜è´§ï¼Œåˆ™å¯¹è±¡å˜ä¸ºæ— é”çŠ¶æ€ï¼Œé‡æ–°åå‘ï¼›å¦‚æœä»å­˜æ´»ï¼Œåˆ™åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ï¼Œæ­¤æ—¶è½»é‡çº§é”ç”±åŸæŒæœ‰åå‘é”çš„çº¿ç¨‹æŒæœ‰ï¼Œç»§ç»­æ‰§è¡Œå…¶åŒæ­¥ä»£ç ï¼Œè€Œæ­£åœ¨ç«äº‰çš„çº¿ç¨‹ä¼šè¿›å…¥è‡ªæ—‹ç­‰å¾…è·å¾—è¯¥è½»é‡çº§é” è½»é‡çº§é”ï¼šåœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•ï¼ˆLock Recordï¼‰çš„ç©ºé—´ï¼Œå°è¯•æ‹·è´é”å¯¹è±¡ç›®å‰çš„Mark Wordåˆ°æ ˆå¸§çš„Lock Recordï¼Œè‹¥æ‹·è´æˆåŠŸï¼šè™šæ‹Ÿæœºå°†ä½¿ç”¨CASæ“ä½œå°è¯•å°†å¯¹è±¡çš„Mark Wordæ›´æ–°ä¸ºæŒ‡å‘Lock Recordçš„æŒ‡é’ˆï¼Œå¹¶å°†Lock recordé‡Œçš„owneræŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„Mark Wordã€‚è‹¥æ‹·è´å¤±è´¥ï¼šè‹¥å½“å‰åªæœ‰ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼Œåˆ™å¯é€šè¿‡è‡ªæ—‹ç¨å¾®ç­‰å¾…ä¸€ä¸‹ï¼Œå¯èƒ½æŒæœ‰è½»é‡çº§é”çš„çº¿ç¨‹å¾ˆå¿«å°±ä¼šé‡Šæ”¾é”ã€‚ ä½†æ˜¯å½“è‡ªæ—‹è¶…è¿‡ä¸€å®šçš„æ¬¡æ•°ï¼Œæˆ–è€…ä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰é”ï¼Œä¸€ä¸ªåœ¨è‡ªæ—‹ï¼Œåˆæœ‰ç¬¬ä¸‰ä¸ªæ¥è®¿æ—¶ï¼Œè½»é‡çº§é”è†¨èƒ€ä¸ºé‡é‡çº§é” é‡é‡çº§é”ï¼šæŒ‡å‘äº’æ–¥é‡ï¼ˆmutexï¼‰ï¼Œåº•å±‚é€šè¿‡æ“ä½œç³»ç»Ÿçš„mutex lockå®ç°ã€‚ç­‰å¾…é”çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç”±äºLinuxä¸‹Javaçº¿ç¨‹ä¸æ“ä½œç³»ç»Ÿå†…æ ¸æ€çº¿ç¨‹ä¸€ä¸€æ˜ å°„ï¼Œæ‰€ä»¥æ¶‰åŠåˆ°ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ã€æ“ä½œç³»ç»Ÿå†…æ ¸æ€ä¸­çš„çº¿ç¨‹çš„é˜»å¡å’Œæ¢å¤ã€‚ synchonizedçš„æ— é”å’Œå…¶ä»–çŠ¶æ€ä¸‹è°ƒç”¨ hashcodeåŒºåˆ« æ— é”çŠ¶æ€ï¼šè°ƒç”¨ hashCode ç›´æ¥è¿”å›å“ˆå¸Œå€¼ï¼Œæ²¡æœ‰é¢å¤–å¼€é”€ï¼ˆå·²å­˜è¿‡hashCodeçš„æƒ…å†µï¼‰ã€‚ åå‘é”çŠ¶æ€ï¼šè°ƒç”¨ hashCode ä¼šå¯¼è‡´é”å‡çº§ä¸ºè½»é‡çº§é”ï¼Œç”Ÿæˆå¹¶å­˜å‚¨å“ˆå¸Œç ã€‚ è½»é‡çº§é”å’Œé‡é‡çº§é”çŠ¶æ€ï¼šè°ƒç”¨ hashCode ä¼šå¯¼è‡´é¢å¤–çš„å¼€é”€ï¼Œé”å‡çº§ä¸ºé‡é‡çº§é”ï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦é¢å¤–çš„å†…å­˜ç©ºé—´æ¥å­˜å‚¨å“ˆå¸Œç ã€‚ HotSpot VM çš„é”å®ç°æœºåˆ¶æ˜¯ï¼š å½“ä¸€ä¸ªå¯¹è±¡å·²ç»è°ƒç”¨é»˜è®¤ hashCode() æˆ–è€… System.identityHashCode()ï¼Œå³è®¡ç®—è¿‡ identity hash code åï¼Œå®ƒå°±æ— æ³•è¿›å…¥åå‘é”çŠ¶æ€ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœè¦åœ¨ä¸å‘ç”Ÿäº‰ç”¨çš„å¯¹è±¡ä¸Šè¿›è¡ŒåŒæ­¥ï¼Œåˆ™æœ€å¥½è¦†ç›–é»˜è®¤hashCode()å®ç°ï¼Œå¦åˆ™JVMä¸ä¼šä¼˜åŒ–ã€‚ å½“ä¸€ä¸ªå¯¹è±¡å½“å‰æ­£å¤„äºåå‘é”çŠ¶æ€ï¼Œå¹¶ä¸”éœ€è¦è®¡ç®—å…¶ identity hash code çš„è¯ï¼Œåˆ™å®ƒçš„åå‘é”ä¼šè¢«æ’¤é”€ï¼Œå¹¶ä¸”é”ä¼šè†¨èƒ€ä¸ºè½»é‡çº§é”æˆ–è€…é‡é‡é”ï¼› è½»é‡çº§é”çš„å®ç°ä¸­ï¼Œä¼šé€šè¿‡çº¿ç¨‹æ ˆå¸§çš„é”è®°å½•å­˜å‚¨ Displaced Mark Wordï¼› é‡é‡é”çš„å®ç°ä¸­ï¼ŒObjectMonitor ç±»é‡Œæœ‰å­—æ®µå¯ä»¥è®°å½•éåŠ é”çŠ¶æ€ä¸‹çš„ mark wordï¼Œå…¶ä¸­å¯ä»¥å­˜å‚¨ identity hash code çš„å€¼ã€‚ synchronizedå…³é”®å­—å¯ä»¥å®ç°ä»€ä¹ˆç±»å‹çš„é” æ‚²è§‚é”ï¼šsynchronizedå…³é”®å­—å®ç°çš„æ˜¯æ‚²è§‚é”ï¼Œæ¯æ¬¡è®¿é—®å…±äº«èµ„æºæ—¶éƒ½ä¼šä¸Šé”ã€‚ éå…¬å¹³é”ï¼šsynchronizedå…³é”®å­—å®ç°çš„æ˜¯éå…¬å¹³é”ï¼Œå³çº¿ç¨‹è·å–é”çš„é¡ºåºå¹¶ä¸ä¸€å®šæ˜¯æŒ‰ç…§çº¿ç¨‹é˜»å¡çš„é¡ºåºã€‚ å¯é‡å…¥é”ï¼šsynchronizedå…³é”®å­—å®ç°çš„æ˜¯å¯é‡å…¥é”ï¼Œå³å·²ç»è·å–é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è·å–é”ã€‚ ç‹¬å é”æˆ–è€…æ’ä»–é”ï¼šsynchronizedå…³é”®å­—å®ç°çš„æ˜¯ç‹¬å é”ï¼Œå³è¯¥é”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ï¼Œå…¶ä»–çº¿ç¨‹å‡è¢«é˜»å¡ã€‚ Lockä¸ReentrantLockLock æ¥æ˜¯ javaå¹¶å‘åŒ…çš„é¡¶å±‚æ¥å£ã€‚ å¯é‡å…¥é” ReentrantLock æ˜¯ Lock æœ€å¸¸è§çš„å®ç°ï¼Œä¸ synchronized ä¸€æ ·å¯é‡å…¥ã€‚ReentrantLock åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯éå…¬å¹³çš„ï¼Œå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•æŒ‡å®šå…¬å¹³é”ã€‚ä¸€æ—¦ä½¿ç”¨äº†å…¬å¹³é”ï¼Œæ€§èƒ½ä¼šä¸‹é™ã€‚ Synchronized å’Œ Lock çš„ä¸»è¦åŒºåˆ«å­˜åœ¨å±‚é¢ï¼šSyncronized æ˜¯Java ä¸­çš„ä¸€ä¸ªå…³é”®å­—ï¼Œå­˜åœ¨äº JVM å±‚é¢ï¼ŒLock æ˜¯ Java ä¸­çš„ä¸€ä¸ªæ¥å£é”çš„é‡Šæ”¾æ¡ä»¶ï¼š1. è·å–é”çš„çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç åï¼Œè‡ªåŠ¨é‡Šæ”¾ï¼›2. çº¿ç¨‹å‘ç”Ÿå¼‚å¸¸æ—¶ï¼ŒJVMä¼šè®©çº¿ç¨‹é‡Šæ”¾é”ï¼›Lock å¿…é¡»åœ¨ finally å…³é”®å­—ä¸­é‡Šæ”¾é”ï¼Œä¸ç„¶å®¹æ˜“é€ æˆçº¿ç¨‹æ­»é”é”çš„è·å–: åœ¨ Syncronized ä¸­ï¼Œå‡è®¾çº¿ç¨‹ A è·å¾—é”ï¼ŒB çº¿ç¨‹ç­‰å¾…ã€‚å¦‚æœ A å‘ç”Ÿé˜»å¡ï¼Œé‚£ä¹ˆ B ä¼šä¸€ç›´ç­‰å¾…ã€‚åœ¨ Lock ä¸­ï¼Œä¼šåˆ†æƒ…å†µè€Œå®šï¼ŒLock ä¸­æœ‰å°è¯•è·å–é”çš„æ–¹æ³•ï¼Œå¦‚æœå°è¯•è·å–åˆ°é”ï¼Œåˆ™ä¸ç”¨ä¸€ç›´ç­‰å¾…é”çš„çŠ¶æ€ï¼šSynchronized æ— æ³•åˆ¤æ–­é”çš„çŠ¶æ€ï¼ŒLock åˆ™å¯ä»¥åˆ¤æ–­é”çš„ç±»å‹ï¼šSynchronized æ˜¯å¯é‡å…¥ï¼Œä¸å¯ä¸­æ–­ï¼Œéå…¬å¹³é”ï¼›Lock é”åˆ™æ˜¯ å¯é‡å…¥ï¼Œå¯åˆ¤æ–­ï¼Œå¯å…¬å¹³é”é”çš„æ€§èƒ½ï¼šSynchronized é€‚ç”¨äºå°‘é‡åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½å¼€é”€æ¯”è¾ƒå¤§ã€‚Lock é”é€‚ç”¨äºå¤§é‡åŒæ­¥é˜¶æ®µï¼šLock é”å¯ä»¥æé«˜å¤šä¸ªçº¿ç¨‹è¿›è¡Œè¯»çš„æ•ˆç‡(ä½¿ç”¨ readWriteLock)åœ¨ç«äº‰ä¸æ˜¯å¾ˆæ¿€çƒˆçš„æƒ…å†µä¸‹ï¼ŒSynchronizedçš„æ€§èƒ½è¦ä¼˜äºReetrantLockï¼Œä½†æ˜¯åœ¨èµ„æºç«äº‰å¾ˆæ¿€çƒˆçš„æƒ…å†µä¸‹ï¼ŒSynchronizedçš„æ€§èƒ½ä¼šä¸‹é™å‡ åå€ï¼Œä½†æ˜¯ReetrantLockçš„æ€§èƒ½èƒ½ç»´æŒå¸¸æ€ï¼›ReetrantLock æä¾›äº†å¤šæ ·åŒ–çš„åŒæ­¥ï¼Œæ¯”å¦‚æœ‰æ—¶é—´é™åˆ¶çš„åŒæ­¥ï¼Œå¯ä»¥è¢«Interruptçš„åŒæ­¥ï¼ˆsynchronizedçš„åŒæ­¥æ˜¯ä¸èƒ½Interruptçš„ï¼‰ç­‰ã€‚ ReentrantLockä¸synchronizedçš„åŒºåˆ« ã€Œé”çš„å®ç°ï¼šã€ synchronizedæ˜¯Javaè¯­è¨€çš„å…³é”®å­—ï¼ŒåŸºäºJVMå®ç°ã€‚è€ŒReentrantLockæ˜¯åŸºäºJDKçš„APIå±‚é¢å®ç°çš„ï¼ˆä¸€èˆ¬æ˜¯lock()å’Œunlock()æ–¹æ³•é…åˆtry/finally è¯­å¥å—æ¥å®Œæˆã€‚ï¼‰ ã€Œæ€§èƒ½ï¼šã€ åœ¨JDK1.6é”ä¼˜åŒ–ä»¥å‰ï¼Œsynchronizedçš„æ€§èƒ½æ¯”ReenTrantLockå·®å¾ˆå¤šã€‚ä½†æ˜¯JDK6å¼€å§‹ï¼Œå¢åŠ äº†é€‚åº”æ€§è‡ªæ—‹ã€é”æ¶ˆé™¤ç­‰ï¼Œä¸¤è€…æ€§èƒ½å°±å·®ä¸å¤šäº†ã€‚ ã€ŒåŠŸèƒ½ç‰¹ç‚¹ï¼šã€ ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œå¦‚ç­‰å¾…å¯ä¸­æ–­ã€å¯å®ç°å…¬å¹³é”ã€å¯å®ç°é€‰æ‹©æ€§é€šçŸ¥ã€‚ â ReentrantLockæä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶ï¼Œé€šè¿‡lock.lockInterruptibly()æ¥å®ç°è¿™ä¸ªæœºåˆ¶ã€‚ ReentrantLockå¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚è€Œsynchronizedåªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚ synchronizedä¸wait()å’Œnotify()/notifyAll()æ–¹æ³•ç»“åˆå®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼ŒReentrantLockç±»å€ŸåŠ©Conditionæ¥å£ä¸newCondition()æ–¹æ³•å®ç°ã€‚ ReentrantLockéœ€è¦æ‰‹å·¥å£°æ˜æ¥åŠ é”å’Œé‡Šæ”¾é”ï¼Œä¸€èˆ¬è·Ÿfinallyé…åˆé‡Šæ”¾é”ã€‚è€Œsynchronizedä¸ç”¨æ‰‹åŠ¨é‡Šæ”¾é”ã€‚ â ReentrantLock æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š ç›¸åŒç‚¹ï¼š å¯é‡å…¥ï¼š å¯é‡å…¥é” ReentrantLock æ˜¯ Lock æœ€å¸¸è§çš„å®ç°ï¼Œä¸ synchronized ä¸€æ ·å¯é‡å…¥ã€‚ ä¸è¿‡ä¸¤è€…å®ç°åŸç†ç¨æœ‰å·® åˆ«ï¼Œ RetrantLock åˆ©ç”¨ AQS çš„çš„ state çŠ¶æ€æ¥åˆ¤æ–­èµ„æºæ˜¯å¦å·²é”ï¼ŒåŒä¸€çº¿ç¨‹é‡å…¥åŠ é”ï¼Œ state çš„çŠ¶æ€ +1 ; åŒä¸€çº¿ç¨‹é‡å…¥è§£é”, state çŠ¶æ€ -1 (è§£é”å¿…é¡»ä¸ºå½“å‰ç‹¬å çº¿ç¨‹ï¼Œå¦åˆ™å¼‚ å¸¸); å½“ state ä¸º 0 æ—¶è§£é”æˆåŠŸã€‚ ä¸åŒç‚¹ï¼š éœ€è¦æ‰‹åŠ¨åŠ é”ã€è§£é”ï¼Œè€Œ synchronized å…³é”®å­—æ˜¯è‡ªåŠ¨è¿›è¡ŒåŠ é”ã€è§£é”çš„ã€‚è€Œ ReentrantLock éœ€è¦ lock() å’Œ unlock() æ–¹æ³•é…åˆ try/finally è¯­å¥å—æ¥å®Œæˆï¼Œæ¥æ‰‹åŠ¨åŠ é”ã€è§£é”ã€‚ æ”¯æŒè®¾ç½®é”çš„è¶…æ—¶æ—¶é—´ï¼Œè€Œ synchronized å…³é”®å­—æ— æ³•è®¾ç½®é”çš„è¶…æ—¶æ—¶é—´ã€‚å¦‚æœä¸€ä¸ªè·å¾—é”çš„çº¿ç¨‹å†…éƒ¨å‘ç”Ÿæ­»é”ï¼Œé‚£ ä¹ˆå…¶ä»–çº¿ç¨‹å°±ä¼šä¸€ç›´è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œ ReentrantLock æä¾› tryLock æ–¹æ³•ï¼Œå…è®¸è®¾ç½®çº¿ ç¨‹è·å–é”çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™è·³è¿‡ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œï¼Œé¿å…æ­»é”çš„å‘ç”Ÿã€‚ æ”¯æŒå…¬å¹³/éå…¬å¹³é”ï¼ˆé»˜è®¤éå…¬å¹³ï¼‰ï¼Œè€Œ synchronized å…³é”®å­—æ˜¯ä¸€ç§éå…¬å¹³é”ã€‚å…ˆæŠ¢åˆ°é”çš„çº¿ç¨‹å…ˆæ‰§è¡Œã€‚è€Œ ReentrantLock çš„ æ„é€ æ–¹æ³•ä¸­å…è®¸è®¾ç½® true/false æ¥å®ç°å…¬å¹³ã€éå…¬å¹³é”ï¼Œå¦‚æœè®¾ç½®ä¸º true ï¼Œåˆ™çº¿ç¨‹è·å– é”è¦éµå¾ªâ€å…ˆæ¥ååˆ°â€çš„è§„åˆ™ï¼Œæ¯æ¬¡éƒ½ä¼šæ„é€ ä¸€ä¸ªçº¿ç¨‹ Node ï¼Œç„¶ååˆ°åŒå‘é“¾è¡¨çš„â€å°¾ å·´â€åé¢æ’é˜Ÿï¼Œç­‰å¾…å‰é¢çš„ Node é‡Šæ”¾é”èµ„æºã€‚ å¯ä¸­æ–­é”ï¼Œ ReentrantLock ä¸­çš„ lockInterruptibly() æ–¹æ³•ä½¿å¾—çº¿ç¨‹å¯ä»¥åœ¨è¢«é˜»å¡æ—¶å“åº”ä¸­æ–­ã€‚æ¯” å¦‚ä¸€ä¸ªçº¿ç¨‹ t1 é€šè¿‡ lockInterruptibly() æ–¹æ³•è·å–åˆ°ä¸€ä¸ªå¯é‡å…¥é”ï¼Œå¹¶æ‰§è¡Œä¸€ä¸ªé•¿æ—¶é—´ çš„ä»»åŠ¡ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹é€šè¿‡ interrupt() æ–¹æ³•å°±å¯ä»¥ç«‹åˆ»æ‰“æ–­ t1 çº¿ç¨‹çš„æ‰§è¡Œï¼Œæ¥è·å–t1æŒ æœ‰çš„é‚£ä¸ªå¯é‡å…¥é”ã€‚è€Œé€šè¿‡ ReentrantLock çš„ lock() æ–¹æ³•æˆ–è€… Synchronized æŒæœ‰é” çš„çº¿ç¨‹æ˜¯ä¸ä¼šå“åº”å…¶ä»–çº¿ç¨‹çš„ interrupt() æ–¹æ³•çš„ï¼Œç›´åˆ°è¯¥æ–¹æ³•ä¸»åŠ¨é‡Šæ”¾é”ä¹‹åæ‰ä¼šå“åº” interrupt() æ–¹æ³•ã€‚ å¯é‡å…¥é”å’Œä¸å¯é‡å…¥é”å¯é‡å…¥é”åˆåé€’å½’é”ï¼Œæ˜¯æŒ‡åœ¨åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œå†è¿›å…¥è¯¥çº¿ç¨‹çš„å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ï¼ˆå‰æé”å¯¹è±¡å¾—æ˜¯åŒä¸€ä¸ªå¯¹è±¡æˆ–è€…classï¼‰ï¼Œä¸ä¼šå› ä¸ºä¹‹å‰å·²ç»è·å–è¿‡è¿˜æ²¡é‡Šæ”¾è€Œé˜»å¡ã€‚Javaä¸­ReentrantLockå’Œsynchronizedéƒ½æ˜¯å¯é‡å…¥é”ï¼Œå¯é‡å…¥é”çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä¸€å®šç¨‹åº¦é¿å…æ­»é”ã€‚ä¸‹é¢ç”¨ç¤ºä¾‹ä»£ç æ¥è¿›è¡Œåˆ†æï¼š 12345678910public class Widget { public synchronized void doSomething() { System.out.println(&quot;æ–¹æ³•1æ‰§è¡Œ...&quot;); doOthers(); } public synchronized void doOthers() { System.out.println(&quot;æ–¹æ³•2æ‰§è¡Œ...&quot;); }} åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œç±»ä¸­çš„ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯è¢«å†…ç½®é”synchronizedä¿®é¥°çš„ï¼ŒdoSomething()æ–¹æ³•ä¸­è°ƒç”¨doOthers()æ–¹æ³•ã€‚å› ä¸ºå†…ç½®é”æ˜¯å¯é‡å…¥çš„ï¼Œæ‰€ä»¥åŒä¸€ä¸ªçº¿ç¨‹åœ¨è°ƒç”¨doOthers()æ—¶å¯ä»¥ç›´æ¥è·å¾—å½“å‰å¯¹è±¡çš„é”ï¼Œè¿›å…¥doOthers()è¿›è¡Œæ“ä½œã€‚ å¦‚æœæ˜¯ä¸€ä¸ªä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹åœ¨è°ƒç”¨doOthers()ä¹‹å‰éœ€è¦å°†æ‰§è¡ŒdoSomething()æ—¶è·å–å½“å‰å¯¹è±¡çš„é”é‡Šæ”¾æ‰ï¼Œå®é™…ä¸Šè¯¥å¯¹è±¡é”å·²è¢«å½“å‰çº¿ç¨‹æ‰€æŒæœ‰ï¼Œä¸”æ— æ³•é‡Šæ”¾ã€‚æ‰€ä»¥æ­¤æ—¶ä¼šå‡ºç°æ­»é”","link":"/2021/11/11/Concurrent/"},{"title":"EventAndNestedScroll","text":"åŸç†&amp;æµç¨‹ä¸€. ns childä¼šåœ¨æ”¶åˆ°DOWNäº‹ä»¶æ—¶ï¼Œæ‰¾åˆ°è‡ªå·±ç¥–ä¸Šä¸­æœ€è¿‘çš„èƒ½ä¸è‡ªå·±åŒ¹é…çš„ns parentï¼Œä¸å®ƒè¿›è¡Œç»‘å®šå¹¶å…³é—­å®ƒçš„äº‹ä»¶æ‹¦æˆªæœºåˆ¶ äºŒ. ç„¶åns childä¼šåœ¨æ¥ä¸‹æ¥çš„MOVEäº‹ä»¶ä¸­åˆ¤å®šå‡ºç”¨æˆ·è§¦å‘äº†æ»‘åŠ¨æ‰‹åŠ¿ï¼Œå¹¶æŠŠäº‹ä»¶æµæ‹¦æˆªä¸‹æ¥ç»™è‡ªå·±æ¶ˆè´¹ ä¸‰. æ¶ˆè´¹äº‹ä»¶æµæ—¶ï¼Œå¯¹äºæ¯ä¸€æ¬¡MOVEäº‹ä»¶å¢åŠ çš„æ»‘åŠ¨è·ç¦»ï¼š ns childå¹¶ä¸æ˜¯ç›´æ¥è‡ªå·±æ¶ˆè´¹ï¼Œè€Œæ˜¯å…ˆæŠŠå®ƒäº¤ç»™ns parentï¼Œè®©ns parentå¯ä»¥åœ¨ns childä¹‹å‰æ¶ˆè´¹æ»‘åŠ¨dispatch/onNestedPreScroll() å¦‚æœns parentæ²¡æœ‰æ¶ˆè´¹æˆ–æ˜¯æ²¡æœ‰æ¶ˆè´¹å®Œï¼Œns childå†è‡ªå·±æ¶ˆè´¹å‰©ä¸‹çš„æ»‘åŠ¨dispatchNestedScroll() å¦‚æœns childè‡ªå·±è¿˜æ˜¯æ²¡æœ‰æ¶ˆè´¹å®Œè¿™ä¸ªæ»‘åŠ¨ï¼Œä¼šå†æŠŠå‰©ä¸‹çš„æ»‘åŠ¨äº¤ç»™ns parentæ¶ˆè´¹onNestedScroll() æœ€åå¦‚æœæ»‘åŠ¨è¿˜æœ‰å‰©ä½™ï¼Œns childå¯ä»¥åšæœ€ç»ˆçš„å¤„ç†dispatchNestedScroll() å››. åŒæ—¶åœ¨ns childçš„computeScroll()æ–¹æ³•ä¸­ï¼Œns childä¹Ÿä¼šæŠŠè‡ªå·±å› ä¸ºç”¨æˆ·flingæ“ä½œå¼•å‘çš„æ»‘åŠ¨ï¼Œä¸ä¸Šä¸€æ¡ä¸­ç”¨æˆ·æ»‘åŠ¨å±å¹•è§¦å‘çš„æ»‘åŠ¨ä¸€æ ·ï¼Œä½¿ç”¨ã€Œparent -&gt; child -&gt; parent -&gt; childã€çš„é¡ºåºè¿›è¡Œæ¶ˆè´¹ ns childä½¿ç”¨æ›´çµæ´»çš„æ–¹å¼æ‰¾åˆ°å’Œç»‘å®šè‡ªå·±çš„ns parentï¼Œè€Œä¸æ˜¯ç›´æ¥æ‰¾è‡ªå·±çš„ä¸Šä¸€çº§ç»“ç‚¹ ns childåœ¨DOWNäº‹ä»¶æ—¶å…³é—­ns parentçš„äº‹ä»¶æ‹¦æˆªæœºåˆ¶å•ç‹¬ç”¨äº†ä¸€ä¸ª Flag è¿›è¡Œå…³é—­ï¼Œè¿™å°±ä¸ä¼šå…³é—­ns parentå¯¹å…¶ä»–æ‰‹åŠ¿çš„æ‹¦æˆªï¼Œä¹Ÿä¸ä¼šé€’å½’å¾€ä¸Šå…³é—­ç¥–ä¸Šä»¬çš„äº‹ä»¶æ‹¦æˆªæœºåˆ¶ã€‚ns childç›´åˆ°åœ¨MOVEäº‹ä»¶ä¸­ç¡®å®šè‡ªå·±è¦å¼€å§‹æ»‘åŠ¨åï¼Œæ‰ä¼šè°ƒç”¨requestDisallowInterceptTouchEvent(true)é€’å½’å…³é—­ç¥–ä¸Šä»¬å…¨éƒ¨çš„äº‹ä»¶æ‹¦æˆª å¯¹æ¯ä¸€æ¬¡MOVEäº‹ä»¶ä¼ é€’æ¥çš„æ»‘åŠ¨ï¼Œéƒ½ä½¿ç”¨ã€Œparent -&gt; child -&gt; parent -&gt; childã€æœºåˆ¶è¿›è¡Œæ¶ˆè´¹ï¼Œè®©ns childåœ¨æ¶ˆè´¹æ»‘åŠ¨æ—¶ä¸ns parenté…åˆæ›´åŠ ç»†è‡´ã€ç´§å¯†å’Œçµæ´» å¯¹äºå› ä¸ºç”¨æˆ·flingæ“ä½œå¼•å‘çš„æ»‘åŠ¨ï¼Œä¸ç”¨æˆ·æ»‘åŠ¨å±å¹•è§¦å‘çš„æ»‘åŠ¨ä½¿ç”¨åŒæ ·çš„æœºåˆ¶è¿›è¡Œæ¶ˆè´¹ï¼Œå®ç°äº†å®Œç¾çš„æƒ¯æ€§è¿ç»­æ•ˆæœ DOWNäº‹ä»¶æ¥æ—¶ï¼ŒNSCstartNestedScroll()æ‰¾åˆ°è‡ªå·±ç¥–ä¸ŠåŒ¹é…çš„NSPè¿›è¡Œç»‘å®šå¹¶å…³é—­NSPçš„æ‹¦æˆªï¼› MOVEäº‹ä»¶æ¥æ—¶ï¼š ã€Œparent -&gt; child -&gt; parent -&gt; childã€çš„é¡ºåºè¿›è¡Œæ¶ˆè´¹ NSCdispatchNestedPreScroll()ä¸­è§¦å‘NSPonNestedPreScroll()é¢„å…ˆè¿›è¡Œæ»‘åŠ¨äº‹ä»¶çš„æ¶ˆè´¹ï¼Œä¹‹åå°†å‰©ä½™äº‹ä»¶è¿”å›ï¼›æ¥ç€NSCæ¶ˆè´¹å‰©ä½™äº‹ä»¶ï¼› NSCæ¶ˆè´¹äº‹ä»¶åå†dispatchNestedScroll()å»å°†å‰©ä½™äº‹ä»¶ä¼ é€’ç»™NSPonNestedScroll()æ¶ˆè´¹ã€‚ NSPæ¶ˆè´¹å®Œå‰©ä½™äº‹ä»¶è¿”å›NSCï¼ŒNSCæ­¤æ—¶å¯ä»¥åšæœ€åçš„å¤„ç†ï¼Œæ¯”å¦‚overScrollæ•ˆæœæ¯”å¦‚åœ¨ fling çš„æ—¶å€™åœæ­¢scroller ä¸MOVEäº‹ä»¶ä¸­å¤„ç†æ»‘åŠ¨æŒ‰ç…§è¿™ä¸ªé¡ºåºè¿›è¡Œæ¶ˆè´¹ï¼šã€ŒdispatchNestedPreScroll()åˆ°Parent -&gt; è‡ªå·± -&gt; dispatchNestedScroll() -&gt; è‡ªå·±ã€ä¸€æ ·ï¼Œæƒ¯æ€§æ»‘åŠ¨æŒ‰ç…§ä¸Šé¢çš„é¡ºåºã€‚ Caseåˆ†æScrollViewåµŒå¥—ScrollViewé»˜è®¤æƒ…å†µï¼šå¤–éƒ¨ScrollViewä¼˜å…ˆè·å–ä¸Šä¸‹æ»‘åŠ¨çš„æƒåŠ›ï¼Œåœ¨è“è‰²åŒºåŸŸä¸Šä¸‹æ»‘åŠ¨ï¼Œå†…éƒ¨ScrollViewå¹¶ä¸ä¼šä¸Šä¸‹æ»‘åŠ¨ ç®€è¿°ï¼š é»˜è®¤å†…éƒ¨ScrollViewä¼šæ¶ˆè´¹DOWNäº‹ä»¶ é»˜è®¤å¤–éƒ¨ScrollViewä¼˜å…ˆè·å–MOVEäº‹ä»¶å¤„ç†æœºä¼šï¼Œå¹¶ä¸”å½“yDiff &gt; mTouchSlopæ—¶ï¼Œå¤–éƒ¨ScrollViewä¼šæ‹¦æˆªæ‰MOVEäº‹ä»¶å¹¶ç»™å†…éƒ¨ScrollViewå‘CANCELäº‹ä»¶ã€‚ è¡¨ç°ï¼šï¼ˆä¸è€ƒè™‘åæ¥ Google ç»™å®ƒåŠ çš„NestedScrollå¼€å…³ï¼‰ï¼ŒåµŒå¥—ScrollViewåŒå‘æ»‘åŠ¨çš„æ•ˆæœå¦‚ä¸Šï¼Œå†…éƒ¨ScrollViewä¼˜å…ˆè·å¾—DOWNäº‹ä»¶çš„å¤„ç†æœºä¼šï¼Œå¤–éƒ¨çš„ScrollViewä¼˜å…ˆè·å¾—MOVEäº‹ä»¶çš„å¤„ç†æœºä¼šå¹¶ä¸”æ‹¦æˆªï¼ˆyDiff &gt; mTouchSlopï¼ˆ8ï¼Œå¯é…ç½®å¸¸é‡ï¼‰)ã€‚ åˆ†æ: å½“å¤–éƒ¨ScrollViewåµŒå¥—å†…éƒ¨ScrollViewæ—¶,DOWNäº‹ä»¶åœ¨å†…éƒ¨ScrollViewçš„onTouchEventä¸­è¿”å›trueï¼Œå†…éƒ¨ScrollViewå¤„ç†äº†DOWNäº‹ä»¶ã€‚MOVEäº‹ä»¶é¦–å…ˆåˆ°è¾¾å¤–éƒ¨ScrollViewçš„onInterceptTouchEventæ–¹æ³•ï¼Œå½“æ»‘åŠ¨è·ç¦»å¤§äºmTouchSlopæ—¶ï¼Œä¼šæ‹¦æˆªæ‰MOVEäº‹ä»¶ï¼Œç»™å†…éƒ¨ScrollViewå‘å‡ºCANCELäº‹ä»¶ï¼Œä»è€Œå¤–éƒ¨ScrollViewè·å¾—äº†äº‹ä»¶çš„å¤„ç†æƒï¼Œå†…éƒ¨ScrollViewå¤±å»äº†äº‹ä»¶çš„å¤„ç†æƒã€‚ ScrollView å®ç°äº†ViewParentæ¥å£ï¼Œè€ŒViewParentæ¥å£å£°æ˜äº†å’ŒNestedScrollParentä¸€æ ·çš„æ¥å£æ–¹æ³• ScrollView ç»§æ‰¿äºViewï¼Œè€ŒViewå®ç°äº†NestedScrollChildæ¥å£æ–¹æ³•ã€‚ (çœ‹è¿™å°±çŸ¥é“äº†ï¼Œæ•´ä½“æ»‘åŠ¨åµŒå¥—çš„æ€è·¯æ˜¯NSCå…ˆè·å–äº‹ä»¶å¤„ç†ä¼˜å…ˆæƒï¼Œä¹Ÿè®¸æ˜¯é€šè¿‡ç¦æ­¢å¤–éƒ¨æ‹¦æˆªçš„æ–¹æ³•è·å–çš„ï¼Œè‡ªèº«çš„æ»‘åŠ¨äº‹ä»¶æ¶ˆè´¹å‰©ä½™çš„æ»‘åŠ¨è·ç¦»å†ç”±NSCåœ¨è‡ªèº«çš„dispatchNestedXXXä¸­ï¼Œé€šçŸ¥NSPçš„onNestesXXScrollæ–¹æ³•æ‰¿æ¥ï¼Œæ‰€ä»¥å†…éƒ¨æ˜¯ä¸»åŠ¨ï¼Œå¤–éƒ¨æ˜¯è¢«åŠ¨ã€‚è‡³äºæƒ¯æ€§æ‰”åŠ¨äº‹ä»¶ç±»ä¼¼ï¼Ÿ) å¦‚æœè¦è¾¾åˆ°å¤–å±‚ScrollViewå¯ä»¥æ¶ˆè´¹å†…éƒ¨æº¢å‡ºçš„æ»‘åŠ¨å’ŒFlingäº‹ä»¶çš„è¯ï¼Œéœ€è¦å¤–å±‚å®ç°NestedScrollingParentï¼Œå†…å±‚å®ç°NestedScrollingChildåä½œäº‹ä»¶å¤„ç†ã€‚ ???ï¼š 1ã€ScrollViewè¦†ç›–äº†Viewçš„onTouchEventå¹¶é»˜è®¤è¿”å›trueï¼›æ‰€ä»¥å¦‚æœä¸€ä¸ªScrollViewå¤–éƒ¨è¿˜åµŒå¥—äº†å…¶ä»–ViewGroupäº†ï¼Œåˆ™Downäº‹ä»¶ä¸ä¼šè¿”å›åˆ°å¤–éƒ¨ï¼Œä¹ŸåŒæ—¶MOVEã€UPäº‹ä»¶ä¹ŸéšDOWNäº‹ä»¶è¢«ScrollViewæˆ–å…¶å­ç±»å†…éƒ¨æ¶ˆè´¹ã€‚ 2ã€å¤–ScrollViewåµŒå¥—å†…ScrollViewï¼Œå†…ScrollViewåŒ…è£¹ä¸€ä¸ªå†…éƒ¨Viewçš„è¯ï¼Œä¸æ‰“å¼€ï¼ˆæ®‹ç¼ºçš„ï¼‰åµŒå¥—æ»‘åŠ¨å¼€å…³setNestedScrollingEnabled(true)çš„è¯ï¼Œç‚¹å‡»å†…éƒ¨Viewæ‹–åŠ¨ï¼š é‚£ä¹ˆDOWNäº‹ä»¶ä¼šç”±å¤–ScrollViewä¼ åˆ°å†…ScrollViewå†ä¼ åˆ°å†…éƒ¨Viewï¼Œå†…éƒ¨Viewä¸æ¶ˆè´¹ï¼Œå›ä¼ åˆ°å†…ScrollViewæ¶ˆè´¹ï¼› MOVEäº‹ä»¶diffè¶…è¿‡touchSlopçš„è¯ä¼šè¢«å¤–ScrollViewæ‹¦æˆªå¤„ç†ï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªCANCELäº‹ä»¶äº¤ç»™å†…SCrollViewï¼Œå› ä¸ºDOWNå·²ç»è¢«å†…ScrollViewæ¶ˆè´¹äº†ï¼Œæ‰€ä»¥CANCELäº‹ä»¶ä¹Ÿäº¤ç»™äº†å†…ScrollViewæ¶ˆè´¹ï¼Œè€Œä¸ä¼šå†ç»™åˆ°å†…éƒ¨Viewã€‚ UPäº‹ä»¶åªè¢«å¤–ScrollViewåˆ†å‘å¹¶ä¼ é€’ç»™å¤–ScrollViewçš„onTouchEventæ¶ˆè´¹ï¼Œæ˜¯çš„æ²¡æœ‰æ‹¦æˆªã€‚åŸå› æœªçŸ¥ï¼ˆç†è®ºä¸Šåº”è¯¥è·ŸCANCELä¸€æ ·æ‰å¯¹â€¦â€¦.ï¼‰ 3ã€ä¸ç”¨å°å¿ƒç¿¼ç¿¼åœ°è®©æ”¹åŠ¨å°½é‡å°ï¼Œæ—¢ç„¶å†…éƒ¨ä¼˜å…ˆï¼Œå®Œå…¨å¯ä»¥è®©å†…éƒ¨çš„ScrollViewåœ¨DOWNäº‹ä»¶çš„æ—¶å€™å°±ç”³è¯·å¤–éƒ¨ä¸æ‹¦æˆªï¼Œç„¶ååœ¨æ»‘åŠ¨ä¸€æ®µè·ç¦»åï¼Œå¦‚æœåˆ¤æ–­è‡ªå·±åœ¨è¯¥æ»‘åŠ¨æ–¹å‘æ— æ³•æ»‘åŠ¨ï¼Œå†å–æ¶ˆå¯¹å¤–éƒ¨çš„æ‹¦æˆªé™åˆ¶ï¼Œåƒè¿™æ ·ä¹Ÿåªèƒ½å®ç°æ»‘åŠ¨äº‹ä»¶ï¼Œå¯¹äºæƒ¯æ€§äº‹ä»¶çš„å¤„ç†æ˜¯ä¸åˆ°ä½çš„ã€‚ 1234567891011121314151617class SimpleNestedScrollView(context: Context, attrs: AttributeSet) : ScrollView(context, attrs) { override fun dispatchTouchEvent(ev: MotionEvent): Boolean { if (ev.actionMasked == MotionEvent.ACTION_DOWN) parent.requestDisallowInterceptTouchEvent(true) if (ev.actionMasked == MotionEvent.ACTION_MOVE) { val offsetY = ev.y.toInt() - getInt(&quot;mLastMotionY&quot;) if (Math.abs(offsetY) &gt; getInt(&quot;mTouchSlop&quot;)) { if ((offsetY &gt; 0 &amp;&amp; isScrollToTop()) || (offsetY &lt; 0 &amp;&amp; isScrollToBottom())) { parent.requestDisallowInterceptTouchEvent(false) } } } return super.dispatchTouchEvent(ev) }} ScrollViewçš„çœŸå®æºç å®é™…ä¸Šæ˜¯ç›´æ¥åœ¨DOWNäº‹ä»¶ä¸­è¯·æ±‚äº†parentç¦æ­¢æ‹¦æˆªï¼Œç„¶åè‡ªèº«å…ˆå¤„ç†æ¶ˆè€—MOVEäº‹ä»¶ç›´åˆ°è¾¾åˆ°è‡ªèº«çš„æ»‘åŠ¨è¾¹ç•Œä¹‹åå†æ‰¾è‡ªå·±çš„parentå¤„ç†å‰©ä½™æ»‘åŠ¨è·ç¦»ã€‚å¯¹äºæƒ¯æ€§äº‹ä»¶ä¹Ÿæ˜¯å¤„ç†ä¸åˆ°ä½çš„ã€‚ æµ…æNestedScrollingåµŒå¥—æ»‘åŠ¨æœºåˆ¶ä¹‹åŸºç¡€ç¯‡ - æ˜é‡‘ (juejin.cn) äº‹ä»¶åˆ†å‘å››éƒ¨æ›²ä¹‹äºŒã€ŠåµŒå¥—æ»‘åŠ¨äº‹ä»¶åˆ†æã€‹ - æ˜é‡‘ (juejin.cn)","link":"/2022/01/12/EventAndNestedScroll/"},{"title":"ClassLoading","text":"ç±»çš„ç”Ÿå‘½å‘¨æœŸï¼š ç®€è¿°ï¼šåŠ è½½æ˜¯å­—èŠ‚ç (.class)æ–‡ä»¶è¢«ClassLoaderè£…è½½è¿›æ–¹æ³•åŒºå¹¶åœ¨å †ä¸­ç”Ÿæˆä¸€ä¸ªclasså¯¹è±¡å¼•ç”¨ï¼›é“¾æ¥åŒ…æ‹¬ï¼šæ ¡éªŒäºŒè¿›åˆ¶æµæ˜¯å¦ç¬¦åˆJVMè§„èŒƒçš„éªŒè¯ã€ä¸ºå„ä¸ªå˜é‡åˆ†é…å†…å­˜èµ‹å€¼é»˜è®¤å€¼çš„å‡†å¤‡ã€å°†å­—ç¬¦ä¸²è¡¨ç¤ºçš„ç¬¦å·å¼•ç”¨è§£ææˆç›´æ¥å°†å¼•ç”¨çš„è§£æï¼›åˆå§‹åŒ–åˆ™æ˜¯staticå—ã€staticå˜é‡åˆå§‹åŒ–ã€ç±»æ„é€ å™¨æ‰§è¡Œçš„è¿‡ç¨‹ã€‚ ç±»åŠ è½½è¿‡ç¨‹(ClassLoading)è¿™é‡Œçš„ç±»åŠ è½½ä¸æ˜¯æŒ‡ç±»åŠ è½½é˜¶æ®µï¼Œè€Œæ˜¯æŒ‡æ•´ä¸ªç±»åŠ è½½è¿‡ç¨‹ï¼Œå³ç±»åŠ è½½é˜¶æ®µåˆ°åˆå§‹åŒ–å®Œæˆã€‚ éšå¼åŠ è½½ åˆ›å»ºç±»å¯¹è±¡ ä½¿ç”¨ç±»çš„é™æ€åŸŸ åˆ›å»ºå­ç±»å¯¹è±¡ ä½¿ç”¨å­ç±»çš„é™æ€åŸŸ åœ¨JVMå¯åŠ¨æ—¶ï¼ŒBootStrapLoaderä¼šåŠ è½½ä¸€äº›JVMè‡ªèº«è¿è¡Œæ‰€éœ€çš„class åœ¨JVMå¯åŠ¨æ—¶ï¼ŒExtClassLoaderä¼šåŠ è½½æŒ‡å®šç›®å½•ä¸‹ä¸€äº›ç‰¹æ®Šçš„class åœ¨JVMå¯åŠ¨æ—¶ï¼ŒAppClassLoaderä¼šåŠ è½½classpathè·¯å¾„ä¸‹çš„classï¼Œä»¥åŠmainå‡½æ•°æ‰€åœ¨çš„ç±»çš„classæ–‡ä»¶ æ˜¾å¼åŠ è½½ ClassLoader.loadClass(className)ï¼ŒåªåŠ è½½å’Œè¿æ¥ã€ä¸ä¼šè¿›è¡Œåˆå§‹åŒ– Class.forName(String name, boolean initialize,ClassLoader loader); ä½¿ç”¨loaderè¿›è¡ŒåŠ è½½å’Œè¿æ¥ï¼Œæ ¹æ®å‚æ•°initializeå†³å®šæ˜¯å¦åˆå§‹åŒ–ã€‚ åŠ¨æ€åŠ è½½ï¼š ä¸ç®¡ä½¿ç”¨ä»€ä¹ˆæ ·çš„ç±»åŠ è½½å™¨ï¼Œç±»ï¼Œéƒ½æ˜¯åœ¨ç¬¬ä¸€æ¬¡è¢«ç”¨åˆ°æ—¶ï¼ŒåŠ¨æ€åŠ è½½åˆ°JVMçš„ã€‚è¿™å¥è¯æœ‰ä¸¤å±‚å«ä¹‰ï¼š Javaç¨‹åºåœ¨è¿è¡Œæ—¶å¹¶ä¸ä¸€å®šè¢«å®Œæ•´åŠ è½½ï¼Œåªæœ‰å½“å‘ç°è¯¥ç±»è¿˜æ²¡æœ‰åŠ è½½æ—¶ï¼Œæ‰å»æœ¬åœ°æˆ–è¿œç¨‹æŸ¥æ‰¾ç±»çš„.classæ–‡ä»¶å¹¶éªŒè¯å’ŒåŠ è½½ï¼› å½“ç¨‹åºåˆ›å»ºäº†ç¬¬ä¸€ä¸ªå¯¹ç±»çš„é™æ€æˆå‘˜çš„å¼•ç”¨ï¼ˆå¦‚ç±»çš„é™æ€å˜é‡ã€é™æ€æ–¹æ³•ã€æ„é€ æ–¹æ³•â€”â€”æ„é€ æ–¹æ³•ä¹Ÿæ˜¯é™æ€çš„ï¼‰æ—¶ï¼Œæ‰ä¼šåŠ è½½è¯¥ç±»ã€‚ åŒ…æ‹¬3ä¸ªæ­¥éª¤ï¼š ä¸€ã€åŠ è½½ï¼ˆLoadingï¼‰ç®€è¿°ï¼šåŠ è½½æ˜¯å°†.classæ–‡ä»¶ä»å„ä¸ªæ¥æºé€šè¿‡ClassLoaderè£…è½½åˆ°æ–¹æ³•åŒºå†…å­˜ï¼Œå¹¶åœ¨å †å†…å­˜ä¸­ç”Ÿæˆè¯¥ç±»çš„classå¯¹è±¡å¼•ç”¨ æ—¶æœºï¼šç±»åŠ è½½å™¨å¹¶ä¸éœ€è¦ç­‰åˆ°æŸä¸ªç±»è¢«â€œé¦–æ¬¡ä¸»åŠ¨ä½¿ç”¨â€æ—¶å†åŠ è½½å®ƒï¼ŒJVMè§„èŒƒå…è®¸ç±»åŠ è½½å™¨åœ¨é¢„æ–™æŸä¸ªç±»å°†è¦è¢«ä½¿ç”¨æ—¶å°±é¢„å…ˆåŠ è½½å®ƒ è¿™é‡Œæœ‰ä¸¤ä¸ªé‡ç‚¹ï¼š å­—èŠ‚ç æ¥æºã€‚ä¸€èˆ¬çš„åŠ è½½æ¥æºåŒ…æ‹¬ä»æœ¬åœ°è·¯å¾„ä¸‹ç¼–è¯‘ç”Ÿæˆçš„.classæ–‡ä»¶ï¼Œä»jaråŒ…ä¸­çš„.classæ–‡ä»¶ï¼Œä»è¿œç¨‹ç½‘ç»œï¼Œä»¥åŠåŠ¨æ€ä»£ç†å®æ—¶ç¼–è¯‘ ç±»åŠ è½½å™¨ã€‚ä¸€èˆ¬åŒ…æ‹¬å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œæ‰©å±•ç±»åŠ è½½å™¨ï¼Œåº”ç”¨ç±»åŠ è½½å™¨ï¼Œä»¥åŠç”¨æˆ·çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚(Androidä¸­æ˜¯ç³»ç»Ÿç”¨PathClassLoaderï¼Œæ’ä»¶åŒ–çƒ­ä¿®å¤æ–¹æ¡ˆç”¨çš„DexClassLoaderå’Œæ‰€æœ‰classLoaderçš„çˆ¶ClassLoaderâ€”â€”BaseClassLoader) äºŒã€é“¾æ¥ï¼ˆLinkingï¼‰éªŒè¯å­—èŠ‚ç ã€ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶èµ‹defaultå€¼ï¼Œè§£æè¯¥ç±»åˆ›å»ºæ‰€éœ€è¦ç›´æ¥å¼•ç”¨ï¼› Javaåœ¨åŠ è½½äº†ç±»ä¹‹åï¼Œéœ€è¦è¿›è¡Œé“¾æ¥çš„æ­¥éª¤ï¼Œé“¾æ¥ç®€å•åœ°è¯´ï¼Œå°±æ˜¯å°†å·²ç»åŠ è½½çš„javaäºŒè¿›åˆ¶ä»£ç ç»„åˆåˆ°JVMè¿è¡ŒçŠ¶æ€ä¸­å»ã€‚å®ƒåŒ…æ‹¬3ä¸ªæ­¥éª¤ï¼š éªŒè¯ï¼ˆVerificationï¼‰â€‹ ç®€è¿°ï¼šä¿è¯äºŒè¿›åˆ¶å­—èŠ‚ç ç¬¦åˆè™šæ‹Ÿæœºè§„èŒƒï¼šåŒ…æ‹¬ç±»å‹æ­£ç¡®ã€è®¿é—®æƒé™ã€finalç±»æ˜¯å¦é”™è¯¯ç»§æ‰¿ç­‰ï¼› â€‹ éªŒè¯æ˜¯ä¿è¯äºŒè¿›åˆ¶å­—èŠ‚ç åœ¨ç»“æ„ä¸Šçš„æ­£ç¡®æ€§ï¼Œå…·ä½“æ¥è¯´ï¼Œå·¥ä½œåŒ…æ‹¬æ£€æµ‹ç±»å‹æ­£ç¡®æ€§ï¼Œæ¥å…¥å±æ€§æ­£ç¡®æ€§ï¼ˆpublicã€privateï¼‰ï¼Œæ£€æŸ¥final class æ²¡æœ‰è¢«ç»§æ‰¿ï¼Œæ£€æŸ¥é™æ€å˜é‡çš„æ­£ç¡®æ€§ç­‰ã€‚ å‡†å¤‡ï¼ˆPreparationï¼‰â€‹ ç®€è¿°ï¼šä¸æ‰§è¡Œä»»ä½•ä»£ç ï¼Œä»…ä¸ºç±»å˜é‡(static)åˆ†é…å†…å­˜å¹¶èµ‹é›¶å€¼ï¼šåŸºæœ¬ç±»å‹ä¸º0ï¼Œå¼•ç”¨ç±»å‹ä¸ºnullï¼› â€‹ å‡†å¤‡é˜¶æ®µä¸»è¦æ˜¯åˆ›å»ºé™æ€åŸŸï¼Œåˆ†é…ç©ºé—´ï¼Œç»™è¿™äº›åŸŸè®¾é»˜è®¤å€¼ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸¤ç‚¹ï¼šä¸€ä¸ªæ˜¯åœ¨å‡†å¤‡é˜¶æ®µä¸ä¼šæ‰§è¡Œä»»ä½•ä»£ç ï¼Œä»…ä»…æ˜¯è®¾ç½®é»˜è®¤å€¼ï¼ŒäºŒä¸ªæ˜¯è¿™äº›é»˜è®¤å€¼æ˜¯è¿™æ ·åˆ†é…çš„ï¼ŒåŸç”Ÿç±»å‹å…¨éƒ¨è®¾ä¸º0ï¼Œå¦‚ï¼šfloat:0f,int 0, long 0L, boolean:0ï¼ˆå¸ƒå°”ç±»å‹ä¹Ÿæ˜¯0ï¼‰ï¼Œå…¶å®ƒå¼•ç”¨ç±»å‹ä¸ºnullã€‚ è§£æï¼ˆResolutionï¼‰â€‹ ç®€è¿°ï¼šå°†ç¬¦å·å¼•ç”¨è§£ææˆç›´æ¥é¥®ç”¨ï¼ˆå³å­—ç¬¦ä¸²è§£ææˆå…·ä½“åœ°å€ï¼‰ç›´æ¥å¼•ç”¨æŒ‡çš„æ˜¯å­˜äºæ–¹æ³•åŒº-è¿è¡Œæ—¶å¸¸é‡æ± ä¸­çš„æ–¹æ³•å¼•ç”¨ â€‹ è§£æçš„è¿‡ç¨‹å°±æ˜¯å¯¹ç±»ä¸­çš„æ¥å£ã€ç±»ã€æ–¹æ³•ã€å˜é‡çš„ç¬¦å·å¼•ç”¨ï¼ˆå¤„äºæ–¹æ³•åŒºçš„ç±»ä¿¡æ¯ï¼‰è¿›è¡Œè§£æå¹¶å®šä½ï¼Œè§£ææˆç›´æ¥å¼•ç”¨ï¼ˆç¬¦å·å¼•ç”¨å°±æ˜¯ç¼–ç ï¼Œæ˜¯ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºæŸä¸ªå˜é‡ã€æ¥å£çš„ä½ç½®ï¼›ç›´æ¥å¼•ç”¨å°±æ˜¯æ ¹æ®ç¬¦å·å¼•ç”¨ç¿»è¯‘å‡ºæ¥çš„åœ°å€ï¼‰ï¼Œå¹¶ä¿è¯è¿™äº›ç±»è¢«æ­£ç¡®çš„æ‰¾åˆ°ã€‚è§£æçš„è¿‡ç¨‹å¯èƒ½å¯¼è‡´å…¶å®ƒçš„ç±»è¢«åŠ è½½ã€‚ ä¸‰ã€åˆå§‹åŒ–ï¼ˆInitializationï¼‰ç±»ä¸æ¥å£çš„åˆå§‹åŒ–ä¸åŒï¼Œå¦‚æœä¸€ä¸ªç±»è¢«åˆå§‹åŒ–ï¼Œåˆ™å…¶çˆ¶ç±»æˆ–çˆ¶æ¥å£ä¹Ÿä¼šè¢«åˆå§‹åŒ–ï¼Œä½†å¦‚æœä¸€ä¸ªæ¥å£åˆå§‹åŒ–ï¼Œåˆ™ä¸ä¼šå¼•èµ·å…¶çˆ¶æ¥å£çš„åˆå§‹åŒ–ã€‚ ç±»çš„åˆå§‹åŒ–æ—¶æœº:ç±»çš„åˆå§‹åŒ–å³javaè™šæ‹Ÿæœºä¸ºç±»çš„staticé™æ€å˜é‡èµ‹äºˆåˆå§‹å€¼(è¿™å’Œå‡†å¤‡é˜¶æ®µè®¾ç½®é»˜è®¤åˆå§‹å€¼ä¸º0æ˜¯ä¸ä¸€æ ·çš„)ã€‚åªæœ‰ç±»çš„ä¸»åŠ¨ä½¿ç”¨æ‰ä¼šåˆå§‹åŒ–ç±»ã€‚ 1.ç±»çš„ä¸»åŠ¨ä½¿ç”¨(6ç§): åˆ›å»ºç±»çš„å®ä¾‹ï¼šç”¨newè¯­å¥åˆ›å»ºå®ä¾‹ Person ps=new Person(); è°ƒç”¨ç±»çš„é™æ€å˜é‡æˆ–å¯¹é™æ€å˜é‡èµ‹å€¼ï¼š è°ƒç”¨ç±»çš„é™æ€æ–¹æ³• è°ƒç”¨java APIä¸­çš„åå°„æ–¹æ³•ï¼šClass.forName(â€œPersonâ€); åˆå§‹åŒ–å­ç±»çš„æ—¶å€™ä¼šå…ˆåˆå§‹åŒ–çˆ¶ç±»(ä½†â€çˆ¶ç±»â€æ˜¯æ¥å£çš„æ—¶å€™ï¼Œä¸ä¼šå…ˆåˆå§‹åŒ–å®ƒæ‰€å®ç°çš„æ¥å£çš„ï¼Œåªæœ‰åœ¨ç¨‹åºåœ¨ä½¿ç”¨æ¥å£çš„é™æ€å˜é‡æ—¶æ‰ä¼šä½¿é™æ€æ¥å£åˆå§‹åŒ–) javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±» 2.ç±»çš„è¢«åŠ¨ä½¿ç”¨: finalç±»å‹çš„é™æ€å˜é‡åœ¨ç¼–è¯‘çš„æ—¶å€™èƒ½è®¡ç®—å‡ºå€¼ï¼ˆå³ç¼–è¯‘æ—¶å¸¸é‡ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™å°†è¿™ä¸ªå€¼å°±æ”¾å…¥åˆ°å¸¸é‡æ± ä¸­äº†ï¼‰ï¼šæ³¨ï¼š finalç±»å‹çš„é™æ€å˜é‡åœ¨ç¼–è¯‘çš„æ—¶å€™ä¸èƒ½è®¡ç®—å‡ºå˜é‡çš„å€¼(å³è¿è¡Œæ—¶å¸¸é‡)çš„æ—¶å€™æ˜¯ä¼šè¢«åˆå§‹åŒ–çš„ 12final static int a=2*3; //å˜é‡aæ˜¯ç¼–è¯‘æ—¶å¸¸é‡final static int a=(int)Math.random(); //å˜é‡aä¸æ˜¯æ˜¯ç¼–è¯‘æ—¶å¸¸é‡ï¼ˆå³è¿è¡Œæ—¶å¸¸é‡ï¼‰ â€œçˆ¶ç±»â€æ˜¯æ¥å£çš„æ—¶å€™ï¼Œä¸ä¼šå…ˆåˆå§‹åŒ–å®ƒæ‰€å®ç°çš„æ¥å£çš„ï¼Œåªæœ‰åœ¨ç¨‹åºåœ¨ä½¿ç”¨æ¥å£çš„é™æ€å˜é‡æ—¶æ‰ä¼šä½¿é™æ€æ¥å£åˆå§‹åŒ– **ClassLoaderç±»çš„loadClass(â€œPersonâ€)**æ–¹æ³•çš„æ—¶å€™ï¼Œåªæ˜¯å¯¹ç±»çš„åŠ è½½ï¼Œä¸æ˜¯åˆå§‹åŒ–ã€‚Class.forName(â€œPersonâ€);æ‰ä¼šåˆå§‹åŒ– Other å˜é‡èµ‹å€¼ï¼š â€œäºŒ.1å‡†å¤‡é˜¶æ®µâ€ï¼Œæ˜¯jvmèµ‹staticå˜é‡åˆå€¼ï¼šåŒ…æ‹¬åŸºæœ¬ç±»å‹èµ‹å€¼é»˜è®¤å€¼0ã€å¼•ç”¨ç±»å‹èµ‹å€¼null â€ä¸‰ã€åˆå§‹åŒ–é˜¶æ®µâ€œï¼Œåˆ™æ ¹æ®ç¨‹åºå‘˜è‡ªå·±è®¾ç½®çš„å˜é‡èµ‹å€¼ã€‚ â€”â€”â€”â€”finalå˜é‡ åœ¨è¿è¡Œæ—¶åˆå§‹åŒ–ã€staticå˜é‡åœ¨â€œä¸‰ã€åˆå§‹åŒ–é˜¶æ®µâ€åˆå§‹åŒ–ï¼Œè‡³äºé»˜è®¤å€¼åˆ™éƒ½æ˜¯åœ¨â€œäºŒ.1å‡†å¤‡é˜¶æ®µâ€èµ‹äºˆäº†â€”â€”â€” ç±»åŠ è½½å™¨ åœ¨äº†è§£Javaçš„æœºåˆ¶ä¹‹å‰ï¼Œéœ€è¦å…ˆäº†è§£ç±»åœ¨JVMï¼ˆJavaè™šæ‹Ÿæœºï¼‰ä¸­æ˜¯å¦‚ä½•åŠ è½½çš„ï¼Œè¿™å¯¹åé¢ç†è§£javaå…¶å®ƒæœºåˆ¶å°†æœ‰é‡è¦ä½œç”¨ã€‚ æ¯ä¸ªç±»ç¼–è¯‘åäº§ç”Ÿä¸€ä¸ªClasså¯¹è±¡ï¼Œå­˜å‚¨åœ¨.classæ–‡ä»¶ä¸­ï¼ŒJVMä½¿ç”¨ç±»åŠ è½½å™¨ï¼ˆClass Loaderï¼‰æ¥åŠ è½½ç±»çš„å­—èŠ‚ç æ–‡ä»¶ï¼ˆ.classï¼‰ï¼Œç±»åŠ è½½å™¨å®è´¨ä¸Šæ˜¯ä¸€æ¡ç±»åŠ è½½å™¨é“¾ï¼Œä¸€èˆ¬çš„ï¼Œæˆ‘ä»¬åªä¼šç”¨åˆ°ä¸€ä¸ªåŸç”Ÿçš„ç±»åŠ è½½å™¨ï¼Œå®ƒåªåŠ è½½Java APIç­‰å¯ä¿¡ç±»ï¼Œé€šå¸¸åªæ˜¯åœ¨æœ¬åœ°ç£ç›˜ä¸­åŠ è½½ï¼Œè¿™äº›ç±»ä¸€èˆ¬å°±å¤Ÿæˆ‘ä»¬ä½¿ç”¨äº†ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦ä»è¿œç¨‹ç½‘ç»œæˆ–æ•°æ®åº“ä¸­ä¸‹è½½.classå­—èŠ‚ç æ–‡ä»¶ï¼Œé‚£å°±éœ€è¦æˆ‘ä»¬æ¥æŒ‚è½½é¢å¤–çš„ç±»åŠ è½½å™¨ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œç±»åŠ è½½å™¨æ˜¯æŒ‰ç…§æ ‘å½¢çš„å±‚æ¬¡ç»“æ„ç»„ç»‡çš„ï¼Œæ¯ä¸ªåŠ è½½å™¨éƒ½æœ‰ä¸€ä¸ªçˆ¶ç±»åŠ è½½å™¨ã€‚å¦å¤–ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½æ”¯æŒä»£ç†æ¨¡å¼ï¼Œå³å¯ä»¥è‡ªå·±å®ŒæˆJavaç±»çš„åŠ è½½å·¥ä½œï¼Œä¹Ÿå¯ä»¥ä»£ç†ç»™å…¶å®ƒç±»åŠ è½½å™¨ã€‚ ç±»åŠ è½½å™¨çš„åŠ è½½é¡ºåºæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯çˆ¶ç±»ä¼˜å…ˆç­–ç•¥ï¼Œä¸€ç§æ˜¯æ˜¯è‡ªå·±ä¼˜å…ˆç­–ç•¥ï¼Œçˆ¶ç±»ä¼˜å…ˆç­–ç•¥æ˜¯æ¯”è¾ƒä¸€èˆ¬çš„æƒ…å†µï¼ˆå¦‚JDKé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ–¹å¼ï¼‰ï¼Œåœ¨è¿™ç§ç­–ç•¥ä¸‹ï¼Œç±»åœ¨åŠ è½½æŸä¸ªJavaç±»ä¹‹å‰ï¼Œä¼šå°è¯•ä»£ç†ç»™å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåªæœ‰å½“çˆ¶ç±»åŠ è½½å™¨æ‰¾ä¸åˆ°æ—¶ï¼Œæ‰å°è¯•è‡ªå·±å»åŠ è½½ã€‚è‡ªå·±ä¼˜å…ˆçš„ç­–ç•¥ä¸çˆ¶ç±»ä¼˜å…ˆç›¸åï¼Œå®ƒä¼šé¦–å…ˆå°è¯•å­ç»æµåŠ è½½ï¼Œæ‰¾ä¸åˆ°çš„æ—¶å€™æ‰è¦çˆ¶ç±»åŠ è½½å™¨å»åŠ è½½ï¼Œè¿™ç§åœ¨webå®¹å™¨ï¼ˆå¦‚tomcatï¼‰ä¸­æ¯”è¾ƒå¸¸è§ã€‚","link":"/2021/10/26/ClassLoading/"},{"title":"EventDispatch","text":"Coreäº‹ä»¶åˆ†å‘ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„è§„åˆ™ï¼šä¸€ä¸ªè§¦æ§ç‚¹çš„ä¸€ä¸ªäº‹ä»¶åºåˆ—åªèƒ½ç»™ä¸€ä¸ªviewå¤„ç† åˆ†æï¼šä»¥DOWNäº‹ä»¶ä¸ºåºåˆ—åˆ†å‘åˆ¤å®šï¼ŒViewGroupä¸ºæ¶ˆè´¹DOWNäº‹ä»¶çš„Viewç”Ÿæˆä¸€ä¸ªTouchTargetï¼ˆè¿™ä¸ªTouchTargetå°±åŒ…å«äº†è¯¥viewçš„å®ä¾‹ä¸è§¦æ§idï¼Œidå¯ä»¥æ˜¯å¤šä¸ªä»¥åº”å¯¹å¤šæŒ‡è§¦æ§ï¼‰ï¼Œåç»­MOVEã€UPéƒ½ä¼šäº¤ç»™è¿™ä¸ªTouchTargetã€‚å¦‚æœTouchTargetä¸ºç©ºåˆ™ViewGroupè‡ªå·±å¤„ç†ã€‚å¦‚æœviewGroupæ¶ˆè´¹äº†downäº‹ä»¶ï¼Œé‚£ä¹ˆå­viewå°†æ— æ³•æ”¶åˆ°ä»»ä½•äº‹ä»¶ã€‚ é™¤éå¼‚å¸¸æƒ…å†µï¼š 1ã€æ¯”å¦‚ScrollViewåµŒå¥—ScrollViewæƒ…å†µä¸‹DOWNäº‹ä»¶è™½ç„¶MOVEäº‹ä»¶è¢«å¤–ScrollViewæ‹¦æˆªè€Œç”ŸæˆCANCELäº‹ä»¶åˆ†å‘ç»™å†…ScrollView)ã€‚ 2ã€ç•Œé¢è·³è½¬ç­‰æƒ…å†µã€‚ æ­¤æ—¶Viewéœ€è¦å¯¹CANCELäº‹ä»¶åšä¸€äº›çŠ¶æ€çš„æ¢å¤å·¥ä½œï¼Œå¦‚ç»ˆæ­¢åŠ¨ç”»ï¼Œæ¢å¤viewå¤§å°ç­‰ç­‰ã€‚ viewGroupæ˜¯å¦‚ä½•åˆ†å‘(dispatch)äº‹ä»¶çš„ï¼Ÿ viewGroupåˆ†å‘äº‹ä»¶ä¿¡æ¯åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼šæ‹¦æˆªã€å¯»æ‰¾å­æ§ä»¶ã€æ´¾å‘äº‹ä»¶ã€‚ ç¬¬ä¸€æ­¥ä¼šåˆ¤æ–­å½“å‰ViewGroupæ˜¯å¦disallowInterceptï¼Œå¦‚æœä¸æ˜¯ï¼ˆä¹Ÿå°±æ˜¯å…è®¸æ‹¦æˆªï¼‰åˆ™è°ƒç”¨onInterceptTouchEventæ–¹æ³•åˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œæ‹¦æˆªã€‚ï¼ˆå¦‚æœæ‹¦æˆªåˆ™ç›´æ¥èµ°è‡ªèº«çš„onTouchEvent()ï¼‰ç¬¬äºŒæ­¥æ˜¯å¦‚æœè¿™ä¸ªäº‹ä»¶æ˜¯downäº‹ä»¶å¹¶ä¸”æ²¡æœ‰æ‹¦æˆªæˆ–å–æ¶ˆï¼Œé‚£ä¹ˆéœ€è¦ä¸ºä»–å¯»æ‰¾ä¸€ä¸ªæ¶ˆè´¹æ­¤äº‹ä»¶çš„å­æ§ä»¶ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ä¸ºä»–åˆ›å»ºä¸€ä¸ªTouchTargetã€‚ç¬¬ä¸‰æ­¥æ˜¯æ´¾å‘äº‹ä»¶ï¼Œå¦‚æœå­˜åœ¨TouchTargetï¼Œè¯´æ˜æ‰¾åˆ°äº†æ¶ˆè´¹äº‹ä»¶åºåˆ—çš„å­viewï¼Œç›´æ¥åˆ†å‘ç»™ä»–ã€‚å¦‚æœæ²¡æœ‰åˆ™äº¤ç»™è‡ªå·±å¤„ç†ã€‚ Viewçš„enableå±æ€§ä¸å½±å“onTouchEventçš„é»˜è®¤è¿”å›å€¼, å“ªæ€•ä¸€ä¸ªViewæ˜¯disableçŠ¶æ€. åªè¦å®ƒçš„clickableæˆ–è€…longClickableæœ‰ä¸€ä¸ªä¸ºtrue. é‚£ä¹ˆå®ƒçš„onTouchEvent()å°±è¿”å›true. ç®€è¿°ï¼šå½“æ‰‹æŒ‡è§¦ç¢°åˆ°å±å¹•æ—¶ï¼Œå±å¹•ç¡¬ä»¶åº•å±‚äº§ç”Ÿä¸­æ–­ä¸ŠæŠ¥å¹¶é€šè¿‡nativeå±‚ä¼ åˆ°Activityå¼€å§‹äº‹ä»¶åˆ†å‘ã€‚Downäº‹ä»¶ä¼šä½¿Activityå…ˆè°ƒç”¨onUserInterationï¼Œä¹‹åç”±PhoneWindowï¼ˆViewGroupï¼‰è°ƒç”¨superDispatchTouchEventå°†äº‹ä»¶åˆ†å‘ç»™DecorViewï¼Œå¦‚æœDecorViewçš„Viewæ ‘æ²¡æœ‰å¤„ç†åˆ™å†è°ƒç”¨åˆ°Activityçš„onTouchEventæ¶ˆè´¹ã€‚ DecorViewäº‹å®ä¸Šæ˜¯ä¸€ä¸ªæœ€é¡¶å±‚å­˜åœ¨çš„ä¸€ä¸ªFrameLayoutï¼Œä»¥DecorViewå¼€å§‹ä»é¡¶å‘ä¸‹çš„å¼€å§‹ViewGroupçš„åˆ†å‘è¿‡ç¨‹ï¼šé¦–å…ˆåˆ¤æ–­ViewGroupæ˜¯å¦è¢«ç¦æ­¢æ‹¦æˆªï¼ˆViewGroup.requestDisallowInterceptTouchEventå¯ä½¿å½“å‰ViewGroupåŠå…¶çˆ¶è‡³é¡¶éƒ½ä¸å¯æ‹¦æˆªäº‹ä»¶ï¼‰ï¼Œæ²¡æœ‰ç¦æ­¢åˆ™å…ˆç”±ViewGroup.onInterceptTouchEventè¿”å›true/falseåˆ¤æ–­æ˜¯å¦æ‹¦æˆªäº‹ä»¶ï¼Œif trueï¼Œåˆ™äº‹ä»¶ä¸å†å¾€ä¸‹ä¼ é€’è€Œæ˜¯è°ƒç”¨æ‹¦æˆªè€…çš„ViewGroup.onTouchEventï¼Œelse ç»§ç»­å¾€ä¸‹ä¼ é€’ï¼ŒViewGroupå¾€å…¶child ViewGroup/Viewä¼ é€’ã€‚ViewGroupåˆ™é‡å¤æ­¤è¿‡ç¨‹ã€‚ç›´åˆ°æœ€åº•çš„Viewã€‚ Viewåœ¨View.dispathTouchEventä¸­åˆ†å‘ï¼šå…ˆåˆ¤æ–­æœ¬èº«æ˜¯å¦æœ‰OnTouchListenerä¸”æœ¬èº«çŠ¶æ€ä¸ºenableï¼Œç”±è¯¥OnTouchListener.onTouchå…ˆå¤„ç†ï¼Œç”±å…¶è¿”å›å€¼ä¸ºtrue/falseï¼Œif true åˆ™OnTouchListenerå·²ç»æ¶ˆè´¹äº†äº‹ä»¶ï¼Œelse è°ƒç”¨View.onTouchEventè¿›è¡Œå¤„ç†ï¼ŒåŒæ ·è¿”å›trueåˆ™ä¸ºViewæ¶ˆè´¹äº†äº‹ä»¶ï¼Œè¿”å›falseåˆ™ç”±å…¶çˆ¶ViewGroupçš„onTouchEvent ps:å¦‚æœViewæ²¡æœ‰æ¶ˆè´¹ACTION_DOWNäº‹ä»¶ï¼Œåˆ™ä¹‹åçš„ACTION_MOVEç­‰äº‹ä»¶éƒ½ä¸ä¼šå†æ¥æ”¶ã€‚ ç»å…¸ä¼ªä»£ç viewGroupæ˜¯å¦‚ä½•åˆ†å‘(dispatch)äº‹ä»¶çš„ï¼Ÿ viewGroupåˆ†å‘äº‹ä»¶ä¿¡æ¯åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼šæ‹¦æˆªã€å¯»æ‰¾å­æ§ä»¶ã€æ´¾å‘äº‹ä»¶ã€‚ ç¬¬ä¸€æ­¥ä¼šåˆ¤æ–­å½“å‰ViewGroupæ˜¯å¦disallowInterceptï¼Œå¦‚æœä¸æ˜¯ï¼ˆä¹Ÿå°±æ˜¯å…è®¸æ‹¦æˆªï¼‰åˆ™è°ƒç”¨onInterceptTouchEventæ–¹æ³•åˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œæ‹¦æˆªã€‚ï¼ˆå¦‚æœæ‹¦æˆªåˆ™ç›´æ¥èµ°è‡ªèº«çš„onTouchEvent()ï¼‰ç¬¬äºŒæ­¥æ˜¯å¦‚æœè¿™ä¸ªäº‹ä»¶æ˜¯downäº‹ä»¶å¹¶ä¸”æ²¡æœ‰æ‹¦æˆªæˆ–å–æ¶ˆï¼Œé‚£ä¹ˆéœ€è¦ä¸ºä»–å¯»æ‰¾ä¸€ä¸ªæ¶ˆè´¹æ­¤äº‹ä»¶çš„å­æ§ä»¶ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ä¸ºä»–åˆ›å»ºä¸€ä¸ªTouchTargetã€‚ç¬¬ä¸‰æ­¥æ˜¯æ´¾å‘äº‹ä»¶ï¼Œå¦‚æœå­˜åœ¨TouchTargetï¼Œè¯´æ˜æ‰¾åˆ°äº†æ¶ˆè´¹äº‹ä»¶åºåˆ—çš„å­viewï¼Œç›´æ¥åˆ†å‘ç»™ä»–ã€‚å¦‚æœæ²¡æœ‰åˆ™äº¤ç»™è‡ªå·±å¤„ç†ã€‚ å…·ä½“ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384public class MViewGroup extends MView implements ViewParent { private MView child; private boolean isChildNeedEvent = false; private boolean isSelfNeedEvent = false; private boolean isDisallowIntercept = false; public MViewGroup(MView child) { this.child = child; // è¿™é‡Œåªæ˜¯ç¤ºæ„ï¼Œå®é™…ä¸­ä¸å»ºè®®è¿™ä¹ˆå†™ï¼Œä¼šé€ æˆæå‰å‘å¸ƒæœªæ„é€ å®Œæˆçš„å®ä¾‹ child.parent = this; } @Override public boolean dispatch(MotionEvent ev) { boolean handled = false; if (ev.getActionMasked() == MotionEvent.ACTION_DOWN) { clearStatus(); if (!isDisallowIntercept &amp;&amp; onIntercept(ev)) { isSelfNeedEvent = true; handled = onTouch(ev); }else{ handled = child.dispatch(ev); if (handled) isChildNeedEvent = true; if (!handled) { // è¿™é‡Œæ²¡æœ‰ç”¨ if else æ˜¯å› ä¸ºè¿™æ ·å†™ä¸Šä¸‹ä¸€è‡´ï¼Œæ›´æ¸…æ™° handled = onTouch(ev); if (handled) isSelfNeedEvent = true; // è¿™ä¸€æ­¥æœ‰æ²¡æœ‰å¿…è¦å‘¢ï¼Ÿè¿˜æ˜¯æœ‰çš„ï¼Œä¼šæ›´æ¸…æ™°ï¼Œå¦åˆ™ä¸‹é¢çš„elseè¦å¤šå†™ä¸€ä¸ªä¸å¤ªæ¸…æ™°çš„else } } } else { // è¿™é‡Œ isSelfNeedEvent æ¡ä»¶åˆ¤æ–­åº”è¯¥æ”¾åœ¨ isChildNeedEvent å‰é¢ // å› ä¸ºä¸¤ä¸ªéƒ½ä¸ºçœŸçš„æƒ…å†µåªèƒ½æ˜¯è‡ªå·±ä¹‹åé€šè¿‡ onIntercept æŠ¢äº†æ§åˆ¶æƒï¼Œé‚£è¿™ä¹‹åçš„æ§åˆ¶æƒå°±ä¸ä¼šå» child é‚£å„¿äº† // çœŸå®æºç ä¸­ mFirstTouchTargetï¼ˆTouchTargetç±»ï¼‰ç”¨æ¥è®°å½•æ¶ˆè´¹äº†DOWNäº‹ä»¶çš„å­Viewï¼Œå³å¦‚æœä¸ºç©ºä¹Ÿå°±æ„å‘³ç€DOWNäº‹ä»¶ä¼šç”±è‡ªèº«å¤„ç†ã€‚ // if (mFirstTouchTarget == null) isSelfNeedEvent = true ç›¸å½“äº isChildNeedEvent = false, if (isSelfNeedEvent) { handled = onTouch(ev); } else if (isChildNeedEvent) { if (!isDisallowIntercept &amp;&amp; onIntercept(ev)) { isSelfNeedEvent = true; MotionEvent cancel = MotionEvent.obtain(ev); cancel.setAction(MotionEvent.ACTION_CANCEL); handled = child.dispatch(cancel); cancel.recycle(); } else { handled = child.dispatch(ev); } } // è¿™é‡Œä¸ç”¨å† else äº†ï¼Œå› ä¸ºå¦‚æœ isSelfNeedEvent å’Œ isChildNeedEvent éƒ½ä¸ä¸º trueï¼Œä¸Šé¢ä¸ä¼šå†å‘äº‹ä»¶ä¸‹æ¥äº† } if (ev.getActionMasked() == MotionEvent.ACTION_UP || ev.getActionMasked() == MotionEvent.ACTION_CANCEL) { this.clearStatus(); } return handled; } private void clearStatus() { isChildNeedEvent = false; isSelfNeedEvent = false; isDisallowIntercept = false; } public boolean onIntercept(MotionEvent ev) { return false; } @Override public boolean onTouch(MotionEvent ev) { return false; } @Override public void requestDisallowInterceptTouchEvent(boolean isDisallowIntercept) { this.isDisallowIntercept = isDisallowIntercept; if (parent != null) { parent.requestDisallowInterceptTouchEvent(isDisallowIntercept); } }} ç®€å•ï¼š 12345678910111213public boolean dispatchTouchEvent(MotionEvent event) { boolean consume = false; //è¡¨ç¤ºè¿™ä¸ªäº‹ä»¶æœ€ç»ˆçš„å¤„ç†ç»“æœ if (onInterceptTouchEvent(event)){ //äº‹ä»¶è¢«æ‹¦æˆªè‡ªå·±å¤„ç† consume = onTouchEvent(event); }else{ //äº‹ä»¶è¢«åˆ†å‘åˆ°å­viewçš„dispatchTouchEvent()ä¸­ consume = child.dispatchTouchEvent(event); } return consume;} æµç¨‹å›¾ onInterceptTouchEventè¿”å›å€¼trueè¡¨ç¤ºäº‹ä»¶æ‹¦æˆªï¼Œ onTouch/onTouchEvent è¿”å›å€¼trueè¡¨ç¤ºäº‹ä»¶æ¶ˆè´¹ã€‚ è§¦æ‘¸äº‹ä»¶å…ˆäº¤ç”±Activity.dispatchTouchEventã€‚å†ä¸€å±‚å±‚å¾€ä¸‹åˆ†å‘ï¼Œå½“ä¸­é—´çš„ViewGroupéƒ½ä¸æ‹¦æˆªæ—¶ï¼Œè¿›å…¥æœ€åº•å±‚çš„Viewåï¼Œå¼€å§‹ç”±æœ€åº•å±‚çš„OnTouchEventæ¥å¤„ç†ï¼Œå¦‚æœä¸€ç›´ä¸æ¶ˆè´¹ï¼Œåˆ™æœ€åè¿”å›åˆ°Activity.OnTouchEventã€‚ ViewGroupæ‰æœ‰onInterceptTouchEventæ‹¦æˆªæ–¹æ³•ã€‚åœ¨åˆ†å‘è¿‡ç¨‹ä¸­ï¼Œä¸­é—´ä»»ä½•ä¸€å±‚ViewGroupéƒ½å¯ä»¥ç›´æ¥æ‹¦æˆªï¼Œåˆ™ä¸å†å¾€ä¸‹åˆ†å‘ï¼Œè€Œæ˜¯äº¤ç”±å‘ç”Ÿæ‹¦æˆªæ“ä½œçš„ViewGroupçš„OnTouchEventæ¥å¤„ç†ã€‚ å­Viewå¯è°ƒç”¨requestDisallowInterceptTouchEventæ–¹æ³•ï¼Œæ¥è®¾ç½®disallowIntercept=trueï¼Œä»è€Œé˜»æ­¢çˆ¶ViewGroupçš„onInterceptTouchEventæ‹¦æˆªæ“ä½œã€‚ OnTouchEventç”±ä¸‹å¾€ä¸Šå†’æ³¡æ—¶ï¼Œå½“ä¸­é—´ä»»ä½•ä¸€å±‚çš„OnTouchEventæ¶ˆè´¹è¯¥äº‹ä»¶ï¼Œåˆ™ä¸å†å¾€ä¸Šä¼ é€’ï¼Œè¡¨ç¤ºäº‹ä»¶å·²å¤„ç†ã€‚ å¦‚æœViewæ²¡æœ‰æ¶ˆè´¹ACTION_DOWNäº‹ä»¶ï¼Œåˆ™ä¹‹åçš„ACTION_MOVEç­‰äº‹ä»¶éƒ½ä¸ä¼šå†æ¥æ”¶ã€‚ åªè¦View.onTouchEventæ˜¯å¯ç‚¹å‡»æˆ–å¯é•¿æŒ‰ï¼Œåˆ™æ¶ˆè´¹è¯¥äº‹ä»¶. onTouchä¼˜å…ˆäºonTouchEventæ‰§è¡Œï¼Œä¸Šé¢æµç¨‹å›¾ä¸­çœç•¥ï¼ŒonTouchçš„ä½ç½®åœ¨onTouchEventå‰é¢ã€‚å½“onTouchè¿”å›true,åˆ™ä¸æ‰§è¡ŒonTouchEvent,å¦åˆ™ä¼šæ‰§è¡ŒonTouchEventã€‚onTouchåªæœ‰Viewè®¾ç½®äº†OnTouchListenerï¼Œä¸”æ˜¯enableçš„æ‰æ‰§è¡Œè¯¥æ–¹æ³•ã€‚ é‚£ä¸»è¦çš„åˆ†å‘æµç¨‹æ˜¯ä»€ä¹ˆï¼š åœ¨ç¨‹åºçš„ä¸»ç•Œé¢æƒ…å†µä¸‹ï¼Œå¸ƒå±€çš„é¡¶å±‚viewæ˜¯DecorViewï¼Œä»–ä¼šå…ˆæŠŠäº‹ä»¶äº¤ç»™Activityï¼ŒActivityè°ƒç”¨PhoneWindowçš„æ–¹æ³•è¿›è¡Œåˆ†å‘ï¼ŒPhoneWindowä¼šè°ƒç”¨DecorViewçš„çˆ¶ç±»ViewGroupçš„dispatchTouchEventæ–¹æ³•è¿›è¡Œåˆ†å‘ã€‚ä¹Ÿå°±æ˜¯Activity-&gt;Window-&gt;ViewGroupçš„æµç¨‹ã€‚ViewGroupåˆ™ä¼šå‘ä¸‹å»å¯»æ‰¾åˆé€‚çš„æ§ä»¶å¹¶æŠŠäº‹ä»¶åˆ†å‘ç»™ä»–ã€‚ äº‹ä»¶ä¸€å®šä¼šç»è¿‡Activityå—ï¼Ÿ ä¸æ˜¯çš„ã€‚æˆ‘ä»¬çš„ç¨‹åºç•Œé¢çš„é¡¶å±‚viewGroupï¼Œä¹Ÿå°±æ˜¯decorViewä¸­æ³¨å†Œäº†Activityè¿™ä¸ªcallBackï¼Œæ‰€ä»¥å½“ç¨‹åºçš„ä¸»ç•Œé¢æ¥æ”¶åˆ°äº‹ä»¶ä¹‹åä¼šå…ˆäº¤ç»™Activityã€‚ä½†æ˜¯ï¼Œå¦‚æœæ˜¯å¦å¤–çš„æ§ä»¶æ ‘ï¼Œå¦‚dialogã€popupWindowç­‰äº‹ä»¶æµæ˜¯ä¸ä¼šç»è¿‡Activityçš„ã€‚åªæœ‰è‡ªå·±ç•Œé¢çš„äº‹ä»¶æ‰ä¼šç»Activityã€‚ Activityçš„åˆ†å‘æ–¹æ³•ä¸­è°ƒç”¨äº†onUserInteraction()æ–¹æ³•ï¼Œä½ èƒ½è¯´è¯´è¿™ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆä½œç”¨å—ï¼Ÿ å¥½çš„ã€‚è¿™ä¸ªæ–¹æ³•åœ¨Activityæ¥æ”¶åˆ°downçš„æ—¶å€™ä¼šè¢«è°ƒç”¨ï¼Œæœ¬èº«æ˜¯ä¸ªç©ºæ–¹æ³•ï¼Œéœ€è¦å¼€å‘è€…è‡ªå·±å»é‡å†™ã€‚é€šè¿‡å®˜æ–¹çš„æ³¨é‡Šå¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨æˆ‘ä»¬ä»¥ä»»æ„çš„æ–¹å¼å¼€å§‹ä¸Activityè¿›è¡Œäº¤äº’çš„æ—¶å€™è¢«è°ƒç”¨ã€‚æ¯”è¾ƒå¸¸è§çš„åœºæ™¯å°±æ˜¯å±ä¿ï¼šå½“æˆ‘ä»¬ä¸€æ®µæ—¶é—´æ²¡æœ‰æ“ä½œä¼šæ˜¾ç¤ºä¸€å¼ å›¾ç‰‡ï¼Œå½“æˆ‘ä»¬å¼€å§‹ä¸Activityäº¤äº’çš„æ—¶å€™å¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å–æ¶ˆå±ä¿ï¼›å¦å¤–è¿˜æœ‰æ²¡æœ‰æ“ä½œè‡ªåŠ¨éšè—å·¥å…·æ ï¼Œå¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è®©å·¥å…·æ é‡æ–°æ˜¾ç¤ºã€‚ å‰é¢ä½ è®²åˆ°æœ€åä¼šåˆ†å‘åˆ°viewGroupï¼Œé‚£ä¹ˆviewGroupæ˜¯å¦‚ä½•åˆ†å‘äº‹ä»¶çš„ï¼Ÿ viewGroupå¤„ç†äº‹ä»¶ä¿¡æ¯åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼šæ‹¦æˆªã€å¯»æ‰¾å­æ§ä»¶ã€æ´¾å‘äº‹ä»¶ã€‚ äº‹ä»¶åˆ†å‘ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„è§„åˆ™ï¼šä¸€ä¸ªè§¦æ§ç‚¹çš„ä¸€ä¸ªäº‹ä»¶åºåˆ—åªèƒ½ç»™ä¸€ä¸ªviewå¤„ç†ï¼Œé™¤éå¼‚å¸¸æƒ…å†µã€‚æ‰€ä»¥å¦‚æœviewGroupæ¶ˆè´¹äº†downäº‹ä»¶ï¼Œé‚£ä¹ˆå­viewå°†æ— æ³•æ”¶åˆ°ä»»ä½•äº‹ä»¶ã€‚ viewGroupç¬¬ä¸€æ­¥ä¼šåˆ¤è¯»è¿™ä¸ªäº‹ä»¶æ˜¯å¦éœ€è¦åˆ†å‘ç»™å­viewï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨onInterceptTouchEventæ–¹æ³•åˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œæ‹¦æˆªã€‚ç¬¬äºŒæ­¥æ˜¯å¦‚æœè¿™ä¸ªäº‹ä»¶æ˜¯downäº‹ä»¶ï¼Œé‚£ä¹ˆéœ€è¦ä¸ºä»–å¯»æ‰¾ä¸€ä¸ªæ¶ˆè´¹æ­¤äº‹ä»¶çš„å­æ§ä»¶ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ä¸ºä»–åˆ›å»ºä¸€ä¸ªTouchTargetã€‚ç¬¬ä¸‰æ­¥æ˜¯æ´¾å‘äº‹ä»¶ï¼Œå¦‚æœå­˜åœ¨TouchTargetï¼Œè¯´æ˜æ‰¾åˆ°äº†æ¶ˆè´¹äº‹ä»¶åºåˆ—çš„å­viewï¼Œç›´æ¥åˆ†å‘ç»™ä»–ã€‚å¦‚æœæ²¡æœ‰åˆ™äº¤ç»™è‡ªå·±å¤„ç†ã€‚ ä½ å‰é¢è®²åˆ°â€œä¸€ä¸ªè§¦æ§ç‚¹çš„ä¸€ä¸ªäº‹ä»¶åºåˆ—åªèƒ½ç»™ä¸€ä¸ªviewå¤„ç†ï¼Œé™¤éå¼‚å¸¸æƒ…å†µâ€,è¿™é‡Œæœ‰ä»€ä¹ˆå¼‚å¸¸æƒ…å†µå‘¢ï¼Ÿå¦‚æœå‘ç”Ÿå¼‚å¸¸æƒ…å†µè¯¥å¦‚ä½•å¤„ç†ï¼Ÿ è¿™é‡Œçš„å¼‚å¸¸æƒ…å†µä¸»è¦æœ‰ä¸¤ç‚¹ï¼š1.è¢«viewGroupæ‹¦æˆªï¼Œ2.å‡ºç°ç•Œé¢è·³è½¬ç­‰å…¶ä»–æƒ…å†µã€‚ å½“äº‹ä»¶æµä¸­æ–­æ—¶ï¼ŒviewGroupä¼šå‘é€ä¸€ä¸ªACTION_CANCELäº‹ä»¶ç»™åˆ°viewï¼Œæ­¤æ—¶éœ€è¦åšä¸€äº›çŠ¶æ€çš„æ¢å¤å·¥ä½œï¼Œå¦‚ç»ˆæ­¢åŠ¨ç”»ï¼Œæ¢å¤viewå¤§å°ç­‰ç­‰ã€‚ å“¦ï¼Ÿè¯´åˆ°å¤šæŒ‡ï¼Œé‚£ä½ çŸ¥é“ViewGroupæ˜¯å¦‚ä½•å°†å¤šä¸ªæ‰‹æŒ‡äº§ç”Ÿçš„äº‹ä»¶å‡†ç¡®åˆ†å‘ç»™ä¸åŒçš„å­viewå— è¿™ä¸ªé—®é¢˜çš„å…³é”®åœ¨äºMotionEventä»¥åŠViewGroupå†…éƒ¨çš„TouchTargetã€‚ æ¯ä¸ªMotionEventä¸­éƒ½åŒ…å«äº†å½“å‰å±å¹•æ‰€æœ‰è§¦æ§ç‚¹çš„ä¿¡æ¯ï¼Œä»–çš„å†…éƒ¨ç”¨äº†ä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨ä¸åŒçš„è§¦æ§idæ‰€å¯¹åº”çš„åæ ‡æ•°å€¼ã€‚ å½“ä¸€ä¸ªå­viewæ¶ˆè´¹äº†downäº‹ä»¶ä¹‹åï¼ŒViewGroupä¼šä¸ºè¯¥viewåˆ›å»ºä¸€ä¸ªTouchTargetï¼Œè¿™ä¸ªTouchTargetå°±åŒ…å«äº†è¯¥viewçš„å®ä¾‹ä¸è§¦æ§idã€‚è¿™é‡Œçš„è§¦æ§idå¯ä»¥æ˜¯å¤šä¸ªï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªviewå¯æ¥å—å¤šä¸ªè§¦æ§ç‚¹çš„äº‹ä»¶åºåˆ—ã€‚ å½“ä¸€ä¸ªMotionEventåˆ°æ¥ä¹‹æ—¶ï¼ŒViewGroupä¼šå°†å…¶ä¸­çš„è§¦æ§ç‚¹ä¿¡æ¯æ‹†å¼€ï¼Œå†åˆ†åˆ«å‘é€ç»™æ„Ÿå…´è¶£çš„å­viewã€‚ä»è€Œè¾¾åˆ°ç²¾å‡†å‘é€è§¦æ§ç‚¹ä¿¡æ¯çš„ç›®çš„ã€‚ é‚£viewæ”¯æŒå¤„ç†å¤šæŒ‡ä¿¡æ¯å—ï¼Ÿ Viewé»˜è®¤æ˜¯ä¸æ”¯æŒçš„ã€‚ä»–åœ¨è·å–è§¦æ§ç‚¹ä¿¡æ¯çš„æ—¶å€™å¹¶æ²¡æœ‰ä¼ å…¥è§¦æ§ç‚¹ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯è·å–çš„æ˜¯MotionEventå†…éƒ¨æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªè§¦æ§ç‚¹çš„ä¿¡æ¯ã€‚å¤šæŒ‡éœ€è¦æˆ‘ä»¬è‡ªå·±å»é‡å†™æ–¹æ³•æ”¯æŒä»–ã€‚ å—¯å—¯â€¦é‚£Viewæ˜¯å¦‚ä½•å¤„ç†è§¦æ‘¸äº‹ä»¶çš„ï¼Ÿ é¦–å…ˆï¼Œä»–ä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨onTouchListenerï¼Œå­˜åœ¨åˆ™ä¼šè°ƒç”¨ä»–çš„onTouchæ–¹æ³•æ¥å¤„ç†äº‹ä»¶ã€‚å¦‚æœè¯¥æ–¹æ³•è¿”å›trueé‚£ä¹ˆå°±åˆ†å‘ç»“æŸç›´æ¥è¿”å›ã€‚è€Œå¦‚æœè¯¥ç›‘å¬å™¨ä¸ºnullæˆ–è€…onTouchæ–¹æ³•è¿”å›äº†falseï¼Œåˆ™ä¼šè°ƒç”¨onTouchEventæ–¹æ³•æ¥å¤„ç†äº‹ä»¶ã€‚ onTouchEventæ–¹æ³•ä¸­æ”¯æŒäº†ä¸¤ç§ç›‘å¬å™¨ï¼šonClickListenerå’ŒonLongClickListenerã€‚Viewä¼šæ ¹æ®ä¸åŒçš„è§¦æ‘¸æƒ…å†µæ¥è°ƒç”¨è¿™ä¸¤ä¸ªç›‘å¬å™¨ã€‚åŒæ—¶è¿›å…¥åˆ°onTouchEventæ–¹æ³•ä¸­ï¼Œæ— è®ºè¯¥viewæ˜¯å¦æ˜¯enableï¼Œåªè¦æ˜¯clickableï¼Œä»–çš„åˆ†å‘æ–¹æ³•éƒ½æ˜¯è¿”å›trueã€‚ æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼šå…ˆè°ƒç”¨onTouchListenerï¼Œå†è°ƒç”¨onClickListenerå’ŒonLongClickListenerã€‚ View æ˜¯æœ€åä¸€ä¸ªå¤„ç†äº‹ä»¶åˆ†å‘çš„èŠ‚ç‚¹äº†ä¸ºä»€ä¹ˆäº†è¿˜ä¼šæœ‰dispatchTouchEventå‘¢ï¼Ÿ æ˜¯å› ä¸º,åœ¨è¯¥æ–¹æ³•ä¸­,è¦å¯¹viewçš„é•¿æŒ‰äº‹ä»¶,è§¦æ‘¸äº‹ä»¶,ç‚¹å‡»äº‹ä»¶è¿›è¡Œè°ƒåº¦å¤„ç† æ•´ç†è‡ªï¼šAndroidäº‹ä»¶åˆ†å‘æœºåˆ¶ - Gityuanåšå®¢ | è¢è¾‰è¾‰çš„æŠ€æœ¯åšå®¢ (32æ¡æ¶ˆæ¯) Androidäº‹ä»¶åˆ†å‘æœºåˆ¶äº”ï¼šé¢è¯•å®˜ä½ åå•Š_ä¸€åªä¿®ä»™çš„çŒ¿-CSDNåšå®¢_androidäº‹ä»¶åˆ†å‘æœºåˆ¶é¢è¯• ç›¸å…³æºç Activityå’ŒPhoneWindowç›¸å…³Activityæ˜¯Androidå››å¤§åŸºæœ¬ç»„ä»¶ä¹‹ä¸€ï¼Œå½“æ‰‹æŒ‡è§¦æ‘¸åˆ°å±å¹•æ—¶ï¼Œå±å¹•ç¡¬ä»¶ä¸€è¡Œè¡Œä¸æ–­åœ°æ‰«ææ¯ä¸ªåƒç´ ç‚¹ï¼Œè·å–åˆ°è§¦æ‘¸äº‹ä»¶åï¼Œä»åº•å±‚äº§ç”Ÿä¸­æ–­ä¸ŠæŠ¥ã€‚å†é€šè¿‡nativeå±‚è°ƒç”¨Javaå±‚InputEventReceiverä¸­çš„dispatchInputEventæ–¹æ³•ã€‚ç»è¿‡å±‚å±‚è°ƒç”¨ï¼Œäº¤ç”±Activityçš„dispatchTouchEventæ–¹æ³•æ¥å¤„ç†ã€‚ 1234567891011121314151617181920212223242526#Activity.javaclass Activity extends...implement ... { public boolean dispatchTouchEvent(MotionEvent ev) { if (ev.getAction() == MotionEvent.ACTION_DOWN) { //ç¬¬ä¸€æ¬¡æŒ‰ä¸‹æ“ä½œæ—¶ï¼Œç”¨æˆ·å¸Œæœ›èƒ½ä¸è®¾å¤‡è¿›è¡Œäº¤äº’ï¼Œå¯é€šè¿‡å®ç°è¯¥æ–¹æ³• onUserInteraction(); } //è·å–å½“å‰Activityçš„é¡¶å±‚çª—å£æ˜¯PhoneWindow [è§PhoneWindow] if (getWindow().superDispatchTouchEvent(ev)) { return true; } //å½“æ²¡æœ‰ä»»ä½•viewå¤„ç†æ—¶ï¼Œäº¤ç”±activityçš„onTouchEventå¤„ç† return onTouchEvent(ev); // [è§å°èŠ‚2.2.1] } public boolean onTouchEvent(MotionEvent event) { //å½“çª—å£éœ€è¦å…³é—­æ—¶ï¼Œæ¶ˆè´¹æ‰å½“å‰event if (mWindow.shouldCloseOnTouch(this, event)) { finish(); return true; } return false; } } PhoneWindowçš„æœ€é¡¶Viewæ˜¯DecorViewï¼Œå†äº¤ç”±DecorViewå¤„ç†ã€‚è€ŒDecorViewçš„çˆ¶ç±»çš„çˆ¶ç±»æ˜¯ViewGroup,æ¥ç€è°ƒç”¨ ViewGroup.dispatchTouchEvent()æ–¹æ³•ã€‚ 123456#PhoneWindow.javaPhoneWindow implement Window { public boolean superDispatchTouchEvent(KeyEvent event) { return mDecor.superDispatcTouchEvent(event); // [è§å°èŠ‚2.4] }} ViewGroupé¦–å…ˆåˆ¤æ–­ViewGroupæ˜¯å¦è¢«ç¦æ­¢æ‹¦æˆªï¼ˆViewGroup.requestDisallowInterceptTouchEventå¯ä½¿å½“å‰ViewGroupåŠå…¶çˆ¶è‡³é¡¶éƒ½ä¸å¯æ‹¦æˆªäº‹ä»¶ï¼‰ï¼Œæ²¡æœ‰ç¦æ­¢åˆ™å…ˆç”±ViewGroup.onInterceptTouchEventè¿”å›true/falseåˆ¤æ–­æ˜¯å¦æ‹¦æˆªäº‹ä»¶ï¼Œif trueï¼Œåˆ™äº‹ä»¶ä¸å†å¾€ä¸‹ä¼ é€’è€Œæ˜¯è°ƒç”¨æ‹¦æˆªè€…çš„ViewGroup.onTouchEventï¼Œelse ç»§ç»­å¾€ä¸‹ä¼ é€’ã€‚ dispatchTransformedTouchEventæ˜¯çœŸæ­£å¤„ç†ViewGroupäº‹ä»¶çš„æ–¹æ³•ï¼Œå…¶ä¸­ä¼šåˆ¤æ–­æ˜¯å¦å½“å‰ViewGroupå¦‚æœå·²ç»æ²¡æœ‰child ViewGroup/Viewäº†ï¼Œåˆ™ç”±è‡ªèº«çš„onTouchEventå¤„ç†ï¼›æœ‰çš„è¯ViewGroup éå†childä¼ å…¥è¯¥æ–¹æ³•ä¸­åˆ¤æ–­ç‚¹å‡»åæ ‡æ˜¯å¦åœ¨childåŒºåŸŸä¸­ï¼Œæ˜¯åˆ™è°ƒç”¨å¯¹åº”child ViewGroup/Viewçš„dispatchTouchEventåˆ†å‘ã€‚ ViewGroupåˆ™é‡å¤æ­¤è¿‡ç¨‹ã€‚ç›´åˆ°æœ€åº•çš„Viewã€‚ åªæœ‰å½“Downäº‹ä»¶è¢«dispatchTouchEventæ¥å—æ—¶æ‰ä¼šç»§ç»­å¤„ç†å…¶ç³»åˆ—MOVEã€UPç­‰äº‹ä»¶ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154public boolean dispatchTouchEvent(MotionEvent ev) { ... boolean handled = false; //æ ¹æ®éšç§ç­–ç•¥è€Œæ¥å†³å®šæ˜¯å¦è¿‡æ»¤æœ¬æ¬¡è§¦æ‘¸äº‹ä»¶, if (onFilterTouchEventForSecurity(ev)) { // [è§å°èŠ‚2.4.1] final int action = ev.getAction(); final int actionMasked = action &amp; MotionEvent.ACTION_MASK; if (actionMasked == MotionEvent.ACTION_DOWN) { // å‘ç”ŸACTION_DOWNäº‹ä»¶, åˆ™å–æ¶ˆå¹¶æ¸…é™¤ä¹‹å‰æ‰€æœ‰çš„è§¦æ‘¸targets cancelAndClearTouchTargets(ev); resetTouchState(); // é‡ç½®è§¦æ‘¸çŠ¶æ€ } // å‘ç”ŸACTION_DOWNäº‹ä»¶æˆ–è€…å·²ç»å‘ç”Ÿè¿‡ACTION_DOWN;æ‰è¿›å…¥æ­¤åŒºåŸŸï¼Œä¸»è¦åŠŸèƒ½æ˜¯æ‹¦æˆªå™¨ //åªæœ‰å‘ç”Ÿè¿‡ACTION_DOWNäº‹ä»¶ï¼Œåˆ™mFirstTouchTarget != null; final boolean intercepted; if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { //å¯é€šè¿‡è°ƒç”¨requestDisallowInterceptTouchEventï¼Œå½“å‰ViewGroupåŠå…¶åˆ°é¡¶çš„çˆ¶ViewGroupç¦æ­¢æ‹¦æˆªäº‹ä»¶ final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; //åˆ¤æ–­æ˜¯å¦å…è®¸è°ƒç”¨æ‹¦æˆªå™¨ if (!disallowIntercept) { //è°ƒç”¨æ‹¦æˆªæ–¹æ³• intercepted = onInterceptTouchEvent(ev); // [è§å°èŠ‚2.4.2] ev.setAction(action); } else { intercepted = false; } } else { // å½“æ²¡æœ‰è§¦æ‘¸targetsï¼Œä¸”ä¸æ˜¯downäº‹ä»¶æ—¶ï¼Œå¼€å§‹æŒç»­æ‹¦æˆªè§¦æ‘¸ã€‚ intercepted = true; } ... //ä¸å–æ¶ˆäº‹ä»¶ï¼ŒåŒæ—¶ä¸æ‹¦æˆªäº‹ä»¶, å¹¶ä¸”æ˜¯Downäº‹ä»¶æ‰è¿›å…¥è¯¥åŒºåŸŸ if (!canceled &amp;&amp; !intercepted) { //æŠŠäº‹ä»¶åˆ†å‘ç»™æ‰€æœ‰çš„å­è§†å›¾ï¼Œå¯»æ‰¾å¯ä»¥è·å–ç„¦ç‚¹çš„è§†å›¾ã€‚ View childWithAccessibilityFocus = ev.isTargetAccessibilityFocus() ? findChildWithAccessibilityFocus() : null; if (actionMasked == MotionEvent.ACTION_DOWN || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN) || actionMasked == MotionEvent.ACTION_HOVER_MOVE) { //...... if (newTouchTarget == null &amp;&amp; childrenCount != 0) { //...... for (int i = childrenCount - 1; i &gt;= 0; i--) { //...... çœç•¥è‹¥å¹²ä»£ç ...... //é‡ç½®å–æ¶ˆæˆ–æŠ¬èµ·æ ‡å¿—ä½ //å¦‚æœè§¦æ‘¸ä½ç½®åœ¨childçš„åŒºåŸŸå†…ï¼Œåˆ™æŠŠäº‹ä»¶åˆ†å‘ç»™å­Viewæˆ–ViewGroup //================ &lt;mark&gt; dispatchTransformedTouchEvent &lt;!mark&gt;================ if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) { // [è§å°èŠ‚2.4.4] // è·å–TouchDownçš„æ—¶é—´ç‚¹ mLastTouchDownTime = ev.getDownTime(); // è·å–TouchDownçš„Index if (preorderedList != null) { for (int j = 0; j &lt; childrenCount; j++) { if (children[childIndex] == mChildren[j]) { mLastTouchDownIndex = j; break; } } } else { mLastTouchDownIndex = childIndex; } //è·å–TouchDownçš„x,yåæ ‡ mLastTouchDownX = ev.getX(); mLastTouchDownY = ev.getY(); //æ·»åŠ TouchTarget,åˆ™mFirstTouchTarget != nullã€‚ [è§å°èŠ‚2.4.5] //=========================ï¼addTouchTargetï¼========================== newTouchTarget = addTouchTarget(child, idBitsToAssign); //è¡¨ç¤ºå·²ç»åˆ†å‘ç»™NewTouchTarget alreadyDispatchedToNewTouchTarget = true; break; } ev.setTargetAccessibilityFocus(false); } // æ¸…é™¤è§†å›¾åˆ—è¡¨ if (preorderedList != null) preorderedList.clear(); } if (newTouchTarget == null &amp;&amp; mFirstTouchTarget != null) { //å°†mFirstTouchTargetçš„é“¾è¡¨æœ€åçš„touchTargetèµ‹ç»™newTouchTarget newTouchTarget = mFirstTouchTarget; while (newTouchTarget.next != null) { newTouchTarget = newTouchTarget.next; } newTouchTarget.pointerIdBits |= idBitsToAssign; } } } // mFirstTouchTargetèµ‹å€¼æ˜¯åœ¨é€šè¿‡addTouchTargetæ–¹æ³•è·å–çš„ï¼› // åªæœ‰å¤„ç†ACTION_DOWNäº‹ä»¶ï¼Œæ‰ä¼šè¿›å…¥addTouchTargetæ–¹æ³•ã€‚ // è¿™ä¹Ÿæ­£æ˜¯å½“Viewæ²¡æœ‰æ¶ˆè´¹ACTION_DOWNäº‹ä»¶ï¼Œåˆ™ä¸ä¼šæ¥æ”¶å…¶ä»–MOVE,UPç­‰äº‹ä»¶çš„åŸå›  if (mFirstTouchTarget == null) { //æ²¡æœ‰è§¦æ‘¸target,åˆ™ç”±å½“å‰ViewGroupæ¥å¤„ç†ã€‚ //================&lt;mark&gt; dispatchTransformedTouchEvent &lt;!mark&gt;================ handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS); } else { //å¦‚æœViewæ¶ˆè´¹ACTION_DOWNäº‹ä»¶ï¼Œé‚£ä¹ˆMOVE,UPç­‰äº‹ä»¶ç›¸ç»§å¼€å§‹æ‰§è¡Œ TouchTarget predecessor = null; TouchTarget target = mFirstTouchTarget; while (target != null) { final TouchTarget next = target.next; if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) { handled = true; } else { final boolean cancelChild = resetCancelNextUpFlag(target.child) || intercepted; if (dispatchTransformedTouchEvent(ev, cancelChild, target.child, target.pointerIdBits)) { handled = true; } if (cancelChild) { if (predecessor == null) { mFirstTouchTarget = next; } else { predecessor.next = next; } target.recycle(); target = next; continue; } } predecessor = target; target = next; } } //å½“å‘ç”ŸæŠ¬èµ·æˆ–å–æ¶ˆäº‹ä»¶ï¼Œæ›´æ–°è§¦æ‘¸targets if (canceled || actionMasked == MotionEvent.ACTION_UP || actionMasked == MotionEvent.ACTION_HOVER_MOVE) { resetTouchState(); } else if (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) { final int actionIndex = ev.getActionIndex(); final int idBitsToRemove = 1 &lt;&lt; ev.getPointerId(actionIndex); removePointersFromTouchTargets(idBitsToRemove); } } //æ­¤å¤„å¤§æ‹¬å·ï¼Œæ˜¯if (onFilterTouchEventForSecurity(ev))çš„ç»“å°¾ //é€šçŸ¥verifierç”±äºå½“å‰æ—¶é—´æœªå¤„ç†ï¼Œé‚£ä¹ˆè¯¥äº‹ä»¶å…¶ä½™çš„éƒ½å°†è¢«å¿½ç•¥ if (!handled &amp;&amp; mInputEventConsistencyVerifier != null) { mInputEventConsistencyVerifier.onUnhandledEvent(ev, 1); } return handled;} 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel, View child, int desiredPointerIdBits) { final boolean handled; // å‘ç”Ÿå–æ¶ˆæ“ä½œæ—¶ï¼Œä¸å†æ‰§è¡Œåç»­çš„ä»»ä½•æ“ä½œ final int oldAction = event.getAction(); if (cancel || oldAction == MotionEvent.ACTION_CANCEL) { event.setAction(MotionEvent.ACTION_CANCEL); if (child == null) { handled = super.dispatchTouchEvent(event); } else { handled = child.dispatchTouchEvent(event); } event.setAction(oldAction); return handled; } final int oldPointerIdBits = event.getPointerIdBits(); final int newPointerIdBits = oldPointerIdBits &amp; desiredPointerIdBits; //ç”±äºæŸäº›åŸå› ï¼Œå‘ç”Ÿä¸ä¸€è‡´çš„æ“ä½œï¼Œé‚£ä¹ˆå°†æŠ›å¼ƒè¯¥äº‹ä»¶ if (newPointerIdBits == 0) { return false; } //åˆ†å‘çš„ä¸»è¦åŒºåŸŸ final MotionEvent transformedEvent; //åˆ¤æ–­é¢„æœŸçš„pointer idä¸äº‹ä»¶çš„pointer idæ˜¯å¦ç›¸ç­‰ if (newPointerIdBits == oldPointerIdBits) { if (child == null || child.hasIdentityMatrix()) { if (child == null) { //ä¸å­˜åœ¨å­è§†å›¾æ—¶ï¼ŒViewGroupè°ƒç”¨View.dispatchTouchEventåˆ†å‘äº‹ä»¶ï¼Œå†è°ƒç”¨ViewGroup.onTouchEventæ¥å¤„ç†äº‹ä»¶ handled = super.dispatchTouchEvent(event); // [è§å°èŠ‚2.4] } else { final float offsetX = mScrollX - child.mLeft; final float offsetY = mScrollY - child.mTop; event.offsetLocation(offsetX, offsetY); //å°†è§¦æ‘¸äº‹ä»¶åˆ†å‘ç»™å­ViewGroupæˆ–View; //å¦‚æœæ˜¯ViewGroupï¼Œåˆ™è°ƒç”¨ä»£ç (2.1)ï¼› //å¦‚æœæ˜¯Viewï¼Œåˆ™è°ƒç”¨ä»£ç (3.1)ï¼› handled = child.dispatchTouchEvent(event); event.offsetLocation(-offsetX, -offsetY); //è°ƒæ•´è¯¥äº‹ä»¶çš„ä½ç½® } return handled; } transformedEvent = MotionEvent.obtain(event); //æ‹·è´è¯¥äº‹ä»¶ï¼Œæ¥åˆ›å»ºä¸€ä¸ªæ–°çš„MotionEvent } else { //åˆ†ç¦»äº‹ä»¶ï¼Œè·å–åŒ…å«newPointerIdBitsçš„MotionEvent transformedEvent = event.split(newPointerIdBits); } if (child == null) { //ä¸å­˜åœ¨å­è§†å›¾æ—¶ï¼ŒViewGroupè°ƒç”¨View.dispatchTouchEventåˆ†å‘äº‹ä»¶ï¼Œå†è°ƒç”¨ViewGroup.onTouchEventæ¥å¤„ç†äº‹ä»¶ handled = super.dispatchTouchEvent(transformedEvent); // [è§å°èŠ‚2.4] } else { final float offsetX = mScrollX - child.mLeft; final float offsetY = mScrollY - child.mTop; transformedEvent.offsetLocation(offsetX, offsetY); if (! child.hasIdentityMatrix()) { //å°†è¯¥è§†å›¾çš„çŸ©é˜µè¿›è¡Œè½¬æ¢ transformedEvent.transform(child.getInverseMatrix()); } //å°†è§¦æ‘¸äº‹ä»¶åˆ†å‘ç»™å­ViewGroupæˆ–View; //å¦‚æœæ˜¯ViewGroupï¼Œåˆ™ [è§å°èŠ‚2.4]; å¦‚æœæ˜¯Viewï¼Œåˆ™[è§å°èŠ‚2.5]; handled = child.dispatchTouchEvent(transformedEvent); } //å›æ”¶transformedEvent transformedEvent.recycle(); return handled;} 123456private TouchTarget addTouchTarget(View child, int pointerIdBits) { TouchTarget target = TouchTarget.obtain(child, pointerIdBits); target.next = mFirstTouchTarget; mFirstTouchTarget = target; return target;} View12345678910111213141516171819202122232425262728293031323334353637public boolean dispatchTouchEvent(MotionEvent event) { ... final int actionMasked = event.getActionMasked(); if (actionMasked == MotionEvent.ACTION_DOWN) { //åœ¨Downäº‹ä»¶ä¹‹å‰ï¼Œå¦‚æœå­˜åœ¨æ»šåŠ¨æ“ä½œåˆ™åœæ­¢ã€‚ä¸å­˜åœ¨åˆ™ä¸è¿›è¡Œæ“ä½œ stopNestedScroll(); } // mOnTouchListener.onTouchä¼˜å…ˆäºonTouchEventã€‚ if (onFilterTouchEventForSecurity(event)) { //å½“å­˜åœ¨OnTouchListenerï¼Œä¸”è§†å›¾çŠ¶æ€ä¸ºENABLEDæ—¶ï¼Œè°ƒç”¨onTouch()æ–¹æ³• ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnTouchListener != null &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; li.mOnTouchListener.onTouch(this, event)) { result = true; //å¦‚æœå·²ç»æ¶ˆè´¹äº‹ä»¶ï¼Œåˆ™è¿”å›True } //å¦‚æœOnTouchï¼ˆ)æ²¡æœ‰æ¶ˆè´¹Touchäº‹ä»¶åˆ™è°ƒç”¨OnTouchEvent() if (!result &amp;&amp; onTouchEvent(event)) { // [è§å°èŠ‚2.5.1] result = true; //å¦‚æœå·²ç»æ¶ˆè´¹äº‹ä»¶ï¼Œåˆ™è¿”å›True } } if (!result &amp;&amp; mInputEventConsistencyVerifier != null) { mInputEventConsistencyVerifier.onUnhandledEvent(event, 0); } // å¤„ç†å–æ¶ˆæˆ–æŠ¬èµ·æ“ä½œ if (actionMasked == MotionEvent.ACTION_UP || actionMasked == MotionEvent.ACTION_CANCEL || (actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) { stopNestedScroll(); } return result;}","link":"/2021/04/10/EventDispatch/"},{"title":"FirstScreenCost.md","text":"Activityå¯åŠ¨è€—æ—¶é¦–å…ˆï¼šæµ‹è¯•æ–¹æ³•ï¼š AMSä¼šæ‰“å°å¯åŠ¨Activityçš„è€—æ—¶ï¼ŒAndroid 10ä¹‹åæ‰“å°tagä¸ºActivityTaskManagerï¼ŒAndroid10ä¹‹å‰æ‰“å°ActivityManager; åœ¨Android 10ï¼ˆQï¼‰ç‰ˆæœ¬ä¸­ï¼ŒAndroidç³»ç»Ÿå¼•å…¥äº†ActivityTaskManagerï¼ˆATMï¼‰ï¼Œå¹¶åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå–ä»£äº†ä¹‹å‰çš„ActivityManagerServiceï¼ˆAMSï¼‰çš„è®¸å¤šèŒè´£ã€‚å…·ä½“æ¥è¯´ï¼ŒAMSè´Ÿè´£ç®¡ç†æ•´ä¸ªç³»ç»Ÿçš„æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸå’Œä»»åŠ¡å †æ ˆï¼Œè€Œåœ¨Android 10ä¸­ï¼Œè¿™äº›èŒè´£è¢«é‡æ–°åˆ†é…å¹¶åˆ†ç¦»åˆ°æ–°çš„ActivityTaskManagerå’ŒActivityManagerä¸­ã€‚ ActivityTaskManagerä¸“æ³¨äºä»»åŠ¡å’Œæ´»åŠ¨çš„ç®¡ç†ï¼Œå¤„ç†ä»»åŠ¡å †æ ˆçš„æ“ä½œå’Œæ´»åŠ¨çš„å¯åŠ¨ã€åˆ‡æ¢ç­‰ã€‚è€ŒActivityManageråˆ™æ›´å¤šåœ°å¤„ç†ä¸åº”ç”¨è¿›ç¨‹ç®¡ç†ç›¸å…³çš„åŠŸèƒ½ï¼Œå¦‚è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€å†…å­˜ç®¡ç†ç­‰ã€‚ è¿™ä¸€æ”¹å˜æ˜¯ä¸ºäº†ç®€åŒ–ä»£ç ç»“æ„ã€æå‡ç³»ç»Ÿçš„æ¨¡å—åŒ–å’Œå¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†æ›´å¥½åœ°æ”¯æŒå¤šçª—å£å’Œå¤šä»»åŠ¡æ“ä½œç­‰æ–°çš„ç‰¹æ€§ã€‚ æ€»ç»“èµ·æ¥ï¼ŒActivityTaskManagerçš„å¼•å…¥å’Œå®ç°ä»Android 10å¼€å§‹æ­£å¼åº”ç”¨ï¼Œå–ä»£äº†åŸæœ‰çš„éƒ¨åˆ†ActivityManagerServiceçš„åŠŸèƒ½ã€‚ ActivityManager : Display / startActivity Android6/7 ç®€å•ç»“è®ºï¼šdisplay åªç»Ÿè®¡A onPauseä¹‹åï¼ˆä¸åŒ…å«A onPauseï¼‰ AMS å¯åŠ¨æ–°ActivityB å¹¶ æ‰§è¡Œ Bçš„onCreateã€onstartã€onresume ä¸ Bå‘WMSæ³¨å†Œçª—å£åˆ°ç¼–èˆè€…å‘èµ·çš„ç¬¬ä¸€æ¬¡æµ‹ç»˜ å®Œæˆ Activityçš„å¯åŠ¨å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼Œä»¥ActivityAå¯åŠ¨ActivityBä¸ºä¾‹ï¼Œä¸‰æ­¥éª¤åˆ†åˆ«ä¸ºï¼š ä»¥ActivityAè°ƒç”¨startActivityï¼Œåˆ°ActivityAæˆåŠŸpauseä¸ºæ­¢ displayTimeStart ActivityBæˆåŠŸåˆå§‹åŒ–ï¼Œåˆ°æ‰§è¡Œå®Œresumeä¸ºæ­¢ ActivityBå‘WSMæ³¨å†Œçª—å£ï¼Œåˆ°ç¬¬ä¸€å¸§ç»˜åˆ¶å®Œæˆä¸ºæ­¢displayTimeEnd","link":"/2024/06/04/FirstScreenCost/"},{"title":"empty","text":"PackageManagerService WindowManagerService(done?) ActivityManagerService(done?) ServiceManager(done?) Binder ANR 1ã€reviewkernel bright spots Apmç›‘æ§ frescoæ·±å…¥ä¼˜åŒ– æ€§èƒ½ä¼˜åŒ–å·¥ä½œ/å·¥å…· skills pool recyclerviewç¼“å­˜å’Œä¼˜åŒ– appã€androidå¯åŠ¨æµç¨‹ ç¼–è¯‘æµç¨‹ ç¼–èˆè€…ä»¥åŠå±å¹•åˆ·æ–°åŸç†ï¼ˆä¸è€—æ—¶æ–¹æ³•ç›‘å¬ä¹‹ï¼‰ æ’ä»¶åŒ–ï¼ˆä»£ç†å’Œhookä¸¤ç§æ–¹å¼ï¼‰ handler https&amp;httpï¼ˆhttp versionï¼‰ hashmap Matrixä¸ºä¸»ï¼ŒDokitã€blockcanaryç­‰APMæ¡†æ¶ Jmmä¸GCç®—æ³•ï¼ˆæ·±å…¥ç†è§£javaè™šæ‹Ÿæœº-æ ‡è®°æ¸…é™¤ä¹‹ç±»ï¼‰ tcpæ»‘åŠ¨çª—å£ä¹‹ç±»ï¼ˆå°±æ‰¾ä¸€ç¯‡æ–‡ç« likeè…¾è®¯ä¹‹å‰çš„é‚£ç¯‡tcp ipé—®é¢˜å½»åº•å¼„æ‡‚TCPåè®®ï¼šä»ä¸‰æ¬¡æ¡æ‰‹è¯´èµ· (qq.com)ï¼‰ leakCanaryã€retrofitã€okhttpã€glideã€ threadLocalã€Rvå››çº§ç¼“å­˜ 2ã€TODO kotlinåç¨‹ é” ç®—æ³•ï¼ˆ1~2ï¼‰ Viewæµ‹ç»˜ï¼Œäº‹ä»¶åˆ†å‘ï¼ˆäº‹ä»¶ç³»åˆ—åªèƒ½è¢«æ•´ä¸€ä¸ªå¤„ç†ï¼‰ SurfaceView, TextureViewåŠViewçš„åŒºåˆ«ã€‚SurfaceViewæ€ä¹ˆæ§åˆ¶å®ƒå¤„äºçš„å±‚çº§ SMTPäº†è§£ä¸‹ 3ã€Optimize Experience å›¾ç‰‡å†…å­˜ä¼˜åŒ–å·¥ä½œï¼šfrescoå…³äºgifç¼“å­˜é—®é¢˜ä¿®å¤ï¼Œdokitå›¾ç‰‡é—ªçƒç¼“å­˜å¤±æ•ˆé—®é¢˜çš„ä¿®å¤ã€åŸºäºdokitæ¡†æ¶ï¼ˆASMï¼‰ä¸‹å°ºå¯¸è¿‡å¤§å›¾ç‰‡è¯†åˆ«å®ç°ã€‚ï¼ˆåŸºäºä¸šåŠ¡åšçš„ä¸€äº›å›¾ç‰‡åŠ è½½çš„ä¼˜åŒ–ï¼Œå¦‚cdné“¾æ¥ç»Ÿä¸€åŸŸåï¼Œregexï¼ˆString.replaceï¼‰è€—æ—¶200usï¼‰ è€—æ—¶æ–¹æ³•ï¼Œä¸¤ç§å¸¸è§çš„ç›‘å¬æ–¹å¼ï¼šlooper.printer ä»¥åŠ ç¼–èˆè€…å›è°ƒç›‘å¬ recyclerviewä¼˜åŒ– 4ã€Other h5å›¾ç‰‡ç¼“å­˜å…±ç”¨çš„ä¼˜åŒ–æ€è·¯ é˜¿é‡Œpatronå’ŒMetrixåšçš„native hook å‡å°‘32bitæ¨¡å¼ä¸‹appå†…å­˜å ç”¨ Project Experienceä»è´­ç‰©è½¦é‡æ„åˆ°è´­ç‰©è½¦é¢„åŠ è½½ps:æˆ‘å¹¶ä¸æƒ³æŠ½è±¡çš„å»å°†è´­ç‰©è½¦çš„æ¶æ„ä¹‹ç±»çš„ä¸œè¥¿ï¼Œè€Œæ˜¯æ›´å…·ä½“çš„è®²é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆã€‚ä¸è¿‡è¿˜æ˜¯å¾—ç®€å•è®²ä¸€ä¸‹è®¾è®¡ è´­ç‰©è½¦ä»£ç ååˆ†å±å±±ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚åœ¨23å¹´æ—¶åšäº†ä¸€æ¬¡å†ç»ä¸€ä¸ªæœˆçš„é‡æ„ï¼Œè¾¹å¼€è½¦è¾¹æ¢è½®å­ã€‚ä½¿ç”¨å¤šæ•°ä¸šåŠ¡åœ¨ç”¨çš„åè®®æ¶æ„å¥¥åˆ›é‡æ„ï¼šå…ˆè¯´æ”¶ç›Šï¼šå¥¥åˆ›åŠ è´­ä»¥ç»„ä»¶ä¸ºå•ä½ï¼ŒèŒè´£æ¸…æ™°ï¼Œæ˜“äºå¤ç”¨ç»´æŠ¤ï¼Œç«¯ä¾§ç»„ä»¶ä½¿ç”¨MVVMæ¶æ„è¿›ä¸€æ­¥è§£è€¦é€»è¾‘ï¼š ä¸¾ä¸ªä¾‹å­ï¼Œè¯·æ±‚åœ¨modelå±‚ï¼ˆå…±ç”¨çš„Repositoryï¼Œç»´æŠ¤äºEngineå±‚ï¼‰ï¼Œæ¯ä¸ªç»„ä»¶é€šè¿‡æ³¨å†Œç»„ä»¶çš„ViewHolderè·å¾—ç‹¬ç«‹çš„Viewï¼Œæ³¨å†Œç»„ä»¶çš„Parserè·å¾—ç‹¬ç«‹çš„ViewModelè§£ææ•°æ®åŠè¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚viewä¸vmä¹‹é—´ä½¿ç”¨liveDataè¿›è¡Œæ•°æ®æ›´æ–°åçš„é€šçŸ¥viewçŠ¶æ€æ¸²æŸ“ã€‚ é‡åˆ°çš„é—®é¢˜ï¼š å¥¥åˆ›å†—ä½™æ•°æ®åŠåç«¯æ¥å£æ…¢ -&gt; è´­ç‰©è½¦æœ¬åœ°æ•°æ®ç¼“å­˜ + ï¼ˆdetail/è´­ç‰©è½¦è¿›ä¸‹å•é¡µï¼‰çš„æ•°æ®é¢„åŠ è½½ + è´­ç‰©è½¦é¢„åŠ è½½çš„æ ¹æ®abtestä¸‹åšçš„ç²¾ç»†è¿è¥ã€‚ LiveDataçš„ä½¿ç”¨ï¼šè´­ç‰©è½¦æä¾›ç»™MainActiivtyçš„å…¶ä»–Tabç”±äºæ—¶æœºé—®é¢˜å¯¼è‡´çš„åˆ·æ–°é—®é¢˜ å¤šå›½å®¶é…ç½®ä¸åŒç»„ä»¶ -&gt; é—®é¢˜ï¼šä¸€äº›ç»„ä»¶ä¸åŒå›½å®¶éœ€è¦é…ç½®ä¸åŒçš„æ ·å¼å’Œé€»è¾‘ï¼Œä½†æ˜¯ä¸‹å‘çš„ç»„ä»¶åæ˜¯ä¸€è‡´çš„ã€‚é‚£ä¹ˆå½“æ—¶æœ‰ä¸¤ç§åšæ³•ï¼šä¸€ç§æ˜¯ç›´æ¥åœ¨è§£ææ˜¯ç¯¡æ”¹æ‰ç½‘ç»œæ•°æ®ä¸­çš„ç»„ä»¶åï¼Œæœ¬åœ°æ­£å¸¸æ˜ å°„ã€‚ä½†æ˜¯è¿™ä¸ªè¯„ä¼°å®Œè®¤ä¸ºç›´æ¥ä¿®æ”¹äº†æ•°æ®ï¼Œé£é™©æ›´ä¸å¥½æ§ã€‚äºæ˜¯æˆ‘åœ¨æ³¨å†Œç»„ä»¶åæ—¶æ ¹æ®ä¾é  åŒåParseråæ³¨å†Œçš„Parserä¼˜å…ˆåŒ¹é…çš„æœºåˆ¶ å®ç° çš„ç‰¹æ€§ï¼Œåœ¨æ³¨å†ŒParseræ—¶æä¾›å°†å¤šå›½å®¶çš„parseråç½®æ¥å£ï¼Œäºæ˜¯å½“è§£æå®Œå¤šå›½å®¶ç»„ä»¶parseråå³ä¸ä¼šå†æ˜ å°„é€šç”¨ç»„ä»¶äº†ï¼Œå³ä¸å½±å“åŸæ•°æ®ï¼Œä¹Ÿå®ç°äº†å¤šå›½å®¶ä¸æ–°å¢åç«¯ç»„ä»¶ã€‚ RTL adapte What: Lträ¸‹ä¸åŒå¸ç§å¯¼è‡´çš„æ˜¾ç¤ºé¡ºåºé”™ä¹±ï¼› How: æœåŠ¡ç«¯é…ç½®ä¸‹å‘ç‰¹æ®Šç¬¦å· More: åšè¿‡å°è±¡æ¯”è¾ƒæ·±çš„äº‹æƒ… ï¼Œæœ‰æŒ‘æˆ˜çš„äº‹æƒ… å¼±ç½‘ç¯å¢ƒä¼˜åŒ–ï¼šä¸šåŠ¡å’ŒæŠ€æœ¯çš„æ‰‹æ®µï¼Œæœ‰ä»€ä¹ˆå¾ˆæŠ€æœ¯çš„æ‰‹æ®µæ¥åšå— å½“å‰å›¢é˜Ÿçš„ä¼˜åŠ£ç‚¹ é‡åˆ°ä¸åˆç†éœ€æ±‚ä½ ä¼šæ€ä¹ˆæ‹’ç» æœ‰ç”¨è¿‡æ–°çš„ä¸œè¥¿å— çº¿ä¸Šé—®é¢˜æ€ä¹ˆè§£å†³ï¼Œå› ä¸ºä¸èƒ½ç”¨åŠ¨æ€å­—èŠ‚ç æŠ€æœ¯ é‡åˆ°å•¥æœ‰æ„æ€çš„é—®é¢˜å—ï¼Œcrashã€‚window 123456789101112131415161718192021222324252627282930313233343536373839java.lang.IllegalArgumentException: View=android.widget.PopupWindow$PopupDecorView{2a10009 V.E...... R.....I. 0,0-0,0} not attached to window manager at android.view.WindowManagerGlobal.findViewLocked(WindowManagerGlobal.java:544) at android.view.WindowManagerGlobal.updateViewLayout(WindowManagerGlobal.java:433) at android.view.WindowManagerImpl.updateViewLayout(WindowManagerImpl.java:162) at android.widget.PopupWindow.update(PopupWindow.java:2226) at android.widget.PopupWindow.update(PopupWindow.java:2347) at android.widget.PopupWindow.alignToAnchor(PopupWindow.java:2517) at android.widget.PopupWindow.-$$Nest$malignToAnchor(Unknown Source:0) at android.widget.PopupWindow$1.onViewAttachedToWindow(PopupWindow.java:243) at android.view.View.dispatchAttachedToWindow(View.java:21423) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3502) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewGroup.dispatchAttachedToWindow(ViewGroup.java:3509) at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:3011) at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:2518) at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:9389) at android.view.Choreographer$CallbackRecord.run(Choreographer.java:1451) at android.view.Choreographer$CallbackRecord.run(Choreographer.java:1459) at android.view.Choreographer.doCallbacks(Choreographer.java:1089) at android.view.Choreographer.doFrame(Choreographer.java:1003) at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:1431) at android.os.Handler.handleCallback(Handler.java:942) at android.os.Handler.dispatchMessage(Handler.java:99) at android.os.Looper.loopOnce(Looper.java:210) at android.os.Looper.loop(Looper.java:299) at android.app.ActivityThread.main(ActivityThread.java:8261) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:559) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:954) OOMçš„æ²»ç†ï¼šcrashç‡åœ¨ä¸€æ¬¡æ¶æ„ç»„çš„å‡çº§åç”±ä¸‡4æ¶¨åˆ°ä¸‡6ï¼Œå…¶ä¸­æ–°å¢äº†å¾ˆå¤šçš„OOMã€‚1ï¼šä¿®å¤äº†EventCenterçš„å†…å­˜æ³„éœ²ï¼›2ï¼šæœæ¨æœåŠ¡é€ æˆçš„æ³„éœ²ï¼› å†…å­˜å…œåº•æªæ–½ï¼š2gè®¾å¤‡ç›´æ¥æ”¹ä¸ºRGB565ï¼Œå…¶ä»–æ‰å¼€ARGB8888ï¼›åŒæ—¶é™ä½èµ·è®¾å¤‡å›¾ç‰‡å†…å­˜æ± å¤§å°;","link":"/2021/07/30/Emty/"},{"title":"fresco","text":"Frescoï¼ˆ2.5.0ï¼‰ä»¥MVCçš„ Frescoæ¶æ„å…¥æ‰‹ï¼Œå±‚å±‚é€’è¿›åˆ†æfrescoçš„æ•´ä½“æ€è·¯ã€‚ ä¸ªäººç†è§£ä¼šå°† å›¾ä¸­çš„UIå±‚è¿›ä¸€æ­¥åˆ†ä¸º DraweeViewä¸ºViewå±‚ï¼ˆè´Ÿè´£æ¸²æŸ“ï¼‰ï¼ŒDraweeHierarchyä¸ºModelå±‚ï¼ˆè®°å½•é…ç½®ä¸æ•°æ®Drawable[6]ï¼‰ï¼ŒDraweeControllerä¸ºControllerå±‚ï¼ˆåˆ†ç¦»PorducerSequenceåŠ è½½ç¼“å­˜è´£ä»»é“¾æ¡ï¼‰ psï¼šMVCç°åœ¨å¾ˆå¤šå˜ç§ä¸­éƒ½ä¼šæœ‰Viewå±‚ä¸Modelå±‚ äº¤äº’ï¼ŒViewå±‚ä¸Controllerå±‚ äº¤äº’ã€‚ä½†ä¸€èˆ¬éƒ½ä¸ä¼šæœ‰ModelæŒæœ‰Controllerã€‚æ‰€ä»¥æˆ‘ä¼šå°†frescoç†è§£ä¸ºMVCã€‚ Viewâ€”DraweeViewä¹Ÿå°±æ˜¯æˆ‘ä»¬ç›´æ¥æ¥è§¦åˆ°çš„å…·ä½“å®ç°ç±» SimpleDraweeView ã€‚æ—©æœŸæ˜¯ç»§æ‰¿imageViewç±»çš„ï¼Œåæ¥æ˜¯æ”¹æˆviewå¹¶ç”±draweeViewè‡ªå·±æ¸²æŸ“å›¾å±‚ ç»§æ‰¿äº View, è´Ÿè´£å›¾ç‰‡çš„æ˜¾ç¤ºã€‚æŒæœ‰DraweeHolder ï¼ˆDraweeHolderä¸­å«æœ‰çš„modelå±‚ å’Œ DraweeController çš„controllerå±‚ï¼‰ã€‚//è§ä¸Šå›¾ SimpleDraweeViewä¸­ï¼ŒsetImageUrlæ–¹æ³•ä¸­ç›´æ¥è°ƒç”¨ 1AbstractDraweeControllerBuilder.build() ä»¥æ„é€ Controllerã€‚ è‡³äºAbstractDraweeControllerBuilderå”¯ä¸€ç»§æ‰¿ç±»ï¼Œæ˜¯PipelineDraweeControllerBuilderã€‚ PipelineDraweeControllerBuilderä¸­obtainControlleræ˜¯å€ŸåŠ©PipelineDraweeControllerFactoryå®Œæˆçš„ å…·ä½“çœ‹ä¸‹é¢çš„Controlerâ€”DraweeControllerè§£æ Modelâ€”DraweeHierarchyç›´æ¥ç”¨åˆ°çš„æ˜¯GenericDraweeHierarchyï¼Œè¿™ä¸€å±‚ä¿å­˜å’Œç®¡ç†å›¾ç‰‡çš„å…­ä¸ªå›¾å±‚ï¼ˆlayersï¼‰ï¼Œå¦‚æœæœ‰overlayçš„è¯å†åŠ ä¸€å±‚ Fresco å›¾ç‰‡æ¸²æŸ“ â€”â€” å…­å±‚drawable1234567public class DraweeView&lt;DH extends DraweeHierarchy&gt; extends ImageView { public void setController(@Nullable DraweeController draweeController) { mDraweeHolder.setController(draweeController); super.setImageDrawable(mDraweeHolder.getTopLevelDrawable()); }} åœ¨è°ƒç”¨SimpleDraweeView.setImageUri()æ—¶ä¼šè°ƒç”¨åˆ°DraweeView.setController(),å³æ­¤æ—¶æ˜¯ç›´æ¥æ˜¾ç¤ºçš„mDraweeHolder.getTopLevelDrawable(): DraweeHolder.java 123public @Nullable Drawable getTopLevelDrawable() { return mHierarchy == null ? null : mHierarchy.getTopLevelDrawable();} æ‰€ä»¥æœ€ç»ˆçš„æ˜¾ç¤ºçš„Drawableæ˜¯mHierarchy.getTopLevelDrawable()ã€‚mHierarchyçš„å®ç°æ˜¯GenericDraweeHierarchyã€‚mHierarchy.getTopLevelDrawable()è·å–çš„Drawableå®é™…ä¸Šå¯ä»¥ç†è§£ä¸ºFadeDrawable: GenericDraweeHierarchy.java 12345GenericDraweeHierarchy(GenericDraweeHierarchyBuilder builder) { mFadeDrawable = new FadeDrawable(layers); Drawable maybeRoundedDrawable = WrappingUtils.maybeWrapWithRoundedOverlayColor(mFadeDrawable, mRoundingParams); mTopLevelDrawable = new RootDrawable(maybeRoundedDrawable); //RootDrawable åªæ˜¯ä¸€ä¸ªè£…é¥°ç±»} FadeDrawableå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªDrawableæ•°ç»„ï¼Œå®ƒå¯ä»¥ç”±ä¸€ä¸ªDrawableåˆ‡æ¢åˆ°å¦ä¸€ä¸ªDrawableï¼ŒDrawableçš„åˆ‡æ¢è¿‡ç¨‹ä¸­ä¼´æœ‰ç€é€æ˜åº¦æ”¹å˜çš„åŠ¨ç”»: 12345678910111213public class FadeDrawable extends ArrayDrawable { private final Drawable[] mLayers; @Override public void draw(Canvas canvas) { ...æ›´æ–°Drawableçš„é€æ˜åº¦ //ä»å‰å¾€åä¸€å±‚ä¸€å±‚çš„ç”»å‡ºæ¥ for (int i = 0; i &lt; mLayers.length; i++) { drawDrawableWithAlpha(canvas, mLayers[i], mAlphas[i] * mAlpha / 255); } }} ä¸»è¦æœ‰é¡¶çº§å›¾å±‚ï¼Œå ä½ç¬¦å›¾å±‚ï¼Œç›®æ ‡æ˜¾ç¤ºå›¾å±‚ï¼Œé‡æ–°åŠ è½½å›¾å±‚ï¼Œæ˜¾ç¤ºå¤±è´¥å›¾å±‚ï¼Œ è¿›åº¦æ¡å›¾å±‚ï¼Œæ§åˆ¶è¦†ç›–å›¾å±‚ DraweeHierarchyç”±DraweeControllerç›´æ¥æŒæœ‰çš„ï¼ŒDraweeControlleré€šè¿‡DataSourceèƒ½è½»æ˜“å¾—åˆ°å„ä¸ªå›¾ç‰‡åŠ è½½æ—¶æœºï¼Œå› æ­¤å¯¹äºä¸åŒå›¾ç‰‡æ˜¾ç¤ºçš„åˆ‡æ¢æ“ä½œå…·ä½“æ˜¯ç”±DraweeControlleræ¥ç›´æ¥æ“ä½œçš„ã€‚ Controlerâ€”DraweeControllerå…³é”®è¯ï¼šä¾èµ–æ³¨å…¥ï¼ˆæ§åˆ¶åè½¬çš„æ€æƒ³ï¼‰ã€è´£ä»»é“¾ã€ç”Ÿäº§è€…æ¶ˆè´¹è€…ã€æ„å»ºè€… frescoä¸­å…·ä½“å®ç°ä¸ºPipelineDraweeControllerï¼Œé›†æˆå…³ç³»ï¼š 1public class PipelineDraweeController extends AbstractDraweeController 12345678910public abstract class AbstractDraweeController&lt;T, INFO&gt; implements DraweeController { public void onAttach() { } public void onDetach() { } protected void submitRequest() { }} 1public interface DraweeController DraweeControllerä¸DataSourceç›´æ¥äº¤äº’ï¼Œé€šè¿‡DataSourceæ§åˆ¶ProducterSequenceä»¥ è´£ä»»é“¾æ¨¡å¼çš„æ€æƒ³ åŠ è½½å›¾ç‰‡ã€‚ ä» bitmapå¯¹è±¡ åˆ° æœªè§£ç å›¾ç‰‡çš„å†…å­˜ç¼“å­˜ åˆ° å›¾ç‰‡çš„ç£ç›˜ç¼“å­˜ åˆ° ç½‘ç»œæ‹‰å– DraweeControllerçš„æ„é€ åœ¨Frescoä¸­DraweeControlleræ˜¯é€šè¿‡DraweeControllerBuilderæ¥æ„é€ çš„ã€‚è€ŒDraweeControllerBuilderåœ¨Frescoä¸­æ˜¯ä»¥å•ä¾‹çš„å½¢å¼å­˜åœ¨çš„ã€‚Frescoåœ¨åˆå§‹åŒ–æ—¶ä¼šè°ƒç”¨ä¸‹é¢çš„ä»£ç : Fresco.java 1234private static void initializeDrawee(Context context, @Nullable DraweeConfig draweeConfig) { sDraweeControllerBuilderSupplier = new PipelineDraweeControllerBuilderSupplier(context, draweeConfig); SimpleDraweeView.initialize(sDraweeControllerBuilderSupplier);} æ‰€ä»¥æ‰€æœ‰çš„DraweeControlleréƒ½æ˜¯é€šè¿‡åŒä¸€ä¸ªDraweeControllerBuilderæ¥æ„é€ çš„ã€‚Frescoæ¯æ¬¡å›¾ç‰‡åŠ è½½éƒ½ä¼šå¯¹åº”åˆ°ä¸€ä¸ªDraweeControllerï¼Œä¸€ä¸ªDraweeViewçš„å¤šæ¬¡å›¾ç‰‡åŠ è½½å¯ä»¥å¤ç”¨åŒä¸€ä¸ªDraweeController: SimpleDraweeView.java 123456789public void setImageURI(Uri uri, @Nullable Object callerContext) { DraweeController controller = mControllerBuilder .setCallerContext(callerContext) .setUri(uri) //è®¾ç½®æ–°çš„å›¾ç‰‡åŠ è½½è·¯å¾„ .setOldController(getController()) //å¤ç”¨ controller .build(); setController(controller);} æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ : **ä¸€ä¸ªDraweeViewå¯¹åº”ä¸€ä¸ªDraweeController**ã€‚ç”±äºDraweeControllerå¾ˆé‡ï¼Œæ‰€ä»¥ä½¿ç”¨obtainController() å›æ”¶åˆ©ç”¨å¹¶ControllerBuilderæä¾›setOldController()ä¼ å…¥draweeViewå¤ç”¨DraweeController é€šè¿‡DataSourceå‘èµ·å›¾ç‰‡åŠ è½½åœ¨å‰é¢å·²ç»è¯´äº†DraweeControlleræ˜¯ç›´æ¥æŒæœ‰DraweeHierachyï¼Œæ‰€ä»¥å®ƒè§‚å¯Ÿåˆ°ProducerSequenceçš„æ•°æ®å˜åŒ–æ˜¯å¯ä»¥å¾ˆå®¹æ˜“æ›´æ–°åˆ°DraweeHierachyï¼ˆå…·ä½“ä»£ç å…ˆä¸å±•ç¤ºäº†ï¼‰ã€‚é‚£å®ƒæ˜¯å¦‚ä½•æ§åˆ¶ProducerSequenceæ¥åŠ è½½å›¾ç‰‡çš„å‘¢ï¼Ÿå…¶å®DraweeControllerå¹¶ä¸ä¼šç›´æ¥å’ŒProducerSequenceå‘ç”Ÿå…³è”ã€‚å¯¹äºå›¾ç‰‡çš„åŠ è½½ï¼Œå®ƒç›´æ¥æ¥è§¦çš„æ˜¯DataSourceï¼Œç”±DataSourceè¿›è€Œæ¥æ§åˆ¶ProducerSequenceå‘èµ·å›¾ç‰‡åŠ è½½å’Œå¤„ç†æµç¨‹ã€‚ä¸‹é¢å°±è·Ÿéšæºç æ¥çœ‹ä¸€ä¸‹DraweeControlleræ˜¯å¦‚æœé€šè¿‡DataSourceæ¥æ§åˆ¶ProducerSequenceå‘èµ·å›¾ç‰‡åŠ è½½å’Œå¤„ç†æµç¨‹çš„ã€‚ DraweeControllerå‘èµ·å›¾ç‰‡åŠ è½½è¯·æ±‚çš„æ–¹æ³•æ˜¯(AbstractDraweeController.java): 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970protected void submitRequest() { final T closeableImage = getCachedImage(); //ä»mImagePipeline.getBitmapMemoryCache()ä¸­å¯»æ‰¾å†…å­˜ï¼ˆè§£ç åï¼‰æ˜¯å¦å­˜åœ¨ if(closeableImage != null) { //å¤„ç†è·å–å›¾åƒç»“æœ onNewResultInternal(mId, mDataSource, closeableImage, 1.0f, true, true, true); } mDataSource = getDataSource(); final DataSubscriber&lt;T&gt; dataSubscriber = new BaseDataSubscriber&lt;T&gt;() { //å¯ä»¥ç®€å•çš„æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªç›‘å¬è€… @Override public void onNewResultImpl(DataSource&lt;T&gt; dataSource) { //å›¾ç‰‡åŠ è½½å›è°ƒ boolean isFinished = dataSource.isFinished(); boolean hasMultipleResults = dataSource.hasMultipleResults(); float progress = dataSource.getProgress(); T image = dataSource.getResult(); if (image != null) { //åŠ è½½æˆåŠŸï¼Œå¤„ç†å›¾åƒç»“æœ onNewResultInternal( id, dataSource, image, progress, isFinished, wasImmediate, hasMultipleResults); } else if (isFinished){ //å¤„ç†å¤±è´¥ onFailureInternal(id, dataSource, new NullPointerException(), /* isFinished */ true); } } ... }; ... mDataSource.subscribe(dataSubscriber, mUiThreadImmediateExecutor); //mUiThreadImmediateExecutoræ˜¯æŒ‡ dataSubscriber å›è°ƒæ–¹æ³•è¿è¡Œçš„çº¿ç¨‹ï¼Œè¿™é‡Œæ˜¯ä¸»çº¿ç¨‹}private void onNewResultInternal( String id, DataSource&lt;T&gt; dataSource, @Nullable T image, float progress, boolean isFinished, boolean wasImmediate, boolean deliverTempResult) { // create drawable Drawable drawable; try { drawable = createDrawable(image); } catch (Exception exception) { ... return; } T previousImage = mFetchedImage; Drawable previousDrawable = mDrawable; mFetchedImage = image; mDrawable = drawable; try { // set the new image if (isFinished) { //å®ŒæˆåŠ è½½ï¼Œè®¾ç½®Hierarchyï¼ˆViewå±‚ï¼‰å›¾å±‚ï¼Œå¹¶ç”±controllerç›‘å¬å™¨å›è°ƒåˆ‡æ¢å›¾å±‚ mSettableDraweeHierarchy.setImage(drawable, 1f, wasImmediate); getControllerListener().onFinalImageSet(id, getImageInfo(image), getAnimatable()); } else if (deliverTempResult) { ... } else { ... } } finally { //é‡Šæ”¾å›¾åƒèµ„æº ... releaseDrawable(previousDrawable); ... releaseImage(previousImage); } } é‚£DataSourceæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ getDataSource()æœ€ç»ˆä¼šè°ƒç”¨åˆ°: ImagePipeline.java 12345678910111213141516public DataSource&lt;CloseableReference&lt;CloseableImage&gt;&gt; fetchDecodedImage(ImageRequest imageRequest,...) { //è·å–åŠ è½½å›¾ç‰‡çš„ProducerSequence Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; producerSequence = mProducerSequenceFactory.getDecodedImageProducerSequence(imageRequest); return submitFetchRequest( producerSequence, imageRequest, lowestPermittedRequestLevelOnSubmit, callerContext, requestListener);}private &lt;T&gt; DataSource&lt;CloseableReference&lt;T&gt;&gt; submitFetchRequest(...) { ... return CloseableProducerToDataSourceAdapter.create(producerSequence, settableProducerContext, finalRequestListener);} æ‰€ä»¥DraweeControlleræœ€ç»ˆæ‹¿åˆ°çš„DataSourceæ˜¯CloseableProducerToDataSourceAdapterã€‚è¿™ä¸ªç±»åœ¨æ„é€ çš„æ—¶å€™å°±ä¼šå¯åŠ¨å›¾ç‰‡åŠ è½½æµç¨‹(å®ƒçš„æ„é€ æ–¹æ³•ä¼šè°ƒç”¨producer.produceResults(...),è¿™ä¸ªæ–¹æ³•å°±æ˜¯å›¾ç‰‡åŠ è½½çš„èµ·ç‚¹ï¼Œæˆ‘ä»¬åé¢å†çœ‹)ã€‚ DataSourceå°ç»“ Frescoä¸­DataSourceçš„æ¦‚å¿µä»¥åŠä½œç”¨:åœ¨Frescoä¸­DraweeControlleræ¯å‘èµ·ä¸€æ¬¡å›¾ç‰‡åŠ è½½å°±ä¼šåˆ›å»ºä¸€ä¸ªDataSource,è¿™ä¸ªDataSourceç”¨æ¥æä¾›è¿™æ¬¡è¯·æ±‚çš„æ•°æ®(å›¾ç‰‡)ã€‚DataSourceåªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œè‡³äºå…·ä½“çš„åŠ è½½æµç¨‹Frescoæ˜¯é€šè¿‡ProducerSequenceæ¥å®ç°çš„ã€‚ Cå±‚æ›´å…·ä½“çš„ProducerSequenceæ€ä¹ˆå®ç°ä¸‹è½½ã€è§£ç ã€ç¼“å­˜çš„ä¸‹é¢å°†è¿›ä¸€æ­¥è¯´æ˜ï¼š ProducerSequenceImagePipelineè·å–å›¾ç‰‡æ—¶ï¼Œä¼šæ ¹æ®ä¸åŒçš„è¯·æ±‚ï¼ˆè·å–è§£ç å›¾ç‰‡ï¼šfetchDecodedImageï¼Œæˆ–è€…è·å–æœªè§£ç å›¾ç‰‡ï¼šfetchEncodedImageï¼‰ç”Ÿæˆä¸åŒçš„Producer Sequenceï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªProduceré“¾æ¡ï¼Œæ¯ä¸ªProduceråªè´Ÿè´£æ•´ä¸ªé“¾æ¡ä¸­çš„ä¸€ç¯ï¼Œä¾‹å¦‚ï¼šNetworkFetchProducerè´Ÿè´£ä¸‹è½½å›¾ç‰‡ï¼ŒDecodeProducerè´Ÿè´£è§£ç å›¾ç‰‡ç­‰ã€‚ Producerçš„ä½œç”¨:ä¸€ä¸ªProducerç”¨æ¥å¤„ç†æ•´ä¸ªFrescoå›¾ç‰‡å¤„ç†æµç¨‹ä¸­çš„ä¸€æ­¥ï¼Œæ¯”å¦‚ä»ç½‘ç»œè·å–å›¾ç‰‡ã€å†…å­˜è·å–å›¾ç‰‡ã€è§£ç å›¾ç‰‡ç­‰ç­‰ï¼Œè€ŒConsumerå¯ä»¥æŠŠå®ƒç†è§£ä¸ºç›‘å¬è€…ã€‚ Producerçš„å¤„ç†ç»“æœå¯ä»¥é€šè¿‡Consumeræ¥å‘Šè¯‰å¤–ç•Œï¼Œæ¯”å¦‚æ˜¯å¤±è´¥è¿˜æ˜¯æˆåŠŸã€‚ ä¸€ä¸ªProducerAå¯ä»¥æ¥æ”¶å¦ä¸€ä¸ªProducerBä½œä¸ºå‚æ•°ï¼Œå¦‚æœProducerAå¤„ç†å®Œæ¯•åå¯ä»¥è°ƒç”¨ProducerBæ¥ç»§ç»­å¤„ç†ã€‚å¹¶ä¼ å…¥Consumeræ¥è§‚å¯ŸProducerBçš„å¤„ç†ç»“æœã€‚æ¯”å¦‚Frescoåœ¨åŠ è½½å›¾ç‰‡æ—¶ä¼šå…ˆå»å†…å­˜ç¼“å­˜è·å–ï¼Œå¦‚æœå†…å­˜ç¼“å­˜ä¸­æ²¡æœ‰é‚£ä¹ˆå°±ç½‘ç»œåŠ è½½ã€‚è¿™é‡Œæ¶‰åŠåˆ°ä¸¤ä¸ªProduceråˆ†åˆ«æ˜¯BitmapMemoryCacheProducerå’ŒNetworkFetchProducerï¼Œå‡è®¾BitmapMemoryCacheProducerä¸ºProducerAï¼ŒNetworkFetchProducerä¸ºProducerBã€‚ è§é™„å½•ï¼šå®Œæ•´ProducerSequenceï¼› è¿™å¼ å›¾æè¿°äº†Frescoåœ¨ç¬¬ä¸€æ¬¡ç½‘ç»œå›¾ç‰‡æ—¶æ‰€ç»å†çš„è¿‡ç¨‹ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¶‰åŠåˆ°ç¼“å­˜çš„Producerå…±æœ‰4ä¸ª:BitmapMemroyCacheGetProducerã€BitmapMemoryCacheProducerã€EncodedMemoryCacheProducerå’ŒDiskCacheWriteProducerã€‚Frescoåœ¨åŠ è½½å›¾ç‰‡æ—¶ä¼šæŒ‰ç…§å›¾ä¸­ç»¿è‰²ç®­å¤´æ‰€ç¤ºä¾æ¬¡ç»è¿‡è¿™å››ä¸ªç¼“å­˜Producerï¼Œä¸€æ—¦åœ¨æŸä¸ªProducerå¾—åˆ°å›¾ç‰‡è¯·æ±‚ç»“æœï¼Œå°±ä¼šæŒ‰ç…§è“è‰²ç®­å¤´æ‰€ç¤ºæŠŠç»“æœä¾æ¬¡å›è°ƒå›æ¥ã€‚ç®€å•ä»‹ç»ä¸€ä¸‹è¿™4ä¸ªProducerçš„åŠŸèƒ½: BitmapMemroyCacheGetProducer: è¿™ä¸ªProducerä¼šå»å†…å­˜ç¼“å­˜ä¸­æ£€æŸ¥è¿™æ¬¡è¯·æ±‚æœ‰æ²¡å‘½ä¸­ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­åˆ™å°†ç¼“å­˜çš„å›¾ç‰‡ä½œä¸ºè¿™æ¬¡è¯·æ±‚ç»“æœã€‚ BitmapMemoryCacheProducer: è¿™ä¸ªProducerä¼šç›‘å¬å…¶åé¢çš„Producerçš„Resultï¼Œå¹¶æŠŠResult(CloseableImage)å­˜å…¥ç¼“å­˜ã€‚ EncodedMemoryCacheProducer: å®ƒä¹Ÿæ˜¯ä¸€ä¸ªå†…å­˜ç¼“å­˜ï¼Œä¸è¿‡å®ƒç¼“å­˜çš„æ˜¯æœªè§£ç çš„å›¾ç‰‡ï¼Œå³å›¾ç‰‡åŸå§‹å­—èŠ‚ã€‚ DiskCacheWriteProducer: é¡¾åæ€ä¹‰ï¼Œå®ƒè´Ÿè´£æŠŠå›¾ç‰‡ç¼“å­˜åˆ°ç£ç›˜ï¼Œå®ƒç¼“å­˜çš„ä¹Ÿæ˜¯æœªè§£ç çš„å›¾ç‰‡ã€‚è·å–å›¾ç‰‡æ—¶å¦‚æœå‘½ä¸­äº†ç£ç›˜ç¼“å­˜é‚£ä¹ˆå°±è¿”å›ç¼“å­˜çš„ç»“æœã€‚ è¿™é‡Œä»…ä»¥Bitmapå†…å­˜ç¼“å­˜ä¸ºä¾‹å­ï¼Œå±•å¼€è¯´æ˜PorducerSequenceä¸­å…¶ä¸­ ç£ç›˜ç¼“å­˜æˆ–å†…å­˜ç¼“å­˜ CacheProducerèŠ‚ç‚¹çš„å·¥ä½œæµç¨‹ï¼š BitmapMemroyCacheGetProduceræ´¾ç”Ÿè‡ªBitmapMemoryCacheProducer,ä¸BitmapMemoryCacheProducerçš„ä¸åŒå°±æ˜¯åªè¯»ä¸å†™è€Œå·²ã€‚ å¤§è‡´çœ‹ä¸€ä¸‹BitmapMemoryCacheProducerçš„ç¼“å­˜è¿ä½œé€»è¾‘: BitmapMemoryCacheProducer.java 1234567891011121314151617181920212223242526272829303132333435363738public class BitmapMemoryCacheProducer implements Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; { private final MemoryCache&lt;CacheKey, CloseableImage&gt; mMemoryCache; //å›¾ç‰‡ç¼“å­˜çš„å®ç° @Override public void produceResults(Consumer&lt;CloseableReference&lt;CloseableImage&gt;&gt; consumer...){ //1.å…ˆå»ç¼“å­˜ä¸­è·å– CloseableReference&lt;CloseableImage&gt; cachedReference = mMemoryCache.get(cacheKey); //2.å‘½ä¸­ç¼“å­˜ç›´æ¥è¿”å›è¯·æ±‚ç»“æœ if (cachedReference != null) { consumer.onNewResult(cachedReference, BaseConsumer.simpleStatusForIsLast(isFinal)); return; } ... //3.wrapConsumeræ¥è§‚å¯Ÿåç»­Producerçš„ç»“æœ Consumer&lt;CloseableReference&lt;CloseableImage&gt;&gt; wrappedConsumer = wrapConsumer(consumer..); //4.è®©ä¸‹ä¸€ä¸ªProducerç»§ç»­å·¥ä½œ mInputProducer.produceResults(wrappedConsumer, producerContext); } protected Consumer&lt;CloseableReference&lt;CloseableImage&gt;&gt; wrapConsumer(){ return new DelegatingConsumer&lt;...&gt;(consumer) { @Override public void onNewResultImpl(CloseableReference&lt;CloseableImage&gt; newResult...){ //5.ç¼“å­˜ç»“æœ newCachedResult = mMemoryCache.cache(cacheKey, newResult); //6.é€šçŸ¥å‰é¢çš„Producerå›¾ç‰‡è¯·æ±‚ç»“æœ getConsumer().onNewResult((newCachedResult != null) ? newCachedResult : newResult, status); } } }} å®ƒçš„ä¸»è¦æµç¨‹å›¾å¦‚ä¸‹(åé¢ä¸¤ä¸ªç¼“å­˜çš„æµç¨‹ä¸å®ƒåŸºæœ¬ç›¸åŒï¼Œå› æ­¤å¯¹äºç¼“å­˜æ•´ä½“æµç¨‹åªç”»è¿™ä¸€æ¬¡): â€‹ BitmapMemoryCacheProducerå·¥ä½œæµ.png å›¾ä¸­çº¢è‰²ç®­å¤´å’Œå­—ä½“æ˜¯æ­£å¸¸ç½‘ç»œåŠ è½½å›¾ç‰‡(ç¬¬ä¸€æ¬¡)çš„æ­¥éª¤ å†…å­˜ç¼“å­˜ : MemoryCacheMemoryCacheæ˜¯ä¸€ä¸ªæ¥å£ï¼Œåœ¨è¿™é‡Œå®ƒçš„å¯¹åº”å®ç°æ˜¯CountingMemoryCache, å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°: CountingMemoryCache.java 123456789101112131415public class CountingMemoryCache&lt;K, V&gt; implements MemoryCache&lt;K, V&gt;, MemoryTrimmable { //ç¼“å­˜çš„é›†åˆå…¶å®å°±æ˜¯ä¸€ä¸ªmapï¼Œä¸è¿‡è¿™ä¸ªmapä½¿ç”¨ Lru ç®—æ³• final CountingLruMap&lt;K, Entry&lt;K, V&gt;&gt; mExclusiveEntries; final CountingLruMap&lt;K, Entry&lt;K, V&gt;&gt; mCachedEntries; public CountingMemoryCache(ValueDescriptor&lt;V&gt; valueDescriptor,CacheTrimStrategy cacheTrimStrategy,Supplier&lt;MemoryCacheParams&gt; memoryCacheParamsSupplier) { mValueDescriptor = valueDescriptor;// ç”¨æ¥ä¼°ç®—å½“å‰ç¼“å­˜å®ä½“çš„å¤§å° mExclusiveEntries = new CountingLruMap&lt;&gt;(wrapValueDescriptor(valueDescriptor)); // ä¸»è¦å­˜æ”¾æ²¡æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œå®ƒçš„æ‰€æœ‰å…ƒç´ ä¸€å®šåœ¨ mCachedEntries é›†åˆä¸­å­˜åœ¨ mCachedEntries = new CountingLruMap&lt;&gt;(wrapValueDescriptor(valueDescriptor)); // ä¸»è¦ç¼“å­˜é›†åˆ mCacheTrimStrategy = cacheTrimStrategy; // trimç¼“å­˜çš„ç­–ç•¥ (å…¶å®å°±æ˜¯æŒ‡å®šäº†trim ratio) mMemoryCacheParams = mMemoryCacheParamsSupplier.get(); // é€šè¿‡ ImagePipelineConfig æ¥é…ç½®çš„ç¼“å­˜å‚æ•° } ...} é€šè¿‡æ„é€ å‡½æ•°å¯ä»¥çŸ¥é“CountingMemoryCacheä¸€å…±å«æœ‰ä¸¤ä¸ªç¼“å­˜é›†åˆ : mCachedEntries : å®ƒæ˜¯ç”¨æ¥å­˜æ”¾æ‰€æœ‰ç¼“å­˜å¯¹è±¡çš„é›†åˆ mExclusiveEntries: å®ƒæ˜¯ç”¨æ¥å­˜æ”¾å½“å‰æ²¡æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œåœ¨trimç¼“å­˜æ˜¯ï¼Œä¸»è¦æ˜¯trimæ‰è¿™ä¸ªç¼“å­˜é›†åˆçš„ä¸­çš„å¯¹è±¡ã€‚ CountingMemoryCacheçš„ç¼“å­˜é€»è¾‘ä¸»è¦æ˜¯å›´ç»•è¿™ä¸¤ä¸ªé›†åˆå±•å¼€çš„ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å®ƒçš„cacheå’Œgetçš„æ–¹æ³•(è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯ç¼“å­˜çš„æ ¸å¿ƒæ–¹æ³•)ã€‚ å°†å›¾ç‰‡ä¿å­˜åˆ°å†…å­˜ç¼“å­˜ : CountingMemoryCache.cache()1234567891011121314151617181920212223242526public CloseableReference&lt;V&gt; cache(K key, CloseableReference&lt;V&gt; valueRef, EntryStateObserver&lt;K&gt; observer) { Entry&lt;K, V&gt; oldExclusive; CloseableReference&lt;V&gt; oldRefToClose = null; CloseableReference&lt;V&gt; clientRef = null; synchronized (this) { oldExclusive = mExclusiveEntries.remove(key); //å¦‚æœå­˜åœ¨çš„è¯ï¼Œä»æ²¡æœ‰å¼•ç”¨çš„ç¼“å­˜é›†åˆä¸­æ¸…é™¤ Entry&lt;K, V&gt; oldEntry = mCachedEntries.remove(key); //ä»ä¸»ç¼“å­˜é›†åˆä¸­ç§»é™¤ if (oldEntry != null) { makeOrphan(oldEntry); oldRefToClose = referenceToClose(oldEntry); } if (canCacheNewValue(valueRef.get())) { //ä¼šåˆ¤æ–­æ˜¯å¦åˆ°è¾¾äº†å½“å‰ç¼“å­˜çš„æœ€å¤§å€¼ Entry&lt;K, V&gt; newEntry = Entry.of(key, valueRef, observer); // æ„é€ ä¸€ä¸ªç¼“å­˜å®ä½“(Entry) mCachedEntries.put(key, newEntry); //ç¼“å­˜ clientRef = newClientReference(newEntry); } } CloseableReference.closeSafely(oldRefToClose); //å¯èƒ½ä¼šè°ƒç”¨åˆ° release æ–¹æ³•ï¼Œ ... return clientRef;} ä¸Šé¢ä»£ç æˆ‘åšäº†æ¯”è¾ƒè¯¦ç»†çš„æ³¨é‡Šã€‚ç®€å•çš„è®²å°±æ˜¯æŠŠè¿™ä¸ªå¯¹è±¡æ”¾å…¥åˆ°mCachedEntriesé›†åˆä¸­ï¼Œå¦‚æœåŸæ¥å°±å·²ç»ç¼“å­˜äº†è¿™ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆå°±è¦æŠŠå®ƒå…ˆä»mCachedEntrieså’ŒmExclusiveEntriesé›†åˆä¸­ç§»é™¤ã€‚ Frescoçš„é»˜è®¤å†…å­˜ç¼“å­˜å¤§å°ä¸Šé¢canCacheNewValue()æ˜¯ç”¨æ¥åˆ¤æ–­å½“å‰ç¼“å­˜æ˜¯å¦å·²ç»è¾¾åˆ°äº†æœ€å¤§å€¼ã€‚é‚£Frescoå†…å­˜ç¼“å­˜çš„æœ€å¤§å€¼æ˜¯å¤šå°‘å‘¢ï¼Ÿè¿™ä¸ªå€¼å¯ä»¥é€šè¿‡ImagePipelineConfigæ¥é…ç½®ï¼Œå¦‚æœæ²¡æœ‰é…ç½®çš„è¯é»˜è®¤é…ç½®æ˜¯:DefaultBitmapMemoryCacheParamsSupplier: DefaultBitmapMemoryCacheParamsSupplier.java 123456789101112131415161718public class DefaultBitmapMemoryCacheParamsSupplier implements Supplier&lt;MemoryCacheParams&gt; { ... private int getMaxCacheSize() { final int maxMemory = Math.min(mActivityManager.getMemoryClass() * ByteConstants.MB, Integer.MAX_VALUE); if (maxMemory &lt; 32 * ByteConstants.MB) { return 4 * ByteConstants.MB; } else if (maxMemory &lt; 64 * ByteConstants.MB) { return 6 * ByteConstants.MB; } else { if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB) { return 8 * ByteConstants.MB; } else { return maxMemory / 4; } } }} å³Frescoçš„é»˜è®¤ç¼“å­˜å¤§å°æ˜¯æ ¹æ®å½“å‰åº”ç”¨çš„è¿è¡Œå†…å­˜æ¥å†³å®šçš„ï¼Œå¯¹äºåº”ç”¨è¿è¡Œå†…å­˜è¾¾åˆ°64MBä»¥ä¸Šçš„æ‰‹æœº(ç°åœ¨çš„æ‰‹æœºæ™®éå·²ç»å¤§äºè¿™ä¸ªå€¼äº†)ï¼ŒFrescoçš„é»˜è®¤ç¼“å­˜å¤§å°æ˜¯maxMemory / 4 ä»å†…å­˜ç¼“å­˜ä¸­è·å–å›¾ç‰‡ : CountingMemoryCache.get()ç¼“å­˜è·å–çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•: CountingMemoryCache.java 123456789101112131415public CloseableReference&lt;V&gt; get(final K key) {Entry&lt;K, V&gt; oldExclusive; CloseableReference&lt;V&gt; clientRef = null; synchronized (this) { oldExclusive = mExclusiveEntries.remove(key); Entry&lt;K, V&gt; entry = mCachedEntries.get(key); if (entry != null) { clientRef = newClientReference(entry); } } maybeNotifyExclusiveEntryRemoval(oldExclusive); maybeUpdateCacheParams(); maybeEvictEntries(); return clientRef;} å³ä»mCachedEntriesé›†åˆä¸­è·å–ï¼Œå¦‚æœmExclusiveEntriesé›†åˆä¸­å­˜åœ¨çš„è¯å°±ç§»é™¤ã€‚ trimç­–ç•¥ : CountingMemoryCache.getrimt()å½“å†…å­˜ç¼“å­˜è¾¾åˆ°å³°å€¼æˆ–ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶å°±éœ€è¦å¯¹å½“å‰çš„å†…å­˜ç¼“å­˜åštrimæ“ä½œ, trimæ—¶æ˜¯åŸºäºLruç®—æ³•çš„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„å…·ä½“é€»è¾‘: 1234567891011public void trim(MemoryTrimType trimType) { ArrayList&lt;Entry&lt;K, V&gt;&gt; oldEntries; //æ ¹æ®å½“å‰çš„åº”ç”¨çŠ¶æ€æ¥ç¡®å®štrim ratioã€‚ åº”ç”¨çŠ¶æ€æ˜¯æŒ‡: åº”ç”¨å¤„äºå‰å°ã€åå°ç­‰ç­‰ final double trimRatio = mCacheTrimStrategy.getTrimRatio(trimType); ... int targetCacheSize = (int) (mCachedEntries.getSizeInBytes() * (1 - trimRatio)); // trimåˆ°å½“å‰ç¼“å­˜çš„å¤šå°‘ int targetEvictionQueueSize = Math.max(0, targetCacheSize - getInUseSizeInBytes()); // åˆ°åº•èƒ½trimå¤šå¤§ oldEntries = trimExclusivelyOwnedEntries(Integer.MAX_VALUE, targetEvictionQueueSize); //trim mExclusiveEntriesé›†åˆ é›†åˆä¸­çš„å¯¹è±¡ makeOrphans(oldEntries); ...} trimæ“ä½œçš„ä¸»è¦æ­¥éª¤æ˜¯: æ ¹æ®å½“å‰åº”ç”¨çš„çŠ¶æ€å†³å®štrim ratio (åº”ç”¨çŠ¶æ€æ˜¯æŒ‡åº”ç”¨å¤„äºå‰å°ã€åå°ç­‰ç­‰)ã€‚ æ ¹æ®trim ratioæ¥ç®—å‡ºç»è¿‡trimåç¼“å­˜çš„å¤§å°targetCacheSize æ ¹æ®mExclusiveEntriesé›†åˆçš„å¤§å°æ¥å†³å®šåˆ°åº•èƒ½trimå¤šå°‘ (èƒ½trimçš„æœ€å¤§å°±æ˜¯mExclusiveEntries.size) å¯¹mExclusiveEntriesé›†åˆåštrimæ“ä½œï¼Œå³ç§»é™¤å…¶ä¸­çš„å…ƒç´ ã€‚ å³trimæ—¶æœ€å¤§èƒ½trimæ‰çš„å¤§å°æ˜¯mExclusiveEntriesé›†åˆçš„å¤§å°ã€‚æ‰€ä»¥å¦‚æœå½“å‰åº”ç”¨å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œå¯¼è‡´mExclusiveEntriesä¸­çš„å…ƒç´ å¾ˆå°‘ï¼Œé‚£ä¹ˆtrimæ“ä½œå‡ ä¹æ˜¯æ²¡æœ‰æ•ˆæœçš„ã€‚ ç¼–ç å†…å­˜ç¼“å­˜ : EncodedMemoryCacheProducerè¿™ä¸ªç¼“å­˜Producerçš„å·¥ä½œé€»è¾‘å’ŒBitmapMemoryCacheProducerç›¸åŒ,ä¸åŒçš„æ˜¯å®ƒç¼“å­˜çš„å¯¹è±¡: 12345public class EncodedMemoryCacheProducer implements Producer&lt;EncodedImage&gt; { private final MemoryCache&lt;CacheKey, PooledByteBuffer&gt; mMemoryCache; ...} å³å®ƒç¼“å­˜çš„æ˜¯PooledByteBuffer, å®ƒæ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢? å®ƒç‰µæ‰¯åˆ°Frescoç¼–ç å›¾ç‰‡çš„å†…å­˜ç®¡ç†ï¼Œè¿™äº›å†…å®¹æˆ‘ä¼šå•å¼€ä¸€ç¯‡æ–‡ç« æ¥è®²ä¸€ä¸‹ã€‚è¿™é‡Œå°±å…ˆä¸è¯´äº†ã€‚PooledByteBufferä½ å¯ä»¥ç®€å•çš„æŠŠå®ƒå½“æˆä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚ ç£ç›˜ç¼“å­˜ : DiskCacheWriteProducerå®ƒæ˜¯Frescoå›¾ç‰‡ç£ç›˜ç¼“å­˜çš„é€»è¾‘ç®¡ç†è€…ï¼Œæ•´ä¸ªç¼“å­˜é€»è¾‘å’ŒBitmapMemoryCacheProducerå·®ä¸å¤š: 123456789101112public class DiskCacheWriteProducer implements Producer&lt;EncodedImage&gt; { private final BufferedDiskCache mDefaultBufferedDiskCache; / ... private static class DiskCacheWriteConsumer extends DelegatingConsumer&lt;EncodedImage, EncodedImage&gt; { @Override public void onNewResultImpl(EncodedImage newResult, @Status int status) { ... mDefaultBufferedDiskCache.put(cacheKey, newResult); } }} æ¥ä¸‹æ¥æˆ‘ä»¬ä¸»è¦çœ‹ä¸€ä¸‹å®ƒçš„ç£ç›˜å­˜å‚¨é€»è¾‘(æ€ä¹ˆå­˜), å¯¹äºå­˜å‚¨é€»è¾‘æ˜¯ç”±BufferedDiskCacheæ¥è´Ÿè´£çš„: BufferedDiskCacheå…ˆæ¥çœ‹ä¸€ä¸‹ç±»çš„ç»„æˆç»“æ„: 12345public class BufferedDiskCache { private final FileCache mFileCache; // æ–‡ä»¶å­˜å‚¨çš„å®ç° private final Executor mWriteExecutor; //å­˜å‚¨æ–‡ä»¶æ—¶çš„çº¿ç¨‹ private final StagingArea mStagingArea; } FileCache : å°†EncodeImageä¿å­˜åˆ°ç£ç›˜å­˜å‚¨å®ç°ã€‚ Executor : æŒ‡å®šæ–‡ä»¶ä¿å­˜æ“ä½œæ‰€è¿è¡Œçš„çº¿ç¨‹ã€‚ StagingArea: ç±»ä¼¼äºgitä¸­çš„stageæ¦‚å¿µ,å®ƒæ˜¯ä¸€ä¸ªmap,ç”¨äºä¿å­˜å½“å‰æ­£åœ¨è¿›è¡Œç£ç›˜ç¼“å­˜æ“ä½œã€‚ å°†å›¾ç‰‡ä¿å­˜è‡³ç£ç›˜ : BufferedDiskCache.put()è¿™ä¸ªæ–¹æ³•ä¸»è¦è´Ÿè´£å¾€ç£ç›˜ç¼“å­˜ä¸€å¼ å›¾ç‰‡: 1234567891011121314151617181920public void put(final CacheKey key, EncodedImage encodedImage) { .. mStagingArea.put(key, encodedImage); //æŠŠè¿™æ¬¡ç¼“å­˜æ“ä½œæ”¾åˆ°æš‚å­˜åŒº ... final EncodedImage finalEncodedImage = EncodedImage.cloneOrNull(encodedImage); mWriteExecutor.execute( //å¼€å¯å†™å…¥çº¿ç¨‹ new Runnable() { @Override public void run() { try { writeToDiskCache(key, finalEncodedImage); //å†™å…¥åˆ°ç£ç›˜ } finally { mStagingArea.remove(key, finalEncodedImage); //ä»æ“ä½œæš‚å­˜åŒºä¸­ç§»é™¤è¿™æ¬¡æ“ä½œ EncodedImage.closeSafely(finalEncodedImage); } } }); } ...} writeToDiskCache()ä¸»è¦è°ƒç”¨mFileCache.insert()æ¥æŠŠå›¾ç‰‡ä¿å­˜åˆ°ç£ç›˜: 1234567mFileCache.insert(key, new WriterCallback() { @Override public void write(OutputStream os) throws IOException { mPooledByteStreams.copy(encodedImage.getInputStream(), os); //å®é™…ä¸Šå°±æ˜¯æŠŠencodeImage å†™å…¥åˆ° os(OutputStream) ä¸­ } }); è‡³äºmFileCache.insert()çš„å…·ä½“å®ç°æ¶‰åŠçš„æºç è¾ƒå¤šï¼Œè€ƒè™‘æ–‡ç« ç¯‡å¹…çš„åŸå› è¿™é‡Œæˆ‘ä¸å»å…·ä½“è·Ÿäº†ã€‚ç®€å•çš„æ€»ç»“ä¸€ä¸‹å…¶å®ç°æ­¥éª¤å’Œä¸€äº›å…³é”®ç‚¹: Step1 : ç”ŸæˆResourceIdè¿™ä¸ªResourceIdå¯ä»¥ç®€å•çš„ç†è§£ä¸ºç¼“å­˜æ–‡ä»¶çš„æ–‡ä»¶åï¼Œå®ƒçš„ç”Ÿæˆç®—æ³•å¦‚ä¸‹: 1SecureHashUtil.makeSHA1HashBase64(key.getUriString().getBytes(&quot;UTF-8&quot;)); // keyå°±æ˜¯CacheKey å³SHA-1 + Base64ã€‚ Step2 : åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œå¹¶æŠŠå›¾ç‰‡å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ åˆ›å»ºä¸´æ—¶æ–‡ä»¶ 123public File createTempFile(File parent) throws IOException { return File.createTempFile(resourceId + &quot;.&quot;, TEMP_FILE_EXTENSION, parent);} æŠŠå›¾ç‰‡å†™å…¥åˆ°è¿™ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ : DefaultDiskStorage.java 123456public void writeData(WriterCallback callback, Object debugInfo) throws IOException { FileOutputStream fileStream = new FileOutputStream(mTemporaryFile); ... CountingOutputStream countingStream = new CountingOutputStream(fileStream); callback.write(countingStream); countingStream.flush(); è¿™é‡Œçš„callback(WriterCallback)å°±æ˜¯mFileCache.insert()æ–¹æ³•ä¼ å…¥çš„é‚£ä¸ªcallback -&gt; { mPooledByteStreams.copy(encodedImage.getInputStream(), os); } Step3 : æŠŠä¸´æ—¶æ–‡ä»¶é‡å‘½åä¸ºresourceIdStep4 : è®¾ç½®å¥½æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´ä»ç£ç›˜ä¸­è·å–æ–‡ä»¶ : BufferedDiskCache.get()è¯»å°±æ˜¯å†™çš„é€†æ“ä½œï¼Œè¿™é‡Œä¸åšå…·ä½“åˆ†æäº†ã€‚ AttentionFresco KeyMemoryCacheKeyè§£ç å†…å­˜ç¼“å­˜æ—¶ç”±CountingMemoryCacheç±»çœŸæ­£å®ç°ï¼Œå†…éƒ¨ç»´æŠ¤CountingLruMap (å†…ä¸ºLinkedHashMap)ï¼Œvalueä¸ºCountingMemoryCache$Entry (æŒæœ‰CloseableReference-&gt;Bitmap)ã€‚ keyä¸ºï¼ˆå†…å­˜ç¼“å­˜CacheKeyå­ç±» BitmapMemoryCacheKey ï¼‰ï¼šå¯¹äºå†…å­˜çš„ç¼“å­˜ï¼Œfrescoæ ¹æ® Uriå­—ç¬¦ä¸²ã€ç¼©æ”¾å°ºå¯¸ã€è§£ç å‚æ•°ã€PostProcessorç­‰å…³é”®å‚æ•°è¿›è¡ŒhashCode ç”Ÿæˆç¼“å­˜keyæ¥ç¼“å­˜bitmap EncodeImageKeyæœªè§£ç å†…å­˜ç¼“å­˜ä¹Ÿç”±CountingMemoryCacheç±»çœŸæ­£å®ç°ï¼Œå†…éƒ¨ç»´æŠ¤CountingLruMap (å†…ä¸ºLinkedHashMap)ï¼Œvalueä¸º CountingMemoryCache$Entry (çœŸæ­£æŒæœ‰æ˜¯MemoryPooledByteBuffer-&gt;NativeMemoryChunk) Keyä¸ºé»˜è®¤å®ç°æ˜¯SimpleCacheKeyï¼šå‚æ•°åªæœ‰å›¾ç‰‡Uri DiskCacheKeyï¼šç”Ÿæˆå›ºå®šçš„ç¼“å­˜å›¾ç‰‡ç›®å½•ï¼Œç›´æ¥æŠŠå›¾ç‰‡Uriå“ˆå¸Œ1åbase64åŠ å¯†ä½œä¸ºæ–‡ä»¶åï¼Œgetæ—¶å°±ç›´æ¥â€åˆ¤æ–­è·¯å¾„+hash1base64 â€œæ˜¯å¦å­˜åœ¨ ç¼“å­˜å¤§å° å†…å­˜ç¼“å­˜ä¸€èˆ¬æ˜¯ å››åˆ†ä¹‹ä¸€ ActivityManager.getMemoryClass æœªè§£ç çš„å›¾ç‰‡ç¼“å­˜ä¸€èˆ¬æ˜¯ 4MB ç£ç›˜ç¼“å­˜ä¸€èˆ¬æ˜¯ 40MB ç”Ÿå‘½å‘¨æœŸè·å–é€šè¿‡DraweeViewçš„onAttachedToWindow()å’ŒonDetachedFromWindow()æ—¶attachController()å’ŒdetachController()ï¼ŒcontrolleræŒæœ‰hierarchyï¼Œæ‰€ä»¥ä¹Ÿä¼šé‡Šæ”¾æ‰hierarchyã€‚ DecodeProducer - Gif Decode*è§£ç ä¼šæ ¹æ®ä¸ºè§£ç çš„å›¾ç‰‡æ ¼å¼ï¼Œé€‰æ‹©ä¸åŒçš„è§£ç å™¨(PNG/JPEG/GIF/WEBP)*ï¼Œæ­¤å¤„ä»…ä»¥Gifå›¾decodeä¸ºåˆ†æå¯¹è±¡ï¼ˆç½‘ç»œæ‹‰å–gifã€è§£ç ã€ç¼“å­˜ï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940//ImagePipeline.javapublic DataSource&lt;CloseableReference&lt;CloseableImage&gt;&gt; fetchDecodedImage( ImageRequest imageRequest, Object callerContext, ImageRequest.RequestLevel lowestPermittedRequestLevelOnSubmit, @Nullable RequestListener requestListener, @Nullable String uiComponentId) { try { //ç”Ÿäº§è€…åºåˆ—å·¥å‚ è·å– ä¸‹è½½ã€ç¼“å­˜ã€è§£ç å›¾ç‰‡çš„ç”Ÿäº§è€…åºåˆ— Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; producerSequence = mProducerSequenceFactory.getDecodedImageProducerSequence(imageRequest); //å°è£…åˆ°DataSorceä¸­å¤„ç† return submitFetchRequest( producerSequence, imageRequest, lowestPermittedRequestLevelOnSubmit, callerContext, requestListener, uiComponentId); } catch (Exception exception) { return DataSources.immediateFailedDataSource(exception); }}//mProducerSequenceFactory.getDecodedImageProducerSequence è°ƒç”¨çš„æ˜¯getBasicDecodedImageSequence//ProducerSequenceFactory.class//ProducerSequenceFactory.getBasicDecodedImageSequence æ–¹æ³•ä¸­ä¼šæ ¹æ®imageRequestçš„uriçš„SCHEMEï¼ˆhttp/httpsã€fileç­‰ï¼‰é€‰æ‹©åˆé€‚çš„ç”Ÿäº§è€…åºåˆ—å·¥å‚ã€‚æ­¤å¤„ä»¥ç»å…¸çš„httpsä¸ºä¾‹ï¼Œè¿”å›çš„æ˜¯ï¼šç½‘ç»œæ‹‰å–åºåˆ—å•ä¾‹mNetworkFetchSequence = newBitmapCacheGetToDecodeSequence(getCommonNetworkFetchToEncodedMemorySequence());//getCommonNetworkFetchToEncodedMemorySequenceè´Ÿè´£ï¼š multiplex -&gt; encoded cache -&gt; disk cache -&gt; (webp transcode) -&gt; network fetch. //newBitmapCacheGetToDecodeSequenceè¿½åŠ produceråï¼š bitmap cache get -&gt; background thread hand-off -&gt; multiplex -&gt; bitmap cache -&gt; decode -&gt; multiplex -&gt; encoded cache -&gt; disk cache -&gt; (webp transcode) -&gt; network fetch. æ¯ä¸€å±‚ç”Ÿäº§è€…è´Ÿè´£å„è‡ªçš„è´£ä»»ï¼Œè¿™é‡Œå…·ä½“åˆ†æè´Ÿè´£decodeçš„DecodeProducerã€‚ 1234567891011121314151617//ProducerSequenceFactory.BitmapCacheGetToDecodeSequence()DecodeProducer decodeProducer = mProducerFactory.newDecodeProducer(inputProducer);//ProducerFactory.classpublic DecodeProducer newDecodeProducer(Producer&lt;EncodedImage&gt; inputProducer) { return new DecodeProducer( mByteArrayPool, mExecutorSupplier.forDecode(), mImageDecoder, //ï¼ï¼å°±æ˜¯è¿™é‡Œä¼ å…¥çš„è§£ç å™¨ mProgressiveJpegConfig, mDownsampleEnabled, mResizeAndRotateEnabledForNetwork, mDecodeCancellationEnabled, inputProducer, mMaxBitmapSize, mCloseableReferenceFactory); } ä¸‹é¢åˆ†æmImageDecoderåˆ›å»ºæ¥æº: imageDecoderçš„åˆ›å»ºç®€è¿°ï¼šå°±æ˜¯æ„é€ ä¸€ä¸ªå•ä¾‹çš„åŒ¿åå†…éƒ¨ImageDecoderç±»ï¼Œå…¶ä¸­æ–¹æ³•decodeGif()å…·ä½“é€šè¿‡AnimatedImageFactoryImplçš„åŒåæ–¹æ³•å®ç°ã€‚ é¦–å…ˆæ˜¯ProducerFactoryçš„æ„å»ºæ—¶å°±è°ƒç”¨getImageDecoderåˆ›å»ºImageDecodeå•ä¾‹å¹¶å…¥å‚ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738ImagePipelineFactory.class private ProducerFactory getProducerFactory() { if (mProducerFactory == null) { mProducerFactory = mConfig .getExperiments() .getProducerFactoryMethod() .createProducerFactory( mConfig.getContext(), mConfig.getPoolFactory().getSmallByteArrayPool(), getImageDecoder(), //... } return mProducerFactory; } private ImageDecoder getImageDecoder() { if (mImageDecoder == null) { if (mConfig.getImageDecoder() != null) { mImageDecoder = mConfig.getImageDecoder(); } else { /*getAnimatedFactory()åˆ©ç”¨AnimatedFactoryProviderä»¥åå°„æ–¹å¼å®ä¾‹åŒ–AnimatedFactoryV2Implå¹¶è¿”å›*/ final AnimatedFactory animatedFactory = getAnimatedFactory(); ImageDecoder gifDecoder = null; ImageDecoder webPDecoder = null; if (animatedFactory != null) { gifDecoder = animatedFactory.getGifDecoder(mConfig.getBitmapConfig()); webPDecoder = animatedFactory.getWebPDecoder(mConfig.getBitmapConfig()); } //... return mImageDecoder;} 123456789101112131415161718192021222324252627282930313233343536373839404142AnimatedFactoryV2Impl implements AnimatedFactory//AnimatedFactoryV2Impl.class//AnimatedFactoryV2Impl.getGifDeocder()ä¸­ç›´æ¥è¿”å›ï¼š//ç”±AnimatedFactoryV2Impl.getAnimatedImageFactory().decodeGif()å®ç°è§£ç çš„åŒ¿åå†…éƒ¨ç±»ImageDecoderå®ä¾‹;å…¶ä¸­getAnimatedIamgeFractory()è¿”å›AnimatedImageFactoryImplå•ä¾‹ã€‚ public ImageDecoder getGifDecoder(final Bitmap.Config bitmapConfig) { return new ImageDecoder() { @Override public CloseableImage decode( EncodedImage encodedImage, int length, QualityInfo qualityInfo, ImageDecodeOptions options) { return getAnimatedImageFactory().decodeGif(encodedImage, options, bitmapConfig); } }; } private AnimatedImageFactory getAnimatedImageFactory() { if (mAnimatedImageFactory == null) { mAnimatedImageFactory = buildAnimatedImageFactory(); } return mAnimatedImageFactory; } private AnimatedImageFactory buildAnimatedImageFactory() { AnimatedDrawableBackendProvider animatedDrawableBackendProvider = new AnimatedDrawableBackendProvider() { @Override public AnimatedDrawableBackend get(AnimatedImageResult imageResult, Rect bounds) { return new AnimatedDrawableBackendImpl( getAnimatedDrawableUtil(), imageResult, bounds, mDownscaleFrameToDrawableDimensions); } }; return new AnimatedImageFactoryImpl(animatedDrawableBackendProvider, mPlatformBitmapFactory); } encodeImageçš„decodeè¿‡ç¨‹ç®€è¿°ï¼šå…ˆå°†æœªè§£ç å›¾åƒä¸­è§£æå‡ºgifçš„å…ƒæ•°æ®ï¼Œå°è£… gifå…ƒæ•°æ®ï¼ˆå¸§æ•°ã€é—´éš”ã€å¾ªç¯æ¬¡æ•°ç­‰ï¼‰ ä¸ æœªè§£ç å›¾åƒå­—èŠ‚æ•°ç»„ä¸º AnimatedImageï¼ˆGifImageï¼‰ã€‚ é€šè¿‡getCloseableImageï¼ˆï¼‰æ ¹æ®optioné…ç½®å°†ä¸Šè¿°AnimatedImageï¼ˆGifImageï¼‰ä¼ å…¥è¿›ä¸€æ­¥è§£æï¼Œ å³å°† AnimatedImageï¼ˆGifImageï¼‰ä¸­çš„æœªè§£ç å­—èŠ‚æ•°ç»„ è¿›ä¸€æ­¥è§£æï¼Œ å°†AnimatedImageï¼ˆGifImageï¼‰ã€é¢„è§ˆå›¾(maybe null)ã€é¢„è§ˆå¸§(maybe null)ã€æ‰€æœ‰å¸§åˆ—è¡¨ï¼ˆå¦‚æœæ‰“å¼€äº†options.decodeAllFrames,maybe nullï¼‰ï¼Œå°è£…æˆAnimatedImageResultã€‚ æœ€å GifImageåœ¨AnimatedDrawable2.draw æ¸²æŸ“æ—¶å†è¿›ä¸€æ­¥decodeå‡ºéœ€è¦çš„å¸§ï¼ˆGifFrameï¼‰ è‡³äºæåˆ°çš„ æœªè§£ç å­—èŠ‚æ•°ç»„ è§£ææˆå¸§çš„è¿‡ç¨‹ï¼Œæ˜¯é€šè¿‡GifImageç±»å®ä¾‹sGifAnimatedImageDecoderï¼Œé€šè¿‡Nativeè§£ç ï¼Œä¸»è¦æ˜¯å€ŸåŠ©giflibåº“åœ¨Nativeå±‚è¿›è¡Œè§£ç ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243//å¤§è‡´å°±æ˜¯ä¸ªä¸­é—´å±‚è°ƒç”¨AnimatedImageFactoryImplè§£æencodeImageæˆCloseableImageAnimatedImageFactoryImpl implements AnimatedImageFactory{ static { sGifAnimatedImageDecoder = loadIfPresent(&quot;com.facebook.animated.gif.GifImage&quot;); sWebpAnimatedImageDecoder = loadIfPresent(&quot;com.facebook.animated.webp.WebPImage&quot;); }//å°†encodeImageï¼ˆæœªè§£ç çš„å›¾åƒï¼ŒåŒ…æ‹¬æœªè§£ç å­—èŠ‚ä¸å…ƒæ•°æ®çš„nativeå­—èŠ‚æ•°ç»„ï¼‰è§£ææˆCloseableImageï¼ˆè§£æå…ƒæ•°æ®åçš„å›¾åƒä¿¡æ¯ï¼‰//GifImageå°±ä»£è¡¨ä¸€ä¸ªGIFï¼Œè¿™é‡Œåªä¼šè§£æå‡ºGIFçš„å…ƒæ•°æ®ï¼Œä¸ä¼šçœŸæ­£è§£ç GIFå¸§ public CloseableImage decodeGif( final EncodedImage encodedImage, final ImageDecodeOptions options, final Bitmap.Config bitmapConfig) { if (sGifAnimatedImageDecoder == null) { throw new UnsupportedOperationException( &quot;To encode animated gif please add the dependency &quot; + &quot;to the animated-gif module&quot;); } final CloseableReference&lt;PooledByteBuffer&gt; bytesRef = encodedImage.getByteBufferRef(); Preconditions.checkNotNull(bytesRef); try { final PooledByteBuffer input = bytesRef.get(); /*AnimateImageï¼šGifçš„è¡¨ç¤ºï¼Œå…·ä½“å®ç°ä¸ºGifImageï¼Œ è¯¥ç±»çš„å®ä¾‹å°†åœ¨å†…å­˜ä¸­ä¿å­˜æœªè§£ç æ•°æ®çš„å‰¯æœ¬å’Œå·²è§£ç çš„å…ƒæ•°æ®ï¼ˆå³è§£æå‡ºäº†å›¾åƒçš„å¸§æ•°ã€é—´éš”ã€å¾ªç¯æ¬¡æ•°ç­‰å…ƒæ•°æ®ï¼‰ã€‚ psï¼šå¸§é€šè¿‡GifFrameæŒ‰éœ€è§£ç ã€‚*/ AnimatedImage gifImage; if (input.getByteBuffer() != null) { /*sGifAnimatedImageDecoderå…¶å®ä¹Ÿå°±æ˜¯æ˜¯GifImage*/ gifImage = sGifAnimatedImageDecoder.decode(input.getByteBuffer()); } else { gifImage = sGifAnimatedImageDecoder.decode(input.getNativePtr(), input.size()); } /*ä¸Šé¢è§£æå‡ºæ¥çš„AnimateImageä¿¡æ¯ï¼Œæ ¹æ®optioné…ç½®ï¼Œå†³å®šæ˜¯å¦è§£ææˆé™æ€å›¾ç‰‡ï¼Œæ˜¯å¦è§£æå…¨éƒ¨å¸§ä½å›¾åˆ—è¡¨ï¼Œæ˜¯å¦è®¾ç½®é¢„è§ˆå¸§ç­‰è¿›ä¸€æ­¥å°è£…æˆCloseableImage*/ return getCloseableImage(options, gifImage, bitmapConfig); } finally { CloseableReference.closeSafely(bytesRef); } }} Gifè§£ç åå¸§çš„ç¼“å­˜ï¼ˆé—®é¢˜å‡ºåœ¨å“ªï¼‰è¿˜è®°å¾—ä¸Šé¢submitRequeståéœ€è¦èµ°åŠ è½½æµç¨‹åçš„å›¾åƒåŠ è½½æˆåŠŸç»“æœonNewResultInternalå—ï¼Œ 1234567891011AnimatedImageFactoryImpl.classprivate CloseableImage getCloseableImage( ImageDecodeOptions options, AnimatedImage image, Bitmap.Config bitmapConfig) { AnimatedImageResult animatedImageResult = AnimatedImageResult.newBuilder(image) .setPreviewBitmap(previewBitmap) .setFrameForPreview(frameForPreview) .setDecodedFrames(decodedFrames) .build(); return new CloseableAnimatedImage(animatedImageResult);} è¿™ä¸ªæ–¹æ³•ä¼šå°†AnimatedImageï¼ˆGifImageï¼‰è¿›ä¸€æ­¥å°è£…æˆAnimatedResultï¼ˆæ„å»ºè€…æ¨¡å¼æ„å»ºï¼‰ï¼Œç„¶åè¿”å›ä¸€ä¸ªnew CloseableAnimatedImage(animatedImageResult) æ­¤æ—¶CloseableAnimatedImageä¸­å°±æœ‰äº†æ–°å»ºçš„animatedImageResultï¼ˆæœªè§£ç çš„å›¾åƒä¸gifå…ƒæ•°æ®ï¼‰ï¼Œæœ€åè¿™ä¸ªcloseableAnimatedImageä¼šè¢«ä¼ é€’åˆ°AbstractDraweeController.classä¸­çš„ onNewResultInternal(String id, DataSource&lt;T&gt; dataSource, @Nullable T image, float progress, boolean isFinished, boolean wasImmediate, boolean deliverTempResult) ï¼Œ æ‰§è¡Œ drawable = createDrawable(image); æ­¤æ–¹æ³•å…·ä½“å®ç°åœ¨PipelineDraweeControllerï¼ˆextends AbstractDraweeControllerï¼‰ä¸­ 12345678910//PipelineDraweeControllerprotected Drawable createDrawable(CloseableReference&lt;CloseableImage&gt; image) { ... drawable = mDefaultDrawableFactory.createDrawable(closeableImage); if (drawable != null) { return drawable; } ... }} mDefaultDrawableFactoryæ˜¯ExperimentalBitmapAnimationDrawableFactoryï¼ˆ implements DrawableFactoryï¼‰çš„å®ä¾‹ï¼Œ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125//ExperimentalBitmapAnimationDrawableFactory.classpublic AnimatedDrawable2 createDrawable(CloseableImage image) { return new AnimatedDrawable2( //((CloseableAnimatedImage) image).getImageResult())ä¹Ÿå°±æ˜¯ä¸Šé¢AnimatedImageFactoryImpl.getCloseableImageè¿”å›çš„AnimatedResultå¯¹è±¡ã€‚ createAnimationBackend(((CloseableAnimatedImage) image).getImageResult()));}private AnimationBackend createAnimationBackend(AnimatedImageResult animatedImageResult) { ... BitmapFrameCache bitmapFrameCache = createBitmapFrameCache(animatedImageResult); ...}private AnimatedFrameCache createAnimatedFrameCache( final AnimatedImageResult animatedImageResult) { return new AnimatedFrameCache( new AnimationFrameCacheKey(animatedImageResult.hashCode()), mBackingCache);}public class AnimationFrameCacheKey implements CacheKey { private static final String URI_PREFIX = &quot;anim://&quot;; private final String mAnimationUriString; private final boolean mDeepEquals; //æºç ä¸­ä¸ºfalse //imageId = animatedImageResult.hashCode() public AnimationFrameCacheKey(int imageId) { mAnimationUriString = URI_PREFIX + imageId; //e.gï¼š â€œanim://306123060&quot; } //é‡å†™equalsä¸hashCodeæ–¹æ³•ä»¥æ±‚ å¾—åˆ°æ­£ç¡®çš„æ¯”å¯¹ç»“æœ @Override public boolean equals(@Nullable Object o) { if (!mDeepEquals) { return super.equals(o); } if (this == o) { return true; } if (o == null || getClass() != o.getClass()) { return false; } AnimationFrameCacheKey that = (AnimationFrameCacheKey) o; return mAnimationUriString.equals(that.mAnimationUriString); } @Override public int hashCode() { if (!mDeepEquals) { return super.hashCode(); } return mAnimationUriString.hashCode(); }}public class AnimatedFrameCache { @Nullable public CloseableReference&lt;CloseableImage&gt; cache( int frameIndex, CloseableReference&lt;CloseableImage&gt; imageRef) { return mBackingCache.cache(keyFor(frameIndex), imageRef, mEntryStateObserver); } private FrameKey keyFor(int frameIndex) { return new FrameKey(mImageCacheKey, frameIndex); } //æ¯ä¸€å¸§çš„ç¼“å­˜Keyã€‚equalsæ—¶æ¯”è¾ƒç±»å‹ã€ static class FrameKey implements CacheKey { //è¿™é‡ŒCacheKey æ˜¯ AnimationFrameCacheKey private final CacheKey mImageCacheKey; private final int mFrameIndex; public FrameKey(CacheKey imageCacheKey, int frameIndex) { mImageCacheKey = imageCacheKey; mFrameIndex = frameIndex; } public boolean equals(Object o) { if (o == this) { return true; } if (o instanceof FrameKey) { FrameKey that = (FrameKey) o; return this.mFrameIndex == that.mFrameIndex &amp;&amp; this.mImageCacheKey.equals(that.mImageCacheKey); } return false; } } } public synchronized void onFrameRendered( int frameNumber, CloseableReference&lt;Bitmap&gt; bitmapReference, @BitmapAnimationBackend.FrameType int frameType) { Preconditions.checkNotNull(bitmapReference); // Close up prepared references. removePreparedReference(frameNumber); // Create the new image reference and cache it. CloseableReference&lt;CloseableImage&gt; closableReference = null; try { closableReference = createImageReference(bitmapReference); if (closableReference != null) { CloseableReference.closeSafely(mLastRenderedItem); mLastRenderedItem = mAnimatedFrameCache.cache(frameNumber, closableReference); } } finally { CloseableReference.closeSafely(closableReference); } } mBackingCacheå†…å­˜ç¼“å­˜æ±  ç¼“å­˜gifæ¯ä¸€å¸§æ—¶ï¼Œkeyä¸ºFrameKeyï¼ŒFrameKeyç”± æ•´ä¸ªGifå›¾å½¢çš„ç¼“å­˜key mImageCacheKey + å¸§ç´¢å¼•mFrameIndexï¼‰ ç»„æˆã€‚ è€Œ mImageCacheKey æ˜¯AnimationFrameCacheKeyçš„å®ä¾‹ï¼Œå…¶ä¸­ æ ¸å¿ƒå˜é‡ä¸ºmAnimationUriStringï¼Œæ˜¯ç”± â€œanim://â€œ + animatedImageResult.hashCodeç»„æˆçš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¿å­˜å¸ƒå°”å€¼mDeepEqualsæ˜¯å¦è¿›è¡Œå†…å®¹åˆ¤æ–­ã€‚ ï¼ˆanimatedImageResultä¸­ä¿å­˜äº†AnimatedImageï¼ˆGifImageï¼‰ã€é¢„è§ˆå›¾(maybe null)ã€é¢„è§ˆå¸§(maybe null)ã€æ‰€æœ‰å¸§åˆ—è¡¨ï¼ˆå¦‚æœæ‰“å¼€äº†options.decodeAllFrames,maybe nullï¼‰ï¼Œæ˜¯ç”± æœªè§£ç gifå›¾å½¢ç¼“å­˜encodeImage åˆæ­¥è§£æå…ƒæ•°æ®å çš„å°è£…ï¼‰ å¦‚æœmDeepEqualsæ˜¯trueçš„è¯ï¼Œåˆ¤æ–­ç¼“å­˜æ˜¯å¦å­˜åœ¨ â€‹ æ˜¯ä¾æ®FrameKey.mImageCacheKey.mAnimationUriString å†…å®¹æ˜¯å¦ç›¸åŒ ä¸ FrameKey.mFrameIndexæ˜¯å¦ç›¸ç­‰ã€‚ å¦‚æœmDeepEqualsæ˜¯falseçš„è¯ï¼Œåˆ¤æ–­ç¼“å­˜æ˜¯å¦å­˜åœ¨ â€‹ æ˜¯ä¾æ®FrameKey.mImageCacheKey.mAnimationUriString å¯¹è±¡æ˜¯å¦ç›¸åŒ ä¸ FrameKey.mFrameIndexæ˜¯å¦ç›¸ç­‰ ç”±äºåŸä»£ç ä¸­ç”±äºmDeepEquals=falseï¼Œä¸”mAnimationUriStringæ¯æ¬¡éƒ½æ˜¯newå‡ºæ¥çš„ï¼Œæ‰€ä»¥å¿…ç„¶ä¸ä¼šç›¸ç­‰ï¼Œä¹Ÿå°±æ˜¯å¸§å†…å­˜ç¼“å­˜æ°¸è¿œæ— æ³•å‘½ä¸­ã€‚ é‚£ä¹ˆç¬¬ä¸€æ­¥å°±æ˜¯mDeepEqualsç½®ä¸ºtrueï¼Œ ä½†æ˜¯ç”±äºmAnimationUriString = â€œanim://â€œ + animatedImageResult.hashCode åˆï¼šanimatedImageResultæ˜¯æ¯æ¬¡è§£æencodeImageéƒ½ä¼šé‡æ–°æ„å»ºçš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ï¼š ä» æœªè§£ç å›¾åƒç¼“å­˜ ä¸­ï¼ŒåŒå¼ å›¾ç‰‡ æ¯æ¬¡è§£æ éƒ½ä¼šå¾—åˆ°ä¸åŒçš„animatedImageResultï¼ŒmAnimationUriStringåˆæ˜¯æ¯ä¸€æ¬¡è§£æéƒ½æ˜¯ä¸åŒçš„ã€‚ æ‰€ä»¥å¸§å†…å­˜ç¼“å­˜åˆæ— æ³•å‘½ä¸­ã€‚ æ‰€ä»¥ç¬¬äºŒæ­¥éœ€è¦ ä¸€ä¸ªencodeImageå¯¹åº”çš„å”¯ä¸€ å€¼æ›¿ä»£ animatedImageResult.hashCode ã€‚ è€ƒè™‘å¯ä»¥é€‰æ‹©ä¸¤ä¸ªï¼š ä¸€ä¸ªæ˜¯ encodeImageçš„hashå€¼ï¼Œ æœªè§£ç å›¾ç‰‡å†…å­˜ç¼“å­˜æ˜¯æ­£ç¡®çš„ï¼Œæ¯æ¬¡åº”ç”¨å®Œæ•´å‘¨æœŸ éƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„encodeImage å¯¹åº”å›¾åƒï¼ŒdecodeGifæ—¶encodeImageä¸­å­˜å‚¨æœªè§£ç å›¾åƒå­—èŠ‚æ•°ç»„CloseableReference&lt;PooledByteBuffer&gt; mPooledByteBufferRef;çš„getValueHashæ–¹æ³•ã€‚ 123456CloseableReference.classMethod used for tracking Closeables pointed by CloseableReference. Use only for debugging and logging.public int getValueHash() { return isValid() ? System.identityHashCode(mSharedReference.get()) : 0;}//identityHashCode â‰ˆ hashCode() ä¸€ä¸ªæ˜¯ æ ¹æ®urlç”Ÿæˆçš„cacheKeyï¼Œè®¾æƒ³æ˜¯ç›´æ¥ç”¨å›¾åƒurlç”Ÿæˆçš„ç£ç›˜ç¼“å­˜keyï¼Œä½†æ˜¯ä¼ é€’é“¾å¤ªé•¿äº† æˆ‘æš‚æ—¶é€‰æ‹©çš„æ˜¯getValueHash åƒdokitè·Ÿfrescoéƒ½åœ¨keyçš„ç”Ÿæˆå’Œä½¿ç”¨ä¸­å‡ºè¿‡ä¸€äº›bugï¼Œä»¥ä¸‹æ˜¯æˆ‘çš„pullRequest dokitå¯¹frescoæ¡†æ¶ä¸‹çš„å¤§å›¾æ£€æµ‹åŠŸèƒ½å¯¼è‡´å›¾ç‰‡é—ªçƒï¼ˆæºäºè‡ªå®šä¹‰çš„postProcessoræ¯æ¬¡éƒ½é‡æ–°éƒ½æ–°å»ºäº† å†…å­˜ç¼“å­˜ç®¡ç†ç±»CacheKeyï¼‰ https://github.com/didi/DoraemonKit/pull/714/commits/4dbc58b84cfe1286c666d0cab5031092df52d81e frescoå®˜æ–¹ä¸­gifå›¾ç¼“å­˜å¤±æ•ˆï¼Œå¯¼è‡´é‡å¤åŠ è½½åŒä¸€å¼ gifå›¾æ—¶å†…å­˜æŒç»­å¢é•¿ ï¼ˆæºäºä¸€ä¸ªEndcodeImageåœ¨è¿›ä¸€æ­¥è§£ææˆæ–‡ä»¶å­—èŠ‚æ•°ç»„åŒ…è£¹çš„å¯¹è±¡AnimatedResultæ—¶ï¼Œæ¯æ¬¡éƒ½æ˜¯æ–°å»ºçš„AnimatedResultå¯¹è±¡ï¼Œåˆç”¨è¿™ä¸ªå¯¹è±¡çš„hashcode+frameIndexä½œä¸ºè§£ææˆå¸§å†…å­˜ç¼“å­˜æ—¶çš„keyä¿¡æ¯ï¼Œæ‰€ä»¥å°±å¯¼è‡´äº†å¸§å†…å­˜ç¼“å­˜å¤±æ•ˆï¼‰ Gif cache doesnâ€™t seem to be working. Â· Issue #2605 Â· facebook/fresco (github.com) change imageId in AnimatedImageResult from the class hash to decodeHaâ€¦ by WhileCrow Â· Pull Request #2612 Â· facebook/fresco (github.com) é™„å½•ï¼šå®Œæ•´ProducerSequenceæ•´ä¸ªProducer Sequenceï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š NetworkFetchProducer : è´Ÿè´£ä»ç½‘ç»œä¸‹è½½å›¾ç‰‡æ•°æ®ï¼Œå†…éƒ¨æŒæœ‰NetworkFetcherï¼Œè´Ÿè´£ä½¿ç”¨ä¸åŒçš„Httpæ¡†æ¶å»å®ç°ä¸‹è½½é€»è¾‘ï¼Œä¾‹å¦‚ï¼šHttpUrlConnectionNetworkFetcherã€OkHttpNetworkFetcherã€VolleyNetworkFetcherç­‰ã€‚ WebpTranscodeProducer : å› ä¸ºä¸æ˜¯æ‰€æœ‰Androidå¹³å°éƒ½æ”¯æŒWebPï¼Œå…·ä½“å¯ä»¥å‚è€ƒWebpTranscodeProducer.shouldTranscodeæ–¹æ³•ï¼Œæ‰€ä»¥å¯¹äºä¸æ”¯æŒWebPçš„å¹³å°ï¼Œéœ€è¦è½¬æ¢æˆjpg/pngã€‚å…¶ä¸­æ— æŸæˆ–è€…å¸¦é€æ˜åº¦çš„WebPï¼ˆDefaultImageFormats.WEBP_LOSSLESSå’ŒDefaultImageFormats.WEBP_EXTENDED_WITH_ALPHAï¼‰ï¼Œéœ€è¦è½¬æ¢æˆPNGï¼Œå…·ä½“æ–¹æ³•æ˜¯å…ˆæŠŠWebPè§£ç æˆRGBAï¼Œç„¶åå†æŠŠRGBAç¼–ç æˆPNGï¼›ç®€å•æˆ–è€…æ‰©å±•çš„WebPï¼ˆDefaultImageFormats.WEBP_SIMPLEå’ŒDefaultImageFormats.WEBP_EXTENDEDï¼‰ï¼Œéœ€è¦è½¬æ¢æˆJPEGã€‚å…·ä½“æ–¹æ³•æ˜¯å…ˆæŠŠWebPè§£ç æˆRGBï¼Œç„¶åå†æŠŠRGBç¼–ç æˆJPEGã€‚ PartialDiskCacheProducer : è§£ä¸‹æ¥çš„ä¸‰ä¸ªæ˜¯ç£ç›˜ç¼“å­˜EncodedImageç›¸å…³ DiskCacheWriteProducer DiskCacheReadProducer EncodedMemoryCacheProducer : æœªè§£ç æ•°æ®çš„å†…å­˜ç¼“å­˜ EncodedCacheKeyMultiplexProducer AddImageTransformMetaDataProducer ResizeAndRotateProducer : è´Ÿè´£é‡‡æ ·å’Œå›¾ç‰‡æ—‹è½¬ DecodeProducer : ä¸Šè¿°çš„Produceréƒ½æ˜¯åŸºäºEncodedImageï¼ŒDecodeProducerä¼šæŠŠEncodedImageè§£ç æˆCloseableReference BitmapMemoryCacheProducer : æ¥ä¸‹æ¥çš„ä¸¤ä¸ªæ˜¯å†…å­˜Bitmapç¼“å­˜ç›¸å…³ BitmapMemoryCacheKeyMultiplexProducer ThreadHandoffProducer : è´Ÿè´£åˆ‡æ¢çº¿ç¨‹ BitmapMemoryCacheGetProducer PostprocessorProducer PostprocessedBitmapMemoryCacheProducer BitmapPrepareProducer ä»ä¸‹å¾€ä¸Šï¼Œä¾æ¬¡æŒæœ‰å¼•ç”¨ï¼›ä»ä¸Šå¾€ä¸‹ï¼Œä¾æ¬¡è¿”å›æ•°æ® OtherFrescoç½‘ç»œå¤§å›¾æ£€æµ‹123456789101112131415161718192021222324252627282930313233//æ’æ¡©/* æ€è·¯ï¼šdraweeViewåœ¨xmlæˆ–æ‰‹åŠ¨setUriæœ€ç»ˆéƒ½éœ€è¦ä¸ºdraweeViewæ„å»ºDraweeControllerï¼Œç”±æ­¤å¾—åˆ°äº†ç»Ÿä¸€çš„draweeViewä¼ å…¥é“¾æ¥çš„å…¥å£æ—¶æœºï¼šæ„å»ºå®Œå°†è¯¥DraweeControllerè®¾ç½®ä¸ºcontrolleræ—¶ç›®çš„ï¼šè·å¾—draweeViewçš„å®½é«˜ï¼ˆæ³¨å†Œå…¶å¸ƒå±€å›è°ƒå®Œæˆï¼‰ã€draweeViewæ‰€åœ¨é¡µé¢åŠidã€å›¾ç‰‡é“¾æ¥ */private fun createDraweeViewInsnList(): InsnList { return with(InsnList()) { add(VarInsnNode(ALOAD, 0)) //ç”±äºDraweeView.setControlleræ–¹æ³•å†…å¼•ç”¨äº†å…¨å±€å˜é‡ï¼Œæ•…æ–¹æ³•å­—èŠ‚ç ä¸­ä¼šå°†DraweeViewå¯¹è±¡æœ€ä¸ºå‚æ•°ä¼ å…¥æ–¹æ³• add(VarInsnNode(ALOAD, 1)) add(MethodInsnNode(INVOKESTATIC, &quot;com/didichuxing/doraemonkit/aop/bigimg/fresco/MyFrescoHook&quot;, &quot;frescoRealHook&quot;, &quot;(Landroid/view/View;Lcom/facebook/drawee/interfaces/DraweeController;)V&quot;, false)) this } }//æ’æ¡©/* æ€è·¯ï¼šè®¾ç½®è‡ªå®šä¹‰postProcessorï¼ŒpostProcessorä¼šå›è°ƒå›¾ç‰‡åŠ è½½å®Œæˆæ—¶æœºæ—¶æœºï¼šåœ¨å›¾ç‰‡ä¸‹è½½è§£æå®Œæˆæ—¶ç›®çš„ï¼šè·å¾—å†…å­˜å›¾ç‰‡å¤§å°ä¸å›¾ç‰‡é“¾æ¥ */private fun createFrescoInsnList(): InsnList { return with(InsnList()) { add(VarInsnNode(ALOAD, 1)) add(VarInsnNode(ALOAD, 1)) add(MethodInsnNode(INVOKEVIRTUAL, &quot;com/facebook/imagepipeline/request/ImageRequestBuilder&quot;, &quot;getSourceUri&quot;, &quot;()Landroid/net/Uri;&quot;, false)) add(VarInsnNode(ALOAD, 1)) add(MethodInsnNode(INVOKEVIRTUAL, &quot;com/facebook/imagepipeline/request/ImageRequestBuilder&quot;, &quot;getPostprocessor&quot;, &quot;()Lcom/facebook/imagepipeline/request/Postprocessor;&quot;, false)) add(MethodInsnNode(INVOKESTATIC, &quot;com/didichuxing/doraemonkit/aop/bigimg/fresco/FrescoHook&quot;, &quot;proxy&quot;, &quot;(Landroid/net/Uri;Lcom/facebook/imagepipeline/request/Postprocessor;)Lcom/facebook/imagepipeline/request/Postprocessor;&quot;, false)) add(MethodInsnNode(INVOKEVIRTUAL, &quot;com/facebook/imagepipeline/request/ImageRequestBuilder&quot;, &quot;setPostprocessor&quot;, &quot;(Lcom/facebook/imagepipeline/request/Postprocessor;)Lcom/facebook/imagepipeline/request/ImageRequestBuilder;&quot;, false)) this } } //ä¹‹åå°±æ˜¯ä»¥å›¾ç‰‡é“¾æ¥ä¸ºæ¡¥æ¢ï¼Œå°†ä¸¤ä¸ªä¸åŒæ—¶æœºè·å–çš„ä¿¡æ¯æ•´åˆï¼Œæ¯”å¯¹å†…å­˜å°ºå¯¸ä¸viewå°ºå¯¸ å‚è€ƒ Frescoæ¶æ„è®¾è®¡èµæ | susion Frescoç¼“å­˜æ¶æ„åˆ†æ | susion Frescoç¼“å­˜æ¶æ„åˆ†æ | susion Frescoå›¾ç‰‡æ˜¾ç¤ºåŸç†æµ…æ | susion Frescoä½¿ç”¨çš„æ‰©å±• | susion GIFé¢é¢è§‚ - æ˜é‡‘ (juejin.cn)","link":"/2021/04/09/Fresco/"},{"title":"Git","text":"èŠ‚ç‚¹Qï¼šæ¯æ¬¡commitï¼ŒGitå‚¨å­˜çš„æ˜¯å…¨æ–°çš„æ–‡ä»¶å¿«ç…§è¿˜æ˜¯å‚¨å­˜æ–‡ä»¶çš„å˜æ›´éƒ¨åˆ†ï¼Ÿ A: å…¨æ–°çš„æ–‡ä»¶å¿«ç…§ Gitå‚¨å­˜çš„æ˜¯å…¨æ–°çš„æ–‡ä»¶å¿«ç…§ï¼Œè€Œä¸æ˜¯æ–‡ä»¶çš„å˜æ›´è®°å½•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå°±ç®—ä½ åªæ˜¯åœ¨æ–‡ä»¶ä¸­æ·»åŠ ä¸€è¡Œï¼ŒGitä¹Ÿä¼šæ–°å»ºä¸€ä¸ªå…¨æ–°çš„blob objectã€‚é‚£è¿™æ ·å­æ˜¯ä¸æ˜¯å¾ˆæµªè´¹ç©ºé—´å‘¢? è¿™å…¶å®æ˜¯Gitåœ¨ç©ºé—´å’Œæ—¶é—´ä¸Šçš„ä¸€ä¸ªå–èˆï¼Œæ€è€ƒä¸€ä¸‹ä½ è¦checkoutä¸€ä¸ªcommitï¼Œæˆ–å¯¹æ¯”ä¸¤ä¸ªcommitä¹‹é—´çš„å·®å¼‚ã€‚å¦‚æœGitå‚¨å­˜çš„æ˜¯é—®å·çš„å˜æ›´éƒ¨åˆ†ï¼Œé‚£ä¹ˆä¸ºäº†æ‹¿åˆ°ä¸€ä¸ªcommitçš„å†…å®¹ï¼ŒGitéƒ½åªèƒ½ä»ç¬¬ä¸€ä¸ªcommitå¼€å§‹ï¼Œç„¶åä¸€ç›´è®¡ç®—å˜æ›´ï¼Œç›´åˆ°ç›®æ ‡commitï¼Œè¿™ä¼šèŠ±è´¹å¾ˆé•¿æ—¶é—´ã€‚è€Œç›¸åï¼ŒGité‡‡ç”¨çš„å‚¨å­˜å…¨æ–°æ–‡ä»¶å¿«ç…§çš„æ–¹æ³•èƒ½ä½¿è¿™ä¸ªæ“ä½œå˜å¾—å¾ˆå¿«ï¼Œç›´æ¥ä»å¿«ç…§é‡Œé¢æ‹¿å–å†…å®¹å°±è¡Œäº†ã€‚ å½“ç„¶ï¼Œåœ¨æ¶‰åŠç½‘ç»œä¼ è¾“æˆ–è€…Gitä»“åº“çœŸçš„ä½“ç§¯å¾ˆå¤§çš„æ—¶å€™ï¼ŒGitä¼šæœ‰åƒåœ¾å›æ”¶æœºåˆ¶gcï¼Œä¸ä»…ä¼šæ¸…é™¤æ— ç”¨çš„objectï¼Œè¿˜ä¼šæŠŠå·²æœ‰çš„ç›¸ä¼¼objectæ‰“åŒ…å‹ç¼©ã€‚ Merge å’Œ Rebaseçš„åŒºåˆ«$ git pull --rebaseå’Œ$ git pullåŒºåˆ«git pullæ˜¯git fetch + git merge FETCH_HEADçš„ç¼©å†™ï¼Œæ‰€ä»¥é»˜è®¤æƒ…å†µä¸‹ï¼Œgit pullå°±æ˜¯å…ˆfetch,ç„¶åæ‰§è¡Œmergeæ“ä½œï¼Œå¦‚æœåŠ -rebaseå‚æ•°ï¼Œå°±æ˜¯ä½¿ç”¨git rebaseä»£æ›¿git merge ã€‚ ç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªç°å®çš„è¯·å†µï¼Œå°±æ˜¯BåŒå­¦å‡†å¤‡è¿›è¡Œç¬¬4æ¬¡æäº¤çš„æ—¶å€™ï¼ŒåŒå­¦Aåœ¨masterä¸»åˆ†æ”¯ä¸Šè¿›è¡Œäº†ä¸€æ¬¡æäº¤ï¼Œmasterçš„æäº¤å·²ç»å‘å‰èµ°äº† æ­¤æ—¶çš„gitåˆ†æ”¯ç±»å›¾æ˜¯è¿™æ ·çš„ æ­¤æ—¶æˆ‘ä»¬çŸ¥é“BåŒå­¦å¼€å‘çš„devåˆ†æ”¯æ˜¯åŸºäºC2æäº¤ç‚¹åˆ‡å‡ºæ¥çš„ï¼Œè€Œè¿™ä¸ªæ—¶å€™masteråˆ†æ”¯å·²ç»è¢«æ›´æ–°äº† å¦‚æœBåŒå­¦å¼€å‘å®Œæ¯•ï¼Œéœ€è¦å°†å…¶æ‰€ä½œçš„åŠŸèƒ½åˆå¹¶åˆ°masteråˆ†æ”¯ ï¼Œä»–å¯ä»¥æœ‰ä¸¤ç§é€‰æ‹©ï¼š Mergeç›´æ¥git mergeï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä¼šè¿™ä¹ˆåš ï¼ˆ1ï¼‰æ‰¾åˆ°masterå’Œdevçš„å…±åŒç¥–å…ˆï¼Œå³C2 ï¼ˆ2ï¼‰å°†devçš„æœ€æ–°æäº¤C5å’Œmasterçš„æœ€æ–°æäº¤å³C6åˆå¹¶æˆä¸€ä¸ªæ–°çš„æäº¤C7ï¼Œæœ‰å†²çªçš„è¯ï¼Œè§£å†³å†²çª ï¼ˆ3ï¼‰å°†C2ä¹‹åçš„devå’Œmasteræ‰€æœ‰æäº¤ç‚¹ï¼ŒæŒ‰ç…§æäº¤æ—¶é—´åˆå¹¶åˆ°master Rebaseç›´æ¥git rebase åˆ‡æ¢åˆ†æ”¯åˆ°éœ€è¦rebaseçš„åˆ†æ”¯ï¼Œè¿™é‡Œæ˜¯devåˆ†æ”¯ æ‰§è¡Œgit rebase masterï¼Œæœ‰å†²çªå°±è§£å†³å†²çªï¼Œè§£å†³åç›´æ¥git add . å†git rebase â€“continueå³å¯ å‘ç°é‡‡ç”¨rebaseçš„æ–¹å¼è¿›è¡Œåˆ†æ”¯åˆå¹¶ï¼Œæ•´ä¸ªmasteråˆ†æ”¯å¹¶æ²¡æœ‰å¤šå‡ºä¸€ä¸ªæ–°çš„commitï¼ŒåŸæ¥devåˆ†æ”¯ä¸Šçš„é‚£å‡ æ¬¡ï¼ˆC3ï¼ŒC4ï¼ŒC5ï¼‰commitè®°å½•åœ¨rebaseä¹‹åå…¶hashå€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸åœ¨æ˜¯å½“åˆåœ¨devåˆ†æ”¯ä¸Šæäº¤çš„æ—¶å€™çš„hashå€¼äº†ï¼Œä½†æ˜¯æäº¤çš„å†…å®¹è¢«å…¨éƒ¨å¤åˆ¶ä¿ç•™äº†ï¼Œå¹¶ä¸”æ•´ä¸ªmasteråˆ†æ”¯çš„commitè®°å½•å‘ˆçº¿æ€§è®°å½• æ­¤æ—¶gitçš„åˆ†æ”¯ç±»å›¾ å°ç»“ç®€å•æ¥è®²ï¼šrebaseä¼šæ”¹å˜æäº¤å†å²ï¼Œä½†å¯ä»¥ä½¿åˆ†æ”¯å¹²å‡€ï¼Œéœ€è¦æ…é‡ã€‚mergeä¼šæ–°å»ºèŠ‚ç‚¹ï¼Œä¸æ”¹å˜æäº¤ï¼Œä½†æ˜¯å®¹æ˜“ä½¿åˆ†æ”¯å˜ä¹±ã€‚ git merge ä¼šè®©2ä¸ªåˆ†æ”¯çš„æäº¤æŒ‰ç…§æäº¤æ—¶é—´è¿›è¡Œæ’åºï¼Œå¹¶ä¸”ä¼šæŠŠæœ€æ–°çš„2ä¸ªcommitåˆå¹¶æˆä¸€ä¸ªcommitã€‚æœ€åçš„åˆ†æ”¯æ ‘å‘ˆç°éçº¿æ€§çš„ç»“æ„ã€‚ï¼ˆåˆ›å»ºæ–°çš„commitï¼ŒèŠ‚ç‚¹hashä¸å˜ï¼‰ git reabse å°†devçš„å½“å‰æäº¤å¤åˆ¶åˆ°masterçš„æœ€æ–°æäº¤ä¹‹åï¼Œä¼šå½¢æˆä¸€ä¸ªçº¿æ€§çš„åˆ†æ”¯æ ‘ã€‚ï¼ˆæ— æ–°å»ºcommitï¼Œå‘èµ·rebaseçš„åˆ†æ”¯éç¥–å…ˆèŠ‚ç‚¹å¾€åçš„èŠ‚ç‚¹å¤åˆ¶ï¼Œhashå€¼æ”¹å˜ï¼‰ Pull å’Œ Fetch çš„åŒºåˆ«git fetchåœ¨æ‹‰å–ä»£ç è¿‡ç¨‹ä¸­ï¼Œgit fetchä¼šé¦–å…ˆæ£€æŸ¥æœ¬åœ°ä»“åº“å’Œè¿œç¨‹ä»“åº“çš„å·®å¼‚ï¼Œæ£€æŸ¥å“ªäº›ä¸å­˜åœ¨äºæœ¬åœ°ä»“åº“ï¼Œç„¶åå°†è¿™äº›å˜åŠ¨çš„æäº¤æ‹‰å–åˆ°æœ¬åœ°ã€‚ ä½†æ˜¯ï¼Œè¿™é‡Œè¯·æ³¨æ„ï¼Œå®ƒæ˜¯æŠŠè¿œç¨‹æäº¤æ‹‰å–åˆ°æœ¬åœ°ä»“åº“ï¼Œè€Œä¸æ˜¯æœ¬åœ°å·¥ä½œç›®å½•ï¼Œå®ƒä¸ä¼šè‡ªè¡Œå°†è¿™äº›æ–°æ•°æ®åˆå¹¶åˆ°å½“å‰å·¥ä½œç›®å½•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç»§ç»­æ‰§è¡Œgit mergeæ‰ä¼šæŠŠè¿™äº›å˜åŠ¨åˆå¹¶åˆ°å½“å‰å·¥ä½œç›®å½•ã€‚ git pullgit pullå’Œgit fetchåˆšå¥½ç›¸åï¼Œå®ƒç›´æ¥è·å–è¿œç¨‹çš„æœ€æ–°æäº¤ï¼Œç›´æ¥æ‹‰å–å¹¶åˆå¹¶åˆ°æœ¬åœ°å·¥ä½œç›®å½•ï¼Œè€Œä¸”åœ¨åˆå¹¶è¿‡ç¨‹ä¸­ä¸ä¼šç»è¿‡æˆ‘ä»¬çš„å®¡æŸ¥ï¼Œå¦‚æœä¸ä»”ç»†æ£€æŸ¥ï¼Œè¿™æ ·å¾ˆå®¹æ˜“é‡åˆ°å†²çªã€‚ åŸç†","link":"/2022/07/26/Git/"},{"title":"Fragment","text":"https://developer.android.com/guide/fragments/lifecycle?hl=zh-cn ç”Ÿå‘½å‘¨æœŸ//ç®€è¿°ï¼šè¿˜æœ‰ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ˜¯ onViewCreated()ï¼Œè¯¥ç”Ÿå‘½å‘¨æœŸä¼šåœ¨onCreateViewåç«‹å³è°ƒç”¨ï¼ˆæ­¤æ—¶å¸ƒå±€inflateå·²å®Œæˆï¼‰ï¼Œæ•…è€Œä¸€èˆ¬fragmentçš„onCreateViewä¸­æ‰§è¡Œinflate layoutæ“ä½œåè¿”å›rootViewï¼Œä¹‹ååœ¨onViewCreatedä¸­æ‰§è¡Œå…·ä½“çš„Viewæ“ä½œã€‚ UseFragmentTransactionçš„4ç§æäº¤æ–¹å¼commit()ï¼šcommitæ˜¯éåŒæ­¥æäº¤ï¼ˆæˆ‘è®¤ä¸ºä¸åº”ç§°ä¸ºå¼‚æ­¥ï¼‰ä¸”æ£€æŸ¥æ˜¯å¦å­˜å‚¨çŠ¶æ€çš„ The commit does not happen immediately; it will be scheduled as work on the main thread to be done the next time that thread is ready. éåŒæ­¥æäº¤ï¼šå³æ“ä½œä¼šè¢«poståˆ°ä¸»çº¿ç¨‹handlerçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç­‰å€™è½®åˆ°æ—¶æ‰§è¡Œï¼› æ£€æŸ¥å­˜å‚¨çŠ¶æ€ï¼šå¦‚æœå®¿ä¸»(FragmentActivity)å·²ç»æ‰§è¡Œäº†onSaveInstanceStateå†æ‰§è¡Œè¯¥æ“ä½œï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ 123456//FragmentManager.classprivate void checkStateLoss() { if (this.isStateSaved()) { throw new IllegalStateException(&quot;Can not perform this action after onSaveInstanceState&quot;); }} commitAllowingStateLoss():éåŒæ­¥æäº¤ä¸”ä¸æ£€æŸ¥çŠ¶æ€ å¦‚æœåœ¨å®¿ä¸»æ‰§è¡Œäº†onSaveInstanceSateä¹‹åå†æ‰§è¡Œè¯¥æ“ä½œï¼Œä¸ä¼šå»æ£€æŸ¥å®¿ä¸»çŠ¶æ€,ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ä½†è¯¥æ“ä½œä¸ä¼šè¢«Activityè®°å½•ï¼Œæ¢å¤æ—¶ä¹Ÿå°±æ²¡åŠæ³•æ¢å¤è¿™äº›æäº¤æ“ä½œï¼Œæ‰€ä»¥è¯¥æ“ä½œé€‚ç”¨ä¸é‡è¦çš„äº‹åŠ¡ã€‚åŒå±äºå¼‚æ­¥äº‹åŠ¡ã€‚ commitNow():åŒæ­¥æäº¤ä¸”æ£€æŸ¥çŠ¶æ€ã€‚ ä¼šç«‹åˆ»æ‰§è¡Œå½“å‰æäº¤çš„transactionäº‹åŠ¡ã€‚ commitNowAllowingStateLoss():åŒæ­¥æäº¤ä¸”ä¸æ£€æŸ¥çŠ¶æ€ æ—¢æ˜¯åŒæ­¥æ‰§è¡Œï¼Œä¹Ÿä¸ä¼šæ£€æŸ¥å®¿ä¸»çš„çŠ¶æ€,æœ‰å¯èƒ½è¯¥æ“ä½œä¸ä¼šè¢«æ­£ç¡®æ¢å¤ åŒæ—¶ï¼šä½¿ç”¨ commitNow() æˆ– commitNowAllowingStateLoss() æäº¤çš„äº‹åŠ¡ä¸å…è®¸åŠ å…¥å›é€€æ ˆ 1234567891011@Overridepublic void commitNow() { disallowAddToBackStack(); mManager.execSingleAction(this, false);}@Overridepublic void commitNowAllowingStateLoss() { disallowAddToBackStack(); mManager.execSingleAction(this, true);} Principleæºç ä¸­fragmentçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å›è°ƒåœ¨äº å†…ç½®å®šä¹‰çš„äº”ç§çŠ¶æ€çš„è½¬ç§»ï¼š å½“å®¿ä¸»ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–æ—¶ï¼ŒFragment çš„çŠ¶æ€ä¼šåŒæ­¥åˆ°å®¿ä¸»çš„çŠ¶æ€ã€‚ä»æºç çœ‹ï¼Œä½“ç°åœ¨å®¿ä¸»ç”Ÿå‘½å‘¨æœŸå›è°ƒä¸­ä¼šè°ƒç”¨ FragmentManager ä¸­ä¸€ç³»åˆ— dispatchXXX() æ–¹æ³•æ¥è§¦å‘ Fragment çŠ¶æ€è½¬ç§»ã€‚ 12345678//FragmentActivity@Overrideprotected void onCreate(@Nullable Bundle savedInstanceState) { super.onCreate(savedInstanceState); mFragmentLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE); mFragments.dispatchCreate();} 123456789101112//android.fragment:fragment:1.3.6 Fragment static final int INITIALIZING = -1; // Not yet attached.static final int ATTACHED = 0; // Attached to the host.static final int CREATED = 1; // Created.static final int VIEW_CREATED = 2; // View Created.static final int AWAITING_EXIT_EFFECTS = 3; // Downward state, awaiting exit effectsstatic final int ACTIVITY_CREATED = 4; // Fully created, not started.static final int STARTED = 5; // Created and started, not resumed.static final int AWAITING_ENTER_EFFECTS = 6; // Upward state, awaiting enter effectsstatic final int RESUMED = 7; // Created started and resumed.int mState = INITIALIZING; INITIALIZINGï¼ŒATTACHEDï¼ŒCREATEDï¼ŒVIEW_CREATEDï¼ŒACTIVITY_CREATEDï¼ŒSTARTEDï¼ŒRESUMEDä¸ƒç§çŠ¶æ€è½®æ¢ï¼Œæ¯ä¸ªçŠ¶æ€è½®æ¢ä¹‹é—´ï¼Œç”Ÿå‘½å‘¨æœŸä¹Ÿå°±è‡ªç„¶è¢«è°ƒç”¨åˆ° å¦‚ä¸€æ¬¡åˆ›å»ºæµç¨‹ï¼Œ æšä¸¾çŠ¶æ€INITALIZING-&gt;RESUMEï¼Œå°±ä¼šä¾æ¬¡è°ƒç”¨åˆ°ï¼šonAttach(), onCreate(), onCreateView(), onActivityCreate(), onStart(), onResume(); åä¹‹ï¼ŒRESUME-&gt;INITIALIZINGï¼Œå°±ä¼šä¾æ¬¡è°ƒç”¨:onPause(), onStop(), onSaveInstanceState(), onDestroyView(), onDestroy(), onDetach() å½“ç„¶ï¼Œæ˜¯å¦éœ€è¦è¢«è°ƒç”¨ï¼Œcaseä¹Ÿä¼šè‡ªå·±åˆ¤æ–­ï¼› 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169 @SuppressWarnings(&quot;deprecation&quot;)void moveToState(@NonNull Fragment f, int newState) { FragmentStateManager fragmentStateManager = mFragmentStore.getFragmentStateManager(f.mWho); if (fragmentStateManager == null) { // Ideally, we only call moveToState() on active Fragments. However, // in restoreSaveState() we can call moveToState() on retained Fragments // just to clean them up without them ever being added to mActive. // For these cases, a brand new FragmentStateManager is enough. fragmentStateManager = new FragmentStateManager(mLifecycleCallbacksDispatcher, mFragmentStore, f); // Only allow this FragmentStateManager to go up to CREATED at the most fragmentStateManager.setFragmentManagerState(Fragment.CREATED); } // When inflating an Activity view with a resource instead of using setContentView(), and // that resource adds a fragment using the &lt;fragment&gt; tag (i.e. from layout and in layout), // the fragment will move to the VIEW_CREATED state before the fragment manager // moves to CREATED. So when moving the fragment manager moves to CREATED and the // inflated fragment is already in VIEW_CREATED we need to move new state up from CREATED // to VIEW_CREATED. This avoids accidentally moving the fragment back down to CREATED // which would immediately destroy the Fragment's view. We rely on computeExpectedState() // to pull the state back down if needed. if (f.mFromLayout &amp;&amp; f.mInLayout &amp;&amp; f.mState == Fragment.VIEW_CREATED) { newState = Math.max(newState, Fragment.VIEW_CREATED); } newState = Math.min(newState, fragmentStateManager.computeExpectedState()); if (f.mState &lt;= newState) { // If we are moving to the same state, we do not need to give up on the animation. if (f.mState &lt; newState &amp;&amp; !mExitAnimationCancellationSignals.isEmpty()) { // The fragment is currently being animated... but! Now we // want to move our state back up. Give up on waiting for the // animation and proceed from where we are. cancelExitAnimation(f); } switch (f.mState) { case Fragment.INITIALIZING: if (newState &gt; Fragment.INITIALIZING) { fragmentStateManager.attach(); } // fall through case Fragment.ATTACHED: if (newState &gt; Fragment.ATTACHED) { fragmentStateManager.create(); } // fall through case Fragment.CREATED: // We want to unconditionally run this anytime we do a moveToState that // moves the Fragment above INITIALIZING, including cases such as when // we move from CREATED =&gt; CREATED as part of the case fall through above. if (newState &gt; Fragment.INITIALIZING) { fragmentStateManager.ensureInflatedView(); } if (newState &gt; Fragment.CREATED) { fragmentStateManager.createView(); } // fall through case Fragment.VIEW_CREATED: if (newState &gt; Fragment.VIEW_CREATED) { fragmentStateManager.activityCreated(); } // fall through case Fragment.ACTIVITY_CREATED: if (newState &gt; Fragment.ACTIVITY_CREATED) { fragmentStateManager.start(); } // fall through case Fragment.STARTED: if (newState &gt; Fragment.STARTED) { fragmentStateManager.resume(); } } } else if (f.mState &gt; newState) { switch (f.mState) { case Fragment.RESUMED: if (newState &lt; Fragment.RESUMED) { fragmentStateManager.pause(); } // fall through case Fragment.STARTED: if (newState &lt; Fragment.STARTED) { fragmentStateManager.stop(); } // fall through case Fragment.ACTIVITY_CREATED: if (newState &lt; Fragment.ACTIVITY_CREATED) { if (isLoggingEnabled(Log.DEBUG)) { Log.d(TAG, &quot;movefrom ACTIVITY_CREATED: &quot; + f); } if (f.mView != null) { // Need to save the current view state if not // done already. if (mHost.onShouldSaveFragmentState(f) &amp;&amp; f.mSavedViewState == null) { fragmentStateManager.saveViewState(); } } } // fall through case Fragment.VIEW_CREATED: if (newState &lt; Fragment.VIEW_CREATED) { FragmentAnim.AnimationOrAnimator anim = null; if (f.mView != null &amp;&amp; f.mContainer != null) { // Stop any current animations: f.mContainer.endViewTransition(f.mView); f.mView.clearAnimation(); // If parent is being removed, no need to handle child animations. if (!f.isRemovingParent()) { if (mCurState &gt; Fragment.INITIALIZING &amp;&amp; !mDestroyed &amp;&amp; f.mView.getVisibility() == View.VISIBLE &amp;&amp; f.mPostponedAlpha &gt;= 0) { anim = FragmentAnim.loadAnimation(mHost.getContext(), f, false, f.getPopDirection()); } f.mPostponedAlpha = 0; // Robolectric tests do not post the animation like a real device // so we should keep up with the container and view in case the // fragment view is destroyed before we can remove it. ViewGroup container = f.mContainer; View view = f.mView; if (anim != null) { FragmentAnim.animateRemoveFragment(f, anim, mFragmentTransitionCallback); } container.removeView(view); if (FragmentManager.isLoggingEnabled(Log.VERBOSE)) { Log.v(FragmentManager.TAG, &quot;Removing view &quot; + view + &quot; for &quot; + &quot;fragment &quot; + f + &quot; from container &quot; + container); } // If the local container is different from the fragment // container, that means onAnimationEnd was called, onDestroyView // was dispatched and the fragment was already moved to state, so // we should early return here instead of attempting to move to // state again. if (container != f.mContainer) { return; } } } // If a fragment has an exit animation (or transition), do not destroy // its view immediately and set the state after animating if (mExitAnimationCancellationSignals.get(f) == null) { fragmentStateManager.destroyFragmentView(); } } // fall through case Fragment.CREATED: if (newState &lt; Fragment.CREATED) { if (mExitAnimationCancellationSignals.get(f) != null) { // We are waiting for the fragment's view to finish animating away. newState = Fragment.CREATED; } else { fragmentStateManager.destroy(); } } // fall through case Fragment.ATTACHED: if (newState &lt; Fragment.ATTACHED) { fragmentStateManager.detach(); } } } if (f.mState != newState) { if (isLoggingEnabled(Log.DEBUG)) { Log.d(TAG, &quot;moveToState: Fragment state for &quot; + f + &quot; not updated inline; &quot; + &quot;expected state &quot; + newState + &quot; found &quot; + f.mState); } f.mState = newState; }}","link":"/2023/12/22/Fragment/"},{"title":"Gc","text":"ç°ä»£VMï¼šâ€å¼•ç”¨è®¡æ•°æ³•ï¼Œä¸è¡Œã€‚å¯è¾¾æ€§åˆ†ææ³•ï¼Œè¡Œï¼â€JVMï¼šâ€å¯è¾¾åˆ†ææ³•ï¼Œå¾ˆè¡Œâ€","link":"/2021/04/30/Gc/"},{"title":"Glide","text":"Glideç¼“å­˜ç£ç›˜(DiskLruCache) -&gt; LRUCache(ä¸æ´»è·ƒèµ„æº) -&gt; WeakReference(ä½¿ç”¨ä¸­èµ„æº) å†…å­˜ç¼“å­˜åˆ†ä¸ºå¼±å¼•ç”¨çš„å’Œ LruCache ï¼Œå…¶ä¸­æ­£åœ¨ä½¿ç”¨çš„å›¾ç‰‡ä½¿ç”¨å¼±å¼•ç”¨ç¼“å­˜ï¼Œæš‚æ—¶ä¸ä½¿ç”¨çš„å›¾ç‰‡ç”¨ LruCacheç¼“å­˜ï¼Œè¿™ä¸€ç‚¹æ˜¯é€šè¿‡ å›¾ç‰‡å¼•ç”¨è®¡æ•°å™¨ï¼ˆacquiredå˜é‡ï¼‰æ¥å®ç°çš„ Glideç”Ÿæˆkeyï¼ˆå†…å­˜ç¼“å­˜Keyç±»å‹ä¸ºEngineKeyï¼‰çš„æ–¹å¼è¿œæ¯”æˆ‘ä»¬æƒ³è±¡çš„è¦å¤æ‚ï¼Œå†³å®šç¼“å­˜Keyçš„å‚æ•°æœ‰8ç§ï¼Œå…¶ä¸­åŒ…æ‹¬å›¾ç‰‡URLã€å®½ã€é«˜ã€‚ 12EngineKey key = keyFactory.buildKey(model, signature, width, height, transformations, resourceClass, transcodeClass, options); è¿™é‡Œå¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼Œå‡ ä¹ä»»æ„é…ç½®çš„æ”¹å˜éƒ½ä¼šå¯¼è‡´åŒä¸€å¼ å›¾ç‰‡ç”Ÿæˆå¤šä¸ªç¼“å­˜keyã€‚ä¸¾ä¸ªä¾‹å­ï¼šåŒä¸€å¼ å›¾ç‰‡åŠ è½½åˆ°2ä¸ªä¸åŒå¤§å°çš„ImageViewä¼šç”Ÿæˆ2ä¸ªç¼“å­˜å›¾ç‰‡ Glide QAglideæ˜¯æ€ä¹ˆæ‹¿åˆ°çš„width,heightï¼ˆviewæœªæµ‹ç»˜å‰æ‹¿ä¸åˆ°å®½é«˜ï¼‰width,heightèƒ½æ‹¿åˆ°çš„åŸå› æ˜¯ViewTargetä¼šä¸ºæ‰€æŒæœ‰çš„Viewæ³¨å†Œviewæ ‘ç»˜åˆ¶å›è°ƒ addOnPreDrawListener(OnPreDrawListener listener) Glideçš„ç¼“å­˜å¤§å°é»˜è®¤æ˜¯å¤šå°‘å†…å­˜ç¼“å­˜æœ€å¤§ç©ºé—´(maxSize) = æ¯ä¸ªè¿›ç¨‹å¯ç”¨çš„æœ€å¤§å†…å­˜ï¼ˆactivityManager.getMemoryClass() * 0.4 (ä½é…æ‰‹æœºçš„è¯æ˜¯: æ¯ä¸ªè¿›ç¨‹å¯ç”¨çš„æœ€å¤§å†…å­˜ * 0.33) activityManager.getMemoryClasså€¼ï¼š ä½ç«¯è®¾å¤‡å¯èƒ½åœ¨ 16-32 MB èŒƒå›´å†…ã€‚ ä¸­æ¡£è®¾å¤‡é€šå¸¸åœ¨ 64-128 MB èŒƒå›´å†…ã€‚ é«˜ç«¯è®¾å¤‡å’Œæ–°æ¬¾è®¾å¤‡å¯èƒ½åœ¨ 256 MB æˆ–æ›´é«˜ã€‚//å½“è®¾ç½®largeHeapæ—¶ï¼Œæœ€å¤šå¯ç”³è¯·512M ç£ç›˜ç¼“å­˜å¤§å°: é»˜è®¤250MB ç£ç›˜ç¼“å­˜ç›®å½•: é¡¹ç›®/cache/image_manager_disk_cache //todo Glideç‰¹ç‚¹ ä¼šæ ¹æ®æ§ä»¶å¤§å°è¿›è¡Œä¸‹é‡‡æ ·ï¼Œä»¥è§£ç å‡ºç¬¦åˆéœ€æ±‚çš„å¤§å°ï¼Œå¯¹å†…å­˜æ›´å‹å¥½ å†…å­˜ç¼“å­˜+ç£ç›˜ç¼“å­˜ æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸï¼Œå–æ¶ˆä»»åŠ¡ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ æ„ŸçŸ¥å†…å­˜åƒç´§ï¼Œè¿›è¡Œå›æ”¶ BitmapPoolï¼Œé˜²æ­¢å†…å­˜æŠ–åŠ¨çš„è¿›è¡Œbitmapï¿½ï¿½æ¢ å®šä¹‰è¯·æ±‚ä¼˜å…ˆçº§ æ‰‹å†™ä¸€ä¸ªå›¾ç‰‡åº“æ³¨æ„äº‹é¡¹ è·å–èµ„æºï¼šå¼‚æ­¥å¹¶å‘ä¸‹è½½å›¾ç‰‡ï¼Œæœ€å¤§åŒ–åˆ©ç”¨cpuèµ„æº èµ„æºè§£ç ï¼šæŒ‰å®é™…éœ€æ±‚å¼‚æ­¥è§£ç ï¼Œå¤šçº¿ç¨‹å¹¶å‘æ˜¯å¦èƒ½åŠ å¿«è§£ç é€Ÿåº¦ èµ„æºå˜æ¢ï¼šä½¿ç”¨èµ„æºæ± ï¼Œå¤ç”¨å˜æ¢çš„èµ„æºï¼Œé¿å…å†…å­˜æŠ–åŠ¨ ç¼“å­˜ï¼šç£ç›˜ç¼“å­˜åŸå§‹å›¾ç‰‡ï¼Œæˆ–å˜æ¢çš„èµ„æºã€‚å†…å­˜ç¼“å­˜åˆšä½¿ç”¨è¿‡çš„èµ„æºï¼Œä½¿ç”¨lruç­–ç•¥æ§åˆ¶å¤§å° æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸï¼šé¿å…å†…å­˜æ³„æ¼ æ„ŸçŸ¥å†…å­˜åƒç´§ï¼šæ¸…ç†ç¼“å­˜ Glide æ•°æ®åŠ è½½æµç¨‹ RequestBuilder æ„å»º Requestå’Œ Targetï¼Œå°†è¯·æ±‚å§”æ‰˜ç»™RequestManagerï¼ŒRequestManagerè§¦å‘Request.begin(),ç„¶åè°ƒç”¨Engine.load()åŠ è½½èµ„æºï¼Œè‹¥æœ‰å†…å­˜ç¼“å­˜åˆ™è¿”å›ï¼Œå¦åˆ™å¯åŠ¨å¼‚æ­¥ä»»åŠ¡åŠ è½½ç£ç›˜ç¼“å­˜ï¼Œè‹¥æ— åˆ™ä»ç½‘ç»œåŠ è½½ DecodeJob è´Ÿè´£åŠ è½½æ•°æ®ï¼ˆå¯èƒ½ä»ç£ç›˜ï¼Œæˆ–ç½‘ç»œï¼ŒonDataFetcherReadyï¼‰ï¼Œå†è¿›è¡Œæ•°æ®è§£ç ï¼ˆonDataFetcherReadyï¼‰ï¼Œå†è¿›è¡Œæ•°æ®å˜æ¢ï¼ˆTransformationï¼‰ï¼Œå†™ActiveResourceï¼Œï¼ˆå°†å˜æ¢åçš„æ•°æ®å›è°ƒç»™Targetï¼‰ï¼Œå°†å˜æ¢åçš„èµ„æºå†™æ–‡ä»¶ï¼ˆResourceEncoderï¼‰ é¢„åŠ è½½preloadï¼ŒåŠ è½½åˆ°ä¸€ä¸ªPreloadTargetï¼Œç­‰èµ„æºåŠ è½½å¥½äº†ï¼Œå°±è°ƒç”¨clearï¼Œå°†èµ„æºä»ActiveResourceç§»é™¤å­˜åˆ°Lrucacheä¸­ æ„ŸçŸ¥å†…å­˜åƒç´§æ³¨å†ŒComponentCallbacks2ï¼Œå®ç°ç»†ç²’åº¦å†…å­˜ç®¡ç†ï¼š onLowMemory(){æ¸…é™¤å†…å­˜} onTrimMemory(){ä¿®å‰ªå†…å­˜} 123memoryCache.trimMemory(level); // å†…å­˜ç¼“å­˜bitmapPool.trimMemory(level); // bitmapæ± arrayPool.trimMemory(level); // å­—èŠ‚æ•°ç»„æ±  å¯ä»¥è®¾ç½®åœ¨onTrimMemoryæ—¶ï¼Œå–æ¶ˆæ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ã€‚ BitmapPool BitmatPool æ˜¯ Glide ç»´æŠ¤äº†ä¸€ä¸ªå›¾ç‰‡å¤ç”¨æ± ï¼ŒLruBitmapPool ä½¿ç”¨ Lru ç®—æ³•ä¿ç•™æœ€è¿‘ä½¿ç”¨çš„å°ºå¯¸çš„ Bitmapã€‚ api19 åä½¿ç”¨bitmapçš„å­—èŠ‚æ•°å’Œconfigä½œä¸ºkeyï¼Œè€Œä¹‹å‰ä½¿ç”¨å®½é«˜å’Œcongifï¼Œæ‰€ä»¥19ä»¥åå¤ç”¨åº¦æ›´é«˜ ç”¨ç±»ä¼¼LinkedHashMapå­˜å‚¨ï¼Œé”®å€¼å¯¹ä¸­çš„å€¼æ˜¯ä¸€ç»„Bitmapï¼Œç›¸åŒå­—èŠ‚æ•°çš„Bitmap å­˜åœ¨ä¸€ä¸ªListä¸­ï¼ˆè¿™æ ·è®¾è®¡çš„ç›®çš„æ˜¯ï¼Œå°†Lruç­–ç•¥è¿ç”¨åœ¨Bitmapå¤§å°ä¸Šï¼Œè€Œä¸æ˜¯å•ä¸ªBitmapä¸Šï¼‰ï¼Œæ§åˆ¶BitmapPoolå¤§å°é€šè¿‡åˆ é™¤æ•°æ®ç»„ä¸­æœ€åä¸€ä¸ªBitmapã€‚ BitmapPool å¤§éƒ¨åˆ†ç”¨äºBitmapå˜æ¢å’ŒgifåŠ è½½æ—¶ ArrayPool æ˜¯ä¸€ä¸ªé‡‡ç”¨Lruç­–ç•¥çš„æ•°ç»„æ± ï¼Œç”¨äºè§£ç æ—¶å€™çš„å­—èŠ‚æ•°ç»„çš„å¤ç”¨ã€‚ æ¸…ç†å†…å­˜æ„å‘³ç€æ¸…ç†MemoryCacheï¼ŒBitmapPool,ArrayPool ç¼“å­˜é»˜è®¤æƒ…å†µä¸‹ï¼ŒGlide ä¼šåœ¨å¼€å§‹ä¸€ä¸ªæ–°çš„å›¾ç‰‡è¯·æ±‚ä¹‹å‰æ£€æŸ¥ä»¥ä¸‹å¤šçº§çš„ç¼“å­˜ï¼š æ´»åŠ¨èµ„æº (Active Resources) - ç°åœ¨æ˜¯å¦æœ‰å¦ä¸€ä¸ª View æ­£åœ¨å±•ç¤ºè¿™å¼ å›¾ç‰‡ï¼Ÿ å†…å­˜ç¼“å­˜ (Memory cache) - è¯¥å›¾ç‰‡æ˜¯å¦æœ€è¿‘è¢«åŠ è½½è¿‡å¹¶ä»å­˜åœ¨äºå†…å­˜ä¸­ï¼Ÿ èµ„æºç±»å‹ï¼ˆResourceï¼‰ - è¯¥å›¾ç‰‡æ˜¯å¦ä¹‹å‰æ›¾è¢«è§£ç ã€è½¬æ¢å¹¶å†™å…¥è¿‡ç£ç›˜ç¼“å­˜ï¼Ÿ æ•°æ®æ¥æº (Data) - æ„å»ºè¿™ä¸ªå›¾ç‰‡çš„èµ„æºæ˜¯å¦ä¹‹å‰æ›¾è¢«å†™å…¥è¿‡æ–‡ä»¶ç¼“å­˜ï¼Ÿ åœ¨ Glide v4 é‡Œï¼Œæ‰€æœ‰ç¼“å­˜é”®éƒ½åŒ…å«è‡³å°‘ä¸¤ä¸ªå…ƒç´  æ´»åŠ¨èµ„æºï¼Œå†…å­˜ç¼“å­˜ï¼Œèµ„æºç£ç›˜ç¼“å­˜çš„ç¼“å­˜é”®è¿˜åŒ…å«ä¸€äº›å…¶ä»–æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š å¿…é€‰ï¼šModel å¯é€‰ï¼šç­¾å å®½åº¦å’Œé«˜åº¦ å¯é€‰çš„å˜æ¢ï¼ˆTransformationï¼‰ é¢å¤–æ·»åŠ çš„ä»»ä½• é€‰é¡¹(Options) è¯·æ±‚çš„æ•°æ®ç±»å‹ (Bitmap, GIF, æˆ–å…¶ä»–) ç£ç›˜ç¼“å­˜ç­–ç•¥ å¦‚æœç¼“å­˜ç­–ç•¥æ˜¯AUTOMATICï¼ˆé»˜è®¤ï¼‰ï¼Œå¯¹äºç½‘ç»œå›¾ç‰‡åªç¼“å­˜åŸå§‹æ•°æ®ï¼ŒåŠ è½½æœ¬åœ°èµ„æºæ˜¯å­˜å‚¨å˜æ¢è¿‡çš„æ•°æ®ï¼Œå¦‚æœåŠ è½½ä¸åŒå°ºå¯¸çš„å›¾ç‰‡ï¼Œåˆ™ä¼šè·å–åŸå§‹ç¼“å­˜å¹¶åœ¨æ­¤åŸºç¡€ä¸Šåšå˜æ¢ã€‚ å¦‚æœç¼“å­˜ç­–ç•¥æ˜¯ALLï¼Œä¼šç¼“å­˜åŸå§‹å›¾ç‰‡ä»¥åŠæ¯ä¸ªå°ºå¯¸çš„å‰¯æœ¬ï¼Œ å¦‚æœç¼“å­˜ç­–ç•¥æ˜¯SOURCE,åªä¼šç¼“å­˜å˜æ¢è¿‡çš„èµ„æºï¼Œå¦‚æœå¦ä¸€ä¸ªç•Œé¢æ¢ä¸€ä¸ªå°ºå¯¸æ˜¾ç¤ºå›¾ç‰‡ï¼Œåˆ™ä¼šé‡æ–°æ‹‰å–ç½‘ç»œ å¯é€šè¿‡è‡ªå®šä¹‰Keyå®ç°æ“æ§ç¼“å­˜å‘½ä¸­ç­–ç•¥ï¼ˆæ··å…¥è‡ªå·±çš„å€¼ï¼Œæ¯”å¦‚ä¿®æ”¹æ—¶é—´ï¼‰ å†…å­˜ç¼“å­˜ å†…å­˜ç¼“å­˜åˆ†ä¸ºä¸¤çº§ æ´»è·ƒå›¾ç‰‡ ActiveResource ä½¿ç”¨HashMapå­˜å‚¨æ­£åœ¨ä½¿ç”¨èµ„æºçš„å¼±å¼•ç”¨ èµ„æºè¢«åŒ…è£…æˆå¸¦å¼•ç”¨è®¡æ•°çš„EngineResourceï¼Œæ ‡è®°å¼•ç”¨èµ„æºçš„æ¬¡æ•°ï¼ˆå½“å¼•ç”¨æ•°ä¸ä¸º0æ—¶é˜»æ­¢è¢«å›æ”¶æˆ–é™çº§ï¼Œé™çº§å³æ˜¯å­˜å‚¨åˆ°LruCacheä¸­ï¼‰ è¿™ä¸€çº§ç¼“å­˜æ²¡æœ‰å¤§å°é™åˆ¶ï¼Œæ‰€ä»¥ä½¿ç”¨äº†èµ„æºçš„å¼±å¼•ç”¨ å­˜ï¼šæ¯å½“ä¸‹è½½èµ„æºåä¼šåœ¨onEngineJobComplete()ä¸­å­˜å…¥ActiveResourceï¼Œæˆ–è€…LruCacheå‘½ä¸­åï¼Œå°†èµ„æºä»ä¸­LruCacheç§»é™¤å¹¶å­˜å…¥ActiveResourceã€‚ å–ï¼šæ¯å½“èµ„æºé‡Šæ”¾æ—¶ï¼Œä¼šé™çº§åˆ°LruCacheä¸­ï¼ˆè¯·æ±‚å¯¹åº”çš„context onDestroyäº†æˆ–è€…è¢«gcäº†ï¼‰ å¼€ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œç›‘å¬ReferenceQueueï¼Œä¸åœåœ°ä»ä¸­è·å–è¢«gcçš„èµ„æºï¼Œå°†å…¶ä»ActiveResourceä¸­ç§»é™¤ï¼Œå¹¶é‡æ–°æ„å»ºä¸€ä¸ªæ–°èµ„æºå°†å…¶é™çº§ä¸ºLruCache ActiveResourceæ˜¯ä¸ºäº†ç¼“è§£LruCacheä¸­ç¼“å­˜é€ æˆå‹åŠ›ï¼Œå› ä¸ºLruCacheä¸­æ²¡æœ‰å‘½ä¸­çš„ç¼“å­˜åªæœ‰ç­‰åˆ°å®¹é‡è¶…é™æ—¶æ‰ä¼šè¢«æ¸…é™¤ï¼Œå¼ºå¼•ç”¨å³ä½¿å†…å­˜åƒç´§ä¹Ÿä¸ä¼šè¢«gcï¼Œç°åœ¨å½“LruCacheå‘½ä¸­åç§»åˆ°ActiveResourceï¼Œå¼±å¼•ç”¨æŒæœ‰ï¼Œå½“å†…å­˜åƒç´§æ—¶èƒ½è¢«å›æ”¶ã€‚ LruCache ä½¿ç”¨ LinkedHashMap å­˜å‚¨ä»æ´»è·ƒå›¾ç‰‡é™çº§çš„èµ„æºï¼Œä½¿ç”¨Lruç®—æ³•æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ å­˜ï¼šä»æ´»è·ƒå›¾ç‰‡é™çº§çš„èµ„æºï¼ˆé€€å‡ºå½“å‰ç•Œé¢ï¼Œæˆ–è€…ActiveResourceèµ„æºè¢«å›æ”¶ï¼‰ å–ï¼šç½‘ç»œè¯·æ±‚èµ„æºä¹‹å‰ï¼Œä»ç¼“å­˜ä¸­å–ï¼Œè‹¥å‘½ä¸­åˆ™ç›´æ¥ä»LruCacheä¸­ç§»é™¤äº†ã€‚ å†…å­˜ç¼“å­˜åªä¼šç¼“å­˜ç»è¿‡è½¬æ¢åçš„å›¾ç‰‡ å†…å­˜ç¼“å­˜é”®æ ¹æ®10å¤šä¸ªå‚æ•°ç”Ÿæˆï¼Œurlï¼Œå®½é«˜ ç£ç›˜ç¼“å­˜ ä¼šå°†æºæ•°æ®æˆ–ç»è¿‡å˜æ¢çš„æ•°æ®å­˜å‚¨åœ¨ç£ç›˜ï¼Œåœ¨å†…å­˜ä¸­ç”¨LinkedHashMapè®°å½•ä¸€ç»„Entryï¼ŒEntryå†…éƒ¨åŒ…å«ä¸€ç»„æ–‡ä»¶ï¼Œæ–‡ä»¶åå³æ˜¯keyï¼Œå¹¶ä¸”æœ‰å¼€å¯åå°çº¿ç¨‹æ‰§è¡Œåˆ é™¤æ–‡ä»¶æ“ä½œä»¥æ§åˆ¶ç£ç›˜ç¼“å­˜å¤§å°ã€‚ å†™ç£ç›˜ç¼“å­˜å³æ˜¯è§¦å‘Writerå°†æ•°æ®å†™å…¥ç£ç›˜ï¼Œå¹¶åœ¨å†…å­˜æ„å»ºå¯¹åº”çš„Fileç¼“å­˜åœ¨LinkedHashMapä¸­ æ ¹æ®ç¼“å­˜ç­–ç•¥çš„ä¸åŒï¼Œå¯èƒ½å­˜å‚¨æºæ•°æ®å’Œç»è¿‡å˜æ¢çš„æ•°æ®ã€‚ æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸ æ„é€ RequestManageræ—¶ä¼ å…¥contextï¼Œå¯ä»¥æ˜¯appçš„ï¼Œactivityçš„ï¼Œæˆ–è€…æ˜¯viewçš„ å‘ç•Œé¢æ·»åŠ æ— ç•Œé¢Fragmentï¼ˆSupportRequestManagerFragmentï¼‰ï¼ŒFragmentæŠŠç”Ÿå‘½å‘¨æœŸä¼ é€’ç»™Lifecycleï¼ŒFragmentæŒæœ‰RequestManagerï¼ŒRequestManagerç›‘å¬Lifecycleï¼ŒRequestManagerå‘RequestTrackerä¼ é€’ç”Ÿå‘½å‘¨æœŸä»¥æš‚åœåŠ è½½ï¼ŒRequestTrackeréå†æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ï¼Œå¹¶æš‚åœä»–ä»¬ï¼ˆç§»é™¤å›è°ƒresourceReadyå›è°ƒï¼‰ å½“ç»‘å®šcontext destroyæ—¶ï¼ŒRequestManagerä¼šå°†è¯¥äº‹ä»¶ä¼ é€’ç»™RequestTrackerï¼Œç„¶åè§¦å‘è¯¥è¯·æ±‚Resourceçš„clearï¼Œå†è°ƒç”¨Engine.releaseï¼Œå°†resourceé™çº§åˆ°LruCache é€šè¿‡HashMapç»“æ„ä¿å­˜æ— ç•Œé¢Fragmentä»¥é¿å…é‡å¤åˆ›å»º å–æ¶ˆè¯·æ±‚é€šè¿‡ç§»é™¤å›è°ƒï¼Œè®¾ç½®å–æ¶ˆæ ‡å¿—ä½å®ç°ï¼šæ— æ³•å–æ¶ˆå·²ç»å‘å‡ºçš„è¯·æ±‚ï¼Œä¼šåœ¨DecodeJobçš„å¼‚æ­¥ä»»åŠ¡çš„run()æ–¹æ³•ä¸­åˆ¤æ–­ï¼Œå¦‚æœcancelï¼Œåˆ™è¿”å›ã€‚ç§»é™¤å„ç§å›è°ƒï¼Œä¼šä¼ é€’åˆ°DataFetcherï¼ŒhttpUrlConnection è¯»å–æ•°æ®åä¼šåˆ¤æ–­æ˜¯å¦cancelï¼Œå¦‚æœæ˜¯åˆ™è¿”å›nullã€‚å¹¶æ²¡æœ‰æ–­å¼€é“¾æ¥ æ„ŸçŸ¥ç½‘ç»œå˜åŒ– é€šè¿‡ ConnectivityManager ç›‘å¬ç½‘ç»œå˜åŒ–ï¼Œå½“ç½‘ç»œæ¢å¤æ—¶ï¼Œéå†è¯·æ±‚åˆ—è¡¨ï¼Œå°†æ²¡æœ‰å®Œæˆçš„ä»»åŠ¡ç»§ç»­å¼€å§‹ Transformation æ‰€æœ‰çš„BitmapTransformation éƒ½æ˜¯ä»BitmapPool æ‹¿åˆ°ä¸€ä¸ªbitmapï¼Œç„¶åå°†åœ¨åŸæœ‰bitmapåŸºç¡€ä¸Šåº”ç”¨ä¸€ä¸ªmatrixå†ç”»åˆ°æ–°bitmapä¸Šã€‚ å˜æ¢ä¹Ÿæ˜¯ä¸€ä¸ªkeyï¼Œç”¨ä»¥åœ¨ç¼“å­˜çš„æ—¶å€™åšåŒºåˆ« RecycleViewå›¾ç‰‡é”™ä¹± å¼‚æ­¥ä»»åŠ¡+è§†å›¾å¤ç”¨å¯¼è‡´ è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®å ä½å›¾+å›æ”¶è¡¨é¡¹æ—¶å–æ¶ˆå›¾ç‰‡åŠ è½½ï¼ˆæˆ–è€…æ–°å¾—åŠ è½½å¼€å§‹æ—¶å–æ¶ˆæ—§çš„åŠ è½½ï¼‰+imageviewåŠ tagåˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±çš„å›¾ç‰‡å¦‚æœä¸æ˜¯åˆ™å…ˆè°ƒç”¨clear Glide ç¼“å­˜å¤±æ•ˆ æ˜¯å› ä¸º Key å‘ç”Ÿå˜åŒ–ï¼ŒUrlæ˜¯ç”Ÿæˆkeyçš„ä¾æ®ï¼ŒUrlå¯èƒ½å‘ç”Ÿå˜åŒ–æ¯”å¦‚æŠŠtokenè¿½åŠ åœ¨åé¢ è‡ªå®šä¹‰ç”Ÿæˆkeyçš„æ–¹å¼ï¼Œç»§æ‰¿GlideUrlé‡å†™getCacheKey() è‡ªå®šä¹‰åŠ è½½ å®šä¹‰ä¸€ä¸ªModelç±»ç”¨äºåŒ…è£…éœ€è¦åŠ è½½çš„æ•°æ® å®šä¹‰ä¸€ä¸ªKeyçš„å®ç°ç±»ï¼Œç”¨äºå®ç°ç¬¬ä¸€æ­¥çš„Modelä¸­çš„æ•°æ®çš„ç­¾åç”¨äºåŒºåˆ†ç¼“å­˜ å®šä¹‰ä¸€ä¸ªDataFetcherçš„å®ç°ç±»ï¼Œç”¨äºå‘Šè¯‰GlideéŸ³é¢‘å°é¢å¦‚ä½•åŠ è½½ï¼Œå¹¶æŠŠåŠ è½½ç»“æœå›è°ƒå‡ºå» å®šä¹‰ä¸€ä¸ªModelLoaderçš„å®ç°ç±»ç”¨äºåŒ…è£…DataFetcher å®šä¹‰ä¸€ä¸ªModelLoaderFactoryçš„å®ç°ç±»ç”¨äºç”ŸæˆModelLoaderå®ä¾‹ å°†è‡ªå®šä¹‰åŠ è½½é…ç½®åˆ°AppGlideModuleä¸­ Glideçº¿ç¨‹æ±  ç£ç›˜ç¼“å­˜çº¿ç¨‹æ± ï¼Œä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼šç”¨äºioå›¾ç‰‡ç¼–ç  åŠ è½½èµ„æºçº¿ç¨‹æ± ï¼Œæœ€å¤šä¸è¶…è¿‡4ä¸ªæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œç”¨äºå¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œå›¾ç‰‡è§£ç è½¬ç  åŠ¨ç”»çº¿ç¨‹æ± ï¼Œæœ€å¤šä¸è¶…è¿‡2ä¸ªçº¿ç¨‹ ç£ç›˜ç¼“å­˜æ¸…ç†çº¿ç¨‹æ±  ActiveResource å¼€å¯ä¸€ä¸ªåå°çº¿ç¨‹ç›‘å¬ReferenceQueue æ‰€æœ‰çº¿ç¨‹æ± éƒ½é»˜è®¤é‡‡ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ— åŠ è½½Gifæµç¨‹è¯»å–æµçš„å‰ä¸‰ä¸ªå­—èŠ‚ï¼Œè‹¥åˆ¤æ–­æ˜¯gifï¼Œåˆ™ä¼šå‘½ä¸­gifè§£ç å™¨-å°†èµ„æºè§£ç æˆGifDrawableï¼Œå®ƒæŒæœ‰GifFrameLoaderä¼šå°†èµ„æºè§£ç æˆä¸€å¼ å¼ Bitmapå¹¶ä¸”ä¼ é€’ç»™DelayTargetçš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ¯æ¬¡èµ„æºåŠ è½½å®Œæ¯•éƒ½ä¼šé€šè¿‡handlerå‘é€å»¶è¿Ÿæ¶ˆæ¯å›è°ƒ onFrameReady() ä»¥è§¦å‘GifDrawable.invalidataSelf()é‡ç»˜ã€‚åŠ è½½ä¸‹ä¸€å¸§æ—¶ä¼šé‡æ–°æ„å»ºDelayTarget è¯·æ±‚ä¼˜å…ˆçº§é€šè¿‡ç»™åŠ è½½çº¿ç¨‹æ± é…ç½®ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ŒåŠ è½½ä»»åŠ¡DecodeJob å®ç°äº† compareTo æ–¹æ³•ï¼Œå°†priorityç›¸å‡ å›¾ç‰‡åŠ è½½ä¼˜åŒ– æœåŠ¡å™¨å­˜å¤šç§å°ºå¯¸çš„å›¾ç‰‡ è‡ªå®šä¹‰ AppGlideModuleï¼ŒæŒ‰è®¾å¤‡æ€§èƒ½å¥½åè®¾å®šMemoryCategory.HIGH,LOW,NORMALï¼Œå†…å­˜ç¼“å­˜å’ŒbitmapPoolçš„å¤§å°ç³»æ•°ï¼Œä»¥åŠå›¾ç‰‡è§£ç æ ¼å¼ï¼ŒARGB_8888ï¼ŒRGB_565 RecyclerView åœ¨onViewRecycled ä¸­è°ƒç”¨clear ï¼Œå› ä¸ºrecyclerViewä¼šé»˜è®¤ä¼šç¼“å­˜5ä¸ªåŒç±»è¡¨é¡¹ï¼Œå¦‚æœç±»å‹å¾ˆå¤šï¼Œå†…å­˜ä¸­ä¼šæŒæœ‰è¡¨é¡¹ï¼Œå¦‚æœè¿™äº›è¡¨é¡¹éƒ½åŒ…å«å›¾ç‰‡ï¼ŒGlide çš„ActiveResourceä¼šè†¨èƒ€ã€‚å¯¼è‡´gc å¦‚æœ RecyclerView åŒ…å«ä¸€ä¸ªå¾ˆé•¿çš„itemViewï¼Œè¶…è¿‡ä¸€å±ï¼Œå…¶ä¸­åŒ…å«å¾ˆå¤šç…§ç‰‡ï¼Œæœ€å¥½æŠŠé•¿itemViewæ‹†æˆå¤šä¸ªitemView ä½¿ç”¨thumbnailï¼ŒåŠ è½½ä¸€ä¸ªç¼©ç•¥å›¾ï¼Œæœ€å¥½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é“¾æ¥ï¼Œå¦‚æœæ˜¯æœ¬åœ°çš„ä¹Ÿä¸å·® ä½¿ç”¨preloadï¼Œå°†èµ„æºæå‰åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ å¤§éƒ¨åˆ†æƒ…å†µä¸‹ RESOURCE ï¼Œå³ç¼“å­˜ç»è¿‡å˜æ¢çš„å›¾ç‰‡ä¸Šæ˜¯æœ€å¥½é€‰æ‹©ï¼ŒèŠ‚çº¦å†…å­˜å’Œç£ç›˜ã€‚å¯¹äºgifèµ„æºåªç¼“å­˜åŸå§‹èµ„æºDATAï¼Œå› ä¸ºgifæ˜¯å¤šå¼ å›¾æ¯æ¬¡ç¼–ç è§£ç åè€Œè€—æ—¶ ä½¿ç”¨Glideå®ç°å˜æ¢ï¼Œå› ä¸ºæœ‰BitmapPoolä¾›å¤ç”¨","link":"/2021/09/30/Glide/"},{"title":"Generics","text":"Javaæ³›å‹ç®€è¿°ï¼š ç†è§£çš„æ³›å‹ï¼Œå…¶å®æ˜¯è¿™æ ·çš„ï¼šå‡å¦‚æ²¡æœ‰æ³›å‹ï¼Œå‡ºç°åœ¨æ³›å‹ç±»å‹ä½ç½®çš„å°±ä¼šæ˜¯Objectç±»ï¼Œè€Œç¨‹åºå‘˜åœ¨ä½¿ç”¨è¯¥ç±»å‹çš„æ—¶å€™å†æ‰‹åŠ¨å°†ç±»å‹å¼ºè½¬ä¸€ä¸‹ï¼Œä¸ä»…ä»£ç å•°å—¦ã€è€Œä¸”æœ‰ç±»å‹ä¸åŒ¹é…çš„crashå¯èƒ½ã€‚ è€Œjava1.5æä¾›æ³›å‹åŒæ—¶ä¸ºäº†å…¼å®¹æ—§ç‰ˆï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ç”¨äº†Objectï¼Œåªä¸è¿‡ç¼–è¯‘å™¨å°†.javaç¼–è¯‘æˆ.classæ—¶è¿›è¡Œâ€œæ³›å‹æ“¦é™¤â€æ—¶ä¼šæŠŠæ³›å‹ç±»å‹æ›¿ä»£æˆObjectæˆ–ä¸Šé™ç±»å‹ï¼ˆå­—èŠ‚ç ä¸­å°±ä¸å­˜åœ¨æ³›å‹äº†ï¼‰ï¼Œå†è‡ªåŠ¨åœ°ä½¿ç”¨å¤„å‰åŠ ä¸ŠåŸå§‹ç±»å‹çš„å¼ºè½¬ï¼Œä¹‹åå†åŠ è½½åˆ°JVMä¸­ã€‚è€Œåœ¨ç¼–è¯‘æœŸå­˜åœ¨çš„æ³›å‹å¯ä»¥å€Ÿç”±IDEæœ‰æ•ˆçš„è¿›è¡Œç±»å‹æ£€æµ‹å’Œå¯è¯»çš„æ‰©å±•ï¼Œé˜²æ­¢ç±»å‹ä¸åŒ¹é…ã€‚ //javaä¼ªæ³›å‹çš„è®¾è®¡åŸå› ä¸»è¦ä¸ºäº†å…¼å®¹è€ç‰ˆæœ¬çš„javaã€‚çœŸæ³›å‹å¹¶éåšä¸åˆ°ï¼Œè€Œæ˜¯å› ä¸ºå¦‚æœç”¨çœŸæ³›å‹ï¼ˆå³ç±»å‹ä¿ç•™ï¼‰ï¼Œè€ç¨‹åºéƒ½éœ€è¦ä¿®æ”¹ã€‚ //å¦å¤–æ³›å‹ç±»ä¸­åŸºç¡€æ•°æ®ç±»å‹éœ€è¦ä½¿ç”¨Integerã€Longç­‰å°è£…ç±»çš„åŸå› ä¹Ÿæ˜¯å› ä¸ºâ€œæ“¦é™¤åä¼šæŠŠæ³›å‹ç±»å‹æ›¿ä»£æˆObjectæˆ–ä¸Šé™ç±»å‹â€ è€Œkotlinçš„æ³›å‹æ˜¯è·Ÿjavaä¸€æ ·çš„ï¼Œåœ¨ç¼–è¯‘æ—¶ä¼šè¢«æ“¦é™¤ã€‚ä½†æ˜¯kotlinæä¾›äº†æ–°çš„ç‰¹æ€§å¯ä»¥ä¿ç•™ç±»å‹ï¼Œå°±æ˜¯**å†…è”å‡½æ•°+reified(ËˆriËÉªfÊŒÉª/)**ï¼Œæ³›å‹å®åŒ–ï¼Œå¯ä»¥è¯´æ˜¯çœŸæ³›å‹ï¼šå†…è”å‡½æ•°(inline)ä¼šæŠŠæ–¹æ³•ä½“copyåˆ°è°ƒç”¨å¤„ï¼ˆå³ä¸ä¼šåˆ›å»ºæ–°çš„è™šæ‹Ÿæœºæ ˆå¸§ï¼‰ï¼Œ 123inline fun &lt;reified C : Activity&gt; Context.startActivityKtx() { startActivity(Intent(this, C::class.java))} åå˜ï¼šâ‘ åå˜ï¼šçˆ¶å­å…³ç³»ä¸€è‡´â†’å­ç±»ä¹Ÿå¯ä»¥ä½œä¸ºå‚æ•°ä¼ è¿›æ¥â†’java&lt;? extends Entity&gt;â†’ä¸Šç•Œé€šé…ç¬¦â†’kotlin&lt;out Entity&gt; é€†å˜ï¼šâ‘¡é€†å˜ï¼šçˆ¶å­å…³ç³»é¢ å€’â†’çˆ¶ç±»ä¹Ÿå¯ä»¥ä½œä¸ºå‚æ•°ä¼ è¿›æ¥â†’java&lt;? super Article&gt;â†’ä¸‹ç•Œé€šé…ç¬¦â†’kotlin&lt;in Entiry&gt; ä¸å˜ï¼šâ‘¢ä¸å˜ï¼šåªèƒ½ æ— é™é€šé…ç¬¦&lt;?&gt; == java &lt;? extend Object&gt; == kotlin&lt;*&gt; == kotlin&lt;out Any&gt; ä¸å˜æ¯”å¦‚ï¼š 12345/** * æ”¯æŒæ·»åŠ å’Œåˆ é™¤å…ƒç´ çš„é€šç”¨æœ‰åºå…ƒç´ é›†åˆã€‚ * å‚æ•°ï¼š * E - åˆ—è¡¨ä¸­åŒ…å«çš„å…ƒç´ çš„ç±»å‹ã€‚å¯å˜åˆ—è¡¨çš„å…ƒç´ ç±»å‹æ˜¯ä¸å˜çš„ã€‚ */public interface MutableList&lt;E&gt; : List&lt;E&gt;, MutableCollection&lt;E&gt; åå˜æ¯”å¦‚ï¼š 123456/** * é€šç”¨çš„æœ‰åºå…ƒç´ é›†åˆã€‚è¯¥æ¥å£ä¸­çš„æ–¹æ³•ä»…æ”¯æŒå¯¹åˆ—è¡¨çš„åªè¯»è®¿é—®ï¼›é€šè¿‡MutableListæ¥å£æ”¯æŒè¯»/å†™è®¿é—®ã€‚ * å‚æ•°ï¼š * E - åˆ—è¡¨ä¸­åŒ…å«çš„å…ƒç´ çš„ç±»å‹ã€‚è¯¥åˆ—è¡¨çš„å…ƒç´ ç±»å‹æ˜¯åå˜çš„ã€‚ */public interface Collection&lt;out E&gt; : Iterable&lt;E&gt; ä¸æ™®é€šçš„ Object ä»£æ›¿ä¸€åˆ‡ç±»å‹è¿™æ ·ç®€å•ç²—æš´è€Œè¨€ï¼Œ ç®€è¿°ï¼šæ³›å‹æä¾›äº†å¯ä»¥ä½¿ç±»å‹åƒå‚æ•°ä¸€æ ·ç”±å¤–éƒ¨ä¼ é€’è¿›æ¥çš„æ‰©å±•èƒ½åŠ›ï¼ŒåŒæ—¶è¿˜æä¾›äº†ç¼–è¯‘æ—¶çš„ç±»å‹æ£€æµ‹æœºåˆ¶ï¼Œå³å½“ä¼ å…¥æ•°æ®ç±»å‹ä¸ºæ³›å‹ æ—¶æ‰èƒ½ç¼–è¯‘é€šè¿‡ï¼Œæé«˜äº†å¯è¯»æ€§ã€‚ ä½†å‡ºäºè§„èŒƒçš„ç›®çš„ï¼ŒJava è¿˜æ˜¯å»ºè®®æˆ‘ä»¬ç”¨å•ä¸ªå¤§å†™å­—æ¯æ¥ä»£è¡¨ç±»å‹å‚æ•°ã€‚å¸¸è§çš„å¦‚ï¼š T ä»£è¡¨ä¸€èˆ¬çš„ä»»ä½•ç±»ã€‚E ä»£è¡¨ Element çš„æ„æ€ï¼Œæˆ–è€… Exception å¼‚å¸¸çš„æ„æ€ã€‚K ä»£è¡¨ Key çš„æ„æ€ã€‚V ä»£è¡¨ Value çš„æ„æ€ï¼Œé€šå¸¸ä¸ K ä¸€èµ·é…åˆä½¿ç”¨ã€‚S ä»£è¡¨ Subtype çš„æ„æ€ï¼Œæ–‡ç« åé¢éƒ¨åˆ†ä¼šè®²è§£ç¤ºæ„ã€‚ æ³›å‹å¯ä»¥ä¸ºç±»å’Œæ–¹æ³•åˆ†åˆ«å®šä¹‰æ³›å‹å‚æ•°ï¼Œ æ³›å‹ç±»ï¼š 1234//å°–æ‹¬å· &lt;&gt;ä¸­çš„ T è¢«ç§°ä½œæ˜¯ç±»å‹å‚æ•°ï¼Œç”¨äºæŒ‡ä»£ä»»ä½•ç±»å‹ã€‚äº‹å®ä¸Šï¼ŒT åªæ˜¯ä¸€ç§ä¹ æƒ¯æ€§å†™æ³•ï¼Œå¦‚æœä½ æ„¿æ„ã€‚ä½ å¯ä»¥è¿™æ ·å†™ã€‚public class Test&lt;T&gt; { T field1;} æ³›å‹æ–¹æ³•å§‹ç»ˆä»¥è‡ªå·±å®šä¹‰çš„ç±»å‹å‚æ•°ä¸ºå‡†ã€‚ é€šé…ç¬¦çš„å‡ºç°æ˜¯ä¸ºäº†æŒ‡å®šæ³›å‹ä¸­çš„ç±»å‹èŒƒå›´ã€‚ é€šé…ç¬¦æœ‰ 3 ç§å½¢å¼ã€‚ &lt;?&gt;è¢«ç§°ä½œæ— é™å®šçš„é€šé…ç¬¦ã€‚ &lt;? extends T&gt;è¢«ç§°ä½œæœ‰ä¸Šé™çš„é€šé…ç¬¦ã€‚ &lt;? super T&gt;è¢«ç§°ä½œæœ‰ä¸‹é™çš„é€šé…ç¬¦ã€‚ æ³›å‹ä¿¡æ¯åªå­˜åœ¨äºä»£ç ç¼–è¯‘é˜¶æ®µï¼Œåœ¨è¿›å…¥ JVM ä¹‹å‰ï¼Œä¸æ³›å‹ç›¸å…³çš„ä¿¡æ¯ä¼šè¢«æ“¦é™¤æ‰ï¼Œä¸“ä¸šæœ¯è¯­å«åšç±»å‹æ“¦é™¤ åœ¨æ³›å‹ç±»è¢«ç±»å‹æ“¦é™¤çš„æ—¶å€™ï¼Œä¹‹å‰æ³›å‹ç±»ä¸­çš„ç±»å‹å‚æ•°éƒ¨åˆ†å¦‚æœæ²¡æœ‰æŒ‡å®šä¸Šé™ï¼Œå¦‚ &lt;T&gt;åˆ™ä¼šè¢«è½¬è¯‘æˆæ™®é€šçš„ Object ç±»å‹ï¼Œå¦‚æœæŒ‡å®šäº†ä¸Šé™å¦‚ &lt;T extends String&gt;åˆ™ç±»å‹å‚æ•°å°±è¢«æ›¿æ¢æˆç±»å‹ä¸Šé™ã€‚ Javaè·å–æ³›å‹çš„classæ–¹æ³•ï¼šä¸€ï¼šåœ¨æ„é€ ç±»æ—¶ä¼ é€’æ³›å‹ç±»å‹å‚æ•°1234567891011121314class MyClass&lt;T&gt; { private Class&lt;T&gt; type; public MyClass(Class&lt;T&gt; type) { this.type = type; }}public class Main { public static void main(String[] args) { MyClass&lt;String&gt; myObj = new MyClass&lt;&gt;(String.class); myObj.printType(); // Output: Type: java.lang.String }} äºŒï¼šåå°„è·å–123456789class MyClass&lt;T&gt; { public void printType() { Type superclass = getClass().getGenericSuperclass(); if (superclass instanceof ParameterizedType) { Type[] typeArguments = ((ParameterizedType) superclass).getActualTypeArguments(); typeArguments[0]//æ³›å‹ç±»å‹å¯èƒ½å¤šä¸ª } }} åŒ¿åå†…éƒ¨ç±»åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±ä¼šç»‘å®šçˆ¶ç±»æˆ–è€…çˆ¶æ¥å£çš„ä¿¡æ¯ï¼Œè¿™æ ·å°±èƒ½é€šè¿‡è·å–çˆ¶ç±»æˆ–çˆ¶æ¥å£çš„æ³›å‹ç±»å‹ä¿¡æ¯ï¼Œæ¥å®ç°æˆ‘ä»¬çš„éœ€æ±‚ å¦‚Gsonä¸­çš„TypeTokenæˆ–FastJsonä¸­çš„TypeReferenceï¼Œä½¿ç”¨åˆ›å»ºç»§æ‰¿äºç‰¹å®šæŠ½è±¡ç±»çš„åŒ¿åå†…éƒ¨ç±»å¯¹è±¡è·å¾— kotlin æ³›å‹Kotlin æ³›å‹ç³»ç»Ÿç»§æ‰¿äº Javaæ³›å‹ï¼Œä¾ç„¶æ˜¯ä¸€ç§è¯­æ³•ç³–çš„ä¼ªæ³›å‹ï¼Œä¼šåœ¨ç¼–è¯‘æ—¶å‘ç”Ÿç±»å‹æ“¦é™¤ã€‚ä½†å¯ä»¥é€šè¿‡inline+reifiedå®ç°æ³›å‹å®åŒ–çš„çœŸæ³›å‹ Inline+reified æ³›å‹å®åŒ–çš„åŸç†ï¼šæˆ‘ä»¬éƒ½çŸ¥é“å†…è”å‡½æ•°çš„åŸç†ï¼Œç¼–è¯‘å™¨æŠŠå®ç°å†…è”å‡½æ•°çš„å­—èŠ‚ç åŠ¨æ€æ’å…¥åˆ°æ¯æ¬¡çš„è°ƒç”¨ç‚¹ã€‚é‚£ä¹ˆå®åŒ–çš„åŸç†æ­£æ˜¯åŸºäºè¿™ä¸ªæœºåˆ¶ï¼Œæ¯æ¬¡è°ƒç”¨å¸¦å®åŒ–ç±»å‹å‚æ•°çš„å‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨éƒ½çŸ¥é“æ­¤æ¬¡è°ƒç”¨ä¸­ä½œä¸ºæ³›å‹ç±»å‹å®å‚çš„å…·ä½“ç±»å‹ã€‚æ‰€ä»¥ç¼–è¯‘å™¨åªè¦åœ¨æ¯æ¬¡è°ƒç”¨æ—¶ç”Ÿæˆå¯¹åº”ä¸åŒç±»å‹å®å‚è°ƒç”¨çš„å­—èŠ‚ç æ’å…¥åˆ°è°ƒç”¨ç‚¹å³å¯ã€‚ æ€»ä¹‹ä¸€å¥è¯å¾ˆç®€å•ï¼Œå°±æ˜¯å¸¦å®åŒ–å‚æ•°çš„å‡½æ•°æ¯æ¬¡è°ƒç”¨éƒ½ç”Ÿæˆä¸åŒç±»å‹å®å‚çš„å­—èŠ‚ç ï¼ŒåŠ¨æ€æ’å…¥åˆ°è°ƒç”¨ç‚¹ã€‚ç”±äºç”Ÿæˆçš„å­—èŠ‚ç çš„ç±»å‹å®å‚å¼•ç”¨äº†å…·ä½“çš„ç±»å‹ï¼Œè€Œä¸æ˜¯ç±»å‹å‚æ•°æ‰€ä»¥ä¸ä¼šå­˜åœ¨æ“¦é™¤é—®é¢˜ã€‚ ç®€è¿°ï¼šç”±äºinlineçš„å­˜åœ¨ï¼Œæ³›å‹ç±»å‹å®å‚çš„è°ƒç”¨å¤„åœ¨åŒä¸€ä¸ªæ–¹æ³•ä½“å†…ï¼Œç›¸å½“äºç›´æ¥çŸ¥é“äº†ç±»å‹ï¼Œæ‰€ä»¥åªè¦ç¼–è¯‘æ—¶ç›´æ¥ç”Ÿæˆå¯¹åº”çš„ä¸åŒç±»å‹å®å‚å³å¯ å®åŒ–ç±»å‹å‚æ•°å‡½æ•°çš„ä½¿ç”¨é™åˆ¶è¿™é‡Œè¯´çš„ä½¿ç”¨é™åˆ¶ä¸»è¦æœ‰ä¸¤ç‚¹: 1ã€Javaè°ƒç”¨Kotlinä¸­çš„å®åŒ–ç±»å‹å‚æ•°å‡½æ•°é™åˆ¶æ˜ç¡®å›ç­”Kotlinä¸­çš„å®åŒ–ç±»å‹å‚æ•°å‡½æ•°ä¸èƒ½åœ¨Javaä¸­çš„è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„åˆ†æä¸‹ï¼Œé¦–å…ˆKotlinçš„å®åŒ–ç±»å‹å‚æ•°å‡½æ•°ä¸»è¦å¾—ç›Šäºinlineå‡½æ•°çš„å†…è”åŠŸèƒ½ï¼Œä½†æ˜¯Javaå¯ä»¥è°ƒç”¨æ™®é€šçš„å†…è”å‡½æ•°ä½†æ˜¯å¤±å»äº†å†…è”åŠŸèƒ½ï¼Œå¤±å»å†…è”åŠŸèƒ½ä¹Ÿå°±æ„å‘³å®åŒ–æ“ä½œä¹Ÿå°±åŒ–ä¸ºæ³¡å½±ã€‚æ•…é‡ç”³ä¸€æ¬¡Kotlinä¸­çš„å®åŒ–ç±»å‹å‚æ•°å‡½æ•°ä¸èƒ½åœ¨Javaä¸­çš„è°ƒç”¨ 2ã€Kotlinå®åŒ–ç±»å‹å‚æ•°å‡½æ•°çš„ä½¿ç”¨é™åˆ¶ ä¸èƒ½ä½¿ç”¨éå®åŒ–ç±»å‹å½¢å‚ä½œä¸ºç±»å‹å®å‚è°ƒç”¨å¸¦å®åŒ–ç±»å‹å‚æ•°çš„å‡½æ•° ä¸èƒ½ä½¿ç”¨å®åŒ–ç±»å‹å‚æ•°åˆ›å»ºè¯¥ç±»å‹å‚æ•°çš„å®ä¾‹å¯¹è±¡ ä¸èƒ½è°ƒç”¨å®åŒ–ç±»å‹å‚æ•°çš„ä¼´ç”Ÿå¯¹è±¡æ–¹æ³• reifiedå…³é”®å­—åªèƒ½æ ‡è®°å®åŒ–ç±»å‹å‚æ•°çš„å†…è”å‡½æ•°ï¼Œä¸èƒ½ä½œç”¨ä¸ç±»å’Œå±æ€§ã€‚ æ³›å‹ç±»å‹è·å–æ–¹å¼åœ¨Kotlinä¸­å¯ä»¥é€šè¿‡ä¸‹è¿°æ–¹æ³•è·å–æ³›å‹çš„ç±»å‹ é€šè¿‡åŒ¿åå†…éƒ¨ç±»è·å¾—æ³›å‹å‚æ•°ç±»å‹å…·ä½“ç¤ºä¾‹ï¼š 1234567// Java ArrayList arrayList = new ArrayList&lt;String&gt;(){};System.out.println(arrayList.getClass().getGenericSuperclass());// Kotlinval clazz = object :ArrayList&lt;String&gt;(){}// Kotlin çš„åŒ¿åå†…éƒ¨ç±»println(clazz.javaClass.genericSuperclass) ä¸ºä»€ä¹ˆå¯ä»¥é€šè¿‡åŒ¿åå†…éƒ¨ç±»å¯ä»¥åœ¨è¿è¡ŒæœŸè·å¾—æ³›å‹å‚æ•°çš„ç±»å‹å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º æ³›å‹çš„ç±»å‹æ“¦é™¤å¹¶ä¸æ˜¯å®Œå…¨çš„å°†æ‰€æœ‰ä¿¡æ¯æ“¦é™¤ï¼Œè€Œä¼š å°†ç±»å‹ä¿¡æ¯æ”¾åœ¨æ‰€å± class çš„å¸¸é‡æ± ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç›¸åº”çš„æ–¹å¼è·å¾—ç±»å‹ä¿¡æ¯ï¼Œè€ŒåŒ¿åå†…éƒ¨ç±»å°±å¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚ Java å°†æ³›å‹ä¿¡æ¯å­˜å‚¨åœ¨ä½•å¤„ï¼šç±»ä¿¡æ¯çš„ç­¾åä¸­ã€‚ åŒ¿åå†…éƒ¨ç±»åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±ä¼šç»‘å®šçˆ¶ç±»æˆ–è€…çˆ¶æ¥å£çš„ä¿¡æ¯ï¼Œè¿™æ ·å°±èƒ½é€šè¿‡è·å–çˆ¶ç±»æˆ–çˆ¶æ¥å£çš„æ³›å‹ç±»å‹ä¿¡æ¯ï¼Œæ¥å®ç°æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå¯ä»¥é€šè¿‡åˆ©ç”¨æ­¤æ¥è®¾è®¡ä¸€ä¸ªè·å¾—æ‰€æœ‰ç±»å‹ä¿¡æ¯çš„æ³›å‹ç±»ï¼š 12345678910111213open class GenericsToken&lt;T&gt;{ var type : Type = Any::class.java init { val superClass = this.javaClass.genericSuperclass type = (superClass as ParameterizedType).actualTypeArguments[0] }}fun main(args: Array&lt;String&gt;) { // åˆ›å»ºä¸€ä¸ªåŒ¿åå†…éƒ¨ç±» val oneKt = object:GenericsToken&lt;Map&lt;String,String&gt;&gt;(){} println(oneKt.type)} æ‰“å°æ—¥å¿—ï¼š 1java.util.Map&lt;java.lang.String, ? extends java.lang.String&gt; è‡³äºå¦‚æœè·å¾—å‚æ•°åŒ–ç±»å‹ï¼Œå¯å‚è§æ­¤åšå®¢ï¼šParameterizedTypeåº”ç”¨ï¼Œjavaåå°„ï¼Œè·å–å‚æ•°åŒ–ç±»å‹çš„classå®ä¾‹ å…¶å®æ­£æ˜¯å› ä¸ºç±»å‹æ“¦é™¤çš„åŸå› ï¼Œåœ¨ä½¿ç”¨ Gson ååºåˆ—åŒ–å¯¹è±¡çš„æ—¶å€™é™¤äº†åˆ¶å®šæ³›å‹å‚æ•°ï¼Œè¿˜éœ€è¦ä¼ å…¥ä¸€ä¸ª class ï¼š 123public &lt;T&gt; T fromJson(String json, Class&lt;T&gt; classOfT) throws JsonSyntaxException { ... } å› ä¸º Gson æ²¡æœ‰åŠæ³•æ ¹æ® T ç›´æ¥å»ååºåˆ—åŒ–ï¼Œæ‰€ä»¥ Gson ä¹Ÿæ˜¯ä½¿ç”¨äº†ç›¸åŒçš„è®¾è®¡ï¼Œé€šè¿‡åŒ¿åå†…éƒ¨ç±»è·å¾—ç›¸åº”çš„ç±»å‹å‚æ•°ï¼Œç„¶åä¼ åˆ° fromJson ä¸­è¿›è¡Œååºåˆ—åŒ–ã€‚ çœ‹ä¸€ä¸‹åœ¨ Kotlin ä¸­æˆ‘ä»¬ä½¿ç”¨ Gson æ¥è¿›è¡Œæ³›å‹ç±»çš„ååºåˆ—åŒ–ï¼š 123val json = &quot;....&quot;val rType = object: TypeToken&lt;List&lt;String&gt;&gt;(){}.type// è·å¾—ååºåˆ—åŒ–çš„æ•°æ®ç±»å‹val stringList = Gson().fromJson&lt;List&lt;String&gt;&gt;(json,rType) å½“ç„¶å¯ä»¥ç›´æ¥ä¼ è¾“æ•°æ®ç±»å‹ï¼š 12// å­˜åœ¨å±€é™ï¼Œæ¯”å¦‚ä¸èƒ½ä¼ å…¥ List&lt;String&gt; çš„æ•°æ®ç±»å‹val stringList = Gson().fromJson&lt;String::class.java&gt;(json,rType) åœ¨ Kotlin ä¸­é™¤äº†ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»è·å¾—æ³›å‹å‚æ•°å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å†…è”å‡½æ•°æ¥è·å–ã€‚ ä½¿ç”¨å†…è”å‡½æ•°è·å–æ³›å‹çš„å‚æ•°ç±»å‹å†…è”å‡½æ•°çš„ç‰¹å¾ï¼š å†…è”å‡½æ•°(inline)åœ¨ç¼–è¯‘æ—¶ä¼šå°†å…·ä½“çš„å‡½æ•°å­—èŠ‚ç æ’å…¥è°ƒç”¨çš„åœ°æ–¹ï¼Œç±»å‹æ’å…¥ç›¸åº”çš„å­—èŠ‚ç ä¸­ï¼Œè¿™å°±æ„å‘³ç€æ³›å‹å‚æ•°ç±»å‹ä¹Ÿä¼šè¢«æ’å…¥åˆ°å­—èŠ‚ç ä¸­ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°åœ¨è¿è¡Œæ—¶å°±å¯ä»¥è·å¾—å¯¹åº”çš„å‚æ•°ç±»å‹äº†ã€‚ ä½¿ç”¨å†…è”å‡½æ•°è·å–æ³›å‹çš„å‚æ•°ç±»å‹ååˆ†çš„ç®€å•ï¼Œåªè¦åŠ ä¸Š reified å…³é”®å­—ï¼Œæ„æ€æ˜¯ï¼šåœ¨ç¼–è¯‘æ—¶ä¼šå°† å…·ä½“çš„ç±»å‹ æ’å…¥åˆ°ç›¸åº”çš„å­—èŠ‚ç ä¸­ï¼Œé‚£ä¹ˆå°±å¯ä»¥è·å¾—å¯¹åº”å‚æ•°çš„ç±»å‹ï¼Œä¸ Java ä¸­çš„æ³›å‹åœ¨ç¼–è¯‘å™¨è¿›è¡Œç±»å‹æ“¦é™¤ä¸åŒï¼ŒKotlin ä¸­ä½¿ç”¨ reified ä¿®é¥°æ³›å‹ï¼Œè¯¥æ³›å‹ç±»å‹ä¿¡æ¯ä¸ä¼šè¢«æŠ¹å»ï¼Œæ‰€ä»¥ Kotiln ä¸­çš„è¯¥æ³›å‹ä¸º çœŸæ³›å‹ã€‚ reified ä¸º Kotlin ä¸­çš„ä¸€ä¸ªå…³é”®å­—ï¼Œè¿˜æœ‰ä¸€ä¸ªå«åš inlineï¼Œåè€…å¯ä»¥å°†å‡½æ•°å®šä¹‰ä¸ºå†…è”å‡½æ•°ï¼Œå‰è€…å¯ä»¥å°†å†…è”å‡½æ•°çš„æ³›å‹å‚æ•°å½“åšçœŸå®ç±»å‹ä½¿ç”¨. å¯ä»¥å€Ÿæ­¤æ¥ä¸º Gson å®šä¹‰ä¸€ä¸ªæ‰©å±•å‡½æ•°ï¼š 1234inline fun &lt;reified T: Any&gt; Gson.fromJson(json: String): T{ return fromJson(json, T::class.java) } æœ‰äº†æ­¤æ‰©å±•æ–¹æ³•ï¼Œå°±æ— é¡»åœ¨ Kotlin å½“ä¸­æ˜¾å¼çš„ä¼ å…¥ä¸€ä¸ª class å¯¹è±¡å°±å¯ä»¥ç›´æ¥ååºåˆ—åŒ– json äº†ï¼š 12345class Person(var id: Int, var name: String) fun test(){ val person: Person = Gson().fromJson&lt;User&gt;(&quot;&quot;&quot;{&quot;id&quot;: 0, &quot;name&quot;: &quot;Jack&quot; }&quot;&quot;&quot;) } ç”±äº Gson.fromJson æ˜¯å†…è”å‡½æ•°ï¼Œæ–¹æ³•è°ƒç”¨æ—¶æ’å…¥è°ƒç”¨ä½ç½®ï¼ŒT çš„ç±»å‹åœ¨ç¼–è¯‘æ—¶å°±å¯ä»¥ç¡®å®šäº†ï¼Œåç¼–è¯‘ä¹‹åçš„ä»£ç ï¼š 12345public static final void test() { Gson $receiver$iv = new Gson(); String json$iv = &quot;{\\&quot;id\\&quot;: 0, \\&quot;name\\&quot;: \\&quot;Jack\\&quot; }&quot;; Person person = (Person)$receiver$iv.fromJson(json$iv, Person.class); } è¿™å°±æ˜¯ Kotin çš„æ³›å‹è¢«ç§°ä¸º çœŸæ³›å‹ çš„åŸå› ã€‚ ä½†æ˜¯ refied å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šreified åªèƒ½ä¿®é¥°æ–¹æ³•ï¼Œè€Œå½“å®šä¹‰ä¸€ä¸ªæ³›å‹ç±»æ—¶ï¼Œreified æ˜¯æ— æ³•é€šè¿‡ç±»ä¼¼ä»¥ä¸Šçš„æ–¹å¼è·å¾—æ³›å‹å‚æ•°çš„ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼è·å¾—æ³›å‹ç±»ä¸­çš„æ³›å‹å‚æ•°ç±»å‹ï¼Œå…·ä½“å¦‚ä¸‹ï¼š 123456789101112131415class View&lt;T&gt;(val clazz:Class&lt;T&gt;){ val presenter by lazy { clazz.newInstance() } companion object{ // åœ¨æ„é€ å‡½æ•°æ‰§è¡Œä¹‹å‰ï¼Œæ‰§è¡Œäº†æ­¤å¤„ï¼ŒçœŸæ³›å‹çš„é‡è½½å‡½æ•°ã€‚ inline operator fun &lt;reified T&gt; invoke() = View(T::class.java) }}class Presenterfun main(args: Array&lt;String&gt;) { // ä¸¤è€…ç­‰æ•ˆï¼Œå…·ä½“å®ç°å¦‚ä¸‹ val p = View&lt;Presenter&gt;().presenter val a = View.Companion.invoke&lt;Presenter&gt;().presenter} è¿™ç§å†™æ³•ç‰¹åˆ«é€‚åˆåœ¨ android ä¸­çš„ MVPï¼Œä¸ç”¨å†åœ¨ Activity ä¸­æ˜¾å¼çš„æ˜¾ç¤º Presenter çš„ç±»åã€‚ 12345678910111213141516171819202122232425262728293031323334353637//æ¥å—å¤šä¸ªç±»å‹å‚æ•°ã€‚public class MultiType &lt;E,T&gt;{ E value1; T value2; public E getValue1(){ return value1; } public T getValue2(){ return value2; }}//æ³›å‹ç±»ä¸æ³›å‹æ–¹æ³•çš„å…±å­˜public class Test1&lt;T&gt;{ public void testMethod(T t){ System.out.println(t.getClass().getName()); } public &lt;T&gt; T testMethod1(T t){ return t; }}//ä¸Šè¿°æ³›å‹ç±»ä¸æ³›å‹æ–¹æ³•å…±å­˜çš„testMethod1å®é™…ä¸Šå…¶ç±»å‹å‚æ•°æ˜¯è‡ªå·±åœ¨å‡½æ•°ç”³æ˜çš„pulic &lt;T&gt; ä¸­ï¼Œä¸ æ•´ä¸ªç±»çš„Tæ²¡å…³ç³»ï¼Œ//ä¸ºäº†é¿å…æ··æ·†ï¼Œå¦‚æœåœ¨ä¸€ä¸ªæ³›å‹ç±»ä¸­å­˜åœ¨æ³›å‹æ–¹æ³•ï¼Œé‚£ä¹ˆä¸¤è€…çš„ç±»å‹å‚æ•°æœ€å¥½ä¸è¦åŒåã€‚åº”è¯¥åƒä¸‹é¢è¿™æ ·å†™ã€‚public class Test1&lt;T&gt;{ public void testMethod(T t){ System.out.println(t.getClass().getName()); } public &lt;E&gt; E testMethod1(E e){ return e; }}","link":"/2021/12/31/Generics/"},{"title":"HandlerEpoll","text":"Looperçš„é˜»å¡å”¤é†’ç®€è¿°ï¼šé€šè¿‡pipe/epollæœºåˆ¶ï¼Œå®ç°MessageQueue.nextçš„æ— æ¶ˆæ¯æ—¶é˜»å¡ï¼Œæœ‰æ¶ˆæ¯æ—¶å”¤é†’ï¼Œpipe åŸç†å…·ä½“æ¥è¯´ï¼Œå½“Looperåœ¨å¤„ç†æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹ˆå®ƒä¼šè°ƒç”¨MessageQueueçš„nextæ–¹æ³•æ¥ç­‰å¾…æ–°çš„æ¶ˆæ¯åˆ°æ¥ï¼Œé€šè¿‡Linuxå†…æ ¸çš„epollæœºåˆ¶é˜»å¡çº¿ç¨‹ï¼Œç­‰å¾…æ–°çš„æ¶ˆæ¯åˆ°æ¥ã€‚åœ¨é˜»å¡æœŸé—´ï¼Œçº¿ç¨‹å¤„äºç¡çœ çŠ¶æ€ï¼Œä¸ä¼šå ç”¨CPUèµ„æº;å½“æ–°çš„æ¶ˆæ¯åˆ°æ¥æ—¶ï¼ŒMessageQueueå¯¹è±¡ä¼šå°†æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶é€šçŸ¥Looperå¯¹è±¡ï¼Œä»è€Œå”¤é†’çº¿ç¨‹å¹¶ç»§ç»­æ‰§è¡Œæ¶ˆæ¯çš„åˆ†å‘å’Œå¤„ç†ã€‚ epollæœºåˆ¶æ˜¯Linuxå†…æ ¸æä¾›çš„ä¸€ç§é«˜æ•ˆçš„I/Oå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå¯ä»¥åœ¨å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šç­‰å¾…ï¼Œå¹¶åœ¨å…¶ä¸­ä»»ä½•ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æœ‰äº‹ä»¶åˆ°è¾¾æ—¶ç«‹å³è¿”å›ï¼Œä»è€Œå®ç°é«˜æ•ˆçš„I/Oäº‹ä»¶å¤„ç†ã€‚ epollæœºåˆ¶ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š åˆ›å»ºepollå¥æŸ„ï¼šåœ¨ä½¿ç”¨epollæœºåˆ¶ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªepollå¥æŸ„ã€‚è¿™å¯ä»¥é€šè¿‡è°ƒç”¨epoll_createå‡½æ•°æ¥å®Œæˆï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªæ•´å‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥ç”¨äºåç»­çš„epollæ“ä½œã€‚ æ·»åŠ æ–‡ä»¶æè¿°ç¬¦åˆ°epollï¼šå°†éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ°epollä¸­ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨epoll_ctlå‡½æ•°æ¥å®Œæˆã€‚åœ¨æ·»åŠ æ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œéœ€è¦æŒ‡å®šæ–‡ä»¶æè¿°ç¬¦çš„ç±»å‹ï¼ˆä¾‹å¦‚ç®¡é“ã€socketç­‰ï¼‰ã€äº‹ä»¶ç±»å‹ï¼ˆä¾‹å¦‚è¯»äº‹ä»¶ã€å†™äº‹ä»¶ç­‰ï¼‰ä»¥åŠå›è°ƒå‡½æ•°ç­‰ä¿¡æ¯ã€‚ ç­‰å¾…äº‹ä»¶åˆ°è¾¾ï¼šç­‰å¾…äº‹ä»¶åˆ°è¾¾æ˜¯epollæœºåˆ¶çš„æ ¸å¿ƒã€‚å¯ä»¥é€šè¿‡è°ƒç”¨epoll_waitå‡½æ•°æ¥ç­‰å¾…æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶ã€‚è¯¥å‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰äº‹ä»¶åˆ°è¾¾æˆ–è€…è¶…æ—¶æ—¶é—´åˆ°è¾¾ã€‚å½“æœ‰äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œå‡½æ•°ä¼šç«‹å³è¿”å›ï¼Œè¿”å›å€¼ä¸ºå°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼ŒåŒæ—¶å°†å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„ä¿¡æ¯å¡«å……åˆ°ä¸€ä¸ªäº‹ä»¶æ•°ç»„ä¸­ã€‚ åœ¨å¤„ç†å°±ç»ªäº‹ä»¶æ—¶ï¼Œå¯ä»¥éå†äº‹ä»¶æ•°ç»„ï¼Œå¹¶æ ¹æ®æ¯ä¸ªäº‹ä»¶çš„ç±»å‹æ¥è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ˜¯è¯»äº‹ä»¶ï¼Œå¯ä»¥ä½¿ç”¨readå‡½æ•°æ¥è¯»å–æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„æ•°æ®ã€‚ æ€»ä¹‹ï¼Œé€šè¿‡ä½¿ç”¨epollæœºåˆ¶ï¼Œå¯ä»¥é«˜æ•ˆåœ°å¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„I/Oäº‹ä»¶ï¼Œå¹¶åŠæ—¶å“åº”äº‹ä»¶çš„åˆ°è¾¾ã€‚è¿™ç§æœºåˆ¶åœ¨Linuxç³»ç»Ÿä¸­å¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ï¼ŒåŒ…æ‹¬ç½‘ç»œç¼–ç¨‹ã€å›¾å½¢ç•Œé¢ç­‰é¢†åŸŸã€‚ ä¸ºä»€ä¹ˆä¸ç”¨waitå’Œnotifyå®ç°Looperçš„é˜»å¡å”¤é†’æœºåˆ¶Androidçš„Handler Frameworkä¸­çš„Looperçš„é˜»å¡å”¤é†’æœºåˆ¶æ˜¯ä¾é Linuxå†…æ ¸çš„è½®è¯¢æœºåˆ¶æ¥å®ç°çš„ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Javaä¸­çš„waitå’Œnotifyæ–¹æ³•ã€‚ åœ¨Androidç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªEventLoopï¼Œå®ƒç”±Looperæ¥ç®¡ç†ã€‚Looperä½¿ç”¨Linuxå†…æ ¸çš„pollç³»ç»Ÿè°ƒç”¨æ¥é˜»å¡çº¿ç¨‹ï¼ŒåŒæ—¶åœ¨æœ‰æ¶ˆæ¯åˆ°æ¥æ—¶å”¤é†’çº¿ç¨‹ã€‚pollæ˜¯Linuxå†…æ ¸ä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒå¯ä»¥ç”¨æ¥ç­‰å¾…æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€å˜åŒ–ï¼Œæ¯”å¦‚æ•°æ®æ˜¯å¦å¯è¯»æˆ–å¯å†™ç­‰ã€‚Looperå°†MessageQueueå°è£…æˆä¸€ä¸ªç®¡é“ï¼ˆpipeï¼‰ï¼Œç„¶åå°†ç®¡é“çš„è¯»ç«¯å£æ·»åŠ åˆ°pollçš„ç›‘å¬åˆ—è¡¨ä¸­ã€‚å½“æ¶ˆæ¯åˆ°è¾¾æ—¶ï¼ŒMessageQueueå°±ä¼šå°†æ¶ˆæ¯å†™å…¥ç®¡é“çš„å†™ç«¯å£ï¼Œä»è€Œä½¿å¾—pollè¿”å›ã€‚ç„¶åLooperå°±å¯ä»¥ä»ç®¡é“ä¸­è¯»å–æ¶ˆæ¯ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ ä½¿ç”¨Linuxå†…æ ¸çš„pollç³»ç»Ÿè°ƒç”¨å¯ä»¥é¿å…ä½¿ç”¨Javaä¸­çš„waitå’Œnotifyæ–¹æ³•çš„ç¼ºé™·ï¼Œä¾‹å¦‚ä¸ä¼šå‘ç”Ÿæ­»é”ã€ä¸ä¼šå ç”¨CPUèµ„æºç­‰ã€‚æ­¤å¤–ï¼Œè¿™ç§æœºåˆ¶è¿˜å¯ä»¥æ”¯æŒæ›´å¤šçš„çº¿ç¨‹ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„EventLoopå’ŒMessageQueueï¼Œå®ƒä»¬ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œä¸ä¼šå‘ç”Ÿç«äº‰é—®é¢˜ã€‚ Native Framework æ—©æœŸçš„Android MessageQueueåº•å±‚æ˜¯selectå®ç°Looperå”¤é†’çš„ï¼Œåé¢ç”±äºselectæ•ˆç‡åœ¨é¢‘ç¹è°ƒç”¨çš„æƒ…å†µä¸‹ä¸å¦‚Linux 2.6å†…æ ¸æ­£å¼å¼•å…¥çš„epoll IO å¤šè·¯å¤ç”¨çš„éœ€æ±‚å’ŒåŸç†ã€‚ IO å¤šè·¯å¤ç”¨å°±æ˜¯ 1 ä¸ªçº¿ç¨‹å¤„ç† å¤šä¸ª fd çš„æ¨¡å¼ã€‚æˆ‘ä»¬çš„è¦æ±‚æ˜¯ï¼šè¿™ä¸ª â€œ1â€ å°±è¦å°½å¯èƒ½çš„å¿«ï¼Œé¿å…ä¸€åˆ‡æ— æ•ˆå·¥ä½œï¼Œè¦æŠŠæ‰€æœ‰çš„æ—¶é—´éƒ½ç”¨åœ¨å¤„ç†å¥æŸ„çš„ IO ä¸Šï¼Œä¸èƒ½æœ‰ä»»ä½•ç©ºè½¬ï¼Œsleep çš„æ—¶é—´æµªè´¹ã€‚ è¿™ 3 ç§éƒ½èƒ½å¤Ÿç®¡ç† fd çš„å¯è¯»å¯å†™äº‹ä»¶ï¼Œåœ¨æ‰€æœ‰ fd ä¸å¯è¯»ä¸å¯å†™æ— æ‰€äº‹äº‹çš„æ—¶å€™ï¼Œå¯ä»¥é˜»å¡çº¿ç¨‹ï¼Œåˆ‡èµ° cpu ã€‚fd æœ‰æƒ…å†µçš„æ—¶å€™ï¼Œéƒ½è¦çº¿ç¨‹èƒ½å¤Ÿè¦èƒ½è¢«å”¤é†’ã€‚ è¡¨ 1. selectã€pollå’Œepollä¸‰ç§I/Oå¤ç”¨æ¨¡å¼çš„æ¯”è¾ƒï¼ˆ æ‘˜å½•è‡ªã€Šlinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ï¼‰ ç³»ç»Ÿè°ƒç”¨ select poll epoll äº‹ä»¶é›†åˆ é€šè¿‡3ä¸ªå‚æ•°åˆ†åˆ«ä¼ å…¥æ„Ÿå…´è¶£çš„å¯è¯»ï¼Œå¯å†™åŠå¼‚å¸¸ç­‰äº‹ä»¶å†…æ ¸é€šè¿‡å¯¹è¿™äº›å‚æ•°çš„åœ¨çº¿ä¿®æ”¹æ¥åé¦ˆå…¶ä¸­çš„å°±ç»ªäº‹ä»¶è¿™ä½¿å¾—ç”¨æˆ·æ¯æ¬¡è°ƒç”¨selectéƒ½è¦é‡ç½®è¿™3ä¸ªå‚æ•° ç»Ÿä¸€å¤„ç†æ‰€æœ‰äº‹ä»¶ç±»å‹ï¼Œå› æ­¤åªéœ€è¦ä¸€ä¸ªäº‹ä»¶é›†å‚æ•°ã€‚ç”¨æˆ·é€šè¿‡pollfd.eventsä¼ å…¥æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå†…æ ¸é€šè¿‡ä¿®æ”¹pollfd.reventsåé¦ˆå…¶ä¸­å°±ç»ªçš„äº‹ä»¶ å†…æ ¸é€šè¿‡ä¸€ä¸ªäº‹ä»¶è¡¨ç›´æ¥ç®¡ç†ç”¨æˆ·æ„Ÿå…´è¶£çš„æ‰€æœ‰äº‹ä»¶ã€‚å› æ­¤æ¯æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œæ— éœ€åå¤ä¼ å…¥ç”¨æˆ·æ„Ÿå…´è¶£çš„äº‹ä»¶ã€‚epoll_waitç³»ç»Ÿè°ƒç”¨çš„å‚æ•°eventsä»…ç”¨æ¥åé¦ˆå°±ç»ªçš„äº‹ä»¶ åº”ç”¨ç¨‹åºç´¢å¼•å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„æ—¶é—´å¤æ‚åº¦ O(n) O(n) O(1) æœ€å¤§æ”¯æŒæ–‡ä»¶æè¿°ç¬¦æ•° ä¸€èˆ¬æœ‰æœ€å¤§å€¼é™åˆ¶ 65535 65535 å·¥ä½œæ¨¡å¼ LT LT æ”¯æŒETé«˜æ•ˆæ¨¡å¼ å†…æ ¸å®ç°å’Œå·¥ä½œæ•ˆç‡ é‡‡ç”¨è½®è¯¢æ–¹å¼æ£€æµ‹å°±ç»ªäº‹ä»¶ï¼Œæ—¶é—´å¤æ‚åº¦ï¼šO(n) é‡‡ç”¨è½®è¯¢æ–¹å¼æ£€æµ‹å°±ç»ªäº‹ä»¶ï¼Œæ—¶é—´å¤æ‚åº¦ï¼šO(n) é‡‡ç”¨å›è°ƒæ–¹å¼æ£€æµ‹å°±ç»ªäº‹ä»¶ï¼Œæ—¶é—´å¤æ‚åº¦ï¼šO(1) selectåœ¨loopçš„ä¸€æ¬¡å¾ªç¯ä¸­sleep ä¸€æ®µæ—¶é—´ï¼ˆcpué‡Šæ”¾å‡ºå»ï¼‰ï¼Œåœ¨å®šæ—¶åˆ°è¾¾åè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯æ‰§è¡Œä»»åŠ¡ï¼Œæ­¤æ¬¡ä»»åŠ¡ä¸­ä¼šéå†æ‰€æœ‰fdï¼ŒæŸ¥è¯¢å“ªä¸ªå·²ç»readyï¼Œæ•ˆç‡å¾ˆå·® pollç›¸æ¯”äºselectæœºåˆ¶ï¼Œpollåªæ˜¯å–æ¶ˆäº†æœ€å¤§ç›‘æ§æ–‡ä»¶æè¿°ç¬¦æ•°é™åˆ¶ï¼Œå¹¶æ²¡æœ‰ä»æ ¹æœ¬ä¸Šè§£å†³selectå­˜åœ¨çš„é—®é¢˜ã€‚ pollå’Œselectåº“ï¼Œå®ƒä»¬çš„æœ€å¤§çš„é—®é¢˜å°±åœ¨äºæ•ˆç‡ã€‚å®ƒä»¬çš„å¤„ç†æ–¹å¼éƒ½æ˜¯åˆ›å»ºä¸€ä¸ªäº‹ä»¶åˆ—è¡¨ï¼Œç„¶åæŠŠè¿™ä¸ªåˆ—è¡¨å‘ç»™å†…æ ¸ï¼Œè¿”å›çš„æ—¶å€™ï¼Œå†å»è½®è¯¢æ£€æŸ¥è¿™ä¸ªåˆ—è¡¨ï¼Œè¿™æ ·åœ¨æè¿°ç¬¦æ¯”è¾ƒå¤šçš„åº”ç”¨ä¸­ï¼Œæ•ˆç‡å°±æ˜¾å¾—æ¯”è¾ƒä½ä¸‹äº†ã€‚ epollæ‰§è¡Œå®Œæ‰€æœ‰ä»»åŠ¡ä¹‹åè¿›å…¥ä¼‘çœ ï¼Œ æŒ‚äº†ä¸ªé’©å­ï¼Œè®¾ç½®äº†å”¤é†’çš„å›è°ƒè·¯å¾„ã€‚epoll è·Ÿåº•å±‚å¯¹æ¥çš„å›è°ƒå‡½æ•°æ˜¯ï¼šep_poll_callbackï¼Œè¿™ä¸ªå‡½æ•°å…¶å®å¾ˆç®€å•ï¼Œåšä¸¤ä»¶äº‹æƒ…ï¼š æŠŠäº‹ä»¶å°±ç»ªçš„ fd å¯¹åº”çš„ç»“æ„ä½“æ”¾åˆ°ä¸€ä¸ªç‰¹å®šçš„é˜Ÿåˆ—ï¼ˆå°±ç»ªé˜Ÿåˆ—ï¼Œready listï¼‰ï¼› å”¤é†’ epoll ï¼Œæ´»æ¥å•¦ï¼ å½“ fd æ»¡è¶³å¯è¯»å¯å†™çš„æ—¶å€™å°±ä¼šç»è¿‡å±‚å±‚å›è°ƒï¼Œæœ€ç»ˆè°ƒç”¨åˆ°è¿™ä¸ªå›è°ƒå‡½æ•°ï¼ŒæŠŠå¯¹åº” fd çš„ç»“æ„ä½“æ”¾å…¥å°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œä»è€ŒæŠŠ epoll ä» epoll_wait å‡ºå”¤é†’ã€‚ ç”±epoll_wait() å”¤é†’çš„æ—¶å€™å·²ç»ç²¾å‡†åœ°æ‹¿åˆ°äº†readyçš„fdæ•°ç»„äº†ï¼Œäºæ˜¯å°±èƒ½ç›´æ¥æ‰§è¡Œ pollæ˜¯ç¿»è¯‘è½®è¯¢çš„æ„æ€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°pollå’Œepolléƒ½æœ‰è½®è¯¢çš„è¿‡ç¨‹ã€‚ä¸åŒç‚¹åœ¨äºï¼špollè½®è¯¢çš„æ˜¯æ‰€æœ‰çš„socketã€‚è€Œepollåªè½®è¯¢å°±ç»ªçš„socket epollæ˜¯ä¸€ç§æ¯”è¾ƒå¥½çš„åšæ³•ï¼Œå®ƒæŠŠæè¿°ç¬¦åˆ—è¡¨äº¤ç»™å†…æ ¸ï¼Œä¸€æ—¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå†…æ ¸æŠŠå‘ç”Ÿäº‹ä»¶çš„æè¿°ç¬¦åˆ—è¡¨é€šçŸ¥ç»™è¿›ç¨‹ï¼Œè¿™æ ·å°±é¿å…äº†è½®è¯¢æ•´ä¸ªæè¿°ç¬¦åˆ—è¡¨ã€‚ epoll ä¹‹æ‰€ä»¥åšåˆ°äº†é«˜æ•ˆï¼Œæœ€å…³é”®çš„ä¸¤ç‚¹ï¼š å†…éƒ¨ç®¡ç† fd ä½¿ç”¨äº†é«˜æ•ˆçš„çº¢é»‘æ ‘ç»“æ„ç®¡ç†ï¼Œåšåˆ°äº†å¢åˆ æ”¹ä¹‹åæ€§èƒ½çš„ä¼˜åŒ–å’Œå¹³è¡¡ï¼› epoll æ± æ·»åŠ  fd çš„æ—¶å€™ï¼Œè°ƒç”¨ file_operations-&gt;poll ï¼ŒæŠŠè¿™ä¸ª fd å°±ç»ªä¹‹åçš„å›è°ƒè·¯å¾„å®‰æ’å¥½ã€‚é€šè¿‡äº‹ä»¶é€šçŸ¥çš„å½¢å¼ï¼Œåšåˆ°æœ€é«˜æ•ˆçš„è¿è¡Œï¼› epoll æ± æ ¸å¿ƒçš„ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼šçº¢é»‘æ ‘å’Œå°±ç»ªåˆ—è¡¨ã€‚çº¢é»‘æ ‘æ˜¯ä¸ºäº†åº”å¯¹ç”¨æˆ·çš„å¢åˆ æ”¹éœ€æ±‚ï¼Œå°±ç»ªåˆ—è¡¨æ˜¯ fd äº‹ä»¶å°±ç»ªä¹‹åæ”¾ç½®çš„ç‰¹æ®Šåœ°ç‚¹ï¼Œepoll æ± åªéœ€è¦éå†è¿™ä¸ªå°±ç»ªé“¾è¡¨ï¼Œå°±èƒ½ç»™ç”¨æˆ·è¿”å›æ‰€æœ‰å·²ç»å°±ç»ªçš„ fd æ•°ç»„ï¼› Java Framework é™„å½•NativeMessageQueue.cpp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236/* * Copyright (C) 2010 The Android Open Source Project * * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */#define LOG_TAG &quot;MessageQueue-JNI&quot;#include &lt;nativehelper/JNIHelp.h&gt;#include &lt;android_runtime/AndroidRuntime.h&gt;#include &lt;utils/Looper.h&gt;#include &lt;utils/Log.h&gt;#include &quot;android_os_MessageQueue.h&quot;#include &quot;core_jni_helpers.h&quot;namespace android {static struct { jfieldID mPtr; // native object attached to the DVM MessageQueue jmethodID dispatchEvents;} gMessageQueueClassInfo;// Must be kept in sync with the constants in Looper.FileDescriptorCallbackstatic const int CALLBACK_EVENT_INPUT = 1 &lt;&lt; 0;static const int CALLBACK_EVENT_OUTPUT = 1 &lt;&lt; 1;static const int CALLBACK_EVENT_ERROR = 1 &lt;&lt; 2;class NativeMessageQueue : public MessageQueue, public LooperCallback {public: NativeMessageQueue(); virtual ~NativeMessageQueue(); virtual void raiseException(JNIEnv* env, const char* msg, jthrowable exceptionObj); void pollOnce(JNIEnv* env, jobject obj, int timeoutMillis); void wake(); void setFileDescriptorEvents(int fd, int events); virtual int handleEvent(int fd, int events, void* data);private: JNIEnv* mPollEnv; jobject mPollObj; jthrowable mExceptionObj;};MessageQueue::MessageQueue() {}MessageQueue::~MessageQueue() {}bool MessageQueue::raiseAndClearException(JNIEnv* env, const char* msg) { if (env-&gt;ExceptionCheck()) { jthrowable exceptionObj = env-&gt;ExceptionOccurred(); env-&gt;ExceptionClear(); raiseException(env, msg, exceptionObj); env-&gt;DeleteLocalRef(exceptionObj); return true; } return false;}NativeMessageQueue::NativeMessageQueue() : mPollEnv(NULL), mPollObj(NULL), mExceptionObj(NULL) { mLooper = Looper::getForThread(); if (mLooper == NULL) { mLooper = new Looper(false); Looper::setForThread(mLooper); }}NativeMessageQueue::~NativeMessageQueue() {}void NativeMessageQueue::raiseException(JNIEnv* env, const char* msg, jthrowable exceptionObj) { if (exceptionObj) { if (mPollEnv == env) { if (mExceptionObj) { env-&gt;DeleteLocalRef(mExceptionObj); } mExceptionObj = jthrowable(env-&gt;NewLocalRef(exceptionObj)); ALOGE(&quot;Exception in MessageQueue callback: %s&quot;, msg); jniLogException(env, ANDROID_LOG_ERROR, LOG_TAG, exceptionObj); } else { ALOGE(&quot;Exception: %s&quot;, msg); jniLogException(env, ANDROID_LOG_ERROR, LOG_TAG, exceptionObj); LOG_ALWAYS_FATAL(&quot;raiseException() was called when not in a callback, exiting.&quot;); } }}void NativeMessageQueue::pollOnce(JNIEnv* env, jobject pollObj, int timeoutMillis) { mPollEnv = env; mPollObj = pollObj; mLooper-&gt;pollOnce(timeoutMillis); mPollObj = NULL; mPollEnv = NULL; if (mExceptionObj) { env-&gt;Throw(mExceptionObj); env-&gt;DeleteLocalRef(mExceptionObj); mExceptionObj = NULL; }}void NativeMessageQueue::wake() { mLooper-&gt;wake();}void NativeMessageQueue::setFileDescriptorEvents(int fd, int events) { if (events) { int looperEvents = 0; if (events &amp; CALLBACK_EVENT_INPUT) { looperEvents |= Looper::EVENT_INPUT; } if (events &amp; CALLBACK_EVENT_OUTPUT) { looperEvents |= Looper::EVENT_OUTPUT; } mLooper-&gt;addFd(fd, Looper::POLL_CALLBACK, looperEvents, this, reinterpret_cast&lt;void*&gt;(events)); } else { mLooper-&gt;removeFd(fd); }}int NativeMessageQueue::handleEvent(int fd, int looperEvents, void* data) { int events = 0; if (looperEvents &amp; Looper::EVENT_INPUT) { events |= CALLBACK_EVENT_INPUT; } if (looperEvents &amp; Looper::EVENT_OUTPUT) { events |= CALLBACK_EVENT_OUTPUT; } if (looperEvents &amp; (Looper::EVENT_ERROR | Looper::EVENT_HANGUP | Looper::EVENT_INVALID)) { events |= CALLBACK_EVENT_ERROR; } int oldWatchedEvents = reinterpret_cast&lt;intptr_t&gt;(data); int newWatchedEvents = mPollEnv-&gt;CallIntMethod(mPollObj, gMessageQueueClassInfo.dispatchEvents, fd, events); if (!newWatchedEvents) { return 0; // unregister the fd } if (newWatchedEvents != oldWatchedEvents) { setFileDescriptorEvents(fd, newWatchedEvents); } return 1;}// ----------------------------------------------------------------------------sp&lt;MessageQueue&gt; android_os_MessageQueue_getMessageQueue(JNIEnv* env, jobject messageQueueObj) { jlong ptr = env-&gt;GetLongField(messageQueueObj, gMessageQueueClassInfo.mPtr); return reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr);}static jlong android_os_MessageQueue_nativeInit(JNIEnv* env, jclass clazz) { NativeMessageQueue* nativeMessageQueue = new NativeMessageQueue(); if (!nativeMessageQueue) { jniThrowRuntimeException(env, &quot;Unable to allocate native queue&quot;); return 0; } nativeMessageQueue-&gt;incStrong(env); return reinterpret_cast&lt;jlong&gt;(nativeMessageQueue);}static void android_os_MessageQueue_nativeDestroy(JNIEnv* env, jclass clazz, jlong ptr) { NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); nativeMessageQueue-&gt;decStrong(env);}static void android_os_MessageQueue_nativePollOnce(JNIEnv* env, jobject obj, jlong ptr, jint timeoutMillis) { NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); nativeMessageQueue-&gt;pollOnce(env, obj, timeoutMillis);}static void android_os_MessageQueue_nativeWake(JNIEnv* env, jclass clazz, jlong ptr) { NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); nativeMessageQueue-&gt;wake();}static jboolean android_os_MessageQueue_nativeIsPolling(JNIEnv* env, jclass clazz, jlong ptr) { NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); return nativeMessageQueue-&gt;getLooper()-&gt;isPolling();}static void android_os_MessageQueue_nativeSetFileDescriptorEvents(JNIEnv* env, jclass clazz, jlong ptr, jint fd, jint events) { NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); nativeMessageQueue-&gt;setFileDescriptorEvents(fd, events);}// ----------------------------------------------------------------------------static const JNINativeMethod gMessageQueueMethods[] = { /* name, signature, funcPtr */ { &quot;nativeInit&quot;, &quot;()J&quot;, (void*)android_os_MessageQueue_nativeInit }, { &quot;nativeDestroy&quot;, &quot;(J)V&quot;, (void*)android_os_MessageQueue_nativeDestroy }, { &quot;nativePollOnce&quot;, &quot;(JI)V&quot;, (void*)android_os_MessageQueue_nativePollOnce }, { &quot;nativeWake&quot;, &quot;(J)V&quot;, (void*)android_os_MessageQueue_nativeWake }, { &quot;nativeIsPolling&quot;, &quot;(J)Z&quot;, (void*)android_os_MessageQueue_nativeIsPolling }, { &quot;nativeSetFileDescriptorEvents&quot;, &quot;(JII)V&quot;, (void*)android_os_MessageQueue_nativeSetFileDescriptorEvents },};int register_android_os_MessageQueue(JNIEnv* env) { int res = RegisterMethodsOrDie(env, &quot;android/os/MessageQueue&quot;, gMessageQueueMethods, NELEM(gMessageQueueMethods)); jclass clazz = FindClassOrDie(env, &quot;android/os/MessageQueue&quot;); gMessageQueueClassInfo.mPtr = GetFieldIDOrDie(env, clazz, &quot;mPtr&quot;, &quot;J&quot;); gMessageQueueClassInfo.dispatchEvents = GetMethodIDOrDie(env, clazz, &quot;dispatchEvents&quot;, &quot;(II)I&quot;); return res;}} // namespace android Looper.cpp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561//// Copyright 2010 The Android Open Source Project//// A looper implementation based on epoll().//#define LOG_TAG &quot;Looper&quot;//#define LOG_NDEBUG 0// Debugs poll and wake interactions.#define DEBUG_POLL_AND_WAKE 0// Debugs callback registration and invocation.#define DEBUG_CALLBACKS 0#include &lt;cutils/log.h&gt;#include &lt;utils/Looper.h&gt;#include &lt;utils/Timers.h&gt;#include &lt;unistd.h&gt;#include &lt;fcntl.h&gt;#include &lt;limits.h&gt;namespace android {// --- WeakMessageHandler ---WeakMessageHandler::WeakMessageHandler(const wp&lt;MessageHandler&gt;&amp; handler) : mHandler(handler) {}WeakMessageHandler::~WeakMessageHandler() {}void WeakMessageHandler::handleMessage(const Message&amp; message) { sp&lt;MessageHandler&gt; handler = mHandler.promote(); if (handler != NULL) { handler-&gt;handleMessage(message); }}// --- SimpleLooperCallback ---SimpleLooperCallback::SimpleLooperCallback(ALooper_callbackFunc callback) : mCallback(callback) {}SimpleLooperCallback::~SimpleLooperCallback() {}int SimpleLooperCallback::handleEvent(int fd, int events, void* data) { return mCallback(fd, events, data);}// --- Looper ---// Hint for number of file descriptors to be associated with the epoll instance.static const int EPOLL_SIZE_HINT = 8;// Maximum number of file descriptors for which to retrieve poll events each iteration.static const int EPOLL_MAX_EVENTS = 16;static pthread_once_t gTLSOnce = PTHREAD_ONCE_INIT;static pthread_key_t gTLSKey = 0;Looper::Looper(bool allowNonCallbacks) : mAllowNonCallbacks(allowNonCallbacks), mSendingMessage(false), mResponseIndex(0), mNextMessageUptime(LLONG_MAX) { int wakeFds[2]; int result = pipe(wakeFds); LOG_ALWAYS_FATAL_IF(result != 0, &quot;Could not create wake pipe. errno=%d&quot;, errno); mWakeReadPipeFd = wakeFds[0]; mWakeWritePipeFd = wakeFds[1]; result = fcntl(mWakeReadPipeFd, F_SETFL, O_NONBLOCK); LOG_ALWAYS_FATAL_IF(result != 0, &quot;Could not make wake read pipe non-blocking. errno=%d&quot;, errno); result = fcntl(mWakeWritePipeFd, F_SETFL, O_NONBLOCK); LOG_ALWAYS_FATAL_IF(result != 0, &quot;Could not make wake write pipe non-blocking. errno=%d&quot;, errno); // Allocate the epoll instance and register the wake pipe. mEpollFd = epoll_create(EPOLL_SIZE_HINT); LOG_ALWAYS_FATAL_IF(mEpollFd &lt; 0, &quot;Could not create epoll instance. errno=%d&quot;, errno); struct epoll_event eventItem; memset(&amp; eventItem, 0, sizeof(epoll_event)); // zero out unused members of data field union eventItem.events = EPOLLIN; eventItem.data.fd = mWakeReadPipeFd; result = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, mWakeReadPipeFd, &amp; eventItem); LOG_ALWAYS_FATAL_IF(result != 0, &quot;Could not add wake read pipe to epoll instance. errno=%d&quot;, errno);}Looper::~Looper() { close(mWakeReadPipeFd); close(mWakeWritePipeFd); close(mEpollFd);}void Looper::initTLSKey() { int result = pthread_key_create(&amp; gTLSKey, threadDestructor); LOG_ALWAYS_FATAL_IF(result != 0, &quot;Could not allocate TLS key.&quot;);}void Looper::threadDestructor(void *st) { Looper* const self = static_cast&lt;Looper*&gt;(st); if (self != NULL) { self-&gt;decStrong((void*)threadDestructor); }}void Looper::setForThread(const sp&lt;Looper&gt;&amp; looper) { sp&lt;Looper&gt; old = getForThread(); // also has side-effect of initializing TLS if (looper != NULL) { looper-&gt;incStrong((void*)threadDestructor); } pthread_setspecific(gTLSKey, looper.get()); if (old != NULL) { old-&gt;decStrong((void*)threadDestructor); }}sp&lt;Looper&gt; Looper::getForThread() { int result = pthread_once(&amp; gTLSOnce, initTLSKey); LOG_ALWAYS_FATAL_IF(result != 0, &quot;pthread_once failed&quot;); return (Looper*)pthread_getspecific(gTLSKey);}sp&lt;Looper&gt; Looper::prepare(int opts) { bool allowNonCallbacks = opts &amp; ALOOPER_PREPARE_ALLOW_NON_CALLBACKS; sp&lt;Looper&gt; looper = Looper::getForThread(); if (looper == NULL) { looper = new Looper(allowNonCallbacks); Looper::setForThread(looper); } if (looper-&gt;getAllowNonCallbacks() != allowNonCallbacks) { ALOGW(&quot;Looper already prepared for this thread with a different value for the &quot; &quot;ALOOPER_PREPARE_ALLOW_NON_CALLBACKS option.&quot;); } return looper;}bool Looper::getAllowNonCallbacks() const { return mAllowNonCallbacks;}int Looper::pollOnce(int timeoutMillis, int* outFd, int* outEvents, void** outData) { int result = 0; for (;;) { while (mResponseIndex &lt; mResponses.size()) { const Response&amp; response = mResponses.itemAt(mResponseIndex++); int ident = response.request.ident; if (ident &gt;= 0) { int fd = response.request.fd; int events = response.events; void* data = response.request.data;#if DEBUG_POLL_AND_WAKE ALOGD(&quot;%p ~ pollOnce - returning signalled identifier %d: &quot; &quot;fd=%d, events=0x%x, data=%p&quot;, this, ident, fd, events, data);#endif if (outFd != NULL) *outFd = fd; if (outEvents != NULL) *outEvents = events; if (outData != NULL) *outData = data; return ident; } } if (result != 0) {#if DEBUG_POLL_AND_WAKE ALOGD(&quot;%p ~ pollOnce - returning result %d&quot;, this, result);#endif if (outFd != NULL) *outFd = 0; if (outEvents != NULL) *outEvents = 0; if (outData != NULL) *outData = NULL; return result; } result = pollInner(timeoutMillis); }}int Looper::pollInner(int timeoutMillis) {#if DEBUG_POLL_AND_WAKE ALOGD(&quot;%p ~ pollOnce - waiting: timeoutMillis=%d&quot;, this, timeoutMillis);#endif // Adjust the timeout based on when the next message is due. if (timeoutMillis != 0 &amp;&amp; mNextMessageUptime != LLONG_MAX) { nsecs_t now = systemTime(SYSTEM_TIME_MONOTONIC); int messageTimeoutMillis = toMillisecondTimeoutDelay(now, mNextMessageUptime); if (messageTimeoutMillis &gt;= 0 &amp;&amp; (timeoutMillis &lt; 0 || messageTimeoutMillis &lt; timeoutMillis)) { timeoutMillis = messageTimeoutMillis; }#if DEBUG_POLL_AND_WAKE ALOGD(&quot;%p ~ pollOnce - next message in %lldns, adjusted timeout: timeoutMillis=%d&quot;, this, mNextMessageUptime - now, timeoutMillis);#endif } // Poll. int result = ALOOPER_POLL_WAKE; mResponses.clear(); mResponseIndex = 0; struct epoll_event eventItems[EPOLL_MAX_EVENTS]; int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis); // Acquire lock. mLock.lock(); // Check for poll error. if (eventCount &lt; 0) { if (errno == EINTR) { goto Done; } ALOGW(&quot;Poll failed with an unexpected error, errno=%d&quot;, errno); result = ALOOPER_POLL_ERROR; goto Done; } // Check for poll timeout. if (eventCount == 0) {#if DEBUG_POLL_AND_WAKE ALOGD(&quot;%p ~ pollOnce - timeout&quot;, this);#endif result = ALOOPER_POLL_TIMEOUT; goto Done; } // Handle all events.#if DEBUG_POLL_AND_WAKE ALOGD(&quot;%p ~ pollOnce - handling events from %d fds&quot;, this, eventCount);#endif for (int i = 0; i &lt; eventCount; i++) { int fd = eventItems[i].data.fd; uint32_t epollEvents = eventItems[i].events; if (fd == mWakeReadPipeFd) { if (epollEvents &amp; EPOLLIN) { awoken(); } else { ALOGW(&quot;Ignoring unexpected epoll events 0x%x on wake read pipe.&quot;, epollEvents); } } else { ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &gt;= 0) { int events = 0; if (epollEvents &amp; EPOLLIN) events |= ALOOPER_EVENT_INPUT; if (epollEvents &amp; EPOLLOUT) events |= ALOOPER_EVENT_OUTPUT; if (epollEvents &amp; EPOLLERR) events |= ALOOPER_EVENT_ERROR; if (epollEvents &amp; EPOLLHUP) events |= ALOOPER_EVENT_HANGUP; pushResponse(events, mRequests.valueAt(requestIndex)); } else { ALOGW(&quot;Ignoring unexpected epoll events 0x%x on fd %d that is &quot; &quot;no longer registered.&quot;, epollEvents, fd); } } }Done: ; // Invoke pending message callbacks. mNextMessageUptime = LLONG_MAX; while (mMessageEnvelopes.size() != 0) { nsecs_t now = systemTime(SYSTEM_TIME_MONOTONIC); const MessageEnvelope&amp; messageEnvelope = mMessageEnvelopes.itemAt(0); if (messageEnvelope.uptime &lt;= now) { // Remove the envelope from the list. // We keep a strong reference to the handler until the call to handleMessage // finishes. Then we drop it so that the handler can be deleted *before* // we reacquire our lock. { // obtain handler sp&lt;MessageHandler&gt; handler = messageEnvelope.handler; Message message = messageEnvelope.message; mMessageEnvelopes.removeAt(0); mSendingMessage = true; mLock.unlock();#if DEBUG_POLL_AND_WAKE || DEBUG_CALLBACKS ALOGD(&quot;%p ~ pollOnce - sending message: handler=%p, what=%d&quot;, this, handler.get(), message.what);#endif handler-&gt;handleMessage(message); } // release handler mLock.lock(); mSendingMessage = false; result = ALOOPER_POLL_CALLBACK; } else { // The last message left at the head of the queue determines the next wakeup time. mNextMessageUptime = messageEnvelope.uptime; break; } } // Release lock. mLock.unlock(); // Invoke all response callbacks. for (size_t i = 0; i &lt; mResponses.size(); i++) { Response&amp; response = mResponses.editItemAt(i); if (response.request.ident == ALOOPER_POLL_CALLBACK) { int fd = response.request.fd; int events = response.events; void* data = response.request.data;#if DEBUG_POLL_AND_WAKE || DEBUG_CALLBACKS ALOGD(&quot;%p ~ pollOnce - invoking fd event callback %p: fd=%d, events=0x%x, data=%p&quot;, this, response.request.callback.get(), fd, events, data);#endifALOOPER_POLL_CALLBACK int callbackResult = response.request.callback-&gt;handleEvent(fd, events, data); if (callbackResult == 0) { removeFd(fd); } // Clear the callback reference in the response structure promptly because we // will not clear the response vector itself until the next poll. response.request.callback.clear(); result = ALOOPER_POLL_CALLBACK; } } return result;}int Looper::pollAll(int timeoutMillis, int* outFd, int* outEvents, void** outData) { if (timeoutMillis &lt;= 0) { int result; do { result = pollOnce(timeoutMillis, outFd, outEvents, outData); } while (result == ALOOPER_POLL_CALLBACK); return result; } else { nsecs_t endTime = systemTime(SYSTEM_TIME_MONOTONIC) + milliseconds_to_nanoseconds(timeoutMillis); for (;;) { int result = pollOnce(timeoutMillis, outFd, outEvents, outData); if (result != ALOOPER_POLL_CALLBACK) { return result; } nsecs_t now = systemTime(SYSTEM_TIME_MONOTONIC); timeoutMillis = toMillisecondTimeoutDelay(now, endTime); if (timeoutMillis == 0) { return ALOOPER_POLL_TIMEOUT; } } }}void Looper::wake() {#if DEBUG_POLL_AND_WAKE ALOGD(&quot;%p ~ wake&quot;, this);#endif ssize_t nWrite; do { nWrite = write(mWakeWritePipeFd, &quot;W&quot;, 1); } while (nWrite == -1 &amp;&amp; errno == EINTR); if (nWrite != 1) { if (errno != EAGAIN) { ALOGW(&quot;Could not write wake signal, errno=%d&quot;, errno); } }}void Looper::awoken() {#if DEBUG_POLL_AND_WAKE ALOGD(&quot;%p ~ awoken&quot;, this);#endif char buffer[16]; ssize_t nRead; do { nRead = read(mWakeReadPipeFd, buffer, sizeof(buffer)); } while ((nRead == -1 &amp;&amp; errno == EINTR) || nRead == sizeof(buffer));}void Looper::pushResponse(int events, const Request&amp; request) { Response response; response.events = events; response.request = request; mResponses.push(response);}int Looper::addFd(int fd, int ident, int events, ALooper_callbackFunc callback, void* data) { return addFd(fd, ident, events, callback ? new SimpleLooperCallback(callback) : NULL, data);}int Looper::addFd(int fd, int ident, int events, const sp&lt;LooperCallback&gt;&amp; callback, void* data) {#if DEBUG_CALLBACKS ALOGD(&quot;%p ~ addFd - fd=%d, ident=%d, events=0x%x, callback=%p, data=%p&quot;, this, fd, ident, events, callback.get(), data);#endif if (!callback.get()) { if (! mAllowNonCallbacks) { ALOGE(&quot;Invalid attempt to set NULL callback but not allowed for this looper.&quot;); return -1; } if (ident &lt; 0) { ALOGE(&quot;Invalid attempt to set NULL callback with ident &lt; 0.&quot;); return -1; } } else { ident = ALOOPER_POLL_CALLBACK; } int epollEvents = 0; if (events &amp; ALOOPER_EVENT_INPUT) epollEvents |= EPOLLIN; if (events &amp; ALOOPER_EVENT_OUTPUT) epollEvents |= EPOLLOUT; { // acquire lock AutoMutex _l(mLock); Request request; request.fd = fd; request.ident = ident; request.callback = callback; request.data = data; struct epoll_event eventItem; memset(&amp; eventItem, 0, sizeof(epoll_event)); // zero out unused members of data field union eventItem.events = epollEvents; eventItem.data.fd = fd; ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &lt; 0) { int epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, fd, &amp; eventItem); if (epollResult &lt; 0) { ALOGE(&quot;Error adding epoll events for fd %d, errno=%d&quot;, fd, errno); return -1; } mRequests.add(fd, request); } else { int epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_MOD, fd, &amp; eventItem); if (epollResult &lt; 0) { ALOGE(&quot;Error modifying epoll events for fd %d, errno=%d&quot;, fd, errno); return -1; } mRequests.replaceValueAt(requestIndex, request); } } // release lock return 1;}int Looper::removeFd(int fd) {#if DEBUG_CALLBACKS ALOGD(&quot;%p ~ removeFd - fd=%d&quot;, this, fd);#endif { // acquire lock AutoMutex _l(mLock); ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &lt; 0) { return 0; } int epollResult = epoll_ctl(mEpollFd, EPOLL_CTL_DEL, fd, NULL); if (epollResult &lt; 0) { ALOGE(&quot;Error removing epoll events for fd %d, errno=%d&quot;, fd, errno); return -1; } mRequests.removeItemsAt(requestIndex); } // release lock return 1;}void Looper::sendMessage(const sp&lt;MessageHandler&gt;&amp; handler, const Message&amp; message) { nsecs_t now = systemTime(SYSTEM_TIME_MONOTONIC); sendMessageAtTime(now, handler, message);}void Looper::sendMessageDelayed(nsecs_t uptimeDelay, const sp&lt;MessageHandler&gt;&amp; handler, const Message&amp; message) { nsecs_t now = systemTime(SYSTEM_TIME_MONOTONIC); sendMessageAtTime(now + uptimeDelay, handler, message);}void Looper::sendMessageAtTime(nsecs_t uptime, const sp&lt;MessageHandler&gt;&amp; handler, const Message&amp; message) {#if DEBUG_CALLBACKS ALOGD(&quot;%p ~ sendMessageAtTime - uptime=%lld, handler=%p, what=%d&quot;, this, uptime, handler.get(), message.what);#endif size_t i = 0; { // acquire lock AutoMutex _l(mLock); size_t messageCount = mMessageEnvelopes.size(); while (i &lt; messageCount &amp;&amp; uptime &gt;= mMessageEnvelopes.itemAt(i).uptime) { i += 1; } MessageEnvelope messageEnvelope(uptime, handler, message); mMessageEnvelopes.insertAt(messageEnvelope, i, 1); // Optimization: If the Looper is currently sending a message, then we can skip // the call to wake() because the next thing the Looper will do after processing // messages is to decide when the next wakeup time should be. In fact, it does // not even matter whether this code is running on the Looper thread. if (mSendingMessage) { return; } } // release lock // Wake the poll loop only when we enqueue a new message at the head. if (i == 0) { wake(); }}void Looper::removeMessages(const sp&lt;MessageHandler&gt;&amp; handler) {#if DEBUG_CALLBACKS ALOGD(&quot;%p ~ removeMessages - handler=%p&quot;, this, handler.get());#endif { // acquire lock AutoMutex _l(mLock); for (size_t i = mMessageEnvelopes.size(); i != 0; ) { const MessageEnvelope&amp; messageEnvelope = mMessageEnvelopes.itemAt(--i); if (messageEnvelope.handler == handler) { mMessageEnvelopes.removeAt(i); } } } // release lock}void Looper::removeMessages(const sp&lt;MessageHandler&gt;&amp; handler, int what) {#if DEBUG_CALLBACKS ALOGD(&quot;%p ~ removeMessages - handler=%p, what=%d&quot;, this, handler.get(), what);#endif { // acquire lock AutoMutex _l(mLock); for (size_t i = mMessageEnvelopes.size(); i != 0; ) { const MessageEnvelope&amp; messageEnvelope = mMessageEnvelopes.itemAt(--i); if (messageEnvelope.handler == handler &amp;&amp; messageEnvelope.message.what == what) { mMessageEnvelopes.removeAt(i); } } } // release lock}} // namespace android","link":"/2022/01/24/HandlerEpoll/"},{"title":"Graphics","text":"ç§»åŠ¨ç«¯æ¸²æŸ“ ç§»åŠ¨Appçš„æ•´ä½“UIæ¡†æ¶å¤§è‡´åˆ†æˆä¸‹é¢4ä¸ªå±‚æ¬¡ï¼š 1ï¼‰UIåº“ è·ŸAndroidã€iOSåŸç”Ÿå¼€å‘ç±»ä¼¼ï¼ŒFlutterç”¨dartè¯­è¨€å®ç°ä¸€æ•´å¥—UIæ§ä»¶ã€‚Flutterå…ˆå°†æ§ä»¶æ ‘è½¬æˆæ¸²æŸ“æ ‘ï¼Œç„¶åäº¤ç”±skiaåº“ç»˜åˆ¶ç•Œé¢ã€‚ 2ï¼‰å›¾å½¢åº“ Skiaå›¾å½¢åº“è·ŸiOSå¹³å°çš„CoreAnimationç­‰åº“åŠŸèƒ½ç±»ä¼¼ï¼Œä¸ä»…æä¾›äº†å›¾å½¢æ¸²æŸ“åŠŸèƒ½ï¼Œè¿˜æä¾›æ–‡å­—ç»˜åˆ¶å’Œå›¾ç‰‡æ˜¾ç¤ºåŠŸèƒ½ã€‚é«˜çº§å›¾å½¢å›¾åƒåº“å°†éœ€è¦ç»˜åˆ¶çš„å›¾å½¢è½¬æˆç‚¹ã€çº¿ã€ä¸‰è§’å½¢ç­‰å›¾å…ƒï¼Œå†è°ƒç”¨åº•å±‚å›¾å½¢æ¥å£å®ç°ç»˜åˆ¶ã€‚ 3ï¼‰ä½çº§å›¾å½¢æ¥å£ OpenGLæ˜¯ä½¿ç”¨æœ€å¹¿çš„ä½çº§å›¾å½¢æ¥å£ï¼Œå…¼å®¹æ€§æœ€å¥½ï¼ŒåŸºæœ¬ä¸Šæ”¯æŒå¸‚é¢ä¸Šçš„æ‰€æœ‰GPUã€‚Vulkanæ˜¯æœ€è¿‘å‡ å¹´æ–°æ¨å‡ºçš„å›¾å½¢APIï¼Œé™¤äº†iPhoneçš„GPUï¼Œå…¶ä»–å‚å®¶çš„GPUåŸºæœ¬éƒ½æ”¯æŒã€‚Metalæ˜¯è‹¹æœæ–°æ¨å‡ºçš„å›¾å½¢APIï¼Œåªæ”¯æŒè‡ªå®¶GPUã€‚ 4ï¼‰ç¡¬ä»¶è®¾å¤‡å±‚ ç›®å‰çš„ç§»åŠ¨è®¾å¤‡å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œå¤§éƒ¨åˆ†å›¾å½¢éƒ½æ˜¯é€šè¿‡GPUæ¸²æŸ“ï¼Œå°‘æ•°æƒ…å†µä¹Ÿä¼šä½¿ç”¨CPUæ¸²æŸ“ï¼Œåæ–‡ä¼šä»‹ç»skiaä½¿ç”¨CPUå’ŒGPUæ¸²æŸ“çš„å…·ä½“åœºæ™¯ã€‚ iPhone åœ¨A11èŠ¯ç‰‡ä»¥å‰ä½¿ç”¨power vrç³»åˆ—GPUï¼Œä¹‹åé‡‡ç”¨è‡ªç ”GPUã€‚å®‰å“æ‰‹æœºå¤§éƒ¨åˆ†é‡‡ç”¨é«˜é€šAdreno GPUæˆ–ARM mail GPUã€‚GPUæ¸²æŸ“å®Œä¸€å¸§å›¾åƒåé€FrameBufferï¼Œæœ€ååœ¨åˆé€‚çš„æ—¶æœºå±•ç¤ºåœ¨å±å¹•ä¸Šã€‚ Skiaåº”ç”¨å¹¿æ³›å¹¶ä¸”è·¨å¹³å°ï¼Œä¸ä»…ç”¨äºFlutterå’ŒAndroidæ“ä½œç³»ç»Ÿï¼Œè¿˜ç”¨äºGoogle Chromeæµè§ˆå™¨ï¼ŒåŒæ—¶æ”¯æŒwindowsã€Macã€iOSæ“ä½œç³»ç»Ÿã€‚Skiaç”±C++ç¼–å†™ï¼Œä»£ç å¼€æºï¼Œé€šè¿‡ç ”ç©¶skiaæœ‰åŠ©äºç†è§£å›¾å½¢å›¾åƒçš„ç»˜åˆ¶åŸç†ï¼Œä¸ºUIæ€§èƒ½ä¼˜åŒ–æä¾›æ€è·¯ã€‚ å›¾å½¢Android æ¡†æ¶æä¾›äº†å„ç§ç”¨äº 2D å’Œ 3D å›¾å½¢æ¸²æŸ“çš„ APIï¼Œå¯ä¸åˆ¶é€ å•†çš„å›¾å½¢é©±åŠ¨ç¨‹åºå®ç°ä»£ç äº¤äº’ï¼Œå› æ­¤ï¼ŒåŠ¡å¿…æ›´å¥½åœ°äº†è§£è¿™äº› API çš„å·¥ä½œåŸç†ã€‚æœ¬é¡µä»‹ç»äº†åœ¨å…¶ä¸Šæ„å»ºè¿™äº›é©±åŠ¨ç¨‹åºçš„ å›¾å½¢ç¡¬ä»¶æŠ½è±¡å±‚ (HAL)ã€‚ åº”ç”¨å¼€å‘è€…å¯é€šè¿‡ä¸‰ç§æ–¹å¼å°†å›¾åƒç»˜åˆ¶åˆ°å±å¹•ä¸Šï¼šä½¿ç”¨canvasã€OpenGL ES æˆ– Vulkan(UE4æ”¯æŒ)ã€‚ Android å›¾å½¢ç»„ä»¶æ— è®ºå¼€å‘è€…ä½¿ç”¨ä»€ä¹ˆæ¸²æŸ“ APIï¼Œä¸€åˆ‡å†…å®¹éƒ½ä¼šæ¸²æŸ“åˆ° Surface ä¸Šã€‚Surface è¡¨ç¤ºç¼“å†²åŒºé˜Ÿåˆ—ä¸­çš„ç”Ÿäº§æ–¹ï¼Œè€Œç¼“å†²åŒºé˜Ÿåˆ—é€šå¸¸ä¼šè¢« SurfaceFlinger æ¶ˆè€—ã€‚åœ¨ Android å¹³å°ä¸Šåˆ›å»ºçš„æ¯ä¸ªçª—å£éƒ½ç”± Surface æä¾›æ”¯æŒã€‚æ‰€æœ‰è¢«æ¸²æŸ“çš„å¯è§ Surface éƒ½è¢« SurfaceFlinger åˆæˆåˆ°å±å¹•ã€‚ ä¸‹å›¾æ˜¾ç¤ºäº†å…³é”®ç»„ä»¶å¦‚ä½•ååŒå·¥ä½œï¼š å›¾ 1. Surface å¦‚ä½•è¢«æ¸²æŸ“ ä¸»è¦ç»„ä»¶å¦‚ä¸‹æ‰€è¿°ï¼š å›¾åƒæµç”Ÿäº§æ–¹ IMAGE STREAM PRODUCERSå›¾åƒæµç”Ÿäº§æ–¹å¯ä»¥æ˜¯ç”Ÿæˆå›¾å½¢ç¼“å†²åŒºä»¥ä¾›æ¶ˆè€—çš„ä»»ä½•å†…å®¹ã€‚ä¾‹å¦‚ OpenGL ESã€Canvas 2D å’Œ mediaserver è§†é¢‘è§£ç å™¨ã€‚ å›¾åƒæµæ¶ˆè€—æ–¹ IMAGE STREAM CONSUMERSå›¾åƒæµçš„æœ€å¸¸è§æ¶ˆè€—æ–¹æ˜¯ SurfaceFlingerï¼Œè¯¥ç³»ç»ŸæœåŠ¡ä¼šæ¶ˆè€—å½“å‰å¯è§çš„ Surfaceï¼Œå¹¶ä½¿ç”¨çª—å£ç®¡ç†å™¨ä¸­æä¾›çš„ä¿¡æ¯å°†å®ƒä»¬åˆæˆåˆ°å±å¹•ã€‚SurfaceFlinger æ˜¯å¯ä»¥ä¿®æ”¹æ‰€æ˜¾ç¤ºéƒ¨åˆ†å†…å®¹çš„å”¯ä¸€æœåŠ¡ã€‚SurfaceFlinger ä½¿ç”¨ OpenGL å’Œ Hardware Composer æ¥åˆæˆä¸€ç»„ Surfaceã€‚ å…¶ä»– OpenGL ES åº”ç”¨ä¹Ÿå¯ä»¥æ¶ˆè€—å›¾åƒæµï¼Œä¾‹å¦‚ç›¸æœºåº”ç”¨ä¼šæ¶ˆè€—ç›¸æœºé¢„è§ˆå›¾åƒæµã€‚é GL åº”ç”¨ä¹Ÿå¯ä»¥æ˜¯ä½¿ç”¨æ–¹ï¼Œä¾‹å¦‚ ImageReader ç±»ã€‚ ç¡¬ä»¶ä½œæ›²å®¶ Hardware Composer (ç®€ç§°HWC)æ˜¾ç¤ºå­ç³»ç»Ÿçš„ç¡¬ä»¶æŠ½è±¡å®ç°ã€‚SurfaceFlinger å¯ä»¥å°†æŸäº›åˆæˆå·¥ä½œå§”æ‰˜ç»™Hardware Composerï¼Œä»¥åˆ†æ‹… OpenGL å’Œ GPU ä¸Šçš„å·¥ä½œé‡ã€‚SurfaceFlinger åªæ˜¯å……å½“å¦ä¸€ä¸ª OpenGL ES å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼Œåœ¨ SurfaceFlinger å°†ä¸€ä¸ªæˆ–ä¸¤ä¸ªç¼“å†²åŒºåˆæˆåˆ°ç¬¬ä¸‰ä¸ªç¼“å†²åŒºä¸­çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šä½¿ç”¨ OpenGL ESã€‚è¿™ä¼šè®©åˆæˆçš„åŠŸè€—æ¯”é€šè¿‡ GPU æ‰§è¡Œæ‰€æœ‰è®¡ç®—æ—¶æ›´ä½ã€‚ ç¡¬ä»¶ä½œæ›²å®¶ Hardware Composer HAL åˆ™è¿›è¡Œå¦ä¸€åŠçš„å·¥ä½œï¼Œæ˜¯æ‰€æœ‰ Android å›¾å½¢æ¸²æŸ“çš„ä¸­å¿ƒç‚¹ã€‚Hardware Composer å¿…é¡»æ”¯æŒäº‹ä»¶ï¼Œå…¶ä¸­ä¹‹ä¸€æ˜¯ VSYNCï¼ˆå¦ä¸€ä¸ªæ˜¯æ”¯æŒå³æ’å³ç”¨ HDMI çš„çƒ­æ’æ‹”ï¼‰ã€‚ Grallocéœ€è¦ä½¿ç”¨å›¾å½¢å†…å­˜åˆ†é…å™¨ (Gralloc) æ¥åˆ†é…å›¾åƒç”Ÿäº§æ–¹è¯·æ±‚çš„å†…å­˜ã€‚æœ‰å…³è¯¦æƒ…ï¼Œè¯·å‚é˜… Gralloc HALã€‚ æ•°æ®æµæœ‰å…³ Android å›¾å½¢ç®¡é“çš„æè¿°ï¼Œè¯·å‚è§ä¸‹å›¾ï¼š å›¾ 2. æµç» Android çš„å›¾å½¢æ•°æ®æµ å·¦ä¾§çš„å¯¹è±¡æ˜¯ç”Ÿæˆå›¾å½¢ç¼“å†²åŒºçš„æ¸²æŸ“å™¨ï¼Œå¦‚ä¸»å±å¹•ã€çŠ¶æ€æ å’Œç³»ç»Ÿç•Œé¢ã€‚SurfaceFlinger æ˜¯åˆæˆå™¨ï¼Œè€Œç¡¬ä»¶æ··åˆæ¸²æŸ“å™¨æ˜¯åˆ¶ä½œå™¨ã€‚ BufferQueueBufferQueues æ˜¯ Android å›¾å½¢ç»„ä»¶ä¹‹é—´çš„ç²˜åˆå‰‚ã€‚å®ƒä»¬æ˜¯ä¸€å¯¹é˜Ÿåˆ—ï¼Œå¯ä»¥è°ƒè§£ç¼“å†²åŒºä»ç”Ÿäº§æ–¹åˆ°æ¶ˆè€—æ–¹çš„å›ºå®šå‘¨æœŸã€‚ä¸€æ—¦ç”Ÿäº§æ–¹ç§»äº¤å…¶ç¼“å†²åŒºï¼ŒSurfaceFlinger ä¾¿ä¼šè´Ÿè´£å°†æ‰€æœ‰å†…å®¹åˆæˆåˆ°æ˜¾ç¤ºéƒ¨åˆ†ã€‚ æœ‰å…³ BufferQueue é€šä¿¡è¿‡ç¨‹ï¼Œè¯·å‚è§ä¸‹å›¾ã€‚ å›¾ 3. BufferQueue é€šä¿¡è¿‡ç¨‹ BufferQueue åŒ…å«å°†å›¾åƒæµç”Ÿäº§æ–¹ä¸å›¾åƒæµæ¶ˆè€—æ–¹ç»“åˆåœ¨ä¸€èµ·çš„é€»è¾‘ã€‚å›¾åƒç”Ÿäº§æ–¹çš„ä¸€äº›ç¤ºä¾‹åŒ…æ‹¬ç”±ç›¸æœº HAL æˆ– OpenGL ES æ¸¸æˆç”Ÿæˆçš„ç›¸æœºé¢„è§ˆã€‚å›¾åƒæ¶ˆè€—æ–¹çš„ä¸€äº›ç¤ºä¾‹åŒ…æ‹¬ SurfaceFlinger æˆ–æ˜¾ç¤º OpenGL ES æµçš„å¦ä¸€ä¸ªåº”ç”¨ï¼Œå¦‚æ˜¾ç¤ºç›¸æœºå–æ™¯å™¨çš„ç›¸æœºåº”ç”¨ã€‚ BufferQueue æ˜¯å°†ç¼“å†²åŒºæ± ä¸é˜Ÿåˆ—ç›¸ç»“åˆçš„æ•°æ®ç»“æ„ï¼Œå®ƒä½¿ç”¨ Binder IPC åœ¨è¿›ç¨‹ä¹‹é—´ä¼ é€’ç¼“å†²åŒºã€‚ç”Ÿäº§æ–¹æ¥å£ï¼Œæˆ–è€…æ‚¨ä¼ é€’ç»™æƒ³è¦ç”Ÿæˆå›¾å½¢ç¼“å†²åŒºçš„æŸä¸ªäººçš„å†…å®¹ï¼Œå³æ˜¯ IGraphicBufferProducerï¼ˆSurfaceTexture çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚BufferQueue é€šå¸¸ç”¨äºæ¸²æŸ“åˆ° Surfaceï¼Œå¹¶ä¸”ä¸ GL æ¶ˆè€—æ–¹åŠå…¶ä»–ä»»åŠ¡ä¸€èµ·æ¶ˆè€—å†…å®¹ã€‚ BufferQueue å¯ä»¥åœ¨ä¸‰ç§ä¸åŒçš„æ¨¡å¼ä¸‹è¿è¡Œï¼š ç±»åŒæ­¥æ¨¡å¼ - é»˜è®¤æƒ…å†µä¸‹ï¼ŒBufferQueue åœ¨ç±»åŒæ­¥æ¨¡å¼ä¸‹è¿è¡Œï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œä»ç”Ÿäº§æ–¹è¿›å…¥çš„æ¯ä¸ªç¼“å†²åŒºéƒ½åœ¨æ¶ˆè€—æ–¹é‚£é€€å‡ºã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ä¸ä¼šèˆå¼ƒä»»ä½•ç¼“å†²åŒºã€‚å¦‚æœç”Ÿäº§æ–¹é€Ÿåº¦å¤ªå¿«ï¼Œåˆ›å»ºç¼“å†²åŒºçš„é€Ÿåº¦æ¯”æ¶ˆè€—ç¼“å†²åŒºçš„é€Ÿåº¦æ›´å¿«ï¼Œå®ƒå°†é˜»å¡å¹¶ç­‰å¾…å¯ç”¨çš„ç¼“å†²åŒºã€‚ éé˜»å¡æ¨¡å¼ - BufferQueue è¿˜å¯ä»¥åœ¨éé˜»å¡æ¨¡å¼ä¸‹è¿è¡Œï¼Œåœ¨æ­¤ç±»æƒ…å†µä¸‹ï¼Œå®ƒä¼šç”Ÿæˆé”™è¯¯ï¼Œè€Œä¸æ˜¯ç­‰å¾…ç¼“å†²åŒºã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ä¹Ÿä¸ä¼šèˆå¼ƒç¼“å†²åŒºã€‚è¿™æœ‰åŠ©äºé¿å…å¯èƒ½ä¸äº†è§£å›¾å½¢æ¡†æ¶çš„å¤æ‚ä¾èµ–é¡¹çš„åº”ç”¨è½¯ä»¶å‡ºç°æ½œåœ¨æ­»é”ç°è±¡ã€‚ èˆå¼ƒæ¨¡å¼ - æœ€åï¼ŒBufferQueue å¯ä»¥é…ç½®ä¸ºä¸¢å¼ƒæ—§ç¼“å†²åŒºï¼Œè€Œä¸æ˜¯ç”Ÿæˆé”™è¯¯æˆ–è¿›è¡Œç­‰å¾…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¯¹çº¹ç†è§†å›¾æ‰§è¡Œ GL æ¸²æŸ“å¹¶å°½å¿«ç»˜åˆ¶ï¼Œåˆ™å¿…é¡»ä¸¢å¼ƒç¼“å†²åŒºã€‚ ä¸ºäº†æ‰§è¡Œè¿™é¡¹å·¥ä½œçš„å¤§éƒ¨åˆ†ç¯èŠ‚ï¼ŒSurfaceFlinger å°±åƒå¦ä¸€ä¸ª OpenGL ES å®¢æˆ·ç«¯ä¸€æ ·å·¥ä½œã€‚ä¾‹å¦‚ï¼Œå½“ SurfaceFlinger æ­£åœ¨ç§¯æåœ°å°†ä¸€ä¸ªç¼“å†²åŒºæˆ–ä¸¤ä¸ªç¼“å†²åŒºåˆæˆåˆ°ç¬¬ä¸‰ä¸ªç¼“å†²åŒºä¸­æ—¶ï¼Œå®ƒä½¿ç”¨çš„æ˜¯ OpenGL ESã€‚ Hardware Composer HAL æ‰§è¡Œå¦ä¸€åŠå·¥ä½œã€‚è¯¥ HAL å……å½“æ‰€æœ‰ Android å›¾å½¢æ¸²æŸ“çš„ä¸­å¿ƒç‚¹ã€‚","link":"/2024/03/25/GraphicsOverriew/"},{"title":"HashMap","text":"å¸¸è§Mapç±»ç®€è¿°ï¼šHashMapæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚éœ€è¦çº¿ç¨‹å®‰å…¨çš„å“ˆå¸Œéšå°„ç±»ï¼Œåº”ä½¿ç”¨å®ç°äº†åˆ†æ®µé”ï¼ˆ1.8ï¼‰çš„ConcurrentHashMapï¼Œè€Œä¸å»ºè®®ä½¿ç”¨é—ç•™ç±»HashTableï¼ˆHashTableå®ç°çº¿ç¨‹å®‰å…¨æ˜¯ä¾é ç”¨synchronizedå…³é”®å­—ä¿®é¥°put/getæ–¹æ³•ï¼Œæ•ˆç‡è¾ƒä½ï¼‰ã€‚ å¦‚æœéœ€è¦ä¿å­˜è®°å½•æ’å…¥çš„é¡ºåºï¼Œå¯ä½¿ç”¨LinkHashMap()ï¼Œå…¶å†…éƒ¨å®ç°äº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå³æ¯ä¸ªèŠ‚ç‚¹æœ¬èº«è®°å½•äº†å‰åèŠ‚ç‚¹çš„å¼•ç”¨ã€‚(btw:MessageQueueæ˜¯å•é“¾è¡¨) (1) HashMapï¼šå®ƒæ ¹æ®é”®çš„hashCodeå€¼å­˜å‚¨æ•°æ®ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥ç›´æ¥å®šä½åˆ°å®ƒçš„å€¼ï¼Œå› è€Œå…·æœ‰å¾ˆå¿«çš„è®¿é—®é€Ÿåº¦ï¼Œä½†éå†é¡ºåºå´æ˜¯ä¸ç¡®å®šçš„ã€‚ HashMapæœ€å¤šåªå…è®¸ä¸€æ¡è®°å½•çš„é”®ä¸ºnullï¼Œå…è®¸å¤šæ¡è®°å½•çš„å€¼ä¸ºnullã€‚HashMapéçº¿ç¨‹å®‰å…¨ï¼Œå³ä»»ä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™HashMapï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚å¦‚æœéœ€è¦æ»¡è¶³çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥ä½¿ç”¨ConcurrentHashMapï¼ˆsynchronizedMapä¸HashTableéƒ½å› ä¸ºå…¶å®ç°çš„çº¿ç¨‹å®‰å…¨ä¾é å…¨è¡¨é”å¯¼è‡´æ€§èƒ½è¾ƒå·®ï¼Œæ•…ä¸å»ºè®®ï¼‰ã€‚ (2) ä¸æ¨èçš„çº¿ç¨‹å®‰å…¨Mapï¼š(2.1)HashTableâ€‹ Hashtableæ˜¯é—ç•™ç±»ï¼Œå¾ˆå¤šæ˜ å°„çš„å¸¸ç”¨åŠŸèƒ½ä¸HashMapç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å®ƒæ‰¿è‡ªDictionaryç±»ï¼Œå¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒHashTableçš„get/putæ–¹æ³•éƒ½è¢«synchronizedå…³é”®å­—ä¿®é¥°ï¼Œè¯´æ˜å®ƒä»¬æ˜¯æ–¹æ³•çº§åˆ«é˜»å¡çš„ï¼Œå®ƒä»¬å ç”¨å…±äº«èµ„æºé”ï¼Œæ‰€ä»¥å¯¼è‡´åŒæ—¶åªèƒ½ä¸€ä¸ªçº¿ç¨‹æ“ä½œgetæˆ–è€…putï¼Œè€Œä¸”get/putæ“ä½œä¸èƒ½åŒæ—¶æ‰§è¡Œï¼Œæ‰€ä»¥è¿™ç§åŒæ­¥çš„é›†åˆæ•ˆç‡éå¸¸ä½ï¼Œä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨è¿™ä¸ªé›†åˆã€‚ (2.2)SynchronizedMapâ€‹ Collections.synchronizedMapç±»ä¼¼ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯ HashMap å¯¹è±¡ï¼Œå…¶å®ä¹Ÿæ˜¯å¯¹ HashMap åšçš„æ–¹æ³•åšäº†ä¸€å±‚åŒ…è£…ï¼Œé‡Œé¢ä½¿ç”¨å¯¹è±¡é”æ¥ä¿è¯å¤šçº¿ç¨‹åœºæ™¯ä¸‹æ“ä½œå®‰å…¨ï¼Œæœ¬è´¨ä¹Ÿæ˜¯å¯¹ HashMap è¿›è¡Œå…¨è¡¨é”ï¼ï¼Œæ€§èƒ½ä½ä¸‹ (3) ConcurrentHashMap:è¿™ä¸ªä¹Ÿæ˜¯æœ€æ¨èä½¿ç”¨çš„çº¿ç¨‹å®‰å…¨çš„Mapï¼Œä¹Ÿæ˜¯å®ç°æ–¹å¼æœ€å¤æ‚çš„ä¸€ä¸ªé›†åˆï¼Œæ¯ä¸ªç‰ˆæœ¬çš„å®ç°æ–¹å¼ä¹Ÿä¸ä¸€æ ·ï¼Œåœ¨jdk8ä¹‹å‰æ˜¯ä½¿ç”¨åˆ†æ®µåŠ é”çš„ä¸€ä¸ªæ–¹å¼ï¼Œåˆ†æˆ16ä¸ªsegmentï¼Œæ¯æ¬¡åªåŠ é”å…¶ä¸­ä¸€ä¸ªsegmentï¼Œè€Œåœ¨jdk8åŠ å…¥äº†çº¢é»‘æ ‘å’ŒCASç®—æ³•åï¼Œåˆæ”¹ç”¨synchronizedé”ä½å“ˆå¸Œæ•°ç»„çš„å¤´ç»“ç‚¹ä½œä¸ºçº¿ç¨‹å®‰å…¨æ¥å®ç°ã€‚ (4) LinkedHashMapï¼šLinkedHashMapæ˜¯HashMapçš„ä¸€ä¸ªå­ç±»ï¼Œä¿å­˜äº†è®°å½•çš„æ’å…¥é¡ºåºï¼Œåœ¨ç”¨Iteratoréå†LinkedHashMapæ—¶ï¼Œå…ˆå¾—åˆ°çš„è®°å½•è‚¯å®šæ˜¯å…ˆæ’å…¥çš„ï¼Œä¹Ÿå¯ä»¥åœ¨æ„é€ æ—¶å¸¦å‚æ•°ï¼ŒæŒ‰ç…§è®¿é—®æ¬¡åºæ’åºã€‚ (5) TreeMapï¼šTreeMapå®ç°SortedMapæ¥å£ï¼Œèƒ½å¤ŸæŠŠå®ƒä¿å­˜çš„è®°å½•æ ¹æ®é”®æ’åºï¼Œé»˜è®¤æ˜¯æŒ‰é”®å€¼çš„å‡åºæ’åºï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæ’åºçš„æ¯”è¾ƒå™¨ï¼Œå½“ç”¨Iteratoréå†TreeMapæ—¶ï¼Œå¾—åˆ°çš„è®°å½•æ˜¯æ’è¿‡åºçš„ã€‚å¦‚æœä½¿ç”¨æ’åºçš„æ˜ å°„ï¼Œå»ºè®®ä½¿ç”¨TreeMapã€‚åœ¨ä½¿ç”¨TreeMapæ—¶ï¼Œkeyå¿…é¡»å®ç°Comparableæ¥å£æˆ–è€…åœ¨æ„é€ TreeMapä¼ å…¥è‡ªå®šä¹‰çš„Comparatorï¼Œå¦åˆ™ä¼šåœ¨è¿è¡Œæ—¶æŠ›å‡ºjava.lang.ClassCastExceptionç±»å‹çš„å¼‚å¸¸ã€‚ å¯¹äºä¸Šè¿°å››ç§Mapç±»å‹çš„ç±»ï¼Œè¦æ±‚æ˜ å°„ä¸­çš„keyæ˜¯ä¸å¯å˜å¯¹è±¡ã€‚ä¸å¯å˜å¯¹è±¡æ˜¯è¯¥å¯¹è±¡åœ¨åˆ›å»ºåå®ƒçš„å“ˆå¸Œå€¼ä¸ä¼šè¢«æ”¹å˜ã€‚å¦‚æœå¯¹è±¡çš„å“ˆå¸Œå€¼å‘ç”Ÿå˜åŒ–ï¼ŒMapå¯¹è±¡å¾ˆå¯èƒ½å°±å®šä½ä¸åˆ°æ˜ å°„çš„ä½ç½®äº†ã€‚ HashMapåŸç†é€šè¿‡ä¸Šé¢çš„æ¯”è¾ƒï¼Œæˆ‘ä»¬çŸ¥é“äº†HashMapæ˜¯Javaçš„Mapå®¶æ—ä¸­ä¸€ä¸ªæ™®é€šæˆå‘˜ï¼Œé‰´äºå®ƒå¯ä»¥æ»¡è¶³å¤§å¤šæ•°åœºæ™¯çš„ä½¿ç”¨æ¡ä»¶ï¼Œæ‰€ä»¥æ˜¯ä½¿ç”¨é¢‘åº¦æœ€é«˜çš„ä¸€ä¸ªã€‚ä¸‹æ–‡æˆ‘ä»¬ä¸»è¦ç»“åˆæºç ï¼Œä»å­˜å‚¨ç»“æ„ã€å¸¸ç”¨æ–¹æ³•åˆ†æã€æ‰©å®¹ä»¥åŠå®‰å…¨æ€§ç­‰æ–¹é¢æ·±å…¥è®²è§£HashMapçš„å·¥ä½œåŸç†ã€‚ (1) å­˜å‚¨ç»“æ„ï¼šä»æºç å¯çŸ¥ï¼ŒHashMapç±»ä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å­—æ®µï¼Œå°±æ˜¯ Node[] tableï¼Œå³å“ˆå¸Œæ¡¶æ•°ç»„ï¼Œæ˜æ˜¾å®ƒæ˜¯ä¸€ä¸ªNodeçš„æ•°ç»„ã€‚æˆ‘ä»¬æ¥çœ‹Node[JDK1.8]æ˜¯ä½•ç‰©ã€‚ 1234567891011121314static class Node&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; { final int hash; //ç”¨æ¥å®šä½æ•°ç»„ç´¢å¼•ä½ç½® final K key; V value; Node&lt;K,V&gt; next; //é“¾è¡¨çš„ä¸‹ä¸€ä¸ªnode Node(int hash, K key, V value, Node&lt;K,V&gt; next) { ... } public final K getKey(){ ... } public final V getValue() { ... } public final String toString() { ... } public final int hashCode() { ... } public final V setValue(V newValue) { ... } public final boolean equals(Object o) { ... }} Nodeæ˜¯HashMapçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå®ç°äº†Map.Entryæ¥å£ï¼Œæœ¬è´¨æ˜¯å°±æ˜¯ä¸€ä¸ªæ˜ å°„(é”®å€¼å¯¹)ã€‚ä¸Šå›¾ä¸­çš„æ¯ä¸ªé»‘è‰²åœ†ç‚¹å°±æ˜¯ä¸€ä¸ªNodeå¯¹è±¡ã€‚ (2) å“ˆå¸Œå†²çªï¼šHashMapå°±æ˜¯ä½¿ç”¨å“ˆå¸Œè¡¨æ¥å­˜å‚¨çš„ã€‚å“ˆå¸Œè¡¨ä¸ºè§£å†³å†²çªï¼Œå¯ä»¥é‡‡ç”¨å¼€æ”¾åœ°å€æ³•å’Œé“¾åœ°å€æ³•ç­‰æ¥è§£å†³é—®é¢˜ Javaä¸­HashMapé‡‡ç”¨äº†**é“¾åœ°å€æ³•(æ‹‰é“¾æ³•)**ã€‚é“¾åœ°å€æ³•ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ•°ç»„åŠ é“¾è¡¨çš„ç»“åˆã€‚åœ¨æ¯ä¸ªæ•°ç»„å…ƒç´ ä¸Šéƒ½ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œå½“æ•°æ®è¢«Hashåï¼Œå¾—åˆ°æ•°ç»„ä¸‹æ ‡ï¼ŒæŠŠæ•°æ®æ”¾åœ¨å¯¹åº”ä¸‹æ ‡å…ƒç´ çš„é“¾è¡¨ä¸Šã€‚ï¼ˆ1.8ä¹‹ååˆåŠ å…¥äº†çº¢é»‘æ ‘ï¼‰ (3)ä½ç½®ç¡®å®šï¼šhashCodeé«˜ä½16ä½ç›¸å¼‚æˆ–åè·Ÿn-1ç›¸ä¸ ç®€è¿°ï¼šå–Keyçš„32ä½hashCodeå€¼è¿›è¡Œä½16ä½ä¸é«˜16ä½å¼‚æˆ–è¿ç®—ï¼Œå¹¶å°†è¿ç®—ç»“æœå–æ¨¡(n-1)ã€‚ è¿™é‡Œæ’ä¸€å¥ï¼šç”±äºindexæ˜¯å–æ¨¡(n-1)çš„ï¼Œæ‰€ä»¥JDK1.8å n -&gt; 2n æ‰©å®¹æ—¶æ— éœ€é‡æ–°hashï¼Œåªéœ€è¦æŠŠå¤šå‡ºæ¥çš„ä¸€ä¸ªbitä½œä¸ºæ˜¯å¦ç§»åŠ¨åˆ°æ–°å¼€è¾Ÿç©ºé—´çš„æ ‡è®°å³å¯ åˆ†ä¸¤æ­¥ï¼š ç¬¬ä¸€æ­¥ï¼šhashCodeé«˜ä½16ä½å¼‚æˆ–hash = (hashCode &gt;&gt;&gt; 16) ^ hashcode)ã€‚ è¿™ä¸€æ­¥å¾—å‡ºä½16ä½ä¸é«˜16ä½çš„å¼‚æˆ–ç»“æœï¼Œä¹Ÿå°±æ˜¯ä¸ºäº†é«˜ä½16ä½éƒ½èƒ½å‚ä¸åˆ°åä¸€æ­¥çš„å–æ¨¡è¿ç®—ã€‚ ç¬¬äºŒæ­¥ï¼šä¸n-1ç›¸ä¸hash &amp; (n - 1) (4) æ‰©å®¹ æ‰©å®¹æ—¶æœºï¼š putæ’å…¥æˆåŠŸåï¼Œåˆ¤æ–­å®é™…å­˜åœ¨çš„é”®å€¼å¯¹æ•°é‡sizeæ˜¯å¦è¶…å¤šäº†æœ€å¤§å®¹é‡thresholdï¼Œå¦‚æœè¶…è¿‡ï¼Œè¿›è¡Œæ‰©å®¹ã€‚æ¯æ¬¡æ‰©å®¹çš„å®¹é‡éƒ½æ˜¯ä¹‹å‰å®¹é‡çš„2å€ã€‚æœ€å¤§(2^30)ã€‚ åˆå§‹å€¼ï¼š capacity å³å®¹é‡ï¼Œé»˜è®¤16ã€‚ loadFactor åŠ è½½å› å­ï¼Œé»˜è®¤æ˜¯0.75 threshold é˜ˆå€¼ã€‚ threshholdé˜ˆå€¼=å®¹é‡*åŠ è½½å› å­ã€‚é»˜è®¤12ã€‚å½“å…ƒç´ æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶ä¾¿ä¼šè§¦å‘æ‰©å®¹ã€‚ å¦‚æœæŸä¸ªæ¡¶å†…çš„å…ƒç´ è¶…è¿‡8ä¸ªï¼Œåˆ™ä¼šå°†é“¾è¡¨è½¬åŒ–æˆçº¢é»‘æ ‘ï¼ŒåŠ å¿«æ•°æ®æŸ¥è¯¢æ•ˆç‡ã€‚ å¦‚æœremoveçš„è¿‡ç¨‹ä¸­ï¼Œæ¡¶å†…çš„å…ƒç´ ä½äº6ä¸ªï¼Œçº¢é»‘æ ‘åˆä¼šè½¬åŒ–æˆé“¾è¡¨ æ‰©å®¹æœºåˆ¶ï¼š ç®€è¿°ï¼š JDK1.7ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸¤å€å¤§å°çš„æ•°ç»„ï¼Œå°†åŸæ•°ç»„ç”¨å¤´æ’æ³•çš„æ–¹å¼å°†æ‰€æœ‰èŠ‚ç‚¹rehashåæ’å…¥æ–°æ•°ç»„ï¼Œæ•…é“¾è¡¨é¡ºåºä¼šç›¸åã€‚ JDK1.8ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸¤å€å¤§å°çš„æ•°ç»„ï¼Œæ¯ä¸€ä¸ªå…ƒç´ é€šè¿‡hashè½¬æ¢åæ ‡çš„æ–¹æ³•è®¡ç®—åï¼Œæœ€é«˜ä½æ˜¯0åˆ™åæ ‡ä¸å˜ï¼Œæœ€é«˜ä½æ˜¯1åˆ™åæ ‡å˜ä¸ºâ€œåŸé•¿åº¦+åŸåæ ‡â€ã€‚è¿ç§»å…ƒç´ æ—¶æ˜¯æ­£åºçš„ï¼Œä¸ä¼šå‡ºç°é“¾è¡¨è½¬ç½®çš„å‘ç”Ÿã€‚ï¼Œ è¯¦è§£ï¼šæ‰©å®¹(resize)å°±æ˜¯é‡æ–°è®¡ç®—å®¹é‡ï¼Œå‘HashMapå¯¹è±¡é‡Œä¸åœçš„æ·»åŠ å…ƒç´ ï¼Œè€ŒHashMapå¯¹è±¡å†…éƒ¨çš„æ•°ç»„æ— æ³•è£…è½½æ›´å¤šçš„å…ƒç´ æ—¶ï¼Œå¯¹è±¡å°±éœ€è¦æ‰©å¤§æ•°ç»„çš„é•¿åº¦ï¼Œä»¥ä¾¿èƒ½è£…å…¥æ›´å¤šçš„å…ƒç´ ã€‚å½“ç„¶Javaé‡Œçš„æ•°ç»„æ˜¯æ— æ³•è‡ªåŠ¨æ‰©å®¹çš„ï¼Œæ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªæ–°çš„æ•°ç»„ä»£æ›¿å·²æœ‰çš„å®¹é‡å°çš„æ•°ç»„ï¼Œå°±åƒæˆ‘ä»¬ç”¨ä¸€ä¸ªå°æ¡¶è£…æ°´ï¼Œå¦‚æœæƒ³è£…æ›´å¤šçš„æ°´ï¼Œå°±å¾—æ¢å¤§æ°´æ¡¶ã€‚ æˆ‘ä»¬åˆ†æä¸‹resizeçš„æºç ï¼Œé‰´äºJDK1.8èå…¥äº†çº¢é»‘æ ‘ï¼Œè¾ƒå¤æ‚ï¼Œä¸ºäº†ä¾¿äºç†è§£æˆ‘ä»¬ä»ç„¶ä½¿ç”¨JDK1.7çš„ä»£ç ï¼Œå¥½ç†è§£ä¸€äº›ï¼Œæœ¬è´¨ä¸ŠåŒºåˆ«ä¸å¤§ï¼Œå…·ä½“åŒºåˆ«åæ–‡å†è¯´ã€‚ 12345678910111213void resize(int newCapacity) { //ä¼ å…¥æ–°çš„å®¹é‡ Entry[] oldTable = table; //å¼•ç”¨æ‰©å®¹å‰çš„Entryæ•°ç»„ int oldCapacity = oldTable.length; if (oldCapacity == MAXIMUM_CAPACITY) { //æ‰©å®¹å‰çš„æ•°ç»„å¤§å°å¦‚æœå·²ç»è¾¾åˆ°æœ€å¤§(2^30)äº† threshold = Integer.MAX_VALUE; //ä¿®æ”¹é˜ˆå€¼ä¸ºintçš„æœ€å¤§å€¼(2^31-1)ï¼Œè¿™æ ·ä»¥åå°±ä¸ä¼šæ‰©å®¹äº† return; } Entry[] newTable = new Entry[newCapacity]; //åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„Entryæ•°ç»„ transfer(newTable); //ï¼ï¼å°†æ•°æ®è½¬ç§»åˆ°æ–°çš„Entryæ•°ç»„é‡Œ table = newTable; //HashMapçš„tableå±æ€§å¼•ç”¨æ–°çš„Entryæ•°ç»„ threshold = (int)(newCapacity * loadFactor);//ä¿®æ”¹é˜ˆå€¼} è¿™é‡Œå°±æ˜¯ä½¿ç”¨ä¸€ä¸ªå®¹é‡æ›´å¤§çš„æ•°ç»„æ¥ä»£æ›¿å·²æœ‰çš„å®¹é‡å°çš„æ•°ç»„ï¼Œtransfer()æ–¹æ³•å°†åŸæœ‰Entryæ•°ç»„çš„å…ƒç´ æ‹·è´åˆ°æ–°çš„Entryæ•°ç»„é‡Œã€‚ 1234567891011121314151617void transfer(Entry[] newTable) { Entry[] src = table; //srcå¼•ç”¨äº†æ—§çš„Entryæ•°ç»„ int newCapacity = newTable.length; for (int j = 0; j &lt; src.length; j++) { //éå†æ—§çš„Entryæ•°ç»„ Entry&lt;K,V&gt; e = src[j]; //å–å¾—æ—§Entryæ•°ç»„çš„æ¯ä¸ªå…ƒç´  if (e != null) { src[j] = null;//é‡Šæ”¾æ—§Entryæ•°ç»„çš„å¯¹è±¡å¼•ç”¨ï¼ˆforå¾ªç¯åï¼Œæ—§çš„Entryæ•°ç»„ä¸å†å¼•ç”¨ä»»ä½•å¯¹è±¡ï¼‰ do { Entry&lt;K,V&gt; next = e.next; int i = indexFor(e.hash, newCapacity); //ï¼ï¼é‡æ–°è®¡ç®—æ¯ä¸ªå…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä½ç½® e.next = newTable[i]; //æ ‡è®°[1] newTable[i] = e; //å°†å…ƒç´ æ”¾åœ¨æ•°ç»„ä¸Š e = next; //è®¿é—®ä¸‹ä¸€ä¸ªEntryé“¾ä¸Šçš„å…ƒç´  } while (e != null); } }} newTable[i]çš„å¼•ç”¨èµ‹ç»™äº†e.nextï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº†å•é“¾è¡¨çš„å¤´æ’å…¥æ–¹å¼ï¼ŒåŒä¸€ä½ç½®ä¸Šæ–°å…ƒç´ æ€»ä¼šè¢«æ”¾åœ¨é“¾è¡¨çš„å¤´éƒ¨ä½ç½®ï¼›è¿™æ ·å…ˆæ”¾åœ¨ä¸€ä¸ªç´¢å¼•ä¸Šçš„å…ƒç´ ç»ˆä¼šè¢«æ”¾åˆ°Entryé“¾çš„å°¾éƒ¨(å¦‚æœå‘ç”Ÿäº†hashå†²çªçš„è¯ï¼‰ï¼Œè¿™ä¸€ç‚¹å’ŒJdk1.8æœ‰åŒºåˆ«ï¼Œä¸‹æ–‡è¯¦è§£ã€‚åœ¨æ—§æ•°ç»„ä¸­åŒä¸€æ¡Entryé“¾ä¸Šçš„å…ƒç´ ï¼Œé€šè¿‡é‡æ–°è®¡ç®—ç´¢å¼•ä½ç½®åï¼Œæœ‰å¯èƒ½è¢«æ”¾åˆ°äº†æ–°æ•°ç»„çš„ä¸åŒä½ç½®ä¸Šã€‚ ä¸‹é¢ä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸‹æ‰©å®¹è¿‡ç¨‹ã€‚å‡è®¾äº†æˆ‘ä»¬çš„hashç®—æ³•å°±æ˜¯ç®€å•çš„ç”¨key mod ä¸€ä¸‹è¡¨çš„å¤§å°ï¼ˆä¹Ÿå°±æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰ã€‚å…¶ä¸­çš„\bå“ˆå¸Œæ¡¶æ•°ç»„tableçš„size=2ï¼Œ æ‰€ä»¥key = 3ã€7ã€5ï¼Œputé¡ºåºä¾æ¬¡ä¸º 5ã€7ã€3ã€‚åœ¨mod 2ä»¥åéƒ½å†²çªåœ¨table[1]è¿™é‡Œäº†ã€‚è¿™é‡Œå‡è®¾è´Ÿè½½å› å­ loadFactor=1ï¼Œå³å½“é”®å€¼å¯¹çš„å®é™…å¤§å°size å¤§äº tableçš„å®é™…å¤§å°æ—¶è¿›è¡Œæ‰©å®¹ã€‚æ¥ä¸‹æ¥çš„ä¸‰ä¸ªæ­¥éª¤æ˜¯å“ˆå¸Œæ¡¶æ•°ç»„ resizeæˆ4ï¼Œç„¶åæ‰€æœ‰çš„Nodeé‡æ–°rehashçš„è¿‡ç¨‹ã€‚ JDK1.8æ‰©å®¹åšäº†ä¼˜åŒ–ï¼Œä¸å†éœ€è¦é‡æ–°å…¨éƒ¨rehashï¼Œè€Œæ˜¯æ ¹æ®hashå€¼æ–°å¢çš„é‚£ä¸ªbitæ˜¯1è¿˜æ˜¯0å°±å¥½äº†ï¼Œçœä¸‹äº†hashæ—¶é—´ï¼Œ åŒæ—¶è¿˜å¯ä»¥å€Ÿç”±æ–°å¢çš„1bitæ˜¯éšæœºçš„ï¼Œè€Œå‡åŒ€åœ°æŠŠä¹‹å‰å†²çªçš„èŠ‚ç‚¹é‡æ–°æ‰“æ•£äº†å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ‰©å……HashMapçš„æ—¶å€™ï¼Œä¸éœ€è¦åƒJDK1.7çš„å®ç°é‚£æ ·é‡æ–°è®¡ç®—hashï¼Œåªéœ€è¦çœ‹çœ‹åŸæ¥çš„hashå€¼æ–°å¢çš„é‚£ä¸ªbitæ˜¯1è¿˜æ˜¯0å°±å¥½äº† æˆ‘ä»¬åœ¨æ‰©å……HashMapçš„æ—¶å€™ï¼Œä¸éœ€è¦åƒJDK1.7çš„å®ç°é‚£æ ·é‡æ–°è®¡ç®—hashï¼Œåªéœ€è¦çœ‹çœ‹åŸæ¥çš„hashå€¼æ–°å¢çš„é‚£ä¸ªbitæ˜¯1è¿˜æ˜¯0å°±å¥½äº†ï¼Œæ˜¯0çš„è¯ç´¢å¼•æ²¡å˜ï¼Œæ˜¯1çš„è¯ç´¢å¼•å˜æˆâ€œåŸç´¢å¼•+oldCapâ€ï¼Œå¯ä»¥çœ‹çœ‹ä¸‹å›¾ä¸º16æ‰©å……ä¸º32çš„resizeç¤ºæ„å›¾ï¼š ï¼ˆæ³¨æ„çœ‹ï¼Œè“è‰²çš„ä¸ºæ–°å¢1bitä¸º0çš„æƒ…å†µï¼Œä¿æŒåŸindexä¸åŠ¨ï¼Œç»¿è‰²çš„ä¸ºæ–°å¢1bitä¸º1ï¼Œä¼šç§»åŠ¨åˆ°16(oldCap) + 15(srcIndex)çš„ä½ç½®ä¸Šï¼‰ JDK1.8çœå»äº†é‡æ–°è®¡ç®—hashå€¼çš„æ—¶é—´ï¼Œè€Œä¸”åŒæ—¶ï¼Œç”±äºæ–°å¢çš„1bitæ˜¯0è¿˜æ˜¯1å¯ä»¥è®¤ä¸ºæ˜¯éšæœºçš„ï¼Œå› æ­¤resizeçš„è¿‡ç¨‹ï¼Œå‡åŒ€çš„æŠŠä¹‹å‰çš„å†²çªçš„èŠ‚ç‚¹åˆ†æ•£åˆ°æ–°çš„bucketäº† JDK8çš„å…ƒç´ è¿ç§» JDK8åˆ™å› ä¸ºå·§å¦™çš„è®¾è®¡ï¼Œæ€§èƒ½æœ‰äº†å¤§å¤§çš„æå‡ï¼šç”±äºæ•°ç»„çš„å®¹é‡æ˜¯ä»¥2çš„å¹‚æ¬¡æ–¹æ‰©å®¹çš„ï¼Œé‚£ä¹ˆä¸€ä¸ªEntityåœ¨æ‰©å®¹æ—¶ï¼Œæ–°çš„ä½ç½®è¦ä¹ˆåœ¨åŸä½ç½®ï¼Œè¦ä¹ˆåœ¨åŸé•¿åº¦+åŸä½ç½®çš„ä½ç½®ã€‚åŸå› å¦‚ä¸‹å›¾ï¼š æ•°ç»„é•¿åº¦å˜ä¸ºåŸæ¥çš„2å€ï¼Œè¡¨ç°åœ¨äºŒè¿›åˆ¶ä¸Šå°±æ˜¯å¤šäº†ä¸€ä¸ªé«˜ä½å‚ä¸æ•°ç»„ä¸‹æ ‡ç¡®å®šã€‚æ­¤æ—¶ï¼Œä¸€ä¸ªå…ƒç´ é€šè¿‡hashè½¬æ¢åæ ‡çš„æ–¹æ³•è®¡ç®—åï¼Œæ°å¥½å‡ºç°ä¸€ä¸ªç°è±¡ï¼šæœ€é«˜ä½æ˜¯0åˆ™åæ ‡ä¸å˜ï¼Œæœ€é«˜ä½æ˜¯1åˆ™åæ ‡å˜ä¸ºâ€œ10000+åŸåæ ‡â€ï¼Œå³â€œåŸé•¿åº¦+åŸåæ ‡â€ã€‚å¦‚ä¸‹å›¾ï¼ˆæ‰©å®¹16 -&gt; 32ï¼‰ï¼š å› æ­¤ï¼Œåœ¨æ‰©å®¹æ—¶ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—å…ƒç´ çš„hashäº†ï¼Œåªéœ€è¦åˆ¤æ–­æœ€é«˜ä½æ˜¯1è¿˜æ˜¯0å°±å¥½äº†ã€‚ (5)Geté€šè¿‡hashCodeé«˜ä½16ä½ç›¸å¼‚æˆ–åè·Ÿn-1ç›¸ä¸ï¼Œå¾—å‡ºçš„æ•°ç»„ä½ç½®indexï¼Œå¦‚è¯¥ä½ç½®æ˜¯ç›®æ ‡åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚è¯¥ä½ç½®æ˜¯é“¾è¡¨èŠ‚ç‚¹åˆ™é“¾è¡¨æ–¹å¼ç´¢å¼•ï¼Œå¦‚æœæ˜¯çº¢é»‘æ ‘åˆ™ä»¥çº¢é»‘æ ‘çš„æ–¹å¼ç´¢å¼•ã€‚ (6)Putä¹Ÿæ˜¯å…ˆé€šè¿‡hashCodeä¸å½“å‰æ•°ç»„é•¿åº¦n-1è®¡ç®—å‡ºindexï¼Œç„¶ååˆ¤æ–­è¯¥ä½ç½®æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™ç›´æ¥æ’å…¥å…ƒç´ ï¼›å¦‚æœè¯¥ä½ç½®åªæœ‰ä¸€ä¸ªå…ƒç´ åˆ™è½¬åŒ–ä¸ºé“¾è¡¨å¹¶æ’å…¥ï¼›å¦‚æœè¯¥ä½ç½®ä¸ºé“¾è¡¨èŠ‚ç‚¹åˆ™ä»¥å°¾æ’æ³•çš„æ–¹å¼æ’å…¥æ–°å¢èŠ‚ç‚¹ï¼›å¦‚æœè¯¥ä½ç½®ä¸ºçº¢é»‘æ ‘ï¼Œåˆ™ä»¥çº¢é»‘æ ‘çš„æ–¹å¼æ’å…¥æ–°å¢èŠ‚ç‚¹ã€‚ æ’å…¥åï¼Œè¶…è¿‡é˜ˆå€¼åˆ™æ‰©å®¹ã€‚ ConcurrentHashMapåŸç†ç®€è¿°ï¼šconcurrentHashMapåœ¨JDK1.7ä¹‹å‰æ˜¯åˆ†æ®µé”ï¼Œä¹Ÿå°±æ˜¯åœ¨å­˜å‚¨æ–¹é¢æ˜¯ä¸€ä¸ª Segment æ•°ç»„ï¼Œä¸€ä¸ª Segment å°±æ˜¯ä¸€ä¸ªå­å“ˆå¸Œè¡¨ï¼ŒSegment é‡Œç»´æŠ¤äº†ä¸€ä¸ª HashEntry æ•°ç»„ï¼Œç›¸å½“äºæ˜¯æŠŠæ•´ä¸ªå“ˆå¸Œè¡¨åˆ†å‰²æˆäº†ssizeä¸ªsegmentæ•°ç»„ï¼Œå¢åˆ æ—¶é€šè¿‡å¯¹å¯¹åº”çš„segmentåŠ é”ï¼Œè¾¾åˆ°åªé”ä¸€æ®µä¸å½±å“å…¶ä»–segmentçš„æ•ˆæœï¼›åŒæ—¶ä¹Ÿä¸ºæ¯ä¸ªèŠ‚ç‚¹Nodeçš„valå’Œnextéƒ½ä½¿ç”¨äº†volatileå…³é”®å­—ä¿è¯å¯è§æ€§ã€‚ JDK1.8ä¹‹åä¿ç•™äº†NodeèŠ‚ç‚¹çš„valå’Œnextå­—æ®µçš„volatileå…³é”®å­—ï¼Œä¸å†ä½¿ç”¨Segmentåˆ†æ®µé”ï¼Œè€Œæ˜¯ä»¥tableæ•°ç»„å¯¹åº”indexçš„ç»“ç‚¹ä½œä¸ºsynchronizedçš„é”ã€‚ ConcurrentHashMapä¿è¯çº¿ç¨‹å®‰å…¨ä¸»è¦æœ‰ä¸‰ä¸ªåœ°æ–¹ã€‚ ä¸€ã€ä½¿ç”¨volatileä¿è¯å½“Nodeä¸­çš„å€¼å˜åŒ–æ—¶å¯¹äºå…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ äºŒã€å½“å¯¹åº”indexç»“ç‚¹ä¸ºnullæ—¶ï¼ˆæœªæœ‰å“ˆå¸Œå†²çªï¼‰ï¼Œä½¿ç”¨CASæ“ä½œæ¥ä¿è¯æ•°æ®èƒ½æ­£ç¡®çš„å†™å…¥ ä¸‰ã€å…¶ä»–æƒ…å†µï¼ˆå³é“¾è¡¨/çº¢é»‘æ ‘ï¼‰ä½¿ç”¨tableæ•°ç»„çš„å¤´ç»“ç‚¹ï¼ˆé“¾è¡¨æˆ–æ ‘çš„å¤´ç»“ç‚¹ï¼‰ä½œä¸ºsynchronizedçš„é”æ¥ä¿è¯å†™æ“ä½œçš„å®‰å…¨ putå¤§ä½“æ€è·¯ï¼š å¦‚æœtableæ•°ç»„è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™ä½¿ç”¨CASè¿›è¡Œåˆå§‹åŒ– å¦‚æœtableæ•°ç»„ä¸­iä½ç½®å¤„å…ƒç´ ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨CASå°†table[i]çš„å€¼è®¾ç½®ä¸ºvalue å¦‚æœå…¶ä»–çº¿ç¨‹æ­£åœ¨å¯¹tableæ•°ç»„è¿›è¡Œæ‰©å®¹ï¼Œåˆ™å½“å‰çº¿ç¨‹å»ååŠ©å…¶è¿›è¡Œæ‰©å®¹ å…¶ä»–æƒ…å†µï¼Œåˆ™ä½¿ç”¨synchronizedé”ä½**table[i]è¿™ä¸ªå…ƒç´ ï¼ˆé“¾è¡¨è¡¨å¤´æˆ–çº¢é»‘æ ‘æ ¹èŠ‚ç‚¹**ï¼‰ï¼Œå¹¶å°†å…ƒç´ è¿½åŠ æ’å…¥åˆ°é“¾è¡¨æˆ–çº¢é»‘æ ‘ä¸­ï¼›æ’å…¥åï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦å°†è¯¥æ¡¶çš„æ•°æ®ç»“æ„ç”±é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ã€‚ æˆåŠŸè®¾ç½®&lt;key, value&gt;åï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹ è¦æƒ³å¯¹é“¾è¡¨æˆ–çº¢é»‘æ ‘è¿›è¡Œputæ“ä½œï¼Œå¿…é¡»æ‹¿åˆ°è¡¨å¤´æˆ–æ ¹èŠ‚ç‚¹ï¼Œæ‰€ä»¥ï¼Œé”ä½äº†è¡¨å¤´æˆ–æ ¹èŠ‚ç‚¹ï¼Œå°±ç›¸å½“äºé”ä½äº†æ•´ä¸ªé“¾è¡¨æˆ–è€…æ•´æ£µæ ‘ã€‚è¿™ä¸ªè®¾è®¡ä¸åˆ†æ®µé”çš„æ€æƒ³ä¸€è‡´ï¼Œåªæ˜¯å…¶ä»–è¯»å–æ“ä½œéœ€è¦ç”¨casæ¥ä¿è¯ã€‚ Getgetç®€å•å¾ˆå¤šï¼Œç”±äºgetåœ¨Node.valå€¼è¢«volatileä¿®é¥°çš„æƒ…å†µä¸‹ä¸éœ€è¦è€ƒè™‘åŠ é”ï¼Œæ‰€ä»¥åªéœ€è¦æ­£å¸¸æ£€ç´¢å³å¯ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡hashCodeé«˜ä½16ä½ç›¸å¼‚æˆ–åè·Ÿn-1ç›¸ä¸ï¼Œå¾—å‡ºçš„æ•°ç»„ä½ç½®indexï¼Œå¦‚è¯¥ä½ç½®æ˜¯ç›®æ ‡åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚è¯¥ä½ç½®æ˜¯é“¾è¡¨èŠ‚ç‚¹åˆ™é“¾è¡¨æ–¹å¼ç´¢å¼•ï¼Œå¦‚æœæ˜¯çº¢é»‘æ ‘åˆ™ä»¥çº¢é»‘æ ‘çš„æ–¹å¼ç´¢å¼•ã€‚ æ‰©å®¹ä¸­ï¼Œä¸”å½“å‰indexä½ç½®æœªå®Œæˆæ‰©å®¹çš„ï¼Œç”±äºæ‰©å®¹è¿‡ç¨‹æ˜¯å½¢æˆhnå’Œlnå¤åˆ¶é“¾è€Œéå‰ªåˆ‡çš„ï¼Œæ•…åŸä½ç½®ä»å¯æ­£å¸¸è®¿é—®ã€‚ æ‰©å®¹ä¸­ï¼Œä¸”å½“å‰indexå·²å®Œæˆæ‰©å®¹çš„ï¼Œç”±äºè¿ç§»è¿‡ç¨‹ä¸­æ¯ç§»åŠ¨å®Œä¸€ä¸ªhashæ¡¶åŸåœ°ä¼šç•™ä¸‹æ–°åœ°å€çš„å¤´ç»“ç‚¹ï¼Œä»¥è¯¥å¤´èŠ‚ç‚¹è¿›è¡Œç´¢å¼•å³å¯ã€‚ Sizeè‡³äºsize()æ–¹æ³•åœ¨JDK1.8ç‰ˆæœ¬ä¸­ï¼Œå¯¹äºsizeçš„è®¡ç®—ï¼Œåœ¨æ‰©å®¹å’ŒaddCount()æ–¹æ³•å°±å·²ç»æœ‰å¤„ç†äº†ï¼ŒJDK1.7æ˜¯åœ¨è°ƒç”¨size()æ–¹æ³•æ‰å»è®¡ç®— Transferæ‰©å®¹(ConcurrentHashMap1.8 - æ‰©å®¹è¯¦è§£_ZOKEKAIçš„åšå®¢-CSDNåšå®¢_concurrenthashmap æ‰©å®¹ å¤šçº¿ç¨‹ååŒæ‰©å®¹ï¼›indexçš„è®¡ç®—ä¾ç„¶ä¸JDK1.8ä¸€æ ·ï¼Œæ˜¯ä¾é æ–°å¢çš„1bitä¸º0åˆ™ç•™åœ¨åŸindexï¼Œä¸º1åˆ™è¿ç§»åˆ°index + åŸæ•°ç»„é•¿åº¦ã€‚","link":"/2021/11/01/HashMap/"},{"title":"HttpProtocol","text":"Http ç¼“å­˜åœ¨è¯·æ±‚ä¸€ä¸ªé™æ€æ–‡ä»¶çš„æ—¶å€™ï¼ˆå›¾ç‰‡ï¼Œcssï¼Œjsï¼‰ç­‰ï¼Œè¿™äº›æ–‡ä»¶çš„ç‰¹ç‚¹æ˜¯æ–‡ä»¶ä¸ç»å¸¸å˜åŒ–ï¼Œå°†è¿™äº›ä¸ç»å¸¸å˜åŒ–çš„æ–‡ä»¶å­˜å‚¨èµ·æ¥ï¼Œå¯¹å®¢æˆ·ç«¯æ¥è¯´æ˜¯ä¸€ä¸ªä¼˜åŒ–ç”¨æˆ·æµè§ˆä½“éªŒçš„æ–¹æ³•ã€‚é‚£ä¹ˆè¿™ä¸ªå°±æ˜¯å®¢æˆ·ç«¯ç¼“å­˜çš„æ„ä¹‰äº†ã€‚ ç®€è¿°ï¼š å¼ºåˆ¶ç¼“å­˜æ˜¯æ ¹æ®ä¸Šæ¬¡å“åº”headerä¸­çš„Cache-Control:Max-ageæˆ–æ˜¯Expriesï¼Œå®¢æˆ·ç«¯ç›´æ¥åˆ¤æ–­ç¼“å­˜æ˜¯å¦èƒ½ç”¨è¯¥èµ„æºç¼“å­˜ï¼› åå•†ç¼“å­˜éœ€è¦å®¢æˆ·ç«¯ç”¨è®°å½•ä¸‹æ¥çš„ä¸Šæ¬¡å“åº”headerä¸­çš„ETagæˆ–æ˜¯Last-Modifiedï¼Œé€šè¿‡ä¸å‘æœåŠ¡å™¨çš„è¯·æ±‚requestçš„headerä¸­èµ‹å€¼If-None-Matchæˆ–If-Modified-Sinceï¼Œç”±æœåŠ¡å™¨åˆ¤æ–­èµ„æºæ˜¯å¦æ›´æ–°ï¼Œç»“æœç”±codeå’Œæ˜¯å¦å­˜åœ¨bodyæ˜ç¡®æ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼› åŒæ—¶å‡ºç°çš„ä¼˜å…ˆçº§æ’åºï¼š å¼ºåˆ¶ç¼“å­˜ &gt; åå•†ç¼“å­˜ï¼›ETag &amp; If-None-Match &gt; Last-Modified &amp; If-Modified-Since ;Cache-Control &gt; Expriesï¼› å®˜æ–¹æ–‡æ¡£https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching ä¸€. å¼ºåˆ¶ç¼“å­˜å¼ºåˆ¶ç¼“å­˜å‘½ä¸­åè¯·æ±‚æ²¡æœ‰åˆ°è¾¾åç«¯ï¼Œæµè§ˆå™¨ä»ç¼“å­˜ä¸­æå–èµ„æºï¼Œä»¥statue code=200 OK(from memory cache)è¿”å› Cache-Control max-ageï¼šæŒ‡å®šç¼“å­˜çš„æœ€å¤§æœ‰æ•ˆæ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚ no-cacheï¼šè¡¨ç¤ºç¼“å­˜éœ€è¦é‡æ–°éªŒè¯ï¼Œä½†ä»ç„¶å¯ä»¥ç¼“å­˜ã€‚ no-storeï¼šè¡¨ç¤ºä¸åº”è¯¥ç¼“å­˜è¿™ä¸ªèµ„æºã€‚ publicï¼šè¡¨ç¤ºå“åº”å¯ä»¥è¢«ä»»ä½•ä¸­é—´ç¼“å­˜å­˜å‚¨ã€‚ privateï¼šè¡¨ç¤ºå“åº”åªèƒ½å¤Ÿè¢«ä¸ªäººç”¨æˆ·ç¼“å­˜ï¼Œä¸å…è®¸ä¸­é—´ç¼“å­˜å­˜å‚¨ã€‚ must-revalidateï¼šè¡¨ç¤ºå¦‚æœç¼“å­˜è¿‡æœŸï¼Œå®¢æˆ·ç«¯å¿…é¡»é‡æ–°éªŒè¯èµ„æºçš„æœ‰æ•ˆæ€§ã€‚ s-maxageï¼šç±»ä¼¼äºmax-ageï¼Œä½†åªä½œç”¨äºå…±äº«ç¼“å­˜ï¼Œæ¯”å¦‚ä»£ç†æœåŠ¡å™¨ã€‚ e.g: Cache-Control: max-age=3600, immutable è¿™è¡¨ç¤ºèµ„æºå°†åœ¨ç¼“å­˜ä¸­ä¿æŒ1å°æ—¶ï¼ˆ3600ç§’ï¼‰ï¼Œå¹¶ä¸”è¯¥èµ„æºçš„å†…å®¹åœ¨è¿™ä¸ªæ—¶é—´å†…éƒ½ä¸ä¼šæ”¹å˜ã€‚å¦‚æœå®¢æˆ·ç«¯æˆ–ä¸­é—´ç¼“å­˜æœåŠ¡å™¨æ”¶åˆ°äº†ä¸€ä¸ªå¸¦æœ‰ â€œimmutableâ€ æŒ‡ä»¤çš„èµ„æºï¼Œå¹¶ä¸”å·²ç»å°†è¯¥èµ„æºå­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œå®ƒä»¬å¯ä»¥å®‰å…¨åœ°å‡è®¾èµ„æºçš„å†…å®¹åœ¨å…¶å£°æ˜çš„æ—¶é—´å†…ä¿æŒä¸å˜ï¼Œè€Œæ— éœ€é‡æ–°éªŒè¯ã€‚ Expiresï¼ˆHttp1.0åºŸå¼ƒï¼‰ç®€è¿°ï¼šè¿‡æœŸæ—¥æœŸï¼Œå€¼ä¸ºå…·ä½“æ—¶é—´ï¼Œèµ„æºåœ¨è¿™ä¸ªæ—¶é—´ä¹‹å‰éƒ½èƒ½ä½¿ç”¨ç¼“å­˜ å¦‚ï¼šExpires:Thu, 31 Dec 2016 23:55:55 GMT äºŒ. åå•†ç¼“å­˜ETag &amp; If-None-Matchç®€è¿°ï¼šèµ„æºå…³é”®ä¿¡æ¯çš„hashï¼ŒæœåŠ¡å™¨ä¸‹å‘responseæ—¶æºå¸¦åœ¨headerä¸­çš„ETagå­—æ®µï¼Œå®¢æˆ·ç«¯å°†ä¸Šæ¬¡ç¼“å­˜ä¸‹æ¥çš„è¯¥ETagå€¼é™„åœ¨requestè¯·æ±‚headerçš„If-None-Matchä¸­ã€‚æœåŠ¡å™¨å°†å®¢æˆ·ç«¯requestå‘æ¥çš„If-None-Matchå¯¹æ¯”æœåŠ¡å™¨å½“å‰èµ„æºETagï¼Œè‹¥ç›¸åŒåˆ™ç¼“å­˜ï¼Œå³è¿”å›response304å’Œheaderï¼ˆæ— bodyï¼‰ï¼›ä¸åŒåˆ™ä¸‹å‘æ–°èµ„æºï¼Œå³è¿”å›200å’Œheader+bodyæ–°èµ„æº Last-Modified &amp; If-Modified-Sinceç®€è¿°ï¼šèµ„æºæ›´æ–°æ—¶é—´ï¼Œç±»ä¼¼ETagï¼ŒæœåŠ¡å™¨ä¸‹å‘responseæ—¶headerä¸­Last-Modifiledï¼Œå®¢æˆ·ç«¯å­˜å‚¨è¯¥GMTæ—¶é—´ï¼Œä¸‹æ¬¡è¯·æ±‚è¯¥èµ„æºæ—¶requestçš„headerä¸­If-Modified-Sinceé™„ä¸Šã€‚æœåŠ¡å™¨ä»requestä¸­å–å‡ºIf-Modified-Sinceåå°†è¯¥æ—¶é—´ä¸æœ¬åœ°çš„èµ„æºæ›´æ–°æ—¶é—´å¯¹æ¯”ï¼Œè‹¥ç›¸åŒåˆ™ç¼“å­˜ï¼Œå³è¿”å›response304å’Œheaderï¼ˆæ— bodyï¼‰ï¼›ä¸åŒåˆ™ä¸‹å‘æ–°èµ„æºï¼Œå³è¿”å›200å’Œheader+bodyæ–°èµ„æº æ•´ä½“æµç¨‹ï¼š åœ¨å‰ä¸€æ¬¡æœåŠ¡å™¨å“åº”æ—¶ä¸‹å‘æ‰€æœ‰çš„ç¼“å­˜å­—æ®µï¼ŒåŒ…æ‹¬ï¼šå¼ºåˆ¶ç¼“å­˜çš„Cache-control:max-ageã€expiresï¼Œåå•†ç¼“å­˜çš„Etagå’ŒLast-Modifiedã€‚ æ¥ä¸‹æ¥å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œä»å››ä¸ªHeaderä¸­é€‰æ‹©ä¸€ä¸ªçš„ç‰¹å®šheaderï¼ˆæ²¡å¿…è¦å¤šä¸ªï¼Œä¼šæŒ‰ä¼˜å…ˆçº§åªå–ä¸€ä¸ªï¼‰ï¼Œå³å®¢æˆ·ç«¯é€‰æ‹©æ˜¯å¼ºåˆ¶ç¼“å­˜è¿˜æ˜¯åå•†ç¼“å­˜ã€‚ å¦‚æœæ˜¯å¼ºåˆ¶ç¼“å­˜å¹¶ä¸”å‘½ä¸­ï¼ˆå³æ®ä¸Šæ¬¡è¯·æ±‚æ—¶é—´å°äºmax-ageæˆ–è€…Expiresè¿˜æ²¡åˆ°ï¼‰åˆ™ä¼šç›´æ¥å®¢æˆ·ç«¯è‡ªå–æœ¬åœ°ç¼“å­˜å¹¶è¿”å›200(from memory cache)ï¼Œè¯·æ±‚æ ¹æœ¬ä¸ä¼šåˆ°è¾¾æœåŠ¡å™¨ï¼› å¦‚æœæ˜¯åå•†ç¼“å­˜ï¼Œåˆ™ä¼šåœ¨è¯·æ±‚ä¸­å¸¦ä¸Šæ­¥éª¤1ä¸­çš„If-None-Match: cache_Etagæˆ–If-Modified-Since: cache_Last-Modifiedï¼Œå‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ æ­¤æ­¥éª¤ä»…ä¸ºåå•†ç¼“å­˜æ‰€æœ‰ï¼šæœåŠ¡å™¨å°† å®¢æˆ·ç«¯è¯·æ±‚ä¸­çš„If-None-Matchå€¼æˆ–Last-If-Modified-Sinceæ—¶é—´ ä¸æœåŠ¡å™¨ä¸­èµ„æºå€¼çš„æœ€æ–°å“ˆå¸Œå€¼æˆ–ä¿®æ”¹æ—¶é—´ æ¯”è¾ƒï¼Œå¦‚æœèµ„æºæœ‰äº†æ›´æ–°åˆ™è¿”å›200å’Œæ–°çš„èµ„æºï¼›å¦‚æœèµ„æºæ²¡æœ‰æ›´æ–°åˆ™è¿”å›304(No Modified)å’Œç©ºbody Httpç‰¹æ€§ä»€ä¹ˆæ˜¯Httpåè®® Httpåè®®æ˜¯å¯¹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¹‹é—´æ•°æ®ä¹‹é—´å®ç°å¯é æ€§çš„ä¼ è¾“æ–‡å­—ã€å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ç­‰è¶…æ–‡æœ¬æ•°æ®çš„è§„èŒƒï¼Œæ ¼å¼ç®€ç§°ä¸ºâ€œè¶…æ–‡æœ¬ä¼ è¾“åè®®â€ Httpåè®®å±äºåº”ç”¨å±‚ï¼ŒåŠç”¨æˆ·è®¿é—®çš„ç¬¬ä¸€å±‚å°±æ˜¯http TcpIpåè®®åˆ†å±‚ï¼šhttp,tlsæ‰€åœ¨çš„åº”ç”¨å±‚ï¼›tcp,udpæ‰€åœ¨çš„ä¼ è¾“å±‚ï¼›ipæ‰€åœ¨çš„ç½‘ç»œå±‚ï¼›arpï¼ˆipè§£ææˆmacï¼‰,rarpæ‰€åœ¨çš„é“¾è·¯å±‚ 1 å¸¸ç”¨HTTPçŠ¶æ€ç å’Œåˆ†ç±» HTTPçŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯HTTPè¯·æ±‚çš„è¿”å›ç»“æœã€æ ‡è¯†æœåŠ¡å™¨å¤„ç†æ˜¯å¦æ­£å¸¸ã€è¡¨æ˜è¯·æ±‚å‡ºç°çš„é”™è¯¯ç­‰ã€‚ çŠ¶æ€ç çš„ç±»åˆ«ï¼š ç±»åˆ« æè¿° 1xxï¼š æŒ‡ç¤ºä¿¡æ¯â€“è¡¨ç¤ºè¯·æ±‚å·²æ¥æ”¶ï¼Œæ­£åœ¨å¤„ç† 2xxï¼š æˆåŠŸâ€“è¡¨ç¤ºè¯·æ±‚å·²è¢«æˆåŠŸæ¥æ”¶ã€ç†è§£ã€æ¥å— 3xxï¼š é‡å®šå‘â€“è¦å®Œæˆè¯·æ±‚å¿…é¡»è¿›è¡Œæ›´è¿›ä¸€æ­¥çš„æ“ä½œ 4xxï¼š å®¢æˆ·ç«¯é”™è¯¯â€“è¯·æ±‚æœ‰è¯­æ³•é”™è¯¯æˆ–è¯·æ±‚æ— æ³•å®ç° 5xxï¼š æœåŠ¡å™¨ç«¯é”™è¯¯â€“æœåŠ¡å™¨æœªèƒ½å®ç°åˆæ³•çš„è¯·æ±‚ å¸¸è§çš„çŠ¶æ€ç ï¼š çŠ¶æ€ç  æè¿° 200ï¼š è¯·æ±‚è¢«æ­£å¸¸å¤„ç† 204ï¼š è¯·æ±‚è¢«å—ç†ä½†æ²¡æœ‰èµ„æºå¯ä»¥è¿”å› 206ï¼š å®¢æˆ·ç«¯åªæ˜¯è¯·æ±‚èµ„æºçš„ä¸€éƒ¨åˆ†ï¼ŒæœåŠ¡å™¨åªå¯¹è¯·æ±‚çš„éƒ¨åˆ†èµ„æºæ‰§è¡ŒGETæ–¹æ³•ï¼Œç›¸åº”æŠ¥æ–‡ä¸­é€šè¿‡Content-RangeæŒ‡å®šèŒƒå›´çš„èµ„æºã€‚ 301ï¼š æ°¸ä¹…æ€§é‡å®šå‘ 302ï¼š ä¸´æ—¶é‡å®šå‘ 303ï¼š ä¸302çŠ¶æ€ç æœ‰ç›¸ä¼¼åŠŸèƒ½ï¼Œåªæ˜¯å®ƒå¸Œæœ›å®¢æˆ·ç«¯åœ¨è¯·æ±‚ä¸€ä¸ªURIçš„æ—¶å€™ï¼Œèƒ½é€šè¿‡GETæ–¹æ³•é‡å®šå‘åˆ°å¦ä¸€ä¸ªURIä¸Š 304ï¼š åå•†ç¼“å­˜å‘½ä¸­ï¼Œè¿”å›ç©ºbodyã€‚å‘é€é™„å¸¦æ¡ä»¶çš„è¯·æ±‚æ—¶ï¼Œæ¡ä»¶ä¸æ»¡è¶³æ—¶è¿”å›ï¼Œä¸é‡å®šå‘æ— å…³ 307ï¼š ä¸´æ—¶é‡å®šå‘ï¼Œä¸302ç±»ä¼¼ï¼Œåªæ˜¯å¼ºåˆ¶è¦æ±‚ä½¿ç”¨POSTæ–¹æ³• 400ï¼š è¯·æ±‚æŠ¥æ–‡è¯­æ³•æœ‰è¯¯ï¼ŒæœåŠ¡å™¨æ— æ³•è¯†åˆ« 401ï¼š è¯·æ±‚éœ€è¦è®¤è¯ 403ï¼š è¯·æ±‚çš„å¯¹åº”èµ„æºç¦æ­¢è¢«è®¿é—® 404ï¼š æœåŠ¡å™¨æ— æ³•æ‰¾åˆ°å¯¹åº”èµ„æº 500ï¼š æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ 503ï¼š æœåŠ¡å™¨æ­£å¿™ 2 è¯·æ±‚å’Œå“åº”æ ¼å¼è¯·æ±‚æ ¼å¼ï¼š12345678910111213Mothed Path HttpVersion ï¼ˆMPVï¼‰HeaderBody(if have)//ç¤ºä¾‹ï¼šGET /d?ttl=1&amp;dn=82f3b6f4e75e6679742bdc4e8990e7e2e0e927e6bb3e8030&amp;id=316 HTTP/1.1Host: 119.29.29.29Connection: Keep-AliveAccept-Encoding: gzipUser-Agent: android/okhttp17d10738b8085b2c9030ce1e4c7aace2998b95e308abbdcbbf425336f3d2e006(if Post) å“åº”æ ¼å¼ï¼š12345678910111213HttpVersion StatusCode StatusMessage (VSS)HeaderBody//ç¤ºä¾‹ï¼šHTTP/1.1 200 OKConnection: closeServer: Http ServerContent-Type: text/htmlContent-Length: 6417d10738b8085b2c9030ce1e4c7aace2998b95e308abbdcbbf425336f3d2e006 3 Httpè¯·æ±‚æ–¹å¼HTTPåè®®å®šä¹‰äº†å¤šç§è¯·æ±‚æ–¹å¼ï¼Œå…·ä½“å¦‚ä¸‹ï¼šGETï¼šè·å–èµ„æºï¼Œç”¨æ¥è¯·æ±‚è®¿é—®å·²è¢«URIï¼ˆç»Ÿä¸€èµ„æºæ ‡å¿—ç¬¦ï¼Œå’ŒURLæ˜¯åŒ…å«å’Œè¢«åŒ…å«çš„å…³ç³»ï¼‰è¯†åˆ«çš„èµ„æºã€‚POSTï¼šç”¨æ¥ä¼ è¾“å®ä½“çš„ä¸»ä½“ï¼Œè™½ç„¶GETä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸ç”¨ã€‚PUTï¼šä¼ è¾“æ–‡ä»¶ã€‚ä½†æ˜¯é‰´äºPUTæ–¹æ³•è‡ªèº«ä¸å¸¦éªŒè¯æœºåˆ¶ï¼Œä»»ä½•äººéƒ½å¯ä»¥ä¸Šä¼ æ–‡ä»¶ï¼Œå­˜åœ¨å®‰å…¨æ€§é—®é¢˜ï¼Œå› æ­¤ä¸€èˆ¬ç½‘ç«™éƒ½ä¸é‡‡ç”¨è¯¥æ–¹æ³•ã€‚HEAD:è·å¾—æŠ¥æ–‡é¦–éƒ¨ã€‚å’ŒGETè¯·æ±‚ä¸€æ ·ï¼Œåªæ˜¯ä¸è¿”å›æŠ¥æ–‡ä¸»ä½“éƒ¨åˆ†ã€‚DELETEï¼šåˆ é™¤æ–‡ä»¶ã€‚åŒæ ·ä¸å¸¦éªŒè¯æœºåˆ¶ï¼Œå­˜åœ¨å®‰å…¨æ€§é—®é¢˜ã€‚OPTIONS:è¯¢é—®æŒ‡å®šçš„è¯·æ±‚URIæ”¯æŒå“ªäº›æ–¹æ³•ã€‚CONNECTï¼šè¦æ±‚åœ¨ä¸ä»£ç†æœåŠ¡å™¨é€šä¿¡æ—¶å»ºç«‹éš§é“ï¼Œå®ç°éš§é“åè®®è¿›è¡ŒTCPé€šä¿¡ã€‚ HTTP å¹‚ç­‰æ–¹æ³•æ˜¯æŒ‡æ— è®ºè°ƒç”¨å¤šå°‘æ¬¡éƒ½ä¸ä¼šæœ‰ä¸åŒç»“æœçš„ HTTP æ–¹æ³•ã€‚å®ƒæ— è®ºæ˜¯è°ƒç”¨ä¸€æ¬¡ï¼Œè¿˜æ˜¯åæ¬¡éƒ½æ— å…³ç´§è¦ã€‚ç»“æœä»åº”ç›¸åŒã€‚ psï¼šåªæœ‰POSTæ˜¯éå¹‚ç­‰çš„ï¼Œå…¶ä»–éƒ½æ˜¯å¹‚ç­‰çš„ã€‚ è¿™é‡Œè¿˜æƒ³è¡¥å……è¯´æ˜ä¸€ç‚¹ï¼Œå°±æ˜¯é€šè¿‡æµè§ˆå™¨åœ°å€æ è¾“å…¥URLè®¿é—®èµ„æºçš„æ–¹å¼éƒ½æ˜¯GETè¯·æ±‚ã€‚ 3 POSTå’ŒGETè¯·æ±‚åŒºåˆ«å˜æ¸…3.1 è¯·æ±‚å‚æ•°é•¿åº¦é™åˆ¶ï¼šGETè¯·æ±‚é•¿åº¦æœ€å¤š1024kbï¼ŒPOSTå¯¹è¯·æ±‚æ•°æ®æ²¡æœ‰é™åˆ¶ï¼Ÿå…³äºæ­¤ç‚¹ï¼Œåœ¨HTTPåè®®ä¸­æ²¡æœ‰å¯¹URLé•¿åº¦è¿›è¡Œé™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶æ˜¯ä¸åŒçš„æµè§ˆå™¨åŠæœåŠ¡å™¨ç”±äºæœ‰ä¸åŒçš„è§„èŒƒè€Œå¸¦æ¥çš„é™åˆ¶ã€‚ 3.2 GETè¯·æ±‚ä¸€å®šä¸èƒ½ç”¨request bodyä¼ è¾“æ•°æ®ï¼ŸGETå¯ä»¥å¸¦request bodyï¼Œä½†ä¸èƒ½ä¿è¯ä¸€å®šèƒ½è¢«æ¥æ”¶åˆ°ã€‚å¦‚æœä½ ç”¨GETæœåŠ¡ï¼Œåœ¨request bodyå·å·è—äº†æ•°æ®ï¼Œä¸åŒæœåŠ¡å™¨çš„å¤„ç†æ–¹å¼ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œæœ‰äº›æœåŠ¡å™¨ä¼šå¸®ä½ è¯»å‡ºæ•°æ®ï¼Œæœ‰äº›æœåŠ¡å™¨ç›´æ¥å¿½ç•¥ã€‚ 3.3 POSTæ¯”GETå®‰å…¨æ€§è¦é«˜ï¼è¿™é‡Œçš„å®‰å…¨æ˜¯ç›¸å¯¹æ€§ï¼Œé€šè¿‡GETæäº¤çš„æ•°æ®éƒ½å°†æ˜¾ç¤ºåˆ°URLä¸Šï¼Œé¡µé¢ä¼šè¢«æµè§ˆå™¨ç¼“å­˜ï¼Œå…¶ä»–äººæŸ¥çœ‹å†å²è®°å½•ä¼šçœ‹åˆ°æäº¤çš„æ•°æ®ï¼Œè€ŒPOSTä¸ä¼šã€‚å¦å¤–GETæäº¤æ•°æ®è¿˜å¯èƒ½ä¼šé€ æˆCSRFæ”»å‡»ã€‚ ï¼ˆæœ‰è¯¯ï¼‰3.4 GETäº§ç”Ÿä¸€ä¸ªTCPæ•°æ®åŒ…ï¼ŒPOSTäº§ç”Ÿä¸¤ä¸ªTCPæ•°æ®åŒ…ï¼å¯¹äºGETæ–¹å¼çš„è¯·æ±‚ï¼Œæµè§ˆå™¨ä¼šæŠŠhttp headerå’Œdataä¸€å¹¶å‘é€å‡ºå»ï¼ŒæœåŠ¡å™¨å“åº”200 OK(è¿”å›æ•°æ®);è€Œå¯¹äºPOSTï¼Œæµè§ˆå™¨å…ˆå‘é€headerï¼ŒæœåŠ¡å™¨å“åº”100 continueï¼Œæµè§ˆå™¨å†å‘é€dataï¼ŒæœåŠ¡å™¨å“åº”200 OK(è¿”å›æ•°æ®)ã€‚æ³¨æ„ï¼Œå°½ç®¡POSTè¯·æ±‚ä¼šåˆ†ä¸¤æ¬¡ï¼Œä½†body æ˜¯ç´§éšåœ¨ header åé¢å‘é€çš„ï¼Œæ ¹æœ¬ä¸å­˜åœ¨ã€ç­‰å¾…æœåŠ¡å™¨å“åº”ã€ä¸€è¯´ã€‚ 4 POSTå’ŒGETè¯·æ±‚çš„åŒºåˆ«å°ç»“è¯·æ±‚å‚æ•°ï¼šGETè¯·æ±‚å‚æ•°æ˜¯é€šè¿‡URLä¼ é€’çš„ï¼Œå¤šä¸ªå‚æ•°ä»¥&amp;è¿æ¥ï¼ŒPOSTè¯·æ±‚æ”¾åœ¨request bodyä¸­ã€‚è¯·æ±‚ç¼“å­˜ï¼šGETè¯·æ±‚ä¼šè¢«ç¼“å­˜ï¼Œè€ŒPOSTè¯·æ±‚ä¸ä¼šï¼Œé™¤éæ‰‹åŠ¨è®¾ç½®ã€‚æ”¶è—ä¸ºä¹¦ç­¾ï¼šGETè¯·æ±‚æ”¯æŒï¼ŒPOSTè¯·æ±‚ä¸æ”¯æŒã€‚å®‰å…¨æ€§ï¼šPOSTæ¯”GETå®‰å…¨ï¼ŒGETè¯·æ±‚åœ¨æµè§ˆå™¨å›é€€æ—¶æ˜¯æ— å®³çš„ï¼Œè€ŒPOSTä¼šå†æ¬¡è¯·æ±‚ã€‚å†å²è®°å½•ï¼šGETè¯·æ±‚å‚æ•°ä¼šè¢«å®Œæ•´ä¿ç•™åœ¨æµè§ˆå†å²è®°å½•é‡Œï¼Œè€ŒPOSTä¸­çš„å‚æ•°ä¸ä¼šè¢«ä¿ç•™ã€‚ç¼–ç æ–¹å¼ï¼šGETè¯·æ±‚åªèƒ½è¿›è¡Œurlç¼–ç ï¼Œè€ŒPOSTæ”¯æŒå¤šç§ç¼–ç æ–¹å¼ã€‚å¯¹å‚æ•°çš„æ•°æ®ç±»å‹ï¼šGETåªæ¥å—ASCIIå­—ç¬¦ï¼Œè€ŒPOSTæ²¡æœ‰é™åˆ¶ã€‚ Http Versionç®€è¿°ï¼šæœ€ä¸ºäººè¯Ÿç—…çš„å°±æ˜¯å½“å®¢æˆ·ç«¯åŒæ—¶å‘å‡ºå¤šä¸ªè¯·æ±‚æ—¶éœ€è¦æ’é˜Ÿè¿›è¡Œä¼šäº§ç”Ÿé˜Ÿå¤´é˜»å¡ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä½•ä¸€äº›åœ¨1.xç«™ç‚¹ä¼šæœ‰å¤šä¸ª[é™æ€èµ„æº]CDN åŸŸåçš„åŸå› ä¹‹ä¸€ï¼Œç›®çš„å°±æ˜¯å˜ç›¸çš„è§£å†³æµè§ˆå™¨é’ˆå¯¹åŒä¸€[åŸŸå]çš„è¯·æ±‚é™åˆ¶é˜»å¡é—®é¢˜ HTTP1.0ï¼ˆå‡ ä¹æ²¡æœ‰ä½¿ç”¨ï¼‰æ— é“¾æ¥ï¼Œå³æ¯æ¬¡è¯·æ±‚éƒ½è¦å»ºç«‹æ–°çš„tcpé“¾æ¥ï¼›ç¼“å­˜åªæœ‰Expires http1.0è¢«æŠ±æ€¨æœ€å¤šçš„å°±æ˜¯ è¿æ¥æ— æ³•å¤ç”¨ å’Œ head of line blocking è¿™ä¸¤ä¸ªé—®é¢˜ã€‚ ç†è§£è¿™ä¸¤ä¸ªé—®é¢˜çš„å‰æï¼š 1ã€æ¯ä¸ªè¿æ¥ï¼ˆä¹Ÿå°±æ˜¯Tcpè¿æ¥ï¼‰å»ºç«‹è¦ç»è¿‡ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ–­å¼€éœ€è¦å››æ¬¡æŒ¥æ‰‹ï¼Œååˆ†è€—æ—¶ 2ã€å®¢æˆ·ç«¯æ˜¯ä¾æ®åŸŸåæ¥å‘æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œä¸€èˆ¬PCç«¯æµè§ˆå™¨ä¼šé’ˆå¯¹å•ä¸ªåŸŸåçš„serveråŒæ—¶å»ºç«‹6ï½8ä¸ªè¿æ¥ï¼Œæ‰‹æœºç«¯çš„è¿æ¥æ•°åˆ™ä¸€èˆ¬æ§åˆ¶åœ¨4ï½6ä¸ªã€‚æ˜¾ç„¶è¿æ¥æ•°å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œèµ„æºå¼€é”€å’Œæ•´ä½“å»¶è¿Ÿéƒ½ä¼šéšä¹‹å¢å¤§ã€‚ æ— è¿æ¥ï¼Œæµè§ˆå™¨çš„æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦ä¸æœåŠ¡å™¨ç»è¿‡ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹ä¸€ä¸ªTCPè¿æ¥ï¼ŒæœåŠ¡å™¨å¤„ç†å®Œæˆåç«‹å³å››æ¬¡æŒ¥æ‰‹æ–­å¼€TCPè¿æ¥ï¼ˆæ— è¿æ¥ï¼‰ã€‚ ç¼“å­˜åªæœ‰Expires HTTP1.1é»˜è®¤keep-aliveé•¿è¿æ¥ï¼Œå³è¯·æ±‚å¯ä»¥å¤ç”¨åŒä¸€ä¸ªtcpé“¾æ¥ï¼›åå•†ç¼“å­˜ï¼›å“åº”åˆ†å—ï¼›å¦å¤–è¿˜æœ‰å‡ ä¹æ²¡å’‹ç”¨çš„ç®¡çº¿åŒ– é•¿è¿æ¥å¤ç”¨ï¼Œå³ Connection: Keep-Alive å­—æ®µé»˜è®¤å¼€å¯ï¼Œè¿™ä¸ªå­—æ®µå…è®¸æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¿æŒä¸€ä¸ªé•¿æ—¶é—´å­˜æ´»çš„TCPè¿æ¥ï¼Œå½“åç»­å®¢æˆ·ç«¯å‘é€å¦ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå®ƒä¼šå¤ç”¨åŒä¸€ä¸ªTCPè¿æ¥ã€‚è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå¦‚æœåŒæ—¶å‘èµ·äº†å¤šä¸ªè¯·æ±‚ï¼Œè¿˜æ˜¯éœ€è¦å»ºç«‹å¤šä¸ªTcpè¿æ¥çš„ã€‚ ç®¡çº¿åŒ–(å®é™…ä¸Šä¸å¯åŠ¨)ï¼Œå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶å‘å‡ºå¤šä¸ªHTTPè¯·æ±‚ï¼Œè€Œä¸ç”¨ä¸€ä¸ªä¸ªç­‰å¾…å“åº”. æ”¯æŒå“åº”åˆ†å—ï¼Œ Transfer-Encoding(chunked) ä¸ Content-Encoding(gzip) åå•†ç¼“å­˜ï¼šåºŸå¼ƒExpiresï¼Œå¯ç”¨Cache-Controlã€‚æ–°å¢åå•†ç¼“å­˜ã€‚ è§£å†³äº†Http1.0ä¸­è¿æ¥æ— æ³•å¤ç”¨çš„é—®é¢˜ï¼Œé»˜è®¤é•¿è¿æ¥ï¼› ä½†ä¾ç„¶è§£å†³ä¸äº† head of line blocking é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œhttp1.1è¯•å›¾ç”¨ç®¡çº¿åŒ–æœºåˆ¶åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚ æ¥è§£å†³head of line blockingï¼Œä½†å³ä½¿pipelining å¯ä»¥åŒæ—¶åœ¨ä¸€ä¸ª TCP ä¸­å‘é€å¤šä¸ª HTTP è¯·æ±‚ï¼Œå®¢æˆ·ç«¯æ¥æ”¶æœåŠ¡ç«¯å“åº”ä¿¡æ¯æ—¶ï¼Œè¿˜æ˜¯æŒ‰ç…§å‘é€æ—¶çš„é¡ºåºæ¥æ¥æ”¶å“åº”ä¿¡æ¯ï¼Œä¾ç„¶ä¼šæœ‰é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ é•¿è¿æ¥å¤ç”¨â€‹ åœ¨ HTTP 1.1 ä¸­ï¼Œ Connection: Keep-Alive å­—æ®µé»˜è®¤å¼€å¯ï¼Œè¿™ä¸ªå­—æ®µå…è®¸æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¿æŒä¸€ä¸ªé•¿è¿æ¥ï¼Œå½“å®¢æˆ·ç«¯å‘é€å¦ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå®ƒä¼šå¤ç”¨åŒä¸€ä¸ªè¿æ¥ã€‚è¿™ä¸ªè¿æ¥ä¼šä¸€ç›´æŒç»­åˆ°å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨ç«¯è®¤ä¸ºä¼šè¯å·²ç»ç»“æŸï¼Œå…¶ä¸­ä¸€æ–¹ä¸­æ–­è¿æ¥ã€‚ä¸­æ–­è¿æ¥çš„å–å†³ä¸å¦å–å†³äº Keep-Alive å­—æ®µä¸­çš„ï¼š timeout: å†³å®šå½“å‰ tcpçš„æœ€é•¿ä¿æŒè¿æ¥æ—¶é—´ï¼Œå•ä½ä¸º s ï¼Œè¶…è¿‡è®¾ç½®çš„æ—¶é—´åæ–­å¼€è¿æ¥ maxï¼šå†³å®šäº†å½“å‰è¿æ¥æœ€å¤šçš„å¯å¤ç”¨æ¬¡æ•° â€‹ å®¹æ˜“æ··æ·†çš„æ¦‚å¿µâ€”â€”TCPçš„keep aliveå’ŒHTTPçš„Keep-aliveï¼š TCPçš„keep aliveæ˜¯æ£€æŸ¥å½“å‰TCPè¿æ¥æ˜¯å¦æ´»ç€; HTTPçš„Keep-aliveæ˜¯è¦è®©ä¸€ä¸ªTCPè¿æ¥æ´»ä¹…ç‚¹ã€‚å®ƒä»¬æ˜¯ä¸åŒå±‚æ¬¡çš„æ¦‚å¿µã€‚ TCP keep aliveçš„è¡¨ç°ï¼š å½“ä¸€ä¸ªè¿æ¥â€œä¸€æ®µæ—¶é—´â€æ²¡æœ‰æ•°æ®é€šè®¯æ—¶ï¼Œä¸€æ–¹ä¼šå‘å‡ºä¸€ä¸ªå¿ƒè·³åŒ…(Keep AliveåŒ…)ï¼Œå¦‚æœå¯¹æ–¹æœ‰å›åŒ…åˆ™è¡¨æ˜å½“å‰è¿æ¥æœ‰æ•ˆï¼Œç»§ç»­ç›‘æ§ã€‚ å“åº”åˆ†å—Transfer-Encoding(chunked) ä¸ Content-Encoding(gzip) æ³¨ï¼š HTTP2 ä¸å†æ”¯æŒä½¿ç”¨ chunked åˆ†å—æœºåˆ¶ä¼ è¾“æ•°æ®ï¼Œæœ‰äº†æ›´å¥½çš„æµä¼ è¾“æœºåˆ¶ æ”¯æŒ Chunked Responses ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨Responseçš„æ—¶å€™ï¼Œä¸å¿…è¯´æ˜ Content-Length è¿™æ ·ï¼Œå®¢æˆ·ç«¯å°±ä¸èƒ½æ–­è¿æ¥ï¼Œç›´åˆ°æ”¶åˆ°æœåŠ¡ç«¯çš„EOFæ ‡è¯†ã€‚è¿™ç§æŠ€æœ¯åˆå« â€œæœåŠ¡ç«¯Pushæ¨¡å‹â€ï¼Œæˆ–æ˜¯ â€œæœåŠ¡ç«¯Pushå¼çš„HTTP æŒä¹…é“¾æ¥â€ ç®¡çº¿åŒ–ï¼ˆhttp pipeliningï¼‰ æ³¨ï¼š é»˜è®¤ä¸å¯ç”¨ï¼ŒHTTP2 ä¸­æµæ°´çº¿å·²ç»è¢«æ›´å¥½çš„ç®—æ³•ç»™ä»£æ›¿ï¼Œå¦‚ multiplexing â€‹ HTTPç®¡çº¿åŒ–ï¼ˆè‹±è¯­ï¼šHTTP pipeliningï¼‰æ˜¯å°†å¤šä¸ª HTTP è¯·æ±‚ï¼ˆrequestï¼‰æ•´æ‰¹æäº¤çš„æŠ€æœ¯ï¼Œè€Œåœ¨å‘é€è¿‡ç¨‹ä¸­ä¸éœ€å…ˆç­‰å¾…æœåŠ¡å™¨çš„å›åº”ã€‚ â€‹ æµæ°´çº¿æ“ä½œå»ºç«‹åœ¨é•¿è¿æ¥ä¹‹ä¸Šï¼Œå¯ä»¥å°†æ‰€æœ‰çš„ HTTP è¯·æ±‚ä¸€æ¬¡æ€§å‘å‡ºï¼Œè€Œæ— éœ€å…³å¿ƒä¸Šä¸€æ¬¡å‘é€è¯·æ±‚çš„çŠ¶æ€ï¼Œè™½ç„¶è¯´å®¢æˆ·ç«¯ä¸€æ¬¡æ€§èƒ½å¤Ÿå‘å‡ºæ‰€æœ‰çš„è¯·æ±‚ï¼Œä½†æ˜¯åœ¨æœåŠ¡ç«¯æ¥æ”¶åˆ°çš„è¯·æ±‚è¿˜æ˜¯ä¸€ä¸€è¿›è¡Œå¤„ç†çš„ï¼Œå¦‚æœå½“æœåŠ¡ç«¯è¿”å›çš„å…¶ä¸­ä¸€ä¸ªå“åº”é˜»å¡åï¼Œæ¥ä¸‹æ¥çš„å“åº”ä¹Ÿä¼šè¢«é˜»å¡ã€‚ HTTP 1.1 åˆ©ç”¨ pipelining å¯ä»¥åŒæ—¶åœ¨ä¸€ä¸ª TCP ä¸­å‘é€å¤šä¸ª HTTP è¯·æ±‚ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ¥æ”¶æœåŠ¡ç«¯å“åº”ä¿¡æ¯æ—¶ï¼Œè¿˜æ˜¯æŒ‰ç…§å‘é€æ—¶çš„é¡ºåºæ¥æ¥æ”¶å“åº”ä¿¡æ¯ã€‚ HTTP2.0ç®€è¿°ï¼šHttp2æ ¸å¿ƒä¼˜åŒ–æ˜¯é€šè¿‡å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œè§£å†³äº†Httpè¯·æ±‚é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œå°†ä¸¤ç«¯æ‰€æœ‰çš„è¯·æ±‚éƒ½æ”¾åˆ°äº†åŒä¸€ä¸ªTcpè¿æ¥ä¸­ï¼ˆä½†Tcpä¼ è¾“çš„å±€é™æ€§å¯¼è‡´äº†Tcpé˜Ÿå¤´é˜»å¡ä¸”æ— æ³•è§£å†³ï¼‰ï¼›èˆå¼ƒäº†ä½æ•ˆçš„plain textæ ¼å¼ä½¿ç”¨äºŒè¿›åˆ¶æ ¼å¼è¿›è¡Œè§£æä¼ è¾“ï¼›ä½¿ç”¨HPACKç®—æ³•å¯¹å¤šä¸ªè¯·æ±‚çš„é¦–éƒ¨è¿›è¡Œå·®é‡æ›´æ–°ï¼›é€šè¿‡æœåŠ¡å™¨æå‰å°†å®¢æˆ·ç«¯å¯èƒ½è¦çš„èµ„æºå“åº”å›å»ï¼ˆæœåŠ¡å™¨ï¼šè™½ç„¶ä½ åªè¯·æ±‚äº†Htmlé¡µé¢ï¼Œä½†æ˜¯æˆ‘è§‰å¾—ä½ è¿˜éœ€è¦è¿™é‡Œé¢æ‰€æœ‰çš„èµ„æºå¦‚jsã€cssç­‰ï¼‰ äºŒè¿›åˆ¶åˆ†å¸§ï¼ˆé‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼çš„ç¼–ç å°†å…¶å°è£…ï¼‰ é¦–éƒ¨å‹ç¼©ï¼ˆè®¾ç½®äº†ä¸“é—¨çš„é¦–éƒ¨å‹ç¼©è®¾è®¡çš„HPACKç®—æ³•ã€‚ï¼‰ å¤šè·¯å¤ç”¨ï¼ˆå¯ä»¥åœ¨å…±äº«TCPé“¾æ¥çš„åŸºç¡€ä¸ŠåŒæ—¶å‘é€è¯·æ±‚å’Œå“åº”ï¼‰ æœåŠ¡å™¨æ¨é€ï¼ˆserver push;å‡ ä¹æ²¡å’‹ç”¨ã€‚å°±æ˜¯æœåŠ¡å™¨å¯ä»¥å¯¹ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚å‘é€å¤šä¸ªå“åº”ã€‚æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€èµ„ æºæ— éœ€å®¢æˆ·ç«¯æ˜ç¡®çš„è¯·æ±‚ã€‚ï¼‰ äºŒè¿›åˆ¶åˆ†å¸§æ–°çš„äºŒè¿›åˆ¶æ ¼å¼ï¼ˆBinary Formatï¼‰ï¼ŒäºŒè¿›åˆ¶åè®®ï¼Œå¢åŠ äº†æ•°æ®ä¼ è¾“çš„æ•ˆç‡ã€‚ HTTP1.xçš„è§£ææ˜¯åŸºäºæ–‡æœ¬ï¼ˆplain textï¼‰ï¼Œä½æ•ˆä¸”å¥å£®æ€§å·®ã€‚http2.0çš„æ ¼å¼å®šä¹‰æ›´æ¥è¿‘tcpå±‚çš„æ–¹å¼ï¼Œååˆ†é«˜æ•ˆä¸”ç²¾ç®€ã€‚è€Œä¸”å®é™…ä¸Šhttp2.0å¹¶æ²¡æœ‰æ”¹å˜http1.xçš„è¯­ä¹‰ï¼Œåªæ˜¯æŠŠåŸæ¥http1.xçš„headerå’Œbodyéƒ¨åˆ†ç”¨frameé‡æ–°å°è£…äº†ä¸€å±‚è€Œå·²ã€‚è°ƒè¯•çš„æ—¶å€™æµè§ˆå™¨ç”šè‡³ä¼šæŠŠhttp2.0çš„frameè‡ªåŠ¨è¿˜åŸæˆhttp1.xçš„æ ¼å¼ã€‚ å¤šè·¯å¤ç”¨å¤šè·¯å¤ç”¨ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªTCPé“¾æ¥ä¸­å¹¶å‘è¯·æ±‚å¤šä¸ªHTTPè¯·æ±‚ã€‚ ä¸€ä¸ªå®¢æˆ·ç«¯å’Œä¸€ä¸ªæœåŠ¡å™¨çš„å¤šä¸ªï¼ˆå³ä½¿æ˜¯åŒæ—¶å‘å‡ºï¼‰çš„è¯·æ±‚éƒ½æ˜¯åœ¨åŒä¸€ä¸ªTcpè¿æ¥ä¸­è¿›è¡Œçš„ã€‚ å‡å°‘äº†éœ€è¦è¿›è¡Œå¤šä¸ªè¿æ¥çš„è€—æ—¶ï¼Œå†å¤šçš„è¯·æ±‚ä¹Ÿåªéœ€è¦ä¸€ä¸ªTcpè¿æ¥çš„ä¸‰æ¬¡æ¡æ‰‹è€—æ—¶ è§£å†³äº†ä¸€ä¸ªHoståªæ”¯æŒ6ä¸ªå·¦å³è¿æ¥çš„é™åˆ¶ï¼Œåªç”¨ä¸€ä¸ªè¿æ¥è¿›è¡Œæ‰€æœ‰è¯·æ±‚ è§£å†³äº†head of line blockingï¼ˆä¸¢åŒ…å¤±åºæ—¶è¿˜æ˜¯ä¼šé˜»å¡ï¼‰ï¼Œå¤šä¸ªè¯·æ±‚å¯ä»¥åŒæ—¶å‘å‡ºï¼ˆä½†ç”±äºåŸºäºTcpï¼ŒTcpä¸ºäº†ä¿è¯æ•°æ®çš„æœ‰åºä¼ è¾“ï¼Œå¦‚æœTcpä¼ è¾“ä¸­æŸä¸ªæ•°æ®åŒ…ä¸¢å¤±æˆ–è€…å¤±åºäº†ï¼Œé‚£ä¹ˆæ¥æ”¶ç«¯ä¼šç­‰å¾…è¯¥æ•°æ®åŒ…å¯¼è‡´åé¢æ•°æ®åŒ…çš„æ•´ä¸ªé˜»å¡ï¼‰ é¦–éƒ¨å‹ç¼©ï¼ˆHPACK-Huffmanç®—æ³•æ— æŸå‹ç¼©ï¼‰headerå‹ç¼©ï¼Œå‹ç¼©å¤´ï¼Œå¦‚æœä½ åŒæ—¶å‘å‡ºå¤šä¸ªè¯·æ±‚ï¼Œä»–ä»¬çš„å¤´æ˜¯ä¸€æ ·çš„æˆ–æ˜¯ç›¸ä¼¼çš„ï¼Œé‚£ä¹ˆï¼Œåè®®ä¼šå¸®ä½ æ¶ˆé™¤é‡å¤çš„éƒ¨åˆ†ã€‚è¿™å°±æ˜¯æ‰€è°“çš„HPACKç®—æ³• HTTP1.xçš„headerå¸¦æœ‰å¤§é‡ä¿¡æ¯ï¼ˆåŒ…å«cookieå¯è¾¾åˆ°kbç­‰çº§å ç”¨ï¼‰ï¼Œè€Œä¸”æ¯æ¬¡éƒ½è¦é‡å¤å‘é€ï¼ŒHTTP2.0ä½¿ç”¨HPACKç®—æ³•encoderæ¥å‡å°‘éœ€è¦ä¼ è¾“çš„headerå¤§å°ï¼Œé€šè®¯åŒæ–¹å„è‡ªcacheä¸€ä»½header å­—å…¸è¿›è¡Œå·®é‡æ›´æ–°ï¼Œæ—¢é¿å…äº†é‡å¤headerçš„ä¼ è¾“ï¼Œåˆå‡å°äº†éœ€è¦ä¼ è¾“çš„å¤§å°ã€‚ æœåŠ¡ç«¯æ¨é€æœåŠ¡ç«¯æ¨é€æ˜¯ä¸€ç§åœ¨å®¢æˆ·ç«¯è¯·æ±‚ä¹‹å‰å‘é€æ•°æ®çš„æœºåˆ¶ã€‚åœ¨ HTTP/2 ä¸­ï¼ŒæœåŠ¡å™¨å¯ä»¥å¯¹å®¢æˆ·ç«¯çš„ä¸€ä¸ªè¯·æ±‚å‘é€å¤šä¸ªå“åº”ã€‚Server Push è®©HTTP1.x æ—¶ä»£ä½¿ç”¨å†…åµŒèµ„æºçš„ä¼˜åŒ–æ‰‹æ®µå˜å¾—æ²¡æœ‰æ„ä¹‰ï¼›å¦‚æœä¸€ä¸ªè¯·æ±‚æ˜¯ç”±ä½ çš„ä¸»é¡µå‘èµ·çš„ï¼ŒæœåŠ¡å™¨å¾ˆå¯èƒ½ä¼šå“åº”ä¸»é¡µå†…å®¹ã€logo ä»¥åŠæ ·å¼è¡¨ï¼Œå› ä¸ºå®ƒçŸ¥é“å®¢æˆ·ç«¯ä¼šç”¨åˆ°è¿™äº›ä¸œè¥¿ã€‚è¿™ç›¸å½“äºåœ¨ä¸€ä¸ª HTML æ–‡æ¡£å†…é›†åˆäº†æ‰€æœ‰çš„èµ„æºï¼Œä¸è¿‡ä¸ä¹‹ç›¸æ¯”ï¼ŒæœåŠ¡å™¨æ¨é€è¿˜æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿ï¼šå¯ä»¥ç¼“å­˜ï¼ä¹Ÿè®©åœ¨éµå¾ªåŒæºçš„æƒ…å†µä¸‹ï¼Œä¸åŒé¡µé¢ä¹‹é—´å¯ä»¥å…±äº«ç¼“å­˜èµ„æºæˆä¸ºå¯èƒ½ã€‚ Psï¼šå¦‚æœä¸éœ€è¦çš„è¯ï¼Œå®¢æˆ·ç«¯èƒ½è‡ªä¸»é€‰æ‹©æ˜¯å¦éœ€è¦ä¸­æ–­è¯¥æ¨é€çš„æµï¼Œé€šè¿‡å‘é€ä¸€ä¸ªRST_STREAMå¸§æ¥ä¸­æ­¢ã€‚ é—®é¢˜é˜Ÿå¤´é˜»å¡é˜Ÿå¤´é˜»å¡ç¿»è¯‘è‡ªè‹±æ–‡head-of-line blockingï¼Œè¿™ä¸ªè¯å¹¶ä¸æ–°é²œï¼Œå› ä¸ºæ—©åœ¨HTTP/1.1æ—¶ä»£ï¼Œå°±ä¸€ç›´å­˜åœ¨ç€é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ã€‚ ä½†æ˜¯å¾ˆå¤šäººåœ¨ä¸€äº›èµ„æ–™ä¸­ä¼šçœ‹åˆ°æœ‰è®ºç‚¹è¯´HTTP/2è§£å†³äº†é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ã€‚ä½†æ˜¯è¿™å¥è¯åªå¯¹äº†ä¸€åŠã€‚ **åªèƒ½è¯´HTTP/2è§£å†³äº†HTTPçš„é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è§£å†³TCPé˜Ÿå¤´é˜»å¡é—®é¢˜!**ä¹Ÿå°±æ˜¯è¯·æ±‚çš„é˜Ÿå¤´é˜»å¡é—®é¢˜è§£å†³äº†ï¼Œtcpä¼ è¾“ä¸¢åŒ…çš„é˜Ÿå¤´é˜»å¡é—®é¢˜æ²¡æœ‰è§£å†³ã€‚ï¼ˆpsï¼šè§£å†³åŠæ³•å°±æ˜¯ä¸ç”¨Tcpï¼Œä¹Ÿå°±æ˜¯H3/QUICä¸­çš„UDPï¼‰ HTTPé˜Ÿå¤´é˜»å¡çš„é—®é¢˜åœ¨HTTP/2ä¸­å¾—åˆ°äº†æœ‰æ•ˆçš„è§£å†³ã€‚HTTP/2åˆ›æ–°æ€§çš„å¼•å…¥äº†å¸§ã€æ¶ˆæ¯å’Œæ•°æ®æµç­‰æ¦‚å¿µã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥æŠŠ HTTP æ¶ˆæ¯åˆ†è§£ä¸ºäº’ä¸ä¾èµ–çš„å¸§ï¼Œç„¶åä¹±åºå‘é€ï¼Œæœ€åå†åœ¨å¦ä¸€ç«¯æŠŠå®ƒä»¬é‡æ–°ç»„åˆèµ·æ¥ã€‚ å› ä¸ºæ²¡æœ‰é¡ºåºäº†ï¼Œæ‰€ä»¥å°±ä¸éœ€è¦é˜»å¡äº†ï¼Œå°±æœ‰æ•ˆçš„è§£å†³äº†HTTPé˜Ÿå¤´é˜»å¡çš„é—®é¢˜ã€‚ ä½†æ˜¯ï¼ŒHTTP/2ä»ç„¶ä¼šå­˜åœ¨TCPé˜Ÿå¤´é˜»å¡çš„é—®é¢˜ï¼Œé‚£æ˜¯å› ä¸ºHTTP/2å…¶å®è¿˜æ˜¯ä¾èµ–TCPåè®®å®ç°çš„ã€‚ TCPä¼ è¾“è¿‡ç¨‹ä¸­ä¼šæŠŠæ•°æ®æ‹†åˆ†ä¸ºä¸€ä¸ªä¸ªæŒ‰ç…§é¡ºåºæ’åˆ—çš„æ•°æ®åŒ…ï¼Œè¿™äº›æ•°æ®åŒ…é€šè¿‡ç½‘ç»œä¼ è¾“åˆ°äº†æ¥æ”¶ç«¯ï¼Œæ¥æ”¶ç«¯å†æŒ‰ç…§é¡ºåºå°†è¿™äº›æ•°æ®åŒ…ç»„åˆæˆåŸå§‹æ•°æ®ï¼Œè¿™æ ·å°±å®Œæˆäº†æ•°æ®ä¼ è¾“ã€‚ ä½†æ˜¯å¦‚æœå…¶ä¸­çš„æŸä¸€ä¸ªæ•°æ®åŒ…æ²¡æœ‰æŒ‰ç…§é¡ºåºåˆ°è¾¾ï¼Œæ¥æ”¶ç«¯ä¼šä¸€ç›´ä¿æŒè¿æ¥ç­‰å¾…æ•°æ®åŒ…è¿”å›ï¼Œè¿™æ—¶å€™å°±ä¼šé˜»å¡åç»­è¯·æ±‚ã€‚è¿™å°±å‘ç”Ÿäº†TCPé˜Ÿå¤´é˜»å¡ã€‚ ç”±äºHTTP/2ä¸­åŒä¸€ä¸ªåŸŸååªæ˜¯ç”¨ä¸€ä¸ªTCPè¿æ¥ï¼Œæ‰€æœ‰çš„æ•°æ®åŒ…éƒ½æ˜¯é€šè¿‡è¿™ä¸ªè¿æ¥ä¼ è¾“çš„ï¼Œæ‰€ä»¥ï¼Œåœ¨HTTP/2ä¸­ï¼Œå‘ç”ŸTCPé˜Ÿå¤´é˜»å¡é€ æˆçš„å½±å“ä¼šæ›´å¤§ï¼Œå› ä¸ºHTTP/2çš„å¤šè·¯å¤ç”¨æŠ€æœ¯ä½¿å¾—å¤šä¸ªè¯·æ±‚å…¶å®æ˜¯åŸºäºåŒä¸€ä¸ªTCPè¿æ¥çš„ï¼Œé‚£å¦‚æœæŸä¸€ä¸ªè¯·æ±‚é€ æˆäº†TCPé˜Ÿå¤´é˜»å¡ï¼Œé‚£ä¹ˆå¤šä¸ªè¯·æ±‚éƒ½ä¼šå—åˆ°å½±å“ã€‚ å°ç»“HTTP/2åº•å±‚æ˜¯é‡‡ç”¨TCPåè®®å®ç°çš„ï¼Œè™½ç„¶è§£å†³äº†HTTPé˜Ÿå¤´é˜»å¡çš„é—®é¢˜ï¼Œä½†æ˜¯å¯¹äºTCPé˜Ÿå¤´é˜»å¡çš„é—®é¢˜å´æ— èƒ½ä¸ºåŠ›ã€‚ å¦å¤–ï¼ŒTCPè¿™ç§å¯é ä¼ è¾“æ˜¯é ä¸‰æ¬¡æ¡æ‰‹å®ç°çš„ï¼ŒTCPä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´éœ€è¦äº¤äº’ä¸‰æ¬¡ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´éœ€è¦æ¶ˆè€—1.5 RTTã€‚å¦‚æœæ˜¯HTTPSé‚£ä¹ˆæ¶ˆè€—çš„RTTå°±æ›´å¤šã€‚ HTTP3/QUICåŸºäºUDPçš„Httpï¼Œæ ¸å¿ƒä¼˜åŠ¿æ˜¯ï¼šåŸºäºUdpå¤šè·¯å¤ç”¨çš„åŒæ—¶å½»åº•è§£å†³äº†é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼›0-RTTå»ºç«‹è¿æ¥ï¼›è¿æ¥è¿ç§»å¯ä»¥ä¿è¯ç½‘ç»œï¼ˆæ¯”å¦‚å®¢æˆ·ç«¯ä» WIFI åˆ‡æ¢åˆ°èœ‚çªç½‘ç»œï¼‰è¿æ¥ä¸æ–­ã€‚ 0-RTT å»ºç«‹è¿æ¥ æ— é˜Ÿå¤´é˜»å¡çš„å¤šè·¯å¤ç”¨ è¿æ¥è¿ç§» å…¨åº”ç”¨æ€åè®®æ ˆ å¯ä»¥çœ‹ä¸€ä¸‹txå®è·µhttps://mp.weixin.qq.com/s/Sf8JsZKeZYxT9WBZrh_etg ä»¥åŠæ·˜å®å¼€æºXQUIChttps://mp.weixin.qq.com/s/VTyy20IkAR-QUc1PcHWjrQ QUIC å…¨ç§° quick udp internet connectionï¼Œâ€œå¿«é€Ÿ UDP äº’è”ç½‘è¿æ¥â€ï¼Œï¼ˆå’Œè‹±æ–‡ quick è°éŸ³ï¼Œç®€ç§°â€œå¿«â€ï¼‰æ˜¯ç”± Google æå‡ºçš„åŸºäº UDP è¿›è¡Œå¯é ä¼ è¾“çš„åè®®ã€‚QUIC åœ¨åº”ç”¨å±‚å®ç°äº†ä¸¢åŒ…æ¢å¤ã€æ‹¥å¡æ§åˆ¶ã€æ»‘çª—æœºåˆ¶ç­‰ä¿è¯æ•°æ®ä¼ è¾“çš„å¯é æ€§ï¼ŒåŒæ—¶å¯¹ä¼ è¾“çš„æ•°æ®å…·å¤‡å‰å‘å®‰å…¨çš„åŠ å¯†èƒ½åŠ›ã€‚HTTP3 åˆ™æ˜¯ IETF(äº’è”ç½‘å·¥ç¨‹ä»»åŠ¡ç»„)åŸºäº QUIC åè®®åŸºç¡€è¿›è¡Œè®¾è®¡çš„æ–°ä¸€ä»£ HTTP åè®®ã€‚ QUIC/HTTP3 åˆ†å±‚æ¨¡å‹åŠä¸ HTTP2 å¯¹æ¯”ï¼š 0-RTT å»ºç«‹è¿æ¥ç®€è¿°ï¼šè¿™é‡Œè¯´ä¸€ä¸‹GQUIC(Google QUIC)é‡Œçš„å®ç°ï¼ŒåŸºæœ¬ä¸Šå®‰å“å®ç°0-RTTæ˜¯åœ¨åº”ç”¨å¯åŠ¨æ—¶å€™å°±è¿›è¡ŒåŠ å¯†æ¡æ‰‹ï¼Œæ‹¿åˆ°æœåŠ¡å™¨çš„åŠ å¯†å¥—ä»¶å’Œè¯ä¹¦ï¼Œå†…å­˜ç¼“å­˜èµ·æ¥ã€‚åé¢ç”¨åˆ°çš„æ—¶å€™å°±ä¸éœ€è¦å†è¿›è¡Œæ¡æ‰‹è·å–äº†ï¼Œç›´æ¥ç”¨æ–°ç”Ÿæˆçš„éšæœºæ•°åšå¯¹ç§°ç§˜é’¥é€šä¿¡ï¼Œåœ¨ç¬¬äºŒæ¬¡å‘é€æ—¶å¸¦ä¸Šç”¨æœåŠ¡å™¨å…¬é’¥åŠ å¯†çš„è¯¥éšæœºæ•°å°±å¯ä»¥ï¼Ÿ QUIC åŸºäºçš„ UDP åè®®æœ¬èº«æ— éœ€æ¡æ‰‹ï¼Œå¹¶ä¸”å®ƒæ—©äº TLS 1.3 åè®®ï¼Œå°±å®ç°äº†è‡ªå·±çš„ 0-RTT åŠ å¯†æ¡æ‰‹ã€‚ä¸‹å›¾åˆ†åˆ«ä»£è¡¨äº† 1-RTT æ¡æ‰‹ï¼ˆé¦–æ¬¡å»ºè¿ï¼‰ï¼ŒæˆåŠŸçš„ 0-RTT æ¡æ‰‹ï¼Œä»¥åŠå¤±è´¥å›é€€çš„æ¡æ‰‹ã€‚ æ— é˜Ÿå¤´é˜»å¡çš„å¤šè·¯å¤ç”¨ç›¸æ¯”äº HTTP/2 çš„å¤šè·¯å¤ç”¨ï¼ŒQUIC ä¸ä¼šå—åˆ°é˜Ÿå¤´é˜»å¡çš„å½±å“ï¼Œå„ä¸ªæµæ›´ç‹¬ç«‹ï¼Œå¤šè·¯å¤ç”¨çš„æ•ˆæœä¹Ÿæ›´å¥½ã€‚ è¿æ¥è¿ç§»è·Ÿ TCP ç”¨å››å…ƒç»„æ ‡è¯†ä¸€ä¸ªå”¯ä¸€è¿æ¥ä¸åŒï¼ŒQUIC ä½¿ç”¨ä¸€ä¸ª 64 ä½çš„ ConnectionID æ¥æ ‡è¯†è¿æ¥ï¼ŒåŸºäºè¿™ä¸ªç‰¹ç‚¹ï¼ŒQUIC çš„ä½¿ç”¨è¿æ¥è¿ç§»æœºåˆ¶ï¼Œåœ¨å››å…ƒç»„å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆæ¯”å¦‚å®¢æˆ·ç«¯ä» WIFI åˆ‡æ¢åˆ°èœ‚çªç½‘ç»œï¼‰ï¼Œå°è¯•â€œä¿ç•™â€å…ˆå‰çš„è¿æ¥ï¼Œä»è€Œç»´æŒæ•°æ®ä¼ è¾“ä¸ä¸­æ–­ã€‚ å…¨åº”ç”¨æ€åè®®æ ˆQUIC æ ¸å¿ƒé€»è¾‘éƒ½åœ¨ç”¨æˆ·æ€ï¼Œèƒ½çµæ´»çš„ä¿®æ”¹è¿æ¥å‚æ•°ã€æ›¿æ¢æ‹¥å¡ç®—æ³•ã€æ›´æ”¹ä¼ è¾“è¡Œä¸ºã€‚è€Œ TCP æ ¸å¿ƒå®ç°åœ¨å†…æ ¸æ€ï¼Œæ”¹é€ éœ€è¦ä¿®æ”¹å†…æ ¸å¹¶ä¸”è¿›è¡Œç³»ç»Ÿé‡å¯ï¼Œæˆæœ¬æé«˜ã€‚ //from chatgpt HTTP/3.0ã€SPDY å’Œ QUIC éƒ½ä¸ç½‘ç»œé€šä¿¡ç›¸å…³ï¼Œå®ƒä»¬åœ¨ä¸åŒå±‚æ¬¡ä¸Šæ¨åŠ¨äº†ç½‘ç»œåè®®çš„å‘å±•ï¼Œå¹¶ä¸”åœ¨ä¸€å®šç¨‹åº¦ä¸Šæœ‰ä¸€äº›è”ç³»ã€‚ä¸‹é¢æˆ‘å°†è¯¦ç»†ä»‹ç»å®ƒä»¬çš„å…³ç³»å’Œç‰¹ç‚¹ï¼š **SPDY(HTTP2.0å‰èº«)**ï¼š SPDYï¼ˆè¯»ä½œâ€speedyâ€ï¼‰æ˜¯ Google å¼€å‘çš„ä¸€ç§ç½‘ç»œåè®®ï¼Œæ—¨åœ¨ä¼˜åŒ–ä¼ è¾“æ€§èƒ½ï¼Œå‡å°‘ç½‘é¡µåŠ è½½æ—¶é—´ã€‚SPDY è¢«è®¾è®¡ä¸º HTTP/1.1 çš„æ›¿ä»£æ–¹æ¡ˆï¼Œå®ƒå¼•å…¥äº†å¤šè·¯å¤ç”¨ã€æµä¼˜å…ˆçº§ã€å¤´éƒ¨å‹ç¼©ç­‰ç‰¹æ€§ï¼Œä»¥æ”¹è¿›æ•°æ®ä¼ è¾“æ•ˆç‡ã€‚ å…³é”®ç‰¹ç‚¹ï¼š å¤šè·¯å¤ç”¨ï¼šåœ¨å•ä¸ª TCP è¿æ¥ä¸ŠåŒæ—¶ä¼ è¾“å¤šä¸ªè¯·æ±‚å’Œå“åº”ï¼Œé¿å…äº† TCP è¿æ¥çš„å»ºç«‹å’Œæ‹†é™¤å¼€é”€ã€‚ æµä¼˜å…ˆçº§ï¼šå…è®¸å¯¹ä¸åŒæµè®¾ç½®ä¼˜å…ˆçº§ï¼Œç¡®ä¿é‡è¦èµ„æºçš„ä¼˜å…ˆä¼ è¾“ã€‚ å¤´éƒ¨å‹ç¼©ï¼šä½¿ç”¨é¦–éƒ¨å‹ç¼©ç®—æ³•å‡å°‘è¯·æ±‚å’Œå“åº”çš„å¤´éƒ¨æ•°æ®é‡ã€‚ æœåŠ¡å™¨æ¨é€ï¼šæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨æ¨é€èµ„æºï¼Œä»¥å‡å°‘å®¢æˆ·ç«¯è¯·æ±‚çš„å»¶è¿Ÿã€‚ **QUIC(Http3.0å‰èº«)**ï¼š QUICï¼ˆQuick UDP Internet Connectionsï¼‰æ˜¯ Google å¼€å‘çš„ä¸€ç§åŸºäº UDP åè®®çš„ä¼ è¾“å±‚åè®®ï¼Œæ—¨åœ¨è§£å†³ TCP çš„ä¸€äº›é™åˆ¶å’Œæ€§èƒ½ç“¶é¢ˆã€‚QUIC ç»¼åˆäº† TCPã€TLS å’Œ SPDY/HTTP2 çš„ç‰¹æ€§ï¼Œæä¾›äº†æ›´å¿«çš„è¿æ¥å»ºç«‹å’Œä¼ è¾“æ€§èƒ½ã€‚ å…³é”®ç‰¹ç‚¹ï¼š è¿æ¥å¤šè·¯å¤ç”¨ï¼šç±»ä¼¼äº SPDYï¼ŒQUIC å…è®¸åœ¨åŒä¸€è¿æ¥ä¸Šå¹¶å‘ä¼ è¾“å¤šä¸ªæµã€‚ 0-RTT æ¡æ‰‹ï¼šQUIC æ”¯æŒé›¶å¾€è¿”æ—¶é—´æ¡æ‰‹ï¼Œä»è€Œå‡å°‘äº†è¿æ¥å»ºç«‹çš„å»¶è¿Ÿã€‚ å‰å‘çº é”™ï¼šé€šè¿‡åœ¨æ•°æ®åŒ…ä¸­å¼•å…¥å†—ä½™ä¿¡æ¯ï¼Œå‡å°‘æ•°æ®åŒ…ä¸¢å¤±çš„å½±å“ï¼Œæé«˜ä¼ è¾“å¯é æ€§ã€‚ åŠ¨æ€é€‚åº”ï¼šQUIC å¯ä»¥æ ¹æ®ç½‘ç»œçŠ¶å†µè‡ªé€‚åº”åœ°è°ƒæ•´æ‹¥å¡æ§åˆ¶å’Œæµæ§åˆ¶ç®—æ³•ã€‚ HTTP/3.0ï¼š HTTP/3.0 æ˜¯åœ¨ QUIC åè®®åŸºç¡€ä¸Šè¿›è¡Œçš„æ–°ä¸€ä»£ HTTP åè®®ã€‚å®ƒç»§æ‰¿äº† QUIC çš„ä¼˜åŠ¿ï¼Œå¹¶åœ¨åº”ç”¨å±‚å®šä¹‰äº†æ–°çš„ç‰¹æ€§ã€‚HTTP/3.0 çš„ç›®æ ‡æ˜¯æ”¹è¿›ç”¨æˆ·ä½“éªŒï¼Œå‡å°‘ç½‘ç»œå»¶è¿Ÿï¼Œæå‡æ€§èƒ½ã€‚ å…³é”®ç‰¹ç‚¹ï¼š åŸºäº QUICï¼šHTTP/3.0 ä½¿ç”¨ QUIC ä½œä¸ºä¼ è¾“å±‚åè®®ï¼Œä»è€Œå…·æœ‰ QUIC çš„ä¼˜åŠ¿ã€‚ å¤šè·¯å¤ç”¨ï¼šç±»ä¼¼äº SPDY å’Œ QUICï¼ŒHTTP/3.0 æ”¯æŒå¤šè·¯å¤ç”¨ï¼Œå‡å°‘äº†è¿æ¥å»ºç«‹å’Œæ‹†é™¤çš„å¼€é”€ã€‚ é›¶ RTT æ¡æ‰‹ï¼šHTTP/3.0 åˆ©ç”¨ QUIC çš„ 0-RTT æ¡æ‰‹åŠŸèƒ½ï¼Œè¿›ä¸€æ­¥å‡å°‘è¿æ¥å»ºç«‹çš„å»¶è¿Ÿã€‚ ç»¼ä¸Šæ‰€è¿°ï¼ŒSPDY å’Œ QUIC éƒ½æ˜¯ Google æå‡ºçš„ç½‘ç»œåè®®ï¼Œå…¶ä¸­ SPDY ä½œä¸º HTTP/1.1 çš„æ”¹è¿›ç‰ˆå¼•å…¥äº†å¤šè·¯å¤ç”¨ç­‰ç‰¹æ€§ï¼Œè€Œ QUIC åˆ™æ˜¯åŸºäº UDP çš„ä¼ è¾“å±‚åè®®ï¼Œç»¼åˆäº†å¤šè·¯å¤ç”¨ã€0-RTT æ¡æ‰‹ç­‰åŠŸèƒ½ã€‚HTTP/3.0 åˆ™æ˜¯åœ¨ QUIC çš„åŸºç¡€ä¸Šå®šä¹‰çš„æ–°ä¸€ä»£ HTTP åè®®ï¼Œå°† QUIC çš„ä¼˜åŠ¿å¼•å…¥åˆ°åº”ç”¨å±‚ã€‚å®ƒä»¬çš„ç›®æ ‡éƒ½æ˜¯æå‡ç½‘ç»œä¼ è¾“æ€§èƒ½ï¼Œå‡å°‘å»¶è¿Ÿï¼Œä»è€Œæ”¹å–„ç”¨æˆ·ä½“éªŒ Otheré™„å½•ï¼šHttpå„ç‰ˆæœ¬åŠHttpsä½¿ç”¨å æ¯”Https: çº¦95%Http2.0: çº¦68%Http3.0: çº¦20%æ•°æ®æ¥æºï¼šhttps://httparchive.org/reports/state-of-the-web#h2 cookieå’Œsessionä½œç”¨ä¸åŒºåˆ« HTTPåè®®æœ¬èº«æ˜¯æ— æ³•åˆ¤æ–­ç”¨æˆ·èº«ä»½ã€‚æ‰€ä»¥éœ€è¦cookieæˆ–è€…session cookieä¸sessionåŒºåˆ« Sessionæ˜¯æœåŠ¡å™¨ç«¯ä¿æŒçŠ¶æ€çš„æ–¹æ¡ˆï¼ŒCookieæ˜¯å®¢æˆ·ç«¯ä¿æŒçŠ¶æ€çš„æ–¹æ¡ˆ Cookieä¿å­˜åœ¨å®¢æˆ·ç«¯æœ¬åœ°ï¼Œå®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨æ—¶ä¼šå°†Cookieä¸€èµ·æäº¤ï¼›Sessionä¿å­˜åœ¨æœåŠ¡ç«¯ï¼Œé€šè¿‡æ£€ç´¢SessionidæŸ¥çœ‹çŠ¶æ€ã€‚ä¿å­˜Sessionidçš„æ–¹å¼å¯ä»¥é‡‡ç”¨Cookieï¼Œå¦‚æœç¦ç”¨äº†Cookieï¼Œå¯ä»¥ä½¿ç”¨URLé‡å†™æœºåˆ¶ï¼ˆæŠŠä¼šè¯IDä¿å­˜åœ¨URLä¸­ï¼‰ã€‚ 1ï¼‰å­˜å‚¨ä½ç½®ä¸åŒï¼Œcookieæ˜¯ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„æ•°æ®ï¼›sessionçš„æ•°æ®å­˜æ”¾åœ¨æœåŠ¡å™¨ä¸Š 2ï¼‰å­˜å‚¨å®¹é‡ä¸åŒï¼Œå•ä¸ªcookieä¿å­˜çš„æ•°æ®å°ï¼Œä¸€ä¸ªç«™ç‚¹æœ€å¤šä¿å­˜20ä¸ªCookieï¼›å¯¹äºsessionæ¥è¯´å¹¶æ²¡æœ‰ä¸Šé™ 3ï¼‰å­˜å‚¨æ–¹å¼ä¸åŒï¼Œcookieä¸­åªèƒ½ä¿ç®¡ASCIIå­—ç¬¦ä¸²ï¼›sessionä¸­èƒ½å¤Ÿå­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ® 4ï¼‰éšç§ç­–ç•¥ä¸åŒï¼Œcookieå¯¹å®¢æˆ·ç«¯æ˜¯å¯è§çš„ï¼›sessionå­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Šï¼Œå¯¹å®¢æˆ·ç«¯æ˜¯é€æ˜çš„ 5ï¼‰æœ‰æ•ˆæœŸä¸Šä¸åŒï¼Œcookieå¯ä»¥é•¿æœŸæœ‰æ•ˆå­˜åœ¨ï¼›sessionä¾èµ–äºåä¸ºJSESSIONIDçš„cookieï¼Œè¿‡æœŸæ—¶é—´é»˜è®¤ä¸º-1ï¼Œåªéœ€å…³é—­çª—å£è¯¥sessionå°±ä¼šå¤±æ•ˆ 6ï¼‰è·¨åŸŸæ”¯æŒä¸Šä¸åŒï¼Œcookieæ”¯æŒè·¨åŸŸåè®¿é—®ï¼›sessionä¸æ”¯æŒè·¨åŸŸåè®¿é—® ä¸€æ¬¡HTTPè¯·æ±‚ï¼Œç¨‹åºä¸€èˆ¬ç»å†äº†å“ªå‡ ä¸ªæ­¥éª¤ï¼Ÿ1ï¼‰è§£æåŸŸå -&gt; 2ï¼‰å‘èµ·TCPä¸‰æ¬¡æ¡æ‰‹ï¼Œå»ºç«‹è¿æ¥ -&gt; 3ï¼‰åŸºäºTCPå‘èµ·HTTPè¯·æ±‚ -&gt; 4ï¼‰æœåŠ¡å™¨å“åº”HTTPè¯·æ±‚ï¼Œå¹¶è¿”å›æ•°æ® -&gt; 5ï¼‰å®¢æˆ·ç«¯è§£æè¿”å›æ•°æ® è¯¦ç»†ç‚¹ï¼š ä»è¾“å…¥ç½‘å€åˆ°è·å¾—é¡µé¢çš„è¿‡ç¨‹ (è¶Šè¯¦ç»†è¶Šå¥½)ï¼Ÿsss æµè§ˆå™¨æŸ¥è¯¢ DNSï¼Œé¦–å…ˆä¼šè®¿é—®æµè§ˆå™¨ç¼“å­˜ï¼Œå¦‚æœªå‘½ä¸­åˆ™è¿›ä¸€æ­¥è®¿é—®æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œå¦‚æœªå‘½ä¸­åˆ™è®¿é—®hostsæ–‡ä»¶ã€‚å¦‚æœªå‘½ä¸­ï¼Œåˆ™å®¢æˆ·ç«¯æƒ³æœ¬åœ°DNSæœåŠ¡å™¨å‘èµ·é€’å½’æŸ¥è¯¢ï¼ˆæœ¬åœ°DNSä¼šå°†ç»“æœä¹Ÿå°±æ˜¯ipç›´æ¥è¿”å›ï¼‰ï¼Œå¦‚æœ¬åœ°DNSè§£ææœåŠ¡å™¨æœªå‘½ä¸­ï¼Œåˆ™ç”±æœ¬åœ°DNSè§£ææœåŠ¡å™¨å‘æ ¹åŸŸåæœåŠ¡å™¨ã€é¡¶çº§åŸŸåæœåŠ¡å™¨ã€ç®¡ç†æ–¹åŸŸåæœåŠ¡å™¨ç­‰ä¾æ¬¡è¿›è¡Œè¿­ä»£æŸ¥è¯¢ï¼ˆæ¯æœ‰ä¸€ä¸ªæœªå‘½ä¸­åˆ™è¿”å›ä¸‹ä¸€ä¸ªåŸŸåæœåŠ¡å™¨åœ°å€ç»™æœ¬åœ°åŸŸåæœåŠ¡å™¨ï¼Œæ¯”å¦‚local dns serverå‘æ ¹åŸŸåæœåŠ¡å™¨æŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æ ¹åŸŸåæœåŠ¡å™¨è¿”å›é¡¶çº§åŸŸåæœåŠ¡å™¨åœ°å€ç»™local dns serverï¼Œç„¶ålocal dns serverå‘æ”¶åˆ°çš„è¿™ä¸ªåœ°å€è¿­ä»£å‘èµ·æŸ¥è¯¢ï¼‰ ç®€è¿°ï¼šå³æµè§ˆå™¨ç¼“å­˜ -&gt; æ“ä½œç³»ç»Ÿç¼“å­˜ -&gt; æœ¬åœ°Hostæ–‡ä»¶ -&gt; å‘æœ¬åœ°DNSæœåŠ¡å™¨æŸ¥è¯¢ ï¼Œæœ€ç»ˆå–å¾—åŸŸåå¯¹åº”ip æµè§ˆå™¨è·å¾—åŸŸåå¯¹åº”çš„IPåœ°å€ä»¥åï¼Œæµè§ˆå™¨å‘æœåŠ¡å™¨è¯·æ±‚å»ºç«‹é“¾æ¥ï¼Œå‘èµ·ä¸‰æ¬¡æ¡æ‰‹ï¼› TCP/IPé“¾æ¥å»ºç«‹èµ·æ¥åï¼Œæµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€HTTPè¯·æ±‚ï¼› æœåŠ¡å™¨æ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶æ ¹æ®è·¯å¾„å‚æ•°æ˜ å°„åˆ°ç‰¹å®šçš„è¯·æ±‚å¤„ç†å™¨è¿›è¡Œå¤„ç†ï¼Œå¹¶å°†å¤„ç†ç»“æœåŠç›¸åº”çš„è§†å›¾è¿”å›ç»™æµè§ˆå™¨ï¼› æµè§ˆå™¨è§£æå¹¶æ¸²æŸ“è§†å›¾ï¼Œè‹¥é‡åˆ°å¯¹jsæ–‡ä»¶ã€cssæ–‡ä»¶åŠå›¾ç‰‡ç­‰é™æ€èµ„æºçš„å¼•ç”¨ï¼Œåˆ™é‡å¤ä¸Šè¿°æ­¥éª¤å¹¶å‘æœåŠ¡å™¨è¯·æ±‚è¿™äº›èµ„æºï¼› æµè§ˆå™¨æ ¹æ®å…¶è¯·æ±‚åˆ°çš„èµ„æºã€æ•°æ®æ¸²æŸ“é¡µé¢ï¼Œæœ€ç»ˆå‘ç”¨æˆ·å‘ˆç°ä¸€ä¸ªå®Œæ•´çš„é¡µé¢ã€‚","link":"/2021/11/19/HttpProtocol/"},{"title":"Image","text":"å†…å­˜æ‰€åœ¨ä½ç½®Android 2.3 ä¹‹å‰ï¼š åƒç´ æ•°æ®å­˜åœ¨äºnative heap Android 3.0 ~ 7.1 ä¹‹é—´ï¼š å­˜åœ¨äº java heap Android 8.0åŠä¹‹åï¼š å­˜åœ¨äº native ä¸ºä»€ä¹ˆ 2.3.3 ~ 7.0 è¦æ”¾åˆ° Java å †? ç›´æ¥æ”¾åˆ° Native ä¸­, ç„¶ååœ¨ Java å¯¹è±¡ finalize è°ƒç”¨çš„æ—¶å€™é‡Šæ”¾ä¸è¡Œå—? Java å±‚çš„ Bitmap å¯¹è±¡æ˜¯ä¸€ä¸ªå£³, éå¸¸å°, å› æ­¤æœ‰å¯èƒ½ä¼šå‡ºç° Native å †å¿«åˆ°äº† 3G, Java å †æ‰ 10 MB, 10MB æ˜¯æ— æ³•è§¦å‘ Dalvik GC çš„, å› æ­¤è¿™ä¸ª java å¯¹è±¡çš„ finalize å¹¶éé‚£ä¹ˆå®¹æ˜“è°ƒç”¨, å› æ­¤å¯èƒ½ä¼šå‡ºç° Native å † OOM çš„æƒ…å†µ, æ•…éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ recycle åƒç´ æ•°æ®ç›´æ¥æ”¾ç½®åˆ° Java å †, Java å †å°±èƒ½ç›´æ¥ç»Ÿè®¡åˆ°çœŸæ­£çš„å†…å­˜æ•°æ®, èƒ½å¤Ÿæ ¹æ®å†…å­˜ä½¿ç”¨æƒ…å†µå‡†ç¡®è§¦å‘ GC å›æ”¶æ•°æ® éšæ‚£ä¾¿æ˜¯ Java å †å†…å­˜ç©ºé—´æ¯”è¾ƒå°, å®¹å™¨é€ æˆ Java å †çš„ OOM ä¸ºä»€ä¹ˆ 8.0 åˆæ”¾ç½®åˆ°äº† Native å †ä¸­? ä½¿ç”¨ NativeAllocationRegistry è§£å†³äº†è¿™ä¸ªé—®é¢˜, è§¦å‘ ART å † GC çš„æ¡ä»¶ä¸ä»…ä»…æ˜¯å †å ç”¨ä¸è¶³, é€šè¿‡ VMRuntime.registerNativeAllocation æ³¨å†Œçš„ Native å†…å­˜ç´¯è®¡è¶…è¿‡äº†é˜ˆå€¼(4MB)ä¹‹åæ—¶ä¹Ÿä¼šè§¦å‘ GC è€Œä¸” ART çš„ GC æ€§èƒ½æ¯” Dalvik å¥½çš„å¤š, ä¸ä¼šè½»æ˜“é€ æˆä¸»çº¿ç¨‹å¡é¡¿ bitmapæ€ä¹ˆé‡Šæ”¾ï¼šåœ¨ Android 2.3.3 ä¹‹å‰å¼€å‘è€…å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ recycle æ–¹æ³•å»é‡Šæ”¾ Native å†…å­˜ï¼Œå› ä¸ºé‚£ä¸ªæ—¶å€™ç®¡ç†Bitmapå†…å­˜æ¯”è¾ƒå¤æ‚,éœ€è¦æ‰‹åŠ¨ç»´æŠ¤å¼•ç”¨è®¡æ•°å™¨ android6åŠä¹‹å‰ï¼šBitmap çš„å†…å­˜å›æ”¶ä¸»è¦æ˜¯é€šè¿‡ BitmapFinalizer æ¥å®Œæˆçš„ï¼Œé€šè¿‡è¦†ç›–**finalize()**ä¸­è°ƒç”¨nativeçš„ææ„å‡½æ•°æ¥é‡Šæ”¾nativeå†…å­˜ã€‚ Android8åŠä¹‹åï¼šä¼šåœ¨ new Bitmap æ—¶ä¼šæ³¨å†Œ native çš„ Finalizer æ–¹æ³•NativeAllocationRegistry.registerNativeAllocation å…¶å®æ— è®ºæ˜¯ Android M å‰è¿˜æ˜¯ä¹‹åï¼Œé‡Šæ”¾ Native å±‚çš„ Bitmap å¯¹è±¡çš„æ€æƒ³éƒ½æ˜¯å»ç›‘å¬ Java å±‚çš„ Bitmap æ˜¯å¦è¢«é‡Šæ”¾ï¼Œä¸€æ—¦å½“ Java å±‚çš„ Bitmap å¯¹è±¡è¢«é‡Šæ”¾åˆ™ç«‹å³å»é‡Šæ”¾ Native å±‚çš„ Bitmap ã€‚åªä¸è¿‡ Android M å‰æ˜¯åŸºäº Java çš„ GC æœºåˆ¶å’Œfinalize()ï¼Œè€Œ Android M åæ˜¯æ³¨å†Œ native çš„ Finalizer æ–¹æ³•ã€‚ å…¶ä¸­ Fresco å¯ä»¥ç•™ç”¨åŒ¿åå…±äº«å†…å­˜ ï¼Œåœ¨5.0ä¹‹å‰åƒç´ å­˜åœ¨äºjava heapä¸Šæ—¶ï¼Œå°†åƒç´ ä¼˜åŒ–è‡³ Ashmem åŒ¿åå…±äº«å†…å­˜ä¸Šï¼ˆè¿‘ä¼¼nativeï¼‰ Android å“ªä¸ªç‰ˆæœ¬ä¹‹å‰ASå¯ä»¥åœ¨profilerä¸­é¢„è§ˆå›¾ç‰‡ The â€œview bitmapâ€ feature is still there (for Android 5.0 to 7.1) å› ä¸ºprofiler åˆ†æçš„ hprof ä¸­ï¼Œåœ¨8.0ç‰ˆæœ¬å‰ï¼Œbitmapæ˜¯å­˜åœ¨java heapä¸­çš„ï¼Œä½†æ˜¯ç”±äº8.0ä¹‹åbitmapå›åˆ°äº†native heapï¼Œè€Œhprofåªåˆ†æjava heapï¼Œæ•…è€Œåªèƒ½åœ¨Android 5.0 to 7.1ä¸­ä½¿ç”¨view bitmap å°ç»“ï¼š2.3ä¹‹å‰çš„åƒç´ å­˜å‚¨éœ€è¦çš„å†…å­˜æ˜¯åœ¨nativeä¸Šåˆ†é…çš„ï¼Œå¹¶ä¸”ç”Ÿå‘½å‘¨æœŸä¸å¤ªå¯æ§ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·è‡ªå·±å›æ”¶ã€‚ 2.3-7.1ä¹‹é—´ï¼ŒBitmapçš„åƒç´ å­˜å‚¨åœ¨Dalvikçš„Javaå †ä¸Šï¼Œ å½“ç„¶ï¼Œ4.4ä¹‹å‰çš„ç”šè‡³èƒ½åœ¨åŒ¿åå…±äº«å†…å­˜ä¸Šåˆ†é…ï¼ˆFrescoé‡‡ç”¨ï¼‰ï¼Œè€Œ8.0ä¹‹åçš„åƒç´ å†…å­˜åˆé‡æ–°å›åˆ°nativeä¸Šå»åˆ†é…ï¼Œä¸éœ€è¦ç”¨æˆ·ä¸»åŠ¨å›æ”¶ï¼Œ8.0ä¹‹åå›¾åƒèµ„æºçš„ç®¡ç†æ›´åŠ ä¼˜ç§€ï¼Œæå¤§é™ä½äº†OOMã€‚ å›¾ç‰‡å†…å­˜å°ºå¯¸å°ºå¯¸è®¡ç®—ï¼š //PSï¼š å°ç±³8UD ç³»ç»Ÿèµ‹çš„dpiä¸º440ï¼ˆè®¡ç®—å€¼401ï¼‰ï¼Œdensityä¸º2.75ï¼ˆè®¡ç®—å€¼ä¸º2.5ï¼‰ mipmapå›¾ç‰‡èµ„æºè®¡ç®— inDensityè¡¨ç¤ºè¯¥èµ„æºæ¥æºäºå“ªä¸ªå¯†åº¦çš„æ–‡ä»¶å¤¹ï¼Œè¯¥å€¼ä»TypedValueè·å–ï¼› inTargetDensityè¡¨ç¤ºè¯¥èµ„æºå°†è¦æ˜¾ç¤ºåœ¨å“ªä¸ªå¯†åº¦çš„è®¾å¤‡ä¸Šã€‚ needSize = (int)(size * ((float)inTargetDensity / inDensity) + 0.5) ï¼ˆå››èˆäº”å…¥ï¼‰ ä¸åŒç›®å½•å¯¹åº”çš„dpiå…·ä½“ä¸º: ä¸€å¼ 172*172çš„å›¾ç‰‡æ”¾åœ¨hdpiç›®å½•ä¸‹ï¼Œåˆ™åœ¨dpiä¸º420çš„è®¾å¤‡ä¸­å°ºå¯¸æ˜¯å¤šå°‘ï¼Ÿ 1ã€hdpiå¯†åº¦æ˜¯240 å› æ­¤Options.inDesnity = 240 2ã€è®¾å¤‡å¯†åº¦æ˜¯420 å› æ­¤Options.inTargetDensity = 420; 3ã€è®¾å¤‡è¿”å›bitmapå¤§å°=172 * 420 / 240 = 301px é€šè¿‡ä¸Šé¢å¯¹dpçš„äº†è§£ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨è®¾å®šviewå¤§å°ã€é—´è·æ—¶ä½¿ç”¨dpèƒ½æœ€å¤§é™åº¦åœ°å±è”½è®¾å¤‡å¯†åº¦ä¹‹é—´çš„å·®å¼‚ã€‚å¯èƒ½ä½ å°±ä¼šé—®äº†ï¼Œé‚£bitmapå±•ç¤ºçš„æ—¶å€™å¦‚ä½•é€‚é…ä¸åŒå¯†åº¦çš„è®¾å¤‡å‘¢ï¼Ÿ 123456789101112131415161718192021scsså¤åˆ¶ä»£ç  @Override protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { setMeasuredDimension(bitmap.getWidth(), bitmap.getHeight()); } private void init() { String path = Environment.getExternalStorageDirectory() + &quot;/Download/photo1.jpg&quot;; bitmap = BitmapFactory.decodeFile(path); paint = new Paint(); paint.setAntiAlias(true); } @Override protected void onDraw(Canvas canvas) { super.onDraw(canvas); Rect src = new Rect(0, 0, bitmap.getWidth(), bitmap.getHeight()); RectF rectF = new RectF(0, 0, bitmap.getWidth(), bitmap.getHeight()); canvas.drawBitmap(bitmap, src, rectF, paint); } è‡ªå®šä¹‰viewä»ç£ç›˜ä¸ŠåŠ è½½ä¸€å¼ å›¾ç‰‡ï¼Œå¹¶å°†ä¹‹æ˜¾ç¤ºåœ¨viewä¸Šï¼Œviewçš„å¤§å°å†³å®šäºbitmapå¤§å°ã€‚ä¾æ—§ä»¥ä¸Šè¿°Aã€Bè®¾å¤‡ä¸ºä¾‹ï¼Œå±•ç¤ºç»“æœå¦‚ä¸‹ï¼š å·¦è¾¹æ˜¯Aè®¾å¤‡ï¼Œå³è¾¹æ˜¯Bè®¾å¤‡ã€‚ æ˜æ˜¾åœ°çœ‹å‡ºï¼Œåœ¨Aè®¾å¤‡æ˜¾ç¤ºæ¯”Bè®¾å¤‡å¤§å¾ˆå¤šï¼Œå®é™…ä¸Šå’Œæˆ‘ä»¬ä¹‹å‰ç”¨pxæ¥æè¿°viewçš„å¤§å°åŸç†æ˜¯ä¸€æ ·çš„ï¼Œbitmapçš„å®½ã€é«˜éƒ½æ˜¯pxåœ¨æè¿°ï¼Œè€Œbitmapå†³å®šäº†viewçš„å®½ã€é«˜ï¼Œæœ€ç»ˆå¯¼è‡´Aè®¾å¤‡å’ŒBè®¾å¤‡ä¸Šçš„viewå¤§å°ï¼ˆå®½ã€é«˜åƒç´ ï¼‰æ˜¯ä¸€æ ·çš„ï¼Œè€Œå®ƒä»¬å±å¹•å¯†åº¦åˆä¸ç›¸åŒï¼Œå› æ­¤äº§ç”Ÿäº†å·®å¼‚ã€‚ é‚£ä¸ä¼šæ¯æ¬¡éƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±æ ¹æ®å±å¹•å¯†åº¦æ¥è½¬æ¢bitmapå¤§å°å§ï¼Ÿå¹¸è¿çš„æ˜¯ï¼ŒAndroidå·²ç»ä¸ºæˆ‘ä»¬è€ƒè™‘åˆ°äº†ã€‚ å¦‚ä¸Šå›¾ï¼Œåœ¨Android Studioåˆ›å»ºå·¥ç¨‹çš„æ—¶å€™ï¼Œé»˜è®¤åœ¨resä¸‹åˆ›å»ºmipmapç›®å½•ï¼Œè¿™äº›mipmapç›®å½•æŒ‰ç…§å¯†åº¦åˆ†ä¸ºmdpi/hdpi/xhdpi/xxhdpi/xxxhdpiï¼Œçœ‹èµ·æ¥éƒ½åœ¨â€œä¸€ä¸ªâ€œmipmapâ€ç›®å½•ä¸‹ï¼Œå®é™…ä¸Šåˆ†ä¸ºä¸åŒçš„ç›®å½•ï¼š ç”Ÿæˆä¸åŒå¯†åº¦çš„ç›®å½•æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ Aè®¾å¤‡dpi=240ï¼Œæ ¹æ®dpièŒƒå›´ï¼Œå±äºhdpi Bè®¾å¤‡dpi=420ï¼Œæ ¹æ®dpièŒƒå›´ï¼Œå±äºxxhdpi å›¾ç‰‡åŸå§‹å°ºå¯¸ï¼šphoto1.jpg(å®½é«˜ 172px-172px) å½“æˆ‘ä»¬æƒ³è¦åœ¨ä¸åŒå¯†åº¦è®¾å¤‡ä¸Šæ˜¾ç¤ºåŒä¸€å¼ å›¾ç‰‡å¹¶ä¸”æƒ³è¦â€œçœ‹èµ·æ¥ä¸€æ ·å¤§æ—¶â€ã€‚å‡è®¾è®¾è®¡çš„æ—¶å€™ä»¥hdpiä¸ºå‡†ï¼Œæ”¾ç½®photo1.jpgä¸º172*172ï¼Œé‚£ä¹ˆæ ¹æ®è®¡ç®—è§„åˆ™åœ¨xxhdpiä¸Šéœ€è¦è®¾ç½®photo1.jpgä¸º: scale = 480 / 240 = 2 width = 172 * 2 = 344 height = 172 * 2= 344 æ³¨ï¼šè¿™é‡Œä¸ºä»€ä¹ˆè¦æ”¾å¤§ï¼Ÿå¯ä»¥è¿™ä¹ˆç†è§£ï¼Œå› ä¸ºBè®¾å¤‡å¯†åº¦å¤§ï¼Œé€šå¸¸æ¥è¯´å¯†åº¦è¶Šå¤§å•ä½å°ºå¯¸å†…éœ€è¦çš„åƒç´ è¶Šå¤šï¼Œå‡è®¾Aè®¾å¤‡ä¸Š172*172å æ®1inché¢ç§¯ï¼Œé‚£ä¹ˆä¸ºäº†èƒ½å¤Ÿåœ¨Bè®¾å¤‡ä¸Šå¡«å……æ»¡ç›¸åŒçš„é¢ç§¯éœ€è¦æ›´å¤šçš„åƒç´ ï¼Œå› æ­¤Bè®¾å¤‡ä¸Šçš„å›¾ç‰‡åˆ†è¾¨ç‡åº”è¯¥æ›´å¤§ï¼ˆè¿™é‡Œè¯´çš„é€šå¸¸æ˜¯å› ä¸ºçœŸæ­£å†³å®šè®¾å¤‡å•ä½å°ºå¯¸å†…å®¹çº³çš„åƒç´ ä¸ªæ•°çš„å› ç´ æ˜¯ppiï¼Œæœ‰äº›è®¾å¤‡dpiæ¯”è¾ƒå¤§ï¼Œä½†æ˜¯ppiåè€Œå°ï¼‰ ç°åœ¨hdpiå’Œxxhdpiç›®å½•ä¸‹åˆ†åˆ«å­˜æ”¾äº†åŒåå›¾ç‰‡ï¼šphoto1.jpgï¼Œåªæ˜¯å¤§å°ä¸åŒã€‚å½“ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼š Aè®¾å¤‡å‘ç°è‡ªå·±å¯†åº¦å±äºhdpiï¼Œå®ƒä¼šç›´æ¥åˆ°hdpiä¸‹å¯»æ‰¾å¯¹åº”çš„photo1.jpgå¹¶æ˜¾ç¤º Bè®¾å¤‡å‘ç°è‡ªå·±å¯†åº¦å±äºxxhdpiï¼Œå®ƒä¼šç›´æ¥åˆ°xxhdpiä¸‹å¯»æ‰¾å¯¹åº”çš„photo1.jpgå¹¶æ˜¾ç¤º æ¥çœ‹çœ‹æ•ˆæœï¼š å·¦è¾¹Aè®¾å¤‡ï¼Œå³è¾¹Bè®¾å¤‡ é’ˆå¯¹ä¸åŒçš„å¯†åº¦è®¾è®¡ä¸åŒçš„å›¾ç‰‡å¤§å°ï¼Œæœ€å¤§é™åº¦ä¿è¯äº†åŒä¸€å›¾ç‰‡åœ¨ä¸åŒå¯†åº¦è®¾å¤‡ä¸Šè¡¨ç°â€œçœ‹èµ·æ¥å·®ä¸å¤šå¤§â€ã€‚ æ¥çœ‹çœ‹Aã€Bè®¾å¤‡ä¸Šå›¾ç‰‡å å†…å­˜å¤§å°ï¼š Aè®¾å¤‡ 172 * 172 * 4 = 118336 â‰ˆ 116k Bè®¾å¤‡ 344 * 344 * 4 = 473344 â‰ˆ 462k æ³¨ï¼šè§£æbitmapæ—¶ï¼Œé»˜è®¤inPreferredConfig=ARGB_8888ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªåƒç´ æœ‰4ä¸ªå­—èŠ‚æ¥å­˜å‚¨ è¯´æ˜åœ¨Bè®¾å¤‡ä¸Šæ˜¾ç¤ºphoto1.jpgéœ€è¦æ›´å¤šçš„å†…å­˜ã€‚ ä¸Šè¾¹åªæ˜¯åˆ—ä¸¾äº†hdpiã€xxhdipiï¼ŒåŒç†å¯¹äºmdpiã€xhdpiã€xxxhdpiæ ¹æ®è§„åˆ™æ”¾å…¥ç›¸åº”å¤§å°çš„å›¾ç‰‡ï¼Œç¨‹åºä¼šæ ¹æ®ä¸åŒçš„è®¾å¤‡å¯†åº¦ä»å¯¹åº”çš„mipmapæ–‡ä»¶å¤¹ä¸‹åŠ è½½èµ„æºã€‚å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬æ— éœ€å…³æ³¨bitmapåœ¨ä¸åŒå¯†åº¦è®¾å¤‡ä¸Šæ˜¾ç¤ºé—®é¢˜äº†ã€‚ åªä¿ç•™ä¸€å¥—å°ºå¯¸çš„èµ„æºåœ¨mipmapå„ä¸ªæ–‡ä»¶å¤¹ä¸‹éƒ½æ”¾ç½®åŒä¸€å¥—èµ„æºçš„ä¸åŒå°ºå¯¸æ–‡ä»¶ä¼¼ä¹æœ‰ç‚¹å¤ªå apkå¤§å°ï¼Œèƒ½å¦åªæ”¾æŸä¸ªå¯†åº¦ä¸‹å›¾ç‰‡ï¼Œå…¶ä½™çš„é ç³»ç»Ÿè‡ªå·±é€‚é…å‘¢ï¼Ÿ ç°åœ¨åªä¿ç•™hdpiä¸‹çš„photo1.jpgå›¾ç‰‡ï¼Œçœ‹çœ‹åœ¨Aã€Bè®¾å¤‡ä¸Šè¿è¡Œæƒ…å†µå¦‚ä½•ï¼š çœ‹èµ·æ¥å’Œä¸Šå¼ å›¾å·®ä¸å¤šï¼Œè¯´æ˜ç³»ç»Ÿä¼šå¸®æˆ‘ä»¬é€‚é…Bè®¾å¤‡ä¸Šçš„å›¾ç‰‡ã€‚ å†æ¥çœ‹çœ‹Aã€Bè®¾å¤‡ä¸Šå›¾ç‰‡å å†…å­˜å¤§å°ï¼š å…ˆçœ‹Aè®¾å¤‡ï¼š å†çœ‹Bè®¾å¤‡ï¼š Aè®¾å¤‡ 172 * 172 * 4 = 118336 â‰ˆ 116k Bè®¾å¤‡ 301 * 301 * 4 = 362404 â‰ˆ 354k å¯¹æ¯”photo1.jpg åˆ†åˆ«æ”¾åœ¨hdpiã€xxhdpiå’Œåªæ”¾åœ¨hdpiä¸‹å¯ä»¥çœ‹å‡ºï¼šBè®¾å¤‡ä¸Šå›¾ç‰‡æ‰€å å†…å­˜å˜å°äº†ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ¥ä¸‹æ¥ä»æºç é‡Œå¯»æ‰¾ç­”æ¡ˆã€‚ æ„é€ Bitmap12iniå¤åˆ¶ä»£ç Bitmap bitmap = BitmapFactory.decodeResource(getContext().getResources(), R.mipmap.photo1); Aã€Bè®¾å¤‡åŒæ ·åŠ è½½hdpi/photo1.jpgï¼Œè¿”å›çš„bitmapå¤§å°ä¸ç›¸åŒï¼Œæˆ‘ä»¬ä»è¿™æ–¹æ³•å¼€å§‹ä¸€æ¢ç©¶ç«Ÿã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public static Bitmap decodeResource(Resources res, int id, BitmapFactory.Options opts) { validate(opts); Bitmap bm = null; InputStream is = null; try { final TypedValue value = new TypedValue(); //æ ¹æ®èµ„æºidï¼Œæ„é€ Valueå¯¹è±¡ï¼Œè¿™é‡Œé¢éœ€è¦å…³æ³¨çš„å˜é‡ï¼šdensity is = res.openRawResource(id, value); bm = decodeResourceStream(res, value, is, null, opts); } catch (Exception e) { /* do nothing. If the exception happened on open, bm will be null. If it happened on close, bm is still valid. */ } finally { try { if (is != null) is.close(); } catch (IOException e) { // Ignore } } if (bm == null &amp;&amp; opts != null &amp;&amp; opts.inBitmap != null) { throw new IllegalArgumentException(&quot;Problem decoding into existing bitmap&quot;); } return bm; }public static Bitmap decodeResourceStream(@Nullable Resources res, @Nullable TypedValue value, @Nullable InputStream is, @Nullable Rect pad, @Nullable BitmapFactory.Options opts) { validate(opts); if (opts == null) { opts = new BitmapFactory.Options(); } if (opts.inDensity == 0 &amp;&amp; value != null) { //é€šè¿‡valueé‡Œçš„densityç»™optionsé‡Œçš„inDensityèµ‹å€¼ final int density = value.density; if (density == TypedValue.DENSITY_DEFAULT) { opts.inDensity = DisplayMetrics.DENSITY_DEFAULT; } else if (density != TypedValue.DENSITY_NONE) { opts.inDensity = density; } } if (opts.inTargetDensity == 0 &amp;&amp; res != null) { //è·å–è®¾å¤‡å±å¹•å¯†åº¦å¹¶èµ‹äºˆopts.inTargetDensity opts.inTargetDensity = res.getDisplayMetrics().densityDpi; } //ç¡®å®šoption inDensityã€inTargetDensity åä¼ å…¥jniå±‚åŠ è½½bitmap return decodeStream(is, pad, opts); } ä¸Šé¢æ¶‰åŠåˆ°çš„å…³é”®ç‚¹æ˜¯densityï¼Œåˆ†åˆ«æ˜¯TypedValueçš„densityå’ŒOptionsçš„densityã€‚ å…ˆæ¥çœ‹çœ‹TypedValue density: 1234/** * If the Value came from a resource, this holds the corresponding pixel density. * */ public int density; ç®€å•è§£é‡Šï¼šè¡¨ç¤ºè¯¥èµ„æºä»å“ªä¸ªå¯†åº¦æ–‡ä»¶å¤¹ä¸‹å–çš„ï¼›æ¯”å¦‚Aã€Bè®¾å¤‡å–hdpiä¸‹çš„photo1.jpgï¼Œé‚£ä¹ˆæ­¤æ—¶density=240 å†æ¥çœ‹çœ‹Options density 1234567891011* The pixel density to use for the bitmap. This will always result* in the returned bitmap having a density set for itpublic int inDensity;* The pixel density of the destination this bitmap will be drawn to.* This is used in conjunction with {@link #inDensity} and* {@link #inScaled} to determine if and how to scale the bitmap before* returning it.public int inTargetDensity; ç®€å•è§£é‡Šï¼šinDensityè¡¨ç¤ºè¯¥èµ„æºæ¥æºäºå“ªä¸ªå¯†åº¦çš„æ–‡ä»¶å¤¹ï¼Œè¯¥å€¼ä»TypedValueè·å–ï¼› inTargetDensityè¡¨ç¤ºè¯¥èµ„æºå°†è¦æ˜¾ç¤ºåœ¨å“ªä¸ªå¯†åº¦çš„è®¾å¤‡ä¸Šã€‚åœ¨æ„é€ Bitmapæ—¶ï¼Œä¼šæ ¹æ®inDensityä¸inTargetDensityå†³å®šBitmapæ”¾å¤§ç¼©å†™çš„å€æ•°ã€‚ è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š needSize = (int)(size * ((float)inTargetDensity / inDensity) + 0.5) ï¼ˆå››èˆäº”å…¥ï¼‰ ç°åœ¨åˆ†æBè®¾å¤‡åŠ è½½hdpi/photo1.jpgå¦‚ä½•åšçš„: 1ã€hdpiå¯†åº¦æ˜¯240 å› æ­¤Options.inDesnity = 240 2ã€Bè®¾å¤‡å¯†åº¦æ˜¯420 å› æ­¤Options.inTargetDensity = 420; 3ã€Bè®¾å¤‡è¿”å›bitmapå¤§å°=172 * 420 / 240 = 301px é“¾æ¥ï¼šhttps://juejin.cn/post/7015597280120176676 å¤§å›¾åŠ è½½ï¼šæŒ‰æ¯”ä¾‹é‡‡æ ·ç¼©å°ï¼Œå‚è§https://developer.android.com/topic/performance/graphics/load-bitmap?hl=zh-cn å·¨å›¾æŒ‰åŒºåŸŸæ˜¾ç¤ºï¼šBitmapRegionDecoderæ˜¾ç¤ºåŒºåŸŸ + æ‰‹åŠ¿ç§»åŠ¨æ˜¾ç¤ºä¸­å¿ƒ å‚è§https://blog.csdn.net/lmj623565791/article/details/49300989 å›¾ç‰‡æ ¼å¼å›¾ç‰‡æ ¼å¼-webp WEBPç›¸è¾ƒä¼ ç»Ÿå›¾ç‰‡æ ¼å¼ï¼ˆjpg/png/gifï¼‰ä¼šæœ‰è¾ƒå¤§çš„æ–‡ä»¶ä½“ç§¯ä¼˜åŠ¿ï¼ˆ25%ä»¥ä¸Šï¼‰ï¼Œä½†ä¼šå¯¼è‡´è§£ç æ—¶é—´æå‡1.5å€ä»¥ä¸Šã€‚å³webpæœ‰æ›´å°çš„ä½“ç§¯ï¼ŒèŠ‚çœå¸¦å®½ï¼Œapkä½“ç§¯ï¼Œæ›´å¿«çš„åŠ è½½é€Ÿåº¦ï¼ˆå› ä¸ºä½“ç§¯é›„å®‰ï¼‰ï¼Œä½†ä¼šå°‘è®¸å¢åŠ cpuå‹åŠ› â€œç¼–è§£ç é€Ÿåº¦ä¸Šï¼Œæ ¹æ®Googleçš„æµ‹è¯•ï¼Œç›®å‰WebPä¸JPGç›¸æ¯”è¾ƒï¼Œæ¯«ç§’çº§åˆ«ä¸Šï¼Œç¼–ç é€Ÿåº¦æ…¢10å€ï¼Œè§£ç é€Ÿåº¦æ…¢1.5å€ã€‚ç¼–ç é€Ÿåº¦å³å¯è¢«æ²¡å½±å“ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨ä¸Šä¼ æ—¶ç”Ÿæˆä¸€ä»½WebPå›¾ç‰‡ã€‚è§£ç é€Ÿåº¦åˆ™éœ€è¦å®¢æˆ·ç«¯ç»¼åˆèŠ‚çœä¸‹çš„æµé‡æ¥ç»¼åˆè€ƒè™‘ã€‚æ€»ä¹‹å¸¦å®½èŠ‚çœæ¯”cpuæ¶ˆè€—æ›´æœ‰ä»·å€¼â€ å›¾ç‰‡æ ¼å¼-JPG/JPEGJPG å’Œ JPEGæ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œä¸è¿‡æ˜¯å› ä¸ºwindowå¹³å°æ—©æœŸåªæ”¯æŒä¸‰ä¸ªå­—ç¬¦çš„æ–‡ä»¶æ ¼å¼ï¼Œå°†JPEGç¼©å†™ä¸ºJPGã€‚ JPGæ˜¯æœ‰æŸå‹ç¼©çš„ï¼Œæ˜¯1600ä¸‡ä½é¢œè‰²ï¼Œä¸æ”¯æŒé€æ˜åº¦çš„ï¼Œå­˜å‚¨ä½“ç§¯è¾ƒå°çš„ å›¾ç‰‡æ ¼å¼-PNGPNGæ–‡ä»¶åˆ©ç”¨ç‰¹æ®Šçš„ç¼–ç æ–¹æ³•æ ‡è®°é‡å¤å‡ºç°çš„æ•°æ®ï¼Œå› è€Œå¯¹å›¾åƒçš„é¢œè‰²æ²¡æœ‰å½±å“ï¼Œä¹Ÿä¸å¯èƒ½äº§ç”Ÿé¢œè‰²çš„æŸå¤±ï¼Œè¿™æ ·å°±å¯ä»¥é‡å¤ä¿å­˜è€Œä¸é™ä½å›¾åƒè´¨é‡ã€‚ PNGæ˜¯æ— æŸå‹ç¼©çš„ï¼Œæ˜¯1600ä¸‡ä½é¢œè‰²ï¼Œæ”¯æŒé€æ˜åº¦çš„ï¼Œå­˜å‚¨ä½“ç§¯è¾ƒå¤§çš„ å›¾ç‰‡æ ¼å¼-GIFç›®å‰ä½¿ç”¨èŒƒå›´æœ€å¹¿çš„åŠ¨å›¾æ ¼å¼ï¼Œå…·ä½“ä¸ºGIF87aç‰ˆæœ¬ GIF æ ¼å¼çš„æ–‡ä»¶æŒ‰å—å­˜å‚¨ï¼Œæ•´ä½“ä¸Šåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š æ–‡ä»¶å¤´ï¼ˆHeaderï¼‰ GIF æ•°æ®æµï¼ˆGIF Data Streamï¼‰ æ–‡ä»¶ç»“å°¾ï¼ˆTrailerï¼‰ GIFæ˜¯æ— æŸå‹ç¼©çš„ï¼Œæ˜¯256ä½é¢œè‰²ï¼Œä¸æ”¯æŒé€æ˜åº¦çš„ï¼Œå­˜å‚¨æäº¤ç¨å¤§çš„ PNG JPEG GIF å‹ç¼©ç®—æ³• æ— æŸå‹ç¼© æœ‰æŸå‹ç¼© æ— æŸå‹ç¼© é€æ˜åº¦ ä¿æŒå›¾åƒé€æ˜åº¦ ä¸ä¿æŒå›¾åƒé€æ˜åº¦ ä¸æ”¯æŒé€æ˜åº¦ å›¾ç‰‡å°ºå¯¸ å¤§ æ›´å° è¾ƒå¤§ ç”»é¢è´¨é‡ æ›´å¥½çš„ ç›¸æ¯”PNGä¸å¤Ÿå¥½ è¾ƒå·® å¯ç”¨é¢œè‰² 1600ä¸‡ 2^24 1600ä¸‡ 2^24 256 2^8 We will learn more by walking through a sample GIF file. You can see the sample file and its corresponding bytes below. Actual Size Enlarged Bytes (10x10) (100x100) 47 49 46 38 39 61 0A 00 0A 00 91 00 00 FF FF FF FF 00 00 00 00 FF 00 00 00 21 F9 04 00 00 00 00 00 2C 00 00 00 00 0A 00 0A 00 00 02 16 8C 2D 99 87 2A 1C DC 33 A0 02 75 EC 95 FA A8 DE 60 8C 04 91 4C 01 00 3B Header BlockFrom the sample file: 47 49 46 38 39 61 ï¼Œ ASCIIè§£ç å³ä¸º GIF89a Logical Screen DescriptorFrom Sample File: 0A 00 0A 00 91 00 00 Global Color TableFrom the sample file: FF FF FF FF 00 00 00 00 FF 00 00 00 Graphics Control ExtensionFrom the sample file: 21 F9 04 00 00 00 00 00 Image DescriptorFrom the sample file: 2C 00 00 00 00 0A 00 0A 00 00 Local Color Table(Opetional)Null Image DataFrom the sample file: 02 16 8C 2D 99 87 2A 1C DC 33 A0 02 75 EC 95 FA A8 DE 60 8C 04 91 4C 01 00 Plain Text ExtensionExample (not in the sample file): 21 01 0C 00 00 00 00 64 00 64 00 14 14 01 00 0B 68 65 6C 6C 6F 20 77 6F 72 6C 64 00 Application ExtensionExample (not in sample file): 21 FF 0B 4E 45 54 53 43 41 50 45 32 2E 30 03 01 05 00 00 Comment ExtensionExample (not in sample file): 21 FE 09 62 6C 75 65 62 65 72 72 79 00 TrailerFrom sample file: 3B //This is the end flag The trailer block indicates when youâ€™ve reached the end of the file. It is always a byte with a value of 3B.","link":"/2021/04/01/Image/"},{"title":"Https","text":"Httpå’ŒHttps å…¶å®HTTPSå°±æ˜¯ä» HTTP åŠ ä¸Š SSL/TLS ï¼ˆåŠ å¯†å¤„ç†+è®¤è¯+å®Œæ•´æ€§ä¿æŠ¤ï¼‰ å®Œæ•´çš„httpsé€šä¿¡è¿‡ç¨‹ï¼Œä¸‰æ¬¡RTTï¼štcpæ¡æ‰‹ä¸€æ¬¡RTTï¼ŒTLSæ¡æ‰‹ä¸¤æ¬¡RTT HTTPSå·¥ä½œåŸç† ä¸€ã€é¦–å…ˆå®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œå°†è‡ªèº«æ”¯æŒçš„åŠ å¯†ï¼ˆRSAï¼‰å’Œå“ˆå¸Œç®—æ³•ï¼ˆsha256ï¼‰è¿å¸¦å‘ç»™æœåŠ¡å™¨ï¼ˆæœåŠ¡å™¨ç«¯æœ‰éå¯¹ç§°åŠ å¯†çš„å…¬é’¥å’Œç§é’¥ï¼‰ äºŒã€æœåŠ¡å™¨ç«¯æ¥å—è¯·æ±‚ï¼Œé€‰å–ä¸€ç»„åŠ å¯†å’Œå“ˆå¸Œç®—æ³•åï¼Œå°†æœåŠ¡å™¨è¯ä¹¦ï¼ˆå«å…¬é’¥ï¼‰å‘é€ç»™å®¢æˆ·ç«¯ ä¸‰ã€å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨ç«¯è¯ä¹¦å¹¶ä½¿ç”¨æ ¹è¯ä¹¦éªŒè¯è¯ä¹¦åï¼Œä»ä¸­å–å‡ºå…¬é’¥ï¼Œç„¶åæœ¬åœ°ç”Ÿæˆä¸€æ®µéšæœºæ•°ï¼Œå°†æ­¤éšæœºæ•°ç”¨å…¬é’¥åŠ å¯†åå‘é€ç»™æœåŠ¡å™¨ç«¯ å››ã€æœåŠ¡å™¨ç«¯ç”¨ç§é’¥è§£å¯†å‡ºè¿™æ®µéšæœºæ•°ä½œä¸ºå¯¹ç§°åŠ å¯†çš„ç§˜é’¥ã€‚ä¹‹ååŒæ–¹å°±å¯ä»¥è¿›è¡Œå¯¹ç§°åŠ å¯†ï¼ˆDESã€AESç­‰ï¼‰ã€‚ è¯ä¹¦æ ¡éªŒè¿‡ç¨‹æ ¡éªŒè¯ä¹¦çš„è¿‡ç¨‹ï¼š ç¬¬ä¸€æ­¥æ˜¯æ ¡éªŒè¯ä¹¦ç½‘ç«™åŸŸåã€æœ‰æ•ˆæœŸç­‰ã€‚ ç¬¬äºŒæ­¥æ˜¯æ ¡éªŒè¯ä¹¦æœ¬èº«æ˜¯å¦å¯ä¿¡ï¼šä¸»è¦æ˜¯ä¾é éªŒè¯è¯ä¹¦çš„ä¿¡ä»»é“¾æ¡å®Œæˆã€‚ æ¯”å¦‚æ ¹è¯ä¹¦A-&gt;B-&gt;æœåŠ¡ç«¯è¯ä¹¦Cï¼Œé‚£ä¹ˆé¦–å…ˆè¦éªŒè¯Cæ˜¯ç”±Bç­¾ç½²çš„ï¼Œè¿™ä¸€æ­¥çš„å…·ä½“æ­¥éª¤æ˜¯ï¼š 1. **ç”¨Bè¯ä¹¦çš„å…¬é’¥è§£å¯†Cè¯ä¹¦çš„ç­¾åä¿¡æ¯åæ‹¿åˆ°Cè¯ä¹¦çš„hashå€¼ï¼ˆç­¾ç½²æ—¶è¯¥Hashå€¼ç”±Bçš„ç§é’¥åŠ å¯†ç”Ÿæˆï¼‰ï¼Œ** 2. **ç„¶åå†ç”¨hashç®—æ³•ï¼ˆBè¯ä¹¦ä¸Šå¸¦çš„ç­¾åç®—æ³•ï¼‰è®¡ç®—Bè¯ä¹¦çš„&lt;u&gt;å¾…ç­¾åæ•°æ®&lt;/u&gt;åå¾—åˆ°è®¡ç®—hashå€¼ï¼Œ** 3. **å°†è¯ä¹¦è§£å¯†çš„hashå€¼ä¸è®¡ç®—hashå€¼æ¯”è¾ƒå³å¯ã€‚** ç¬¬ä¸‰æ­¥æ˜¯ä½¿ç”¨CRLï¼ˆè¯ä¹¦åŠé”€åˆ—è¡¨ï¼‰æˆ–OCSPï¼ˆåœ¨çº¿è¯ä¹¦çŠ¶æ€åè®®ï¼‰ç¡®è®¤è¯ä¹¦æ˜¯å¦å·²è¢«åŠé”€ã€‚ 123456789101112è¯ä¹¦å†…å®¹å¯ç®€åŒ–ä¸º:å¾…ç­¾åæ•°æ®ï¼š ç‰ˆæœ¬: v3 åºåˆ—å·: 123456 ç­¾åç®—æ³•: SHA256withRSA é¢å‘è€…ä¿¡æ¯: CN=A, O=A Corporation, C=US æœ‰æ•ˆæœŸ: 2022-01-01 è‡³ 2023-01-01 ä¸»é¢˜ä¿¡æ¯: CN=B, O=B Corporation, C=US ä¸»é¢˜å…¬é’¥: (å…¬é’¥æ•°æ®) æ‰©å±•å­—æ®µ: (å¯é€‰)ç­¾åï¼š ç­¾å: (ç­¾åæ•°æ®) æŠ“åŒ…è½¯ä»¶æ€ä¹ˆå®ç°çš„ä»¥æˆ‘ç†Ÿæ‚‰çš„æŠ“åŒ…è½¯ä»¶whistleä¸ºä¾‹ï¼ŒæŠ“åŒ…è½¯ä»¶èƒ½æŠ“httpså†…å®¹çš„æ ¸å¿ƒæ˜¯ï¼šä½ çš„æ‰‹æœºå®‰è£…äº†whistleçš„è‡ªç­¾åæ ¹è¯ä¹¦ï¼ŒåŒæ—¶ä½ çš„è¯·æ±‚éƒ½æ˜¯ä»£ç†ç»™whistleçš„ï¼Œç„¶åwhistleä¼šå‘é€ç»™å®¢æˆ·ç«¯ç»è‡ªç­¾åæ ¹è¯ä¹¦ç­¾ç½²è¿‡çš„ä¼ªé€ æœåŠ¡å™¨è¯ä¹¦ï¼Œæ•…è€Œèƒ½é€šè¿‡å®¢æˆ·ç«¯çš„è¯ä¹¦æ ¡éªŒï¼Œä»è€Œæ‹¿åˆ°è¯·æ±‚åŸæ–‡ã€‚ æ‰‹æœºå®‰è£…äº†æŠ“åŒ…è½¯ä»¶çš„è‡ªç­¾åè¯ä¹¦åï¼ŒæŠ“åŒ…å·¥å…·åœ¨ä½œä¸ºä»£ç†è¿›è¡ŒHTTPSæµé‡æ•è·æ—¶ï¼Œå®é™…ä¸Šå……å½“äº†ä¸­é—´äººã€‚æŠ“åŒ…å¼€å¯åï¼Œå®¢æˆ·ç«¯httpsè¯·æ±‚çš„æ¡æ‰‹å¯¹è±¡å®é™…ä¸Šæ˜¯æŠ“åŒ…è½¯ä»¶ï¼ŒæœåŠ¡ç«¯æ‹¿åˆ°çš„è¯·æ±‚åœ°å€æ˜¯ æŠ“åŒ…è½¯ä»¶çš„åœ°å€ã€‚æ‰‹æœºçš„è¯·æ±‚ä¹Ÿå®é™…ä¸Šæ˜¯ä¸æŠ“åŒ…è½¯ä»¶åœ¨äº¤äº’ï¼ŒæŠ“åŒ…è½¯ä»¶å†ä¸æœåŠ¡å™¨äº¤äº’ã€‚æ•…è€ŒæŠ“åŒ…è½¯ä»¶èƒ½è®°å½•å¹¶ä¿®æ”¹å®¢æˆ·ç«¯çš„è¯·æ±‚ä¸å“åº” è‡ªç­¾åè¯ä¹¦ï¼šæŠ“åŒ…è½¯ä»¶ç”Ÿæˆä¸€ä¸ªè‡ªç­¾åçš„è¯ä¹¦ï¼ˆè‡ªç­¾åè¯ä¹¦æ˜¯ä¸€ç§çµæ´»ä¸”æ–¹ä¾¿çš„SSL/TLSè¯ä¹¦è§£å†³æ–¹æ¡ˆï¼Œæ˜¯ç”±è¯ä¹¦çš„æ‰€æœ‰è€…è‡ªå·±ç­¾å‘çš„ï¼Œé€‚ç”¨äºäºå¼€å‘æµ‹è¯•ç¯å¢ƒå’Œå†…éƒ¨ç½‘ç»œã€‚ç„¶è€Œï¼Œç”±äºå®ƒä¸æ˜¯ç”±å—ä¿¡ä»»çš„ä¸‰æ–¹è¯ä¹¦é¢å‘æœºæ„å³CAç­¾å‘çš„ï¼Œä½¿å¾—å®ƒæ— æ³•æä¾›å¯é çš„èº«ä»½éªŒè¯ï¼Œæ— æ³•é€‚ç”¨äºå…¬ç½‘ï¼‰ å®¢æˆ·ç«¯ä¿¡ä»»è‡ªç­¾åè¯ä¹¦ï¼š å½“ç”¨æˆ·åœ¨è®¾å¤‡ä¸Šå®‰è£…æŠ“åŒ…è½¯ä»¶çš„è‡ªç­¾åè¯ä¹¦åï¼Œè¿™ä¸ªè¯ä¹¦è¢«è®¾å¤‡ä½œä¸ºå—ä¿¡ä»»çš„æ ¹è¯ä¹¦ã€‚è®¾å¤‡ä¼šä¿¡ä»»ç”±è¿™ä¸ªè‡ªç­¾åè¯ä¹¦ç­¾å‘çš„æ‰€æœ‰è¯ä¹¦ã€‚ ä¸­é—´äººä»£ç†æ¡æ‰‹ï¼š æŠ“åŒ…è½¯ä»¶å……å½“â€œä¸­é—´äººâ€ï¼Œæ‹¦æˆªå®¢æˆ·ç«¯çš„HTTPSè¯·æ±‚ã€‚å®¢æˆ·ç«¯å‘å‡ºçš„è¯·æ±‚é¦–å…ˆåˆ°è¾¾æŠ“åŒ…è½¯ä»¶ã€‚ æŠ“åŒ…è½¯ä»¶å‘å®¢æˆ·ç«¯æä¾›ä¸€ä¸ªç”±å®ƒè‡ªå·±çš„è‡ªç­¾åæ ¹è¯ä¹¦ç­¾ç½²çš„ä¼ªé€ æœåŠ¡å™¨è¯ä¹¦ï¼ˆç›®æ ‡æœåŠ¡å™¨çš„æ›¿èº«è¯ä¹¦ï¼‰ã€‚ å› ä¸ºå®¢æˆ·ç«¯å·²ç»ä¿¡ä»»æŠ“åŒ…è½¯ä»¶çš„è‡ªç­¾åè¯ä¹¦ï¼Œæ‰€ä»¥å®ƒä¼šä¿¡ä»»è¿™ä¸ªä¼ªé€ çš„æœåŠ¡å™¨è¯ä¹¦ï¼Œå¹¶ä¸æŠ“åŒ…è½¯ä»¶è¿›è¡ŒTLSæ¡æ‰‹ã€‚ è¿™æ ·ï¼Œæ‰‹æœºä¸Šçš„æµè§ˆå™¨æˆ–åº”ç”¨ç¨‹åºåœ¨è¿æ¥æ—¶å®é™…ä¸Šæ˜¯ä¸æŠ“åŒ…è½¯ä»¶å»ºç«‹çš„httpsæ¡æ‰‹ã€‚ æŠ“åŒ…è½¯ä»¶çš„ä¸»è¦ç›®çš„æ˜¯æ•è·ã€åˆ†æå’Œè°ƒè¯•ç½‘ç»œæµé‡ã€‚å…¶å·¥ä½œæ­¥éª¤å¦‚ä¸‹ï¼š å®¢æˆ·ç«¯é€šè¿‡ä»£ç†å‘é€è¯·æ±‚ï¼š æŠ“åŒ…è½¯ä»¶é…ç½®ä¸ºä»£ç†ï¼Œå®¢æˆ·ç«¯é…ç½®é€šè¿‡æ­¤ä»£ç†å‘é€æ‰€æœ‰ç½‘ç»œè¯·æ±‚ã€‚ æŠ“åŒ…è½¯ä»¶ç”Ÿæˆä¸€ä¸ªè‡ªç­¾åè¯ä¹¦ï¼Œå®¢æˆ·ç«¯å°†å…¶å®‰è£…ä¸ºå—ä¿¡ä»»çš„æ ¹è¯ä¹¦ã€‚ ä»£ç†è§£æå¹¶å†å‘é€è¯·æ±‚ï¼š å®¢æˆ·ç«¯çš„è¯·æ±‚é¦–å…ˆç”±æŠ“åŒ…è½¯ä»¶æ¥æ”¶ã€‚å¯¹äºHTTPSè¯·æ±‚ï¼ŒæŠ“åŒ…è½¯ä»¶ä¼šä½¿ç”¨è‡ªç­¾åè¯ä¹¦è§£å¯†è¿™äº›è¯·æ±‚ã€‚ æŠ“åŒ…è½¯ä»¶è®°å½•å’Œåˆ†æè§£å¯†åçš„è¯·æ±‚å†…å®¹ï¼Œç„¶åé‡æ–°åŠ å¯†å¹¶å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ æœåŠ¡å™¨å“åº”ç»è¿‡ä»£ç†è¿”å›å®¢æˆ·ç«¯ï¼š ç›®æ ‡æœåŠ¡å™¨è¿”å›å“åº”ï¼ŒæŠ“åŒ…è½¯ä»¶è§£å¯†å¹¶è®°å½•è¿™äº›å“åº”æ•°æ®ã€‚ æŠ“åŒ…è½¯ä»¶å†é‡æ–°åŠ å¯†è¿™äº›æ•°æ®å¹¶å‘é€å›å®¢æˆ·ç«¯ã€‚ VPNä¸æŠ“åŒ…è½¯ä»¶çš„åŸç†ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ä¸€å±‚ä¸­é—´äººï¼Œå°†å®¢æˆ·ç«¯çš„è¯·æ±‚å®é™…ä¸Šä»£ç†åˆ°ä¸­é—´äººå±‚å‘èµ·è¯·æ±‚ã€‚ ä¸åŒçš„æ˜¯ç”±äºæŠ“åŒ…è½¯ä»¶ä½¿å®¢æˆ·ç«¯å®‰è£…çš„è‡ªç­¾åè¯ä¹¦ï¼Œå®¢æˆ·ç«¯åœ¨è¯ä¹¦æ ¡éªŒæ—¶é‡åˆ°æŠ“åŒ…è½¯ä»¶è‡ªç­¾åè¯ä¹¦ç­¾ç½²çš„ä¼ªé€ æœåŠ¡å™¨è¯ä¹¦ä¼šæ ¡éªŒé€šè¿‡ï¼Œä½¿å®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½èƒ½åœ¨ä¸­é—´äººå±‚è§£å¯†åæŸ¥çœ‹å’Œä¿®æ”¹ï¼Œä¹‹åæŠ“åŒ…å†è½¬å‘ã€‚ è€ŒVPNåˆ™æ˜¯é€šè¿‡åŠ å¯†éš§é“ï¼ˆåŠ å¯†æ•´ä¸ªä¼ è¾“é“¾è·¯ï¼‰ï¼šä½¿ç”¨åè®®å¦‚IPsecã€OpenVPNã€L2TPç­‰ï¼‰ï¼Œåœ¨åŸæœ¬å°±ç”±ssl/tlsåŠ å¯†çš„æ•°æ®ä¸Šå†åŠ å¯†ä¸€å±‚ï¼Œä¹‹åæ— æ³•æ„ŸçŸ¥ä¼ è¾“å†…å®¹åŸåŸæœ¬æœ¬çš„è½¬å‘ã€‚","link":"/2024/07/08/Https/"},{"title":"InputMangerService","text":"","link":"/2023/03/16/InputMangerService/"},{"title":"Thread","text":"å¯¹äºdalvikè™šæ‹Ÿæœºè€Œè¨€å…¶æ£€æµ‹åˆ°æ‰§è¡Œé¢‘ç‡è¾ƒé«˜çš„å‡½æ•°æ—¶å°±ä¼šè¿›è¡Œjitç¼–è¯‘å°†å…¶ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨ç ï¼Œè¿™æ ·ä¸‹æ¬¡æ­¤å‡½æ•°æ‰§è¡Œçš„æ—¶å€™å°±ä¼šç›´æ¥æ‰§è¡Œç¼–è¯‘åçš„æœºå™¨ç ï¼Œç¼–è¯‘åçš„æœºå™¨ç åªå­˜åœ¨äºå†…å­˜ä¸­å¹¶ä¸ä¼šä»¥æ–‡ä»¶çš„å½¢å¼ä¿å­˜ï¼Œappé‡å¯åæ­¤å‡½æ•°ä¾ç„¶ä¼šä»¥è§£é‡Šæ¨¡å¼æ‰§è¡Œã€‚åœ¨JITç¼–è¯‘å‡½æ•°ç”Ÿæˆæœºå™¨ç çš„åŒæ—¶è¿˜ä¼šç”Ÿæˆé…ç½®æ–‡ä»¶profileè®°å½•çƒ­ç‚¹å‡½æ•°ä¿¡æ¯ï¼Œä¾›AOTå®ˆæŠ¤è¿›ç¨‹ä½¿ç”¨ç¼–è¯‘ç”Ÿæˆoatæ–‡ä»¶ï¼Œä»¥æé€Ÿæ‰§è¡Œã€‚ ä»¥ä¸‹ä¸ºJITå·¥ä½œæµï¼š ä½†åœ¨æˆ‘ä»¬æµ‹è¯•ä¸­ AE æ— è®ºè¿è¡Œå¤šå°‘æ¬¡å¯åŠ¨é˜¶æ®µä¾ç„¶æœ‰JITçš„è¿è¡Œï¼Œä½†TEMUåœ¨å¯åŠ¨é˜¶æ®µJITæ˜¯æ— æ‰§è¡Œçš„ï¼Œåˆ¤æ–­TEMUå·²åšäº†AOTä¼˜åŒ–ã€‚ AOTäº‹å‰ç¼–è¯‘ï¼Œå³åœ¨ä»£ç è¿è¡Œå‰è¿›è¡Œç¼–è¯‘ã€‚å¯¹äºandroid 7.0ä¹‹å‰çš„artè™šæ‹Ÿæœºè€Œè¨€å…¶ä¼šåœ¨apkå®‰è£…çš„è¿‡ç¨‹ä¸­åˆ©ç”¨dex2oatç¨‹åºå°†apkä¸­çš„dexæ–‡ä»¶ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤å¹¶ä¿å­˜ä¸ºoatæ–‡ä»¶ï¼Œè¿™æ ·åœ¨apkå¯åŠ¨æ—¶ç›´æ¥åŠ è½½æ­¤oatæ–‡ä»¶å¹¶è¿è¡Œï¼Œæé«˜äº†ç¨‹åºäº†æ‰§è¡Œæ•ˆç‡ã€‚ä½†æ˜¯å› ä¸ºä»–éœ€è¦åœ¨apkå®‰è£…çš„æ—¶å€™ä½¿ç”¨dex2oatç¨‹åºè¿›è¡Œç¼–è¯‘ï¼Œæ‰€ä»¥å¢åŠ äº†apkåœ¨å®‰è£…è¿‡ç¨‹ä¸­çš„æ—¶é—´ã€‚ é€šè¿‡AOTä¼˜åŒ–çš„ä¸­ç«¯æœºæœ‰100msæ”¶ç›Š è¯¥ä¼˜åŒ–éœ€è¦å¯¹APPå†…æ‰€æœ‰å·¥ç¨‹åšæ”¹é€ ï¼Œå‡çº§AGPåï¼Œè¿›è¡ŒBaselineProfileä¼˜åŒ–","link":"/2024/08/08/JIT&AOT/"},{"title":"JvmMemoryStructure","text":"ç¨‹åºè®¡æ•°å™¨ä¸ä¼šOOMå’ŒStackOverflow æœ‰æ ˆçš„ç»“æ„ï¼ˆæ ˆ java stackã€navtive stackï¼‰å¯èƒ½å‘ç”Ÿ StackOverflowErrorï¼ˆæ ˆè¿‡æ·±ï¼‰ å’Œ OOM StackOverFlowError ï¸°è‹¥Java è™šæ‹Ÿæœºæ ˆçš„å†…å­˜å¤§å°ä¸å…è®¸åŠ¨æ€æ‰©å±•ï¼Œé‚£ä¹ˆå½“çº¿ç¨‹è¯·æ±‚æ ˆçš„æ·±åº¦è¶…è¿‡å½“å‰Java è™šæ‹Ÿæœºæ ˆçš„æœ€å¤§æ·±åº¦çš„æ—¶å€™ï¼Œå°±æŠ›å‡ºStackOverFlowErroré”™è¯¯ã€‚OutOfMemoryError :å¦‚æœè™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼ˆå½“å‰å¤§éƒ¨åˆ†çš„ Java è™šæ‹Ÿæœºéƒ½å¯åŠ¨æ€æ‰©å±•ï¼Œåªä¸è¿‡ Java è™šæ‹Ÿæœºè§„èŒƒä¸­ä¹Ÿå…è®¸å›ºå®šé•¿åº¦çš„è™šæ‹Ÿæœºæ ˆï¼‰ï¼Œå½“æ‰©å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜æ—¶ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚ æ²¡æ ˆçš„ç»“æ„ï¼ˆå †heapã€æ–¹æ³•åŒºMethod Areaï¼‰åªå¯èƒ½å‘ç”Ÿ OOM javaæ ˆå¸§ç»“æ„ JavaStackFrameï¼š Javaå†…å­˜æ¯”è¾ƒæµè¡Œçš„è¯´æ³•ä¾¿æ˜¯å †å’Œæ ˆï¼Œè¿™å…¶å®æ˜¯éå¸¸ç²—ç•¥çš„ä¸€ç§åˆ’åˆ†ï¼Œè¿™ç§åˆ’åˆ†çš„â€å †â€å¯¹åº”å†…å­˜æ¨¡å‹çš„Javaå †ï¼Œâ€æ ˆâ€æ˜¯æŒ‡è™šæ‹Ÿæœºæ ˆã€‚ JMM (processon.com) ç®€å•èšç„¦äºå †ã€æ–¹æ³•åŒºä¸æ ˆã€‚ Java Heap javaå †æ˜¯JVMæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ã€‚å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å®ä¾‹å¯¹è±¡ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½åœ¨è¿™é‡Œåˆ†é…ã€‚Javaå †æ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸï¼Œå› æ­¤å¾ˆå¤šæ—¶å€™ä¹Ÿè¢«ç§°ä¸ºâ€œGCå †â€ã€‚ å †å†…å­˜æ˜¯JVMä¸­æœ€å¤§çš„ä¸€å—ç”±å¹´è½»ä»£å’Œè€å¹´ä»£ç»„æˆï¼ˆ1:2ï¼‰ï¼Œè€Œå¹´è½»ä»£å†…å­˜åˆè¢«åˆ†æˆä¸‰éƒ¨åˆ†ï¼ŒEdenç©ºé—´ã€From Survivorç©ºé—´ã€To Survivorç©ºé—´,é»˜è®¤æƒ…å†µä¸‹å¹´è½»ä»£æŒ‰ç…§8:1:1çš„æ¯”ä¾‹æ¥åˆ†é…ï¼› ç®€è¿°ï¼š 1ï¼šä¸€å¼€å§‹ï¼ŒEden,from,to éƒ½æ˜¯ç©ºçš„ï¼Œæ–°å¯¹è±¡äº§ç”Ÿè¢«åˆ†é…åˆ°EdenåŒºï¼› 2ï¼šEdenæ»¡äº†ï¼Œå¼€å§‹ç¬¬ä¸€æ¬¡GCï¼Œmark-copyç®—æ³•ï¼Œå°†å­˜æ´»å¯¹è±¡å¤åˆ¶è‡³fromï¼Œä¹‹åæ¸…ç©ºEdenï¼Œæ­¤æ—¶Edenï¼Œtoä¸ºç©ºï¼›fromä¿å­˜age1å¯¹è±¡ï¼› 3ï¼š2æ­¥éª¤é‡å¤ï¼Œä¹Ÿå°±æ˜¯Edenå¡«æ»¡-&gt;GC-&gt;è½¬ç§»å­˜æ´»è‡³fromï¼Œä½†æ³¨æ„ä¸‹GCæ—¶å¦‚æœfromä¸­ageè¶…è¿‡é˜ˆå€¼çš„å¯¹è±¡ä¼šè¢«é€å¾€oldï¼› 4ï¼šç›´åˆ°fromä¹Ÿæ»¡äº†ï¼Œä¸‹ä¸€æ¬¡GCä¼š HotSpot JVMæŠŠå¹´è½»ä»£åˆ†ä¸ºäº†ä¸‰éƒ¨åˆ†ï¼š1ä¸ªEdenåŒºå’Œ2ä¸ªSurvivoråŒºï¼ˆåˆ†åˆ«å«fromå’Œtoï¼‰ã€‚é»˜è®¤æ¯”ä¾‹ä¸º8ï¼š1,ä¸ºå•¥é»˜è®¤ä¼šæ˜¯è¿™ä¸ªæ¯”ä¾‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šèŠåˆ°ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ–°åˆ›å»ºçš„å¯¹è±¡éƒ½ä¼šè¢«åˆ†é…åˆ°EdenåŒº(ä¸€äº›å¤§å¯¹è±¡ç‰¹æ®Šå¤„ç†),è¿™äº›å¯¹è±¡ç»è¿‡ç¬¬ä¸€æ¬¡Minor GCåï¼Œå¦‚æœä»ç„¶å­˜æ´»ï¼Œå°†ä¼šè¢«ç§»åˆ°SurvivoråŒºã€‚å¯¹è±¡åœ¨SurvivoråŒºä¸­æ¯ç†¬è¿‡ä¸€æ¬¡Minor GCï¼Œå¹´é¾„å°±ä¼šå¢åŠ 1å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œå°±ä¼šè¢«ç§»åŠ¨åˆ°å¹´è€ä»£ä¸­ã€‚ å› ä¸ºå¹´è½»ä»£ä¸­çš„å¯¹è±¡åŸºæœ¬éƒ½æ˜¯æœç”Ÿå¤•æ­»çš„(80%ä»¥ä¸Š)ï¼Œæ‰€ä»¥åœ¨å¹´è½»ä»£çš„åƒåœ¾å›æ”¶ç®—æ³•ä½¿ç”¨çš„æ˜¯å¤åˆ¶ç®—æ³•ï¼Œå¤åˆ¶ç®—æ³•çš„åŸºæœ¬æ€æƒ³å°±æ˜¯å°†å†…å­˜åˆ†ä¸ºä¸¤å—ï¼Œæ¯æ¬¡åªç”¨å…¶ä¸­ä¸€å—ï¼Œå½“è¿™ä¸€å—å†…å­˜ç”¨å®Œï¼Œå°±å°†è¿˜æ´»ç€çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—ä¸Šé¢ã€‚å¤åˆ¶ç®—æ³•ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚ åœ¨GCå¼€å§‹çš„æ—¶å€™ï¼Œå¯¹è±¡åªä¼šå­˜åœ¨äºEdenåŒºå’Œåä¸ºâ€œFromâ€çš„SurvivoråŒºï¼ŒSurvivoråŒºâ€œToâ€æ˜¯ç©ºçš„ã€‚ç´§æ¥ç€è¿›è¡ŒGCï¼ŒEdenåŒºä¸­æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½ä¼šè¢«å¤åˆ¶åˆ°â€œToâ€ï¼Œè€Œåœ¨â€œFromâ€åŒºä¸­ï¼Œä»å­˜æ´»çš„å¯¹è±¡ä¼šæ ¹æ®ä»–ä»¬çš„å¹´é¾„å€¼æ¥å†³å®šå»å‘ã€‚å¹´é¾„è¾¾åˆ°ä¸€å®šå€¼(å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡-XX:MaxTenuringThresholdæ¥è®¾ç½®)çš„å¯¹è±¡ä¼šè¢«ç§»åŠ¨åˆ°å¹´è€ä»£ä¸­ï¼Œæ²¡æœ‰è¾¾åˆ°é˜ˆå€¼çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°â€œToâ€åŒºåŸŸã€‚ç»è¿‡è¿™æ¬¡GCåï¼ŒEdenåŒºå’ŒFromåŒºå·²ç»è¢«æ¸…ç©ºã€‚è¿™ä¸ªæ—¶å€™ï¼Œâ€œFromâ€å’Œâ€œToâ€ä¼šäº¤æ¢ä»–ä»¬çš„è§’è‰²ï¼Œä¹Ÿå°±æ˜¯æ–°çš„â€œToâ€å°±æ˜¯ä¸Šæ¬¡GCå‰çš„â€œFromâ€ï¼Œæ–°çš„â€œFromâ€å°±æ˜¯ä¸Šæ¬¡GCå‰çš„â€œToâ€ã€‚ä¸ç®¡æ€æ ·ï¼Œéƒ½ä¼šä¿è¯åä¸ºToçš„SurvivoråŒºåŸŸæ˜¯ç©ºçš„ã€‚Minor GCä¼šä¸€ç›´é‡å¤è¿™æ ·çš„è¿‡ç¨‹ï¼Œç›´åˆ°â€œToâ€åŒºè¢«å¡«æ»¡ï¼Œâ€œToâ€åŒºè¢«å¡«æ»¡ä¹‹åï¼Œä¼šå°†æ‰€æœ‰å¯¹è±¡ç§»åŠ¨åˆ°å¹´è€ä»£ä¸­ã€‚ Method Area æ–¹æ³•åŒº/éå †å­˜å‚¨æ¯ä¸ªç±»çš„ç»“æ„ï¼Œä¾‹å¦‚è¿è¡Œæ—¶å¸¸é‡æ± ã€å­—æ®µå’Œæ–¹æ³•æ•°æ®ï¼Œä»¥åŠæ–¹æ³•å’Œæ„é€ å‡½æ•°çš„ä»£ç  per-class structures such as the run-time constant pool, field and method data, and the code for methods and constructors è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯ç±»æ–‡ä»¶ä¸­constant_poolè¡¨çš„æ¯ä¸ªç±»æˆ–æ¯ä¸ªæ¥å£çš„è¿è¡Œæ—¶è¡¨ç¤º A run-time constant pool is a per-class or per-interface run-time representation of the constant_pool table in a class file æ¯ä¸ªè¿è¡Œæ—¶å¸¸é‡æ± éƒ½æ˜¯ä»JVMçš„æ–¹æ³•åŒºåˆ†é…çš„ã€‚ç±»æˆ–æ¥å£çš„è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯åœ¨JVMåˆ›å»ºç±»æˆ–æ¥å£æ—¶æ„é€ çš„ã€‚ Each run-time constant pool is allocated from the Java Virtual Machineâ€™s method area (Â§2.5.4). The run-time constant pool for a class or interface is constructed when the class or interface is created (Â§5.3) by the Java Virtual Machine. è™½ç„¶å«æ–¹æ³•åŒºï¼Œä½†è·Ÿæ–¹æ³•æ˜¯æ²¡ä»€ä¹ˆå…³è¥¿çš„ã€‚æ–¹æ³•åŒºå­˜å‚¨ç±»ä¿¡æ¯ã€å¸¸é‡(final static)ã€é™æ€å˜é‡ç­‰æ•°æ®ï¼Œæ˜¯çº¿ç¨‹å…±äº«çš„åŒºåŸŸï¼Œä¸ºä¸Javaå †åŒºåˆ†ï¼Œæ–¹æ³•åŒºè¿˜æœ‰ä¸€ä¸ªåˆ«åNon-Heap(éå †)ï¼› å¸¸é‡æ± ä»‹ç»å¸¸é‡æ± å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªè¡¨ï¼Œä½†æ˜¯æœ‰ä¸‰ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚ è¡¨å¤´ç»™å‡ºçš„å¸¸é‡æ± å¤§å°æ¯”å®é™…å¤§1ã€‚å‡è®¾è¡¨å¤´ç»™å‡ºçš„å€¼æ˜¯nï¼Œé‚£ä¹ˆå¸¸é‡æ± çš„å®é™…å¤§å°æ˜¯nâ€“1ã€‚ æœ‰æ•ˆçš„å¸¸é‡æ± ç´¢å¼•æ˜¯1~nâ€“1ã€‚0æ˜¯æ— æ•ˆç´¢å¼•ï¼Œè¡¨ç¤ºä¸æŒ‡å‘ä»»ä½•å¸¸é‡ã€‚ CONSTANT_Long_infoå’ŒCONSTANT_Double_infoå„å ä¸¤ä¸ªä½ç½®ã€‚ è¡¨ä¸­çš„æ¯ä¸€é¡¹çš„ç»“æ„å¦‚ä¸‹ï¼š 1234cp_info { u1 tag; u1 info[];} å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸€é¡¹éƒ½åŒ…å«ä¸€ä¸ª tagï¼Œä¸€ä¸ª info æ•°ç»„ã€‚info æ•°ç»„é‡Œé¢çš„çš„å…·ä½“å†…å®¹ä¸ tag çš„å€¼æœ‰å…³ã€‚ tag çš„å€¼åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š tagå–å€¼å¾ˆå¤šï¼Œå°±ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå…¶ä»–çš„éƒ½æ˜¯ç±»ä¼¼çš„ã€‚å¦‚æœ tag çš„å€¼ä¸º 7ï¼Œé‚£ä¹ˆ info æ•°ç»„è¡¨ç¤ºçš„æ„ä¹‰å¦‚ä¸‹ï¼š 1234CONSTANT_Class_info { u1 tag; u2 name_index;} name_index æ˜¯ä¸€ä¸ª u2 ç±»å‹ï¼Œå°±ç›¸å½“äºinfoçš„é•¿åº¦ä¸º2ã€‚ name_index çš„å«ä¹‰æ ¹æ®åç§°ä¹Ÿèƒ½çŒœçš„å‡ºæ¥ï¼Œæ˜¯ç±»åï¼Œåªä¸è¿‡å‚¨å­˜çš„æ˜¯å¸¸é‡æ± çš„ç´¢å¼•ï¼Œç´¢å¼•æŒ‡å‘çš„ä½ç½®æ˜¯ç±»åã€‚è¯¥ä½ç½®çš„å¸¸é‡ç±»å‹ä¸€å®šæ˜¯ä¸€ä¸ª CONSTANT_Utf8_info ç±»å‹ã€‚ è¯´èµ·æ¥å¯èƒ½æœ‰ç‚¹ä¸å¤ªå¥½æ‡‚ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼š å›¾ä¸­æ˜¯ä¸€ä¸ª CONSTANT_Class_info ï¼Œå®ƒçš„ name_index æ˜¯ 34ï¼Œæˆ‘ä»¬çœ‹çœ‹å¸¸é‡æ± çš„ç¬¬34é¡¹æ˜¯ä»€ä¹ˆï¼š å¯ä»¥çœ‹åˆ°34å¤„ï¼Œå®ƒç¡®å®æ˜¯ä¸€ä¸ª CONSTANT_Utf8_info ç±»å‹ï¼Œå…¶å…·ä½“çš„å€¼å°±æ˜¯ç±»çš„åå­—ã€‚ å…¶ä»–çš„tagç±»å‹ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå…·ä½“å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œæˆ‘ä»¬ç°åœ¨å¼€å§‹ä½¿ç”¨ä»£ç è§£æå¸¸é‡æ± ã€‚ ä¸Šä¸ºæ‰€æœ‰çº¿ç¨‹å…±äº« â†‘ä¸‹ä¸ºçº¿ç¨‹ç§æœ‰ â†“ æ ˆåˆåˆ†ä¸ºjvmæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆä¸»è¦ç”¨äºæ–¹æ³•çš„æ‰§è¡Œã€‚ VMStack javaæ–¹æ³•æ ˆå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒã€‚è™šæ‹Ÿæœºæ ˆæè¿°çš„æ˜¯Javaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼šæ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚æ¯ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­ä»å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚ å±€éƒ¨å˜é‡è¡¨å­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbooleanã€byteã€charã€shortã€intã€floatã€longã€doubleï¼‰ã€å¯¹è±¡å¼•ç”¨ï¼ˆreferenceç±»å‹ï¼Œå®ƒä¸ç­‰åŒäºå¯¹è±¡æœ¬èº«ï¼Œæ ¹æ®ä¸åŒçš„è™šæ‹Ÿæœºå®ç°ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æŒ‡å‘ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–è€…å…¶ä»–ä¸æ­¤å¯¹è±¡ç›¸å…³çš„ä½ç½®ï¼‰å’ŒreturnAddressç±»å‹ï¼ˆæŒ‡å‘äº†ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼‰ã€‚ æœ¬åœ°æ–¹æ³•æ ˆ nativeæ–¹æ³•æ ˆè™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡Œjavaæ–¹æ³•ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„Nativeæ–¹æ³•æœåŠ¡ã€‚ ç¨‹åºè®¡æ•°å™¨ä¸€å—è¾ƒå°çš„å†…å­˜ï¼Œå½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶ï¼Œå°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚ ï¼ï¼è®°å½•çš„æ˜¯å½“å‰çº¿ç¨‹æ‰§è¡Œçš„å­—èŠ‚ç è¡Œå·ï¼Œdebugæ—¶ä¼šè¢«é‡æ–°æ˜ å°„åˆ°å¯¹åº”çš„ä»£ç è¡Œæ•°ã€‚Debugæ–­ç‚¹æŒ‡å‘çš„ä»£ç è¡Œæ•°å¯èƒ½åŒ…å«å¤šè¡Œå­—èŠ‚ç ã€‚ æ¨èé˜…è¯»ï¼šhttp://gityuan.com/2015/10/17/java-memory/ DOC2.5. Run-Time Data AreasThe Java Virtual Machine defines various run-time data areas that are used during execution of a program. Some of these data areas are created on Java Virtual Machine start-up and are destroyed only when the Java Virtual Machine exits. Other data areas are per thread. Per-thread data areas are created when a thread is created and destroyed when the thread exits. 2.5.1. The pc RegisterThe Java Virtual Machine can support many threads of execution at once (JLS Â§17). Each Java Virtual Machine thread has its own pc (program counter) register. At any point, each Java Virtual Machine thread is executing the code of a single method, namely the current method (Â§2.6) for that thread. If that method is not native, the pc register contains the address of the Java Virtual Machine instruction currently being executed. If the method currently being executed by the thread is native, the value of the Java Virtual Machineâ€™s pc register is undefined. The Java Virtual Machineâ€™s pc register is wide enough to hold a returnAddress or a native pointer on the specific platform. 2.5.2. Java Virtual Machine StacksEach Java Virtual Machine thread has a private Java Virtual Machine stack, created at the same time as the thread. A Java Virtual Machine stack stores frames (Â§2.6). A Java Virtual Machine stack is analogous to the stack of a conventional language such as C: it holds local variables and partial results, and plays a part in method invocation and return. Because the Java Virtual Machine stack is never manipulated directly except to push and pop frames, frames may be heap allocated. The memory for a Java Virtual Machine stack does not need to be contiguous. In the First Edition of The JavaÂ® Virtual Machine Specification, the Java Virtual Machine stack was known as the Java stack. This specification permits Java Virtual Machine stacks either to be of a fixed size or to dynamically expand and contract as required by the computation. If the Java Virtual Machine stacks are of a fixed size, the size of each Java Virtual Machine stack may be chosen independently when that stack is created. A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of Java Virtual Machine stacks, as well as, in the case of dynamically expanding or contracting Java Virtual Machine stacks, control over the maximum and minimum sizes. The following exceptional conditions are associated with Java Virtual Machine stacks: If the computation in a thread requires a larger Java Virtual Machine stack than is permitted, the Java Virtual Machine throws a StackOverflowError. If Java Virtual Machine stacks can be dynamically expanded, and expansion is attempted but insufficient memory can be made available to effect the expansion, or if insufficient memory can be made available to create the initial Java Virtual Machine stack for a new thread, the Java Virtual Machine throws an OutOfMemoryError. 2.5.3. HeapThe Java Virtual Machine has a heap that is shared among all Java Virtual Machine threads. The heap is the run-time data area from which memory for all class instances and arrays is allocated. The heap is created on virtual machine start-up. Heap storage for objects is reclaimed by an automatic storage management system (known as a garbage collector); objects are never explicitly deallocated. The Java Virtual Machine assumes no particular type of automatic storage management system, and the storage management technique may be chosen according to the implementorâ€™s system requirements. The heap may be of a fixed size or may be expanded as required by the computation and may be contracted if a larger heap becomes unnecessary. The memory for the heap does not need to be contiguous. A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of the heap, as well as, if the heap can be dynamically expanded or contracted, control over the maximum and minimum heap size. The following exceptional condition is associated with the heap: If a computation requires more heap than can be made available by the automatic storage management system, the Java Virtual Machine throws an OutOfMemoryError. 2.5.4. Method AreaThe Java Virtual Machine has a method area that is shared among all Java Virtual Machine threads. The method area is analogous to the storage area for compiled code of a conventional language or analogous to the â€œtextâ€ segment in an operating system process. It stores per-class structures such as the run-time constant pool, field and method data, and the code for methods and constructors, including the special methods (Â§2.9) used in class and instance initialization and interface initialization. The method area is created on virtual machine start-up. Although the method area is logically part of the heap, simple implementations may choose not to either garbage collect or compact it. This specification does not mandate the location of the method area or the policies used to manage compiled code. The method area may be of a fixed size or may be expanded as required by the computation and may be contracted if a larger method area becomes unnecessary. The memory for the method area does not need to be contiguous. A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of the method area, as well as, in the case of a varying-size method area, control over the maximum and minimum method area size. The following exceptional condition is associated with the method area: If memory in the method area cannot be made available to satisfy an allocation request, the Java Virtual Machine throws an OutOfMemoryError. 2.5.5. Run-Time Constant PoolA run-time constant pool is a per-class or per-interface run-time representation of the constant_pool table in a class file (Â§4.4). It contains several kinds of constants, ranging from numeric literals known at compile-time to method and field references that must be resolved at run-time. The run-time constant pool serves a function similar to that of a symbol table for a conventional programming language, although it contains a wider range of data than a typical symbol table. Each run-time constant pool is allocated from the Java Virtual Machineâ€™s method area (Â§2.5.4). The run-time constant pool for a class or interface is constructed when the class or interface is created (Â§5.3) by the Java Virtual Machine. The following exceptional condition is associated with the construction of the run-time constant pool for a class or interface: When creating a class or interface, if the construction of the run-time constant pool requires more memory than can be made available in the method area of the Java Virtual Machine, the Java Virtual Machine throws an OutOfMemoryError. See Â§5 (Loading, Linking, and Initializing) for information about the construction of the run-time constant pool. 2.5.6. Native Method StacksAn implementation of the Java Virtual Machine may use conventional stacks, colloquially called â€œC stacks,â€ to support native methods (methods written in a language other than the Java programming language). Native method stacks may also be used by the implementation of an interpreter for the Java Virtual Machineâ€™s instruction set in a language such as C. Java Virtual Machine implementations that cannot load native methods and that do not themselves rely on conventional stacks need not supply native method stacks. If supplied, native method stacks are typically allocated per thread when each thread is created. This specification permits native method stacks either to be of a fixed size or to dynamically expand and contract as required by the computation. If the native method stacks are of a fixed size, the size of each native method stack may be chosen independently when that stack is created. A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of the native method stacks, as well as, in the case of varying-size native method stacks, control over the maximum and minimum method stack sizes. The following exceptional conditions are associated with native method stacks: If the computation in a thread requires a larger native method stack than is permitted, the Java Virtual Machine throws a StackOverflowError. If native method stacks can be dynamically expanded and native method stack expansion is attempted but insufficient memory can be made available, or if insufficient memory can be made available to create the initial native method stack for a new thread, the Java Virtual Machine throws an OutOfMemoryError. 2.6. FramesA frame is used to store data and partial results, as well as to perform dynamic linking, return values for methods, and dispatch exceptions. A new frame is created each time a method is invoked. A frame is destroyed when its method invocation completes, whether that completion is normal or abrupt (it throws an uncaught exception). Frames are allocated from the Java Virtual Machine stack (Â§2.5.2) of the thread creating the frame. Each frame has its own array of local variables (Â§2.6.1), its own operand stack (Â§2.6.2), and a reference to the run-time constant pool (Â§2.5.5) of the class of the current method. A frame may be extended with additional implementation-specific information, such as debugging information. The sizes of the local variable array and the operand stack are determined at compile-time and are supplied along with the code for the method associated with the frame (Â§4.7.3). Thus the size of the frame data structure depends only on the implementation of the Java Virtual Machine, and the memory for these structures can be allocated simultaneously on method invocation. Only one frame, the frame for the executing method, is active at any point in a given thread of control. This frame is referred to as the current frame, and its method is known as the current method. The class in which the current method is defined is the current class. Operations on local variables and the operand stack are typically with reference to the current frame. A frame ceases to be current if its method invokes another method or if its method completes. When a method is invoked, a new frame is created and becomes current when control transfers to the new method. On method return, the current frame passes back the result of its method invocation, if any, to the previous frame. The current frame is then discarded as the previous frame becomes the current one. Note that a frame created by a thread is local to that thread and cannot be referenced by any other thread. 2.6.1. Local VariablesEach frame (Â§2.6) contains an array of variables known as its local variables. The length of the local variable array of a frame is determined at compile-time and supplied in the binary representation of a class or interface along with the code for the method associated with the frame (Â§4.7.3). A single local variable can hold a value of type boolean, byte, char, short, int, float, reference, or returnAddress. A pair of local variables can hold a value of type long or double. Local variables are addressed by indexing. The index of the first local variable is zero. An integer is considered to be an index into the local variable array if and only if that integer is between zero and one less than the size of the local variable array. A value of type long or type double occupies two consecutive local variables. Such a value may only be addressed using the lesser index. For example, a value of type double stored in the local variable array at index n actually occupies the local variables with indices n and n+1; however, the local variable at index n+1 cannot be loaded from. It can be stored into. However, doing so invalidates the contents of local variable n. The Java Virtual Machine does not require n to be even. In intuitive terms, values of types long and double need not be 64-bit aligned in the local variables array. Implementors are free to decide the appropriate way to represent such values using the two local variables reserved for the value. The Java Virtual Machine uses local variables to pass parameters on method invocation. On class method invocation, any parameters are passed in consecutive local variables starting from local variable 0. On instance method invocation, local variable 0 is always used to pass a reference to the object on which the instance method is being invoked (this in the Java programming language). Any parameters are subsequently passed in consecutive local variables starting from local variable 1. 2.6.2. Operand StacksEach frame (Â§2.6) contains a last-in-first-out (LIFO) stack known as its operand stack. The maximum depth of the operand stack of a frame is determined at compile-time and is supplied along with the code for the method associated with the frame (Â§4.7.3). Where it is clear by context, we will sometimes refer to the operand stack of the current frame as simply the operand stack. The operand stack is empty when the frame that contains it is created. The Java Virtual Machine supplies instructions to load constants or values from local variables or fields onto the operand stack. Other Java Virtual Machine instructions take operands from the operand stack, operate on them, and push the result back onto the operand stack. The operand stack is also used to prepare parameters to be passed to methods and to receive method results. For example, the iadd instruction (Â§iadd) adds two int values together. It requires that the int values to be added be the top two values of the operand stack, pushed there by previous instructions. Both of the int values are popped from the operand stack. They are added, and their sum is pushed back onto the operand stack. Subcomputations may be nested on the operand stack, resulting in values that can be used by the encompassing computation. Each entry on the operand stack can hold a value of any Java Virtual Machine type, including a value of type long or type double. Values from the operand stack must be operated upon in ways appropriate to their types. It is not possible, for example, to push two int values and subsequently treat them as a long or to push two float values and subsequently add them with an iadd instruction. A small number of Java Virtual Machine instructions (the dup instructions (Â§dup) and swap (Â§swap)) operate on run-time data areas as raw values without regard to their specific types; these instructions are defined in such a way that they cannot be used to modify or break up individual values. These restrictions on operand stack manipulation are enforced through class file verification (Â§4.10). At any point in time, an operand stack has an associated depth, where a value of type long or double contributes two units to the depth and a value of any other type contributes one unit. 2.6.3. Dynamic LinkingEach frame (Â§2.6) contains a reference to the run-time constant pool (Â§2.5.5) for the type of the current method to support dynamic linking of the method code. The class file code for a method refers to methods to be invoked and variables to be accessed via symbolic references. Dynamic linking translates these symbolic method references into concrete method references, loading classes as necessary to resolve as-yet-undefined symbols, and translates variable accesses into appropriate offsets in storage structures associated with the run-time location of these variables. This late binding of the methods and variables makes changes in other classes that a method uses less likely to break this code. 2.6.4. Normal Method Invocation CompletionA method invocation completes normally if that invocation does not cause an exception (Â§2.10) to be thrown, either directly from the Java Virtual Machine or as a result of executing an explicit throw statement. If the invocation of the current method completes normally, then a value may be returned to the invoking method. This occurs when the invoked method executes one of the return instructions (Â§2.11.8), the choice of which must be appropriate for the type of the value being returned (if any). The current frame (Â§2.6) is used in this case to restore the state of the invoker, including its local variables and operand stack, with the program counter of the invoker appropriately incremented to skip past the method invocation instruction. Execution then continues normally in the invoking methodâ€™s frame with the returned value (if any) pushed onto the operand stack of that frame. 2.6.5. Abrupt Method Invocation CompletionA method invocation completes abruptly if execution of a Java Virtual Machine instruction within the method causes the Java Virtual Machine to throw an exception (Â§2.10), and that exception is not handled within the method. Execution of an athrow instruction (Â§athrow) also causes an exception to be explicitly thrown and, if the exception is not caught by the current method, results in abrupt method invocation completion. A method invocation that completes abruptly never returns a value to its invoker.","link":"/2024/04/19/JMM/"},{"title":"Gradle","text":"Gradle ç”¨æˆ·æŒ‡å—å®˜æ–¹æ–‡æ¡£ä¸­æ–‡ç‰ˆ GradleåŸºç¡€ ç”Ÿå‘½å‘¨æœŸ ç”Ÿå‘½å‘¨æœŸç›‘å¬(HOOK) ProjectGradleçš„æ„å»ºç”±ä¸€ä¸ªæˆ–å¤šä¸ªProjectç»„æˆï¼ˆæ ¹ç›®å½•ä¸‹setting.gradleå†³å®šï¼‰ï¼Œä¸€ä¸ªæ‰“å°Projectæ‰€æœ‰å±æ€§ä¿¡æ¯çš„ç¤ºä¾‹å¦‚ä¸‹: 123456789./gradlew app:propertieså¸¸è§å¦‚ï¼šé¡¹ç›®åç§°: project.nameé¡¹ç›®ç›®å½•: project.projectDiræ„å»ºç›®å½•: project.buildDiræ ¹é¡¹ç›®: project.rootProjectç‰ˆæœ¬: project.versionç»„: project.groupçŠ¶æ€: project.status TaskGradle Plugin ä¸­çš„Taskä¸»è¦æœ‰ä¸‰ç§ï¼š**æ™®é€šTaskã€å¢é‡Taskã€Transform**ã€‚ Taskä¸€èˆ¬ä¼šç»§æ‰¿ DefaultTask æˆ– **IncrementalTask**ï¼Œè€Œ @TaskAction æ³¨è§£çš„æ–¹æ³•ï¼Œå°±æ˜¯æ­¤Taskåšçš„äº‹ã€‚ ç»§æ‰¿ IncrementalTask çš„ç±»ä¸ºå¢é‡Taskï¼Œè¿™ä¸ªå¢é‡æ˜¯ç›¸å¯¹äºå…¨é‡æ¥è¯´çš„ï¼Œå…¨é‡æŒ‡çš„æ˜¯ï¼šè°ƒç”¨å®Œcleanåç¬¬ä¸€æ¬¡ç¼–è¯‘è¿‡ç¨‹ï¼Œä¿®æ”¹ä»£ç æˆ–èµ„æºåå†æ¬¡ç¼–è¯‘ï¼Œå°±æ˜¯å¢é‡ç¼–è¯‘ 123456789101112131415161718public abstract class IncrementalTask extends BaseTask { // æ˜¯å¦éœ€è¦å¢é‡ï¼Œé»˜è®¤false @Internal protected boolean isIncremental() { } // éœ€è¦å­ç±»å®ç°ï¼Œå…¨é‡æ—¶æ‰§è¡Œçš„ä»»åŠ¡ protected abstract void doFullTaskAction() throws Exception; // å¢é‡æ—¶æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé»˜è®¤ä»€ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œå‚æ•°æ˜¯å¢é‡æ—¶ä¿®æ”¹è¿‡çš„æ–‡ä»¶ protected void doIncrementalTaskAction(Map&lt;File, FileStatus&gt; changedInputs) throws Exception{ } @TaskAction void taskAction(IncrementalTaskInputs inputs) throws Exception { // åˆ¤æ–­æ˜¯å¦æ˜¯å¢é‡ï¼Œæ˜¯æ‰§è¡ŒdoIncrementalTaskActionï¼Œå¦åˆ™æ‰§è¡ŒdoFullTaskAction ï½ // è·å–ä¿®æ”¹æ–‡ä»¶ private Map&lt;File, FileStatus&gt; getChangedInputs(IncrementalTaskInputs inputs) { }} è‡³äº Transformï¼ˆå˜æ¢ï¼‰ï¼Œæ˜¯Androidå®˜æ–¹æä¾›ç»™å¼€å‘è€…ï¼Œåœ¨.class â†’ .dexè½¬æ¢æœŸé—´ç”¨æ¥ä¿®æ”¹.classæ–‡ä»¶çš„ä¸€å¥—APIï¼Œç•™æ„ transform() æ–¹æ³•çš„å®ç°å°±å¥½ã€‚ Gradle Plugin Version or Gradle VesionGladleæ’ä»¶ç‰ˆæœ¬(AGP) build.gradleæ–‡ä»¶ classpathâ€™com.android.tools.build:gradle:3.0.0â€™ æŒ‡å®šï¼Œæ˜¯ASç”¨æ¥å¼•å…¥gladleç‰¹æ€§çš„æ’ä»¶ Gladleç‰ˆæœ¬(Gradle)ï¼š gradle/wrapper/gradle-wrapper.propertiesæ–‡ä»¶ä¸­ distributionUrl=https://services.gradle.org/distributions/gradle-x.x.x.zip æŒ‡å®šï¼Œä¹Ÿå³ä½¿gradleæœ¬ä½“çš„ç‰ˆæœ¬ ç®€è¿°ï¼šè¿™å¾ˆå¥½ç†è§£ï¼Œgradle-wrapper.propertiesé…ç½®åä¼šä¸‹è½½è¯¥ç‰ˆæœ¬Gradleæœ¬ä½“åˆ°/gradleç›®å½•ä¸‹ï¼Œè¿™å°±æ˜¯gradleæœ¬ä½“ç›®å½•äº† AGPå’Œgradleçš„ç‰ˆæœ¬å¯¹åº”å…³ç³»ï¼š æ’ä»¶ç‰ˆæœ¬ æ‰€éœ€çš„ Gradle ç‰ˆæœ¬ 7.3 7.4 7.2 7.3.3 7.1 7.2 7.0 7.0 4.2.0+ 6.7.1 4.1.0+ 6.5+ 4.0.0+ 6.1.1+ 3.6.0 - 3.6.4 5.6.4+ 3.5.0 - 3.5.4 5.4.1+ lower version lower version Android Studioç‰ˆæœ¬(AS) Dependencies Tree CheckdependenciesTask :app:dependenciesç”¨äºè¾“å‡ºé¡¹ç›®ä¾èµ–é¡¹çš„æ ‘çŠ¶ç»“æ„ å¦‚æœ dependencies ä¿¡æ¯å¤ªå¤šï¼Œå¯ä»¥ä¿å­˜åˆ°æ–‡ä»¶ï¼š./gradlew :app:dependencies --configuration releaseRuntimeClassPath &gt; dependencies.txtï¼Œè¿™æ ·æ›´æ–¹ä¾¿æœç´¢å’ŒæŸ¥çœ‹ã€‚é¡¹ç›®ä¾èµ–é¡¹ä¿¡æ¯éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥ç”¨æ¥æ’æŸ¥ä¾èµ–å†²çªã€åˆ†æåº“ä¾èµ–å…³ç³»ç­‰ã€‚ å…¨éƒ¨ä¾èµ–: gradlew app:dependencies releaseä¾èµ–: gradlew app:dependencies â€“configuration releaseRuntimeClasspath ./gradlew app:dependencies --configuration debugRuntimeClasspath 123456--configuration åå‚æ•°æ­£å¼ç¯å¢ƒä¾èµ–ï¼š releaseRuntimeClasspathdebugä¾èµ–: debugRuntimeClasspathç¼–è¯‘ä¾èµ–ï¼š compile åé¢å¸¦æœ‰ â€œ(*)â€ çš„åº“å°±è¡¨ç¤º è¿™ä¸ªåº“æœ‰è¢«è¦†ç›–è¿‡ï¼ˆæœ€é«˜çš„ç‰ˆæœ¬è¦†ç›–ï¼‰ã€‚ 1234567androidx.annotation:annotation:1.1.0 -&gt; 1.3.0org.jetbrains.kotlin:kotlin-stdlib:1.5.31 -&gt; 1.7.10 (*)org.jetbrains.kotlin:kotlin-stdlib:1.7.10 (*)androidx.test:core:{strictly 1.4.0} -&gt; 1.4.0 (c) -&gt;ï¼šè¡¨ç¤ºå†²çªï¼Œæ¯”å¦‚è¿™ä¸ª1.1.0 -&gt; 1.3.0ï¼Œ-&gt; åé¢çš„ç‰ˆæœ¬è¡¨ç¤ºGradleå†³è®®ä¹‹åçš„ç‰ˆæœ¬ï¼Œè¿™é‡Œè¡¨ç¤º1.1.0ç‰ˆæœ¬è¢«æ‹‰é«˜åˆ°1.3.0ï¼› *ï¼š*å…¶å®æ˜¯çœç•¥çš„æ„æ€ï¼Œå±‚çº§å¤ªæ·±ï¼ŒGradleå°±çœç•¥äº†ä¸€éƒ¨åˆ†ï¼Œè€Œè¶Šæ·±çš„ä¿¡æ¯ä¹Ÿä¸å¤ªé‡è¦ï¼Œå°±æ˜¾çš„å†—ä½™ï¼Œå¾€å¾€é‡è¦çš„ä¿¡æ¯éƒ½åœ¨å‰å‡ å±‚ï¼› cï¼šcæ˜¯constraintsçš„ç®€ç§°ï¼Œä¸»è¦æ˜¯ç”¨æ¥ä¿è¯å½“å‰ä¾èµ–é¡¹æ‰€éœ€è¦çš„ä¾èµ–çš„ç‰ˆæœ¬çš„ä¸€è‡´æ€§ï¼Œç™½è¯è®²å°±æ˜¯ä¸ºäº†é˜²æ­¢å…¶ä»–ä¾èµ–é¡¹æŠŠæˆ‘éœ€è¦çš„ä¾èµ–ç»™æ‹‰é«˜è€Œå¯¼è‡´æˆ‘è‡ªå·±ä¸å¯ç”¨çš„æƒ…å†µã€‚ strictlyï¼šstrictlyè·Ÿforceä¸€æ ·è¡¨ç¤ºå¼ºåˆ¶ä½¿ç”¨è¯¥ç‰ˆæœ¬ï¼ŒåŒºåˆ«åœ¨äºstrictlyå¯ä»¥åœ¨ä¾èµ–æ ‘é‡Œæ ‡ç¤ºå‡ºæ¥ï¼Œè€Œforceåˆ™æ²¡æœ‰ä»»ä½•æ ‡ç¤ºï¼Œæ‰€ä»¥forceåœ¨é«˜ç‰ˆæœ¬é‡Œä¹Ÿè¢«åºŸå¼ƒäº†ã€‚ dependencyInsightTask :app:dependencyInsight ç”¨äºè¾“å‡ºé¡¹ç›®ä¸­ç‰¹å®šä¾èµ–é¡¹çš„è¯¦ç»†ä¿¡æ¯ ä½¿ç”¨è¿™ä¸ª task çš„æ–¹å¼æ˜¯ï¼š./gradlew :app:dependencyInsight --configuration someConf --dependency someDepï¼Œå¿…é¡»æœ‰ â€“configuration å’Œ â€“dependency é€‰é¡¹ã€‚å¯¹äº â€“configuration é€‰é¡¹å‚æ•°ï¼Œå¯ä»¥é€šè¿‡ä¸Šé¢çš„Task :app:androidDependencies æŸ¥çœ‹ã€‚ 1./gradlew module-detail:dependencyInsight --dependency component-media --configuration releaseRuntimeClasspath How Gradle depend onæœ¬åœ°åº“æ¨¡å—ä¾èµ–é¡¹module implementation project(â€˜:mylibraryâ€™) è¿™å£°æ˜äº†å¯¹ä¸€ä¸ªåä¸ºâ€œmylibraryâ€ï¼ˆæ­¤åç§°å¿…é¡»ä¸åœ¨æ‚¨çš„ settings.gradle æ–‡ä»¶ä¸­ä½¿ç”¨ include: å®šä¹‰çš„åº“åç§°ç›¸ç¬¦ï¼‰çš„ Android åº“æ¨¡å—çš„ä¾èµ–å…³ç³»ã€‚åœ¨æ„å»ºæ‚¨çš„åº”ç”¨æ—¶ï¼Œæ„å»ºç³»ç»Ÿä¼šç¼–è¯‘è¯¥åº“æ¨¡å—ï¼Œå¹¶å°†ç”Ÿæˆçš„ç¼–è¯‘å†…å®¹æ‰“åŒ…åˆ° APK ä¸­ã€‚ æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–é¡¹jar java ARchive .classæ–‡ä»¶+MENIFEST.MFæ–‡ä»¶ implementation fileTree(dir: â€˜libsâ€™, include: [â€˜*.jarâ€™]) Gradle å£°æ˜äº†å¯¹é¡¹ç›®çš„ module_name/libs/ ç›®å½•ä¸­ JAR æ–‡ä»¶çš„ä¾èµ–å…³ç³»ï¼ˆå› ä¸º Gradle ä¼šè¯»å– build.gradle æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„ï¼‰ã€‚ æˆ–è€…ï¼Œæ‚¨ä¹Ÿå¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼æŒ‡å®šå„ä¸ªæ–‡ä»¶ï¼š implementation files(â€˜libs/foo.jarâ€™, â€˜libs/bar.jarâ€™) è¿œç¨‹äºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–é¡¹aar = jar + AndroidManifestã€resã€Rã€public.txtå’Œå¯èƒ½å…¶ä»– implementation â€˜com.example.android:app-magic:12.3â€™ è¿™å®é™…ä¸Šæ˜¯ä»¥ä¸‹ä»£ç çš„ç®€å†™å½¢å¼ï¼š implementation group: â€˜com.example.androidâ€™, name: â€˜app-magicâ€™, version: â€˜12.3â€™ è¿™å£°æ˜äº†å¯¹â€œcom.example.androidâ€å‘½åç©ºé—´ç»„å†…çš„ 12.3 ç‰ˆâ€œapp-magicâ€åº“çš„ä¾èµ–å…³ç³»ã€‚ æ–‡ä»¶æ ¼å¼.aarå®é™…ä¸Š.arrä¸­å¯èƒ½åªæœ‰.jar å’Œ AndroidManifest.xml Mavenä¾èµ–1234567891011 allprojects { repositories { google() //Google Maven repository jcenter() //Bintrayâ€™s JCenter Maven repository å·²ä¸ç»´æŠ¤ mavenCentral() //central Maven repository maven { url &quot;https://maven.aliyun.com/repository/google&quot; } //Googleé˜¿é‡Œé•œåƒ maven { url &quot;https://maven.aliyun.com/repository/jcenter&quot; } //JCenteré˜¿é‡Œé•œåƒ mavenLocal() // }} Google çš„ Maven ä»£ç åº“ä¸­æä¾›äº†ä»¥ä¸‹ Android åº“çš„æœ€æ–°ç‰ˆæœ¬ï¼š Android æ”¯æŒåº“æ¶æ„ç»„ä»¶åº“çº¦æŸå¸ƒå±€åº“AndroidX æµ‹è¯•æ•°æ®ç»‘å®šåº“Android å…å®‰è£…åº”ç”¨åº“Wear OSGoogle Play æœåŠ¡Google Play ç»“ç®—åº“Firebase è¡¥å……é“¾æ¥https://juejin.cn/post/6950643579643494431 Gradleå¸¸ç”¨å‘½ä»¤12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879# å‘½ä»¤ç»“æ„gradle [taskName...] [--option-name...]# å¢é‡ç¼–è¯‘ï¼šåŒä¸€ä¸ªé¡¹ç›®ä¸­, åŒä¸€ä¸ª taské™¤éæœ‰å¿…è¦, å¦åˆ™ä¸ä¼šè¢«æ— æ„ä¹‰çš„æ‰§è¡Œå¤šæ¬¡ï¼›# ç¼“å­˜ï¼šæ— è®ºæ˜¯å¦åœ¨åŒä¸€ä¸ªé¡¹ç›®ï¼Œåªè¦Taskè¾“å…¥æ²¡å˜å°±å¤ç”¨ç¼“å­˜ç»“æœï¼Œä¸å¿…çœŸçš„æ‰§è¡Œtaskï¼›# Tasksæ‰§è¡Œgradle myTask # æ‰§è¡ŒæŸä¸ªTaskgradle :my-subproject:taskName # æ‰§è¡Œå­é¡¹ç›®ä¸­çš„Taskgradle my-subproject:taskName # åŒä¸Šï¼Œä¸æŒ‡å®šå­é¡¹ç›®ï¼Œä¼šæ‰§è¡Œæ‰€æœ‰å­é¡¹ç›®çš„æ­¤Taskï¼Œå¦‚gradle cleanï¼›gradle task1 task2 # è¿è¡Œå¤šä¸ªTaskgradle dist --exclude-task test # å°†æŸä¸ªtaskæ’é™¤åœ¨æ‰§è¡Œå¤–gradle dist -x test # åŒä¸Šgradle test --rerun-tasks # å¼ºåˆ¶æ‰§è¡ŒUP-TO-DATEçš„Taskï¼Œå³ä¸èµ°å¢é‡ç¼–è¯‘ï¼Œæ‰§è¡Œå…¨é‡ç¼–è¯‘ï¼›gradle test --continue # é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€æ—¦Taskå¤±è´¥å°±ä¼šæ„å»ºå¤±è´¥ï¼Œé€šè¿‡æ­¤å‚æ•°å¯ç»§ç»­æ‰§è¡Œï¼›# å¸¸è§ä»»åŠ¡(å’Œæ’ä»¶é—´çš„Taskçº¦å®š)gradle buildgradle rungradle checkgradle clean # åˆ é™¤æ„å»ºç›®å½•# æ„å»ºç»†èŠ‚gradle projects # åˆ—å‡ºæ‰€æœ‰å­é¡¹ç›®gradle tasks # åˆ—å‡ºæ‰€æœ‰Task(åˆ†é…ç»™ä»»åŠ¡ç»„çš„Task)gradle tasks --group=&quot;build setup&quot; # åˆ—å‡ºç‰¹å®šä»»åŠ¡ç»„çš„Taskgradle tasks --all # åˆ—å‡ºæ‰€æœ‰Taskgradle -q help --task libs # æŸ¥çœ‹æŸä¸ªTaskçš„è¯¦ç»†ä¿¡æ¯gradle myTask --scan # ç”Ÿæˆå¯è§†åŒ–çš„ç¼–è¯‘æŠ¥å‘Šgradle dependencies # åˆ—å‡ºé¡¹ç›®ä¾èµ–gradle -q project:properties # åˆ—å‡ºé¡¹ç›®å±æ€§åˆ—è¡¨# è°ƒè¯•é€‰é¡¹-?ï¼Œ-hï¼Œ--help # å¸®åŠ©ä¿¡æ¯-vï¼Œ--version # ç‰ˆæœ¬ä¿¡æ¯-s, --stacktrace # æ‰“å°å‡ºå¼‚å¸¸å †æ ˆè·Ÿè¸ªä¿¡æ¯ï¼›-S, --full-stacktrace # æ¯”ä¸Šé¢æ›´å®Œæ•´çš„ä¿¡æ¯ï¼›# æ€§èƒ½ç›¸å…³--build-cache # å¤ç”¨ç¼“å­˜--no-build-cache # ä¸å¤ç”¨ç¼“å­˜ï¼Œé»˜è®¤--max-workers # æœ€å¤§å¤„ç†å™¨æ•°é‡--parallel # å¹¶è¡Œç”Ÿæˆé¡¹ç›®--no-parallel # ä¸å¹¶è¡Œç”Ÿæˆé¡¹ç›®--priority # Gradleå¯åŠ¨çš„è¿›ç¨‹ä¼˜å…ˆçº§--profile # ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š# å®ˆæŠ¤è¿›ç¨‹--daemon # ä½¿ç”¨deamonè¿›ç¨‹æ„å»º--no-daemon # ä¸ä½¿ç”¨deamonè¿›ç¨‹æ„å»º--foreground # å‰å°è¿›ç¨‹å¯åŠ¨deamonè¿›ç¨‹--status # æŸ¥çœ‹è¿è¡Œä¸­å’Œæœ€è¿‘åœæ­¢çš„deamonè¿›ç¨‹ï¼›--stop # åœæ­¢æ‰€æœ‰åŒä¸€ç‰ˆæœ¬çš„deamonè¿›ç¨‹ï¼›# æ—¥å¿—é€‰é¡¹-q, --quiet # åªè®°å½•é”™è¯¯-w, --warn-i, --info -d, --debug--console=(auto,plain,rich,verbose) # æŒ‡å®šè¾“å‡ºç±»å‹--warning-mode=(all,fail,none,summary) # æŒ‡å®šè­¦å‘Šçº§åˆ«# æ‰§è¡Œé€‰é¡¹--include-build # å¤åˆæ„å»º--offline # ç¦»çº¿æ„å»º--refresh-dependencies # å¼ºåˆ¶æ¸…é™¤ä¾èµ–ç¼“å­˜--dry-run # åœ¨ä¸å®é™…æ‰§è¡ŒTaskçš„æƒ…å†µä¸‹çœ‹Taskæ‰§è¡Œé¡ºåº--no-rebuild # ä¸é‡å¤æ„å»ºé¡¹ç›®ä¾èµ–# ç¯å¢ƒé€‰é¡¹-b, --build-file # æŒ‡å®šæ„å»ºæ–‡ä»¶-c, --settings-file # æŒ‡å®šè®¾ç½®æ–‡ä»¶-g, --gradle-user-home # æŒ‡å®šé»˜è®¤.Gradleç›®å½•-p, --project-dir # æŒ‡å®šGradleçš„å¼€å§‹ç›®å½•--project-cache-dir # æŒ‡å®šç¼“å­˜ç›®å½•ï¼Œé»˜è®¤.gradle-D, --system-prop # è®¾ç½®JVMç³»ç»Ÿå±æ€§-I, --init-script # æŒ‡å®šåˆå§‹åŒ–è„šæœ¬-P, --project-prop # æŒ‡å®šæ ¹é¡¹ç›®çš„é¡¹ç›®å±æ€§ï¼› //gradle build å‘½ä»¤åŒ…å«äº† gradle assemble ï¼Œ å¯é€šè¿‡ gradle build â€“dry-runæŸ¥çœ‹","link":"/2021/04/02/Gradle/"},{"title":"JsBridage","text":"Jsä¸åŸç”Ÿäº¤äº’çš„æ–¹å¼ï¼šé€šè¿‡æ³¨å…¥å¯¹è±¡æˆ–æ‹¦æˆª URL SCHEMEå®ç°JSBridge åŸç”Ÿè°ƒç”¨JSï¼ˆwebView.loadUrlï¼‰ Jsè°ƒç”¨åŸç”Ÿ1. æ³¨å…¥å¯¹è±¡(webView.addJavaScriptInterface)â€‹ Android4.2å‰addJavascriptInterfaceæ¥å£å­˜åœ¨æ³¨å…¥æ¼æ´ï¼Œå³JSå¯ä»¥é€šè¿‡åå°„è·å–åˆ°nativeç«¯çš„å…¶ä»–æ¥å£ï¼Œè¿›è¡Œå…¶ä»–éæ³•æ“ä½œï¼Œæ‰€ä»¥4.2ä¹‹åå‡çº§å¢åŠ äº†JSåªèƒ½è®¿é—®å¸¦æœ‰ @JavascriptInterfaceæ³¨è§£çš„Javaå‡½æ•°çš„é™åˆ¶ã€‚ 2. æ‹¦æˆª URL SCHEME(è¦†ç›–shouldOverrideUrlLoading)â€‹ æ›´å¥½çš„å…¼å®¹æ€§ï¼Œåˆ›å»ºè¯·æ±‚ï¼Œéœ€è¦ä¸€å®šçš„è€—æ—¶","link":"/2021/04/10/JsBridage/"},{"title":"Kotlin","text":"kotlin data classdata classä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹æ–¹æ³•ï¼š equals() hashCode() 12345public int hashCode() { int var10000 = Integer.hashCode(this.age) * 31; String var10001 = this.name; return var10000 + (var10001 != null ? var10001.hashCode() : 0);} toString() copy() componentN() ç¼–è¯‘å™¨ä¼šä¸ºæ•°æ®ç±»ç”Ÿæˆ ç»„ä»¶å‡½æ•°(Component function), æœ‰äº†è¿™äº›ç»„ä»¶å‡½æ•°, å°±å¯ä»¥åœ¨ è§£æ„å£°æ˜(destructuring declaration) ä¸­ä½¿ç”¨æ•°æ®ç±»: 1234val jane = User(&quot;Jane&quot;, 35)val (name, age) = janeprintln(&quot;$name, $age years of age&quot;) // è¾“å‡ºç»“æœä¸º Jane, 35 years of age å±æ€§çš„get()/set() valçš„å±æ€§ä¸ä¼šæœ‰setter constructor() åªæœ‰æœ‰å‚æ„é€ å‡½æ•°ï¼Œæ²¡æœ‰æ— å‚æ„é€ å‡½æ•°ã€‚fastJsonè§£æä¼šæŠ›è¯¥å¼‚å¸¸ï¼Œéœ€å‡çº§åˆ°é«˜ç‰ˆæœ¬å¹¶å¼•å…¥kotlin-reflectä¾èµ– Kotlin Objectç±»å…¶å­—èŠ‚ç å®ç°æ˜¯ï¼šæä¾›ä¸€ä¸ªç±»ï¼Œä¼šåœ¨staticæ–¹æ³•å—ä¸­å®ä¾‹åŒ–çš„è¯¥ç±»çš„static final å¯¹è±¡ã€‚ æ˜¯é¥¿æ±‰æ¨¡å¼çš„ï¼Œé€šè¿‡JVMç±»åŠ è½½æœºåˆ¶ç¡®ä¿çº¿ç¨‹å®‰å…¨çš„ Kotlinç©ºå®‰å…¨Kotlinç©ºå®‰å…¨åŸç†:Stringã€String?é¦–å…ˆé€šè¿‡æ³¨è§£ @Lorg/jetbrains/annotations/NotNull;å’Œ@Lorg/jetbrains/annotations/Nullable;æ¥å‘ç¼–è¯‘å™¨æ ‡ç¤ºå‚æ•°æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™é€šè¿‡ INVOKESTATIC kotlin/jvm/internal/Intrinsics.checkParameterIsNotNull (Ljava/lang/Object;Ljava/lang/String;)æ¥è¿›è¡Œæ£€æŸ¥ï¼Œæ­¤æ—¶å¦‚æœæˆ‘ä»¬ç»™ä¸ªç©ºå€¼åˆ™ç¼–è¯‘å™¨å‡ºç°æŠ¥é”™æç¤ºã€‚ ?.ï¼ˆelvisçŒ«ç‹è¡¨è¾¾å¼ï¼‰å¯¹ç”¨ä½¿ç”¨ ?. æ“ä½œç¬¦å·kotlinä¼šåˆ¤æ–­æ˜¯å¦ä¸ºnull å¦‚æœä¸ä¸ºnullæ‰§è¡Œå¯¹åº”çš„é€»è¾‘ï¼Œå¦‚æœä¸ºnullåˆ™ä»€ä¹ˆä¹Ÿä¸æ‰§è¡Œï¼ˆæ­¤æ—¶çš„é»˜è®¤ç»“æœä¹Ÿæ˜¯nullï¼‰ !!.å¯¹ç”¨ä½¿ç”¨ !! æ“ä½œç¬¦å· Kotlin åŒæ ·ä¼šæ‰§è¡Œnullåˆ¤æ–­å¦‚æœä¸ä¸ºnull åˆ™æ‰§è¡Œå¯¹åº”çš„é€»è¾‘ï¼Œå¦‚æœä¸ºnull åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå³æ‰§è¡Œ INVOKESTATIC kotlin/jvm/internal/Intrinsics.throwNpe () kotlin æ³›å‹Kotlin æ³›å‹ç³»ç»Ÿç»§æ‰¿äº Javaæ³›å‹ï¼Œä¾ç„¶æ˜¯ä¸€ç§è¯­æ³•ç³–çš„ä¼ªæ³›å‹ï¼Œä¼šåœ¨ç¼–è¯‘æ—¶å‘ç”Ÿç±»å‹æ“¦é™¤ã€‚ä½†å¦‚æœæ˜¯å†…è”å‡½æ•°+reifiedæ—¶ï¼Œæ˜¯å­—èŠ‚ç ä¸­ä¿ç•™ç±»å‹çš„çœŸæ³›å‹ Kotliné«˜é˜¶å‡½æ•°Kotlinä¸­çš„é«˜é˜¶å‡½æ•°é€šè¿‡ä½äºkotlin.jvm.functionsä¸‹çš„å‡½æ•°æ¥å£ï¼ˆSAMï¼‰æ¥è¡¨ç¤ºï¼Œåœ¨ç¼–è¯‘æ—¶å°†å‡½æ•°ç±»å‹è½¬æ¢ä¸ºè¿™äº›æ¥å£çš„å®ç°ã€‚ç¼–è¯‘å™¨ç”Ÿæˆç›¸åº”çš„å­—èŠ‚ç æ¥å¤„ç†é«˜é˜¶å‡½æ•°è°ƒç”¨ã€‚ï¼ˆç”±äºéƒ½æ˜¯é¢„å…ˆå†™å¥½çš„å‡½æ•°æ¥å£ï¼Œæ‰€ä»¥å…¶å®é«˜é˜¶å‡½æ•°æœ€å¤§æ”¯æŒçš„å‚æ•°æ•°é‡æ˜¯æœ‰é™çš„ï¼Œç°ä¸º22ä¸ªï¼‰ 12345/** A function that takes 22 arguments. */public interface Function22&lt;in P1, in P2, in P3, in P4, in P5, in P6, in P7, in P8, in P9, in P10, in P11, in P12, in P13, in P14, in P15, in P16, in P17, in P18, in P19, in P20, in P21, in P22, out R&gt; : Function&lt;R&gt; { /** Invokes the function with the specified arguments. */ public operator fun invoke(p1: P1, p2: P2, p3: P3, p4: P4, p5: P5, p6: P6, p7: P7, p8: P8, p9: P9, p10: P10, p11: P11, p12: P12, p13: P13, p14: P14, p15: P15, p16: P16, p17: P17, p18: P18, p19: P19, p20: P20, p21: P21, p22: P22): R} ä¾‹å¦‚ï¼Œä»¥ä¸‹é«˜é˜¶å‡½æ•°ï¼š 123fun doSomeThing(x: Int, predicate: (Int) -&gt; String): String { return predicate(x)} å½“ç¼–è¯‘è¿™ä¸ªå‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆç±»ä¼¼å¦‚ä¸‹çš„å­—èŠ‚ç ï¼ˆä¼ªä»£ç ï¼Œç”¨äºè¯´æ˜ï¼‰ï¼š 1234567public final class ExperimentalFiled3 { @NotNull public final String doSomeThing(int x, @NotNull kotlin.jvm.functions.Function1 predicate) { Intrinsics.checkNotNullParameter(predicate, &quot;predicate&quot;); return (String)predicate.invoke(x); }} åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£ç§°ä¸ºå‡½æ•°å¼æ¥å£æˆ– å•ä¸€æŠ½è±¡æ–¹æ³•ï¼ˆSAMï¼‰æ¥å£ Kotliné—­åŒ…Lambdaè¡¨è¾¾å¼å’ŒåŒ¿åå‡½æ•°åœ¨Kotlinä¸­éƒ½æ˜¯é—­åŒ…ï¼Œæ„å‘³ç€å®ƒä»¬å¯ä»¥æ•è·å¹¶æŒæœ‰å…¶å®šä¹‰ä½œç”¨åŸŸå†…çš„å˜é‡ã€‚ å‡½æ•°å’Œå¯¹å…¶å‘¨å›´çŠ¶æ€ï¼ˆlexical environmentï¼Œè¯æ³•ç¯å¢ƒï¼‰çš„å¼•ç”¨æ†ç»‘åœ¨ä¸€èµ·æ„æˆé—­åŒ…ã€‚ å…¶ä¸­åŒ…æ‹¬ä¸¤ä¸ªè¦ç‚¹ï¼š å‡½æ•° å‘¨å›´ç¯å¢ƒï¼ˆ&amp;çŠ¶æ€&amp;ä¸Šä¸‹æ–‡ï¼‰æ¯”å¦‚åœ¨aå‡½æ•°é‡Œå®šä¹‰äº†båŒ¿åå‡½æ•°å’Œå˜é‡xï¼Œbèƒ½å¼•ç”¨åˆ°açš„å˜é‡xï¼Œå°±å«é—­åŒ… è¿™ä¸¤è€…çš„å®ç°åŸç†ç±»ä¼¼çš„ï¼Œé€šè¿‡ç¼–è¯‘å™¨ç”Ÿæˆå¯¹åº”çš„ ç»§æ‰¿äºkotlin.jvm.internal.Lambdaå¹¶ä¸”å®ç°kotlin.jvm.functionsä¸‹å‡½æ•°æ¥å£çš„ç±»ï¼Œå°†è¡¨è¾¾å¼æˆ–åŒ¿åå‡½æ•°ç±»æ–¹æ³•ä½“ä»£ç å¡å…¥è¯¥ç±»çš„invokeæ–¹æ³•ä¸­ï¼Œå¹¶åœ¨è¢«è°ƒç”¨å¤„ç”Ÿæˆè¯¥ç±»çš„å®ä¾‹ æ¯”å¦‚ 1val sum = { a: Int, b: Int -&gt; a + b } ç¼–è¯‘å™¨ä¼šç”Ÿæˆç±»ä¼¼å¦‚ä¸‹çš„å­—èŠ‚ç ï¼ˆä¼ªä»£ç ï¼Œç”¨äºè¯´æ˜ï¼‰ï¼š 123456789101112public final class SumLambda extends Lambda implements Function2&lt;Integer, Integer, Integer&gt; { public static final SumLambda INSTANCE = new SumLambda(); private SumLambda() { super(2); } @Override public Integer invoke(Integer a, Integer b) { return a + b; }} ä½¿ç”¨æ—¶ï¼š 1val sum = SumLambda.INSTANCE Lambdaè¡¨è¾¾å¼å’ŒåŒ¿åå‡½æ•°çš„åŒºåˆ«ä¸»è¦è¿˜æ˜¯åœ¨äºè¯­æ³•çš„ä¸åŒã€è¿”å›ç±»å‹æ˜¯å¦éœ€è¦æ˜¾ç¤ºå£°æ˜ã€éå±€éƒ¨è¿”å›ä¸Šã€‚ Kotlin ç±»ã€æ–¹æ³•ä¸ºä»€ä¹ˆé»˜è®¤finalä¸ºäº†è®©ç¨‹åºç¼–å†™è€…æ…ç”¨ç»§æ‰¿ï¼Œä»…å½“éœ€è¦è¢«ç»§æ‰¿æ—¶æ‰æ‰‹åŠ¨ä½¿ç”¨openå…³é”®å­—ä¿®é¥°éœ€è¦è¢«é›†æˆçš„ç±»æˆ–æ–¹æ³•ã€‚è¿™æ ·å¯ä»¥å¢åŠ å¯¹â€œé™ä½è€¦åˆæ€§ã€æé«˜çµæ´»æ€§â€çš„è€ƒè™‘ kotlin åµŒå¥—ç±»&amp;å†…éƒ¨ç±»javaï¼š åªåˆ†ä¸º é™æ€å†…éƒ¨ç±» å’Œ éé™æ€å†…éƒ¨ç±»ï¼Œ åªè¦æ˜¯éé™æ€å†…éƒ¨ç±»éƒ½ä¼šå›ºå®šæŒæœ‰å¤–éƒ¨ç±»çš„å¯¹è±¡ï¼Œåªè¦æ˜¯é™æ€å†…éƒ¨ç±»éƒ½æ˜¯ä¸æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨çš„ kotlinï¼š åˆ†ä¸º å†…éƒ¨ç±» inner ä¿®é¥°çš„å†…éƒ¨ç±»ï¼ˆç±»æˆå‘˜ï¼‰ï¼Œ ç›¸å½“äº javaéé™æ€å†…éƒ¨ç±»ï¼Œå›ºå®šæŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨çš„ï¼ˆæœ¬è´¨ä¸Šæ˜¯ç”Ÿæˆå¤–éƒ¨ç±»å¼•ç”¨çš„æ„é€ å‚æ•°ï¼‰ åµŒå¥—ç±» éinnerä¿®é¥°çš„æˆå‘˜ç±»ï¼Œ ç›¸å½“äº javaé™æ€å†…éƒ¨ç±»ï¼Œä¸æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨çš„ 3.1 åŒ¿åå†…éƒ¨ç±»ï¼ˆå¸¸è§ï¼‰ ä½¿ç”¨å¯¹è±¡è¡¨è¾¾å¼åˆ›å»ºçš„ç±»ï¼ˆobject: Interface{ }ï¼‰ï¼Œå¯ä»¥è®¿é—®åˆ°å¤–éƒ¨ç±»æˆå‘˜ï¼Œä½†é»˜è®¤ä¸æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨ï¼Œåªæœ‰ä¸»åŠ¨æŒæœ‰å¤–éƒ¨å˜é‡æ˜¯æ‰ä¼šå°†è¯¥å¤–éƒ¨ç±»å¯¹è±¡ï¼ˆå¦‚Activityå¯¹è±¡ï¼‰ä½œä¸ºæ„é€ å‚æ•°ï¼ˆè§å­—èŠ‚ç ï¼‰å¼•å…¥ 3.2 æ–¹æ³•å†…åµŒå¥—ç±» åœ¨æ–¹æ³•å†…å®šä¹‰çš„éinnerä¿®é¥°çš„ç±»ï¼Œå¯ä»¥è®¿é—®åˆ°å¤–éƒ¨ç±»æˆå‘˜ï¼Œä½†é»˜è®¤ä¸æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨ï¼Œåªæœ‰ä¸»åŠ¨æŒæœ‰å¤–éƒ¨å˜é‡æ˜¯æ‰ä¼šå°†è¯¥å¤–éƒ¨ç±»å¯¹è±¡ï¼ˆå¦‚Activityå¯¹è±¡ï¼‰ä½œä¸ºæ„é€ å‚æ•°ï¼ˆè§å­—èŠ‚ç ï¼‰å¼•å…¥ Kotlinæ³¨è§£Kotlinä»£ç å¯ä»¥ç»è¿‡ç¼–è¯‘å™¨è½¬æ¢æˆVMè™šæ‹Ÿæœºèƒ½è¯†åˆ«çš„å­—èŠ‚ç ï¼Œæ‰€ä»¥Javaä¸Kotlinå¯ä»¥äº’ç›¸è¿›è¡Œè°ƒç”¨ã€‚è€Œç”±äºJavaä¸Kotlinè¯­è¨€ç‰¹æ€§çš„å·®å¼‚ï¼Œå½“Javaè°ƒç”¨Kotlinä»£ç æ—¶ï¼Œå¯ä»¥åœ¨Kotlinä»£ç ä¸­é€‚å½“å¢åŠ ä¸€äº›æ³¨è§£ï¼Œä»è€Œæ›´æ–¹ä¾¿çš„è°ƒç”¨Kotlinä»£ç ã€‚ @JvmOverloadsåœ¨Kotlinçš„æ–¹æ³•é‡Œæœ‰å¤šä¸ªé»˜è®¤å‚æ•°æ—¶ï¼Œå¦‚æœåœ¨Javaä¸­ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½è°ƒç”¨ä¸€ä¸ªåŒ…å«å®Œæ•´å‚æ•°çš„æ–¹æ³•ï¼Œå¦‚æœæƒ³æš´éœ²æ›´å¤šçš„é‡è½½å‡½æ•°ç»™Javaï¼Œå¯ä»¥ä½¿ç”¨@JvmOverloads ç”¨äºç”Ÿæˆé‡è½½ã€‚å¯¹äºæ¯ä¸€ä¸ªæœ‰é»˜è®¤å€¼çš„å‚æ•°ï¼Œç”Ÿæˆçš„é‡è½½ä¼šæŠŠå½“å‰æœ‰é»˜è®¤å€¼çš„å‚æ•°åŠå…¶å³è¾¹çš„å‚æ•°éƒ½å»æ‰ï¼Œæ‰€ä»¥å¦‚æœæ–¹æ³•ä¸­æ‰€æœ‰çš„å‚æ•°éƒ½æœ‰é»˜è®¤å€¼ï¼Œç”Ÿæˆçš„é‡è½½å‡½æ•°ä¸­è¿˜ä¼šæœ‰ä¸€ä¸ªæ— å‚çš„é‡è½½å‡½æ•°ã€‚ @JvmOverloads ä¸»è¦ç”¨äºæ„é€ å‡½æ•°ã€æ–¹æ³•ä¸­ï¼ŒåŒæ—¶ä¸èƒ½ç”¨äºæŠ½è±¡æ–¹æ³•ã€æ¥å£ä¸­çš„æ–¹æ³•ç­‰ã€‚ å¸¸è§åº”ç”¨åœ¨è‡ªå®šä¹‰Viewæ„é€ å‡½æ•°ä¸­ 12345VpLoadMoreView @JvmOverloads constructor( context: Context, attrs: AttributeSet? = null, defStyle: Int = 0,) : LinearLayout(context, attrs, defStyle) {} @JvmStatic@JvmStaticç”¨äºå£°æ˜é™æ€æ–¹æ³•ã€‚åœ¨å…·åå¯¹è±¡åŠä¼´ç”Ÿå¯¹è±¡ä¸­ä½¿ç”¨æ—¶ï¼Œæ—¢ä¼šåœ¨ç›¸åº”å¯¹è±¡çš„ç±»ä¸­ç”Ÿæˆé™æ€æ–¹æ³•ï¼Œä¹Ÿä¼šåœ¨å¯¹è±¡è‡ªèº«ä¸­ç”Ÿæˆå®ä¾‹æ–¹æ³•ï¼Œå¦‚ï¼š 123456class KtA { companion object { @JvmStatic fun invokeStatic() {} fun invokeNoStatic() {}} åœ¨Javaä¸­è°ƒç”¨ï¼š 123456public void invokeKt() { KtA.invokeStatic(); //æ­£ç¡®ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ //KtA.invokeNoStatic(); //é”™è¯¯ï¼Œè¿™é‡Œè°ƒç”¨ä¸åˆ° KtA.Companion.invokeStatic(); //æ­£ç¡® KtA.Companion.invokeNoStatic(); //æ­£ç¡® } @JvmField@JvmFieldä½¿å¾—ç¼–è¯‘å™¨ä¸å†å¯¹è¯¥å­—æ®µç”Ÿæˆgetter/setterå¹¶å°†å…¶ä½œä¸ºå…¬å¼€å­—æ®µ @JvmSynthetic@JvmSyntheticå¯ä»¥ä¿®é¥°äºæ–¹æ³•ä¸Šï¼Œæ§åˆ¶åªèƒ½åœ¨Kotlinä¸­è°ƒç”¨ï¼Œå¦‚ï¼š 1234class KtA { @JvmSynthetic fun visit() {}} Javaä¸­è°ƒç”¨ï¼š 1234public void invokeKt() { KtA clz = new KtA(); clz.visit(); //é”™è¯¯ï¼Œè¿™é‡Œåœ¨Javaä¸­è°ƒç”¨ä¸åˆ°ã€‚} å¦‚æœæƒ³åœ¨Javaä¸­è°ƒç”¨åˆ°Kotlinç±»ä¸­çš„æ–¹æ³•ï¼Œå°†@JvmSyntheticå»æ‰å³å¯ã€‚ @JvmInline12345@Target(AnnotationTarget.CLASS)@Retention(AnnotationRetention.RUNTIME)@MustBeDocumented@SinceKotlin(&quot;1.5&quot;)public actual annotation class JvmInline @JvmInlineåœ¨1.5.0ç‰ˆæœ¬å¼•å…¥ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªç±»ä¸ºå†…è”ç±»ï¼Œéœ€ç»“åˆvalueä¸€èµ·ä½¿ç”¨ï¼›åœ¨1.5.0ä¹‹å‰ä½¿ç”¨inlineå…³é”®å­—ã€‚ 1234567//1.5.0ä¹‹å‰ï¼Œinlineæ ‡è®°å†…è”ç±»inline class Person(private val name: String = &quot;&quot;)//1.5.0ä¹‹åï¼Œ@JvmInline + value æ ‡è®°å†…è”ç±»@JvmInlinevalue class Person(private val name: String = &quot;&quot;)å†…è”ç±»æ„é€ å‚æ•°ä¸­æœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œæœ€ç»ˆè¢«å†…è”åˆ°å­—èŠ‚ç ä¸­çš„valueã€‚ï¼Œä¸Šè¿°ä»£ç ç»è¿‡å†…è”ä¼˜åŒ–ä¼šåœ¨å­—èŠ‚ç ä¸­å°†Personå¯¹è±¡è½¬æ¢ä¸ºStringå€¼ï¼Œä»è€Œç”±å †åˆ†é…ä¼˜åŒ–ä¸ºæ ˆåˆ†é…ã€‚ @JvmName ã€@JvmMultifileClass@JvmName æ³¨è§£å¯ä»¥ç”Ÿæˆç±»åï¼›å¦‚æœç±»åå·²å­˜åœ¨ï¼Œå¯ä»¥ä¿®æ”¹å·²ç”Ÿæˆçš„ Java ç±»çš„ç±»åã€‚åŒ…åç›¸åŒå¹¶ä¸”ç±»åç›¸åŒæˆ–è€…æœ‰ç›¸åŒçš„ @JvmName æ³¨è§£æœ‰ä¼šé”™è¯¯ï¼Œå¯ä»¥é€šè¿‡@JvmMultifileClassæŠŠä»–ä»¬åˆå¹¶åˆ°ä¸€èµ· Kotlin lateinit å’Œ by lazyç®€è¿°ï¼š lateinitæ˜¯ç”¨äºvarçš„ä¸å¯ç©ºç±»å‹å±æ€§ï¼Œæ˜¯å£°æ˜å»¶è¿Ÿåˆå§‹åŒ–ï¼Œéœ€å¼€å‘è€…ä¿è¯èµ‹å€¼çš„æ—¶åºæ­£ç¡® by lazyæ˜¯ç”¨äºvalçš„å±æ€§ï¼Œbyæ˜¯ç”¨äºå§”æ‰˜çš„å…³é”®å­—ï¼Œlazyæ˜¯æä¾›çº¿ç¨‹å®‰å…¨çš„æ‡’åŠ è½½çš„å®ç° lateinit varé€‚ç”¨äºä½ åœ¨å£°æ˜å˜é‡æ—¶ä¸çŸ¥é“å®ƒçš„åˆå§‹å€¼æ˜¯å¤šå°‘çš„åœºæ™¯ï¼Œéœ€è¦ä¿è¯ä»£ç è®¿é—®æ—¶åºçš„æ­£ç¡®æ€§ lazyæ›´é€‚ç”¨äºï¼Œã€Œä¸€ä¸ªå¯¹è±¡çš„åˆ›å»ºéœ€è¦æ¶ˆè€—å¤§é‡çš„èµ„æºï¼Œè€Œæˆ‘ä¸çŸ¥é“å®ƒåˆ°åº•ä¼šä¸ä¼šè¢«ç”¨åˆ°ã€çš„åœºæ™¯ï¼Œlazyåªæœ‰åœ¨ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨åˆ°çš„æ—¶å€™æ‰ä¼šå»èµ‹å€¼ lazyæœ¬è´¨æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªSynchronizedLazyImplå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åˆå§‹åŒ–çš„æ—¶å€™ä¼šæŒæœ‰ä¸€ä¸ªå‡½æ•°çš„å¼•ç”¨ï¼Œå½“è°ƒç”¨å®ƒçš„valueçš„æ—¶å€™ï¼Œä¼šå»æ£€æŸ¥æ˜¯ä¸æ˜¯åˆå§‹åŒ–è¿‡äº†ï¼Œå¦‚æœåˆå§‹åŒ–è¿‡äº†ç›´æ¥è¿”å›ï¼Œæ²¡æœ‰çš„è¯è°ƒç”¨ä¼ å…¥çš„å‡½æ•°ï¼Œè·å–åˆ°è¿”å›å€¼ä¹‹åå†è¿”å›ï¼Œä»è€Œå®ç°äº†ä¸€ä¸ªæ‡’åŠ è½½çš„æ•ˆæœ 123456789101112131415161718192021222324252627private class SynchronizedLazyImpl&lt;out T&gt;(initializer: () -&gt; T, lock: Any? = null) : Lazy&lt;T&gt;, Serializable { private var initializer: (() -&gt; T)? = initializer @Volatile private var _value: Any? = UNINITIALIZED_VALUE // final field is required to enable safe publication of constructed instance private val lock = lock ?: this override val value: T get() { val _v1 = _value if (_v1 !== UNINITIALIZED_VALUE) { @Suppress(&quot;UNCHECKED_CAST&quot;) return _v1 as T } return synchronized(lock) { val _v2 = _value if (_v2 !== UNINITIALIZED_VALUE) { @Suppress(&quot;UNCHECKED_CAST&quot;) (_v2 as T) } else { val typedValue = initializer!!() _value = typedValue initializer = null typedValue } } }} ä½†æ˜¯ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªå®ç°å®ƒåœ¨ç¬¬ä¸€æ¬¡è·å–å€¼çš„æ—¶å€™æ˜¯æœ‰åŠ é”æ¥å®ç°çº¿ç¨‹å®‰å…¨ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™æˆ‘ä»¬çš„ä»£ç éƒ½æ˜¯å•çº¿ç¨‹è°ƒç”¨çš„ï¼Œä¸éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šæœ‰é¢å¤–çš„æ€§èƒ½å¼€é”€","link":"/2021/07/30/Kotlin/"},{"title":"LeakType","text":"å†…å­˜æ³„æ¼å®è´¨å†…å­˜æ³„æ¼å®è´¨ä¸Šæ˜¯GCæ—¶å€™ï¼Œè¢«GC Rootå¼•ç”¨æˆ–é—´æ¥å¼•ç”¨ç€çš„å¯¹è±¡æ— æ³•è¢«å›æ”¶ï¼Œè€Œå¯ä»¥ä½œä¸ºGC Rootçš„å¯¹è±¡åœ¨javaä¸­æœ‰å‡ ç§ï¼š è™šæ‹Ÿæœºæ ˆæˆ–å«JVMæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡ï¼› ï¼ˆçº¿ç¨‹æ³„éœ²ï¼‰ è™šæ‹Ÿæœºæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œæ¯ä¸ªjavaæ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚æ¯ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­ä»å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚ æ–¹æ³•åŒºä¸­çš„ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ï¼› ï¼ˆstaticå˜é‡ï¼‰ æ–¹æ³•åŒºå­˜å‚¨ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ç­‰æ•°æ®ï¼Œæ˜¯çº¿ç¨‹å…±äº«çš„åŒºåŸŸ æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIï¼ˆå³ä¸€èˆ¬è¯´çš„Nativeæ–¹æ³•ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡ ï¼ˆJniæŒæœ‰çš„å¯¹è±¡ï¼‰ å¯¹åº”è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡Œjavaæ–¹æ³•æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„Nativeæ–¹æ³•æœåŠ¡ æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼› ï¼ˆfinalä¿®é¥°çš„int/float/longç­‰åŸºæœ¬æ•°æ®ç±»å‹å’ŒStringï¼‰ ä¸å¸¸è§ Androidå†…å­˜æ³„æ¼å†…å­˜æ³„æ¼ï¼šé•¿å‘¨æœŸå¯¹è±¡æŒæœ‰çŸ­å‘¨æœŸå¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œå¯¼è‡´çŸ­å‘¨æœŸçš„å¯¹è±¡åœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶æ— æ³•è¢«å›æ”¶ã€‚ å³ï¼šå¯¹è±¡åœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶è¢«å¦ä¸€ä¸ªå¯¹è±¡é€šè¿‡å¼ºå¼•ç”¨æŒæœ‰è€Œæ— æ³•é‡Šæ”¾ æ°¸ä¹…æ€§å†…å­˜æ³„æ¼ï¼šéé™æ€å†…éƒ¨ç±»ã€‚ å¦‚handlerã€runnableã€asnycTaskã€Threadç­‰ï¼Œä¸ç®¡æ˜¯ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»çš„åˆ›å»ºæ¨¡å¼ï¼Œè¿˜æ˜¯å®šä¹‰ä¸€ä¸ªéé™æ€çš„classçš„æ¨¡å¼ï¼Œéƒ½ä¼šå¯¼è‡´æŒæœ‰å¤–éƒ¨ç±»ä½¿å¤–éƒ¨ç±»æ— æ³•é‡Šæ”¾ã€‚ï¼ˆä¸Š1ï¼‰ é™æ€å˜é‡ï¼Œå•ä¾‹æ¨¡å¼ï¼ˆä¸Š2ï¼‰ æ–‡ä»¶æ“ä½œã€æ•°æ®åº“æ“ä½œç­‰closeableç±»ï¼Œå®ƒä»¬åº•å±‚æ˜¯jniå®ç°çš„ï¼ˆä¸Š4ï¼‰ï¼Œéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ ps:ä¸€èˆ¬ç±»ä¼¼onClickListenerçš„ç”¨æ³•è™½ç„¶ä¼šä½¿ç”¨åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼åˆ›å»ºä½†ä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå› ä¸ºåªæœ‰å¼‚æ­¥ä»»åŠ¡çš„åŒ¿åå†…éƒ¨ç±»ç”Ÿå‘½å‘¨æœŸä¸åŒæ‰å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ï¼ŒåŒæ­¥çš„ä¼šè¢«ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«GCæ‰ã€‚ ä¸¤ç§ç‰¹æ®Šæƒ…å†µï¼š ç³»ç»Ÿç›‘å¬LocationListenerï¼Œç³»ç»Ÿä¸€ç›´æŒæœ‰è€Œæ°¸ä¹…æ€§æ³„æ¼ï¼› ç›‘å¬å›è°ƒä¸­æœ‰è€—æ—¶æ“ä½œï¼Œå¯¼è‡´ä¸´æ—¶æ³„æ¼ï¼ˆè§ä¸‹ï¼‰ã€‚ ä¸´æ—¶æ€§å†…å­˜æ³„æ¼ï¼šé™æ€handleræœ‰æ¶ˆæ¯å­˜åœ¨messageQueueä¸­ï¼Œç”±äºmessageQueueæŒæœ‰messageï¼ŒmessageæŒæœ‰targetï¼ˆhandlerå¯¹è±¡ï¼‰ï¼Œhandleråˆ™ä¼šæ— æ³•å›æ”¶ï¼Œç›´åˆ°æ¶ˆæ¯è¢«å–å‡ºå¤„ç†åï¼Œå†æ¬¡GCæ—¶å›æ”¶ã€‚ï¼ˆä¸Š1ï¼‰","link":"/2024/07/04/LeakType/"},{"title":"Lifecycle","text":"","link":"/2023/10/10/Lifecycle/"},{"title":"Java","text":"final &amp; finalize()finalfinalä¿®é¥°çš„ç±»ä¸å¯è¢«ç»§æ‰¿ï¼Œæ–¹æ³•ä¸å¯è¢«è¦†ç›–(æˆ–è€…å«é‡å†™)ï¼Œå¯¹è±¡ä¸å¯è¢«æ›´æ”¹ã€‚ finalize()finalize()æ˜¯Objectçš„protectedæ–¹æ³•ï¼Œæ˜¯ç”¨æ¥ç»™å¯¹è±¡åœ¨Gcå‰ä¸€æ¬¡è¡ŒåŠ¨çš„æœºä¼šï¼šé¦–å…ˆï¼Œå½“å¯¹è±¡å˜æˆ(GC Roots)ä¸å¯è¾¾æ—¶ï¼ŒGCä¼šåˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦è¦†ç›–äº†finalizeæ–¹æ³•ï¼Œè‹¥æœªè¦†ç›–ï¼Œåˆ™ç›´æ¥å°†å…¶å›æ”¶ã€‚å¦åˆ™ï¼Œè‹¥å¯¹è±¡æœªæ‰§è¡Œè¿‡finalizeæ–¹æ³•ï¼Œå°†å…¶æ”¾å…¥F-Queueé˜Ÿåˆ—ï¼Œç”±ä¸€ä½ä¼˜å…ˆçº§çº¿ç¨‹æ‰§è¡Œè¯¥é˜Ÿåˆ—ä¸­å¯¹è±¡çš„finalizeæ–¹æ³•ã€‚æ‰§è¡Œfinalizeæ–¹æ³•å®Œæ¯•åï¼ŒGCä¼šå†æ¬¡åˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦å¯è¾¾ï¼Œè‹¥ä¸å¯è¾¾ï¼Œåˆ™è¿›è¡Œå›æ”¶ï¼Œå¦åˆ™ï¼Œå¯¹è±¡â€œå¤æ´»â€ã€‚ System.gc()ä¸System.runFinalization()æ–¹æ³•å¢åŠ äº†finalizeæ–¹æ³•æ‰§è¡Œçš„æœºä¼šï¼Œä½†ä¸å¯ç›²ç›®ä¾èµ–å®ƒä»¬ Javaè¯­è¨€è§„èŒƒå¹¶ä¸ä¿è¯finalizeæ–¹æ³•ä¼šè¢«åŠæ—¶åœ°æ‰§è¡Œã€è€Œä¸”æ ¹æœ¬ä¸ä¼šä¿è¯å®ƒä»¬ä¼šè¢«æ‰§è¡Œ finalizeæ–¹æ³•å¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚å› ä¸ºJVMé€šå¸¸åœ¨å•ç‹¬çš„ä½ä¼˜å…ˆçº§çº¿ç¨‹ä¸­å®Œæˆfinalizeçš„æ‰§è¡Œ å¯¹è±¡å†ç”Ÿé—®é¢˜ï¼šfinalizeæ–¹æ³•ä¸­ï¼Œå¯å°†å¾…å›æ”¶å¯¹è±¡èµ‹å€¼ç»™GC Rootså¯è¾¾çš„å¯¹è±¡å¼•ç”¨ï¼Œä»è€Œè¾¾åˆ°å¯¹è±¡å†ç”Ÿçš„ç›®çš„ finalizeæ–¹æ³•è‡³å¤šç”±GCæ‰§è¡Œä¸€æ¬¡(ç”¨æˆ·å½“ç„¶å¯ä»¥æ‰‹åŠ¨è°ƒç”¨å¯¹è±¡çš„finalizeæ–¹æ³•ï¼Œä½†å¹¶ä¸å½±å“GCå¯¹finalizeçš„è¡Œä¸º) ç®€è¿°ï¼šfinalize()æ–¹æ³•ä¼šåœ¨å¯¹è±¡å›æ”¶å‰è‡³å¤šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸€èˆ¬å¯ä»¥åœ¨è¿™é‡Œåšä¸€æ¬¡é‡æ–°æŒ‚åˆ°GcRooté“¾ä¸Šçš„ä¿æ´»æ“ä½œï¼Œæˆ–è€…åƒAndroid6ä»¥å‰å®‰å“åœ¨è¦†ç›–çš„finalize()æ–¹æ³•ä¸­é‡Šæ”¾nativeå†…å­˜ä¸€æ ·ã€‚ Object.toStringtoString é»˜è®¤æ˜¯ä¸ªæŒ‡é’ˆï¼Œä¸€èˆ¬éœ€è¦é‡å†™ï¼Œæœªé‡å†™æƒ…å†µä¸‹ï¼Œè¿”å› 1getClass().getName() + '@' + Integer.toHexString(hashCode()) equal &amp; hashcode If o1.equals(o2), then o1.hashCode() == o2.hashCode() should always be true. If o1.hashCode() == o2.hashCode is true, it doesnâ€™t mean that o1.equals(o2) will be true. ä¹Ÿå°±æ˜¯equals æ˜¯ hashcodeçš„å……åˆ†ä¸å¿…è¦æ¡ä»¶ equalsæ¯”è¾ƒå¯¹è±¡æ˜¯å¦å†…å®¹ç›¸åŒï¼Œé»˜è®¤å’Œ==åŠŸèƒ½ä¸€è‡´ hashcodeè¯¥å¯¹è±¡å“ˆå¸Œã€‚hashcodeæœ‰å¤šç§å®ç°ï¼Œä¸ä¸€å®šä¸å†…å­˜åœ°å€ç›¸å…³ã€‚ç›®å‰ç‰ˆæœ¬æ˜¯â€å½“å‰çº¿ç¨‹æœ‰å…³çš„ä¸€ä¸ªéšæœºæ•°+ä¸‰ä¸ªç¡®å®šå€¼ï¼Œè¿ç”¨xorshiftéšæœºæ•°ç®—æ³•å¾—åˆ°çš„ä¸€ä¸ªéšæœºæ•°â€œ é‡å†™equal çš„åŒæ—¶ä¸ºä»€ä¹ˆå¿…é¡»é‡å†™hashcodeï¼Ÿ æ³¨æ„ï¼šå½“equalsæ–¹æ³•è¢«é‡å†™æ—¶ï¼Œé€šå¸¸æœ‰å¿…è¦é‡å†™ hashCode æ–¹æ³•ï¼Œä»¥ç»´æŠ¤ hashCode æ–¹æ³•çš„å¸¸è§„åå®šï¼Œè¯¥åå®šå£°æ˜ç›¸ç­‰å¯¹è±¡å¿…é¡»å…·æœ‰ç›¸ç­‰çš„å“ˆå¸Œç ã€‚ hashCodeæ˜¯ç¼–è¯‘å™¨ä¸ºä¸åŒå¯¹è±¡äº§ç”Ÿçš„ä¸åŒæ•´æ•°ï¼Œæ ¹æ®equalæ–¹æ³•çš„å®šä¹‰ï¼šå¦‚æœä¸¤ä¸ªå¯¹è±¡æ˜¯ç›¸ç­‰ï¼ˆequalï¼‰çš„ï¼Œé‚£ä¹ˆä¸¤ä¸ªå¯¹è±¡è°ƒç”¨hashCodeå¿…é¡»äº§ç”Ÿç›¸åŒçš„æ•´æ•°ç»“æœï¼Œå³ï¼šequalä¸ºtrueï¼ŒhashCodeå¿…é¡»ä¸ºtrueï¼Œequalä¸ºfalseï¼ŒhashCodeä¹Ÿå¿…é¡»ä¸ºfalseï¼Œæ‰€ä»¥å¿…é¡»é‡å†™hashCodeæ¥ä¿è¯ä¸equalåŒæ­¥ã€‚ finalize()wait() &amp; notify()getClass()clone()é¢å‘å¯¹è±¡å°è£…ï¼šå¯¹æŠ½è±¡çš„äº‹ç‰©æŠ½è±¡åŒ–æˆä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶å¯¹å…¶å¯¹è±¡çš„å±æ€§ç§æœ‰åŒ–ï¼ŒåŒæ—¶æä¾›ä¸€äº›èƒ½è¢«å¤–ç•Œè®¿é—®å±æ€§çš„æ–¹æ³•ï¼› ç»§æ‰¿ï¼šå­ç±»æ‰©å±•æ–°çš„æ•°æ®åŸŸæˆ–åŠŸèƒ½ï¼Œå¹¶å¤ç”¨çˆ¶ç±»çš„å±æ€§ä¸åŠŸèƒ½ï¼Œå•ç»§æ‰¿ï¼Œå¤šå®ç°ï¼› å¤šæ€ï¼šé€šè¿‡ç»§æ‰¿ï¼ˆå¤šä¸ªâ¼¦ç±»å¯¹åŒâ¼€â½…æ³•çš„é‡å†™ï¼‰ã€ä¹Ÿå¯ä»¥é€šè¿‡æ¥â¼ï¼ˆå®ç°æ¥â¼å¹¶è¦†ç›–æ¥â¼ï¼‰ é™æ€ç»‘å®šä¸åŠ¨æ€ç»‘å®šï¼Œé‡è½½Overloadä¸é‡å†™Overrideï¼šé‡è½½ ä¸€ç§æ˜¯åœ¨ç¼–è¯‘æœŸç¡®å®šï¼Œè¢«ç§°ä¸ºé™æ€åˆ†æ´¾ï¼Œæ¯”å¦‚æ–¹æ³•çš„é‡è½½Overloadï¼› é‡è½½æŒ‡åœ¨åŒä¸€ä¸ªç±»ä¸­å®šä¹‰å¤šä¸ªæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åç§°ç›¸åŒï¼Œç­¾åä¸åŒã€‚**(å‚æ•°åˆ—è¡¨å¿…é¡»æ”¹ï¼Œå…¶ä»–æ— è¦æ±‚)** å¤šæ€ ä¸€ç§æ˜¯åœ¨è¿è¡Œæ—¶ç¡®å®šï¼Œè¢«ç§°ä¸ºåŠ¨æ€åˆ†æ´¾ï¼Œæ¯”å¦‚æ–¹æ³•çš„è¦†ç›–Overrideï¼ˆé‡å†™ï¼‰å’Œæ¥å£çš„å®ç°ã€‚ é‡å†™æŒ‡åœ¨å­ç±»ä¸­çš„æ–¹æ³•çš„åç§°å’Œç­¾åéƒ½å’Œçˆ¶ç±»ç›¸åŒï¼Œä½¿ç”¨overrideæ³¨è§£ã€‚**(å‚æ•°å’Œè¿”å›ä¸èƒ½æ”¹ï¼Œå…¶ä»–ä¸èƒ½å‡çº§)** å¤šæ€å®ç°å¤šæ€çš„åº•å±‚å®ç°æ˜¯åŠ¨æ€ç»‘å®šï¼Œå³åœ¨è¿è¡Œæ—¶æ‰æŠŠæ–¹æ³•è°ƒç”¨ä¸æ–¹æ³•å®ç°å…³è”èµ·æ¥ã€‚åœ¨Javaä¸­æœ‰ä¸¤ç§å½¢å¼å¯ä»¥å®ç°å¤šæ€ï¼šæ–¹æ³•çš„è¦†ç›–Overrideï¼ˆé‡å†™ï¼‰å’Œæ¥å£çš„å®ç°ã€‚ å¤šæ€çš„å®ç°åŸç† è™šæ‹Ÿæœºæ ˆä¸­ä¼šå­˜æ”¾å½“å‰æ–¹æ³•è°ƒç”¨çš„æ ˆå¸§ï¼ˆå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ ˆã€åŠ¨æ€è¿æ¥ ã€è¿”å›åœ°å€ï¼‰ã€‚å¤šæ€çš„å®ç°è¿‡ç¨‹ï¼Œå°±æ˜¯æ–¹æ³•è°ƒç”¨åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ï¼Œå¦‚æœå­ç±»è¦†ç›–äº†çˆ¶ç±»çš„æ–¹æ³•ï¼Œåˆ™åœ¨å¤šæ€è°ƒç”¨ä¸­ï¼ŒåŠ¨æ€ç»‘å®šè¿‡ç¨‹ä¼šé¦–å…ˆç¡®å®šå®é™…ç±»å‹æ˜¯å­ç±»ï¼Œä»è€Œå…ˆæœç´¢åˆ°å­ç±»ä¸­çš„æ–¹æ³•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¾¿æ˜¯æ–¹æ³•è¦†ç›–çš„æœ¬è´¨ã€‚ é™„å½•ï¼šé‡å†™Overrideå’Œé‡è½½Overloadçš„åŒºåˆ«Overload åœ¨åŒä¸€ä¸ªç±»ä¸­ï¼Œé‡è½½æŒ‡åœ¨åŒä¸€ä¸ªç±»ä¸­å®šä¹‰å¤šä¸ªæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åç§°ç›¸åŒï¼Œç­¾åä¸åŒã€‚**(å‚æ•°åˆ—è¡¨å¿…é¡»æ”¹ï¼Œå…¶ä»–æ— è¦æ±‚)** Overwirte é›†æˆäºçˆ¶ç±»çš„å­ç±»ä¸­ï¼Œé‡å†™æŒ‡åœ¨å­ç±»ä¸­çš„æ–¹æ³•çš„åç§°å’Œç­¾åéƒ½å’Œçˆ¶ç±»ç›¸åŒï¼Œä½¿ç”¨overrideæ³¨è§£ã€‚**(å‚æ•°å’Œè¿”å›ä¸èƒ½æ”¹ï¼Œå…¶ä»–ä¸èƒ½å‡çº§)** åŒºåˆ«ç‚¹ é‡è½½æ–¹æ³• é‡å†™æ–¹æ³• å‚æ•°åˆ—è¡¨ å¿…é¡»ä¿®æ”¹ ä¸€å®šä¸èƒ½ä¿®æ”¹ è¿”å›ç±»å‹ å¯ä»¥ä¿®æ”¹ ä¸€å®šä¸èƒ½ä¿®æ”¹ å¼‚å¸¸ å¯ä»¥ä¿®æ”¹ å¯ä»¥å‡å°‘æˆ–åˆ é™¤ï¼Œä¸€å®šä¸èƒ½æŠ›å‡ºæ–°çš„æˆ–è€…æ›´å¹¿çš„å¼‚å¸¸ è®¿é—® å¯ä»¥ä¿®æ”¹ ä¸€å®šä¸èƒ½åšæ›´ä¸¥æ ¼çš„é™åˆ¶ï¼ˆå¯ä»¥é™ä½é™åˆ¶ï¼‰ é¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹æ€§ç‰¹æ€§ï¼šå°è£…ã€ç»§æ‰¿ã€å¤šæ€ å°è£…ï¼šå¯¹æŠ½è±¡çš„äº‹ç‰©æŠ½è±¡åŒ–æˆä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶å¯¹å…¶å¯¹è±¡çš„å±æ€§ç§æœ‰åŒ–ï¼ŒåŒæ—¶æä¾›ä¸€äº›èƒ½è¢«å¤–ç•Œè®¿é—®å±æ€§çš„æ–¹æ³•ï¼› ç»§æ‰¿ï¼šå­ç±»æ‰©å±•æ–°çš„æ•°æ®åŸŸæˆ–åŠŸèƒ½ï¼Œå¹¶å¤ç”¨çˆ¶ç±»çš„å±æ€§ä¸åŠŸèƒ½ï¼Œå•ç»§æ‰¿ï¼Œå¤šå®ç°ï¼› å¤šæ€ï¼šé€šè¿‡ç»§æ‰¿ï¼ˆå¤šä¸ªâ¼¦ç±»å¯¹åŒâ¼€â½…æ³•çš„é‡å†™ï¼‰ã€ä¹Ÿå¯ä»¥é€šè¿‡æ¥â¼ï¼ˆå®ç°æ¥â¼å¹¶è¦†ç›–æ¥â¼ï¼‰ 1ã€Javaä¸C++åŒºåˆ« ä¸åŒç‚¹ï¼šc++æ”¯æŒå¤šç»§æ‰¿ï¼Œå¹¶ä¸”æœ‰æŒ‡é’ˆçš„æ¦‚å¿µï¼Œç”±ç¨‹åºå‘˜è‡ªå·±ç®¡ç†å†…å­˜ï¼›Javaæ˜¯å•ç»§æ‰¿ï¼Œå¯ä»¥ç”¨æ¥å£å®ç°å¤šç»§æ‰¿ï¼ŒJava ä¸æä¾›æŒ‡é’ˆæ¥ç›´æ¥è®¿é—®å†…å­˜ï¼Œç¨‹åºå†…å­˜æ›´åŠ å®‰å…¨ï¼Œå¹¶ä¸”Javaæœ‰JVMâ¾ƒåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œä¸éœ€è¦ç¨‹åºå‘˜â¼¿åŠ¨é‡Šæ”¾â½†â½¤å†…å­˜ 2ã€å¤šæ€å®ç°åŸç†å¤šæ€çš„åº•å±‚å®ç°æ˜¯åŠ¨æ€ç»‘å®šï¼Œå³åœ¨è¿è¡Œæ—¶æ‰æŠŠæ–¹æ³•è°ƒç”¨ä¸æ–¹æ³•å®ç°å…³è”èµ·æ¥ã€‚ é™æ€ç»‘å®šä¸åŠ¨æ€ç»‘å®šï¼š ä¸€ç§æ˜¯åœ¨ç¼–è¯‘æœŸç¡®å®šï¼Œè¢«ç§°ä¸ºé™æ€åˆ†æ´¾ï¼Œæ¯”å¦‚æ–¹æ³•çš„é‡è½½ï¼› ä¸€ç§æ˜¯åœ¨è¿è¡Œæ—¶ç¡®å®šï¼Œè¢«ç§°ä¸ºåŠ¨æ€åˆ†æ´¾ï¼Œæ¯”å¦‚æ–¹æ³•çš„è¦†ç›–ï¼ˆé‡å†™ï¼‰å’Œæ¥å£çš„å®ç°ã€‚ å¤šæ€çš„å®ç° è™šæ‹Ÿæœºæ ˆä¸­ä¼šå­˜æ”¾å½“å‰æ–¹æ³•è°ƒç”¨çš„æ ˆå¸§ï¼ˆå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ ˆã€åŠ¨æ€è¿æ¥ ã€è¿”å›åœ°å€ï¼‰ã€‚å¤šæ€çš„å®ç°è¿‡ç¨‹ï¼Œå°±æ˜¯æ–¹æ³•è°ƒç”¨åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ï¼Œå¦‚æœå­ç±»è¦†ç›–äº†çˆ¶ç±»çš„æ–¹æ³•ï¼Œåˆ™åœ¨å¤šæ€è°ƒç”¨ä¸­ï¼ŒåŠ¨æ€ç»‘å®šè¿‡ç¨‹ä¼šé¦–å…ˆç¡®å®šå®é™…ç±»å‹æ˜¯å­ç±»ï¼Œä»è€Œå…ˆæœç´¢åˆ°å­ç±»ä¸­çš„æ–¹æ³•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¾¿æ˜¯æ–¹æ³•è¦†ç›–çš„æœ¬è´¨ã€‚ 3ã€staticå’Œfinalå…³é”®å­—staticï¼šå¯ä»¥ä¿®é¥°å±æ€§ã€æ–¹æ³• staticä¿®é¥°å±æ€§ï¼š ç±»çº§åˆ«å±æ€§ï¼Œæ‰€æœ‰å¯¹è±¡å…±äº«ä¸€ä»½ï¼Œéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼ˆåªåŠ è½½ä¸€æ¬¡ï¼‰ï¼Œå…ˆäºå¯¹è±¡çš„åˆ›å»ºï¼›å¯ä»¥ä½¿ç”¨ç±»åç›´æ¥è°ƒç”¨ã€‚ staticä¿®é¥°æ–¹æ³•ï¼š éšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼›å¯ä»¥ä½¿ç”¨ç±»åç›´æ¥è°ƒç”¨ï¼›é™æ€æ–¹æ³•ä¸­ï¼Œåªèƒ½è°ƒç”¨é™æ€çš„æˆå‘˜ï¼Œä¸å¯ç”¨thisï¼› finalï¼šå…³é”®å­—ä¸»è¦â½¤åœ¨ä¸‰ä¸ªåœ°â½…ï¼šå˜é‡ã€â½…æ³•ã€ç±»ã€‚ finalä¿®é¥°å˜é‡ï¼š å¦‚æœæ˜¯åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡ï¼Œåˆ™å…¶æ•°å€¼â¼€æ—¦åœ¨åˆå§‹åŒ–ä¹‹åä¾¿ä¸èƒ½æ›´æ”¹ï¼› å¦‚æœæ˜¯å¼•â½¤ç±»å‹çš„å˜é‡ï¼Œåˆ™åœ¨å¯¹å…¶åˆå§‹åŒ–ä¹‹åä¾¿ä¸èƒ½å†è®©å…¶æŒ‡å‘å¦â¼€ä¸ªå¯¹è±¡ã€‚ finalä¿®é¥°æ–¹æ³•ï¼š æŠŠâ½…æ³•é”å®šï¼Œä»¥é˜²ä»»ä½•ç»§æ‰¿ç±»ä¿®æ”¹å®ƒçš„å«ä¹‰ï¼ˆé‡å†™ï¼‰ï¼›ç±»ä¸­æ‰€æœ‰çš„ private â½…æ³•éƒ½éšå¼åœ°æŒ‡å®šä¸º finalã€‚ finalä¿®é¥°ç±»ï¼š final ä¿®é¥°ç±»æ—¶ï¼Œè¡¨æ˜è¿™ä¸ªç±»ä¸èƒ½è¢«ç»§æ‰¿ã€‚final ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜â½…æ³•éƒ½ä¼šè¢«éšå¼åœ°æŒ‡å®šä¸º final â½…æ³•ã€‚ ä¸€ä¸ªç±»ä¸èƒ½è¢«ç»§æ‰¿ï¼Œé™¤äº†finalå…³é”®å­—ä¹‹å¤–ï¼Œè¿˜æœ‰å¯ä»¥ç§æœ‰åŒ–æ„é€ å™¨ã€‚ï¼ˆå†…éƒ¨ç±»æ— æ•ˆï¼‰ 4ã€æŠ½è±¡ç±»å’Œæ¥å£æŠ½è±¡ç±»ï¼šåŒ…å«æŠ½è±¡æ–¹æ³•çš„ç±»ï¼Œå³ä½¿ç”¨abstractä¿®é¥°çš„ç±»ï¼›æŠ½è±¡ç±»åªèƒ½è¢«ç»§æ‰¿ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨finalä¿®é¥°ï¼ŒæŠ½è±¡ç±»ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œ æ¥å£ï¼šæ¥å£æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»å‹ï¼Œæ˜¯æŠ½è±¡æ–¹æ³•çš„é›†åˆï¼Œæ¥å£æ”¯æŒå¤šç»§æ‰¿ï¼Œæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œé»˜è®¤æ˜¯public abstractä¿®é¥°çš„æŠ½è±¡æ–¹æ³• ç›¸åŒç‚¹ï¼š â‘  æŠ½è±¡ç±»å’Œæ¥å£éƒ½ä¸èƒ½è¢«å®ä¾‹åŒ– â‘¡ æŠ½è±¡ç±»å’Œæ¥å£éƒ½å¯ä»¥å®šä¹‰æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»/å®ç°ç±»å¿…é¡»è¦†å†™è¿™äº›æŠ½è±¡æ–¹æ³• ä¸åŒç‚¹ï¼š â‘  æŠ½è±¡ç±»æœ‰æ„é€ æ–¹æ³•ï¼Œæ¥å£æ²¡æœ‰æ„é€ æ–¹æ³• â‘¢æŠ½è±¡ç±»å¯ä»¥åŒ…å«æ™®é€šæ–¹æ³•ï¼Œæ¥å£ä¸­åªèƒ½æ˜¯public abstractä¿®é¥°æŠ½è±¡æ–¹æ³•ï¼ˆJava8ä¹‹åå¯ä»¥ï¼‰ â‘¢ æŠ½è±¡ç±»åªèƒ½å•ç»§æ‰¿ï¼Œæ¥å£å¯ä»¥å¤šç»§æ‰¿ â‘£ æŠ½è±¡ç±»å¯ä»¥å®šä¹‰å„ç§ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œæ¥å£ä¸­åªèƒ½æ˜¯public static finalä¿®é¥°çš„é™æ€å¸¸é‡ æŠ½è±¡ç±»çš„ä½¿ç”¨åœºæ™¯ï¼š æ—¢æƒ³çº¦æŸå­ç±»å…·æœ‰å…±åŒçš„è¡Œä¸ºï¼ˆä½†ä¸å†ä¹å…¶å¦‚ä½•å®ç°ï¼‰ï¼Œåˆæƒ³æ‹¥æœ‰ç¼ºçœçš„æ–¹æ³•ï¼Œåˆèƒ½æ‹¥æœ‰å®ä¾‹å˜é‡ æ¥å£çš„åº”ç”¨åœºæ™¯ï¼š çº¦æŸå¤šä¸ªå®ç°ç±»å…·æœ‰ç»Ÿä¸€çš„è¡Œä¸ºï¼Œä½†æ˜¯ä¸åœ¨ä¹æ¯ä¸ªå®ç°ç±»å¦‚ä½•å…·ä½“å®ç°ï¼›å®ç°ç±»ä¸­å„ä¸ªåŠŸèƒ½ä¹‹é—´å¯èƒ½æ²¡æœ‰ä»»ä½•è”ç³» 5ã€æ³›å‹ä»¥åŠæ³›å‹æ“¦é™¤å‚è€ƒï¼šhttps://blog.csdn.net/baoyinwang/article/details/107341997 æ³›å‹ï¼š æ³›å‹çš„æœ¬è´¨æ˜¯å‚æ•°åŒ–ç±»å‹ã€‚è¿™ç§å‚æ•°ç±»å‹å¯ä»¥ç”¨åœ¨ç±»ã€æ¥å£å’Œæ–¹æ³•çš„åˆ›å»ºä¸­ï¼Œåˆ†åˆ«ç§°ä¸ºæ³›å‹ç±»ã€æ³›å‹æ¥å£å’Œæ³›å‹æ–¹æ³•ã€‚ æ³›å‹æ“¦é™¤ï¼š Javaçš„æ³›å‹æ˜¯ä¼ªæ³›å‹ï¼Œä½¿ç”¨æ³›å‹çš„æ—¶å€™åŠ ä¸Šç±»å‹å‚æ•°ï¼Œåœ¨ç¼–è¯‘å™¨ç¼–è¯‘ç”Ÿæˆçš„å­—èŠ‚ç çš„æ—¶å€™ä¼šå»æ‰ï¼Œè¿™ä¸ªè¿‡ç¨‹æˆä¸ºç±»å‹æ“¦é™¤ã€‚ å¦‚Listç­‰ç±»å‹ï¼Œåœ¨ç¼–è¯‘ä¹‹åéƒ½ä¼šå˜æˆ Listã€‚JVM çœ‹åˆ°çš„åªæ˜¯ Listï¼Œè€Œç”±æ³›å‹é™„åŠ çš„ç±»å‹ä¿¡æ¯å¯¹ JVM æ¥è¯´æ˜¯ä¸å¯è§çš„ã€‚ å¯ä»¥é€šè¿‡åå°„æ·»åŠ å…¶å®ƒç±»å‹å…ƒç´  6ã€åå°„åŸç†ä»¥åŠä½¿ç”¨åœºæ™¯Javaåå°„ï¼š æ˜¯æŒ‡åœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»éƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»æ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•ï¼›å¹¶ä¸”éƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•ï¼› åå°„åŸç†ï¼š åå°„é¦–å…ˆæ˜¯èƒ½å¤Ÿè·å–åˆ°Javaä¸­çš„åå°„ç±»çš„å­—èŠ‚ç ï¼Œç„¶åå°†å­—èŠ‚ç ä¸­çš„æ–¹æ³•ï¼Œå˜é‡ï¼Œæ„é€ å‡½æ•°ç­‰æ˜ å°„æˆ ç›¸åº”çš„ Methodã€Filedã€Constructor ç­‰ç±» å¦‚ä½•å¾—åˆ°Classçš„å®ä¾‹: 1231.ç±»å.class(å°±æ˜¯ä¸€ä»½å­—èŠ‚ç )2.Class.forName(String className);æ ¹æ®ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥æ„å»ºClasså¯¹è±¡3.æ¯ä¸€ä¸ªå¯¹è±¡å¤šæœ‰getClass()æ–¹æ³•:obj.getClass();è¿”å›å¯¹è±¡çš„çœŸå®ç±»å‹ ä½¿ç”¨åœºæ™¯ï¼š å¼€å‘é€šç”¨æ¡†æ¶ - åå°„æœ€é‡è¦çš„ç”¨é€”å°±æ˜¯å¼€å‘å„ç§é€šç”¨æ¡†æ¶ã€‚å¾ˆå¤šæ¡†æ¶ï¼ˆæ¯”å¦‚ Springï¼‰éƒ½æ˜¯é…ç½®åŒ–çš„ï¼ˆæ¯”å¦‚é€šè¿‡ XML æ–‡ä»¶é…ç½® JavaBeanã€Filter ç­‰ï¼‰ï¼Œä¸ºäº†ä¿è¯æ¡†æ¶çš„é€šç”¨æ€§ï¼Œéœ€è¦æ ¹æ®é…ç½®æ–‡ä»¶è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ä¸åŒçš„å¯¹è±¡æˆ–ç±»ï¼Œè°ƒç”¨ä¸åŒçš„æ–¹æ³•ã€‚ åŠ¨æ€ä»£ç† - åœ¨åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰ä¸­ï¼Œéœ€è¦æ‹¦æˆªç‰¹å®šçš„æ–¹æ³•ï¼Œé€šå¸¸ï¼Œä¼šé€‰æ‹©åŠ¨æ€ä»£ç†æ–¹å¼ã€‚è¿™æ—¶ï¼Œå°±éœ€è¦åå°„æŠ€æœ¯æ¥å®ç°äº†ã€‚ JDKï¼šspringé»˜è®¤åŠ¨æ€ä»£ç†ï¼Œéœ€è¦å®ç°æ¥å£ CGLIBï¼šé€šè¿‡asmæ¡†æ¶åºåˆ—åŒ–å­—èŠ‚æµï¼Œå¯é…ç½®ï¼Œæ€§èƒ½å·® è‡ªå®šä¹‰æ³¨è§£ - æ³¨è§£æœ¬èº«ä»…ä»…æ˜¯èµ·åˆ°æ ‡è®°ä½œç”¨ï¼Œå®ƒéœ€è¦åˆ©ç”¨åå°„æœºåˆ¶ï¼Œæ ¹æ®æ³¨è§£æ ‡è®°å»è°ƒç”¨æ³¨è§£è§£é‡Šå™¨ï¼Œæ‰§è¡Œè¡Œä¸ºã€‚ 7ã€Javaå¼‚å¸¸ä½“ç³» Throwable æ˜¯ Java è¯­è¨€ä¸­æ‰€æœ‰é”™è¯¯æˆ–å¼‚å¸¸çš„è¶…ç±»ã€‚ä¸‹ä¸€å±‚åˆ†ä¸º Error å’Œ Exception Error ï¼š æ˜¯æŒ‡ java è¿è¡Œæ—¶ç³»ç»Ÿçš„å†…éƒ¨é”™è¯¯å’Œèµ„æºè€—å°½é”™è¯¯ã€‚åº”ç”¨ç¨‹åºä¸ä¼šæŠ›å‡ºè¯¥ç±»å¯¹è±¡ã€‚å¦‚æœå‡ºç°äº†è¿™æ ·çš„é”™è¯¯ï¼Œé™¤äº†å‘ŠçŸ¥ç”¨æˆ·ï¼Œå‰©ä¸‹çš„å°±æ˜¯å°½åŠ›ä½¿ç¨‹åºå®‰å…¨çš„ç»ˆæ­¢ã€‚ Exception åŒ…å«ï¼šRuntimeException ã€CheckedException ç¼–ç¨‹é”™è¯¯å¯ä»¥åˆ†æˆä¸‰ç±»ï¼šè¯­æ³•é”™è¯¯ã€é€»è¾‘é”™è¯¯å’Œè¿è¡Œé”™è¯¯ã€‚ è¯­æ³•é”™è¯¯ï¼ˆä¹Ÿç§°ç¼–è¯‘é”™è¯¯ï¼‰æ˜¯åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å‡ºç°çš„é”™è¯¯ï¼Œç”±ç¼–è¯‘å™¨æ£€æŸ¥å‘ç°è¯­æ³•é”™è¯¯ é€»è¾‘é”™è¯¯æŒ‡ç¨‹åºçš„æ‰§è¡Œç»“æœä¸é¢„æœŸä¸ç¬¦ï¼Œå¯ä»¥é€šè¿‡è°ƒè¯•å®šä½å¹¶å‘ç°é”™è¯¯çš„åŸå›  è¿è¡Œé”™è¯¯æ˜¯å¼•èµ·ç¨‹åºéæ­£å¸¸ç»ˆç«¯çš„é”™è¯¯ï¼Œéœ€è¦é€šè¿‡å¼‚å¸¸å¤„ç†çš„æ–¹å¼å¤„ç†è¿è¡Œé”™è¯¯ RuntimeExceptionï¼š è¿è¡Œæ—¶å¼‚å¸¸ï¼Œç¨‹åºåº”è¯¥ä»é€»è¾‘è§’åº¦å°½å¯èƒ½é¿å…è¿™ç±»å¼‚å¸¸çš„å‘ç”Ÿã€‚ å¦‚ NullPointerException ã€ ClassCastException ï¼› CheckedExceptionï¼šå—æ£€å¼‚å¸¸ï¼Œç¨‹åºä½¿ç”¨trycatchè¿›è¡Œæ•æ‰å¤„ç† å¦‚IOExceptionã€SQLExceptionã€NotFoundExceptionï¼› æ•°æ®ç»“æ„ 1ã€ArrayListå’ŒLinkedListArrayListï¼š åº•å±‚åŸºäºæ•°ç»„å®ç°ï¼Œæ”¯æŒå¯¹å…ƒç´ è¿›è¡Œå¿«é€Ÿéšæœºè®¿é—®ï¼Œé€‚åˆéšæœºæŸ¥æ‰¾å’Œéå†ï¼Œä¸é€‚åˆæ’å…¥å’Œåˆ é™¤ã€‚ï¼ˆæä¸€å¥å®é™…ä¸Šï¼‰â€‹ é»˜è®¤åˆå§‹å¤§å°ä¸º10ï¼Œå½“æ•°ç»„å®¹é‡ä¸å¤Ÿæ—¶ï¼Œä¼šè§¦å‘æ‰©å®¹æœºåˆ¶ï¼ˆæ‰©å¤§åˆ°å½“å‰çš„1.5å€ï¼‰ï¼Œéœ€è¦å°†åŸæ¥æ•°ç»„çš„æ•°æ®å¤åˆ¶åˆ°æ–°çš„æ•°ç»„ä¸­ï¼›å½“ä» ArrayList çš„ä¸­é—´ä½ç½®æ’å…¥æˆ–è€…åˆ é™¤å…ƒç´ æ—¶ï¼Œéœ€è¦å¯¹æ•°ç»„è¿›è¡Œå¤åˆ¶ã€ç§»åŠ¨ã€ä»£ä»·æ¯”è¾ƒé«˜ã€‚ LinkedListï¼š åº•å±‚åŸºäºåŒå‘é“¾è¡¨å®ç°ï¼Œé€‚åˆæ•°æ®çš„åŠ¨æ€æ’å…¥å’Œåˆ é™¤ï¼›â€‹ å†…éƒ¨æä¾›äº† List æ¥å£ä¸­æ²¡æœ‰å®šä¹‰çš„æ–¹æ³•ï¼Œç”¨äºæ“ä½œè¡¨å¤´å’Œè¡¨å°¾å…ƒç´ ï¼Œå¯ä»¥å½“ä½œå †æ ˆã€é˜Ÿåˆ—å’ŒåŒå‘é˜Ÿåˆ—ä½¿ç”¨ã€‚ï¼ˆæ¯”å¦‚jdkå®˜æ–¹æ¨èä½¿ç”¨åŸºäºlinkedListçš„Dequeè¿›è¡Œå †æ ˆæ“ä½œï¼‰ ArrayListä¸LinkedListåŒºåˆ«ï¼š éƒ½æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼ŒArrayList é€‚ç”¨äºæŸ¥æ‰¾çš„åœºæ™¯ï¼ŒLinkedList é€‚ç”¨äºå¢åŠ ã€åˆ é™¤å¤šçš„åœºæ™¯ å®ç°çº¿ç¨‹å®‰å…¨ï¼š å¯ä»¥ä½¿ç”¨åŸç”Ÿçš„Vectorï¼Œæˆ–è€…æ˜¯Collections.synchronizedList(List list)å‡½æ•°è¿”å›ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ArrayListé›†åˆã€‚â€‹ å»ºè®®ä½¿ç”¨concurrentå¹¶å‘åŒ…ä¸‹çš„CopyOnWriteArrayListçš„ã€‚ â‘ Vector: åº•å±‚é€šè¿‡synchronizeä¿®é¥°ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ•ˆç‡è¾ƒå·® â‘¡CopyOnWriteArrayListï¼šå†™æ—¶åŠ é”ï¼Œä½¿ç”¨äº†ä¸€ç§å«å†™æ—¶å¤åˆ¶çš„æ–¹æ³•ï¼›è¯»æ“ä½œæ˜¯å¯ä»¥ä¸ç”¨åŠ é”çš„ 2ã€Listéå†å¿«é€Ÿå’Œå®‰å…¨å¤±è´¥â‘ æ™®é€šforå¾ªç¯éå†Liståˆ é™¤æŒ‡å®šå…ƒç´  1234for(int i=0; i &lt; list.size(); i++){ if(list.get(i) == 5) list.remove(i);} â‘¡ è¿­ä»£éå†,ç”¨list.remove(i)æ–¹æ³•åˆ é™¤å…ƒç´  1234567Iterator&lt;Integer&gt; it = list.iterator();while(it.hasNext()){ Integer value = it.next(); if(value == 5){ list.remove(value); }} â‘¢foreachéå†Liståˆ é™¤å…ƒç´  123for(Integer i:list){ if(i==3) list.remove(i);} failâ€”fastï¼šå¿«é€Ÿå¤±è´¥ å½“å¼‚å¸¸äº§ç”Ÿæ—¶ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œç¨‹åºç»ˆæ­¢; fail-fastä¸»è¦æ˜¯ä½“ç°åœ¨å½“æˆ‘ä»¬åœ¨éå†é›†åˆå…ƒç´ çš„æ—¶å€™ï¼Œç»å¸¸ä¼šä½¿ç”¨è¿­ä»£å™¨ï¼Œä½†åœ¨è¿­ä»£å™¨éå†å…ƒç´ çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé›†åˆçš„ç»“æ„ï¼ˆmodCountï¼‰è¢«æ”¹å˜çš„è¯ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ConcurrentModificationExceptionï¼Œé˜²æ­¢ç»§ç»­éå†ã€‚è¿™å°±æ˜¯æ‰€è°“çš„å¿«é€Ÿå¤±è´¥æœºåˆ¶ã€‚ failâ€”safeï¼šå®‰å…¨å¤±è´¥ é‡‡ç”¨å®‰å…¨å¤±è´¥æœºåˆ¶çš„é›†åˆå®¹å™¨ï¼Œåœ¨éå†æ—¶ä¸æ˜¯ç›´æ¥åœ¨é›†åˆå†…å®¹ä¸Šè®¿é—®çš„ï¼Œè€Œæ˜¯å…ˆå¤åˆ¶åŸæœ‰é›†åˆå†…å®¹ï¼Œåœ¨æ‹·è´çš„é›†åˆä¸Šè¿›è¡Œéå†ã€‚ç”±äºåœ¨éå†è¿‡ç¨‹ä¸­å¯¹åŸé›†åˆæ‰€ä½œçš„ä¿®æ”¹å¹¶ä¸èƒ½è¢«è¿­ä»£å™¨æ£€æµ‹åˆ°ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘ConcurrentModificationExceptionã€‚ ç¼ºç‚¹ï¼šåŸºäºæ‹·è´å†…å®¹çš„ä¼˜ç‚¹æ˜¯é¿å…äº†ConcurrentModificationExceptionï¼Œä½†åŒæ ·åœ°ï¼Œè¿­ä»£å™¨å¹¶ä¸èƒ½è®¿é—®åˆ°ä¿®æ”¹åçš„å†…å®¹ï¼Œå³ï¼šè¿­ä»£å™¨éå†çš„æ˜¯å¼€å§‹éå†é‚£ä¸€åˆ»æ‹¿åˆ°çš„é›†åˆæ‹·è´ï¼Œåœ¨éå†æœŸé—´åŸé›†åˆå‘ç”Ÿçš„ä¿®æ”¹è¿­ä»£å™¨æ˜¯ä¸çŸ¥é“çš„ã€‚ åœºæ™¯ï¼šjava.util.concurrentåŒ…ä¸‹çš„å®¹å™¨éƒ½æ˜¯å®‰å…¨å¤±è´¥ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä½¿ç”¨ï¼Œå¹¶å‘ä¿®æ”¹ã€‚ 3ã€è¯¦ç»†ä»‹ç»HashMapè§’åº¦ï¼šæ•°æ®ç»“æ„+æ‰©å®¹æƒ…å†µ+putæŸ¥æ‰¾çš„è¯¦ç»†è¿‡ç¨‹+å“ˆå¸Œå‡½æ•°+å®¹é‡ä¸ºä»€ä¹ˆå§‹ç»ˆéƒ½æ˜¯2^Nï¼ŒJDK1.7ä¸1.8çš„åŒºåˆ«ã€‚ å‚è€ƒï¼šhttps://www.jianshu.com/p/9fe4cb316c05 æ•°æ®ç»“æ„ï¼š HashMapåœ¨åº•å±‚æ•°æ®ç»“æ„ä¸Šé‡‡ç”¨äº†æ•°ç»„ï¼‹é“¾è¡¨ï¼‹çº¢é»‘æ ‘ï¼Œé€šè¿‡æ•£åˆ—æ˜ å°„æ¥å­˜å‚¨é”®å€¼å¯¹æ•°æ® æ‰©å®¹æƒ…å†µï¼š é»˜è®¤çš„è´Ÿè½½å› å­æ˜¯0.75ï¼Œå¦‚æœæ•°ç»„ä¸­å·²ç»å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°å¤§äºæ•°ç»„é•¿åº¦çš„75%ï¼Œå°†ä¼šå¼•å‘æ‰©å®¹æ“ä½œã€‚ ã€1ã€‘åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸ºåŸæ¥æ•°ç»„é•¿åº¦ä¸¤å€çš„æ–°æ•°ç»„ã€‚ ã€2ã€‘1.7é‡‡ç”¨Entryçš„é‡æ–°hashè¿ç®—ï¼Œ1.8é‡‡ç”¨é«˜äºä¸è¿ç®—ã€‚ putæ“ä½œæ­¥éª¤ï¼š 1ã€åˆ¤æ–­æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¿›è¡Œåˆå§‹åŒ–; 2ã€ä¸ä¸ºç©ºï¼Œåˆ™è®¡ç®— key çš„ hash å€¼ï¼Œé€šè¿‡(n - 1) &amp; hashè®¡ç®—åº”å½“å­˜æ”¾åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡ index; 3ã€æŸ¥çœ‹ table[index] æ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œæ²¡æœ‰æ•°æ®å°±æ„é€ ä¸€ä¸ªNodeèŠ‚ç‚¹å­˜æ”¾åœ¨ table[index] ä¸­ï¼› 4ã€å­˜åœ¨æ•°æ®ï¼Œè¯´æ˜å‘ç”Ÿäº†hashå†²çª(å­˜åœ¨äºŒä¸ªèŠ‚ç‚¹keyçš„hashå€¼ä¸€æ ·), ç»§ç»­åˆ¤æ–­keyæ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰ï¼Œç”¨æ–°çš„valueæ›¿æ¢åŸæ•°æ®ï¼› 5ã€è‹¥ä¸ç›¸ç­‰ï¼Œåˆ¤æ–­å½“å‰èŠ‚ç‚¹ç±»å‹æ˜¯ä¸æ˜¯æ ‘å‹èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯æ ‘å‹èŠ‚ç‚¹ï¼Œåˆ›é€ æ ‘å‹èŠ‚ç‚¹æ’å…¥çº¢é»‘æ ‘ä¸­ï¼› 6ã€è‹¥ä¸æ˜¯çº¢é»‘æ ‘ï¼Œåˆ›å»ºæ™®é€šNodeåŠ å…¥é“¾è¡¨ä¸­ï¼›åˆ¤æ–­é“¾è¡¨é•¿åº¦æ˜¯å¦å¤§äº 8ï¼Œå¤§äºåˆ™å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼› 7ã€æ’å…¥å®Œæˆä¹‹ååˆ¤æ–­å½“å‰èŠ‚ç‚¹æ•°æ˜¯å¦å¤§äºé˜ˆå€¼ï¼Œè‹¥å¤§äºï¼Œåˆ™æ‰©å®¹ä¸ºåŸæ•°ç»„çš„äºŒå€ å“ˆå¸Œå‡½æ•°ï¼š é€šè¿‡hashå‡½æ•°ï¼ˆä¼˜è´¨å› å­31å¾ªç¯ç´¯åŠ ï¼‰å…ˆæ‹¿åˆ° key çš„hashcodeï¼Œæ˜¯ä¸€ä¸ª32ä½çš„å€¼ï¼Œç„¶åè®©hashcodeçš„é«˜16ä½å’Œä½16ä½è¿›è¡Œå¼‚æˆ–æ“ä½œã€‚è¯¥å‡½æ•°ä¹Ÿç§°ä¸ºæ‰°åŠ¨å‡½æ•°ï¼Œåšåˆ°å°½å¯èƒ½é™ä½hashç¢°æ’ï¼Œé€šè¿‡å°¾æ’æ³•è¿›è¡Œæ’å…¥ã€‚ å®¹é‡ä¸ºä»€ä¹ˆå§‹ç»ˆéƒ½æ˜¯2^Nï¼š å…ˆåšå¯¹æ•°ç»„çš„â»“åº¦å–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ä½™æ•°æ‰èƒ½â½¤æ¥è¦å­˜æ”¾çš„ä½ç½®ä¹Ÿå°±æ˜¯å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ã€‚è¿™ä¸ªæ•°ç»„ä¸‹æ ‡çš„è®¡ç®—â½…æ³•æ˜¯â€œ (n - 1) &amp; hash â€ã€‚ï¼ˆnä»£è¡¨æ•°ç»„â»“åº¦ï¼‰ã€‚æ–¹ä¾¿æ•°ç»„çš„æ‰©å®¹å’Œå¢åˆ æ”¹æ—¶çš„å–æ¨¡ã€‚ JDK1.7ä¸1.8çš„åŒºåˆ«ï¼š JDK1.7 HashMapï¼š åº•å±‚æ˜¯ æ•°ç»„å’Œé“¾è¡¨ ç»“åˆåœ¨â¼€èµ·ä½¿â½¤ä¹Ÿå°±æ˜¯é“¾è¡¨æ•£åˆ—ã€‚å¦‚æœç›¸åŒçš„è¯ï¼Œç›´æ¥è¦†ç›–ï¼Œä¸ç›¸åŒå°±é€šè¿‡æ‹‰é“¾æ³•è§£å†³å†²çªã€‚æ‰©å®¹ç¿»è½¬æ—¶é¡ºåºä¸ä¸€è‡´ä½¿ç”¨å¤´æ’æ³•ä¼šäº§ç”Ÿæ­»å¾ªç¯ï¼Œå¯¼è‡´cpu100% JDK1.8 HashMapï¼š åº•å±‚æ•°æ®ç»“æ„ä¸Šé‡‡ç”¨äº†æ•°ç»„ï¼‹é“¾è¡¨ï¼‹çº¢é»‘æ ‘ï¼›å½“é“¾è¡¨â»“åº¦â¼¤äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8-æ³Šæ¾åˆ†å¸ƒï¼‰ï¼Œæ•°ç»„çš„â»“åº¦å¤§äº 64æ—¶ï¼Œé“¾è¡¨å°†è½¬åŒ–ä¸ºçº¢â¿Šæ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚ï¼ˆè§£å†³äº†tomcatè‡­åæ˜­è‘—çš„urlå‚æ•°dosæ”»å‡»é—®é¢˜ï¼‰ **4ã€ConcurrentHashMap ** å¯ä»¥é€šè¿‡ConcurrentHashMap å’Œ Hashtableæ¥å®ç°çº¿ç¨‹å®‰å…¨ï¼›Hashtable æ˜¯åŸå§‹APIç±»ï¼Œé€šè¿‡synchronizeåŒæ­¥ä¿®é¥°ï¼Œæ•ˆç‡ä½ä¸‹ï¼›ConcurrentHashMap é€šè¿‡åˆ†æ®µé”å®ç°ï¼Œæ•ˆç‡è¾ƒæ¯”Hashtableè¦å¥½ï¼› ConcurrentHashMapçš„åº•å±‚å®ç°ï¼š JDK1.7çš„ ConcurrentHashMap åº•å±‚é‡‡â½¤ åˆ†æ®µçš„æ•°ç»„+é“¾è¡¨ å®ç°ï¼›é‡‡ç”¨ åˆ†æ®µé”ï¼ˆSagmentï¼‰ å¯¹æ•´ä¸ªæ¡¶æ•°ç»„è¿›â¾äº†åˆ†å‰²åˆ†æ®µ(Segmenté»˜è®¤16ä¸ª)ï¼Œæ¯â¼€æŠŠé”åªé”å®¹å™¨å…¶ä¸­â¼€éƒ¨åˆ†æ•°æ®ï¼Œå¤šçº¿ç¨‹è®¿é—®å®¹å™¨â¾¥ä¸åŒæ•°æ®æ®µçš„æ•°æ®ï¼Œå°±ä¸ä¼šå­˜åœ¨é”ç«äº‰ï¼Œæâ¾¼å¹¶å‘è®¿é—®ç‡ã€‚ JDK1.8çš„ ConcurrentHashMap é‡‡â½¤çš„æ•°æ®ç»“æ„è·ŸHashMap1.8çš„ç»“æ„â¼€æ ·ï¼Œæ•°ç»„+é“¾è¡¨/çº¢â¿Šæ ‘ï¼›æ‘’å¼ƒäº†Segmentçš„æ¦‚å¿µï¼Œâ½½æ˜¯ç›´æ¥â½¤ Node æ•°ç»„+é“¾è¡¨+çº¢â¿Šæ ‘çš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œé€šè¿‡å¹¶å‘æ§åˆ¶ synchronized å’ŒCASæ¥æ“ä½œä¿è¯çº¿ç¨‹çš„å®‰å…¨ã€‚ 5ã€åºåˆ—åŒ–å’Œååºåˆ—åŒ– åºåˆ—åŒ–çš„æ„æ€å°±æ˜¯å°†å¯¹è±¡çš„çŠ¶æ€è½¬åŒ–æˆå­—èŠ‚æµï¼Œä»¥åå¯ä»¥é€šè¿‡è¿™äº›å€¼å†ç”Ÿæˆç›¸åŒçŠ¶æ€çš„å¯¹è±¡ã€‚å¯¹è±¡åºåˆ—åŒ–æ˜¯å¯¹è±¡æŒä¹…åŒ–çš„ä¸€ç§å®ç°æ–¹æ³•ï¼Œå®ƒæ˜¯å°†å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•è½¬åŒ–ä¸ºä¸€ç§åºåˆ—åŒ–çš„å½¢å¼ç”¨äºå­˜å‚¨å’Œä¼ è¾“ã€‚ååºåˆ—åŒ–å°±æ˜¯æ ¹æ®è¿™äº›ä¿å­˜çš„ä¿¡æ¯é‡å»ºå¯¹è±¡çš„è¿‡ç¨‹ã€‚ åºåˆ—åŒ–ï¼šå°†javaå¯¹è±¡è½¬åŒ–ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ã€‚ ååºåˆ—åŒ–ï¼šå°†å­—èŠ‚åºåˆ—è½¬åŒ–ä¸ºjavaå¯¹è±¡çš„è¿‡ç¨‹ã€‚ ä¼˜ç‚¹ï¼š aã€å®ç°äº†æ•°æ®çš„æŒä¹…åŒ–ï¼Œé€šè¿‡åºåˆ—åŒ–å¯ä»¥æŠŠæ•°æ®æ°¸ä¹…åœ°ä¿å­˜åˆ°ç¡¬ç›˜ä¸Šï¼ˆé€šå¸¸å­˜æ”¾åœ¨æ–‡ä»¶é‡Œï¼‰Redisçš„RDB bã€åˆ©ç”¨åºåˆ—åŒ–å®ç°è¿œç¨‹é€šä¿¡ï¼Œå³åœ¨ç½‘ç»œä¸Šä¼ é€å¯¹è±¡çš„å­—èŠ‚åºåˆ—ã€‚ Googleçš„protoBuf ååºåˆ—åŒ–å¤±è´¥çš„åœºæ™¯ï¼š åºåˆ—åŒ–IDï¼šserialVersionUIDä¸ä¸€è‡´çš„æ—¶å€™ï¼Œå¯¼è‡´ååºåˆ—åŒ–å¤±è´¥ 6ã€StringString ä½¿ç”¨æ•°ç»„å­˜å‚¨å†…å®¹ï¼Œæ•°ç»„ä½¿ç”¨ final ä¿®é¥°ï¼Œå› æ­¤ String å®šä¹‰çš„å­—ç¬¦ä¸²çš„å€¼ä¹Ÿæ˜¯ä¸å¯å˜çš„ StringBuffer å¯¹æ–¹æ³•åŠ äº†åŒæ­¥é”ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œæ•ˆç‡ç•¥ä½äº StringBuilder è®¾è®¡æ¨¡å¼ä¸åŸåˆ™1ã€å•ä¾‹æ¨¡å¼ æŸä¸ªç±»åªèƒ½ç”Ÿæˆä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹å…¨å±€è®¿é—®ï¼Œä¾‹å¦‚Springå®¹å™¨é‡Œä¸€çº§ç¼“å­˜é‡Œçš„å•ä¾‹æ± ã€‚ ä¼˜ç‚¹ï¼š å”¯ä¸€è®¿é—®ï¼šå¦‚ç”Ÿæˆå”¯ä¸€åºåˆ—åŒ–çš„åœºæ™¯ã€æˆ–è€…springé»˜è®¤çš„beanç±»å‹ã€‚ æé«˜æ€§èƒ½ï¼šé¢‘ç¹å®ä¾‹åŒ–åˆ›å»ºé”€æ¯æˆ–è€…è€—æ—¶è€—èµ„æºçš„åœºæ™¯ï¼Œå¦‚è¿æ¥æ± ã€çº¿ç¨‹æ± ã€‚ ç¼ºç‚¹ï¼š ä¸é€‚åˆæœ‰çŠ¶æ€ä¸”éœ€å˜æ›´çš„ å®ç°æ–¹å¼ï¼š é¥¿æ±‰å¼ï¼šçº¿ç¨‹å®‰å…¨é€Ÿåº¦å¿« æ‡’æ±‰å¼ï¼šåŒé‡æ£€æµ‹é”ï¼Œç¬¬ä¸€æ¬¡å‡å°‘é”çš„å¼€é”€ã€ç¬¬äºŒæ¬¡é˜²æ­¢é‡å¤ã€volatileé˜²æ­¢é‡æ’åºå¯¼è‡´å®ä¾‹åŒ–æœªå®Œæˆ é™æ€å†…éƒ¨ç±»ï¼šçº¿ç¨‹å®‰å…¨åˆ©ç”¨ç‡é«˜ æšä¸¾ï¼šeffictiveJAVAæ¨èï¼Œåå°„ä¹Ÿæ— æ³•ç ´å 2ã€å·¥å‚æ¨¡å¼ å®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºäº§å“çš„æ¥å£ï¼Œç”±å­ç±»å†³å®šç”Ÿäº§ä½•ç§äº§å“ã€‚ ä¼˜ç‚¹ï¼šè§£è€¦ï¼šæä¾›å‚æ•°å³å¯è·å–äº§å“ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶å¯ä»¥ä¸ä¿®æ”¹ä»£ç å¢åŠ å…·ä½“äº§å“ã€‚ ç¼ºç‚¹ï¼šæ¯å¢åŠ ä¸€ä¸ªäº§å“å°±å¾—æ–°å¢ä¸€ä¸ªäº§å“ç±» 3ã€æŠ½è±¡å·¥å‚æ¨¡å¼ æä¾›ä¸€ä¸ªæ¥å£ï¼Œç”¨äºåˆ›å»ºç›¸å…³æˆ–è€…ä¾èµ–å¯¹è±¡çš„å®¶æ—ï¼Œå¹¶ç”±æ­¤è¿›è¡Œçº¦æŸã€‚ ä¼˜ç‚¹ï¼šå¯ä»¥åœ¨ç±»çš„å†…éƒ¨å¯¹äº§å“æ—è¿›è¡Œçº¦æŸ ç¼ºç‚¹ï¼šå‡å¦‚äº§å“æ—ä¸­éœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„äº§å“ï¼Œåˆ™å‡ ä¹æ‰€æœ‰çš„å·¥å‚ç±»éƒ½éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚ é¢è¯•é¢˜æ„é€ æ–¹æ³•æ„é€ æ–¹æ³•å¯ä»¥è¢«é‡è½½ï¼Œåªæœ‰å½“ç±»ä¸­æ²¡æœ‰æ˜¾æ€§å£°æ˜ä»»ä½•æ„é€ æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæœ‰é»˜è®¤æ„é€ æ–¹æ³•ã€‚ æ„é€ æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œæ„é€ æ–¹æ³•çš„ä½œç”¨æ˜¯åˆ›å»ºæ–°å¯¹è±¡ã€‚ åˆå§‹åŒ–å—é™æ€åˆå§‹åŒ–å—çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¼šæœ€å…ˆæ‰§è¡Œï¼Œåœ¨éé™æ€åˆå§‹åŒ–å—ä¹‹å‰æ‰§è¡Œã€‚ é™æ€åˆå§‹åŒ–å—ä¼šåœ¨ç±»ç¬¬ä¸€æ¬¡è¢«åŠ è½½æ—¶æœ€å…ˆæ‰§è¡Œï¼Œå› æ­¤åœ¨ main æ–¹æ³•ä¹‹å‰ã€‚ Thiså…³é”®å­— this ä»£è¡¨å½“å‰å¯¹è±¡çš„å¼•ç”¨ã€‚å½“å‰å¯¹è±¡æŒ‡çš„æ˜¯è°ƒç”¨ç±»ä¸­çš„å±æ€§æˆ–æ–¹æ³•çš„å¯¹è±¡ å…³é”®å­— this ä¸å¯ä»¥åœ¨é™æ€æ–¹æ³•ä¸­ä½¿ç”¨ã€‚é™æ€æ–¹æ³•ä¸ä¾èµ–äºç±»çš„å…·ä½“å¯¹è±¡çš„å¼•ç”¨ é‡å†™Overrideå’Œé‡è½½Overloadçš„åŒºåˆ«é‡è½½æŒ‡åœ¨åŒä¸€ä¸ªç±»ä¸­å®šä¹‰å¤šä¸ªæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åç§°ç›¸åŒï¼Œç­¾åä¸åŒã€‚**(å‚æ•°åˆ—è¡¨å¿…é¡»æ”¹ï¼Œå…¶ä»–æ— è¦æ±‚)** é‡å†™æŒ‡åœ¨å­ç±»ä¸­çš„æ–¹æ³•çš„åç§°å’Œç­¾åéƒ½å’Œçˆ¶ç±»ç›¸åŒï¼Œä½¿ç”¨overrideæ³¨è§£ã€‚**(å‚æ•°å’Œè¿”å›ä¸èƒ½æ”¹ï¼Œå…¶ä»–ä¸èƒ½å‡çº§)** åŒºåˆ«ç‚¹ é‡è½½æ–¹æ³• é‡å†™æ–¹æ³• å‚æ•°åˆ—è¡¨ å¿…é¡»ä¿®æ”¹ ä¸€å®šä¸èƒ½ä¿®æ”¹ è¿”å›ç±»å‹ å¯ä»¥ä¿®æ”¹ ä¸€å®šä¸èƒ½ä¿®æ”¹ å¼‚å¸¸ å¯ä»¥ä¿®æ”¹ å¯ä»¥å‡å°‘æˆ–åˆ é™¤ï¼Œä¸€å®šä¸èƒ½æŠ›å‡ºæ–°çš„æˆ–è€…æ›´å¹¿çš„å¼‚å¸¸ è®¿é—® å¯ä»¥ä¿®æ”¹ ä¸€å®šä¸èƒ½åšæ›´ä¸¥æ ¼çš„é™åˆ¶ï¼ˆå¯ä»¥é™ä½é™åˆ¶ï¼‰ Objectç±»æ–¹æ³•toString é»˜è®¤æ˜¯ä¸ªæŒ‡é’ˆï¼Œä¸€èˆ¬éœ€è¦é‡å†™ equals æ¯”è¾ƒå¯¹è±¡æ˜¯å¦ç›¸åŒï¼Œé»˜è®¤å’Œ==åŠŸèƒ½ä¸€è‡´ hashCode æ•£åˆ—ç ï¼Œequalsåˆ™hashCodeç›¸åŒï¼Œæ‰€ä»¥é‡å†™equalså¿…é¡»é‡å†™hashCode **finalize ** ç”¨äºåƒåœ¾å›æ”¶ä¹‹å‰åšçš„é—å˜±ï¼Œé»˜è®¤ç©ºï¼Œå­ç±»éœ€é‡å†™ clone æ·±æ‹·è´ï¼Œç±»éœ€å®ç°cloneableçš„æ¥å£ getClass åå°„è·å–å¯¹è±¡å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ç±»åã€æ–¹æ³•ã€ notifyã€wait ç”¨äºçº¿ç¨‹é€šçŸ¥å’Œå”¤é†’ åŸºæœ¬æ•°æ®ç±»å‹å’ŒåŒ…è£…ç±» ç±»å‹ ç¼“å­˜èŒƒå›´ Byte,Short,Integer,Long [-128, 127] Character [0, 127] Boolean [false, true] JVM-DOC-DataType primitive values and reference values. 2.3. Primitive Types and ValuesThe primitive data types supported by the Java Virtual Machine are the numeric types, the boolean type (Â§2.3.4), and the returnAddress type (Â§2.3.3). The numeric types consist of the integral types (Â§2.3.1) and the floating-point types (Â§2.3.2). The integral types are: byte, whose values are 8-bit signed twoâ€™s-complement integers, and whose default value is zero short, whose values are 16-bit signed twoâ€™s-complement integers, and whose default value is zero int, whose values are 32-bit signed twoâ€™s-complement integers, and whose default value is zero long, whose values are 64-bit signed twoâ€™s-complement integers, and whose default value is zero char, whose values are 16-bit unsigned integers representing Unicode code points in the Basic Multilingual Plane, encoded with UTF-16, and whose default value is the null code point ('\\u0000') The floating-point types are: float, whose values are elements of the float value set or, where supported, the float-extended-exponent value set, and whose default value is positive zero double, whose values are elements of the double value set or, where supported, the double-extended-exponent value set, and whose default value is positive zero 2.4. Reference Types and ValuesThere are three kinds of reference types: class types, array types, and interface types. Their values are references to dynamically created class instances, arrays, or class instances or arrays that implement interfaces, respectively.","link":"/2022/01/10/Java/"},{"title":"Linux","text":"è¿›ç¨‹åˆ‡æ¢ä»€ä¹ˆæ˜¯ CPU ä¸Šä¸‹æ–‡CPU å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨å°±æ˜¯ CPU ä¸Šä¸‹æ–‡ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯ CPU åœ¨è¿è¡Œä»»ä½•ä»»åŠ¡å‰ï¼Œå¿…é¡»çš„ä¾èµ–ç¯å¢ƒã€‚ CPU å¯„å­˜å™¨æ˜¯ CPU å†…ç½®çš„å®¹é‡å°ã€ä½†é€Ÿåº¦æå¿«çš„å†…å­˜ã€‚ ç¨‹åºè®¡æ•°å™¨åˆ™æ˜¯ç”¨æ¥å­˜å‚¨ CPU æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤ä½ç½®ã€æˆ–è€…å³å°†æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ä½ç½®ã€‚ ä»€ä¹ˆæ˜¯ CPU ä¸Šä¸‹æ–‡åˆ‡æ¢å°±æ˜¯å…ˆæŠŠå‰ä¸€ä¸ªä»»åŠ¡çš„ CPU ä¸Šä¸‹æ–‡ï¼ˆä¹Ÿå°±æ˜¯ CPU å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨ï¼‰ä¿å­˜èµ·æ¥ï¼Œç„¶ååŠ è½½æ–°ä»»åŠ¡çš„ä¸Šä¸‹æ–‡åˆ°è¿™äº›å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨ï¼Œæœ€åå†è·³è½¬åˆ°ç¨‹åºè®¡æ•°å™¨æ‰€æŒ‡çš„æ–°ä½ç½®ï¼Œè¿è¡Œæ–°ä»»åŠ¡ã€‚ è€Œè¿™äº›ä¿å­˜ä¸‹æ¥çš„ä¸Šä¸‹æ–‡ï¼Œä¼šå­˜å‚¨åœ¨ç³»ç»Ÿå†…æ ¸ä¸­ï¼Œå¹¶åœ¨ä»»åŠ¡é‡æ–°è°ƒåº¦æ‰§è¡Œæ—¶å†æ¬¡åŠ è½½è¿›æ¥ã€‚è¿™æ ·å°±èƒ½ä¿è¯ä»»åŠ¡åŸæ¥çš„çŠ¶æ€ä¸å—å½±å“ï¼Œè®©ä»»åŠ¡çœ‹èµ·æ¥è¿˜æ˜¯è¿ç»­è¿è¡Œã€‚ CPU ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ç±»å‹æ ¹æ®ä»»åŠ¡çš„ä¸åŒï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹ - è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ - çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ - ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢ è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢Linux æŒ‰ç…§ç‰¹æƒç­‰çº§ï¼ŒæŠŠè¿›ç¨‹çš„è¿è¡Œç©ºé—´åˆ†ä¸ºå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ï¼Œåˆ†åˆ«å¯¹åº”ç€ä¸‹å›¾ä¸­ï¼Œ CPU ç‰¹æƒç­‰çº§çš„ Ring 0 å’Œ Ring 3ã€‚ å†…æ ¸ç©ºé—´ï¼ˆRing 0ï¼‰å…·æœ‰æœ€é«˜æƒé™ï¼Œå¯ä»¥ç›´æ¥è®¿é—®æ‰€æœ‰èµ„æºï¼› ç”¨æˆ·ç©ºé—´ï¼ˆRing 3ï¼‰åªèƒ½è®¿é—®å—é™èµ„æºï¼Œä¸èƒ½ç›´æ¥è®¿é—®å†…å­˜ç­‰ç¡¬ä»¶è®¾å¤‡ï¼Œå¿…é¡»é€šè¿‡ç³»ç»Ÿè°ƒç”¨é™·å…¥åˆ°å†…æ ¸ä¸­ï¼Œæ‰èƒ½è®¿é—®è¿™äº›ç‰¹æƒèµ„æºã€‚ è¿›ç¨‹æ—¢å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œï¼Œåˆå¯ä»¥åœ¨å†…æ ¸ç©ºé—´ä¸­è¿è¡Œã€‚è¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œæ—¶ï¼Œè¢«ç§°ä¸ºè¿›ç¨‹çš„ç”¨æˆ·æ€ï¼Œè€Œé™·å…¥å†…æ ¸ç©ºé—´çš„æ—¶å€™ï¼Œè¢«ç§°ä¸ºè¿›ç¨‹çš„å†…æ ¸æ€ã€‚ ç³»ç»Ÿè°ƒç”¨ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„è½¬å˜ï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆã€‚æ¯”å¦‚ï¼Œå½“æˆ‘ä»¬æŸ¥çœ‹æ–‡ä»¶å†…å®¹æ—¶ï¼Œå°±éœ€è¦å¤šæ¬¡ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆï¼šé¦–å…ˆè°ƒç”¨ open() æ‰“å¼€æ–‡ä»¶ï¼Œç„¶åè°ƒç”¨ read() è¯»å–æ–‡ä»¶å†…å®¹ï¼Œå¹¶è°ƒç”¨ write() å°†å†…å®¹å†™åˆ°æ ‡å‡†è¾“å‡ºï¼Œæœ€åå†è°ƒç”¨ close() å…³é—­æ–‡ä»¶ã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å°±å‘ç”Ÿäº† CPU ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š1ã€ä¿å­˜ CPU å¯„å­˜å™¨é‡ŒåŸæ¥ç”¨æˆ·æ€çš„æŒ‡ä»¤ä½2ã€ä¸ºäº†æ‰§è¡Œå†…æ ¸æ€ä»£ç ï¼ŒCPU å¯„å­˜å™¨éœ€è¦æ›´æ–°ä¸ºå†…æ ¸æ€æŒ‡ä»¤çš„æ–°ä½ç½®ã€‚3ã€è·³è½¬åˆ°å†…æ ¸æ€è¿è¡Œå†…æ ¸ä»»åŠ¡ã€‚4ã€å½“ç³»ç»Ÿè°ƒç”¨ç»“æŸåï¼ŒCPU å¯„å­˜å™¨éœ€è¦æ¢å¤åŸæ¥ä¿å­˜çš„ç”¨æˆ·æ€ï¼Œç„¶åå†åˆ‡æ¢åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç»§ç»­è¿è¡Œè¿›ç¨‹ã€‚ æ‰€ä»¥ï¼Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ï¼Œå…¶å®æ˜¯å‘ç”Ÿäº†ä¸¤æ¬¡ CPU ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ï¼ˆç”¨æˆ·æ€-å†…æ ¸æ€-ç”¨æˆ·æ€ï¼‰ ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸ä¼šæ¶‰åŠåˆ°è™šæ‹Ÿå†…å­˜ç­‰è¿›ç¨‹ç”¨æˆ·æ€çš„èµ„æºï¼Œä¹Ÿä¸ä¼šåˆ‡æ¢è¿›ç¨‹ã€‚è¿™è·Ÿæˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯ä¸ä¸€æ ·çš„ï¼šè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ˜¯æŒ‡ä»ä¸€ä¸ªè¿›ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹è¿è¡Œï¼›è€Œç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ä¸­ä¸€ç›´æ˜¯åŒä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œã€‚ æ‰€ä»¥ï¼Œç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹é€šå¸¸ç§°ä¸ºç‰¹æƒæ¨¡å¼åˆ‡æ¢ï¼Œè€Œä¸æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ç³»ç»Ÿè°ƒç”¨å±äºåŒè¿›ç¨‹å†…çš„ CPU ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ä½†å®é™…ä¸Šï¼Œç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ä¸­ï¼ŒCPU çš„ä¸Šä¸‹æ–‡åˆ‡æ¢è¿˜æ˜¯æ— æ³•é¿å…çš„ã€‚ è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢è·Ÿç³»ç»Ÿè°ƒç”¨åˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢é¦–å…ˆï¼Œè¿›ç¨‹æ˜¯ç”±å†…æ ¸æ¥ç®¡ç†å’Œè°ƒåº¦çš„ï¼Œè¿›ç¨‹çš„åˆ‡æ¢åªèƒ½å‘ç”Ÿåœ¨å†…æ ¸æ€ã€‚æ‰€ä»¥ï¼Œè¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸ä»…åŒ…æ‹¬äº†è™šæ‹Ÿå†…å­˜ã€æ ˆã€å…¨å±€å˜é‡ç­‰ç”¨æˆ·ç©ºé—´çš„èµ„æºï¼Œè¿˜åŒ…æ‹¬äº†å†…æ ¸å †æ ˆã€å¯„å­˜å™¨ç­‰å†…æ ¸ç©ºé—´çš„çŠ¶æ€ã€‚ å› æ­¤ï¼Œè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å°±æ¯”ç³»ç»Ÿè°ƒç”¨æ—¶å¤šäº†ä¸€æ­¥ï¼šåœ¨ä¿å­˜å†…æ ¸æ€èµ„æºï¼ˆå½“å‰è¿›ç¨‹çš„å†…æ ¸çŠ¶æ€å’Œ CPU å¯„å­˜å™¨ï¼‰ä¹‹å‰ï¼Œéœ€è¦å…ˆæŠŠè¯¥è¿›ç¨‹çš„ç”¨æˆ·æ€èµ„æºï¼ˆè™šæ‹Ÿå†…å­˜ã€æ ˆç­‰ï¼‰ä¿å­˜ä¸‹æ¥ï¼›è€ŒåŠ è½½äº†ä¸‹ä¸€è¿›ç¨‹çš„å†…æ ¸æ€åï¼Œè¿˜éœ€è¦åˆ·æ–°è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å’Œç”¨æˆ·æ ˆã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¿å­˜ä¸Šä¸‹æ–‡å’Œæ¢å¤ä¸Šä¸‹æ–‡çš„è¿‡ç¨‹å¹¶ä¸æ˜¯â€œå…è´¹â€çš„ï¼Œéœ€è¦å†…æ ¸åœ¨ CPU ä¸Šè¿è¡Œæ‰èƒ½å®Œæˆã€‚ è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ½œåœ¨çš„æ€§èƒ½é—®é¢˜æ ¹æ® Tsuna çš„æµ‹è¯•æŠ¥å‘Šï¼Œæ¯æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢éƒ½éœ€è¦å‡ åçº³ç§’åˆ°æ•°å¾®ç§’çš„ CPU æ—¶é—´ã€‚è¿™ä¸ªæ—¶é—´è¿˜æ˜¯ç›¸å½“å¯è§‚çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´ CPU å°†å¤§é‡æ—¶é—´è€—è´¹åœ¨å¯„å­˜å™¨ã€å†…æ ¸æ ˆä»¥åŠè™šæ‹Ÿå†…å­˜ç­‰èµ„æºçš„ä¿å­˜å’Œæ¢å¤ä¸Šï¼Œè¿›è€Œå¤§å¤§ç¼©çŸ­äº†çœŸæ­£è¿è¡Œè¿›ç¨‹çš„æ—¶é—´ã€‚è¿™ä¹Ÿæ­£æ˜¯å¯¼è‡´å¹³å‡è´Ÿè½½å‡é«˜çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚ å¦å¤–ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œ Linux é€šè¿‡ TLBï¼ˆTranslation Lookaside Bufferï¼‰æ¥ç®¡ç†è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„å…³ç³»ã€‚å½“è™šæ‹Ÿå†…å­˜æ›´æ–°åï¼ŒTLB ä¹Ÿéœ€è¦åˆ·æ–°ï¼Œå†…å­˜çš„è®¿é—®ä¹Ÿä¼šéšä¹‹å˜æ…¢ã€‚ç‰¹åˆ«æ˜¯åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šï¼Œç¼“å­˜æ˜¯è¢«å¤šä¸ªå¤„ç†å™¨å…±äº«çš„ï¼Œåˆ·æ–°ç¼“å­˜ä¸ä»…ä¼šå½±å“å½“å‰å¤„ç†å™¨çš„è¿›ç¨‹ï¼Œè¿˜ä¼šå½±å“å…±äº«ç¼“å­˜çš„å…¶ä»–å¤„ç†å™¨çš„è¿›ç¨‹ã€‚ å‘ç”Ÿè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„åœºæ™¯ ä¸ºäº†ä¿è¯æ‰€æœ‰è¿›ç¨‹å¯ä»¥å¾—åˆ°å…¬å¹³è°ƒåº¦ï¼ŒCPU æ—¶é—´è¢«åˆ’åˆ†ä¸ºä¸€æ®µæ®µçš„æ—¶é—´ç‰‡ï¼Œè¿™äº›æ—¶é—´ç‰‡å†è¢«è½®æµåˆ†é…ç»™å„ä¸ªè¿›ç¨‹ã€‚è¿™æ ·ï¼Œå½“æŸä¸ªè¿›ç¨‹çš„æ—¶é—´ç‰‡è€—å°½äº†ï¼Œå°±ä¼šè¢«ç³»ç»ŸæŒ‚èµ·ï¼Œåˆ‡æ¢åˆ°å…¶å®ƒæ­£åœ¨ç­‰å¾… CPU çš„è¿›ç¨‹è¿è¡Œã€‚ è¿›ç¨‹åœ¨ç³»ç»Ÿèµ„æºä¸è¶³ï¼ˆæ¯”å¦‚å†…å­˜ä¸è¶³ï¼‰æ—¶ï¼Œè¦ç­‰åˆ°èµ„æºæ»¡è¶³åæ‰å¯ä»¥è¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™è¿›ç¨‹ä¹Ÿä¼šè¢«æŒ‚èµ·ï¼Œå¹¶ç”±ç³»ç»Ÿè°ƒåº¦å…¶ä»–è¿›ç¨‹è¿è¡Œã€‚ å½“è¿›ç¨‹é€šè¿‡ç¡çœ å‡½æ•° sleep è¿™æ ·çš„æ–¹æ³•å°†è‡ªå·±ä¸»åŠ¨æŒ‚èµ·æ—¶ï¼Œè‡ªç„¶ä¹Ÿä¼šé‡æ–°è°ƒåº¦ã€‚ å½“æœ‰ä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹è¿è¡Œæ—¶ï¼Œä¸ºäº†ä¿è¯é«˜ä¼˜å…ˆçº§è¿›ç¨‹çš„è¿è¡Œï¼Œå½“å‰è¿›ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç”±é«˜ä¼˜å…ˆçº§è¿›ç¨‹æ¥è¿è¡Œ å‘ç”Ÿç¡¬ä»¶ä¸­æ–­æ—¶ï¼ŒCPU ä¸Šçš„è¿›ç¨‹ä¼šè¢«ä¸­æ–­æŒ‚èµ·ï¼Œè½¬è€Œæ‰§è¡Œå†…æ ¸ä¸­çš„ä¸­æ–­æœåŠ¡ç¨‹åºã€‚ çº¿ç¨‹åˆ‡æ¢çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çº¿ç¨‹ä¸è¿›ç¨‹æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šçº¿ç¨‹æ˜¯è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œè€Œè¿›ç¨‹åˆ™æ˜¯èµ„æºæ‹¥æœ‰çš„åŸºæœ¬å•ä½ã€‚è¯´ç™½äº†ï¼Œæ‰€è°“å†…æ ¸ä¸­çš„ä»»åŠ¡è°ƒåº¦ï¼Œå®é™…ä¸Šçš„è°ƒåº¦å¯¹è±¡æ˜¯çº¿ç¨‹ï¼›è€Œè¿›ç¨‹åªæ˜¯ç»™çº¿ç¨‹æä¾›äº†è™šæ‹Ÿå†…å­˜ã€å…¨å±€å˜é‡ç­‰èµ„æºã€‚ æ‰€ä»¥ï¼Œå¯¹äºçº¿ç¨‹å’Œè¿›ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆç†è§£ï¼š - å½“è¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œå¯ä»¥è®¤ä¸ºè¿›ç¨‹å°±ç­‰äºçº¿ç¨‹ã€‚ - å½“è¿›ç¨‹æ‹¥æœ‰å¤šä¸ªçº¿ç¨‹æ—¶ï¼Œè¿™äº›çº¿ç¨‹ä¼šå…±äº«ç›¸åŒçš„è™šæ‹Ÿå†…å­˜å’Œå…¨å±€å˜é‡ç­‰èµ„æºã€‚è¿™äº›èµ„æºåœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶æ˜¯ä¸éœ€è¦ä¿®æ”¹çš„ã€‚ - å¦å¤–ï¼Œçº¿ç¨‹ä¹Ÿæœ‰è‡ªå·±çš„ç§æœ‰æ•°æ®ï¼Œæ¯”å¦‚æ ˆå’Œå¯„å­˜å™¨ç­‰ï¼Œè¿™äº›åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ä¹Ÿæ˜¯éœ€è¦ä¿å­˜çš„ã€‚ å‘ç”Ÿçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„åœºæ™¯ å‰åä¸¤ä¸ªçº¿ç¨‹å±äºä¸åŒè¿›ç¨‹ã€‚æ­¤æ—¶ï¼Œå› ä¸ºèµ„æºä¸å…±äº«ï¼Œæ‰€ä»¥åˆ‡æ¢è¿‡ç¨‹å°±è·Ÿè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯ä¸€æ ·ã€‚ å‰åä¸¤ä¸ªçº¿ç¨‹å±äºåŒä¸€ä¸ªè¿›ç¨‹ã€‚æ­¤æ—¶ï¼Œå› ä¸ºè™šæ‹Ÿå†…å­˜æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥åœ¨åˆ‡æ¢æ—¶ï¼Œè™šæ‹Ÿå†…å­˜è¿™äº›èµ„æºå°±ä¿æŒä¸åŠ¨ï¼Œåªéœ€è¦åˆ‡æ¢çº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€å¯„å­˜å™¨ç­‰ä¸å…±äº«çš„æ•°æ® ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸ºäº†å¿«é€Ÿå“åº”ç¡¬ä»¶çš„äº‹ä»¶ï¼Œä¸­æ–­å¤„ç†ä¼šæ‰“æ–­è¿›ç¨‹çš„æ­£å¸¸è°ƒåº¦å’Œæ‰§è¡Œï¼Œè½¬è€Œè°ƒç”¨ä¸­æ–­å¤„ç†ç¨‹åºï¼Œå“åº”è®¾å¤‡äº‹ä»¶ã€‚è€Œåœ¨æ‰“æ–­å…¶ä»–è¿›ç¨‹æ—¶ï¼Œå°±éœ€è¦å°†è¿›ç¨‹å½“å‰çš„çŠ¶æ€ä¿å­˜ä¸‹æ¥ï¼Œè¿™æ ·åœ¨ä¸­æ–­ç»“æŸåï¼Œè¿›ç¨‹ä»ç„¶å¯ä»¥ä»åŸæ¥çš„çŠ¶æ€æ¢å¤è¿è¡Œã€‚ è·Ÿè¿›ç¨‹ä¸Šä¸‹æ–‡ä¸åŒï¼Œä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢å¹¶ä¸æ¶‰åŠåˆ°è¿›ç¨‹çš„ç”¨æˆ·æ€ã€‚æ‰€ä»¥ï¼Œå³ä¾¿ä¸­æ–­è¿‡ç¨‹æ‰“æ–­äº†ä¸€ä¸ªæ­£å¤„åœ¨ç”¨æˆ·æ€çš„è¿›ç¨‹ï¼Œä¹Ÿä¸éœ€è¦ä¿å­˜å’Œæ¢å¤è¿™ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ã€å…¨å±€å˜é‡ç­‰ç”¨æˆ·æ€èµ„æºã€‚ä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œå…¶å®åªåŒ…æ‹¬å†…æ ¸æ€ä¸­æ–­æœåŠ¡ç¨‹åºæ‰§è¡Œæ‰€å¿…éœ€çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬ CPU å¯„å­˜å™¨ã€å†…æ ¸å †æ ˆã€ç¡¬ä»¶ä¸­æ–­å‚æ•°ç­‰ã€‚ å¯¹åŒä¸€ä¸ª CPU æ¥è¯´ï¼Œä¸­æ–­å¤„ç†æ¯”è¿›ç¨‹æ‹¥æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œæ‰€ä»¥ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢å¹¶ä¸ä¼šä¸è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢åŒæ—¶å‘ç”Ÿã€‚åŒæ ·é“ç†ï¼Œç”±äºä¸­æ–­ä¼šæ‰“æ–­æ­£å¸¸è¿›ç¨‹çš„è°ƒåº¦å’Œæ‰§è¡Œï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†ä¸­æ–­å¤„ç†ç¨‹åºéƒ½çŸ­å°ç²¾æ‚ï¼Œä»¥ä¾¿å°½å¯èƒ½å¿«çš„æ‰§è¡Œç»“æŸã€‚ å¦å¤–ï¼Œè·Ÿè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸€æ ·ï¼Œä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢ä¹Ÿéœ€è¦æ¶ˆè€— CPUï¼Œåˆ‡æ¢æ¬¡æ•°è¿‡å¤šä¹Ÿä¼šè€—è´¹å¤§é‡çš„ CPUï¼Œç”šè‡³ä¸¥é‡é™ä½ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚æ‰€ä»¥ï¼Œå½“ä½ å‘ç°ä¸­æ–­æ¬¡æ•°è¿‡å¤šæ—¶ï¼Œå°±éœ€è¦æ³¨æ„å»æ’æŸ¥å®ƒæ˜¯å¦ä¼šç»™ä½ çš„ç³»ç»Ÿå¸¦æ¥ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚","link":"/2022/01/24/Linux/"},{"title":"MVXArchitecture","text":"MVC Viewï¼šXMLå¸ƒå±€æ–‡ä»¶ã€‚ Modelï¼šå®ä½“æ¨¡å‹ï¼ˆæ•°æ®çš„è·å–ã€å­˜å‚¨ã€æ•°æ®çŠ¶æ€å˜åŒ–ï¼‰ã€‚ Controllerï¼šå¯¹åº”äºActivityï¼Œå¤„ç†æ•°æ®ã€ä¸šåŠ¡å’ŒUIã€‚ ä»ä¸Šé¢è¿™ä¸ªç»“æ„æ¥çœ‹ï¼ŒAndroidæœ¬èº«çš„è®¾è®¡è¿˜æ˜¯ç¬¦åˆMVCæ¶æ„çš„ï¼Œä½†æ˜¯Androidä¸­çº¯ç²¹ä½œä¸ºViewçš„XMLè§†å›¾åŠŸèƒ½å¤ªå¼±ï¼Œæˆ‘ä»¬å¤§é‡å¤„ç†Viewçš„é€»è¾‘åªèƒ½å†™åœ¨Activityä¸­ï¼Œè¿™æ ·Activityå°±å……å½“äº†Viewå’ŒControllerä¸¤ä¸ªè§’è‰²ï¼Œç›´æ¥å¯¼è‡´Activityä¸­çš„ä»£ç å¤§çˆ†ç‚¸ã€‚ç›¸ä¿¡å¤§å¤šæ•°Androidå¼€å‘è€…éƒ½é‡åˆ°è¿‡ä¸€ä¸ªAcitivtyæ•°ä»¥åƒè¡Œçš„ä»£ç æƒ…å†µå§ï¼æ‰€ä»¥ï¼Œæ›´è´´åˆ‡çš„è¯´æ³•æ˜¯ï¼Œè¿™ä¸ªMVCç»“æ„æœ€ç»ˆå…¶å®åªæ˜¯ä¸€ä¸ªModel-Viewï¼ˆActivity:View&amp;Controllerï¼‰çš„ç»“æ„ã€‚ MVP **View: **å¯¹åº”äºActivityå’ŒXMLï¼Œè´Ÿè´£Viewçš„ç»˜åˆ¶ä»¥åŠä¸ç”¨æˆ·çš„äº¤äº’ã€‚ **Model: **ä¾ç„¶æ˜¯å®ä½“æ¨¡å‹ã€‚ **Presenter: **è´Ÿè´£å®ŒæˆViewä¸Modelé—´çš„äº¤äº’å’Œä¸šåŠ¡é€»è¾‘ã€‚ å‰é¢æˆ‘ä»¬è¯´ï¼ŒActivityå……å½“äº†Viewå’ŒControllerä¸¤ä¸ªè§’è‰²ï¼ŒMVPå°±èƒ½å¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…¶æ ¸å¿ƒç†å¿µæ˜¯é€šè¿‡ä¸€ä¸ªæŠ½è±¡çš„Viewæ¥å£ï¼ˆä¸æ˜¯çœŸæ­£çš„Viewå±‚ï¼‰å°†Presenterä¸çœŸæ­£çš„Viewå±‚è¿›è¡Œè§£è€¦ã€‚PersenteræŒæœ‰è¯¥Viewæ¥å£ï¼Œå¯¹è¯¥æ¥å£è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œViewå±‚ã€‚è¿™æ ·å°±å¯ä»¥æŠŠè§†å›¾æ“ä½œå’Œä¸šåŠ¡é€»è¾‘è§£è€¦ï¼Œä»è€Œè®©Activityæˆä¸ºçœŸæ­£çš„Viewå±‚ã€‚ ä½†MVPä¹Ÿå­˜åœ¨ä¸€äº›å¼Šç«¯ï¼š Presenterï¼ˆä»¥ä¸‹ç®€ç§°Pï¼‰å±‚ä¸Viewï¼ˆä»¥ä¸‹ç®€ç§°Vï¼‰å±‚æ˜¯é€šè¿‡æ¥å£è¿›è¡Œäº¤äº’çš„ï¼Œæ¥å£ç²’åº¦ä¸å¥½æ§åˆ¶ã€‚ç²’åº¦å¤ªå°ï¼Œå°±ä¼šå­˜åœ¨å¤§é‡æ¥å£çš„æƒ…å†µï¼Œä½¿ä»£ç å¤ªè¿‡ç¢ç‰ˆåŒ–ï¼›ç²’åº¦å¤ªå¤§ï¼Œè§£è€¦æ•ˆæœä¸å¥½ã€‚åŒæ—¶å¯¹äºUIçš„è¾“å…¥å’Œæ•°æ®çš„å˜åŒ–ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨Vå±‚æˆ–è€…På±‚ç›¸å…³çš„æ¥å£ï¼Œç›¸å¯¹æ¥è¯´ç¼ºä¹è‡ªåŠ¨æ€§ã€ç›‘å¬æ€§ã€‚å¦‚æœæ•°æ®çš„å˜åŒ–èƒ½è‡ªåŠ¨å“åº”åˆ°UIã€UIçš„è¾“å…¥èƒ½è‡ªåŠ¨æ›´æ–°åˆ°æ•°æ®ï¼Œé‚£è¯¥å¤šå¥½ï¼ MVPæ˜¯ä»¥UIä¸ºé©±åŠ¨çš„æ¨¡å‹ï¼Œæ›´æ–°UIéƒ½éœ€è¦ä¿è¯èƒ½è·å–åˆ°æ§ä»¶çš„å¼•ç”¨ï¼ŒåŒæ—¶æ›´æ–°UIçš„æ—¶å€™è¦è€ƒè™‘å½“å‰æ˜¯å¦æ˜¯UIçº¿ç¨‹ï¼Œä¹Ÿè¦è€ƒè™‘Activityçš„ç”Ÿå‘½å‘¨æœŸï¼ˆæ˜¯å¦å·²ç»é”€æ¯ç­‰ï¼‰ã€‚ MVPæ˜¯ä»¥UIå’Œäº‹ä»¶ä¸ºé©±åŠ¨çš„ä¼ ç»Ÿæ¨¡å‹ï¼Œæ•°æ®éƒ½æ˜¯è¢«åŠ¨åœ°é€šè¿‡UIæ§ä»¶åšå±•ç¤ºï¼Œä½†æ˜¯ç”±äºæ•°æ®çš„æ—¶å˜æ€§ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›æ•°æ®èƒ½è½¬è¢«åŠ¨ä¸ºä¸»åŠ¨ï¼Œå¸Œæœ›æ•°æ®èƒ½æ›´æœ‰æ´»æ€§ï¼Œç”±æ•°æ®æ¥é©±åŠ¨UIã€‚ Vå±‚ä¸På±‚è¿˜æ˜¯æœ‰ä¸€å®šçš„è€¦åˆåº¦ã€‚ä¸€æ—¦Vå±‚æŸä¸ªUIå…ƒç´ æ›´æ”¹ï¼Œé‚£ä¹ˆå¯¹åº”çš„æ¥å£å°±å¿…é¡»å¾—æ”¹ï¼Œæ•°æ®å¦‚ä½•æ˜ å°„åˆ°UIä¸Šã€äº‹ä»¶ç›‘å¬æ¥å£è¿™äº›éƒ½éœ€è¦è½¬å˜ï¼Œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ã€‚å¦‚æœè¿™ä¸€å±‚ä¹Ÿèƒ½è§£è€¦å°±æ›´å¥½äº†ã€‚ å¤æ‚çš„ä¸šåŠ¡åŒæ—¶ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´På±‚å¤ªå¤§ï¼Œä»£ç è‡ƒè‚¿çš„é—®é¢˜ä¾ç„¶ä¸èƒ½è§£å†³ã€‚ MVVM **View: **å¯¹åº”äºActivityå’ŒXMLï¼Œè´Ÿè´£Viewçš„ç»˜åˆ¶ä»¥åŠä¸ç”¨æˆ·äº¤äº’ã€‚ **Model: **å®ä½“æ¨¡å‹ã€‚ **ViewModel: **è´Ÿè´£å®ŒæˆViewä¸Modelé—´çš„äº¤äº’ï¼Œè´Ÿè´£ä¸šåŠ¡é€»è¾‘ã€‚ MVVMçš„ç›®æ ‡å’Œæ€æƒ³ä¸MVPç±»ä¼¼ï¼Œåˆ©ç”¨æ•°æ®ç»‘å®š(Data Binding)ã€ä¾èµ–å±æ€§(Dependency Property)ã€å‘½ä»¤(Command)ã€è·¯ç”±äº‹ä»¶(Routed Event)ç­‰æ–°ç‰¹æ€§ï¼Œæ‰“é€ äº†ä¸€ä¸ªæ›´åŠ çµæ´»é«˜æ•ˆçš„æ¶æ„ã€‚ æ•°æ®é©±åŠ¨åœ¨å¸¸è§„çš„å¼€å‘æ¨¡å¼ä¸­ï¼Œæ•°æ®å˜åŒ–éœ€è¦æ›´æ–°UIçš„æ—¶å€™ï¼Œéœ€è¦å…ˆè·å–UIæ§ä»¶çš„å¼•ç”¨ï¼Œç„¶åå†æ›´æ–°UIã€‚è·å–ç”¨æˆ·çš„è¾“å…¥å’Œæ“ä½œä¹Ÿéœ€è¦é€šè¿‡UIæ§ä»¶çš„å¼•ç”¨ã€‚åœ¨MVVMä¸­ï¼Œè¿™äº›éƒ½æ˜¯é€šè¿‡æ•°æ®é©±åŠ¨æ¥è‡ªåŠ¨å®Œæˆçš„ï¼Œæ•°æ®å˜åŒ–åä¼šè‡ªåŠ¨æ›´æ–°UIï¼ŒUIçš„æ”¹å˜ä¹Ÿèƒ½è‡ªåŠ¨åé¦ˆåˆ°æ•°æ®å±‚ï¼Œæ•°æ®æˆä¸ºä¸»å¯¼å› ç´ ã€‚è¿™æ ·MVVMå±‚åœ¨ä¸šåŠ¡é€»è¾‘å¤„ç†ä¸­åªè¦å…³å¿ƒæ•°æ®ï¼Œä¸éœ€è¦ç›´æ¥å’ŒUIæ‰“äº¤é“ï¼Œåœ¨ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­ç®€å•æ–¹ä¾¿å¾ˆå¤šã€‚ ä½è€¦åˆåº¦MVVMæ¨¡å¼ä¸­ï¼Œæ•°æ®æ˜¯ç‹¬ç«‹äºUIçš„ã€‚ æ•°æ®å’Œä¸šåŠ¡é€»è¾‘å¤„äºä¸€ä¸ªç‹¬ç«‹çš„ViewModelä¸­ï¼ŒViewModelåªéœ€è¦å…³æ³¨æ•°æ®å’Œä¸šåŠ¡é€»è¾‘ï¼Œä¸éœ€è¦å’ŒUIæˆ–è€…æ§ä»¶æ‰“äº¤é“ã€‚UIæƒ³æ€ä¹ˆå¤„ç†æ•°æ®éƒ½ç”±UIè‡ªå·±å†³å®šï¼ŒViewModelä¸æ¶‰åŠä»»ä½•å’ŒUIç›¸å…³çš„äº‹ï¼Œä¹Ÿä¸æŒæœ‰UIæ§ä»¶çš„å¼•ç”¨ã€‚å³ä¾¿æ˜¯æ§ä»¶æ”¹å˜äº†ï¼ˆæ¯”å¦‚ï¼šTextViewæ¢æˆEditTextï¼‰ï¼ŒViewModelä¹Ÿå‡ ä¹ä¸éœ€è¦æ›´æ”¹ä»»ä½•ä»£ç ã€‚å®ƒéå¸¸å®Œç¾çš„è§£è€¦äº†Viewå±‚å’ŒViewModelï¼Œè§£å†³äº†ä¸Šé¢æˆ‘ä»¬æ‰€è¯´çš„MVPçš„ç—›ç‚¹ã€‚ æ›´æ–°UIåœ¨MVVMä¸­ï¼Œæ•°æ®å‘ç”Ÿå˜åŒ–åï¼Œæˆ‘ä»¬åœ¨å·¥ä½œçº¿ç¨‹ç›´æ¥ä¿®æ”¹ï¼ˆåœ¨æ•°æ®æ˜¯çº¿ç¨‹å®‰å…¨çš„æƒ…å†µä¸‹ï¼‰ViewModelçš„æ•°æ®å³å¯ï¼Œä¸ç”¨å†è€ƒè™‘è¦åˆ‡åˆ°ä¸»çº¿ç¨‹æ›´æ–°UIäº†ï¼Œè¿™äº›äº‹æƒ…ç›¸å…³æ¡†æ¶éƒ½å¸®æˆ‘ä»¬åšäº†ã€‚ å›¢é˜Ÿåä½œMVVMçš„åˆ†å·¥æ˜¯éå¸¸æ˜æ˜¾çš„ï¼Œç”±äºViewå’ŒViewModelä¹‹é—´æ˜¯æ¾æ•£è€¦åˆçš„ï¼šä¸€ä¸ªæ˜¯å¤„ç†ä¸šåŠ¡å’Œæ•°æ®ã€ä¸€ä¸ªæ˜¯ä¸“é—¨çš„UIå¤„ç†ã€‚æ‰€ä»¥ï¼Œå®Œå…¨ç”±ä¸¤ä¸ªäººåˆ†å·¥æ¥åšï¼Œä¸€ä¸ªåšUIï¼ˆXMLå’ŒActivityï¼‰ä¸€ä¸ªå†™ViewModelï¼Œæ•ˆç‡æ›´é«˜ã€‚ å¯å¤ç”¨æ€§ä¸€ä¸ªViewModelå¯ä»¥å¤ç”¨åˆ°å¤šä¸ªViewä¸­ã€‚åŒæ ·çš„ä¸€ä»½æ•°æ®ï¼Œå¯ä»¥æä¾›ç»™ä¸åŒçš„UIå»åšå±•ç¤ºã€‚å¯¹äºç‰ˆæœ¬è¿­ä»£ä¸­é¢‘ç¹çš„UIæ”¹åŠ¨ï¼Œæ›´æ–°æˆ–æ–°å¢ä¸€å¥—Viewå³å¯ã€‚å¦‚æœæƒ³åœ¨UIä¸ŠåšA/B Testingï¼Œé‚£MVVMæ˜¯ä½ ä¸äºŒé€‰æ‹©ã€‚ MVVMï¼š MVVMæ¶æ„ä»‹ç»MVVM æ¨¡å¼å°† Presenter æ”¹åä¸º ViewModelï¼ŒåŸºæœ¬ä¸Šä¸ MVP æ¨¡å¼å®Œå…¨ä¸€è‡´ã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼Œå®ƒé‡‡ç”¨åŒå‘æ•°æ®ç»‘å®šï¼ˆdata-bindingï¼‰ï¼šViewçš„å˜åŠ¨ï¼Œè‡ªåŠ¨åæ˜ åœ¨ ViewModelï¼Œåä¹‹äº¦ç„¶ã€‚ MVVMæ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºMVVMä¸MVPçš„ä¸»è¦åŒºåˆ«åœ¨äº,ä½ ä¸ç”¨å»ä¸»åŠ¨å»åˆ·æ–°UIäº†ï¼Œåªè¦Modelæ•°æ®å˜äº†ï¼Œä¼šè‡ªåŠ¨åæ˜ åˆ°UIä¸Šã€‚æ¢å¥è¯è¯´ï¼ŒMVVMæ›´åƒæ˜¯è‡ªåŠ¨åŒ–çš„MVPã€‚ MVVMçš„åŒå‘æ•°æ®ç»‘å®šä¸»è¦é€šè¿‡DataBindingå®ç°ï¼Œä¸è¿‡ç›¸ä¿¡æœ‰å¾ˆå¤šäººè·Ÿæˆ‘ä¸€æ ·ï¼Œæ˜¯ä¸å–œæ¬¢ç”¨DataBindingçš„ï¼Œè¿™æ ·æ¶æ„å°±å˜æˆäº†ä¸‹é¢è¿™æ ·ã€‚ Viewè§‚å¯ŸViewModelçš„æ•°æ®å˜åŒ–å¹¶è‡ªæˆ‘æ›´æ–°ï¼Œè¿™å…¶å®æ˜¯å•ä¸€æ•°æ®æºè€Œä¸æ˜¯åŒå‘æ•°æ®ç»‘å®šï¼Œæ‰€ä»¥å…¶å®MVVMçš„è¿™ä¸€å¤§ç‰¹æ€§æˆ‘å…¶å®å¹¶æ²¡æœ‰ç”¨åˆ° Viewé€šè¿‡è°ƒç”¨ViewModelæä¾›çš„æ–¹æ³•æ¥ä¸ViewModeläº¤äº’ å°ç»“ MVCæ¶æ„çš„ä¸»è¦é—®é¢˜åœ¨äºActivityæ‰¿æ‹…äº†Viewä¸Controllerä¸¤å±‚çš„èŒè´£ï¼ŒåŒæ—¶Viewå±‚ä¸Modelå±‚å­˜åœ¨è€¦åˆ MVPå¼•å…¥Presenterå±‚è§£å†³äº†MVCæ¶æ„çš„ä¸¤ä¸ªé—®é¢˜ï¼ŒViewåªèƒ½ä¸Presenterå±‚äº¤äº’ï¼Œä¸šåŠ¡é€»è¾‘æ”¾åœ¨Presenterå±‚ MVPçš„é—®é¢˜åœ¨äºéšç€ä¸šåŠ¡é€»è¾‘çš„å¢åŠ ï¼ŒViewçš„æ¥å£ä¼šå¾ˆåºå¤§ï¼ŒMVVMæ¶æ„é€šè¿‡åŒå‘æ•°æ®ç»‘å®šå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ MVVMä¸MVPçš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œä½ ä¸ç”¨å»ä¸»åŠ¨å»åˆ·æ–°UIäº†ï¼Œåªè¦Modelæ•°æ®å˜äº†ï¼Œä¼šè‡ªåŠ¨åæ˜ åˆ°UIä¸Šã€‚æ¢å¥è¯è¯´ï¼ŒMVVMæ›´åƒæ˜¯è‡ªåŠ¨åŒ–çš„MVPã€‚ MVVMçš„åŒå‘æ•°æ®ç»‘å®šä¸»è¦é€šè¿‡DataBindingå®ç°ï¼Œä½†æœ‰å¾ˆå¤šäºº(æ¯”å¦‚æˆ‘)ä¸å–œæ¬¢ç”¨DataBindingï¼Œè€Œæ˜¯Viewé€šè¿‡LiveDataç­‰è§‚å¯ŸViewModleçš„æ•°æ®å˜åŒ–å¹¶è‡ªæˆ‘æ›´æ–°,è¿™å…¶å®æ˜¯å•ä¸€æ•°æ®æºè€Œä¸æ˜¯åŒå‘æ•°æ®ç»‘å®š MVVMè¡¥å……é“¾æ¥ï¼šhttps://juejin.cn/post/6844904176296673287 æ•°æ®è§†å›¾äº’ç»‘ + é•¿ç”Ÿå‘½å‘¨æœŸæ•°æ®å³ä½¿å°†è®¿é—®æ•°æ®çš„ç»†èŠ‚å‰¥ç¦»å‡ºPresenterï¼Œå®ƒä¾ç„¶ä¸å•çº¯ã€‚å› ä¸ºå®ƒæŒæœ‰ View å±‚æ¥å£ï¼Œè¿™å°±è¦æ±‚Presenteréœ€äº†è§£ è¯¥æŠŠå“ªä¸ªæ•°æ®ä¼ é€’ç»™å“ªä¸ªæ¥å£æ–¹æ³•ï¼Œè¿™å°±æ˜¯ æ•°æ®ç»‘å®šï¼Œå®ƒåœ¨æ„å»ºè§†å›¾æ—¶å°±å·²ç»ç¡®å®šï¼ˆæ— éœ€ç­‰åˆ°æ•°æ®è¿”å›ï¼‰ï¼Œæ‰€ä»¥è¿™ä¸ªç»†èŠ‚å¯ä»¥ä»ä¸šåŠ¡å±‚å‰¥ç¦»ï¼Œå½’å¹¶åˆ°è§†å›¾å±‚ã€‚ Presenterçš„å®ä¾‹è¢« Activity æŒæœ‰ï¼Œæ‰€ä»¥å®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œ Activiy åŒæ­¥ï¼Œå³ä¸šåŠ¡æ•°æ®å’Œç•Œé¢åŒç”Ÿå‘½å‘¨æœŸã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ªç¼ºç‚¹ï¼Œæ¯”å¦‚æ¨ªç«–å±åˆ‡æ¢ã€‚æ­¤æ—¶ï¼Œå¦‚æœæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸä¸ä¾èµ–ç•Œé¢ï¼Œå°±å¯ä»¥å…å»é‡æ–°è·å–æ•°æ®çš„æˆæœ¬ã€‚è¿™åŠ¿å¿… éœ€è¦ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ›´é•¿çš„å¯¹è±¡ï¼ˆViewModelï¼‰æŒæœ‰æ•°æ®ã€‚ ç”Ÿå‘½å‘¨æœŸæ›´é•¿çš„ ViewModel æœ€ç»ˆçš„æŒæœ‰é“¾å¦‚ä¸‹ï¼šNonConfigurationInstances æŒæœ‰ ViewModelStore æŒæœ‰ ViewModelã€‚ æ‰€ä»¥ ViewModel ç”Ÿå‘½å‘¨æœŸæ¯” Activity æ›´é•¿ã€‚è¿™æ · ViewModel ä¸­å­˜æ”¾çš„ä¸šåŠ¡æ•°æ®å°±å¯ä»¥åœ¨ Activity é”€æ¯é‡å»ºæ—¶è¢«å¤ç”¨ã€‚ ä¸Šä¸€èŠ‚çš„ä¾‹å­ä¸­ï¼Œæ„å»º Presenter æ˜¯ç›´æ¥åœ¨ Activity ä¸­ newï¼Œè€Œæ„å»ºViewModelæ˜¯é€šè¿‡ViewModelProvider.get(): 12345678910111213141516171819202122232425public class ViewModelProvider { // ViewModel å®ä¾‹å•†åº— private final ViewModelStore mViewModelStore; public &lt;T extends ViewModel&gt; T get(@NonNull String key, @NonNull Class&lt;T&gt; modelClass) { // ä»å•†åº—è·å– ViewModelå®ä¾‹ ViewModel viewModel = mViewModelStore.get(key); if (modelClass.isInstance(viewModel)) { return (T) viewModel; } else { ... } // è‹¥å•†åº—æ—  ViewModel å®ä¾‹ åˆ™é€šè¿‡ Factory æ„å»º if (mFactory instanceof KeyedFactory) { viewModel = ((KeyedFactory) (mFactory)).create(key, modelClass); } else { viewModel = (mFactory).create(modelClass); } // å°† ViewModel å®ä¾‹å­˜å…¥å•†åº— mViewModelStore.put(key, viewModel); return (T) viewModel; }} ViewModelå®ä¾‹é€šè¿‡ViewModelStoreè·å–: 123456789101112131415161718192021// ViewModel å®ä¾‹å•†åº—public class ViewModelStore { // å­˜å‚¨ ViewModel å®ä¾‹çš„ Map private final HashMap&lt;String, ViewModel&gt; mMap = new HashMap&lt;&gt;(); // å­˜ final void put(String key, ViewModel viewModel) { ViewModel oldViewModel = mMap.put(key, viewModel); if (oldViewModel != null) { oldViewModel.onCleared(); } } // å– final ViewModel get(String key) { return mMap.get(key); } ...} ViewModelStoreå°†ViewModelå®ä¾‹å­˜å‚¨åœ¨HashMapä¸­ã€‚ è€ŒViewModelStoreé€šè¿‡ViewModelStoreOwnerè·å–: 12345678910111213141516public class ViewModelProvider { // ViewModel å®ä¾‹å•†åº— private final ViewModelStore mViewModelStore; // æ„é€  ViewModelProvider æ—¶éœ€ä¼ å…¥ ViewModelStoreOwner å®ä¾‹ public ViewModelProvider(@NonNull ViewModelStoreOwner owner, @NonNull Factory factory) { // é€šè¿‡ ViewModelStoreOwner è·å– ViewModelStore this(owner.getViewModelStore(), factory); } public ViewModelProvider(@NonNull ViewModelStore store, @NonNull Factory factory) { mFactory = factory; mViewModelStore = store; }} é‚£ViewModelStoreOwnerå®ä¾‹åˆå­˜å‚¨åœ¨å“ªï¼Ÿ 123456789101112131415161718192021222324252627282930313233// Activity åŸºç±»å®ç°äº† ViewModelStoreOwner æ¥å£public class ComponentActivity extends androidx.core.app.ComponentActivity implements LifecycleOwner, ViewModelStoreOwner, SavedStateRegistryOwner, OnBackPressedDispatcherOwner { // Activity æŒæœ‰ ViewModelStore å®ä¾‹ private ViewModelStore mViewModelStore; public ViewModelStore getViewModelStore() { if (mViewModelStore == null) { // è·å–é…ç½®æ— å…³å®ä¾‹ NonConfigurationInstances nc =(NonConfigurationInstances) getLastNonConfigurationInstance(); if (nc != null) { // ä»é…ç½®æ— å…³å®ä¾‹ä¸­æ¢å¤ ViewModelå•†åº— mViewModelStore = nc.viewModelStore; } if (mViewModelStore == null) { mViewModelStore = new ViewModelStore(); } } return mViewModelStore; } // é™æ€çš„é…ç½®æ— å…³å®ä¾‹ static final class NonConfigurationInstances { // æŒæœ‰ ViewModelå•†åº—å®ä¾‹ ViewModelStore viewModelStore; ... }} Activity å°±æ˜¯ViewModelStoreOwnerå®ä¾‹ï¼Œä¸”æŒæœ‰ViewModelStoreå®ä¾‹ï¼Œè¯¥å®ä¾‹è¿˜ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªé™æ€ç±»ä¸­ã€‚ æœ€ç»ˆçš„æŒæœ‰é“¾å¦‚ä¸‹ï¼šNonConfigurationInstances æŒæœ‰ ViewModelStore æŒæœ‰ ViewModelã€‚ æ‰€ä»¥ ViewModel ç”Ÿå‘½å‘¨æœŸæ¯” Activity æ›´é•¿ã€‚è¿™æ · ViewModel ä¸­å­˜æ”¾çš„ä¸šåŠ¡æ•°æ®å°±å¯ä»¥åœ¨ Activity é”€æ¯é‡å»ºæ—¶è¢«å¤ç”¨ã€‚ æ•°æ®ç»‘å®š åœ¨ MVP æ¨¡å¼ä¸­ï¼ŒPresenter æŒæœ‰ View å±‚æ¥å£å¹¶ä¸»åŠ¨å‘ç•Œé¢æ¨æ•°æ®ã€‚ MVVM æ¨¡å¼ä¸­ï¼ŒViewModel ä¸å†æŒæœ‰ View å±‚æ¥å£ï¼Œä¹Ÿä¸ä¸»åŠ¨ç»™ç•Œé¢æ¨æ•°æ®ï¼Œè€Œæ˜¯ç•Œé¢è¢«åŠ¨åœ°è§‚å¯Ÿæ•°æ®å˜åŒ–ã€‚ MVVM è¿™ç§æ›´æ–°ç•Œé¢çš„æ–¹å¼ç§°ä¸º â€œæ•°æ®é©±åŠ¨â€ï¼Œå³åªéœ€æ›´æ–°æ•°æ®å³å¯ï¼Œå› ä¸ºç•Œé¢ä¼šä¸»åŠ¨è§‚å¯Ÿæ•°æ®çš„å˜åŒ–å¹¶åšå‡ºå“åº”ã€‚ è¿™ä½¿å¾— ViewModel åªéœ€æŒæœ‰æ•°æ®å¹¶æ ¹æ®ä¸šåŠ¡é€»è¾‘æ›´æ–°ä¹‹å³å¯ MVVMä¸­Activity å±äºVå±‚ï¼Œå¸ƒå±€æ„å»ºä»¥åŠæ•°æ®ç»‘å®šéƒ½åœ¨è¿™å±‚å®Œæˆï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455class MvvmActivity : AppCompatActivity() { private var rvNews: RecyclerView? = null private var newsAdapter = NewsAdapter() // æ„å»ºå¸ƒå±€ private val rootView by lazy { ConstraintLayout { TextView { layout_id = &quot;tvTitle&quot; layout_width = wrap_content layout_height = wrap_content textSize = 25f padding_start = 20 padding_end = 20 center_horizontal = true text = &quot;News&quot; top_toTopOf = parent_id } rvNews = RecyclerView { layout_id = &quot;rvNews&quot; layout_width = match_parent layout_height = wrap_content top_toBottomOf = &quot;tvTitle&quot; margin_top = 10 center_horizontal = true } } } // æ„å»º ViewModel å®ä¾‹ private val newsViewModel by lazy { // æ„é€  ViewModelProvider å®ä¾‹, é€šè¿‡å…¶ get() è·å¾— ViewModel å®ä¾‹ ViewModelProvider(this, NewsFactory(applicationContext)).get(NewsViewModel::class.java) } override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContentView(rootView) initView() bindData() } // å°†æ•°æ®ç»‘å®šåˆ°è§†å›¾ private fun bindData() { newsViewModel.newsLiveData.observe(this, Observer { newsAdapter.news = it rvNews?.adapter = newsAdapter }) } private fun initView() { rvNews?.layoutManager = LinearLayoutManager(this) }} å…¶ä¸­æ„å»ºå¸ƒå±€ DSL çš„è¯¦ç»†ä»‹ç»å¯ä»¥ç‚¹å‡»è¿™é‡Œã€‚å®ƒçœå»äº†åŸå…ˆVå±‚( Activity + xml )ä¸­çš„ xmlã€‚ ä»£ç ä¸­çš„æ•°æ®ç»‘å®šæ˜¯é€šè¿‡è§‚å¯Ÿ ViewModel ä¸­çš„ LiveData å®ç°çš„ã€‚è¿™ä¸æ˜¯æ•°æ®ç»‘å®šçš„å®Œå…¨ä½“ï¼Œæ‰€ä»¥è¿˜éœ€æ‰‹åŠ¨åœ°è§‚å¯Ÿ observe æ•°æ®å˜åŒ–ï¼ˆåªæœ‰å½“å¼•å…¥data-bindingåŒ…åï¼Œæ‰èƒ½æŠŠè§†å›¾å’Œæ§ä»¶çš„ç»‘å®šéƒ½é™æ€åŒ–åˆ° xml ä¸­ï¼‰ã€‚ä½†è‡³å°‘å®ƒè®© ViewModel æ— éœ€ä¸»åŠ¨æ¨æ•°æ®äº†: åœ¨ MVP æ¨¡å¼ä¸­ï¼ŒPresenter æŒæœ‰ View å±‚æ¥å£å¹¶ä¸»åŠ¨å‘ç•Œé¢æ¨æ•°æ®ã€‚ MVVM æ¨¡å¼ä¸­ï¼ŒViewModel ä¸å†æŒæœ‰ View å±‚æ¥å£ï¼Œä¹Ÿä¸ä¸»åŠ¨ç»™ç•Œé¢æ¨æ•°æ®ï¼Œè€Œæ˜¯ç•Œé¢è¢«åŠ¨åœ°è§‚å¯Ÿæ•°æ®å˜åŒ–ã€‚ MVVM è¿™ç§æ›´æ–°ç•Œé¢çš„æ–¹å¼ç§°ä¸º â€œæ•°æ®é©±åŠ¨â€ï¼Œå³åªéœ€æ›´æ–°æ•°æ®å³å¯ï¼Œå› ä¸ºç•Œé¢ä¼šä¸»åŠ¨è§‚å¯Ÿæ•°æ®çš„å˜åŒ–å¹¶åšå‡ºå“åº”ã€‚ è¿™ä½¿å¾— ViewModel åªéœ€æŒæœ‰æ•°æ®å¹¶æ ¹æ®ä¸šåŠ¡é€»è¾‘æ›´æ–°ä¹‹å³å¯: 1234567891011121314151617181920212223// æ•°æ®è®¿é—®æ¥å£åœ¨æ„é€ å‡½æ•°ä¸­æ³¨å…¥class NewsViewModel(var newsRepository: NewsRepository) : ViewModel() { // æŒæœ‰ä¸šåŠ¡æ•°æ® val newsLiveData by lazy { newsRepository.fetchNewsLiveData() }}// å®šä¹‰æ„é€  ViewModel æ–¹æ³•class NewsFactory(context: Context) : ViewModelProvider.Factory { // æ„é€  æ•°æ®è®¿é—®æ¥å£å®ä¾‹ private val newsRepository = NewsRepositoryImpl(context) override fun &lt;T : ViewModel?&gt; create(modelClass: Class&lt;T&gt;): T { // å°†æ•°æ®æ¥å£è®¿é—®å®ä¾‹æ³¨å…¥ ViewModel return NewsViewModel(newsRepository) as T }}// ç„¶åå°±å¯ä»¥åœ¨ Activity ä¸­è¿™æ ·æ„é€  ViewModel äº†class MvvmActivity : AppCompatActivity() { // æ„å»º ViewModel å®ä¾‹ private val newsViewModel by lazy { ViewModelProvider(this, NewsFactory(applicationContext)).get(NewsViewModel::class.java) }} ViewModelåªå…³å¿ƒä¸šåŠ¡é€»è¾‘å’Œæ•°æ®ï¼Œä¸å…³å¿ƒè·å–æ•°æ®çš„ç»†èŠ‚ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½è¢«æ•°æ®è®¿é—®æ¥å£éšè—äº†ã€‚","link":"/2021/11/09/MVXArchitecture/"},{"title":"matrix","text":"Matrix Tencentä¸€ï¼šTraceCanaryæ’æ¡©ï¼šé€šè¿‡æ’æ¡©ï¼Œåœ¨é™¤äº†get/setã€é»˜è®¤æˆ–åŒ¿åæ„é€ å‡½æ•°ç­‰ç®€å•å‡½æ•°å¤–çš„æ‰€æœ‰æ–¹æ³•ï¼Œå…¥å£/å‡ºå£æ’å…¥MethodBeat.i()/MethodBeat.o()ã€‚ 123456789101112131415//AppMethodBeat.javaprivate static void mergeData(int methodId, int index, boolean isIn) { if (methodId == AppMethodBeat.METHOD_ID_DISPATCH) { sCurrentDiffTime = SystemClock.uptimeMillis() - sDiffTime; } long trueId = 0L; if (isIn) { trueId |= 1L &lt;&lt; 63; } trueId |= (long) methodId &lt;&lt; 43; trueId |= sCurrentDiffTime &amp; 0x7FFFFFFFFFFL; sBuffer[index] = trueId; checkPileup(index); sLastIndex = index;} ç”¨ä¸€ä¸ª64ä½çš„longå‹æ¥å­˜å‚¨æ–¹æ³•çš„ï¼šæ–¹æ³•å¼€å§‹/æ–¹æ³•ç»“æŸ(æœ€é«˜ä½63ä½)ã€æ–¹æ³•id(é€’å¢ï¼Œ43åˆ°62ä½)ã€å½“å‰ä¸MethodBeatæ¨¡å—åˆå§‹åŒ–æ—¶å·®ï¼ˆ0åˆ°42ä½ï¼‰ duringè®¡ç®—ï¼šè€ƒè™‘åˆ°æ¯ä¸ªæ–¹æ³•æ‰§è¡Œå‰åéƒ½è·å–ç³»ç»Ÿæ—¶é—´ï¼ˆSystem.nanoTimeï¼‰ä¼šå¯¹æ€§èƒ½å½±å“æ¯”è¾ƒå¤§ï¼Œè€Œå®é™…ä¸Šï¼Œå•ä¸ªå‡½æ•°æ‰§è¡Œè€—æ—¶å°äº 5ms çš„æƒ…å†µï¼Œå¯¹å¡é¡¿æ¥è¯´ä¸æ˜¯ä¸»è¦åŸå› ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œå¦‚æœæ˜¯å¤šæ¬¡è°ƒç”¨çš„æƒ…å†µï¼Œåˆ™åœ¨å®ƒçš„çˆ¶çº§æ–¹æ³•ä¸­å¯ä»¥åæ˜ å‡ºæ¥ï¼Œæ‰€ä»¥ä¸ºäº†å‡å°‘å¯¹æ€§èƒ½çš„å½±å“ï¼Œé€šè¿‡å¦ä¸€æ¡æ›´æ–°æ—¶é—´çš„çº¿ç¨‹æ¯ 5ms å»æ›´æ–°ä¸€ä¸ªæ—¶é—´å˜é‡ï¼Œè€Œæ¯ä¸ªæ–¹æ³•æ‰§è¡Œå‰ååªè¯»å–è¯¥å˜é‡æ¥å‡å°‘æ€§èƒ½æŸè€—ã€‚ï¼ˆsTimerUpdateThreadï¼‰ exampleï¼ˆåˆå§‹åŒ–æ—¶å·®æœªä½“ç°ï¼‰ï¼š åé¢ç”Ÿæˆè°ƒç”¨æ ˆæ ‘ è¾“å‡ºç»“æœçš„å¯ä»¥å‚è€ƒï¼ˆå¾®ä¿¡å›¢é˜Ÿè‡ªç ”çš„APMåˆ©å™¨ï¼ŒMatrixæ€§èƒ½ç›‘æ§æ—¥å¿—æ¢ç´¢ (qq.com) çš„6.2 ç”Ÿæˆè°ƒç”¨æ ˆæ ‘ï¼‰ ä¸Šè¿°é¡¹ä½œä¸ºåŸºç¡€ ï¼ˆå‡½æ•°è€—æ—¶= æ¯ä¸ªå‡½æ•°è°ƒç”¨ä¸ŠæŠ¥ + æ¯ä¸ªå‡½æ•°ç»Ÿè®¡è€—æ—¶ï¼‰ EvilMethodTracerï¼š æ³¨å†Œä¸»çº¿ç¨‹handler çš„Looper.looperï¼Œprinteræ¶ˆæ¯å›è°ƒï¼Œåœ¨æ¯ä¸€ä¸ªdispatchBeginä¸dispatchEndçš„å·®è·è¶…è¿‡700msæ—¶è§¦å‘ä¸ŠæŠ¥ ANRTracerï¼š æ³¨å†Œä¸»çº¿ç¨‹handler çš„Looper.looperï¼Œprinteræ¶ˆæ¯å›è°ƒï¼Œåœ¨æ¯ä¸€ä¸ªdispatchBeginæ—¶postDelayä¸€ä¸ª5såçš„ANRä¸ŠæŠ¥æ¶ˆæ¯ï¼Œå¹¶åœ¨dispatchEndæ—¶å€™removeCallbackè¿™ä¸ªæ¶ˆæ¯ã€‚ å¦‚æœæ¶ˆæ¯äº”ç§’åè¿˜æ²¡æœ‰è¢«ç§»é™¤æ‰ï¼Œé‚£å°±è¯´æ˜å‘ç”Ÿäº†ANRï¼Œä¼šä¸»åŠ¨å–å‡ºå½“å‰è®°å½•çš„ buffer æ•°æ®è¿›è¡Œç‹¬ç«‹åˆ†æå¹¶äº§ç”Ÿä¸ŠæŠ¥ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼ˆè¯¥message5så†…æ‰§è¡Œå®Œæˆï¼‰ï¼Œé‚£ä¹ˆè‡ªç„¶ä¼šå–æ¶ˆæ‰å¹¶ç»§ç»­ç”¨è¿™ç§æ–¹å¼ç›‘å¬ä¸‹ä¸€ä¸ªæ¶ˆæ¯ã€‚ FrameTracerï¼š å‘ Choreographer æ³¨å†Œç›‘å¬ï¼Œåœ¨æ¯ä¸€å¸§ doframe å›è°ƒæ—¶åˆ¤æ–­è·ç¦»ä¸Šä¸€å¸§çš„æ—¶é—´å·®æ˜¯å¦è¶…å‡ºé˜ˆå€¼ï¼ˆå¡é¡¿ï¼‰ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼ï¼Œåˆ™è·å–æ•°ç»„ index å‰çš„æ‰€æœ‰æ•°æ®ï¼ˆå³ä¸¤å¸§ä¹‹é—´çš„æ‰€æœ‰å‡½æ•°æ‰§è¡Œä¿¡æ¯ï¼‰è¿›è¡Œåˆ†æä¸ŠæŠ¥ã€‚ äºŒï¼šAPK Trackerapkä½“ç§¯æ£€æµ‹ä¸‰ï¼šHooké»‘ç§‘æŠ€ï¼Œhook ç³»ç»Ÿä»¥è¾¾åˆ°32ä½è®¾å¤‡ä¸­è·å¾—æ›´å¤§çš„è™šæ‹Ÿå†…å­˜å››ï¼šIOCanary","link":"/2021/05/26/Matrix/"},{"title":"leakcanary","text":"çº¿ç¨‹æ ˆä¸­çš„å±€éƒ¨å˜é‡è¡¨å¼•ç”¨çš„æ‰€æœ‰å˜é‡ï¼Œå³è¿è¡Œçº¿ç¨‹ä¸­å¼•ç”¨åˆ°çš„æ‰€æœ‰å˜é‡ï¼ŒåŒ…æ‹¬çº¿ç¨‹ä¸­æ–¹æ³•å‚æ•°å’Œå±€éƒ¨å˜é‡ å­˜æ´»çš„çº¿ç¨‹å¯¹è±¡ native çš„ jniå¼•ç”¨ class å¯¹è±¡ ï¼ˆclassLoader ä¸ä¼šå¸è½½classï¼‰ å¼•ç”¨ç±»å‹çš„é™æ€å˜é‡ // 1è·Ÿ2å…¶å®è¯´çš„æ˜¯ä¸€ä¸ªä¸œè¥¿ Reference queues, to which registered reference objects are appended by the garbage collector after the appropriate reachability changes are detected. åœ¨æ£€æµ‹åˆ°é€‚å½“çš„å¯è¾¾æ€§æ”¹å˜åï¼Œåƒåœ¾æ”¶é›†å™¨å°†æ³¨å†Œçš„å¼•ç”¨å¯¹è±¡ï¼ˆWeakReferenceï¼‰è¿½åŠ åˆ°å¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰ã€‚ â€‹ æ ¸å¿ƒæ€è·¯æ˜¯ï¼šâ€‹ leakCanaryåšæ³•æ˜¯ondestoryåæ‰‹åŠ¨å‡ºå‘GCï¼ŒGCè¿‡åå¯¹è±¡WeakReferenceä¸€ç›´ä¸è¢«åŠ å…¥ ReferenceQueueï¼Œå®ƒå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ã€‚ â€‹ åˆ©ç”¨ åŒå‚åˆå§‹åŒ–çš„å¼±å¼•ç”¨ WeakReference(T referent, ReferenceQueue&lt;? super T&gt; q) åœ¨objectå¯¹è±¡å˜æˆå¼±å¯è¾¾çš„æ—¶å€™ï¼ˆå¯è§†ä¸ºå·²è¢«å›æ”¶/(å…¶ä»–éå¼ºå¼•ç”¨ä¹Ÿä¸€æ ·)ï¼‰ï¼Œä¼šå°†è¯¥WeakReferenceå¯¹è±¡å…¥é˜Ÿqä¸­ çš„ç‰¹æ€§ï¼ˆä¹Ÿå°±æ˜¯quequeä¸­æœ€åä¼šå­˜åœ¨å·²ç»è¢«å›æ”¶äº†çš„weakreferenceå¯¹è±¡ï¼‰ï¼Œé€šè¿‡åœ¨Activityå’ŒFragmentçš„onDestroy()ä¸­ï¼Œå°†è¯¥Activityæˆ–Fragmentå®ä¾‹çš„å¼±å¼•ç”¨åˆå§‹åŒ–ï¼ˆåŒå‚object,queueï¼‰åæ”¾å…¥mapä¸­ï¼ˆkeyéšæœºå›ºå®šuuidï¼‰ï¼ŒGCå æŠŠmapä¸­çš„ queueåŒ…å«çš„å¯¹è±¡ ç§»é™¤ï¼Œmapä¸­å‰©ä½™çš„å³ä¸ºå¯èƒ½æ³„éœ²çš„å¯¹è±¡ KOOMç”±äºleakCanaryé¢‘ç¹çš„Gcæ—¶å¸¦æ¥çš„STWï¼ˆstop the worldï¼‰ä¼šå¯¼è‡´æ˜æ˜¾çš„å¡é¡¿ï¼Œä¸é€‚åˆä½œä¸ºçº¿ä¸Šç›‘æ§æœºåˆ¶ KOOMé‡‡ç”¨å†…å­˜é˜ˆå€¼ç›‘æ§æ¥è§¦å‘é•œåƒé‡‡é›†ï¼Œå°†å¯¹è±¡æ˜¯å¦æ³„æ¼çš„åˆ¤æ–­å»¶è¿Ÿåˆ°äº†è§£ææ—¶ï¼Œé˜ˆå€¼ç›‘æ§åªè¦åœ¨å¸¸é©»çš„å­çº¿ç¨‹ä¸­æ¯éš”äº”ç§’è·å–å…³æ³¨çš„å‡ ä¸ªå†…å­˜æŒ‡æ ‡ã€‚è¾¾åˆ°é˜ˆå€¼åˆ™ç›´æ¥suspendAndForkä¸»è¿›ç¨‹ï¼Œåœ¨æ–°è¿›ç¨‹ï¼ˆç”±äºforkè‡ªä¸»è¿›ç¨‹ï¼Œcopy_on_writeæœºåˆ¶å› æ­¤æ‹¥æœ‰ä¸»è¿›ç¨‹ä¸€æ ·çš„è¿›ç¨‹ä¿¡æ¯ï¼‰è¿›è¡Œdumpï¼Œä¹‹åresumeAndWaitä¸»è¿›ç¨‹ã€‚æ–°è¿›ç¨‹ä¼šè£å‰ªdumpæ–‡ä»¶ä¿å­˜ã€‚ è£å‰ªæ—¶KOOMä¼šæ ¹æ®å †ç±»å‹è¿›è¡Œè£å‰ªï¼š é’ˆå¯¹system spaceï¼ˆZygote Spaceã€Image Spaceï¼‰ï¼šä¼šè£å‰ªPRIMITIVE_ARRAY_DUMPã€HEAP_DUMP_INFOã€INSTANCE_DUMPå’ŒOBJECT_ARRAY_DUMPè¿™4ä¸ªå­TAGï¼Œï¼ˆä¹Ÿå°±æ˜¯åªä¿ç•™äº†CLASS DUMPï¼‰ä¼šåˆ é™¤è¿™å››ä¸ªå­TAGçš„å…¨éƒ¨å†…å®¹ï¼ˆåŒ…å‡½å­TAGå…¨éƒ½ä¼šåˆ é™¤ï¼‰ã€‚ é’ˆå¯¹app spaceï¼šä¼šå¤„ç†PRIMITIVE_ARRAY_DUMPè¿™ä¸€å—æ•°æ®ï¼Œä½†ä¼šä¿ç•™metadataï¼Œæ–¹ä¾¿å›å¡«ã€‚ ç”¨äºç›‘æ§åº”ç”¨çš„ Java å†…å­˜æ³„æ¼é—®é¢˜ï¼Œå®ƒçš„æ ¸å¿ƒåŸç† å‘¨æœŸæ€§æŸ¥è¯¢Javaå †å†…å­˜ã€çº¿ç¨‹æ•°ã€æ–‡ä»¶æè¿°ç¬¦æ•°ç­‰èµ„æºå ç”¨æƒ…å†µï¼Œå½“è¿ç»­å¤šæ¬¡è¶…è¿‡è®¾å®šé˜ˆå€¼æˆ–çªå‘æ€§è¿ç»­å¿«é€Ÿçªç ´é«˜é˜ˆå€¼æ—¶ï¼Œè§¦å‘é•œåƒé‡‡é›† é•œåƒé‡‡é›†é‡‡ç”¨è™šæ‹Ÿæœºsupend-&gt;forkè™šæ‹Ÿæœºè¿›ç¨‹-&gt;è™šæ‹Ÿæœºresume-&gt;dumpå†…å­˜é•œåƒçš„ç­–ç•¥ï¼Œå°†ä¼ ç»ŸDumpå†»ç»“è¿›ç¨‹20sçš„æ—¶é—´ç¼©å‡è‡³20msä»¥å†… åŸºäºsharkæ‰§è¡Œé•œåƒè§£æï¼Œå¹¶é’ˆå¯¹sharkåšäº†ä¸€ç³»åˆ—è°ƒæ•´ç”¨äºæå‡æ€§èƒ½ï¼Œåœ¨æ‰‹æœºè®¾å¤‡æµ‹å³å¯æ‰§è¡Œç¦»çº¿å†…å­˜æ³„éœ²åˆ¤å®šä¸å¼•ç”¨é“¾æŸ¥æ‰¾ï¼Œç”Ÿæˆåˆ†ææŠ¥å‘Š æ³„éœ²æ˜¯å¦‚ä½•åˆ¤å®šçš„ï¼Ÿ å¯¹äºActivityå’ŒFragmentå½“å¯¹è±¡å·²ç»é”€æ¯å´ä»æœ‰ä»GC Rootåˆ°æ­¤å¯¹è±¡çš„å¼•ç”¨è·¯å¾„æ—¶ï¼Œè®¤ä¸ºæ­¤å¯¹è±¡å·²ç»æ³„éœ² Activityçš„é”€æ¯åˆ¤å®šè§„åˆ™ä¸ºï¼ŒmFinishedæˆ–mDestroyedå€¼ä¸ºtrue Fragmentçš„é”€æ¯åˆ¤å®šè§„åˆ™ä¸ºï¼ŒmFragmentManagerä¸ºç©ºä¸”mCalledä¸ºtrueï¼ŒmCalledä¸ºtrueè¡¨ç¤ºæ­¤fragmentå·²ç»ç»å†äº†ä¸€äº›ç”Ÿå‘½å‘¨æœŸ //è¯†åˆ«åˆ°ç›‘æ§çš„activityåœ¨gcåè¿Ÿè¿Ÿä¸åŠ å…¥ReferenceQueueï¼Œä¼šè§¦å‘dump hprofï¼ˆAndroid è®¾å¤‡ä¸Šï¼Œè¦ dump å½“å‰å†…å­˜å¿«ç…§ï¼Œä¸€èˆ¬ä¼šè°ƒç”¨ Debug.dumpHprofData() æ–¹æ³•ï¼‰ Hprofè£å‰ªä¸»è¦æ˜¯ç”¨leakcanaryçš„sharkç»„ä»¶ï¼ŒLeakCanary ç”¨ shark ç»„ä»¶æ¥å®ç°è£å‰ª hprof æ–‡ä»¶åŠŸèƒ½ï¼Œåœ¨ shark-cli å·¥å…·ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ  strip-hprof é€‰é¡¹æ¥è£å‰ª hprof æ–‡ä»¶ï¼Œå®ƒçš„å®ç°æ€è·¯æ˜¯ï¼šé€šè¿‡å°†æ‰€æœ‰åŸºæœ¬ç±»å‹æ•°ç»„æ›¿æ¢ä¸ºç©ºæ•°ç»„ï¼ˆå¤§å°ä¸å˜ï¼‰ã€‚ å„å®¶æ¡†æ¶åŸºæœ¬éƒ½ä¼šå¯¹è¿™ä»½hprofå†è¿›è¡Œè£å‰ªï¼š Matrix:Matrix çš„è£å‰ªæ€è·¯ä¸»è¦æ˜¯å°†é™¤äº†éƒ¨åˆ†å­—ç¬¦ä¸²å’Œ Bitmap ä»¥å¤–å®ä¾‹å¯¹è±¡ä¸­çš„ buffer æ•°ç»„ã€‚ä¹‹æ‰€ä»¥ä¿ç•™ Bitmap æ˜¯å› ä¸º Matirx æœ‰ä¸ªæ£€æµ‹é‡å¤ Bitmap çš„åŠŸèƒ½ï¼Œä¼šå¯¹ Bitmap çš„ buffer æ•°ç»„åšä¸€æ¬¡ MD5 æ“ä½œæ¥åˆ¤æ–­æ˜¯å¦é‡å¤ã€‚ KOOM é€šè¿‡ xhook å®ç° PLT hookï¼Œé€šè¿‡ hook ä¸¤ä¸ªè™šæ‹Ÿæœºæ–¹æ³• open() å’Œ writ() æ¥å®ç°è£å‰ª hprof KOOM è£å‰ªæ—¶ä¼šæ ¹æ®å †ç±»å‹è¿›è¡Œè£å‰ªï¼š é’ˆå¯¹system spaceï¼ˆZygote Spaceã€Image Spaceï¼‰ï¼šä¼šè£å‰ªPRIMITIVE_ARRAY_DUMPã€HEAP_DUMP_INFOã€INSTANCE_DUMPå’ŒOBJECT_ARRAY_DUMPè¿™4ä¸ªå­TAGï¼Œï¼ˆä¹Ÿå°±æ˜¯åªä¿ç•™äº†CLASS DUMPï¼‰ä¼šåˆ é™¤è¿™å››ä¸ªå­TAGçš„å…¨éƒ¨å†…å®¹ï¼ˆåŒ…å‡½å­TAGå…¨éƒ½ä¼šåˆ é™¤ï¼‰ã€‚ é’ˆå¯¹app spaceï¼šä¼šå¤„ç†PRIMITIVE_ARRAY_DUMPè¿™ä¸€å—æ•°æ®ï¼Œä½†ä¼šä¿ç•™metadataï¼Œæ–¹ä¾¿å›å¡«ã€‚ //æ³¨ï¼šLeakCanary2 é‡å†™äº†ä¸€ä¸ªè§£æ hprof æ–‡ä»¶çš„åº“ï¼Œå«åš sharkï¼Œå®ƒæ˜¯ç”¨æ¥ä»£æ›¿åŸæ¥çš„ hahaï¼Œæ ¹æ®å®˜æ–¹çš„è¯´æ³•ï¼Œç›¸æ¯”äº hahaï¼Œshark å†…å­˜å‡å°‘äº†10å€ï¼Œé€Ÿåº¦å¿«äº†6å€ã€‚KOOM é™¤äº†ä½¿ç”¨ shark æ¥è§£æï¼Œè¿˜åœ¨è¿™ä¸ªçš„åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œå‡å°‘äº†å†…å­˜çš„å ç”¨ï¼Œå…·ä½“å¯ä»¥çœ‹æºç ã€‚ Hprofåˆ†æMatrix: Hprofæ–‡ä»¶ä¸­åŒ…å«äº†Dumpæ—¶åˆ»å†…å­˜ä¸­çš„æ‰€æœ‰å¯¹è±¡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»çš„æè¿°ï¼Œå®ä¾‹çš„æ•°æ®å’Œå¼•ç”¨å…³ç³»ï¼Œçº¿ç¨‹çš„æ ˆä¿¡æ¯ç­‰ã€‚å…·ä½“å¯å‚è€ƒè¿™ä»½æ–‡æ¡£ä¸­çš„Binary Dump Formatä¸€èŠ‚ã€‚æŒ‰ç…§æ–‡æ¡£æè¿°çš„æ ¼å¼å°†Hprofä¸­çš„å®ä¾‹ä¿¡æ¯è§£ææˆæè¿°å¼•ç”¨å…³ç³»çš„å›¾ç»“æ„åï¼Œå¥—ç”¨ç»å…¸çš„å›¾æœç´¢ç®—æ³•å³å¯æ‰¾åˆ°æ³„æ¼çš„Activityåˆ°GC Rootçš„å¼ºå¼•ç”¨é“¾äº†ã€‚ å¤§å¤šæ•°æ—¶å€™è¿™æ ·çš„å¼ºå¼•ç”¨é“¾ä¸æ­¢ä¸€æ¡ï¼Œå…¨éƒ¨æ‰¾å‡ºæ¥ä¼šè®©ä¸€æ¬¡åˆ†ææ“ä½œçš„è€—æ—¶å¤§å¤§å¢åŠ ï¼Œå»¶é•¿äº†æ•´ä¸ªæµ‹è¯•æµç¨‹çš„å‘¨æœŸï¼Œè€Œä¸”å¯¹è§£å†³é—®é¢˜å¹¶æ²¡æœ‰æ›´å¤šå¸®åŠ©ã€‚å®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦æ‰¾åˆ°æœ€çŸ­çš„é‚£æ¡å°±å¯ä»¥äº†ã€‚å¦‚ä¸‹å›¾ï¼š è¿™ç§æƒ…å†µä¸‹åªè¦åˆ‡æ–­è“è‰²ç®­å¤´å³å¯ä½¿æ³„æ¼çš„Activityä¸GC Rootè„±ç¦»è”ç³»ã€‚å¦‚æœæŒæœ‰æ³„æ¼çš„Activityçš„GC Rootä¸æ­¢ä¸€ä¸ªï¼Œæˆ–è€…ä»GC Rootå‡ºå‘çš„å¼•ç”¨ä¸æ­¢ä¸€æ¡ï¼Œåœ¨Matrixæ¡†æ¶æˆä¸ºæµç¨‹åŒ–å·¥å…·çš„èƒŒæ™¯ä¸‹æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šæ¬¡æ£€æµ‹æ¥è§£å†³ï¼Œè¿™æ ·è‡³å°‘ä¿è¯äº†æ¯æ¬¡æ‰§è¡ŒResourceCanaryæ¨¡å—çš„è€—æ—¶ç¨³å®šåœ¨ä¸€ä¸ªå¯é¢„è®¡çš„èŒƒå›´å†…ï¼Œä¸è‡³äºåœ¨æç«¯æƒ…å†µä¸‹è€½è¯¯å…¶ä»–æµç¨‹ã€‚ æœ¬æ¥æˆ‘ä»¬æ‰“ç®—è‡ªè¡Œå®ç°è¿™ä¸ªç®—æ³•ï¼Œå¹¸è¿çš„æ˜¯åœ¨é˜…è¯»LeakCanaryçš„ä»£ç æ—¶æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªå«hahaçš„åº“å·²ç»æŠŠHprofæ–‡ä»¶æŒ‰ç…§æ–‡æ¡£æè¿°çš„æ ¼å¼è§£ææˆäº†ç»“æ„åŒ–çš„å¼•ç”¨å…³ç³»å›¾ï¼Œè€Œä¸”LeakCanaryä¹ŸæŒ‰ç…§ä¸ä¸Šé¢çš„æè¿°ç±»ä¼¼çš„æ€è·¯å®ç°äº†å¼•ç”¨é“¾çš„æå–é€»è¾‘ï¼Œäºæ˜¯æˆ‘ä»¬å°±ä¸å†é‡å¤é€ è½®å­ï¼Œç›´æ¥ä½¿ç”¨äº†LeakCanaryçš„è¿™éƒ¨åˆ†ä»£ç äº†ã€‚ ä»Hprofæ–‡ä»¶ä¸­è·å–æ‰€æœ‰å†—ä½™çš„Bitmapå¯¹è±¡ è¿™ä¸ªåŠŸèƒ½Android Monitorå·²ç»æœ‰å®Œæ•´å®ç°äº†ï¼ŒåŸç†ç®€å•ç²—æš´â€”â€”æŠŠæ‰€æœ‰æœªè¢«å›æ”¶çš„Bitmapçš„æ•°æ®bufferå–å‡ºæ¥ï¼Œç„¶åå…ˆå¯¹æ¯”æ‰€æœ‰é•¿åº¦ä¸º1çš„bufferï¼Œæ‰¾å‡ºç›¸åŒçš„ï¼Œè®°å½•æ‰€å±çš„Bitmapå¯¹è±¡ï¼›å†å¯¹æ¯”æ‰€æœ‰é•¿åº¦ä¸º2çš„ã€é•¿åº¦ä¸º3çš„bufferâ€¦â€¦ç›´åˆ°æŠŠæ‰€æœ‰bufferéƒ½æ¯”å¯¹å®Œï¼Œè¿™æ ·å°±è®°å½•ä¸‹äº†æ‰€æœ‰å†—ä½™çš„Bitmapå¯¹è±¡äº†ï¼Œæ¥ç€å†å¥—ç”¨LeakCanaryè·å–å¼•ç”¨é“¾çš„é€»è¾‘æŠŠè¿™äº›Bitmapå¯¹è±¡åˆ°GC Rootçš„æœ€çŸ­å¼ºå¼•ç”¨é“¾æ‰¾å‡ºæ¥å³å¯ã€‚ ç¾å›¢Probe Probe è¿˜ä¼˜åŒ–åˆ†ææ³„éœ²å¯¹è±¡çš„é“¾è·¯ï¼Œå› ä¸º Probe ç›¸å¯¹äºå…¶ä»–æ–¹æ¡ˆï¼Œç†è®ºä¸Šå®ƒæ˜¯æ”¯æŒæ‰€æœ‰å¯¹è±¡çš„å†…å­˜æ³„éœ²æ£€æµ‹çš„ï¼ˆæ’é™¤äº†åŸå§‹ç±»å‹ç­‰ï¼‰ï¼Œè€Œ LeakCanary å’Œ Matrix åªæ”¯æŒ Activity å’Œ Fragment ç­‰å¯¹è±¡ï¼Œè¿™ä¸ªä¼˜åŒ–æ˜¯åŸºäº RetainSize è¶Šå¤§çš„å¯¹è±¡å¯¹å†…å­˜çš„å½±å“ä¹Ÿè¶Šå¤§ï¼Œæ˜¯æœ€æœ‰å¯èƒ½é€ æˆOOMçš„â€œå…ƒå‡¶â€ è¿™ä¸€åŸåˆ™ã€‚ é¦–å…ˆï¼Œåœ¨ dump å‡ºæ‰€æœ‰å¯¹è±¡åï¼Œåˆ›å»ºä¸€ä¸ª TOP N çš„å°æ ¹å †ï¼Œæ ¹æ® RetainSize æ’åºï¼Œåˆå§‹ N é»˜è®¤æ˜¯ 5ï¼Œè¿™é‡Œæœ‰ä¸ªå°ç»†èŠ‚ï¼Œå°±æ˜¯ Probe ä¼šå¤„ç† ByteArray ç±»å‹çš„å®ä¾‹ï¼š 1234å¤åˆ¶ä»£ç if (isByteArray(var6)) { var6.parent.addRetainedSize(var1.getHeapIndex(var4), var6.getTotalRetainedSize()); var15.add(var6.parent);} å°† ByteArray çš„ RetainSize åŠ åˆ°å®ƒçš„çˆ¶èŠ‚ç‚¹ï¼ŒåŒæ—¶å°†å®ƒçš„çˆ¶èŠ‚ç‚¹åŠ åˆ°å †ä¸­ã€‚ åœ¨åˆå§‹åŒ–å°æ ¹å †åï¼Œç»§ç»­éå†åšåŠ¨æ€è°ƒæ•´ï¼Œå°†å¤§äºæ–‡ä»¶å¤§å° 5% çš„å¯¹è±¡ç›´æ¥åŠ åˆ°å †ä¸­ï¼ŒåŒæ—¶å¢å¤§ TOP N çš„å€¼ï¼Œå¦åˆ™ï¼Œè·Ÿå †é¡¶å…ƒç´ åšæ¯”è¾ƒã€‚åœ¨éå†å¯¹è±¡çš„åŒæ—¶ï¼Œå¦‚æœæ˜¯ç›¸åŒç±»çš„ä¸åŒå®ä¾‹ï¼Œåˆ™åªä¼šä¿å­˜ä¸€ä»½å®ä¾‹ï¼ŒåŒæ—¶å°†å®ƒä»¬çš„ RetainSize å’Œ Num è®¡ç®—è¿›å»ï¼š 12345å¤åˆ¶ä»£ç if (var3.containsKey(var9)) { InstanceExtra var17 = (InstanceExtra)var3.get(var9); var17.retainSize += var6.getTotalRetainedSize(); ++var17.num;} è¿˜ä¼šå°†åœ¨ è®¡æ•°å‹ç¼©é€»è¾‘ ä¸­ RetainSize è¡¥å›æ¥ï¼š 123456789å¤åˆ¶ä»£ç if (var10 != null) { var16.retainSize += var10.getSize(); long var11 = var16.num; var16.num = (long)var10.getCount() + var11; ClassCountInfo var18 = (ClassCountInfo)AbandonedInstanceManager.getInstance().countMap.get(var9); if (var18 != null &amp;&amp; var18.classId &gt; 0L) { var16.id = var18.classId; } } å…³äº OOMOut of memory (OOM) å½“ç³»ç»Ÿæ— æ³•æ»¡è¶³ç”³è¯·çš„å†…å­˜å¤§å°æ—¶ï¼Œå°±ä¼šæŠ›å‡º OOM é”™è¯¯ã€‚å¯¼è‡´ OOM çš„åŸå› ï¼Œé™¤äº†æˆ‘ä»¬ä¸Šé¢è¯´è®²çš„å†…å­˜æ³„éœ²ä»¥å¤–ï¼Œå¯èƒ½è¿˜ä¼šæ˜¯çº¿ç¨‹åˆ›å»ºè¶…è¿‡é™åˆ¶ï¼Œå¯ä»¥é€šè¿‡ /proc/sys/kernel/threads-max è·å–ï¼š 12cat /proc/sys/kernel/threads-max26418 è¿˜æœ‰ä¸€ç§å¯èƒ½æ˜¯ FDï¼ˆFile descriptorï¼‰æ–‡ä»¶æè¿°ç¬¦è¶…è¿‡é™åˆ¶ï¼Œå¯ä»¥é€šè¿‡ /proc/pid/limits è·å–ï¼Œå…¶ä¸­ Max open files å°±æ˜¯å¯åˆ›å»ºçš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ï¼š 12Limit Soft Limit Hard Limit UnitsMax open files 4096 4096 files LeakCanary å…·ä½“åŸç†â€‹ å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š â€‹ Applicationä¸­intallï¼ˆæ–°ç‰ˆæœ¬ä¸ç”¨ï¼Œæ˜¯é€šè¿‡ContenProvideråˆ›å»ºæ—¶æ‹¿åˆ°applicationå¯¹è±¡åè‡ªåŠ¨æ³¨å†Œï¼‰ã€‚â€‹â€‹ ç„¶å é€šè¿‡application.registerActivityLifecycleCallbacks å¯¹æ¯ä¸ªactivity æ³¨å†Œç”Ÿå‘½å‘¨æœŸ onDestroy()å›è°ƒï¼Œâ€‹ å¹¶è¿›ä¸€æ­¥ï¼Œæ ¹æ®ä¸åŒçš„Android APIï¼Œå…¼å®¹åœ°å¯¹ AndroidXï¼ŒAndroidOï¼ŒSupport libç­‰è°ƒç”¨ activity.fragmentManager/activity.supportFragmentManageræ–¹æ³•ï¼Œç›‘å¬fragmentçš„ç”Ÿå‘½å‘¨æœŸ çš„ onDestroyView() å’Œ onDestroy() â€‹ åœ¨ activity/fragment é”€æ¯çš„ç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œè°ƒç”¨watchæ–¹æ³•ã€‚æ‰§è¡ŒremoveWeaklyReachableObjects()//â€œç§»é™¤watchedObjectsä¸­å«æœ‰çš„queueå…ƒç´ å«æœ‰çš„key ç„¶åå°†è¯¥activity/fragmentçš„å¼±å¼•ç”¨å¯¹è±¡KeyWeakReferenceæ·»åŠ å…¥å“ˆå¸Œè¡¨watchedObjectsï¼ˆRandomUUID ä¸ºkeyï¼Œqueue ä¸ºå¼±å¼•ç”¨çš„ç¬¬äºŒå‚æ•°é˜Ÿåˆ—ï¼‰ã€‚ ä¹‹ååœ¨å­çº¿ç¨‹ä¸­å†æ¥ä¸€æ¬¡ç§»é™¤å¼±å¯è¾¾å¯¹è±¡removeWeaklyReachableObjectsï¼Œæ¥ä¸‹æ¥è°ƒç”¨gcï¼ˆä¼‘çœ 100msï¼‰ï¼Œæœ€åç•™å­˜ä¸‹æ¥çš„watchedObjects å³ä¸ºå¤§æ¦‚ç‡æ³„éœ²çš„å¯¹è±¡â€‹ å¦‚æœ å¤„äºè°ƒè¯•çŠ¶æ€/å·²æ£€æµ‹æ³„éœ²å¯¹è±¡è¶…è¿‡5ä¸ª/æ®ä¸Šä¸€æ¬¡dumpæ—¶é—´å°äº60s returnâ€‹ dumpæ—¶è°ƒç”¨Debug.dumpHprofData()æ–¹æ³•ï¼Œè·å–å †ä¿¡æ¯å­˜å‚¨åˆ°æœ¬åœ°æ–‡ä»¶ã€‚ç„¶ååœ¨HeapAnalyzeServiceä¸­è¿›è¡Œåˆ†æï¼ˆâ€sharkåº“è¿›è¡Œåˆ†æâ€ï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152 //è¿›å…¥destoryæµç¨‹çš„activity æˆ– fragment çš„å¼±å¼•ç”¨å¯¹è±¡map private val watchedObjects = mutableMapOf&lt;String, KeyedWeakReference&gt;() //å³å°†è¢«é¡ºåˆ©é”€æ¯çš„activity æˆ– fragmentçš„å¼±å¼•ç”¨å¯¹è±¡é˜Ÿåˆ— private val queue = ReferenceQueue&lt;Any&gt;() @Synchronized fun watch( watchedObject: Any, description: String ) { if (!isEnabled()) { return } removeWeaklyReachableObjects() val key = UUID.randomUUID() .toString() val watchUptimeMillis = clock.uptimeMillis() val reference = KeyedWeakReference(watchedObject, key, description, watchUptimeMillis, queue)//... watchedObjects[key] = reference checkRetainedExecutor.execute { moveToRetained(key) } } @Synchronized private fun moveToRetained(key: String) { removeWeaklyReachableObjects() val retainedRef = watchedObjects[key] if (retainedRef != null) { retainedRef.retainedUptimeMillis = clock.uptimeMillis() onObjectRetainedListeners.forEach { it.onObjectRetained() } } } private fun removeWeaklyReachableObjects() { // WeakReferences are enqueued as soon as the object to which they point to becomes weakly // reachable. This is before finalization or garbage collection has actually happened. var ref: KeyedWeakReference? //do whileå¾ªç¯ï¼Œæ•´ä½“å°±æ˜¯å°†watchObjects Mapä¸­ å«æœ‰çš„ queueæˆå‘˜keyçš„ å…ƒç´ ç§»é™¤ //æ„åœ¨ä¿ç•™æœ‰å¯èƒ½æ³„éœ²çš„å¯¹è±¡ çš„ å¼±å¼•ç”¨å¯¹è±¡ do { ref = queue.poll() as KeyedWeakReference? if (ref != null) { //æ’é™¤æ‰ queueä¸­è¿™äº›å³å°†è¢«å›æ”¶çš„å¼±å¼•ç”¨å¯¹è±¡ï¼Œå°±æ˜¯æœ‰å¯èƒ½ä¼šæ³„éœ²çš„å¼±å¼•ç”¨å¯¹è±¡ watchedObjects.remove(ref.key) } } while (ref != null) } APIhttps://square.github.io/leakcanary/recipes/#matching-known-library-leaks LeakCanary config val dumpHeap: Boolean = true, val dumpHeapWhenDebugging: Boolean = false, val retainedVisibleThreshold: Int = 5, val referenceMatchers: List = AndroidReferenceMatchers.appDefaults, val onHeapAnalyzedListener: OnHeapAnalyzedListener = DefaultOnHeapAnalyzedListener.create(), val metadataExtractor: MetadataExtractor = AndroidMetadataExtractor, val computeRetainedHeapSize: Boolean = true, val maxStoredHeapDumps: Int = 7, val requestWriteExternalStoragePermission: Boolean = false, val leakingObjectFinder: LeakingObjectFinder = KeyedWeakReferenceFinder, val useExperimentalLeakFinders: Boolean = false AppWatcher config val watchActivities: Boolean = true, val watchFragments: Boolean = true, val watchFragmentViews: Boolean = true, val watchViewModels: Boolean = true, val watchDurationMillis: Long = TimeUnit.SECONDS.toMillis(5), val enabled: Boolean = true åˆ†ç¦»è¿›ç¨‹åˆ†ææ³„æ¼dependencies { // debugImplementation 'com.squareup.leakcanary:leakcanary-android:${version}' debugImplementation 'com.squareup.leakcanary:leakcanary-android-process:${version}' } è¡¥å…… ActivityDestroyWatcheråˆå§‹åŒ–ï¼šapplicationæ³¨å†Œç›‘å¬Activityç”Ÿå‘½å‘¨æœŸï¼Œå¹¶åœ¨Activity destroyçš„æ—¶å€™è°ƒç”¨objectWatcher.watch() FragmentDestroyWatcheråˆå§‹åŒ–ï¼š å¦‚æœandroid 8.0ä»¥ä¸Šï¼Œæ³¨å†ŒAndroidOFragmentDestroyWatcherç›‘å¬fragmentç”Ÿå‘½å‘¨æœŸ æ³¨å†ŒAndroidSupportFragmentDestroyWatcherç›‘å¬fragmentç”Ÿå‘½å‘¨æœŸ æ³¨å†ŒAndroidXFragmentDestroyWatcherç›‘å¬fragmentç”Ÿå‘½å‘¨æœŸ ä»¥ä¸Šä¸‰ç§æœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡ä¼ å…¥çš„Activity.fragmentManager.registerFragmentLifecycleCallbacksè¿›è¡Œç›‘å¬fragmentç”Ÿå‘½å‘¨æœŸå›è°ƒ é€šè¿‡InternalLeakCanaryç±»çš„invokeå‡½æ•°ï¼š åˆå§‹åŒ–ä¸€äº›æ£€æµ‹å†…å­˜æ³„éœ²è¿‡ç¨‹ä¸­éœ€è¦çš„å¯¹è±¡ã€‚ addOnObjectRetainedListenerè®¾ç½®å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼çš„å›è°ƒã€‚ é€šè¿‡AndroidHeapDumperè¿›è¡Œå†…å­˜æ³„æ¼ä¹‹åè¿›è¡Œ heap dump ä»»åŠ¡ã€‚ é€šè¿‡GcTrigger æ‰‹åŠ¨è°ƒç”¨ GC å†æ¬¡ç¡®è®¤å†…å­˜æ³„éœ²ã€‚ å¯åŠ¨å†…å­˜æ³„æ¼æ£€æŸ¥çš„çº¿ç¨‹ã€‚ é€šè¿‡registerVisibilityListenerç›‘å¬åº”ç”¨ç¨‹åºçš„å¯è§æ€§ã€‚ å®è·µåŸºäºLeakCanary2.5ã€‚ é—®é¢˜ï¼šViewPageråˆ‡æ¢Fragmentæ—¶ï¼Œä¸šåŠ¡ä¸Šä¼šå°†æ‰€æœ‰å±•ç¤ºè¿‡çš„Fragmentéƒ½åŠ å…¥åˆ—è¡¨æ‰‹åŠ¨ç¼“å­˜ï¼Œè€ŒViewPagerçš„é»˜è®¤ç¼“å­˜æœºåˆ¶æ˜¯ä¸è¶…è¿‡ä¸‰ä¸ªï¼Œè¶…å‡ºçš„Fragmentæ ¹æ®LRUè°ƒç”¨å…¶onDestroyViewç”Ÿå‘½å‘¨æœŸç§»é™¤å…¶ä¸­çš„æ‰€æœ‰Viewã€‚ä½†å¯¹äºä¸šåŠ¡æ¥è¯´æˆ‘ä»¬ä¸å¸Œæœ›ç”¨æˆ·åˆ‡æ¢å›æ¥ä¹‹åç”±äºViewPagerçš„ç¼“å­˜é™åˆ¶è€Œé‡æ–°ç­‰å¾…viewçš„åˆ›å»ºåŠ è½½ï¼ŒåŒæ—¶ä¹Ÿä¸å¸Œæœ›å¼€å‘è€…é’ˆå¯¹è¿™ç§æƒ…å†µè°ƒç”¨ViewPagerçš„setOffscreenPageLimit()çš„æ–¹å¼å®ç°ã€‚ è§£å†³æ–¹æ¡ˆï¼š é€šè¿‡åœ¨åˆå§‹åŒ–æ—¶é€šè¿‡é…ç½®AppWatcher.configå…³é—­LeakCanaryå¯¹Fragmentçš„æ³„éœ²ç›‘å¬ï¼Œç„¶åè‡ªå·±å®ç°ä¸€å¥—ï¼ˆCVåŸä»£ç æ”¹åŠ¨ï¼‰å…³äºFragmentçš„æ³„éœ²ç›‘å¬ã€‚ 1234567891011121314151617181920212223242526272829//å…ˆé…ç½®ï¼Œå°†FragmentåŠFragmentViewçš„æ³„éœ²ä»LeakCanaryè½¬åˆ°ä»¥ä¸‹è‡ªå·±å®ç°é€»è¾‘AppWatcher.config = AppWatcher.config.copy(watchFragments = false, watchFragmentViews = false)val fragmentDestroyWatchers = mutableListOf&lt;(Activity) -&gt; Unit&gt;()//LeakCanaryé’ˆå¯¹AndroidOã€AndroidXã€AndoridSurportåˆ†åˆ«å¤„ç†ï¼Œæ­¤å¤„åªä»¥ä½¿ç”¨è¾ƒå¤šçš„AndroidXä¸ºä¾‹getWatcherIfAvailable( &quot;androidx.fragment.app.Fragment&quot;, &quot;com.youself.AndroidXFragmentDestroyWatcher&quot;, objectWatcher, { configProvider() })?.let { fragmentDestroyWatchers.add(it)}app.registerActivityLifecycleCallbacks(object : Application.ActivityLifecycleCallbacks by noOpDelegate() { override fun onActivityCreated( activity: Activity, savedInstanceState: Bundle? ) { for (watcher in fragmentDestroyWatchers) { if (!isIgnoreActivity(activity)) { watcher(activity) } } }}) 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253//#leakcanary.internal.AndroidXFragmentDestroyWatcher.classpackage leakcanary.internalinternal class AndroidXFragmentDestroyWatcher( private val reachabilityWatcher: ReachabilityWatcher) : (Activity) -&gt; Unit { private val fragmentLifecycleCallbacks = object : FragmentManager.FragmentLifecycleCallbacks() { override fun onFragmentCreated( fm: FragmentManager, fragment: Fragment, savedInstanceState: Bundle? ) { ViewModelClearedWatcher.install(fragment, reachabilityWatcher) } /*å…¶å®ä¹Ÿæ²¡å•¥ï¼Œå°±æ˜¯æ³¨é‡Šæ‰è¿™ä¸ªæ–¹æ³•å°±è¡Œäº†ï¼Œå…¶ä»–ç‰ˆæœ¬å…¼å®¹çš„Fragmentç›‘å¬ç±»åŒæ ·å¤„ç† override fun onFragmentViewDestroyed( fm: FragmentManager, fragment: Fragment ) { val view = fragment.view if (view != null) { reachabilityWatcher.expectWeaklyReachable( view, &quot;${fragment::class.java.name} received Fragment#onDestroyView() callback &quot; + &quot;(references to its views should be cleared to prevent leaks)&quot; ) } } */ override fun onFragmentDestroyed( fm: FragmentManager, fragment: Fragment ) { reachabilityWatcher.expectWeaklyReachable( fragment, &quot;${fragment::class.java.name} received Fragment#onDestroy() callback&quot; ) } } override fun invoke(activity: Activity) { if (activity is FragmentActivity) { val supportFragmentManager = activity.supportFragmentManager supportFragmentManager.registerFragmentLifecycleCallbacks(fragmentLifecycleCallbacks, true) ViewModelClearedWatcher.install(activity, reachabilityWatcher) } }}","link":"/2021/04/06/Leakcanary/"},{"title":"Full-QA","text":"ä¸€ã€åŸºç¡€ç¯‡ç½‘ç»œåŸºç¡€TCPä¸‰æ¬¡æ¡æ‰‹ ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š å®¢æˆ·ç«¯â€”â€”å‘é€å¸¦æœ‰SYNæ ‡å¿—çš„æ•°æ®åŒ…â€”â€”æœåŠ¡ç«¯ ä¸€æ¬¡æ¡æ‰‹ Clientè¿›å…¥syn_sentçŠ¶æ€ æœåŠ¡ç«¯â€”â€”å‘é€å¸¦æœ‰SYN/ACKæ ‡å¿—çš„æ•°æ®åŒ…â€”â€”å®¢æˆ·ç«¯ äºŒæ¬¡æ¡æ‰‹ æœåŠ¡ç«¯è¿›å…¥syn_rcvd å®¢æˆ·ç«¯â€”â€”å‘é€å¸¦æœ‰ACKæ ‡å¿—çš„æ•°æ®åŒ…â€”â€”æœåŠ¡ç«¯ ä¸‰æ¬¡æ¡æ‰‹ è¿æ¥å°±è¿›å…¥EstablishedçŠ¶æ€ ä¸ºä»€ä¹ˆä¸‰æ¬¡ï¼š ä¸»è¦æ˜¯ä¸ºäº†å»ºç«‹å¯é çš„é€šä¿¡ä¿¡é“ï¼Œä¿è¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯åŒæ—¶å…·å¤‡å‘é€ã€æ¥æ”¶æ•°æ®çš„èƒ½åŠ› ä¸ºä»€ä¹ˆä¸¤æ¬¡ä¸è¡Œï¼Ÿ 1ã€é˜²æ­¢å·²å¤±æ•ˆçš„è¯·æ±‚æŠ¥æ–‡åˆä¼ é€åˆ°äº†æœåŠ¡ç«¯ï¼Œå»ºç«‹äº†å¤šä½™çš„é“¾æ¥ï¼Œæµªè´¹èµ„æº 2ã€ ä¸¤æ¬¡æ¡æ‰‹åªèƒ½ä¿è¯å•å‘è¿æ¥æ˜¯ç•…é€šçš„ã€‚ï¼ˆä¸ºäº†å®ç°å¯é æ•°æ®ä¼ è¾“ï¼Œ TCP åè®®çš„é€šä¿¡åŒæ–¹ï¼Œ éƒ½å¿…é¡»ç»´ æŠ¤ä¸€ä¸ªåºåˆ—å·ï¼Œ ä»¥æ ‡è¯†å‘é€å‡ºå»çš„æ•°æ®åŒ…ä¸­ï¼Œ å“ªäº›æ˜¯å·²ç»è¢«å¯¹æ–¹æ”¶åˆ°çš„ã€‚ ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹å³æ˜¯é€šä¿¡åŒæ–¹ ç›¸äº’å‘ŠçŸ¥åºåˆ—å·èµ·å§‹å€¼ï¼Œ å¹¶ç¡®è®¤å¯¹æ–¹å·²ç»æ”¶åˆ°äº†åºåˆ—å·èµ·å§‹å€¼çš„å¿…ç»æ­¥éª¤ï¼›å¦‚æœåªæ˜¯ä¸¤æ¬¡æ¡æ‰‹ï¼Œ è‡³å¤šåªæœ‰è¿æ¥å‘èµ·æ–¹çš„èµ·å§‹åºåˆ—å·èƒ½è¢«ç¡®è®¤ï¼Œ å¦ä¸€æ–¹é€‰æ‹©çš„åºåˆ—å·åˆ™å¾—ä¸åˆ°ç¡®è®¤ï¼‰ **TCPå››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹ ** å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹ï¼š å®¢æˆ·ç«¯â€”â€”å‘é€å¸¦æœ‰FINæ ‡å¿—çš„æ•°æ®åŒ…â€”â€”æœåŠ¡ç«¯ï¼Œå…³é—­ä¸æœåŠ¡ç«¯çš„è¿æ¥ ï¼Œå®¢æˆ·ç«¯è¿›å…¥FIN-WAIT-1çŠ¶æ€ æœåŠ¡ç«¯æ”¶åˆ°è¿™ä¸ª FINï¼Œå®ƒå‘å›â¼€ ä¸ª ACKï¼Œç¡®è®¤åºå·ä¸ºæ”¶åˆ°çš„åºå·åŠ 1ï¼ŒæœåŠ¡ç«¯å°±è¿›å…¥äº†CLOSE-WAITçŠ¶æ€ æœåŠ¡ç«¯â€”â€”å‘é€â¼€ä¸ªFINæ•°æ®åŒ…â€”â€”å®¢æˆ·ç«¯ï¼Œå…³é—­ä¸å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå®¢æˆ·ç«¯å°±è¿›å…¥FIN-WAIT-2çŠ¶æ€ å®¢æˆ·ç«¯æ”¶åˆ°è¿™ä¸ª FINï¼Œå‘å› ACK æŠ¥â½‚ç¡®è®¤ï¼Œå¹¶å°†ç¡®è®¤åºå·è®¾ç½®ä¸ºæ”¶åˆ°åºå·åŠ 1ï¼ŒTIME-WAITçŠ¶æ€ ä¸ºä»€ä¹ˆå››æ¬¡ï¼š å› ä¸ºéœ€è¦ç¡®ä¿å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„æ•°æ®èƒ½å¤Ÿå®Œæˆä¼ è¾“ã€‚ CLOSE-WAITï¼š è¿™ç§çŠ¶æ€çš„å«ä¹‰å…¶å®æ˜¯è¡¨ç¤ºåœ¨ç­‰å¾…å…³é—­ TIME-WAITï¼š ä¸ºäº†è§£å†³ç½‘ç»œçš„ä¸¢åŒ…å’Œç½‘ç»œä¸ç¨³å®šæ‰€å¸¦æ¥çš„å…¶ä»–é—®é¢˜ï¼Œç¡®ä¿è¿æ¥æ–¹èƒ½åœ¨æ—¶é—´èŒƒå›´å†…ï¼Œå…³é—­è‡ªå·±çš„è¿æ¥ å¦‚ä½•æŸ¥çœ‹TIME-WAITçŠ¶æ€çš„é“¾æ¥æ•°é‡ï¼Ÿ netstat -an |grep TIME_WAIT|wc -l æŸ¥çœ‹è¿æ¥æ•°ç­‰å¾…time_waitçŠ¶æ€è¿æ¥æ•° ä¸ºä»€ä¹ˆä¼šTIME-WAITè¿‡å¤šï¼Ÿè§£å†³æ–¹æ³•æ˜¯æ€æ ·çš„ï¼Ÿ å¯èƒ½åŸå› ï¼š é«˜å¹¶å‘çŸ­è¿æ¥çš„TCPæœåŠ¡å™¨ä¸Šï¼Œå½“æœåŠ¡å™¨å¤„ç†å®Œè¯·æ±‚åç«‹åˆ»æŒ‰ç…§ä¸»åŠ¨æ­£å¸¸å…³é—­è¿æ¥ è§£å†³ï¼šè´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼›WebæœåŠ¡å™¨é¦–å…ˆå…³é—­æ¥è‡ªè´Ÿè½½å‡è¡¡æœåŠ¡å™¨çš„è¿æ¥ 1ã€OSIä¸TCP/IP æ¨¡å‹ OSIä¸ƒå±‚ï¼šç‰©ç†å±‚ã€æ•°æ®é“¾è·¯å±‚ã€ç½‘ç»œå±‚ã€ä¼ è¾“å±‚ã€ä¼šè¯å±‚ã€è¡¨ç¤ºå±‚ã€åº”ç”¨å±‚ TCP/IPäº”å±‚ï¼šç‰©ç†å±‚ã€æ•°æ®é“¾è·¯å±‚ã€ç½‘ç»œå±‚ã€ä¼ è¾“å±‚ã€åº”ç”¨å±‚ 2ã€å¸¸è§ç½‘ç»œæœåŠ¡åˆ†å±‚ åº”ç”¨å±‚ï¼šHTTPã€SMTPã€DNSã€FTP ä¼ è¾“å±‚ï¼šTCP ã€UDP ç½‘ç»œå±‚ï¼šICMP ã€IPã€è·¯ç”±å™¨ã€é˜²ç«å¢™ æ•°æ®é“¾è·¯å±‚ï¼šç½‘å¡ã€ç½‘æ¡¥ã€äº¤æ¢æœº ç‰©ç†å±‚ï¼šä¸­ç»§å™¨ã€é›†çº¿å™¨ 3ã€TCPä¸UDPåŒºåˆ«åŠåœºæ™¯ ç±»å‹ ç‰¹ç‚¹ æ€§èƒ½ åº”ç”¨è¿‡åœºæ™¯ é¦–éƒ¨å­—èŠ‚ TCP é¢å‘è¿æ¥ã€å¯é ã€å­—èŠ‚æµ ä¼ è¾“æ•ˆç‡æ…¢ã€æ‰€éœ€èµ„æºå¤š æ–‡ä»¶ã€é‚®ä»¶ä¼ è¾“ 20-60 UDP æ— è¿æ¥ã€ä¸å¯é ã€æ•°æ®æŠ¥æ–‡æ®µ ä¼ è¾“æ•ˆç‡å¿«ã€æ‰€éœ€èµ„æºå°‘ è¯­éŸ³ã€è§†é¢‘ã€ç›´æ’­ 8ä¸ªå­—èŠ‚ åŸºäºTCPçš„åè®®ï¼šHTTPã€FTPã€SMTP åŸºäºUDPçš„åè®®ï¼šRIPã€DNSã€SNMP 4ã€TCPæ»‘åŠ¨çª—å£ï¼Œæ‹¥å¡æ§åˆ¶ TCPé€šè¿‡ï¼šåº”ç”¨æ•°æ®åˆ†å‰²ã€å¯¹æ•°æ®åŒ…è¿›è¡Œç¼–å·ã€æ ¡éªŒå’Œã€æµé‡æ§åˆ¶ã€æ‹¥å¡æ§åˆ¶ã€è¶…æ—¶é‡ä¼ ç­‰æªæ–½ä¿è¯æ•°æ®çš„å¯é ä¼ è¾“ï¼› æ‹¥å¡æ§åˆ¶ç›®çš„ï¼šä¸ºäº†é˜²æ­¢è¿‡å¤šçš„æ•°æ®æ³¨å…¥åˆ°ç½‘ç»œä¸­ï¼Œé¿å…ç½‘ç»œä¸­çš„è·¯ç”±å™¨ã€é“¾è·¯è¿‡è½½ æ‹¥å¡æ§åˆ¶è¿‡ç¨‹ï¼šTCPç»´æŠ¤ä¸€ä¸ªæ‹¥å¡çª—å£ï¼Œè¯¥çª—å£éšç€ç½‘ç»œæ‹¥å¡ç¨‹åº¦åŠ¨æ€å˜åŒ–ï¼Œé€šè¿‡æ…¢å¼€å§‹ã€æ‹¥å¡é¿å…ç­‰ç®—æ³•å‡å°‘ç½‘ç»œæ‹¥å¡çš„å‘ç”Ÿã€‚ 5ã€TCPç²˜åŒ…åŸå› å’Œè§£å†³æ–¹æ³• TCPç²˜åŒ…æ˜¯æŒ‡ï¼šå‘é€æ–¹å‘é€çš„è‹¥å¹²åŒ…æ•°æ®åˆ°æ¥æ”¶æ–¹æ¥æ”¶æ—¶ç²˜æˆä¸€åŒ… å‘é€æ–¹åŸå› ï¼š TCPé»˜è®¤ä½¿ç”¨Nagleç®—æ³•ï¼ˆä¸»è¦ä½œç”¨ï¼šå‡å°‘ç½‘ç»œä¸­æŠ¥æ–‡æ®µçš„æ•°é‡ï¼‰ï¼š æ”¶é›†å¤šä¸ªå°åˆ†ç»„ï¼Œåœ¨ä¸€ä¸ªç¡®è®¤åˆ°æ¥æ—¶ä¸€èµ·å‘é€ã€å¯¼è‡´å‘é€æ–¹å¯èƒ½ä¼šå‡ºç°ç²˜åŒ…é—®é¢˜ æ¥æ”¶æ–¹åŸå› ï¼š TCPå°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¿å­˜åœ¨æ¥æ”¶ç¼“å­˜é‡Œï¼Œå¦‚æœTCPæ¥æ”¶æ•°æ®åŒ…åˆ°ç¼“å­˜çš„é€Ÿåº¦å¤§äºåº”ç”¨ç¨‹åºä»ç¼“å­˜ä¸­è¯»å–æ•°æ®åŒ…çš„é€Ÿåº¦ï¼Œå¤šä¸ªåŒ…å°±ä¼šè¢«ç¼“å­˜ï¼Œåº”ç”¨ç¨‹åºå°±æœ‰å¯èƒ½è¯»å–åˆ°å¤šä¸ªé¦–å°¾ç›¸æ¥ç²˜åˆ°ä¸€èµ·çš„åŒ…ã€‚ è§£å†³ç²˜åŒ…é—®é¢˜ï¼š æœ€æœ¬è´¨åŸå› åœ¨ä¸æ¥æ”¶å¯¹ç­‰æ–¹æ— æ³•åˆ†è¾¨æ¶ˆæ¯ä¸æ¶ˆæ¯ä¹‹é—´çš„è¾¹ç•Œåœ¨å“ªï¼Œé€šè¿‡ä½¿ç”¨æŸç§æ–¹æ¡ˆç»™å‡ºè¾¹ç•Œï¼Œä¾‹å¦‚ï¼š å‘é€å®šé•¿åŒ…ã€‚æ¯ä¸ªæ¶ˆæ¯çš„å¤§å°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ¥æ”¶æ–¹åªè¦ç´¯è®¡æ¥æ”¶æ•°æ®ï¼Œç›´åˆ°æ•°æ®ç­‰äºä¸€ä¸ªå®šé•¿çš„æ•°å€¼å°±å°†å®ƒä½œä¸ºä¸€ä¸ªæ¶ˆæ¯ã€‚ åŒ…å°¾åŠ ä¸Š\\r\\næ ‡è®°ã€‚FTPåè®®æ­£æ˜¯è¿™ä¹ˆåšçš„ã€‚ä½†é—®é¢˜åœ¨äºå¦‚æœæ•°æ®æ­£æ–‡ä¸­ä¹Ÿå«æœ‰\\r\\nï¼Œåˆ™ä¼šè¯¯åˆ¤ä¸ºæ¶ˆæ¯çš„è¾¹ç•Œã€‚ åŒ…å¤´åŠ ä¸ŠåŒ…ä½“é•¿åº¦ã€‚åŒ…å¤´æ˜¯å®šé•¿çš„4ä¸ªå­—èŠ‚ï¼Œè¯´æ˜äº†åŒ…ä½“çš„é•¿åº¦ã€‚æ¥æ”¶å¯¹ç­‰æ–¹å…ˆæ¥æ”¶åŒ…ä½“é•¿åº¦ï¼Œä¾æ®åŒ…ä½“é•¿åº¦æ¥æ¥æ”¶åŒ…ä½“ã€‚ 6ã€TCPã€UDPæŠ¥æ–‡æ ¼å¼ TCPæŠ¥æ–‡æ ¼å¼ï¼š æºç«¯å£å·å’Œç›®çš„ç«¯å£å·ï¼š ç”¨äºå¯»æ‰¾å‘ç«¯å’Œæ”¶ç«¯åº”ç”¨è¿›ç¨‹ã€‚è¿™ä¸¤ä¸ªå€¼åŠ ä¸Šipé¦–éƒ¨æºç«¯ipåœ°å€å’Œç›®çš„ç«¯ipåœ°å€å”¯ä¸€ç¡®å®šä¸€ä¸ªtcpè¿æ¥ã€‚ åºå·å­—æ®µï¼š åºå·ç”¨æ¥æ ‡è¯†ä»T C På‘ç«¯å‘T C Pæ”¶ç«¯å‘é€çš„æ•°æ®å­—èŠ‚æµï¼Œå®ƒè¡¨ç¤ºåœ¨è¿™ä¸ªæŠ¥æ–‡æ®µä¸­çš„çš„ç¬¬ä¸€ä¸ªæ•°æ®å­—èŠ‚ã€‚å¦‚æœå°†å­—èŠ‚æµçœ‹ä½œåœ¨ä¸¤ä¸ªåº”ç”¨ç¨‹åºé—´çš„å•å‘æµåŠ¨ï¼Œåˆ™ T C Pç”¨åºå·å¯¹æ¯ä¸ªå­—èŠ‚è¿›è¡Œè®¡æ•°ã€‚åºå·æ˜¯32 bitçš„æ— ç¬¦å·æ•°ï¼Œåºå·åˆ°è¾¾ 2^32-1ååˆä»0å¼€å§‹ã€‚ å½“å»ºç«‹ä¸€ä¸ªæ–°çš„è¿æ¥æ—¶ï¼ŒSYNæ ‡å¿—å˜1ã€‚åºå·å­—æ®µåŒ…å«ç”±è¿™ä¸ªä¸»æœºé€‰æ‹©çš„è¯¥è¿æ¥çš„åˆå§‹åºå·ISNï¼ˆInitial Sequence Numberï¼‰ã€‚è¯¥ä¸»æœºè¦å‘é€æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚åºå·ä¸ºè¿™ä¸ªISNåŠ 1ï¼Œå› ä¸ºSYNæ ‡å¿—æ¶ˆè€—äº†ä¸€ä¸ªåºå· ç¡®è®¤åºå·ï¼š æ—¢ç„¶æ¯ä¸ªä¼ è¾“çš„å­—èŠ‚éƒ½è¢«è®¡æ•°ï¼Œç¡®è®¤åºå·åŒ…å«å‘é€ç¡®è®¤çš„ä¸€ç«¯æ‰€æœŸæœ›æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªåºå·ã€‚å› æ­¤ï¼Œç¡®è®¤åºå·åº”å½“æ˜¯ä¸Šæ¬¡å·²æˆåŠŸæ”¶åˆ°æ•°æ®å­—èŠ‚åºå·åŠ  1ã€‚åªæœ‰ACKæ ‡å¿—ä¸º 1æ—¶ç¡®è®¤åºå·å­—æ®µæ‰æœ‰æ•ˆã€‚å‘é€ACKæ— éœ€ä»»ä½•ä»£ä»·ï¼Œå› ä¸º 32 bitçš„ç¡®è®¤åºå·å­—æ®µå’ŒA C Kæ ‡å¿—ä¸€æ ·ï¼Œæ€»æ˜¯T C Pé¦–éƒ¨çš„ä¸€éƒ¨åˆ†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€æ—¦ä¸€ä¸ªè¿æ¥å»ºç«‹èµ·æ¥ï¼Œè¿™ä¸ªå­—æ®µæ€»æ˜¯è¢«è®¾ç½®ï¼Œ ACKæ ‡å¿—ä¹Ÿæ€»æ˜¯è¢«è®¾ç½®ä¸º1ã€‚TCPä¸ºåº”ç”¨å±‚æä¾›å…¨åŒå·¥æœåŠ¡ã€‚è¿™æ„å‘³æ•°æ®èƒ½åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šç‹¬ç«‹åœ°è¿›è¡Œä¼ è¾“ã€‚å› æ­¤ï¼Œè¿æ¥çš„æ¯ä¸€ç«¯å¿…é¡»ä¿æŒæ¯ä¸ªæ–¹å‘ä¸Šçš„ä¼ è¾“æ•°æ®åºå·ã€‚ é¦–éƒ½é•¿åº¦ï¼š é¦–éƒ¨é•¿åº¦ç»™å‡ºé¦–éƒ¨ä¸­ 32 bitå­—çš„æ•°ç›®ã€‚éœ€è¦è¿™ä¸ªå€¼æ˜¯å› ä¸ºä»»é€‰å­—æ®µçš„é•¿åº¦æ˜¯å¯å˜çš„ã€‚è¿™ä¸ªå­—æ®µå 4 bitï¼Œå› æ­¤T C Pæœ€å¤šæœ‰6 0å­—èŠ‚çš„é¦–éƒ¨ã€‚ç„¶è€Œï¼Œæ²¡æœ‰ä»»é€‰å­—æ®µï¼Œæ­£å¸¸çš„é•¿åº¦æ˜¯ 2 0å­—èŠ‚ã€‚ æ ‡å¿—å­—æ®µï¼šåœ¨T C Pé¦–éƒ¨ä¸­æœ‰ 6ä¸ªæ ‡å¿—æ¯”ç‰¹ã€‚å®ƒä»¬ä¸­çš„å¤šä¸ªå¯åŒæ—¶è¢«è®¾ç½®ä¸º1. URGç´§æ€¥æŒ‡é’ˆï¼ˆu rgent pointerï¼‰æœ‰æ•ˆ ACKç¡®è®¤åºå·æœ‰æ•ˆã€‚ PSHæ¥æ”¶æ–¹åº”è¯¥å°½å¿«å°†è¿™ä¸ªæŠ¥æ–‡æ®µäº¤ç»™åº”ç”¨å±‚ã€‚ RSTé‡å»ºè¿æ¥ã€‚ SYNåŒæ­¥åºå·ç”¨æ¥å‘èµ·ä¸€ä¸ªè¿æ¥ã€‚è¿™ä¸ªæ ‡å¿—å’Œä¸‹ä¸€ä¸ªæ ‡å¿—å°†åœ¨ç¬¬ 1 8ç« ä»‹ç»ã€‚ FINå‘ç«¯å®Œæˆå‘é€ä»»åŠ¡ã€‚ çª—å£å¤§å°ï¼š T C Pçš„æµé‡æ§åˆ¶ç”±è¿æ¥çš„æ¯ä¸€ç«¯é€šè¿‡å£°æ˜çš„çª—å£å¤§å°æ¥æä¾›ã€‚çª—å£å¤§å°ä¸ºå­—èŠ‚æ•°ï¼Œèµ·å§‹äºç¡®è®¤åºå·å­—æ®µæŒ‡æ˜çš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯æ¥æ”¶ç«¯æœŸæœ›æ¥æ”¶çš„å­—èŠ‚ã€‚çª—å£å¤§å°æ˜¯ä¸€ä¸ª 16 bitå­—æ®µï¼Œå› è€Œçª—å£å¤§å°æœ€å¤§ä¸º 65535å­—èŠ‚ã€‚ æ£€éªŒå’Œï¼š æ£€éªŒå’Œè¦†ç›–äº†æ•´ä¸ªçš„ T C PæŠ¥æ–‡æ®µï¼šT C Pé¦–éƒ¨å’ŒT C Pæ•°æ®ã€‚è¿™æ˜¯ä¸€ä¸ªå¼ºåˆ¶æ€§çš„å­—æ®µï¼Œä¸€å®šæ˜¯ç”±å‘ç«¯è®¡ç®—å’Œå­˜å‚¨ï¼Œå¹¶ç”±æ”¶ç«¯è¿›è¡ŒéªŒè¯ã€‚ ç´§æ€¥æŒ‡é’ˆï¼š åªæœ‰å½“URGæ ‡å¿—ç½®1æ—¶ç´§æ€¥æŒ‡é’ˆæ‰æœ‰æ•ˆã€‚ç´§æ€¥æŒ‡é’ˆæ˜¯ä¸€ä¸ªæ­£çš„åç§»é‡ï¼Œå’Œåºå·å­—æ®µä¸­çš„å€¼ç›¸åŠ è¡¨ç¤ºç´§æ€¥æ•°æ®æœ€åä¸€ä¸ªå­—èŠ‚çš„åºå·ã€‚ T C Pçš„ç´§æ€¥æ–¹å¼æ˜¯å‘é€ç«¯å‘å¦ä¸€ç«¯å‘é€ç´§æ€¥æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚ é€‰é¡¹ï¼š æœ€å¸¸è§çš„å¯é€‰å­—æ®µæ˜¯æœ€é•¿æŠ¥æ–‡å¤§å°ï¼Œåˆç§°ä¸º MSS (Maximum Segment Size)ã€‚æ¯ä¸ªè¿æ¥æ–¹é€šå¸¸éƒ½åœ¨é€šä¿¡çš„ç¬¬ä¸€ä¸ªæŠ¥æ–‡æ®µï¼ˆä¸ºå»ºç«‹è¿æ¥è€Œè®¾ç½® S Y Næ ‡å¿—çš„é‚£ä¸ªæ®µï¼‰ä¸­æŒ‡æ˜è¿™ä¸ªé€‰é¡¹ã€‚å®ƒæŒ‡æ˜æœ¬ç«¯æ‰€èƒ½æ¥æ”¶çš„æœ€å¤§é•¿åº¦çš„æŠ¥æ–‡æ®µã€‚ UDPæŠ¥æ–‡æ ¼å¼ï¼š ç«¯å£å·ï¼š ç”¨æ¥è¡¨ç¤ºå‘é€å’Œæ¥å—è¿›ç¨‹ã€‚ç”±äº I På±‚å·²ç»æŠŠI Pæ•°æ®æŠ¥åˆ†é…ç»™T C Pæˆ–U D Pï¼ˆæ ¹æ®I Pé¦–éƒ¨ä¸­åè®®å­—æ®µå€¼ï¼‰ï¼Œå› æ­¤T C Pç«¯å£å·ç”±T C Pæ¥æŸ¥çœ‹ï¼Œè€Œ U D Pç«¯å£å·ç”±UDPæ¥æŸ¥çœ‹ã€‚T C Pç«¯å£å·ä¸UDPç«¯å£å·æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚ é•¿åº¦ï¼š UDPé•¿åº¦å­—æ®µæŒ‡çš„æ˜¯UDPé¦–éƒ¨å’ŒUDPæ•°æ®çš„å­—èŠ‚é•¿åº¦ã€‚è¯¥å­—æ®µçš„æœ€å°å€¼ä¸º 8å­—èŠ‚ï¼ˆå‘é€ä¸€ä»½0å­—èŠ‚çš„UDPæ•°æ®æŠ¥æ˜¯ O Kï¼‰ã€‚ æ£€éªŒå’Œï¼š UDPæ£€éªŒå’Œæ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ£€éªŒå’Œã€‚å®ƒç”±å‘é€ç«¯è®¡ç®—ï¼Œç„¶åç”±æ¥æ”¶ç«¯éªŒè¯ã€‚å…¶ç›®çš„æ˜¯ä¸ºäº†å‘ç°UDPé¦–éƒ¨å’Œæ•°æ®åœ¨å‘é€ç«¯åˆ°æ¥æ”¶ç«¯ä¹‹é—´å‘ç”Ÿçš„ä»»ä½•æ”¹åŠ¨ã€‚ IPæŠ¥æ–‡æ ¼å¼ï¼šæ™®é€šçš„IPé¦–éƒ¨é•¿ä¸º20ä¸ªå­—èŠ‚ï¼Œé™¤éå«æœ‰å¯é€‰é¡¹å­—æ®µã€‚ 4ä½ç‰ˆæœ¬ï¼š ç›®å‰åè®®ç‰ˆæœ¬å·æ˜¯4ï¼Œå› æ­¤IPæœ‰æ—¶ä¹Ÿç§°ä½œIPV4. 4ä½é¦–éƒ¨é•¿åº¦ï¼š é¦–éƒ¨é•¿åº¦æŒ‡çš„æ˜¯é¦–éƒ¨å 32bitå­—çš„æ•°ç›®ï¼ŒåŒ…æ‹¬ä»»ä½•é€‰é¡¹ã€‚ç”±äºå®ƒæ˜¯ä¸€ä¸ª4æ¯”ç‰¹å­—æ®µï¼Œå› æ­¤é¦–éƒ¨é•¿åº¦æœ€é•¿ä¸º60ä¸ªå­—èŠ‚ã€‚ æœåŠ¡ç±»å‹ï¼ˆTOSï¼‰ï¼š æœåŠ¡ç±»å‹å­—æ®µåŒ…æ‹¬ä¸€ä¸ª3bitçš„ä¼˜å…ˆæƒå­—æ®µï¼ˆç°åœ¨å·²ç»è¢«å¿½ç•¥ï¼‰ï¼Œ4bitçš„TOSå­å­—æ®µå’Œ1bitæœªç”¨ä½å¿…é¡»ç½®0ã€‚4bitçš„TOSåˆ†åˆ«ä»£è¡¨ï¼šæœ€å°æ—¶å»¶ï¼Œæœ€å¤§ååé‡ï¼Œæœ€é«˜å¯é æ€§å’Œæœ€å°è´¹ç”¨ã€‚4bitä¸­åªèƒ½ç½®å…¶ä¸­1æ¯”ç‰¹ã€‚å¦‚æœæ‰€æœ‰4bitå‡ä¸º0ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€æ˜¯ä¸€èˆ¬æœåŠ¡ã€‚ æ€»é•¿åº¦ï¼š æ€»é•¿åº¦å­—æ®µæ˜¯æŒ‡æ•´ä¸ªIPæ•°æ®æŠ¥çš„é•¿åº¦ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚åˆ©ç”¨é¦–éƒ¨é•¿åº¦å’Œæ€»é•¿åº¦å­—æ®µï¼Œå°±å¯ä»¥çŸ¥é“IPæ•°æ®æŠ¥ä¸­æ•°æ®å†…å®¹çš„èµ·å§‹ä½ç½®å’Œé•¿åº¦ã€‚ç”±äºè¯¥å­—æ®µé•¿16bitï¼Œæ‰€ä»¥IPæ•°æ®æŠ¥æœ€é•¿å¯è¾¾65535å­—èŠ‚ã€‚å½“æ•°æ®æŠ¥è¢«åˆ†ç‰‡æ—¶ï¼Œè¯¥å­—æ®µçš„å€¼ä¹Ÿéšç€å˜åŒ–ã€‚ æ ‡è¯†å­—æ®µï¼š æ ‡è¯†å­—æ®µå”¯ä¸€åœ°æ ‡è¯†ä¸»æœºå‘é€çš„æ¯ä¸€ä»½æ•°æ®æŠ¥ã€‚é€šå¸¸æ¯å‘é€ä¸€ä»½æŠ¥æ–‡å®ƒçš„å€¼å°±ä¼šåŠ 1ã€‚ ç”Ÿå­˜æ—¶é—´ï¼š TTLï¼ˆtime-to-liveï¼‰ç”Ÿå­˜æ—¶é—´å­—æ®µè®¾ç½®äº†æ•°æ®æŠ¥å¯ä»¥ç»è¿‡çš„æœ€å¤šè·¯ç”±å™¨æ•°ã€‚å®ƒæŒ‡å®šäº†æ•°æ®æŠ¥çš„ç”Ÿå­˜æ—¶é—´ã€‚TTLçš„åˆå§‹å€¼ç”±æºä¸»æœºè®¾ç½®ï¼ˆé€šå¸¸ä¸º 3 2æˆ–6 4ï¼‰ï¼Œä¸€æ—¦ç»è¿‡ä¸€ä¸ªå¤„ç†å®ƒçš„è·¯ç”±å™¨ï¼Œå®ƒçš„å€¼å°±å‡å» 1ã€‚å½“è¯¥å­—æ®µçš„å€¼ä¸º 0æ—¶ï¼Œæ•°æ®æŠ¥å°±è¢«ä¸¢å¼ƒï¼Œå¹¶å‘é€ ICMP æŠ¥æ–‡é€šçŸ¥æºä¸»æœºã€‚ é¦–éƒ¨æ£€éªŒå’Œï¼š é¦–éƒ¨æ£€éªŒå’Œå­—æ®µæ˜¯æ ¹æ® I Pé¦–éƒ¨è®¡ç®—çš„æ£€éªŒå’Œç ã€‚å®ƒä¸å¯¹é¦–éƒ¨åé¢çš„æ•°æ®è¿›è¡Œè®¡ç®—ã€‚ ICMPã€IGMPã€UDPå’ŒTCPåœ¨å®ƒä»¬å„è‡ªçš„é¦–éƒ¨ä¸­å‡å«æœ‰åŒæ—¶è¦†ç›–é¦–éƒ¨å’Œæ•°æ®æ£€éªŒå’Œç ã€‚ ä»¥å¤ªç½‘æŠ¥æ–‡æ ¼å¼ï¼š ç›®çš„åœ°å€å’Œæºåœ°å€ï¼š æ˜¯æŒ‡ç½‘å¡çš„ç¡¬ä»¶åœ°å€ï¼ˆä¹Ÿå«MAC åœ°å€ï¼‰ï¼Œé•¿åº¦æ˜¯48 ä½ï¼Œæ˜¯åœ¨ç½‘å¡å‡ºå‚æ—¶å›ºåŒ–çš„ã€‚ æ•°æ®ï¼š ä»¥å¤ªç½‘å¸§ä¸­çš„æ•°æ®é•¿åº¦è§„å®šæœ€å°46 å­—èŠ‚ï¼Œæœ€å¤§1500 å­—èŠ‚ï¼ŒARP å’ŒRARP æ•°æ®åŒ…çš„é•¿åº¦ä¸å¤Ÿ46 å­—èŠ‚ï¼Œè¦åœ¨åé¢è¡¥å¡«å……ä½ã€‚æœ€å¤§å€¼1500 ç§°ä¸ºä»¥å¤ªç½‘çš„æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆMTUï¼‰ï¼Œä¸åŒçš„ç½‘ç»œç±»å‹æœ‰ä¸åŒçš„MTUï¼Œå¦‚æœä¸€ä¸ªæ•°æ®åŒ…ä»ä»¥å¤ªç½‘è·¯ç”±åˆ°æ‹¨å·é“¾è·¯ä¸Šï¼Œæ•°æ®åŒ…åº¦å¤§äºæ‹¨å·é“¾è·¯çš„MTUäº†ï¼Œåˆ™éœ€è¦å¯¹æ•°æ®åŒ…è¿›è¡Œåˆ†ç‰‡fragmentationï¼‰ã€‚ifconfig å‘½ä»¤çš„è¾“å‡ºä¸­ä¹Ÿæœ‰â€œMTU:1500â€ã€‚æ³¨æ„ï¼ŒMTU ä¸ªæ¦‚å¿µæŒ‡æ•°æ®å¸§ä¸­æœ‰æ•ˆè½½è·çš„æœ€å¤§é•¿åº¦ï¼Œä¸åŒ…æ‹¬å¸§é¦–éƒ¨çš„é•¿åº¦ã€‚ HTTPåè®®1ã€HTTPåè®®1.0_1.1_2.0 HTTP1.0ï¼šæœåŠ¡å™¨å¤„ç†å®Œæˆåç«‹å³æ–­å¼€TCPè¿æ¥ï¼ˆæ— è¿æ¥ï¼‰ï¼ŒæœåŠ¡å™¨ä¸è·Ÿè¸ªæ¯ä¸ªå®¢æˆ·ç«¯ä¹Ÿä¸è®°å½•è¿‡å»çš„è¯·æ±‚ï¼ˆæ— çŠ¶æ€ï¼‰ HTTP1.1ï¼šKeepAlivedé•¿è¿æ¥é¿å…äº†è¿æ¥å»ºç«‹å’Œé‡Šæ”¾çš„å¼€é”€ï¼›é€šè¿‡Content-Lengthæ¥åˆ¤æ–­å½“å‰è¯·æ±‚æ•°æ®æ˜¯å¦å·²ç»å…¨éƒ¨æ¥å—ï¼ˆæœ‰çŠ¶æ€ï¼‰ HTTP2.0ï¼šå¼•å…¥äºŒè¿›åˆ¶æ•°æ®å¸§å’Œæµçš„æ¦‚å¿µï¼Œå…¶ä¸­å¸§å¯¹æ•°æ®è¿›è¡Œé¡ºåºæ ‡è¯†ï¼›å› ä¸ºæœ‰äº†åºåˆ—ï¼ŒæœåŠ¡å™¨å¯ä»¥å¹¶è¡Œçš„ä¼ è¾“æ•°æ®ã€‚ http1.0å’Œhttp1.1çš„ä¸»è¦åŒºåˆ«å¦‚ä¸‹ï¼šâ€‹ 1ã€ç¼“å­˜å¤„ç†ï¼š1.1æ·»åŠ æ›´å¤šçš„ç¼“å­˜æ§åˆ¶ç­–ç•¥ï¼ˆå¦‚ï¼šEntity tagï¼ŒIf-Matchï¼‰â€‹ 2ã€ç½‘ç»œè¿æ¥çš„ä¼˜åŒ–ï¼š1.1æ”¯æŒæ–­ç‚¹ç»­ä¼ â€‹ 3ã€é”™è¯¯çŠ¶æ€ç çš„å¢å¤šï¼š1.1æ–°å¢äº†24ä¸ªé”™è¯¯çŠ¶æ€å“åº”ç ï¼Œä¸°å¯Œçš„é”™è¯¯ç æ›´åŠ æ˜ç¡®å„ä¸ªçŠ¶æ€â€‹ 4ã€Hostå¤´å¤„ç†ï¼šæ”¯æŒHostå¤´åŸŸï¼Œä¸åœ¨ä»¥IPä¸ºè¯·æ±‚æ–¹æ ‡å¿—â€‹ 5ã€é•¿è¿æ¥ï¼šå‡å°‘äº†å»ºç«‹å’Œå…³é—­è¿æ¥çš„æ¶ˆè€—å’Œå»¶è¿Ÿã€‚ http1.1å’Œhttp2.0çš„ä¸»è¦åŒºåˆ«ï¼šâ€‹ 1ã€æ–°çš„ä¼ è¾“æ ¼å¼ï¼š2.0ä½¿ç”¨äºŒè¿›åˆ¶æ ¼å¼ï¼Œ1.0ä¾ç„¶ä½¿ç”¨åŸºäºæ–‡æœ¬æ ¼å¼â€‹ 2ã€å¤šè·¯å¤ç”¨ï¼šè¿æ¥å…±äº«ï¼Œä¸åŒçš„requestå¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ä¼ è¾“ï¼ˆæœ€åæ ¹æ®æ¯ä¸ªrequestä¸Šçš„idå·ç»„åˆæˆæ­£å¸¸çš„è¯·æ±‚ï¼‰â€‹ 3ã€headerå‹ç¼©ï¼šç”±äº1.Xä¸­headerå¸¦æœ‰å¤§é‡çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å¾—é‡å¤ä¼ è¾“ï¼Œ2.0ä½¿ç”¨encoderæ¥å‡å°‘éœ€è¦ä¼ è¾“çš„hearderå¤§å°â€‹ 4ã€æœåŠ¡ç«¯æ¨é€ï¼šåŒgoogleçš„SPDUYï¼ˆ1.0çš„ä¸€ç§å‡çº§ï¼‰ä¸€æ · 2ã€HTTPä¸HTTPSä¹‹é—´çš„åŒºåˆ« HTTPä¸HTTPSä¹‹é—´çš„åŒºåˆ«ï¼š HTTP HTTPS é»˜è®¤ç«¯å£80 HTTPSé»˜è®¤ä½¿ç”¨ç«¯å£443 æ˜æ–‡ä¼ è¾“ã€æ•°æ®æœªåŠ å¯†ã€å®‰å…¨æ€§å·® ä¼ è¾“è¿‡ç¨‹sslåŠ å¯†ã€å®‰å…¨æ€§è¾ƒå¥½ å“åº”é€Ÿåº¦å¿«ã€æ¶ˆè€—èµ„æºå°‘ å“åº”é€Ÿåº¦è¾ƒæ…¢ã€æ¶ˆè€—èµ„æºå¤šã€éœ€è¦ç”¨åˆ°CAè¯ä¹¦ HTTPSé“¾æ¥å»ºç«‹çš„è¿‡ç¨‹ï¼š 1.é¦–å…ˆå®¢æˆ·ç«¯å…ˆç»™æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ 2.æœåŠ¡å™¨å‘é€ä¸€ä¸ªSSLè¯ä¹¦ç»™å®¢æˆ·ç«¯ï¼Œå†…å®¹åŒ…æ‹¬ï¼šè¯ä¹¦çš„å‘å¸ƒæœºæ„ã€æœ‰æ•ˆæœŸã€æ‰€æœ‰è€…ã€ç­¾åä»¥åŠå…¬é’¥ 3.å®¢æˆ·ç«¯å¯¹å‘æ¥çš„å…¬é’¥è¿›è¡ŒçœŸä¼ªæ ¡éªŒï¼Œæ ¡éªŒä¸ºçœŸåˆ™ä½¿ç”¨å…¬é’¥å¯¹å¯¹ç§°åŠ å¯†ç®—æ³•ä»¥åŠå¯¹ç§°å¯†é’¥è¿›è¡ŒåŠ å¯† 4.æœåŠ¡å™¨ç«¯ä½¿ç”¨ç§é’¥è¿›è¡Œè§£å¯†å¹¶ä½¿ç”¨å¯¹ç§°å¯†é’¥åŠ å¯†ç¡®è®¤ä¿¡æ¯å‘é€ç»™å®¢æˆ·ç«¯ 5.éšåå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å°±ä½¿ç”¨å¯¹ç§°å¯†é’¥è¿›è¡Œä¿¡æ¯ä¼ è¾“ å¯¹ç§°åŠ å¯†ç®—æ³•ï¼š åŒæ–¹æŒæœ‰ç›¸åŒçš„å¯†é’¥ï¼Œä¸”åŠ å¯†é€Ÿåº¦å¿«ï¼Œå…¸å‹å¯¹ç§°åŠ å¯†ç®—æ³•ï¼šDESã€AES éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼š å¯†é’¥æˆå¯¹å‡ºç°ï¼ˆç§é’¥ã€å…¬é’¥ï¼‰ï¼Œç§é’¥åªæœ‰è‡ªå·±çŸ¥é“ï¼Œä¸åœ¨ç½‘ç»œä¸­ä¼ è¾“ï¼›è€Œå…¬é’¥å¯ä»¥å…¬å¼€ã€‚ç›¸æ¯”å¯¹ç§°åŠ å¯†é€Ÿåº¦è¾ƒæ…¢ï¼Œå…¸å‹çš„éå¯¹ç§°åŠ å¯†ç®—æ³•æœ‰ï¼šRSAã€DSA 3ã€Getå’ŒPostè¯·æ±‚åŒºåˆ«HTTPè¯·æ±‚ï¼š æ–¹æ³• æè¿° GET å‘ç‰¹å®šèµ„æºå‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢æ•°æ®ï¼Œå¹¶è¿”å›å®ä½“ POST å‘æŒ‡å®šèµ„æºæäº¤æ•°æ®è¿›è¡Œå¤„ç†è¯·æ±‚ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ–°çš„èµ„æºå»ºç«‹ã€å·²æœ‰èµ„æºä¿®æ”¹ PUT å‘æœåŠ¡å™¨ä¸Šä¼ æ–°çš„å†…å®¹ HEAD ç±»ä¼¼GETè¯·æ±‚ï¼Œè¿”å›çš„å“åº”ä¸­æ²¡æœ‰å…·ä½“çš„å†…å®¹ï¼Œç”¨äºè·å–æŠ¥å¤´ DELETE è¯·æ±‚æœåŠ¡å™¨åˆ é™¤æŒ‡å®šæ ‡è¯†çš„èµ„æº OPTIONS å¯ä»¥ç”¨æ¥å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ¥æµ‹è¯•æœåŠ¡å™¨çš„åŠŸèƒ½æ€§ TRACE å›æ˜¾æœåŠ¡å™¨æ”¶åˆ°çš„è¯·æ±‚ï¼Œç”¨äºæµ‹è¯•æˆ–è¯Šæ–­ CONNECT HTTP/1.1åè®®ä¸­é¢„ç•™ç»™èƒ½å¤Ÿå°†è¿æ¥æ”¹ä¸ºç®¡é“æ–¹å¼çš„ä»£ç†æœåŠ¡å™¨ getå’ŒPoståŒºåˆ«ï¼š GET POST å¯è§æ€§ æ•°æ®åœ¨URLä¸­å¯¹æ‰€æœ‰äººå¯è§ æ•°æ®ä¸ä¼šæ˜¾ç¤ºåœ¨URLä¸­ å®‰å…¨æ€§ ä¸postç›¸æ¯”ï¼Œgetçš„å®‰å…¨æ€§è¾ƒå·®ï¼Œå› ä¸ºæ‰€ å‘é€çš„æ•°æ®æ˜¯URLçš„ä¸€éƒ¨åˆ† å®‰å…¨ï¼Œå› ä¸ºå‚æ•°ä¸ä¼šè¢«ä¿å­˜åœ¨æµè§ˆå™¨ å†å²æˆ–webæœåŠ¡å™¨æ—¥å¿—ä¸­ æ•°æ®é•¿åº¦ å—é™åˆ¶ï¼Œæœ€é•¿2kb æ— é™åˆ¶ ç¼–ç ç±»å‹ application/x-www-form-urlencoded multipart/form-data ç¼“å­˜ èƒ½è¢«ç¼“å­˜ ä¸èƒ½è¢«ç¼“å­˜ 4ã€HTTPå¸¸è§å“åº”çŠ¶æ€ç  100ï¼šContinue â€” ç»§ç»­ã€‚å®¢æˆ·ç«¯åº”ç»§ç»­å…¶è¯·æ±‚ã€‚ 200ï¼šOK â€” è¯·æ±‚æˆåŠŸã€‚ä¸€èˆ¬ç”¨äºGETä¸POSTè¯·æ±‚ã€‚ 301ï¼šMoved Permanently â€” æ°¸ä¹…é‡å®šå‘ã€‚ 302ï¼šFound â€” æš‚æ—¶é‡å®šå‘ã€‚ 400ï¼šBad Request â€” å®¢æˆ·ç«¯è¯·æ±‚çš„è¯­æ³•é”™è¯¯ï¼ŒæœåŠ¡å™¨æ— æ³•ç†è§£ã€‚ 403ï¼šForbideen â€” æœåŠ¡å™¨ç†è§£è¯·æ±‚å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä½†æ˜¯æ‹’ç»æ‰§è¡Œæ­¤è¯·æ±‚ã€‚ 404ï¼šNot Found â€” æœåŠ¡å™¨æ— æ³•æ ¹æ®å®¢æˆ·ç«¯çš„è¯·æ±‚æ‰¾åˆ°èµ„æºï¼ˆç½‘é¡µï¼‰ã€‚ 500ï¼šInternal Server Error â€” æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œæ— æ³•å®Œæˆè¯·æ±‚ã€‚ 502ï¼šBad Gateway â€” ä½œä¸ºç½‘å…³æˆ–è€…ä»£ç†æœåŠ¡å™¨å°è¯•æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œä»è¿œç¨‹æœåŠ¡å™¨æ¥æ”¶åˆ°äº†æ— æ•ˆçš„å“åº”ã€‚ 5ã€é‡å®šå‘å’Œè½¬å‘åŒºåˆ« é‡å®šå‘ï¼šredirectï¼š åœ°å€æ å‘ç”Ÿå˜åŒ– é‡å®šå‘å¯ä»¥è®¿é—®å…¶ä»–ç«™ç‚¹ï¼ˆæœåŠ¡å™¨ï¼‰çš„èµ„æº é‡å®šå‘æ˜¯ä¸¤æ¬¡è¯·æ±‚ã€‚ä¸èƒ½ä½¿ç”¨requestå¯¹è±¡æ¥å…±äº«æ•°æ® è½¬å‘ï¼šforwardï¼š è½¬å‘åœ°å€æ è·¯å¾„ä¸å˜ è½¬å‘åªèƒ½è®¿é—®å½“å‰æœåŠ¡å™¨ä¸‹çš„èµ„æº è½¬å‘æ˜¯ä¸€æ¬¡è¯·æ±‚ï¼Œå¯ä»¥ä½¿ç”¨requestå¯¹è±¡å…±äº«æ•°æ® 6ã€Cookieå’ŒSessionåŒºåˆ«ã€‚ Cookie å’Œ Sessionéƒ½æ˜¯ç”¨æ¥è·Ÿè¸ªæµè§ˆå™¨ç”¨æˆ·èº«ä»½çš„ä¼šè¯æ–¹å¼ï¼Œä½†ä¸¤è€…æœ‰æ‰€åŒºåˆ«ï¼š Cookie æ•°æ®ä¿å­˜åœ¨å®¢æˆ·ç«¯(æµè§ˆå™¨ç«¯)ï¼ŒSession æ•°æ®ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ã€‚ cookieä¸æ˜¯å¾ˆå®‰å…¨ï¼Œåˆ«äººå¯ä»¥åˆ†æå­˜æ”¾åœ¨æœ¬åœ°çš„COOKIEå¹¶è¿›è¡Œæ¬ºéª—,è€ƒè™‘åˆ°å®‰å…¨åº”å½“ä½¿ç”¨sessionã€‚ Cookie â¼€èˆ¬â½¤æ¥ä¿å­˜â½¤æˆ·ä¿¡æ¯ï¼ŒSession çš„ä¸»è¦ä½œâ½¤å°±æ˜¯é€šè¿‡æœåŠ¡ç«¯è®°å½•â½¤æˆ·çš„çŠ¶æ€ æµè§ˆå™¨è¾“å…¥URLè¿‡ç¨‹ è¿‡ç¨‹ï¼šDNSè§£æã€TCPè¿æ¥ã€å‘é€HTTPè¯·æ±‚ã€æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶è¿”å›HTTPæŠ¥æ–‡ã€æµè§ˆå™¨æ¸²æŸ“ã€ç»“æŸ è¿‡ç¨‹ ä½¿ç”¨çš„åè®® 1ã€æµè§ˆå™¨æŸ¥æ‰¾åŸŸåDNSçš„IPåœ°å€ DNSæŸ¥æ‰¾è¿‡ç¨‹ï¼ˆæµè§ˆå™¨ç¼“å­˜ã€è·¯ç”±å™¨ç¼“å­˜ã€DNSç¼“å­˜ï¼‰ DNSï¼šè·å–åŸŸåå¯¹åº”çš„ip 2ã€æ ¹æ®ipå»ºç«‹TCPè¿æ¥ TCPï¼šä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ 3ã€æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€HTTPè¯·æ±‚ HTTPï¼šå‘é€è¯·æ±‚ 4ã€æœåŠ¡å™¨å“åº”HTTPå“åº” HTTP 5ã€æµè§ˆå™¨è¿›è¡Œæ¸²æŸ“ æ“ä½œç³»ç»ŸåŸºç¡€è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ« è¿›ç¨‹ï¼šæ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„å †å’Œæ–¹æ³•åŒºèµ„æºï¼Œä¸å…±äº«æ ˆã€ç¨‹åºè®¡æ•°å™¨ çº¿ç¨‹ï¼šæ˜¯ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œçš„æœ€å°å•ä½ï¼Œçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œå­˜åœ¨èµ„æºç«äº‰å’Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„é—®é¢˜ åç¨‹ï¼šæ˜¯ä¸€ç§æ¯”çº¿ç¨‹æ›´åŠ è½»é‡çº§çš„å­˜åœ¨ï¼Œæ­£å¦‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‹¥æœ‰å¤šä¸ªçº¿ç¨‹ä¸€æ ·ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‹¥æœ‰å¤šä¸ªåç¨‹ã€‚ 1ã€è¿›ç¨‹é—´é€šä¿¡æ–¹å¼IPCç®¡é“pipeï¼š äº²ç¼˜å…³ç³»ä½¿ç”¨åŒ¿åç®¡é“ï¼Œéäº²ç¼˜å…³ç³»ä½¿ç”¨å‘½åç®¡é“ï¼Œç®¡é“éµå¾ªFIFOï¼ŒåŠåŒå·¥ï¼Œæ•°æ®åªèƒ½å•å‘é€šä¿¡ï¼› ä¿¡å·ï¼š ä¿¡å·æ˜¯ä¸€ç§æ¯”è¾ƒå¤æ‚çš„é€šä¿¡æ–¹å¼ï¼Œç”¨æˆ·è°ƒç”¨killå‘½ä»¤å°†ä¿¡å·å‘é€ç»™å…¶ä»–è¿›ç¨‹ã€‚ æ¶ˆæ¯é˜Ÿåˆ—ï¼š æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº†ä¿¡å·ä¼ é€’ä¿¡æ¯å°‘ï¼Œç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ç­‰ç‰¹ç‚¹ã€‚ å…±äº«å†…å­˜(share memory)ï¼š ä½¿å¾—å¤šä¸ªè¿›ç¨‹å¯ä»¥å¯ä»¥ç›´æ¥è¯»å†™åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œæ˜¯æœ€å¿«çš„å¯ç”¨IPCå½¢å¼ã€‚æ˜¯é’ˆå¯¹å…¶ä»–é€šä¿¡æœºåˆ¶è¿è¡Œæ•ˆç‡è¾ƒä½è€Œè®¾è®¡çš„ã€‚ ç”±äºå¤šä¸ªè¿›ç¨‹å…±äº«ä¸€æ®µå†…å­˜ï¼Œå› æ­¤éœ€è¦ä¾é æŸç§åŒæ­¥æœºåˆ¶ï¼ˆå¦‚ä¿¡å·é‡ï¼‰æ¥è¾¾åˆ°è¿›ç¨‹é—´çš„åŒæ­¥åŠäº’æ–¥ã€‚ ä¿¡å·é‡(Semaphores) ï¼š ä¿¡å·é‡æ˜¯â¼€ä¸ªè®¡æ•°å™¨ï¼Œâ½¤äºå¤šè¿›ç¨‹å¯¹å…±äº«æ•°æ®çš„è®¿é—®ï¼Œè¿™ç§é€šä¿¡â½…å¼ä¸»è¦â½¤äºè§£å†³ä¸åŒæ­¥ç›¸å…³çš„é—®é¢˜å¹¶é¿å…ç«äº‰æ¡ä»¶ã€‚ å¥—æ¥å­—(Sockets) : ç®€å•çš„è¯´å°±æ˜¯é€šä¿¡çš„ä¸¤â½…çš„â¼€ç§çº¦å®šï¼Œâ½¤å¥—æ¥å­—ä¸­çš„ç›¸å…³å‡½æ•°æ¥å®Œæˆé€šä¿¡è¿‡ç¨‹ã€‚ 2ã€ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ç”¨æˆ·æ€ï¼šåªèƒ½å—é™çš„è®¿é—®å†…å­˜ï¼Œè¿è¡Œæ‰€æœ‰çš„åº”ç”¨ç¨‹åº æ ¸å¿ƒæ€ï¼šè¿è¡Œæ“ä½œç³»ç»Ÿç¨‹åºï¼Œcpuå¯ä»¥è®¿é—®å†…å­˜çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬å¤–å›´è®¾å¤‡ ä¸ºä»€ä¹ˆè¦æœ‰ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼š ç”±äºéœ€è¦é™åˆ¶ä¸åŒçš„ç¨‹åºä¹‹é—´çš„è®¿é—®èƒ½åŠ›, é˜²æ­¢ä»–ä»¬è·å–åˆ«çš„ç¨‹åºçš„å†…å­˜æ•°æ®, æˆ–è€…è·å–å¤–å›´è®¾å¤‡çš„æ•°æ®, å¹¶å‘é€åˆ°ç½‘ç»œ ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€çš„3ç§æ–¹å¼ï¼š a. ç³»ç»Ÿè°ƒç”¨ ä¸»åŠ¨è°ƒç”¨ï¼Œç³»ç»Ÿè°ƒç”¨çš„æœºåˆ¶å…¶æ ¸å¿ƒè¿˜æ˜¯ä½¿ç”¨äº†æ“ä½œç³»ç»Ÿä¸ºç”¨æˆ·ç‰¹åˆ«å¼€æ”¾çš„ä¸€ä¸ªä¸­æ–­æ¥å®ç°ï¼Œä¾‹å¦‚Linuxçš„int 80hä¸­æ–­ã€‚ b. å¼‚å¸¸ å½“CPUåœ¨æ‰§è¡Œè¿è¡Œåœ¨ç”¨æˆ·æ€ä¸‹çš„ç¨‹åºæ—¶ï¼Œå‘ç”Ÿäº†æŸäº›äº‹å…ˆä¸å¯çŸ¥çš„å¼‚å¸¸ï¼Œæ¯”å¦‚ç¼ºé¡µå¼‚å¸¸ï¼Œè¿™æ—¶ä¼šè§¦å‘åˆ‡æ¢å†…æ ¸æ€å¤„ç†å¼‚å¸¸ã€‚ c. å¤–å›´è®¾å¤‡çš„ä¸­æ–­ å½“å¤–å›´è®¾å¤‡å®Œæˆç”¨æˆ·è¯·æ±‚çš„æ“ä½œåï¼Œä¼šå‘CPUå‘å‡ºç›¸åº”çš„ä¸­æ–­ä¿¡å·ï¼Œè¿™æ—¶CPUä¼šç”±ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢ã€‚ 3ã€æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹ç©ºé—´ æ ˆåŒºï¼ˆstackï¼‰â€” ç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…é‡Šæ”¾ ï¼Œå­˜æ”¾å‡½æ•°çš„å‚æ•°å€¼ï¼Œå±€éƒ¨å˜é‡çš„å€¼ç­‰ã€‚ å †åŒºï¼ˆheapï¼‰â€” ä¸€èˆ¬ç”±ç¨‹åºå‘˜åˆ†é…é‡Šæ”¾ï¼Œ è‹¥ç¨‹åºå‘˜ä¸é‡Šæ”¾ï¼Œç¨‹åºç»“æŸæ—¶å¯èƒ½ç”±OSå›æ”¶ ã€‚ é™æ€åŒºï¼ˆstaticï¼‰â€”å­˜æ”¾å…¨å±€å˜é‡å’Œé™æ€å˜é‡çš„å­˜å‚¨ ä»£ç åŒº(text)â€”å­˜æ”¾å‡½æ•°ä½“çš„äºŒè¿›åˆ¶ä»£ç ã€‚ çº¿ç¨‹å…±äº«å †åŒºã€é™æ€åŒº æ“ä½œç³»ç»Ÿå†…å­˜ç®¡ç†å­˜ç®¡ç†æ–¹å¼ï¼šé¡µå¼ç®¡ç†ã€æ®µå¼ç®¡ç†ã€æ®µé¡µå¼ç®¡ç† åˆ†æ®µç®¡ç†ï¼š å°†ç¨‹åºçš„åœ°å€ç©ºé—´åˆ’åˆ†ä¸ºè‹¥å¹²æ®µï¼ˆsegmentï¼‰ï¼Œå¦‚ä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œå †æ ˆæ®µï¼›è¿™æ ·æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªäºŒç»´åœ°å€ç©ºé—´ï¼Œç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ã€‚æ®µå¼ç®¡ç†çš„ä¼˜ç‚¹æ˜¯ï¼šæ²¡æœ‰å†…ç¢ç‰‡ï¼ˆå› ä¸ºæ®µå¤§å°å¯å˜ï¼Œæ”¹å˜æ®µå¤§å°æ¥æ¶ˆé™¤å†…ç¢ç‰‡ï¼‰ã€‚ä½†æ®µæ¢å…¥æ¢å‡ºæ—¶ï¼Œä¼šäº§ç”Ÿå¤–ç¢ç‰‡ï¼ˆæ¯”å¦‚4kçš„æ®µæ¢5kçš„æ®µï¼Œä¼šäº§ç”Ÿ1kçš„å¤–ç¢ç‰‡ï¼‰ åˆ†é¡µç®¡ç†ï¼š åœ¨é¡µå¼å­˜å‚¨ç®¡ç†ä¸­ï¼Œå°†ç¨‹åºçš„é€»è¾‘åœ°å€åˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„é¡µï¼ˆpageï¼‰ï¼Œè€Œç‰©ç†å†…å­˜åˆ’åˆ†ä¸ºåŒæ ·å¤§å°çš„é¡µæ¡†ï¼Œç¨‹åºåŠ è½½æ—¶ï¼Œå¯ä»¥å°†ä»»æ„ä¸€é¡µæ”¾å…¥å†…å­˜ä¸­ä»»æ„ä¸€ä¸ªé¡µæ¡†ï¼Œè¿™äº›é¡µæ¡†ä¸å¿…è¿ç»­ï¼Œä»è€Œå®ç°äº†ç¦»æ•£åˆ†ç¦»ã€‚é¡µå¼å­˜å‚¨ç®¡ç†çš„ä¼˜ç‚¹æ˜¯ï¼šæ²¡æœ‰å¤–ç¢ç‰‡ï¼ˆå› ä¸ºé¡µçš„å¤§å°å›ºå®šï¼‰ï¼Œä½†ä¼šäº§ç”Ÿå†…ç¢ç‰‡ï¼ˆä¸€ä¸ªé¡µå¯èƒ½å¡«å……ä¸æ»¡ï¼‰ æ®µé¡µå¼ç®¡ç†ï¼š æ®µâ»šå¼ç®¡ç†æœºåˆ¶ç»“åˆäº†æ®µå¼ç®¡ç†å’Œâ»šå¼ç®¡ç†çš„ä¼˜ç‚¹ã€‚ç®€å•æ¥è¯´æ®µâ»šå¼ç®¡ç†æœºåˆ¶å°±æ˜¯æŠŠä¸»å­˜å…ˆåˆ†æˆè‹¥â¼²æ®µï¼Œæ¯ä¸ªæ®µâ¼œåˆ†æˆè‹¥â¼²â»šï¼Œä¹Ÿå°±æ˜¯è¯´ æ®µâ»šå¼ç®¡ç†æœºåˆ¶ ä¸­æ®µä¸æ®µä¹‹é—´ä»¥åŠæ®µçš„å†…éƒ¨çš„éƒ½æ˜¯ç¦»æ•£çš„ 1ã€é¡µé¢ç½®æ¢ç®—æ³•FIFOã€LRUç½®æ¢ç®—æ³•ï¼šå…ˆè¿›å…ˆå‡ºFIFOã€æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨LRUã€æœ€ä½³ç½®æ¢ç®—æ³•OPT å…ˆè¿›å…ˆå‡ºFIFO: ç¼ºç‚¹ï¼šæ²¡æœ‰è€ƒè™‘åˆ°å®é™…çš„é¡µé¢ä½¿ç”¨é¢‘ç‡ï¼Œæ€§èƒ½å·®ã€ä¸é€šå¸¸é¡µé¢ä½¿ç”¨çš„è§„åˆ™ä¸ç¬¦åˆï¼Œå®é™…åº”ç”¨è¾ƒå°‘ æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨LRU: åŸç†ï¼šé€‰æ‹©æœ€è¿‘ä¸”æœ€ä¹…æœªä½¿ç”¨çš„é¡µé¢è¿›è¡Œæ·˜æ±° ä¼˜ç‚¹ï¼šè€ƒè™‘åˆ°äº†ç¨‹åºè®¿é—®çš„æ—¶é—´å±€éƒ¨æ€§ï¼Œæœ‰è¾ƒå¥½çš„æ€§èƒ½ï¼Œå®é™…åº”ç”¨ä¹Ÿæ¯”è¾ƒå¤š ç¼ºç‚¹ï¼šæ²¡æœ‰åˆé€‚çš„ç®—æ³•ï¼Œåªæœ‰é€‚åˆçš„ç®—æ³•ï¼ŒlFUã€randoméƒ½å¯ä»¥ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576/** * @program: Java * @description: LRUæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ç½®æ¢ç®—æ³•ï¼Œé€šè¿‡LinkedHashMapå®ç° * @author: Mr.Li * @create: 2020-07-17 10:29 **/public class LRUCache { private LinkedHashMap&lt;Integer,Integer&gt; cache; private int capacity; //å®¹é‡å¤§å° /** *åˆå§‹åŒ–æ„é€ å‡½æ•° * @param capacity */ public LRUCache(int capacity) { cache = new LinkedHashMap&lt;&gt;(capacity); this.capacity = capacity; } public int get(int key) { //ç¼“å­˜ä¸­ä¸å­˜åœ¨æ­¤keyï¼Œç›´æ¥è¿”å› if(!cache.containsKey(key)) { return -1; } int res = cache.get(key); cache.remove(key); //å…ˆä»é“¾è¡¨ä¸­åˆ é™¤ cache.put(key,res); //å†æŠŠè¯¥èŠ‚ç‚¹æ”¾åˆ°é“¾è¡¨æœ«å°¾å¤„ return res; } public void put(int key,int value) { if(cache.containsKey(key)) { cache.remove(key); //å·²ç»å­˜åœ¨ï¼Œåœ¨å½“å‰é“¾è¡¨ç§»é™¤ } if(capacity == cache.size()) { //cacheå·²æ»¡ï¼Œåˆ é™¤é“¾è¡¨å¤´ä½ç½® Set&lt;Integer&gt; keySet = cache.keySet(); Iterator&lt;Integer&gt; iterator = keySet.iterator(); cache.remove(iterator.next()); } cache.put(key,value); //æ’å…¥åˆ°é“¾è¡¨æœ«å°¾ }}/** * @program: Java * @description: LRUæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ç½®æ¢ç®—æ³•ï¼Œé€šè¿‡LinkedHashMapå†…éƒ¨removeEldestEntryæ–¹æ³•å®ç° * @author: Mr.Li * @create: 2020-07-17 10:59 **/class LRUCache { private Map&lt;Integer, Integer&gt; map; private int capacity; /** *åˆå§‹åŒ–æ„é€ å‡½æ•° * @param capacity */ public LRUCache(int capacity) { this.capacity = capacity; map = new LinkedHashMap&lt;Integer, Integer&gt;(capacity, 0.75f, true) { @Override protected boolean removeEldestEntry(Map.Entry eldest) { return size() &gt; capacity; // å®¹é‡å¤§äºcapacity æ—¶å°±åˆ é™¤ } }; } public int get(int key) { //è¿”å›keyå¯¹åº”çš„valueå€¼ï¼Œè‹¥ä¸å­˜åœ¨ï¼Œè¿”å›-1 return map.getOrDefault(key, -1); } public void put(int key, int value) { map.put(key, value); }} æœ€ä½³ç½®æ¢ç®—æ³•OPT: åŸç†ï¼šæ¯æ¬¡é€‰æ‹©å½“å‰ç‰©ç†å—ä¸­çš„é¡µé¢åœ¨æœªæ¥é•¿æ—¶é—´ä¸è¢«è®¿é—®çš„æˆ–æœªæ¥ä¸å†ä½¿ç”¨çš„é¡µé¢è¿›è¡Œæ·˜æ±° ä¼˜ç‚¹ï¼šå…·æœ‰è¾ƒå¥½çš„æ€§èƒ½ï¼Œå¯ä»¥ä¿è¯è·å¾—æœ€ä½çš„ç¼ºé¡µç‡ ç¼ºç‚¹ï¼šè¿‡äºç†æƒ³åŒ–ï¼Œä½†æ˜¯å®é™…ä¸Šæ— æ³•å®ç°ï¼ˆæ²¡åŠæ³•é¢„çŸ¥æœªæ¥çš„é¡µé¢ï¼‰ 2ã€æ­»é”æ¡ä»¶ã€è§£å†³æ–¹å¼ã€‚ æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šè¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„ä¸‹ç›¸äº’ç­‰å¾…çš„ç°è±¡ï¼› æ­»é”çš„æ¡ä»¶ï¼š äº’æ–¥æ¡ä»¶ï¼šè¿›ç¨‹å¯¹æ‰€åˆ†é…åˆ°çš„èµ„æºä¸å…è®¸å…¶ä»–è¿›ç¨‹è®¿é—®ï¼Œè‹¥å…¶ä»–è¿›ç¨‹è®¿é—®è¯¥èµ„æºï¼Œåªèƒ½ç­‰å¾…è‡³å æœ‰è¯¥èµ„æºçš„è¿›ç¨‹é‡Šæ”¾è¯¥èµ„æºï¼› è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šè¿›ç¨‹è·å¾—ä¸€å®šçš„èµ„æºåï¼Œåˆå¯¹å…¶ä»–èµ„æºå‘å‡ºè¯·æ±‚ï¼Œé˜»å¡è¿‡ç¨‹ä¸­ä¸ä¼šé‡Šæ”¾è‡ªå·±å·²ç»å æœ‰çš„èµ„æº éå‰¥å¤ºæ¡ä»¶ï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªå®Œæˆä½¿ç”¨ä¹‹å‰ï¼Œä¸å¯è¢«å‰¥å¤ºï¼Œåªèƒ½åœ¨ä½¿ç”¨åè‡ªå·±é‡Šæ”¾ å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šç³»ç»Ÿä¸­è‹¥å¹²è¿›ç¨‹ç»„æˆç¯è·¯ï¼Œç¯è·¯ä¸­æ¯ä¸ªè¿›ç¨‹éƒ½åœ¨ç­‰å¾…ç›¸é‚»è¿›ç¨‹å ç”¨çš„èµ„æº è§£å†³æ–¹æ³•ï¼šç ´åæ­»é”çš„ä»»æ„ä¸€æ¡ä»¶ ä¹è§‚é”ï¼Œç ´åèµ„æºäº’æ–¥æ¡ä»¶ï¼ŒCAS èµ„æºä¸€æ¬¡æ€§åˆ†é…ï¼Œä»è€Œå‰¥å¤ºè¯·æ±‚å’Œä¿æŒæ¡ä»¶ã€tryLock å¯å‰¥å¤ºèµ„æºï¼šå³å½“è¿›ç¨‹æ–°çš„èµ„æºæœªå¾—åˆ°æ»¡è¶³æ—¶ï¼Œé‡Šæ”¾å·²å æœ‰çš„èµ„æºï¼Œä»è€Œç ´åä¸å¯å‰¥å¤ºçš„æ¡ä»¶ï¼Œæ•°æ®åº“deadlockè¶…æ—¶ èµ„æºæœ‰åºåˆ†é…æ³•ï¼šç³»ç»Ÿç»™æ¯ç±»èµ„æºèµ‹äºˆä¸€ä¸ªåºå·ï¼Œæ¯ä¸ªè¿›ç¨‹æŒ‰ç¼–å·é€’å¢çš„è¯·æ±‚èµ„æºï¼Œä»è€Œç ´åç¯è·¯ç­‰å¾…çš„æ¡ä»¶ï¼Œè½¬è´¦åœºæ™¯ JavaåŸºç¡€é¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹æ€§ç‰¹æ€§ï¼šå°è£…ã€ç»§æ‰¿ã€å¤šæ€ å°è£…ï¼šå¯¹æŠ½è±¡çš„äº‹ç‰©æŠ½è±¡åŒ–æˆä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶å¯¹å…¶å¯¹è±¡çš„å±æ€§ç§æœ‰åŒ–ï¼ŒåŒæ—¶æä¾›ä¸€äº›èƒ½è¢«å¤–ç•Œè®¿é—®å±æ€§çš„æ–¹æ³•ï¼› ç»§æ‰¿ï¼šå­ç±»æ‰©å±•æ–°çš„æ•°æ®åŸŸæˆ–åŠŸèƒ½ï¼Œå¹¶å¤ç”¨çˆ¶ç±»çš„å±æ€§ä¸åŠŸèƒ½ï¼Œå•ç»§æ‰¿ï¼Œå¤šå®ç°ï¼› å¤šæ€ï¼šé€šè¿‡ç»§æ‰¿ï¼ˆå¤šä¸ªâ¼¦ç±»å¯¹åŒâ¼€â½…æ³•çš„é‡å†™ï¼‰ã€ä¹Ÿå¯ä»¥é€šè¿‡æ¥â¼ï¼ˆå®ç°æ¥â¼å¹¶è¦†ç›–æ¥â¼ï¼‰ 1ã€Javaä¸C++åŒºåˆ« ä¸åŒç‚¹ï¼šc++æ”¯æŒå¤šç»§æ‰¿ï¼Œå¹¶ä¸”æœ‰æŒ‡é’ˆçš„æ¦‚å¿µï¼Œç”±ç¨‹åºå‘˜è‡ªå·±ç®¡ç†å†…å­˜ï¼›Javaæ˜¯å•ç»§æ‰¿ï¼Œå¯ä»¥ç”¨æ¥å£å®ç°å¤šç»§æ‰¿ï¼ŒJava ä¸æä¾›æŒ‡é’ˆæ¥ç›´æ¥è®¿é—®å†…å­˜ï¼Œç¨‹åºå†…å­˜æ›´åŠ å®‰å…¨ï¼Œå¹¶ä¸”Javaæœ‰JVMâ¾ƒåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œä¸éœ€è¦ç¨‹åºå‘˜â¼¿åŠ¨é‡Šæ”¾â½†â½¤å†…å­˜ 2ã€å¤šæ€å®ç°åŸç†å¤šæ€çš„åº•å±‚å®ç°æ˜¯åŠ¨æ€ç»‘å®šï¼Œå³åœ¨è¿è¡Œæ—¶æ‰æŠŠæ–¹æ³•è°ƒç”¨ä¸æ–¹æ³•å®ç°å…³è”èµ·æ¥ã€‚ é™æ€ç»‘å®šä¸åŠ¨æ€ç»‘å®šï¼š ä¸€ç§æ˜¯åœ¨ç¼–è¯‘æœŸç¡®å®šï¼Œè¢«ç§°ä¸ºé™æ€åˆ†æ´¾ï¼Œæ¯”å¦‚æ–¹æ³•çš„é‡è½½ï¼› ä¸€ç§æ˜¯åœ¨è¿è¡Œæ—¶ç¡®å®šï¼Œè¢«ç§°ä¸ºåŠ¨æ€åˆ†æ´¾ï¼Œæ¯”å¦‚æ–¹æ³•çš„è¦†ç›–ï¼ˆé‡å†™ï¼‰å’Œæ¥å£çš„å®ç°ã€‚ å¤šæ€çš„å®ç° è™šæ‹Ÿæœºæ ˆä¸­ä¼šå­˜æ”¾å½“å‰æ–¹æ³•è°ƒç”¨çš„æ ˆå¸§ï¼ˆå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ ˆã€åŠ¨æ€è¿æ¥ ã€è¿”å›åœ°å€ï¼‰ã€‚å¤šæ€çš„å®ç°è¿‡ç¨‹ï¼Œå°±æ˜¯æ–¹æ³•è°ƒç”¨åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ï¼Œå¦‚æœå­ç±»è¦†ç›–äº†çˆ¶ç±»çš„æ–¹æ³•ï¼Œåˆ™åœ¨å¤šæ€è°ƒç”¨ä¸­ï¼ŒåŠ¨æ€ç»‘å®šè¿‡ç¨‹ä¼šé¦–å…ˆç¡®å®šå®é™…ç±»å‹æ˜¯å­ç±»ï¼Œä»è€Œå…ˆæœç´¢åˆ°å­ç±»ä¸­çš„æ–¹æ³•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¾¿æ˜¯æ–¹æ³•è¦†ç›–çš„æœ¬è´¨ã€‚ 3ã€staticå’Œfinalå…³é”®å­—staticï¼šå¯ä»¥ä¿®é¥°å±æ€§ã€æ–¹æ³• staticä¿®é¥°å±æ€§ï¼š ç±»çº§åˆ«å±æ€§ï¼Œæ‰€æœ‰å¯¹è±¡å…±äº«ä¸€ä»½ï¼Œéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼ˆåªåŠ è½½ä¸€æ¬¡ï¼‰ï¼Œå…ˆäºå¯¹è±¡çš„åˆ›å»ºï¼›å¯ä»¥ä½¿ç”¨ç±»åç›´æ¥è°ƒç”¨ã€‚ staticä¿®é¥°æ–¹æ³•ï¼š éšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼›å¯ä»¥ä½¿ç”¨ç±»åç›´æ¥è°ƒç”¨ï¼›é™æ€æ–¹æ³•ä¸­ï¼Œåªèƒ½è°ƒç”¨é™æ€çš„æˆå‘˜ï¼Œä¸å¯ç”¨thisï¼› finalï¼šå…³é”®å­—ä¸»è¦â½¤åœ¨ä¸‰ä¸ªåœ°â½…ï¼šå˜é‡ã€â½…æ³•ã€ç±»ã€‚ finalä¿®é¥°å˜é‡ï¼š å¦‚æœæ˜¯åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡ï¼Œåˆ™å…¶æ•°å€¼â¼€æ—¦åœ¨åˆå§‹åŒ–ä¹‹åä¾¿ä¸èƒ½æ›´æ”¹ï¼› å¦‚æœæ˜¯å¼•â½¤ç±»å‹çš„å˜é‡ï¼Œåˆ™åœ¨å¯¹å…¶åˆå§‹åŒ–ä¹‹åä¾¿ä¸èƒ½å†è®©å…¶æŒ‡å‘å¦â¼€ä¸ªå¯¹è±¡ã€‚ finalä¿®é¥°æ–¹æ³•ï¼š æŠŠâ½…æ³•é”å®šï¼Œä»¥é˜²ä»»ä½•ç»§æ‰¿ç±»ä¿®æ”¹å®ƒçš„å«ä¹‰ï¼ˆé‡å†™ï¼‰ï¼›ç±»ä¸­æ‰€æœ‰çš„ private â½…æ³•éƒ½éšå¼åœ°æŒ‡å®šä¸º finalã€‚ finalä¿®é¥°ç±»ï¼š final ä¿®é¥°ç±»æ—¶ï¼Œè¡¨æ˜è¿™ä¸ªç±»ä¸èƒ½è¢«ç»§æ‰¿ã€‚final ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜â½…æ³•éƒ½ä¼šè¢«éšå¼åœ°æŒ‡å®šä¸º final â½…æ³•ã€‚ ä¸€ä¸ªç±»ä¸èƒ½è¢«ç»§æ‰¿ï¼Œé™¤äº†finalå…³é”®å­—ä¹‹å¤–ï¼Œè¿˜æœ‰å¯ä»¥ç§æœ‰åŒ–æ„é€ å™¨ã€‚ï¼ˆå†…éƒ¨ç±»æ— æ•ˆï¼‰ 4ã€æŠ½è±¡ç±»å’Œæ¥å£æŠ½è±¡ç±»ï¼šåŒ…å«æŠ½è±¡æ–¹æ³•çš„ç±»ï¼Œå³ä½¿ç”¨abstractä¿®é¥°çš„ç±»ï¼›æŠ½è±¡ç±»åªèƒ½è¢«ç»§æ‰¿ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨finalä¿®é¥°ï¼ŒæŠ½è±¡ç±»ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œ æ¥å£ï¼šæ¥å£æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»å‹ï¼Œæ˜¯æŠ½è±¡æ–¹æ³•çš„é›†åˆï¼Œæ¥å£æ”¯æŒå¤šç»§æ‰¿ï¼Œæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œé»˜è®¤æ˜¯public abstractä¿®é¥°çš„æŠ½è±¡æ–¹æ³• ç›¸åŒç‚¹ï¼š â‘  æŠ½è±¡ç±»å’Œæ¥å£éƒ½ä¸èƒ½è¢«å®ä¾‹åŒ– â‘¡ æŠ½è±¡ç±»å’Œæ¥å£éƒ½å¯ä»¥å®šä¹‰æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»/å®ç°ç±»å¿…é¡»è¦†å†™è¿™äº›æŠ½è±¡æ–¹æ³• ä¸åŒç‚¹ï¼š â‘  æŠ½è±¡ç±»æœ‰æ„é€ æ–¹æ³•ï¼Œæ¥å£æ²¡æœ‰æ„é€ æ–¹æ³• â‘¢æŠ½è±¡ç±»å¯ä»¥åŒ…å«æ™®é€šæ–¹æ³•ï¼Œæ¥å£ä¸­åªèƒ½æ˜¯public abstractä¿®é¥°æŠ½è±¡æ–¹æ³•ï¼ˆJava8ä¹‹åå¯ä»¥ï¼‰ â‘¢ æŠ½è±¡ç±»åªèƒ½å•ç»§æ‰¿ï¼Œæ¥å£å¯ä»¥å¤šç»§æ‰¿ â‘£ æŠ½è±¡ç±»å¯ä»¥å®šä¹‰å„ç§ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œæ¥å£ä¸­åªèƒ½æ˜¯public static finalä¿®é¥°çš„é™æ€å¸¸é‡ æŠ½è±¡ç±»çš„ä½¿ç”¨åœºæ™¯ï¼š æ—¢æƒ³çº¦æŸå­ç±»å…·æœ‰å…±åŒçš„è¡Œä¸ºï¼ˆä½†ä¸å†ä¹å…¶å¦‚ä½•å®ç°ï¼‰ï¼Œåˆæƒ³æ‹¥æœ‰ç¼ºçœçš„æ–¹æ³•ï¼Œåˆèƒ½æ‹¥æœ‰å®ä¾‹å˜é‡ æ¥å£çš„åº”ç”¨åœºæ™¯ï¼š çº¦æŸå¤šä¸ªå®ç°ç±»å…·æœ‰ç»Ÿä¸€çš„è¡Œä¸ºï¼Œä½†æ˜¯ä¸åœ¨ä¹æ¯ä¸ªå®ç°ç±»å¦‚ä½•å…·ä½“å®ç°ï¼›å®ç°ç±»ä¸­å„ä¸ªåŠŸèƒ½ä¹‹é—´å¯èƒ½æ²¡æœ‰ä»»ä½•è”ç³» 5ã€æ³›å‹ä»¥åŠæ³›å‹æ“¦é™¤å‚è€ƒï¼šhttps://blog.csdn.net/baoyinwang/article/details/107341997 æ³›å‹ï¼š æ³›å‹çš„æœ¬è´¨æ˜¯å‚æ•°åŒ–ç±»å‹ã€‚è¿™ç§å‚æ•°ç±»å‹å¯ä»¥ç”¨åœ¨ç±»ã€æ¥å£å’Œæ–¹æ³•çš„åˆ›å»ºä¸­ï¼Œåˆ†åˆ«ç§°ä¸ºæ³›å‹ç±»ã€æ³›å‹æ¥å£å’Œæ³›å‹æ–¹æ³•ã€‚ æ³›å‹æ“¦é™¤ï¼š Javaçš„æ³›å‹æ˜¯ä¼ªæ³›å‹ï¼Œä½¿ç”¨æ³›å‹çš„æ—¶å€™åŠ ä¸Šç±»å‹å‚æ•°ï¼Œåœ¨ç¼–è¯‘å™¨ç¼–è¯‘ç”Ÿæˆçš„å­—èŠ‚ç çš„æ—¶å€™ä¼šå»æ‰ï¼Œè¿™ä¸ªè¿‡ç¨‹æˆä¸ºç±»å‹æ“¦é™¤ã€‚ å¦‚Listç­‰ç±»å‹ï¼Œåœ¨ç¼–è¯‘ä¹‹åéƒ½ä¼šå˜æˆ Listã€‚JVM çœ‹åˆ°çš„åªæ˜¯ Listï¼Œè€Œç”±æ³›å‹é™„åŠ çš„ç±»å‹ä¿¡æ¯å¯¹ JVM æ¥è¯´æ˜¯ä¸å¯è§çš„ã€‚ å¯ä»¥é€šè¿‡åå°„æ·»åŠ å…¶å®ƒç±»å‹å…ƒç´  6ã€åå°„åŸç†ä»¥åŠä½¿ç”¨åœºæ™¯Javaåå°„ï¼š æ˜¯æŒ‡åœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»éƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»æ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•ï¼›å¹¶ä¸”éƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•ï¼› åå°„åŸç†ï¼š åå°„é¦–å…ˆæ˜¯èƒ½å¤Ÿè·å–åˆ°Javaä¸­çš„åå°„ç±»çš„å­—èŠ‚ç ï¼Œç„¶åå°†å­—èŠ‚ç ä¸­çš„æ–¹æ³•ï¼Œå˜é‡ï¼Œæ„é€ å‡½æ•°ç­‰æ˜ å°„æˆ ç›¸åº”çš„ Methodã€Filedã€Constructor ç­‰ç±» å¦‚ä½•å¾—åˆ°Classçš„å®ä¾‹: 1231.ç±»å.class(å°±æ˜¯ä¸€ä»½å­—èŠ‚ç )2.Class.forName(String className);æ ¹æ®ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥æ„å»ºClasså¯¹è±¡3.æ¯ä¸€ä¸ªå¯¹è±¡å¤šæœ‰getClass()æ–¹æ³•:obj.getClass();è¿”å›å¯¹è±¡çš„çœŸå®ç±»å‹ ä½¿ç”¨åœºæ™¯ï¼š å¼€å‘é€šç”¨æ¡†æ¶ - åå°„æœ€é‡è¦çš„ç”¨é€”å°±æ˜¯å¼€å‘å„ç§é€šç”¨æ¡†æ¶ã€‚å¾ˆå¤šæ¡†æ¶ï¼ˆæ¯”å¦‚ Springï¼‰éƒ½æ˜¯é…ç½®åŒ–çš„ï¼ˆæ¯”å¦‚é€šè¿‡ XML æ–‡ä»¶é…ç½® JavaBeanã€Filter ç­‰ï¼‰ï¼Œä¸ºäº†ä¿è¯æ¡†æ¶çš„é€šç”¨æ€§ï¼Œéœ€è¦æ ¹æ®é…ç½®æ–‡ä»¶è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ä¸åŒçš„å¯¹è±¡æˆ–ç±»ï¼Œè°ƒç”¨ä¸åŒçš„æ–¹æ³•ã€‚ åŠ¨æ€ä»£ç† - åœ¨åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰ä¸­ï¼Œéœ€è¦æ‹¦æˆªç‰¹å®šçš„æ–¹æ³•ï¼Œé€šå¸¸ï¼Œä¼šé€‰æ‹©åŠ¨æ€ä»£ç†æ–¹å¼ã€‚è¿™æ—¶ï¼Œå°±éœ€è¦åå°„æŠ€æœ¯æ¥å®ç°äº†ã€‚ JDKï¼šspringé»˜è®¤åŠ¨æ€ä»£ç†ï¼Œéœ€è¦å®ç°æ¥å£ CGLIBï¼šé€šè¿‡asmæ¡†æ¶åºåˆ—åŒ–å­—èŠ‚æµï¼Œå¯é…ç½®ï¼Œæ€§èƒ½å·® è‡ªå®šä¹‰æ³¨è§£ - æ³¨è§£æœ¬èº«ä»…ä»…æ˜¯èµ·åˆ°æ ‡è®°ä½œç”¨ï¼Œå®ƒéœ€è¦åˆ©ç”¨åå°„æœºåˆ¶ï¼Œæ ¹æ®æ³¨è§£æ ‡è®°å»è°ƒç”¨æ³¨è§£è§£é‡Šå™¨ï¼Œæ‰§è¡Œè¡Œä¸ºã€‚ 7ã€Javaå¼‚å¸¸ä½“ç³» Throwable æ˜¯ Java è¯­è¨€ä¸­æ‰€æœ‰é”™è¯¯æˆ–å¼‚å¸¸çš„è¶…ç±»ã€‚ä¸‹ä¸€å±‚åˆ†ä¸º Error å’Œ Exception Error ï¼š æ˜¯æŒ‡ java è¿è¡Œæ—¶ç³»ç»Ÿçš„å†…éƒ¨é”™è¯¯å’Œèµ„æºè€—å°½é”™è¯¯ã€‚åº”ç”¨ç¨‹åºä¸ä¼šæŠ›å‡ºè¯¥ç±»å¯¹è±¡ã€‚å¦‚æœå‡ºç°äº†è¿™æ ·çš„é”™è¯¯ï¼Œé™¤äº†å‘ŠçŸ¥ç”¨æˆ·ï¼Œå‰©ä¸‹çš„å°±æ˜¯å°½åŠ›ä½¿ç¨‹åºå®‰å…¨çš„ç»ˆæ­¢ã€‚ Exception åŒ…å«ï¼šRuntimeException ã€CheckedException ç¼–ç¨‹é”™è¯¯å¯ä»¥åˆ†æˆä¸‰ç±»ï¼šè¯­æ³•é”™è¯¯ã€é€»è¾‘é”™è¯¯å’Œè¿è¡Œé”™è¯¯ã€‚ è¯­æ³•é”™è¯¯ï¼ˆä¹Ÿç§°ç¼–è¯‘é”™è¯¯ï¼‰æ˜¯åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å‡ºç°çš„é”™è¯¯ï¼Œç”±ç¼–è¯‘å™¨æ£€æŸ¥å‘ç°è¯­æ³•é”™è¯¯ é€»è¾‘é”™è¯¯æŒ‡ç¨‹åºçš„æ‰§è¡Œç»“æœä¸é¢„æœŸä¸ç¬¦ï¼Œå¯ä»¥é€šè¿‡è°ƒè¯•å®šä½å¹¶å‘ç°é”™è¯¯çš„åŸå›  è¿è¡Œé”™è¯¯æ˜¯å¼•èµ·ç¨‹åºéæ­£å¸¸ç»ˆç«¯çš„é”™è¯¯ï¼Œéœ€è¦é€šè¿‡å¼‚å¸¸å¤„ç†çš„æ–¹å¼å¤„ç†è¿è¡Œé”™è¯¯ RuntimeExceptionï¼š è¿è¡Œæ—¶å¼‚å¸¸ï¼Œç¨‹åºåº”è¯¥ä»é€»è¾‘è§’åº¦å°½å¯èƒ½é¿å…è¿™ç±»å¼‚å¸¸çš„å‘ç”Ÿã€‚ å¦‚ NullPointerException ã€ ClassCastException ï¼› CheckedExceptionï¼šå—æ£€å¼‚å¸¸ï¼Œç¨‹åºä½¿ç”¨trycatchè¿›è¡Œæ•æ‰å¤„ç† å¦‚IOExceptionã€SQLExceptionã€NotFoundExceptionï¼› æ•°æ®ç»“æ„ 1ã€ArrayListå’ŒLinkedListArrayListï¼š åº•å±‚åŸºäºæ•°ç»„å®ç°ï¼Œæ”¯æŒå¯¹å…ƒç´ è¿›è¡Œå¿«é€Ÿéšæœºè®¿é—®ï¼Œé€‚åˆéšæœºæŸ¥æ‰¾å’Œéå†ï¼Œä¸é€‚åˆæ’å…¥å’Œåˆ é™¤ã€‚ï¼ˆæä¸€å¥å®é™…ä¸Šï¼‰â€‹ é»˜è®¤åˆå§‹å¤§å°ä¸º10ï¼Œå½“æ•°ç»„å®¹é‡ä¸å¤Ÿæ—¶ï¼Œä¼šè§¦å‘æ‰©å®¹æœºåˆ¶ï¼ˆæ‰©å¤§åˆ°å½“å‰çš„1.5å€ï¼‰ï¼Œéœ€è¦å°†åŸæ¥æ•°ç»„çš„æ•°æ®å¤åˆ¶åˆ°æ–°çš„æ•°ç»„ä¸­ï¼›å½“ä» ArrayList çš„ä¸­é—´ä½ç½®æ’å…¥æˆ–è€…åˆ é™¤å…ƒç´ æ—¶ï¼Œéœ€è¦å¯¹æ•°ç»„è¿›è¡Œå¤åˆ¶ã€ç§»åŠ¨ã€ä»£ä»·æ¯”è¾ƒé«˜ã€‚ LinkedListï¼š åº•å±‚åŸºäºåŒå‘é“¾è¡¨å®ç°ï¼Œé€‚åˆæ•°æ®çš„åŠ¨æ€æ’å…¥å’Œåˆ é™¤ï¼›â€‹ å†…éƒ¨æä¾›äº† List æ¥å£ä¸­æ²¡æœ‰å®šä¹‰çš„æ–¹æ³•ï¼Œç”¨äºæ“ä½œè¡¨å¤´å’Œè¡¨å°¾å…ƒç´ ï¼Œå¯ä»¥å½“ä½œå †æ ˆã€é˜Ÿåˆ—å’ŒåŒå‘é˜Ÿåˆ—ä½¿ç”¨ã€‚ï¼ˆæ¯”å¦‚jdkå®˜æ–¹æ¨èä½¿ç”¨åŸºäºlinkedListçš„Dequeè¿›è¡Œå †æ ˆæ“ä½œï¼‰ ArrayListä¸LinkedListåŒºåˆ«ï¼š éƒ½æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼ŒArrayList é€‚ç”¨äºæŸ¥æ‰¾çš„åœºæ™¯ï¼ŒLinkedList é€‚ç”¨äºå¢åŠ ã€åˆ é™¤å¤šçš„åœºæ™¯ å®ç°çº¿ç¨‹å®‰å…¨ï¼š å¯ä»¥ä½¿ç”¨åŸç”Ÿçš„Vectorï¼Œæˆ–è€…æ˜¯Collections.synchronizedList(List list)å‡½æ•°è¿”å›ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ArrayListé›†åˆã€‚â€‹ å»ºè®®ä½¿ç”¨concurrentå¹¶å‘åŒ…ä¸‹çš„CopyOnWriteArrayListçš„ã€‚ â‘ Vector: åº•å±‚é€šè¿‡synchronizeä¿®é¥°ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ•ˆç‡è¾ƒå·® â‘¡CopyOnWriteArrayListï¼šå†™æ—¶åŠ é”ï¼Œä½¿ç”¨äº†ä¸€ç§å«å†™æ—¶å¤åˆ¶çš„æ–¹æ³•ï¼›è¯»æ“ä½œæ˜¯å¯ä»¥ä¸ç”¨åŠ é”çš„ 2ã€Listéå†å¿«é€Ÿå’Œå®‰å…¨å¤±è´¥â‘ æ™®é€šforå¾ªç¯éå†Liståˆ é™¤æŒ‡å®šå…ƒç´  1234for(int i=0; i &lt; list.size(); i++){ if(list.get(i) == 5) list.remove(i);} â‘¡ è¿­ä»£éå†,ç”¨list.remove(i)æ–¹æ³•åˆ é™¤å…ƒç´  1234567Iterator&lt;Integer&gt; it = list.iterator();while(it.hasNext()){ Integer value = it.next(); if(value == 5){ list.remove(value); }} â‘¢foreachéå†Liståˆ é™¤å…ƒç´  123for(Integer i:list){ if(i==3) list.remove(i);} failâ€”fastï¼šå¿«é€Ÿå¤±è´¥ å½“å¼‚å¸¸äº§ç”Ÿæ—¶ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œç¨‹åºç»ˆæ­¢; fail-fastä¸»è¦æ˜¯ä½“ç°åœ¨å½“æˆ‘ä»¬åœ¨éå†é›†åˆå…ƒç´ çš„æ—¶å€™ï¼Œç»å¸¸ä¼šä½¿ç”¨è¿­ä»£å™¨ï¼Œä½†åœ¨è¿­ä»£å™¨éå†å…ƒç´ çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé›†åˆçš„ç»“æ„ï¼ˆmodCountï¼‰è¢«æ”¹å˜çš„è¯ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ConcurrentModificationExceptionï¼Œé˜²æ­¢ç»§ç»­éå†ã€‚è¿™å°±æ˜¯æ‰€è°“çš„å¿«é€Ÿå¤±è´¥æœºåˆ¶ã€‚ failâ€”safeï¼šå®‰å…¨å¤±è´¥ é‡‡ç”¨å®‰å…¨å¤±è´¥æœºåˆ¶çš„é›†åˆå®¹å™¨ï¼Œåœ¨éå†æ—¶ä¸æ˜¯ç›´æ¥åœ¨é›†åˆå†…å®¹ä¸Šè®¿é—®çš„ï¼Œè€Œæ˜¯å…ˆå¤åˆ¶åŸæœ‰é›†åˆå†…å®¹ï¼Œåœ¨æ‹·è´çš„é›†åˆä¸Šè¿›è¡Œéå†ã€‚ç”±äºåœ¨éå†è¿‡ç¨‹ä¸­å¯¹åŸé›†åˆæ‰€ä½œçš„ä¿®æ”¹å¹¶ä¸èƒ½è¢«è¿­ä»£å™¨æ£€æµ‹åˆ°ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘ConcurrentModificationExceptionã€‚ ç¼ºç‚¹ï¼šåŸºäºæ‹·è´å†…å®¹çš„ä¼˜ç‚¹æ˜¯é¿å…äº†ConcurrentModificationExceptionï¼Œä½†åŒæ ·åœ°ï¼Œè¿­ä»£å™¨å¹¶ä¸èƒ½è®¿é—®åˆ°ä¿®æ”¹åçš„å†…å®¹ï¼Œå³ï¼šè¿­ä»£å™¨éå†çš„æ˜¯å¼€å§‹éå†é‚£ä¸€åˆ»æ‹¿åˆ°çš„é›†åˆæ‹·è´ï¼Œåœ¨éå†æœŸé—´åŸé›†åˆå‘ç”Ÿçš„ä¿®æ”¹è¿­ä»£å™¨æ˜¯ä¸çŸ¥é“çš„ã€‚ åœºæ™¯ï¼šjava.util.concurrentåŒ…ä¸‹çš„å®¹å™¨éƒ½æ˜¯å®‰å…¨å¤±è´¥ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä½¿ç”¨ï¼Œå¹¶å‘ä¿®æ”¹ã€‚ 3ã€è¯¦ç»†ä»‹ç»HashMapè§’åº¦ï¼šæ•°æ®ç»“æ„+æ‰©å®¹æƒ…å†µ+putæŸ¥æ‰¾çš„è¯¦ç»†è¿‡ç¨‹+å“ˆå¸Œå‡½æ•°+å®¹é‡ä¸ºä»€ä¹ˆå§‹ç»ˆéƒ½æ˜¯2^Nï¼ŒJDK1.7ä¸1.8çš„åŒºåˆ«ã€‚ å‚è€ƒï¼šhttps://www.jianshu.com/p/9fe4cb316c05 æ•°æ®ç»“æ„ï¼š HashMapåœ¨åº•å±‚æ•°æ®ç»“æ„ä¸Šé‡‡ç”¨äº†æ•°ç»„ï¼‹é“¾è¡¨ï¼‹çº¢é»‘æ ‘ï¼Œé€šè¿‡æ•£åˆ—æ˜ å°„æ¥å­˜å‚¨é”®å€¼å¯¹æ•°æ® æ‰©å®¹æƒ…å†µï¼š é»˜è®¤çš„è´Ÿè½½å› å­æ˜¯0.75ï¼Œå¦‚æœæ•°ç»„ä¸­å·²ç»å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°å¤§äºæ•°ç»„é•¿åº¦çš„75%ï¼Œå°†ä¼šå¼•å‘æ‰©å®¹æ“ä½œã€‚ ã€1ã€‘åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸ºåŸæ¥æ•°ç»„é•¿åº¦ä¸¤å€çš„æ–°æ•°ç»„ã€‚ ã€2ã€‘1.7é‡‡ç”¨Entryçš„é‡æ–°hashè¿ç®—ï¼Œ1.8é‡‡ç”¨é«˜äºä¸è¿ç®—ã€‚ putæ“ä½œæ­¥éª¤ï¼š 1ã€åˆ¤æ–­æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¿›è¡Œåˆå§‹åŒ–; 2ã€ä¸ä¸ºç©ºï¼Œåˆ™è®¡ç®— key çš„ hash å€¼ï¼Œé€šè¿‡(n - 1) &amp; hashè®¡ç®—åº”å½“å­˜æ”¾åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡ index; 3ã€æŸ¥çœ‹ table[index] æ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œæ²¡æœ‰æ•°æ®å°±æ„é€ ä¸€ä¸ªNodeèŠ‚ç‚¹å­˜æ”¾åœ¨ table[index] ä¸­ï¼› 4ã€å­˜åœ¨æ•°æ®ï¼Œè¯´æ˜å‘ç”Ÿäº†hashå†²çª(å­˜åœ¨äºŒä¸ªèŠ‚ç‚¹keyçš„hashå€¼ä¸€æ ·), ç»§ç»­åˆ¤æ–­keyæ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰ï¼Œç”¨æ–°çš„valueæ›¿æ¢åŸæ•°æ®ï¼› 5ã€è‹¥ä¸ç›¸ç­‰ï¼Œåˆ¤æ–­å½“å‰èŠ‚ç‚¹ç±»å‹æ˜¯ä¸æ˜¯æ ‘å‹èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯æ ‘å‹èŠ‚ç‚¹ï¼Œåˆ›é€ æ ‘å‹èŠ‚ç‚¹æ’å…¥çº¢é»‘æ ‘ä¸­ï¼› 6ã€è‹¥ä¸æ˜¯çº¢é»‘æ ‘ï¼Œåˆ›å»ºæ™®é€šNodeåŠ å…¥é“¾è¡¨ä¸­ï¼›åˆ¤æ–­é“¾è¡¨é•¿åº¦æ˜¯å¦å¤§äº 8ï¼Œå¤§äºåˆ™å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼› 7ã€æ’å…¥å®Œæˆä¹‹ååˆ¤æ–­å½“å‰èŠ‚ç‚¹æ•°æ˜¯å¦å¤§äºé˜ˆå€¼ï¼Œè‹¥å¤§äºï¼Œåˆ™æ‰©å®¹ä¸ºåŸæ•°ç»„çš„äºŒå€ å“ˆå¸Œå‡½æ•°ï¼š é€šè¿‡hashå‡½æ•°ï¼ˆä¼˜è´¨å› å­31å¾ªç¯ç´¯åŠ ï¼‰å…ˆæ‹¿åˆ° key çš„hashcodeï¼Œæ˜¯ä¸€ä¸ª32ä½çš„å€¼ï¼Œç„¶åè®©hashcodeçš„é«˜16ä½å’Œä½16ä½è¿›è¡Œå¼‚æˆ–æ“ä½œã€‚è¯¥å‡½æ•°ä¹Ÿç§°ä¸ºæ‰°åŠ¨å‡½æ•°ï¼Œåšåˆ°å°½å¯èƒ½é™ä½hashç¢°æ’ï¼Œé€šè¿‡å°¾æ’æ³•è¿›è¡Œæ’å…¥ã€‚ å®¹é‡ä¸ºä»€ä¹ˆå§‹ç»ˆéƒ½æ˜¯2^Nï¼š å…ˆåšå¯¹æ•°ç»„çš„â»“åº¦å–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ä½™æ•°æ‰èƒ½â½¤æ¥è¦å­˜æ”¾çš„ä½ç½®ä¹Ÿå°±æ˜¯å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ã€‚è¿™ä¸ªæ•°ç»„ä¸‹æ ‡çš„è®¡ç®—â½…æ³•æ˜¯â€œ (n - 1) &amp; hash â€ã€‚ï¼ˆnä»£è¡¨æ•°ç»„â»“åº¦ï¼‰ã€‚æ–¹ä¾¿æ•°ç»„çš„æ‰©å®¹å’Œå¢åˆ æ”¹æ—¶çš„å–æ¨¡ã€‚ JDK1.7ä¸1.8çš„åŒºåˆ«ï¼š JDK1.7 HashMapï¼š åº•å±‚æ˜¯ æ•°ç»„å’Œé“¾è¡¨ ç»“åˆåœ¨â¼€èµ·ä½¿â½¤ä¹Ÿå°±æ˜¯é“¾è¡¨æ•£åˆ—ã€‚å¦‚æœç›¸åŒçš„è¯ï¼Œç›´æ¥è¦†ç›–ï¼Œä¸ç›¸åŒå°±é€šè¿‡æ‹‰é“¾æ³•è§£å†³å†²çªã€‚æ‰©å®¹ç¿»è½¬æ—¶é¡ºåºä¸ä¸€è‡´ä½¿ç”¨å¤´æ’æ³•ä¼šäº§ç”Ÿæ­»å¾ªç¯ï¼Œå¯¼è‡´cpu100% JDK1.8 HashMapï¼š åº•å±‚æ•°æ®ç»“æ„ä¸Šé‡‡ç”¨äº†æ•°ç»„ï¼‹é“¾è¡¨ï¼‹çº¢é»‘æ ‘ï¼›å½“é“¾è¡¨â»“åº¦â¼¤äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8-æ³Šæ¾åˆ†å¸ƒï¼‰ï¼Œæ•°ç»„çš„â»“åº¦å¤§äº 64æ—¶ï¼Œé“¾è¡¨å°†è½¬åŒ–ä¸ºçº¢â¿Šæ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚ï¼ˆè§£å†³äº†tomcatè‡­åæ˜­è‘—çš„urlå‚æ•°dosæ”»å‡»é—®é¢˜ï¼‰ **4ã€ConcurrentHashMap ** å¯ä»¥é€šè¿‡ConcurrentHashMap å’Œ Hashtableæ¥å®ç°çº¿ç¨‹å®‰å…¨ï¼›Hashtable æ˜¯åŸå§‹APIç±»ï¼Œé€šè¿‡synchronizeåŒæ­¥ä¿®é¥°ï¼Œæ•ˆç‡ä½ä¸‹ï¼›ConcurrentHashMap é€šè¿‡åˆ†æ®µé”å®ç°ï¼Œæ•ˆç‡è¾ƒæ¯”Hashtableè¦å¥½ï¼› ConcurrentHashMapçš„åº•å±‚å®ç°ï¼š JDK1.7çš„ ConcurrentHashMap åº•å±‚é‡‡â½¤ åˆ†æ®µçš„æ•°ç»„+é“¾è¡¨ å®ç°ï¼›é‡‡ç”¨ åˆ†æ®µé”ï¼ˆSagmentï¼‰ å¯¹æ•´ä¸ªæ¡¶æ•°ç»„è¿›â¾äº†åˆ†å‰²åˆ†æ®µ(Segmenté»˜è®¤16ä¸ª)ï¼Œæ¯â¼€æŠŠé”åªé”å®¹å™¨å…¶ä¸­â¼€éƒ¨åˆ†æ•°æ®ï¼Œå¤šçº¿ç¨‹è®¿é—®å®¹å™¨â¾¥ä¸åŒæ•°æ®æ®µçš„æ•°æ®ï¼Œå°±ä¸ä¼šå­˜åœ¨é”ç«äº‰ï¼Œæâ¾¼å¹¶å‘è®¿é—®ç‡ã€‚ JDK1.8çš„ ConcurrentHashMap é‡‡â½¤çš„æ•°æ®ç»“æ„è·ŸHashMap1.8çš„ç»“æ„â¼€æ ·ï¼Œæ•°ç»„+é“¾è¡¨/çº¢â¿Šæ ‘ï¼›æ‘’å¼ƒäº†Segmentçš„æ¦‚å¿µï¼Œâ½½æ˜¯ç›´æ¥â½¤ Node æ•°ç»„+é“¾è¡¨+çº¢â¿Šæ ‘çš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œé€šè¿‡å¹¶å‘æ§åˆ¶ synchronized å’ŒCASæ¥æ“ä½œä¿è¯çº¿ç¨‹çš„å®‰å…¨ã€‚ 5ã€åºåˆ—åŒ–å’Œååºåˆ—åŒ– åºåˆ—åŒ–çš„æ„æ€å°±æ˜¯å°†å¯¹è±¡çš„çŠ¶æ€è½¬åŒ–æˆå­—èŠ‚æµï¼Œä»¥åå¯ä»¥é€šè¿‡è¿™äº›å€¼å†ç”Ÿæˆç›¸åŒçŠ¶æ€çš„å¯¹è±¡ã€‚å¯¹è±¡åºåˆ—åŒ–æ˜¯å¯¹è±¡æŒä¹…åŒ–çš„ä¸€ç§å®ç°æ–¹æ³•ï¼Œå®ƒæ˜¯å°†å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•è½¬åŒ–ä¸ºä¸€ç§åºåˆ—åŒ–çš„å½¢å¼ç”¨äºå­˜å‚¨å’Œä¼ è¾“ã€‚ååºåˆ—åŒ–å°±æ˜¯æ ¹æ®è¿™äº›ä¿å­˜çš„ä¿¡æ¯é‡å»ºå¯¹è±¡çš„è¿‡ç¨‹ã€‚ åºåˆ—åŒ–ï¼šå°†javaå¯¹è±¡è½¬åŒ–ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ã€‚ ååºåˆ—åŒ–ï¼šå°†å­—èŠ‚åºåˆ—è½¬åŒ–ä¸ºjavaå¯¹è±¡çš„è¿‡ç¨‹ã€‚ ä¼˜ç‚¹ï¼š aã€å®ç°äº†æ•°æ®çš„æŒä¹…åŒ–ï¼Œé€šè¿‡åºåˆ—åŒ–å¯ä»¥æŠŠæ•°æ®æ°¸ä¹…åœ°ä¿å­˜åˆ°ç¡¬ç›˜ä¸Šï¼ˆé€šå¸¸å­˜æ”¾åœ¨æ–‡ä»¶é‡Œï¼‰Redisçš„RDB bã€åˆ©ç”¨åºåˆ—åŒ–å®ç°è¿œç¨‹é€šä¿¡ï¼Œå³åœ¨ç½‘ç»œä¸Šä¼ é€å¯¹è±¡çš„å­—èŠ‚åºåˆ—ã€‚ Googleçš„protoBuf ååºåˆ—åŒ–å¤±è´¥çš„åœºæ™¯ï¼š åºåˆ—åŒ–IDï¼šserialVersionUIDä¸ä¸€è‡´çš„æ—¶å€™ï¼Œå¯¼è‡´ååºåˆ—åŒ–å¤±è´¥ 6ã€StringString ä½¿ç”¨æ•°ç»„å­˜å‚¨å†…å®¹ï¼Œæ•°ç»„ä½¿ç”¨ final ä¿®é¥°ï¼Œå› æ­¤ String å®šä¹‰çš„å­—ç¬¦ä¸²çš„å€¼ä¹Ÿæ˜¯ä¸å¯å˜çš„ StringBuffer å¯¹æ–¹æ³•åŠ äº†åŒæ­¥é”ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œæ•ˆç‡ç•¥ä½äº StringBuilder è®¾è®¡æ¨¡å¼ä¸åŸåˆ™1ã€å•ä¾‹æ¨¡å¼ æŸä¸ªç±»åªèƒ½ç”Ÿæˆä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹å…¨å±€è®¿é—®ï¼Œä¾‹å¦‚Springå®¹å™¨é‡Œä¸€çº§ç¼“å­˜é‡Œçš„å•ä¾‹æ± ã€‚ ä¼˜ç‚¹ï¼š å”¯ä¸€è®¿é—®ï¼šå¦‚ç”Ÿæˆå”¯ä¸€åºåˆ—åŒ–çš„åœºæ™¯ã€æˆ–è€…springé»˜è®¤çš„beanç±»å‹ã€‚ æé«˜æ€§èƒ½ï¼šé¢‘ç¹å®ä¾‹åŒ–åˆ›å»ºé”€æ¯æˆ–è€…è€—æ—¶è€—èµ„æºçš„åœºæ™¯ï¼Œå¦‚è¿æ¥æ± ã€çº¿ç¨‹æ± ã€‚ ç¼ºç‚¹ï¼š ä¸é€‚åˆæœ‰çŠ¶æ€ä¸”éœ€å˜æ›´çš„ å®ç°æ–¹å¼ï¼š é¥¿æ±‰å¼ï¼šçº¿ç¨‹å®‰å…¨é€Ÿåº¦å¿« æ‡’æ±‰å¼ï¼šåŒé‡æ£€æµ‹é”ï¼Œç¬¬ä¸€æ¬¡å‡å°‘é”çš„å¼€é”€ã€ç¬¬äºŒæ¬¡é˜²æ­¢é‡å¤ã€volatileé˜²æ­¢é‡æ’åºå¯¼è‡´å®ä¾‹åŒ–æœªå®Œæˆ é™æ€å†…éƒ¨ç±»ï¼šçº¿ç¨‹å®‰å…¨åˆ©ç”¨ç‡é«˜ æšä¸¾ï¼šeffictiveJAVAæ¨èï¼Œåå°„ä¹Ÿæ— æ³•ç ´å 2ã€å·¥å‚æ¨¡å¼ å®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºäº§å“çš„æ¥å£ï¼Œç”±å­ç±»å†³å®šç”Ÿäº§ä½•ç§äº§å“ã€‚ ä¼˜ç‚¹ï¼šè§£è€¦ï¼šæä¾›å‚æ•°å³å¯è·å–äº§å“ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶å¯ä»¥ä¸ä¿®æ”¹ä»£ç å¢åŠ å…·ä½“äº§å“ã€‚ ç¼ºç‚¹ï¼šæ¯å¢åŠ ä¸€ä¸ªäº§å“å°±å¾—æ–°å¢ä¸€ä¸ªäº§å“ç±» 3ã€æŠ½è±¡å·¥å‚æ¨¡å¼ æä¾›ä¸€ä¸ªæ¥å£ï¼Œç”¨äºåˆ›å»ºç›¸å…³æˆ–è€…ä¾èµ–å¯¹è±¡çš„å®¶æ—ï¼Œå¹¶ç”±æ­¤è¿›è¡Œçº¦æŸã€‚ ä¼˜ç‚¹ï¼šå¯ä»¥åœ¨ç±»çš„å†…éƒ¨å¯¹äº§å“æ—è¿›è¡Œçº¦æŸ ç¼ºç‚¹ï¼šå‡å¦‚äº§å“æ—ä¸­éœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„äº§å“ï¼Œåˆ™å‡ ä¹æ‰€æœ‰çš„å·¥å‚ç±»éƒ½éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚ é¢è¯•é¢˜æ„é€ æ–¹æ³•æ„é€ æ–¹æ³•å¯ä»¥è¢«é‡è½½ï¼Œåªæœ‰å½“ç±»ä¸­æ²¡æœ‰æ˜¾æ€§å£°æ˜ä»»ä½•æ„é€ æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæœ‰é»˜è®¤æ„é€ æ–¹æ³•ã€‚ æ„é€ æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œæ„é€ æ–¹æ³•çš„ä½œç”¨æ˜¯åˆ›å»ºæ–°å¯¹è±¡ã€‚ åˆå§‹åŒ–å—é™æ€åˆå§‹åŒ–å—çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¼šæœ€å…ˆæ‰§è¡Œï¼Œåœ¨éé™æ€åˆå§‹åŒ–å—ä¹‹å‰æ‰§è¡Œã€‚ é™æ€åˆå§‹åŒ–å—ä¼šåœ¨ç±»ç¬¬ä¸€æ¬¡è¢«åŠ è½½æ—¶æœ€å…ˆæ‰§è¡Œï¼Œå› æ­¤åœ¨ main æ–¹æ³•ä¹‹å‰ã€‚ Thiså…³é”®å­— this ä»£è¡¨å½“å‰å¯¹è±¡çš„å¼•ç”¨ã€‚å½“å‰å¯¹è±¡æŒ‡çš„æ˜¯è°ƒç”¨ç±»ä¸­çš„å±æ€§æˆ–æ–¹æ³•çš„å¯¹è±¡ å…³é”®å­— this ä¸å¯ä»¥åœ¨é™æ€æ–¹æ³•ä¸­ä½¿ç”¨ã€‚é™æ€æ–¹æ³•ä¸ä¾èµ–äºç±»çš„å…·ä½“å¯¹è±¡çš„å¼•ç”¨ é‡å†™å’Œé‡è½½çš„åŒºåˆ«é‡è½½æŒ‡åœ¨åŒä¸€ä¸ªç±»ä¸­å®šä¹‰å¤šä¸ªæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åç§°ç›¸åŒï¼Œç­¾åä¸åŒã€‚ é‡å†™æŒ‡åœ¨å­ç±»ä¸­çš„æ–¹æ³•çš„åç§°å’Œç­¾åéƒ½å’Œçˆ¶ç±»ç›¸åŒï¼Œä½¿ç”¨overrideæ³¨è§£ Objectç±»æ–¹æ³•toString é»˜è®¤æ˜¯ä¸ªæŒ‡é’ˆï¼Œä¸€èˆ¬éœ€è¦é‡å†™ï¼Œæœªé‡å†™æƒ…å†µä¸‹ï¼Œè¿”å› 1getClass().getName() + '@' + Integer.toHexString(hashCode()) equals æ¯”è¾ƒå¯¹è±¡æ˜¯å¦ç›¸åŒï¼Œé»˜è®¤å’Œ==åŠŸèƒ½ä¸€è‡´ hashCode æ•£åˆ—ç ï¼Œequalsåˆ™hashCodeç›¸åŒï¼Œæ‰€ä»¥é‡å†™equalså¿…é¡»é‡å†™hashCode **finalize ** ç”¨äºåƒåœ¾å›æ”¶ä¹‹å‰åšçš„é—å˜±ï¼Œé»˜è®¤ç©ºï¼Œå­ç±»éœ€é‡å†™ clone æ·±æ‹·è´ï¼Œç±»éœ€å®ç°cloneableçš„æ¥å£ getClass åå°„è·å–å¯¹è±¡å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ç±»åã€æ–¹æ³•ã€ notifyã€wait ç”¨äºçº¿ç¨‹é€šçŸ¥å’Œå”¤é†’ åŸºæœ¬æ•°æ®ç±»å‹å’ŒåŒ…è£…ç±» ç±»å‹ ç¼“å­˜èŒƒå›´ Byte,Short,Integer,Long [-128, 127] Character [0, 127] Boolean [false, true] äºŒã€JVMç¯‡JVMå†…å­˜åˆ’åˆ†1ã€JVMè¿è¡Œæ—¶æ•°æ®åŒºåŸŸ å †ã€æ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰ã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€ç¨‹åºè®¡æ•°å™¨ Heap(å †)ï¼š å¯¹è±¡çš„å®ä¾‹ä»¥åŠæ•°ç»„çš„å†…å­˜éƒ½æ˜¯è¦åœ¨å †ä¸Šè¿›è¡Œåˆ†é…çš„ï¼Œå †æ˜¯çº¿ç¨‹å…±äº«çš„ä¸€å—åŒºåŸŸï¼Œç”¨æ¥å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œä¹Ÿæ˜¯åƒåœ¾å›æ”¶ï¼ˆGCï¼‰çš„ä¸»è¦åŒºåŸŸï¼›å¼€å¯é€ƒé€¸åˆ†æåï¼ŒæŸäº›æœªé€ƒé€¸çš„å¯¹è±¡å¯ä»¥é€šè¿‡æ ‡é‡æ›¿æ¢çš„æ–¹å¼åœ¨æ ˆä¸­åˆ†é… å †ç»†åˆ†ï¼šæ–°ç”Ÿä»£ã€è€å¹´ä»£ï¼Œå¯¹äºæ–°ç”Ÿä»£åˆåˆ†ä¸ºï¼šEdenåŒºå’ŒSurviver1å’ŒSurviver2åŒºï¼› æ–¹æ³•åŒºï¼š å¯¹äºJVMçš„æ–¹æ³•åŒºä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºæ°¸ä¹…åŒºï¼Œå®ƒå‚¨å­˜çš„æ˜¯å·²ç»è¢«javaè™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ï¼›Jdk1.8ä»¥åå–æ¶ˆäº†æ–¹æ³•åŒºè¿™ä¸ªæ¦‚å¿µï¼Œç§°ä¹‹ä¸ºå…ƒç©ºé—´ï¼ˆMetaSpaceï¼‰ï¼› å½“åº”ç”¨ä¸­çš„ Java ç±»è¿‡å¤šæ—¶ï¼Œæ¯”å¦‚ Spring ç­‰ä¸€äº›ä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ¡†æ¶ç”Ÿæˆäº†å¾ˆå¤šç±»ï¼Œå¦‚æœå ç”¨ç©ºé—´è¶…å‡ºäº†æˆ‘ä»¬çš„è®¾å®šå€¼ï¼Œå°±ä¼šå‘ç”Ÿå…ƒç©ºé—´æº¢å‡º è™šæ‹Ÿæœºæ ˆï¼š è™šæ‹Ÿæœºæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œä»–çš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€è‡´çš„ã€‚é‡Œé¢è£…çš„æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„æ ˆå¸§ï¼Œæ¯ä¸€ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ ˆå¸§ä¸­ç”¨æ¥å­˜æ”¾ï¼ˆå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆ ã€åŠ¨æ€é“¾æ¥ ã€è¿”å›åœ°å€ï¼‰ï¼›åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­ï¼Œå¯¹æ­¤åŒºåŸŸè§„å®šäº†ä¸¤ç§å¼‚å¸¸çŠ¶å†µï¼šå¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æ·±åº¦ï¼Œå°†ä¼šæŠ›å‡ºStackOverflowErrorå¼‚å¸¸ï¼›å¦‚æœè™šæ‹Ÿæœºæ ˆåŠ¨æ€æ‰©å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œå°±ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚ å±€éƒ¨å˜é‡è¡¨ï¼šå±€éƒ¨å˜é‡è¡¨æ˜¯ä¸€ç»„å˜é‡å€¼å­˜å‚¨ç©ºé—´ï¼Œç”¨æ¥å­˜æ”¾æ–¹æ³•å‚æ•°ã€æ–¹æ³•å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡ã€‚åº•å±‚æ˜¯å˜é‡æ§½ï¼ˆvariable slotï¼‰ æ“ä½œæ•°æ ˆï¼šæ˜¯ç”¨æ¥è®°å½•ä¸€ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå­—èŠ‚ç æŒ‡ä»¤å‘æ“ä½œæ•°æ ˆä¸­è¿›è¡Œå…¥æ ˆå’Œå‡ºæ ˆçš„è¿‡ç¨‹ã€‚å¤§å°åœ¨ç¼–è¯‘çš„æ—¶å€™å·²ç»ç¡®å®šäº†ï¼Œå½“ä¸€ä¸ªæ–¹æ³•åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œæ“ä½œæ•°æ ˆä¸­æ˜¯ç©ºå‘çš„ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¼šæœ‰å„ç§å­—èŠ‚ç æŒ‡ä»¤å¾€æ“ä½œæ•°æ ˆä¸­å…¥æ ˆå’Œå‡ºæ ˆã€‚ åŠ¨æ€é“¾æ¥ï¼šå› ä¸ºå­—èŠ‚ç æ–‡ä»¶ä¸­æœ‰å¾ˆå¤šç¬¦å·çš„å¼•ç”¨ï¼Œè¿™äº›ç¬¦å·å¼•ç”¨ä¸€éƒ¨åˆ†ä¼šåœ¨ç±»åŠ è½½çš„è§£æé˜¶æ®µæˆ–ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™è½¬åŒ–æˆç›´æ¥å¼•ç”¨ï¼Œè¿™ç§ç§°ä¸ºé™æ€è§£æï¼›å¦ä¸€éƒ¨åˆ†ä¼šåœ¨è¿è¡ŒæœŸé—´è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ï¼Œç§°ä¸ºåŠ¨æ€é“¾æ¥ã€‚ è¿”å›åœ°å€ï¼ˆreturnAddressï¼‰ï¼šç±»å‹ï¼ˆæŒ‡å‘äº†ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼‰ JITå³æ—¶ç¼–è¯‘å™¨ï¼ˆJust In Time Compilerï¼‰ï¼Œç®€ç§° JIT ç¼–è¯‘å™¨: ä¸ºäº†æé«˜çƒ­ç‚¹ä»£ç çš„æ‰§è¡Œæ•ˆç‡ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºå°†ä¼šæŠŠè¿™äº›ä»£ç ç¼–è¯‘æˆä¸æœ¬åœ°å¹³å°ç›¸å…³çš„æœºå™¨ç ï¼Œå¹¶è¿›è¡Œå„ç§å±‚æ¬¡çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚é”ç²—åŒ–ç­‰ æœ¬åœ°æ–¹æ³•æ ˆï¼š æœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯è™šæ‹Ÿæœºæ ˆæœåŠ¡çš„æ˜¯Javaæ–¹æ³•ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆæœåŠ¡çš„æ˜¯Nativeæ–¹æ³•ã€‚åœ¨HotSpotè™šæ‹Ÿæœºå®ç°ä¸­æ˜¯æŠŠæœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€çš„ï¼ŒåŒç†å®ƒä¹Ÿä¼šæŠ›å‡ºStackOverflowErrorå’ŒOOMå¼‚å¸¸ã€‚ PCç¨‹åºè®¡æ•°å™¨ï¼š PCï¼ŒæŒ‡çš„æ˜¯å­˜æ”¾ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®çš„ä¸€ä¸ªæŒ‡é’ˆã€‚å®ƒæ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œä¸”æ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚ç”±äºçº¿ç¨‹çš„åˆ‡æ¢ï¼ŒCPUåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦è®°ä½åŸçº¿ç¨‹çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½éœ€è¦æœ‰è‡ªå·±çš„PCã€‚ 2ã€å †å†…å­˜åˆ†é…ç­–ç•¥ å¯¹è±¡ä¼˜å…ˆåˆ†é…åœ¨EdenåŒºï¼Œå¦‚æœEdenåŒºæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºæ‰§è¡Œä¸€æ¬¡MinorGCã€‚è€Œé‚£äº›æ— éœ€å›æ”¶çš„å­˜æ´»å¯¹è±¡ï¼Œå°†ä¼šè¿›åˆ° Survivor çš„ From åŒºï¼ˆFrom åŒºå†…å­˜ä¸è¶³æ—¶ï¼Œç›´æ¥è¿›å…¥ Old åŒºï¼‰ã€‚ å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼ˆéœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼‰ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯é¿å…åœ¨EdenåŒºå’Œä¸¤ä¸ªSurvivoråŒºä¹‹é—´å‘ç”Ÿå¤§é‡çš„å†…å­˜æ‹·è´ï¼ˆæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•æ”¶é›†å†…å­˜ï¼‰ã€‚ é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£ã€‚è™šæ‹Ÿæœºä¸ºæ¯ä¸ªå¯¹è±¡å®šä¹‰äº†ä¸€ä¸ªå¹´é¾„ï¼ˆAge Countï¼‰è®¡æ•°å™¨ï¼Œå¦‚æœå¯¹è±¡ç»è¿‡äº†1æ¬¡Minor GCé‚£ä¹ˆå¯¹è±¡ä¼šè¿›å…¥SurvivoråŒºï¼Œä¹‹åæ¯ç»è¿‡ä¸€æ¬¡Minor GCé‚£ä¹ˆå¯¹è±¡çš„å¹´é¾„åŠ 1ï¼Œç›´åˆ°è¾¾åˆ°é˜€å€¼ï¼ˆé»˜è®¤15æ¬¡ï¼‰ï¼Œå¯¹è±¡è¿›å…¥è€å¹´åŒºã€‚ ï¼ˆåŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®šï¼šç¨‹åºä»å¹´é¾„æœ€å°çš„å¯¹è±¡å¼€å§‹ç´¯åŠ ï¼Œå¦‚æœç´¯åŠ çš„å¯¹è±¡å¤§å°ï¼Œå¤§äºå¹¸å­˜åŒºçš„ä¸€åŠï¼Œåˆ™å°†å½“å‰çš„å¯¹è±¡ age ä½œä¸ºæ–°çš„é˜ˆå€¼ï¼Œå¹´é¾„å¤§äºæ­¤é˜ˆå€¼çš„å¯¹è±¡åˆ™ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼‰ æ¯æ¬¡è¿›è¡ŒMinor GCæˆ–è€…å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´åŒºæ—¶ï¼ŒJVMä¼šè®¡ç®—æ‰€éœ€ç©ºé—´å¤§å°å¦‚å°äºè€å¹´åŒºçš„å‰©ä½™å€¼å¤§å°ï¼Œåˆ™è¿›è¡Œä¸€æ¬¡Full GCã€‚ 3ã€åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„æ­¥éª¤æ­¥éª¤ï¼šç±»åŠ è½½æ£€æŸ¥ã€åˆ†é…å†…å­˜ã€åˆå§‹åŒ–é›¶å€¼ã€è®¾ç½®å¯¹è±¡å¤´ã€æ‰§è¡Œinitæ–¹æ³• â‘ ç±»åŠ è½½æ£€æŸ¥ï¼š è™šæ‹Ÿæœºé‡åˆ° new æŒ‡ä»¤æ—¶ï¼Œâ¾¸å…ˆå»æ£€æŸ¥æ˜¯å¦èƒ½åœ¨å¸¸é‡æ± ä¸­å®šä½åˆ°è¿™ä¸ªç±»çš„ç¬¦å·å¼•â½¤ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•â½¤ä»£è¡¨çš„ç±»æ˜¯å¦å·²è¢«åŠ è½½è¿‡ã€è§£æå’Œåˆå§‹åŒ–è¿‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£å¿…é¡»å…ˆæ‰§â¾ç›¸åº”çš„ç±»åŠ è½½è¿‡ç¨‹ã€‚ â‘¡åˆ†é…å†…å­˜ï¼š åœ¨ç±»åŠ è½½æ£€æŸ¥é€šè¿‡åï¼Œæ¥ä¸‹æ¥è™šæ‹Ÿæœºå°†ä¸ºæ–°â½£å¯¹è±¡åˆ†é…å†…å­˜ï¼Œåˆ†é…â½…å¼æœ‰ â€œæŒ‡é’ˆç¢°æ’â€ å’Œ â€œç©ºé—²åˆ—è¡¨â€ ä¸¤ç§ï¼Œé€‰æ‹©é‚£ç§åˆ†é…â½…å¼ç”± Java å †æ˜¯å¦è§„æ•´å†³å®šï¼Œâ½½Javaå †æ˜¯å¦è§„æ•´â¼œç”±æ‰€é‡‡â½¤çš„åƒåœ¾æ”¶é›†å™¨æ˜¯å¦å¸¦æœ‰å‹ç¼©æ•´ç†åŠŸèƒ½å†³å®šã€‚ â‘¢åˆå§‹åŒ–é›¶å€¼ï¼š å†…å­˜åˆ†é…å®Œæˆåï¼Œè™šæ‹Ÿæœºéœ€è¦å°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´éƒ½åˆå§‹åŒ–ä¸ºé›¶å€¼ï¼Œè¿™â¼€æ­¥æ“ä½œä¿è¯äº†å¯¹è±¡çš„å®ä¾‹å­—æ®µåœ¨ Java ä»£ç ä¸­å¯ä»¥ä¸èµ‹åˆå§‹å€¼å°±ç›´æ¥ä½¿â½¤ï¼Œç¨‹åºèƒ½è®¿é—®åˆ°è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ‰€å¯¹åº”çš„é›¶å€¼ã€‚ â‘£è®¾ç½®å¯¹è±¡å¤´ï¼š åˆå§‹åŒ–é›¶å€¼å®Œæˆä¹‹åï¼Œè™šæ‹Ÿæœºè¦å¯¹å¯¹è±¡è¿›â¾å¿…è¦çš„è®¾ç½®ï¼Œä¾‹å¦‚è¿™ä¸ªå¯¹è±¡æ˜¯é‚£ä¸ªç±»çš„å®ä¾‹ã€å¦‚ä½•æ‰èƒ½æ‰¾åˆ°ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ã€å¯¹è±¡çš„å“ˆå¸Œå—ã€å¯¹è±¡çš„ GC åˆ†ä»£å¹´é¾„ç­‰ä¿¡æ¯ã€‚ è¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨å¯¹è±¡å¤´ä¸­ã€‚ å¦å¤–ï¼Œæ ¹æ®è™šæ‹Ÿæœºå½“å‰è¿â¾çŠ¶æ€çš„ä¸åŒï¼Œå¦‚æ˜¯å¦å¯â½¤åå‘é”ç­‰ï¼Œå¯¹è±¡å¤´ä¼šæœ‰ä¸åŒçš„è®¾ç½®â½…å¼ã€‚ â‘¤æ‰§â¾ init â½…æ³•ï¼š ä»è™šæ‹Ÿæœºçš„è§†â»†æ¥çœ‹ï¼Œâ¼€ä¸ªæ–°çš„å¯¹è±¡å·²ç»äº§â½£äº†ï¼Œä½†ä»Java ç¨‹åºçš„è§†â»†æ¥çœ‹ï¼Œ â½…æ³•è¿˜æ²¡æœ‰æ‰§â¾ï¼Œæ‰€æœ‰çš„å­—æ®µéƒ½è¿˜ä¸ºé›¶ã€‚æ‰€ä»¥â¼€èˆ¬æ¥è¯´ï¼ˆé™¤å¾ªç¯ä¾èµ–ï¼‰ï¼Œæ‰§â¾ new æŒ‡ä»¤ä¹‹åä¼šæ¥ç€æ‰§â¾ â½…æ³•ï¼Œè¿™æ ·â¼€ä¸ªçœŸæ­£å¯â½¤çš„å¯¹è±¡æ‰ç®—äº§â½£å‡ºæ¥ã€‚ 4ã€å¯¹è±¡å¼•ç”¨æ™®é€šçš„å¯¹è±¡å¼•ç”¨å…³ç³»å°±æ˜¯å¼ºå¼•ç”¨ã€‚ è½¯å¼•ç”¨ç”¨äºç»´æŠ¤ä¸€äº›å¯æœ‰å¯æ— çš„å¯¹è±¡ã€‚åªæœ‰åœ¨å†…å­˜ä¸è¶³æ—¶ï¼Œç³»ç»Ÿåˆ™ä¼šå›æ”¶è½¯å¼•ç”¨å¯¹è±¡ï¼Œå¦‚æœå›æ”¶äº†è½¯å¼•ç”¨å¯¹è±¡ä¹‹åä»ç„¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚ å¼±å¼•ç”¨å¯¹è±¡ç›¸æ¯”è½¯å¼•ç”¨æ¥è¯´ï¼Œè¦æ›´åŠ æ— ç”¨ä¸€äº›ï¼Œå®ƒæ‹¥æœ‰æ›´çŸ­çš„ç”Ÿå‘½å‘¨æœŸï¼Œå½“ JVM è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œæ— è®ºå†…å­˜æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚ è™šå¼•ç”¨æ˜¯ä¸€ç§å½¢åŒè™šè®¾çš„å¼•ç”¨ï¼Œåœ¨ç°å®åœºæ™¯ä¸­ç”¨çš„ä¸æ˜¯å¾ˆå¤šï¼Œå®ƒä¸»è¦ç”¨æ¥è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ´»åŠ¨ã€‚ JVMç±»åŠ è½½è¿‡ç¨‹è¿‡ç¨‹ï¼šåŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æã€åˆå§‹åŒ– åŠ è½½é˜¶æ®µï¼š 1.é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµã€‚ 2.å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ã€‚ 3.åœ¨Javaå †ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™äº›æ•°æ®çš„è®¿é—®å…¥å£ã€‚ éªŒè¯é˜¶æ®µï¼š 1.æ–‡ä»¶æ ¼å¼éªŒè¯ï¼ˆæ˜¯å¦ç¬¦åˆClassæ–‡ä»¶æ ¼å¼çš„è§„èŒƒï¼Œå¹¶ä¸”èƒ½è¢«å½“å‰ç‰ˆæœ¬çš„è™šæ‹Ÿæœºå¤„ç†ï¼‰ 2.å…ƒæ•°æ®éªŒè¯ï¼ˆå¯¹å­—èŠ‚ç æè¿°çš„ä¿¡æ¯è¿›è¡Œè¯­æ„åˆ†æï¼Œä»¥ä¿è¯å…¶æè¿°çš„ä¿¡æ¯ç¬¦åˆJavaè¯­è¨€è§„èŒƒè¦æ±‚ï¼‰ 3.å­—èŠ‚ç éªŒè¯ï¼ˆä¿è¯è¢«æ ¡éªŒç±»çš„æ–¹æ³•åœ¨è¿è¡Œæ—¶ä¸ä¼šåšå‡ºå±å®³è™šæ‹Ÿæœºå®‰å…¨çš„è¡Œä¸ºï¼‰ 4.ç¬¦å·å¼•ç”¨éªŒè¯ï¼ˆè™šæ‹Ÿæœºå°†ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨æ—¶ï¼Œè§£æé˜¶æ®µä¸­å‘ç”Ÿï¼‰ å‡†å¤‡é˜¶æ®µï¼š å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼çš„é˜¶æ®µã€‚å°†å¯¹è±¡åˆå§‹åŒ–ä¸ºâ€œé›¶â€å€¼ è§£æé˜¶æ®µï¼š è§£æé˜¶æ®µæ—¶è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚ å­—ç¬¦ä¸²å¸¸é‡æ± ï¼šå †ä¸Šï¼Œé»˜è®¤classæ–‡ä»¶çš„é™æ€å¸¸é‡æ±  è¿è¡Œæ—¶å¸¸é‡æ± ï¼šåœ¨æ–¹æ³•åŒºï¼Œå±äºå…ƒç©ºé—´ åˆå§‹åŒ–é˜¶æ®µï¼š åˆå§‹åŒ–é˜¶æ®µæ—¶åŠ è½½è¿‡ç¨‹çš„æœ€åä¸€æ­¥ï¼Œè€Œè¿™ä¸€é˜¶æ®µä¹Ÿæ˜¯çœŸæ­£æ„ä¹‰ä¸Šå¼€å§‹æ‰§è¡Œç±»ä¸­å®šä¹‰çš„Javaç¨‹åºä»£ç ã€‚ 1ã€åŒäº²å§”æ´¾æœºåˆ¶ æ¯â¼€ä¸ªç±»éƒ½æœ‰â¼€ä¸ªå¯¹åº”å®ƒçš„ç±»åŠ è½½å™¨ã€‚ç³»ç»Ÿä¸­çš„ ClassLoder åœ¨ååŒâ¼¯ä½œçš„æ—¶å€™ä¼šé»˜è®¤ä½¿â½¤ åŒäº²å§”æ´¾æ¨¡å‹ ã€‚å³åœ¨ç±»åŠ è½½çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šâ¾¸å…ˆåˆ¤æ–­å½“å‰ç±»æ˜¯å¦è¢«åŠ è½½è¿‡ã€‚å·²ç»è¢«åŠ è½½çš„ç±»ä¼šç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰ä¼šå°è¯•åŠ è½½ã€‚åŠ è½½çš„æ—¶å€™ï¼Œâ¾¸å…ˆä¼šæŠŠè¯¥è¯·æ±‚å§”æ´¾è¯¥â½—ç±»åŠ è½½å™¨çš„ loadClass() å¤„ç†ï¼Œå› æ­¤æ‰€æœ‰çš„è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ BootstrapClassLoader ä¸­ã€‚å½“â½—ç±»åŠ è½½å™¨â½†æ³•å¤„ç†æ—¶ï¼Œæ‰ç”±â¾ƒâ¼°æ¥å¤„ç†ã€‚å½“â½—ç±»åŠ è½½å™¨ä¸ºnullæ—¶ï¼Œä¼šä½¿â½¤å¯åŠ¨ç±»åŠ è½½å™¨ BootstrapClassLoader ä½œä¸ºâ½—ç±»åŠ è½½å™¨ã€‚ ä½¿ç”¨å¥½å¤„ï¼š æ­¤æœºåˆ¶ä¿è¯JDKæ ¸å¿ƒç±»çš„ä¼˜å…ˆåŠ è½½ï¼›ä½¿å¾—Javaç¨‹åºçš„ç¨³å®šè¿â¾ï¼Œå¯ä»¥é¿å…ç±»çš„é‡å¤åŠ è½½ï¼Œä¹Ÿä¿è¯äº† Java çš„æ ¸â¼¼ API ä¸è¢«ç¯¡æ”¹ã€‚å¦‚æœä¸â½¤æ²¡æœ‰ä½¿â½¤åŒäº²å§”æ´¾æ¨¡å‹ï¼Œâ½½æ˜¯æ¯ä¸ªç±»åŠ è½½å™¨åŠ è½½â¾ƒâ¼°çš„è¯å°±ä¼šå‡ºç°â¼€äº›é—®é¢˜ï¼Œâ½å¦‚æˆ‘ä»¬ç¼–å†™â¼€ä¸ªç§°ä¸º java.lang.Object ç±»çš„è¯ï¼Œé‚£ä¹ˆç¨‹åºè¿â¾çš„æ—¶å€™ï¼Œç³»ç»Ÿå°±ä¼šå‡ºç°å¤šä¸ªä¸åŒçš„Object ç±»ã€‚ ç ´ååŒäº²å§”æ´¾æœºåˆ¶ï¼š å¯ä»¥â¾ƒâ¼°å®šä¹‰â¼€ä¸ªç±»åŠ è½½å™¨ï¼Œé‡å†™loadClassæ–¹æ³•ï¼› Tomcat å¯ä»¥åŠ è½½è‡ªå·±ç›®å½•ä¸‹çš„ class æ–‡ä»¶ï¼Œå¹¶ä¸ä¼šä¼ é€’ç»™çˆ¶ç±»çš„åŠ è½½å™¨ï¼› Java çš„ SPIï¼Œå‘èµ·è€… BootstrapClassLoader å·²ç»æ˜¯æœ€ä¸Šå±‚äº†ï¼Œå®ƒç›´æ¥è·å–äº† AppClassLoader è¿›è¡Œé©±åŠ¨åŠ è½½ï¼Œå’ŒåŒäº²å§”æ´¾æ˜¯ç›¸åçš„ã€‚ 2ã€tomcatçš„ç±»åŠ è½½æœºåˆ¶æ­¥éª¤ï¼š å…ˆåœ¨æœ¬åœ°cacheæŸ¥æ‰¾è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œçœ‹çœ‹ Tomcat æœ‰æ²¡æœ‰åŠ è½½è¿‡è¿™ä¸ªç±»ã€‚ å¦‚æœTomcat æ²¡æœ‰åŠ è½½è¿‡è¿™ä¸ªç±»ï¼Œåˆ™ä»ç³»ç»Ÿç±»åŠ è½½å™¨çš„cacheä¸­æŸ¥æ‰¾æ˜¯å¦åŠ è½½è¿‡ã€‚ å¦‚æœæ²¡æœ‰åŠ è½½è¿‡è¿™ä¸ªç±»ï¼Œå°è¯•ç”¨ExtClassLoaderç±»åŠ è½½å™¨ç±»åŠ è½½ï¼Œé‡ç‚¹æ¥äº†ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰é¦–å…ˆä½¿ç”¨ AppClassLoader æ¥åŠ è½½ç±»ã€‚è¿™ä¸ªTomcat çš„ WebAPPClassLoader è¿èƒŒäº†åŒäº²å§”æ´¾æœºåˆ¶ï¼Œç›´æ¥ä½¿ç”¨äº† ExtClassLoaderæ¥åŠ è½½ç±»ã€‚è¿™é‡Œæ³¨æ„ ExtClassLoader åŒäº²å§”æ´¾ä¾ç„¶æœ‰æ•ˆï¼ŒExtClassLoader å°±ä¼šä½¿ç”¨ Bootstrap ClassLoader æ¥å¯¹ç±»è¿›è¡ŒåŠ è½½ï¼Œä¿è¯äº† Jre é‡Œé¢çš„æ ¸å¿ƒç±»ä¸ä¼šè¢«é‡å¤åŠ è½½ã€‚ æ¯”å¦‚åœ¨ Web ä¸­åŠ è½½ä¸€ä¸ª Object ç±»ã€‚WebAppClassLoader â†’ ExtClassLoader â†’ Bootstrap ClassLoaderï¼Œè¿™ä¸ªåŠ è½½é“¾ï¼Œå°±ä¿è¯äº† Object ä¸ä¼šè¢«é‡å¤åŠ è½½ã€‚ å¦‚æœ BoostrapClassLoaderï¼Œæ²¡æœ‰åŠ è½½æˆåŠŸï¼Œå°±ä¼šè°ƒç”¨è‡ªå·±çš„ findClass æ–¹æ³•ç”±è‡ªå·±æ¥å¯¹ç±»è¿›è¡ŒåŠ è½½ï¼ŒfindClass åŠ è½½ç±»çš„åœ°å€æ˜¯è‡ªå·±æœ¬ web åº”ç”¨ä¸‹çš„ classã€‚ åŠ è½½ä¾ç„¶å¤±è´¥ï¼Œæ‰ä½¿ç”¨ AppClassLoader ç»§ç»­åŠ è½½ã€‚ éƒ½æ²¡æœ‰åŠ è½½æˆåŠŸçš„è¯ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚ æ€»ç»“ä¸€ä¸‹ä»¥ä¸Šæ­¥éª¤ï¼ŒWebAppClassLoader åŠ è½½ç±»çš„æ—¶å€™ï¼Œæ•…æ„æ‰“ç ´äº†JVM åŒäº²å§”æ´¾æœºåˆ¶ï¼Œç»•å¼€äº† AppClassLoaderï¼Œç›´æ¥å…ˆä½¿ç”¨ ExtClassLoader æ¥åŠ è½½ç±»ã€‚ JVMåƒåœ¾å›æ”¶1ã€å­˜æ´»ç®—æ³•å’Œä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹å¼•ç”¨è®¡æ•°æ³•ï¼š ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“ç”±ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒæ—¶ï¼Œè®¡æ•°å™¨å€¼å°±åŠ 1ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨å€¼å°±å‡1ï¼›ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨ä¸º0çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚ ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œåˆ¤å®šæ•ˆç‡ä¹Ÿå¾ˆé«˜ ç¼ºç‚¹ï¼šä»–å¾ˆéš¾è§£å†³å¯¹è±¡ä¹‹é—´ç›¸äº’å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼ŒåŸºæœ¬ä¸Šè¢«æŠ›å¼ƒ å¯è¾¾æ€§åˆ†ææ³•ï¼š é€šè¿‡ä¸€ç³»åˆ—çš„æˆä¸ºâ€œGC Rootsâ€(æ´»åŠ¨çº¿ç¨‹ç›¸å…³çš„å„ç§å¼•ç”¨ï¼Œè™šæ‹Ÿæœºæ ˆå¸§å¼•ç”¨ï¼Œé™æ€å˜é‡å¼•ç”¨ï¼ŒJNIå¼•ç”¨)çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹ReferenceChainså¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„æˆä¸ºå¼•ç”¨é“¾ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ°GC ROOTSæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ—¶ä¸å¯ç”¨çš„ï¼› ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹ï¼š å¯¹è±¡è¢«å›æ”¶ä¹‹å‰ï¼Œè¯¥å¯¹è±¡çš„finalize()æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼›ä¸¤æ¬¡æ ‡è®°ï¼Œå³ç¬¬ä¸€æ¬¡æ ‡è®°ä¸åœ¨â€œå…³ç³»ç½‘â€ä¸­çš„å¯¹è±¡ã€‚ç¬¬äºŒæ¬¡çš„è¯å°±è¦å…ˆåˆ¤æ–­è¯¥å¯¹è±¡æœ‰æ²¡æœ‰å®ç°finalize()æ–¹æ³•äº†ï¼Œå¦‚æœæ²¡æœ‰å®ç°å°±ç›´æ¥åˆ¤æ–­è¯¥å¯¹è±¡å¯å›æ”¶ï¼›å¦‚æœå®ç°äº†å°±ä¼šå…ˆæ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¹¶ç”±è™šæ‹Ÿæœºå»ºç«‹çš„ä¸€ä¸ªä½ä¼˜å…ˆçº§çš„çº¿ç¨‹å»æ‰§è¡Œå®ƒï¼Œéšåå°±ä¼šè¿›è¡Œç¬¬äºŒæ¬¡çš„å°è§„æ¨¡æ ‡è®°ï¼Œåœ¨è¿™æ¬¡è¢«æ ‡è®°çš„å¯¹è±¡å°±ä¼šçœŸæ­£çš„è¢«å›æ”¶äº†ã€‚ 2ã€åƒåœ¾å›æ”¶ç®—æ³•åƒåœ¾å›æ”¶ç®—æ³•ï¼šå¤åˆ¶ç®—æ³•ã€æ ‡è®°æ¸…é™¤ã€æ ‡è®°æ•´ç†ã€åˆ†ä»£æ”¶é›† å¤åˆ¶ç®—æ³•ï¼š(young) å°†å†…å­˜åˆ†ä¸ºâ¼¤â¼©ç›¸åŒçš„ä¸¤å—ï¼Œæ¯æ¬¡ä½¿â½¤å…¶ä¸­çš„â¼€å—ã€‚å½“è¿™â¼€å—çš„å†…å­˜ä½¿â½¤å®Œåï¼Œå°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦â¼€å—å»ï¼Œç„¶åå†æŠŠä½¿â½¤çš„ç©ºé—´â¼€æ¬¡æ¸…ç†æ‰ã€‚è¿™æ ·å°±ä½¿æ¯æ¬¡çš„å†…å­˜å›æ”¶éƒ½æ˜¯å¯¹å†…å­˜åŒºé—´çš„â¼€åŠè¿›â¾å›æ”¶ï¼› ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œå†…å­˜æ•ˆç‡é«˜ï¼Œä¸æ˜“äº§ç”Ÿç¢ç‰‡ ç¼ºç‚¹ï¼šå†…å­˜å‹ç¼©äº†ä¸€åŠï¼Œå€˜è‹¥å­˜æ´»å¯¹è±¡å¤šï¼ŒCopying ç®—æ³•çš„æ•ˆç‡ä¼šå¤§å¤§é™ä½ æ ‡è®°æ¸…é™¤ï¼š(cms) æ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåç»Ÿâ¼€å›æ”¶æ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ ç¼ºç‚¹ï¼šæ•ˆç‡ä½ï¼Œæ ‡è®°æ¸…é™¤åä¼šäº§â½£â¼¤é‡ä¸è¿ç»­çš„ç¢â½šï¼Œéœ€è¦é¢„ç•™ç©ºé—´ç»™åˆ†é…é˜¶æ®µçš„æµ®åŠ¨åƒåœ¾ æ ‡è®°æ•´ç†ï¼š(old) æ ‡è®°è¿‡ç¨‹ä»ç„¶ä¸â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•â¼€æ ·ï¼Œå†è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡å‘â¼€ç«¯ç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰ç«¯è¾¹ç•Œä»¥å¤–çš„å†…å­˜ï¼›è§£å†³äº†äº§ç”Ÿå¤§é‡ä¸è¿ç»­ç¢ç‰‡é—®é¢˜ åˆ†ä»£æ”¶é›†ï¼š æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†ç®—æ³•ã€‚ æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œæ–°ç”Ÿä»£æ¯æ¬¡åƒåœ¾å›æ”¶éƒ½è¦å›æ”¶å¤§éƒ¨åˆ†å¯¹è±¡ï¼Œå­˜æ´»å¯¹è±¡è¾ƒå°‘ï¼Œå³è¦å¤åˆ¶çš„æ“ä½œæ¯”è¾ƒå°‘ï¼Œä¸€èˆ¬å°†æ–°ç”Ÿä»£åˆ’åˆ†ä¸ºä¸€å—è¾ƒå¤§çš„ Eden ç©ºé—´å’Œä¸¤ä¸ªè¾ƒå°çš„ Survivor ç©ºé—´(From Space, To Space)ï¼Œæ¯æ¬¡ä½¿ç”¨Eden ç©ºé—´å’Œå…¶ä¸­çš„ä¸€å— Survivor ç©ºé—´ï¼Œå½“è¿›è¡Œå›æ”¶æ—¶ï¼Œå°†è¯¥ä¸¤å—ç©ºé—´ä¸­è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å— Survivor ç©ºé—´ä¸­ã€‚ è€å¹´ä»£çš„å¯¹è±¡å­˜æ´»â¼ç‡æ˜¯â½è¾ƒâ¾¼çš„ï¼Œâ½½ä¸”æ²¡æœ‰é¢å¤–çš„ç©ºé—´å¯¹å®ƒè¿›â¾åˆ†é…æ‹…ä¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»é€‰æ‹©â€œæ ‡è®°-æ¸…é™¤â€æˆ–â€œæ ‡è®°-æ•´ç†â€ç®—æ³•è¿›â¾åƒåœ¾æ”¶é›†ã€‚ Safepoint å½“å‘ç”Ÿ GC æ—¶ï¼Œç”¨æˆ·çº¿ç¨‹å¿…é¡»å…¨éƒ¨åœä¸‹æ¥ï¼Œæ‰å¯ä»¥è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œè¿™ä¸ªçŠ¶æ€æˆ‘ä»¬å¯ä»¥è®¤ä¸º JVM æ˜¯å®‰å…¨çš„ï¼ˆsafeï¼‰ï¼Œæ•´ä¸ªå †çš„çŠ¶æ€æ˜¯ç¨³å®šçš„ã€‚å¦‚æœåœ¨ GC å‰ï¼Œæœ‰çº¿ç¨‹è¿Ÿè¿Ÿè¿›å…¥ä¸äº† safepointï¼Œé‚£ä¹ˆæ•´ä¸ª JVM éƒ½åœ¨ç­‰å¾…è¿™ä¸ªé˜»å¡çš„çº¿ç¨‹ï¼Œé€ æˆäº†æ•´ä½“ GC çš„æ—¶é—´å˜é•¿ MinorGCã€MajorGCã€FullGCMinorGC åœ¨å¹´è½»ä»£ç©ºé—´ä¸è¶³çš„æ—¶å€™å‘ç”Ÿï¼Œ MajorGC æŒ‡çš„æ˜¯è€å¹´ä»£çš„ GCï¼Œå‡ºç° MajorGC ä¸€èˆ¬ç»å¸¸ä¼´æœ‰ MinorGCã€‚ FullGC 1ã€å½“è€å¹´ä»£æ— æ³•å†åˆ†é…å†…å­˜çš„æ—¶å€™ï¼›2ã€å…ƒç©ºé—´ä¸è¶³çš„æ—¶å€™ï¼›3ã€æ˜¾ç¤ºè°ƒç”¨ System.gc çš„æ—¶å€™ã€‚å¦å¤–ï¼Œåƒ CMS ä¸€ç±»çš„åƒåœ¾å›æ”¶å™¨ï¼Œåœ¨ MinorGC å‡ºç° promotion failure çš„æ—¶å€™ä¹Ÿä¼šå‘ç”Ÿ FullGCã€‚ å¯¹è±¡ä¼˜å…ˆåœ¨ Eden åŒºåˆ†é…å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡åœ¨æ–°ç”Ÿä»£ Eden åŒºåˆ†é…ï¼Œå½“ Eden åŒºç©ºé—´ä¸å¤Ÿæ—¶ï¼Œå‘èµ· Minor GCã€‚ å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£å¤§å¯¹è±¡æ˜¯æŒ‡éœ€è¦è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼Œæ¯”å¦‚å¾ˆé•¿çš„å­—ç¬¦ä¸²ä»¥åŠæ•°ç»„ã€‚è€å¹´ä»£ç›´æ¥åˆ†é…çš„ç›®çš„æ˜¯é¿å…åœ¨ Eden åŒºå’Œ Survivor åŒºä¹‹é—´å‡ºç°å¤§é‡å†…å­˜å¤åˆ¶ã€‚ é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£è™šæ‹Ÿæœºç»™æ¯ä¸ªå¯¹è±¡å®šä¹‰äº†å¹´é¾„è®¡æ•°å™¨ï¼Œå¯¹è±¡åœ¨ Eden åŒºå‡ºç”Ÿä¹‹åï¼Œå¦‚æœç»è¿‡ä¸€æ¬¡ Minor GC ä¹‹åï¼Œå°†è¿›å…¥ Survivor åŒºï¼ŒåŒæ—¶å¯¹è±¡å¹´é¾„å˜ä¸º 1ï¼Œå¢åŠ åˆ°ä¸€å®šé˜ˆå€¼æ—¶åˆ™è¿›å…¥è€å¹´ä»£ï¼ˆé˜ˆå€¼é»˜è®¤ä¸º 15ï¼‰ åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®šä¸ºäº†èƒ½æ›´å¥½åœ°é€‚åº”ä¸åŒç¨‹åºçš„å†…å­˜çŠ¶å†µï¼Œè™šæ‹Ÿæœºå¹¶ä¸æ€»æ˜¯è¦æ±‚å¯¹è±¡çš„å¹´é¾„å¿…é¡»è¾¾åˆ°é˜ˆå€¼æ‰èƒ½è¿›å…¥è€å¹´ä»£ã€‚å¦‚æœåœ¨ Survivor åŒºä¸­ç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡çš„ç©ºé—´æ€»å’Œå¤§äº Survivor åŒºç©ºé—´çš„ä¸€åŠï¼Œåˆ™å¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚ ç©ºé—´åˆ†é…æ‹…ä¿åœ¨å‘ç”Ÿ Minor GC ä¹‹å‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆæ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡çš„ç©ºé—´æ€»å’Œï¼Œå¦‚æœè¿™ä¸ªæ¡ä»¶æˆç«‹ï¼Œé‚£ä¹ˆ Minor GC å¯ä»¥ç¡®ä¿æ˜¯å®‰å…¨çš„ã€‚å¦‚æœä¸æˆç«‹åˆ™è¿›è¡Œ Full GCã€‚ 3ã€åƒåœ¾æ”¶é›†å™¨ JDK3ï¼šSerial Parnew å…³æ³¨æ•ˆç‡ Serialï¼š Serial æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ”¶é›†å™¨ï¼Œå®ƒä¸ä½†åªä¼šä½¿ç”¨ä¸€ä¸ª CPU æˆ–ä¸€æ¡çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œå¹¶ä¸”åœ¨è¿›è¡Œåƒåœ¾æ”¶é›†çš„åŒæ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œç›´åˆ°åƒåœ¾æ”¶é›†ç»“æŸã€‚é€‚åˆç”¨äºå®¢æˆ·ç«¯åƒåœ¾æ”¶é›†å™¨ã€‚ Parnewï¼š ParNew åƒåœ¾æ”¶é›†å™¨å…¶å®æ˜¯ Serial æ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œä¹Ÿä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œé™¤äº†ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†ä¹‹å¤–ï¼Œå…¶ä½™çš„è¡Œä¸ºå’Œ Serial æ”¶é›†å™¨å®Œå…¨ä¸€æ ·ï¼ŒParNew åƒåœ¾æ”¶é›†å™¨åœ¨åƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­åŒæ ·ä¹Ÿè¦æš‚åœæ‰€æœ‰å…¶ä»–çš„å·¥ä½œçº¿ç¨‹ã€‚ JDK5ï¼šparallel Scavenge+ï¼ˆSerial old/parallel oldï¼‰å…³æ³¨ååé‡ parallel Scavengeï¼š(å…³æ³¨ååé‡) Parallel Scavengeæ”¶é›†å™¨å…³æ³¨ç‚¹æ˜¯ååé‡ï¼ˆâ¾¼æ•ˆç‡çš„åˆ©â½¤CPUï¼‰ã€‚CMSç­‰åƒåœ¾æ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ›´å¤šçš„æ˜¯â½¤æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼ˆæâ¾¼â½¤æˆ·ä½“éªŒï¼‰ï¼›é«˜ååé‡å¯ä»¥æœ€é«˜æ•ˆç‡åœ°åˆ©ç”¨ CPU æ—¶é—´ï¼Œå°½å¿«åœ°å®Œæˆç¨‹åºçš„è¿ç®—ä»»åŠ¡ï¼Œä¸»è¦é€‚ç”¨äºåœ¨åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„ä»»åŠ¡ã€‚ Serial oldï¼š Serialæ”¶é›†å™¨çš„â½¼å¹´ä»£ç‰ˆæœ¬ï¼Œå®ƒåŒæ ·æ˜¯â¼€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨ï¼Œä½¿ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚ä¸»è¦æœ‰ä¸¤ä¸ªç”¨é€”ï¼š åœ¨ JDK1.5 ä¹‹å‰ç‰ˆæœ¬ä¸­ä¸æ–°ç”Ÿä»£çš„ Parallel Scavenge æ”¶é›†å™¨æ­é…ä½¿ç”¨ã€‚ ä½œä¸ºå¹´è€ä»£ä¸­ä½¿ç”¨ CMS æ”¶é›†å™¨çš„åå¤‡åƒåœ¾æ”¶é›†æ–¹æ¡ˆã€‚ parallel oldï¼š Parallel Scavengeæ”¶é›†å™¨çš„â½¼å¹´ä»£ç‰ˆæœ¬ã€‚ä½¿â½¤å¤šçº¿ç¨‹å’Œâ€œæ ‡è®°-æ•´ç†â€ç®—æ³•ã€‚ JDK8-CMSï¼šï¼ˆå…³æ³¨æœ€çŸ­åƒåœ¾å›æ”¶åœé¡¿æ—¶é—´ï¼‰ CMSæ”¶é›†å™¨æ˜¯ä¸€ç§å¹´è€ä»£åƒåœ¾æ”¶é›†å™¨ï¼Œå…¶æœ€ä¸»è¦ç›®æ ‡æ˜¯è·å–æœ€çŸ­åƒåœ¾å›æ”¶åœé¡¿æ—¶é—´ï¼Œå’Œå…¶ä»–å¹´è€ä»£ä½¿ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ä¸åŒï¼Œå®ƒä½¿ç”¨å¤šçº¿ç¨‹çš„æ ‡è®°-æ¸…é™¤ç®—æ³•ã€‚æœ€çŸ­çš„åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´å¯ä»¥ä¸ºäº¤äº’æ¯”è¾ƒé«˜çš„ç¨‹åºæé«˜ç”¨æˆ·ä½“éªŒã€‚CMS å·¥ä½œæœºåˆ¶ç›¸æ¯”å…¶ä»–çš„åƒåœ¾æ”¶é›†å™¨æ¥è¯´æ›´å¤æ‚ï¼Œæ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºä»¥ä¸‹ 4 ä¸ªé˜¶æ®µï¼š åˆå§‹æ ‡è®°ï¼šåªæ˜¯æ ‡è®°ä¸€ä¸‹ GC Roots èƒ½ç›´æ¥å…³è”çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼ŒSTWã€‚ å¹¶å‘æ ‡è®°ï¼šè¿›è¡Œ ReferenceChainsè·Ÿè¸ªçš„è¿‡ç¨‹ï¼Œå’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·å·¥ä½œï¼Œä¸éœ€è¦æš‚åœå·¥ä½œçº¿ç¨‹ã€‚ é‡æ–°æ ‡è®°ï¼šä¸ºäº†ä¿®æ­£åœ¨å¹¶å‘æ ‡è®°æœŸé—´ï¼Œå› ç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼ŒSTWã€‚ å¹¶å‘æ¸…é™¤ï¼šæ¸…é™¤ GC Roots ä¸å¯è¾¾å¯¹è±¡ï¼Œå’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·å·¥ä½œï¼Œä¸éœ€è¦æš‚åœå·¥ä½œçº¿ç¨‹ã€‚ ç”±äºè€—æ—¶æœ€é•¿çš„å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…é™¤è¿‡ç¨‹ä¸­ï¼Œåƒåœ¾æ”¶é›†çº¿ç¨‹å¯ä»¥å’Œç”¨æˆ·ç°åœ¨ä¸€èµ·å¹¶å‘å·¥ä½œï¼Œæ‰€ä»¥æ€»ä½“ä¸Šæ¥çœ‹CMS æ”¶é›†å™¨çš„å†…å­˜å›æ”¶å’Œç”¨æˆ·çº¿ç¨‹æ˜¯ä¸€èµ·å¹¶å‘åœ°æ‰§è¡Œã€‚ ä¼˜ç‚¹ï¼šå¹¶å‘æ”¶é›†ã€ä½åœé¡¿ ç¼ºç‚¹ï¼šå¯¹CPUèµ„æºæ•æ„Ÿï¼›â½†æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ï¼›ä½¿â½¤â€œæ ‡è®°æ¸…é™¤â€ç®—æ³•ï¼Œä¼šå¯¼è‡´â¼¤é‡ç©ºé—´ç¢â½šäº§â½£ã€‚ JDK9-G1ï¼šï¼ˆç²¾å‡†æ§åˆ¶åœé¡¿æ—¶é—´ï¼Œé¿å…åƒåœ¾ç¢ç‰‡ï¼‰ æ˜¯â¼€æ¬¾â¾¯å‘æœåŠ¡å™¨çš„åƒåœ¾æ”¶é›†å™¨,ä¸»è¦é’ˆå¯¹é…å¤‡å¤šé¢—å¤„ç†å™¨åŠâ¼¤å®¹é‡å†…å­˜çš„æœºå™¨.ä»¥æâ¾¼æ¦‚ç‡æ»¡â¾œGCåœé¡¿æ—¶é—´è¦æ±‚çš„åŒæ—¶,è¿˜å…·å¤‡â¾¼ååé‡æ€§èƒ½ç‰¹å¾ï¼›ç›¸æ¯”ä¸ CMS æ”¶é›†å™¨ï¼ŒG1 æ”¶é›†å™¨ä¸¤ä¸ªæœ€çªå‡ºçš„æ”¹è¿›æ˜¯ï¼š ã€1ã€‘åŸºäºæ ‡è®°-æ•´ç†ç®—æ³•ï¼Œä¸äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚ ã€2ã€‘å¯ä»¥éå¸¸ç²¾ç¡®æ§åˆ¶åœé¡¿æ—¶é—´ï¼Œåœ¨ä¸ç‰ºç‰²ååé‡å‰æä¸‹ï¼Œå®ç°ä½åœé¡¿åƒåœ¾å›æ”¶ã€‚ G1 æ”¶é›†å™¨é¿å…å…¨åŒºåŸŸåƒåœ¾æ”¶é›†ï¼Œå®ƒæŠŠå †å†…å­˜åˆ’åˆ†ä¸ºå¤§å°å›ºå®šçš„å‡ ä¸ªç‹¬ç«‹åŒºåŸŸï¼Œå¹¶ä¸”è·Ÿè¸ªè¿™äº›åŒºåŸŸçš„åƒåœ¾æ”¶é›†è¿›åº¦ï¼ŒåŒæ—¶åœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆçº§åˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®æ‰€å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶åƒåœ¾æœ€å¤šçš„åŒºåŸŸã€‚åŒºåŸŸåˆ’åˆ†å’Œä¼˜å…ˆçº§åŒºåŸŸå›æ”¶æœºåˆ¶ï¼Œç¡®ä¿ G1 æ”¶é›†å™¨å¯ä»¥åœ¨æœ‰é™æ—¶é—´è·å¾—æœ€é«˜çš„åƒåœ¾æ”¶é›†æ•ˆç‡ã€‚ åˆå§‹æ ‡è®°ï¼šStop The Worldï¼Œä»…ä½¿ç”¨ä¸€æ¡åˆå§‹æ ‡è®°çº¿ç¨‹å¯¹GC Rootså…³è”çš„å¯¹è±¡è¿›è¡Œæ ‡è®° å¹¶å‘æ ‡è®°ï¼šä½¿ç”¨ä¸€æ¡æ ‡è®°çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚æ­¤è¿‡ç¨‹è¿›è¡Œå¯è¾¾æ€§åˆ†æï¼Œé€Ÿåº¦å¾ˆæ…¢ æœ€ç»ˆæ ‡è®°ï¼šStop The Worldï¼Œä½¿ç”¨å¤šæ¡æ ‡è®°çº¿ç¨‹å¹¶å‘æ‰§è¡Œ ç­›é€‰å›æ”¶ï¼šå›æ”¶åºŸå¼ƒå¯¹è±¡ï¼Œæ­¤æ—¶ä¹Ÿè¦ Stop The Worldï¼Œå¹¶ä½¿ç”¨å¤šæ¡ç­›é€‰å›æ”¶çº¿ç¨‹å¹¶å‘æ‰§è¡Œ **JDK11-ZGC:**ï¼ˆåœ¨ä¸å…³æ³¨å®¹é‡çš„æƒ…å†µè·å–æœ€å°åœé¡¿æ—¶é—´5TB/10msï¼‰ ç€è‰²ç¬”æŠ€æœ¯ï¼šåŠ å¿«æ ‡è®°è¿‡ç¨‹ è¯»å±éšœï¼šè§£å†³GCå’Œåº”ç”¨ä¹‹é—´å¹¶å‘å¯¼è‡´çš„STWé—®é¢˜ æ”¯æŒ TB çº§å †å†…å­˜ï¼ˆæœ€å¤§ 4Tï¼Œ JDK13 æœ€å¤§16TBï¼‰ æœ€å¤§ GC åœé¡¿ 10ms å¯¹ååé‡å½±å“æœ€å¤§ï¼Œä¸è¶…è¿‡ 15% 4ã€é…ç½®åƒåœ¾æ”¶é›†å™¨ é¦–å…ˆæ˜¯å†…å­˜å¤§å°é—®é¢˜ï¼ŒåŸºæœ¬ä¸Šæ¯ä¸€ä¸ªå†…å­˜åŒºåŸŸæˆ‘éƒ½ä¼šè®¾ç½®ä¸€ä¸ªä¸Šé™ï¼Œæ¥é¿å…æº¢å‡ºé—®é¢˜ï¼Œæ¯”å¦‚å…ƒç©ºé—´ã€‚ é€šå¸¸ï¼Œå †ç©ºé—´æˆ‘ä¼šè®¾ç½®æˆæ“ä½œç³»ç»Ÿçš„ 2/3ï¼Œè¶…è¿‡ 8GB çš„å †ï¼Œä¼˜å…ˆé€‰ç”¨ G1 ç„¶åæˆ‘ä¼šå¯¹ JVM è¿›è¡Œåˆæ­¥ä¼˜åŒ–ï¼Œæ¯”å¦‚æ ¹æ®è€å¹´ä»£çš„å¯¹è±¡æå‡é€Ÿåº¦ï¼Œæ¥è°ƒæ•´å¹´è½»ä»£å’Œè€å¹´ä»£ä¹‹é—´çš„æ¯”ä¾‹ ä¾æ®ç³»ç»Ÿå®¹é‡ã€è®¿é—®å»¶è¿Ÿã€ååé‡ç­‰è¿›è¡Œä¸“é¡¹ä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„æœåŠ¡æ˜¯é«˜å¹¶å‘çš„ï¼Œå¯¹ STW çš„æ—¶é—´æ•æ„Ÿ æˆ‘ä¼šé€šè¿‡è®°å½•è¯¦ç»†çš„ GC æ—¥å¿—ï¼Œæ¥æ‰¾åˆ°è¿™ä¸ªç“¶é¢ˆç‚¹ï¼Œå€Ÿç”¨ GCeasy è¿™æ ·çš„æ—¥å¿—åˆ†æå·¥å…·ï¼Œå®šä½é—®é¢˜ 4ã€JVMæ€§èƒ½è°ƒä¼˜å¯¹åº”è¿›ç¨‹çš„JVMçŠ¶æ€ä»¥å®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜å¹¶ä½œå‡ºç›¸åº”çš„ä¼˜åŒ– å¸¸ç”¨å‘½ä»¤ï¼šjpsã€jinfoã€jstatã€jstackã€jmap jpsï¼šæŸ¥çœ‹javaè¿›ç¨‹åŠç›¸å…³ä¿¡æ¯ 123jps -l è¾“å‡ºjaråŒ…è·¯å¾„ï¼Œç±»å…¨åjps -m è¾“å‡ºmainå‚æ•°jps -v è¾“å‡ºJVMå‚æ•° jinfoï¼šæŸ¥çœ‹JVMå‚æ•° 123jinfo 11666jinfo -flags 11666Xmxã€Xmsã€Xmnã€MetaspaceSize jstatï¼šæŸ¥çœ‹JVMè¿è¡Œæ—¶çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬å†…å­˜çŠ¶æ€ã€åƒåœ¾å›æ”¶ 1jstat [option] LVMID [interval] [count]å…¶ä¸­LVMIDæ˜¯è¿›ç¨‹idï¼Œintervalæ˜¯æ‰“å°é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œcountæ˜¯æ‰“å°æ¬¡æ•°ï¼ˆé»˜è®¤ä¸€ç›´æ‰“å°ï¼‰ optionå‚æ•°è§£é‡Šï¼š-gc åƒåœ¾å›æ”¶å †çš„è¡Œä¸ºç»Ÿè®¡-gccapacity å„ä¸ªåƒåœ¾å›æ”¶ä»£å®¹é‡(young,old,perm)å’Œä»–ä»¬ç›¸åº”çš„ç©ºé—´ç»Ÿè®¡-gcutil åƒåœ¾å›æ”¶ç»Ÿè®¡æ¦‚è¿°-gcnew æ–°ç”Ÿä»£è¡Œä¸ºç»Ÿè®¡-gcold å¹´è€ä»£å’Œæ°¸ç”Ÿä»£è¡Œä¸ºç»Ÿè®¡ jstackï¼šæŸ¥çœ‹JVMçº¿ç¨‹å¿«ç…§ï¼Œjstackå‘½ä»¤å¯ä»¥å®šä½çº¿ç¨‹å‡ºç°é•¿æ—¶é—´å¡é¡¿çš„åŸå› ï¼Œä¾‹å¦‚æ­»é”ï¼Œæ­»å¾ªç¯ 1jstack [-l] &lt;pid&gt; (è¿æ¥è¿è¡Œä¸­çš„è¿›ç¨‹) optionå‚æ•°è§£é‡Šï¼š-F å½“ä½¿ç”¨jstack &lt;pid&gt;æ— å“åº”æ—¶ï¼Œå¼ºåˆ¶è¾“å‡ºçº¿ç¨‹å †æ ˆã€‚-m åŒæ—¶è¾“å‡ºjavaå’Œæœ¬åœ°å †æ ˆ(æ··åˆæ¨¡å¼)-l é¢å¤–æ˜¾ç¤ºé”ä¿¡æ¯ jmapï¼šå¯ä»¥ç”¨æ¥æŸ¥çœ‹å†…å­˜ä¿¡æ¯(é…åˆjhatä½¿ç”¨) 1jmap [option] &lt;pid&gt; (è¿æ¥æ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹)optionå‚æ•°è§£é‡Šï¼š-heap æ‰“å°java heapæ‘˜è¦-dump:&lt;dump-options&gt; ç”Ÿæˆjavaå †çš„dumpæ–‡ä»¶ 5ã€JDKæ–°ç‰¹æ€§JDK8 æ”¯æŒ Lamda è¡¨è¾¾å¼ã€é›†åˆçš„ stream æ“ä½œã€æå‡HashMapæ€§èƒ½ JDK9 1//Stream APIä¸­iterateæ–¹æ³•çš„æ–°é‡è½½æ–¹æ³•ï¼Œå¯ä»¥æŒ‡å®šä»€ä¹ˆæ—¶å€™ç»“æŸè¿­ä»£IntStream.iterate(1, i -&gt; i &lt; 100, i -&gt; i + 1).forEach(System.out::println); é»˜è®¤G1åƒåœ¾å›æ”¶å™¨ JDK10 å…¶é‡ç‚¹åœ¨äºé€šè¿‡å®Œå…¨GCå¹¶è¡Œæ¥æ”¹å–„G1æœ€åæƒ…å†µçš„ç­‰å¾…æ—¶é—´ã€‚ JDK11 ZGC (å¹¶å‘å›æ”¶çš„ç­–ç•¥) 4TB ç”¨äº Lambda å‚æ•°çš„å±€éƒ¨å˜é‡è¯­æ³• JDK12 Shenandoah GC (GC ç®—æ³•)åœé¡¿æ—¶é—´å’Œå †çš„å¤§å°æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œå¹¶è¡Œå…³æ³¨åœé¡¿å“åº”æ—¶é—´ã€‚ JDK13 å¢åŠ ZGCä»¥å°†æœªä½¿ç”¨çš„å †å†…å­˜è¿”å›ç»™æ“ä½œç³»ç»Ÿï¼Œ16TB JDK14 åˆ é™¤cmsåƒåœ¾å›æ”¶å™¨ã€å¼ƒç”¨ParallelScavenge+SerialOldGCåƒåœ¾å›æ”¶ç®—æ³•ç»„åˆ å°†ZGCåƒåœ¾å›æ”¶å™¨åº”ç”¨åˆ°macOSå’Œwindowså¹³å° ä¸‰ã€å¤šçº¿ç¨‹ç¯‡çº¿ç¨‹è°ƒåº¦1ã€çº¿ç¨‹çŠ¶æ€ çº¿ç¨‹æ˜¯cpuä»»åŠ¡è°ƒåº¦çš„æœ€å°æ‰§è¡Œå•ä½ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆ çº¿ç¨‹çŠ¶æ€ï¼šåˆ›å»ºã€å°±ç»ªã€è¿è¡Œã€é˜»å¡ã€æ­»äº¡ 2ã€çº¿ç¨‹çŠ¶æ€åˆ‡æ¢ æ–¹æ³• ä½œç”¨ åŒºåˆ« start å¯åŠ¨çº¿ç¨‹ï¼Œç”±è™šæ‹Ÿæœºè‡ªåŠ¨è°ƒåº¦æ‰§è¡Œrun()æ–¹æ³• çº¿ç¨‹å¤„äºå°±ç»ªçŠ¶æ€ run çº¿ç¨‹é€»è¾‘ä»£ç å—å¤„ç†ï¼ŒJVMè°ƒåº¦æ‰§è¡Œ çº¿ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€ sleep è®©å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¼‘çœ ï¼ˆæš‚åœæ‰§è¡Œï¼‰ ä¸é‡Šæ”¾é” wait ä½¿å¾—å½“å‰çº¿ç¨‹ç­‰å¾… é‡Šæ”¾åŒæ­¥é” notify å”¤é†’åœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šç­‰å¾…çš„å•ä¸ªçº¿ç¨‹ å”¤é†’å•ä¸ªçº¿ç¨‹ notifyAll å”¤é†’åœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹ å”¤é†’å¤šä¸ªçº¿ç¨‹ yiled åœæ­¢å½“å‰çº¿ç¨‹ï¼Œè®©åŒç­‰ä¼˜å…ˆæƒçš„çº¿ç¨‹è¿è¡Œ ç”¨Threadç±»è°ƒç”¨ join ä½¿å½“å‰çº¿ç¨‹åœä¸‹æ¥ç­‰å¾…ï¼Œç›´è‡³å¦ä¸€ä¸ªè°ƒç”¨joinæ–¹æ³•çš„çº¿ç¨‹ç»ˆæ­¢ ç”¨çº¿ç¨‹å¯¹è±¡è°ƒç”¨ 3ã€é˜»å¡å”¤é†’è¿‡ç¨‹é˜»å¡ï¼š è¿™ä¸‰ä¸ªæ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šä½¿å½“å‰çº¿ç¨‹é˜»å¡ã€‚è¯¥çº¿ç¨‹å°†ä¼šè¢«æ”¾ç½®åˆ°å¯¹è¯¥Objectçš„è¯·æ±‚ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç„¶åè®©å‡ºå½“å‰å¯¹Objectæ‰€æ‹¥æœ‰çš„æ‰€æœ‰çš„åŒæ­¥è¯·æ±‚ã€‚çº¿ç¨‹ä¼šä¸€ç›´æš‚åœæ‰€æœ‰çº¿ç¨‹è°ƒåº¦ï¼Œç›´åˆ°ä¸‹é¢å…¶ä¸­ä¸€ç§æƒ…å†µå‘ç”Ÿï¼š â‘  å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†è¯¥Objectçš„notifyæ–¹æ³•ï¼Œè€Œè¯¥çº¿ç¨‹åˆšå¥½æ˜¯é‚£ä¸ªè¢«å”¤é†’çš„çº¿ç¨‹ï¼› â‘¡ å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†è¯¥Objectçš„notifyAllæ–¹æ³•ï¼› å”¤é†’ï¼š çº¿ç¨‹å°†ä¼šä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œé‡æ–°æˆä¸ºå¯è°ƒåº¦çº¿ç¨‹ã€‚å®ƒä¼šä¸å…¶ä»–çº¿ç¨‹ä»¥å¸¸è§„çš„æ–¹å¼ç«äº‰å¯¹è±¡åŒæ­¥è¯·æ±‚ã€‚ä¸€æ—¦å®ƒé‡æ–°è·å¾—å¯¹è±¡çš„åŒæ­¥è¯·æ±‚ï¼Œæ‰€æœ‰ä¹‹å‰çš„è¯·æ±‚çŠ¶æ€éƒ½ä¼šæ¢å¤ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹è°ƒç”¨waitçš„åœ°æ–¹çš„çŠ¶æ€ã€‚çº¿ç¨‹å°†ä¼šåœ¨ä¹‹å‰è°ƒç”¨waitçš„åœ°æ–¹ç»§ç»­è¿è¡Œä¸‹å»ã€‚ ä¸ºä»€ä¹ˆè¦å‡ºç°åœ¨åŒæ­¥ä»£ç å—ä¸­ï¼š ç”±äºwait()å±äºObjectæ–¹æ³•ï¼Œè°ƒç”¨ä¹‹åä¼šå¼ºåˆ¶é‡Šæ”¾å½“å‰å¯¹è±¡é”ï¼Œæ‰€ä»¥åœ¨wait() è°ƒç”¨æ—¶å¿…é¡»æ‹¿åˆ°å½“å‰å¯¹è±¡çš„ç›‘è§†å™¨monitorå¯¹è±¡ã€‚å› æ­¤ï¼Œwait()æ–¹æ³•åœ¨åŒæ­¥æ–¹æ³•/ä»£ç å—ä¸­è°ƒç”¨ã€‚ 4ã€waitå’ŒsleepåŒºåˆ« wait æ–¹æ³•å¿…é¡»åœ¨ synchronized ä¿æŠ¤çš„ä»£ç ä¸­ä½¿ç”¨ï¼Œè€Œ sleep æ–¹æ³•å¹¶æ²¡æœ‰è¿™ä¸ªè¦æ±‚ã€‚ wait æ–¹æ³•ä¼šä¸»åŠ¨é‡Šæ”¾ monitor é”ï¼Œåœ¨åŒæ­¥ä»£ç ä¸­æ‰§è¡Œ sleep æ–¹æ³•æ—¶ï¼Œå¹¶ä¸ä¼šé‡Šæ”¾ monitor é”ã€‚ wait æ–¹æ³•æ„å‘³ç€æ°¸ä¹…ç­‰å¾…ï¼Œç›´åˆ°è¢«ä¸­æ–­æˆ–è¢«å”¤é†’æ‰èƒ½æ¢å¤ï¼Œä¸ä¼šä¸»åŠ¨æ¢å¤ï¼Œsleep æ–¹æ³•ä¸­ä¼šå®šä¹‰ä¸€ä¸ªæ—¶é—´ï¼Œæ—¶é—´åˆ°æœŸåä¼šä¸»åŠ¨æ¢å¤ã€‚ wait/notify æ˜¯ Object ç±»çš„æ–¹æ³•ï¼Œè€Œ sleep æ˜¯ Thread ç±»çš„æ–¹æ³•ã€‚ 5ã€åˆ›å»ºçº¿ç¨‹æ–¹å¼å®ç° Runnable æ¥å£ï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰ 1public class RunnableThread implements Runnable { @Override public void run() {System.out.println('ç”¨å®ç°Runnableæ¥å£å®ç°çº¿ç¨‹');}} å®ç°Callableæ¥å£ï¼ˆæœ‰è¿”å›å€¼å¯æŠ›å‡ºå¼‚å¸¸ï¼‰ 1class CallableTask implements Callable&lt;Integer&gt; { @Override public Integer call() throws Exception { return new Random().nextInt();}} ç»§æ‰¿Threadç±»ï¼ˆjavaä¸æ”¯æŒå¤šç»§æ‰¿ï¼‰ 1public class ExtendsThread extends Thread { @Override public void run() {System.out.println('ç”¨Threadç±»å®ç°çº¿ç¨‹');}} ä½¿ç”¨çº¿ç¨‹æ± ï¼ˆåº•å±‚éƒ½æ˜¯å®ç°runæ–¹æ³•ï¼‰ 1static class DefaultThreadFactory implements ThreadFactory { DefaultThreadFactory() { SecurityManager s = System.getSecurityManager(); group = (s != null) ? s.getThreadGroup() : Thread.currentThread().getThreadGroup(); namePrefix = &quot;pool-&quot; + poolNumber.getAndIncrement() +&quot;-thread-&quot;; } public Thread newThread(Runnable r) { Thread t = new Thread(group, r,namePrefix + threadNumber.getAndIncrement(),0); if (t.isDaemon()) t.setDaemon(false); //æ˜¯å¦å®ˆæŠ¤çº¿ç¨‹ if (t.getPriority() != Thread.NORM_PRIORITY) t.setPriority(Thread.NORM_PRIORITY); //çº¿ç¨‹ä¼˜å…ˆçº§ return t; }} çº¿ç¨‹æ± ä¼˜ç‚¹ï¼šé€šè¿‡å¤ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹ï¼Œé™ä½èµ„æºæŸè€—ã€çº¿ç¨‹å¯ä»¥ç›´æ¥å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åŠ å¿«å“åº”é€Ÿåº¦ã€åŒæ—¶ä¾¿äºç»Ÿä¸€ç›‘æ§å’Œç®¡ç†ã€‚ 1ã€çº¿ç¨‹æ± æ„é€ å‡½æ•°1/*** çº¿ç¨‹æ± æ„é€ å‡½æ•°7å¤§å‚æ•°*/public ThreadPoolExecutor(int corePoolSize,int maximumPoolSize,long keepAliveTime, TimeUnit unit,BlockingQueue&lt;Runnable&gt; workQueue,ThreadFactory threadFactory, RejectedExecutionHandler handler) {} å‚æ•°ä»‹ç»ï¼š å‚æ•° ä½œç”¨ corePoolSize æ ¸å¿ƒçº¿ç¨‹æ± å¤§å° maximumPoolSize æœ€å¤§çº¿ç¨‹æ± å¤§å° keepAliveTime çº¿ç¨‹æ± ä¸­è¶…è¿‡ corePoolSize æ•°ç›®çš„ç©ºé—²çº¿ç¨‹æœ€å¤§å­˜æ´»æ—¶é—´ï¼› TimeUnit keepAliveTime æ—¶é—´å•ä½ workQueue é˜»å¡ä»»åŠ¡é˜Ÿåˆ— threadFactory æ–°å»ºçº¿ç¨‹å·¥å‚ RejectedExecutionHandler æ‹’ç»ç­–ç•¥ã€‚å½“æäº¤ä»»åŠ¡æ•°è¶…è¿‡ maxmumPoolSize+workQueue ä¹‹å’Œæ—¶ï¼Œä»»åŠ¡ä¼šäº¤ç»™RejectedExecutionHandler æ¥å¤„ç† 2ã€çº¿ç¨‹å¤„ç†ä»»åŠ¡è¿‡ç¨‹ï¼š å½“çº¿ç¨‹æ± å°äºcorePoolSizeï¼Œæ–°æäº¤ä»»åŠ¡å°†åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå³ä½¿æ­¤æ—¶çº¿ç¨‹æ± ä¸­å­˜åœ¨ç©ºé—²çº¿ç¨‹ã€‚ å½“çº¿ç¨‹æ± è¾¾åˆ°corePoolSizeæ—¶ï¼Œæ–°æäº¤ä»»åŠ¡å°†è¢«æ”¾å…¥ workQueue ä¸­ï¼Œç­‰å¾…çº¿ç¨‹æ± ä¸­ä»»åŠ¡è°ƒåº¦æ‰§è¡Œã€‚ å½“workQueueå·²æ»¡ï¼Œä¸” maximumPoolSize å¤§äº corePoolSize æ—¶ï¼Œæ–°æäº¤ä»»åŠ¡ä¼šåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚ å½“æäº¤ä»»åŠ¡æ•°è¶…è¿‡ maximumPoolSize æ—¶ï¼Œæ–°æäº¤ä»»åŠ¡ç”± RejectedExecutionHandler å¤„ç†ã€‚ å½“çº¿ç¨‹æ± ä¸­è¶…è¿‡corePoolSize çº¿ç¨‹ï¼Œç©ºé—²æ—¶é—´è¾¾åˆ° keepAliveTime æ—¶ï¼Œå…³é—­ç©ºé—²çº¿ç¨‹ ã€‚ 3ã€çº¿ç¨‹æ‹’ç»ç­–ç•¥ çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å·²ç»ç”¨å®Œäº†ï¼Œæ— æ³•ç»§ç»­ä¸ºæ–°ä»»åŠ¡æœåŠ¡ï¼ŒåŒæ—¶ï¼Œç­‰å¾…é˜Ÿåˆ—ä¹Ÿå·²ç»æ’æ»¡äº†ï¼Œå†ä¹Ÿå¡ä¸ä¸‹æ–°ä»»åŠ¡äº†ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦æ‹’ç»ç­–ç•¥æœºåˆ¶åˆç†çš„å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚ JDK å†…ç½®çš„æ‹’ç»ç­–ç•¥å¦‚ä¸‹ï¼š AbortPolicyï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚å¯ä»¥æ ¹æ®ä¸šåŠ¡é€»è¾‘é€‰æ‹©é‡è¯•æˆ–è€…æ”¾å¼ƒæäº¤ç­‰ç­–ç•¥ã€‚ CallerRunsPolicy ï¼šåªè¦çº¿ç¨‹æ± æœªå…³é—­ï¼Œè¯¥ç­–ç•¥ç›´æ¥åœ¨è°ƒç”¨è€…çº¿ç¨‹ä¸­ï¼Œè¿è¡Œå½“å‰è¢«ä¸¢å¼ƒçš„ä»»åŠ¡ã€‚ ä¸ä¼šé€ æˆä»»åŠ¡ä¸¢å¤±ï¼ŒåŒæ—¶å‡ç¼“æäº¤ä»»åŠ¡çš„é€Ÿåº¦ï¼Œç»™æ‰§è¡Œä»»åŠ¡ç¼“å†²æ—¶é—´ã€‚ DiscardOldestPolicy ï¼šä¸¢å¼ƒæœ€è€çš„ä¸€ä¸ªè¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯å³å°†è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶å°è¯•å†æ¬¡æäº¤å½“å‰ä»»åŠ¡ã€‚ DiscardPolicy ï¼šè¯¥ç­–ç•¥é»˜é»˜åœ°ä¸¢å¼ƒæ— æ³•å¤„ç†çš„ä»»åŠ¡ï¼Œä¸äºˆä»»ä½•å¤„ç†ã€‚å¦‚æœå…è®¸ä»»åŠ¡ä¸¢å¤±ï¼Œè¿™æ˜¯æœ€å¥½çš„ä¸€ç§æ–¹æ¡ˆã€‚ 4ã€Execuorsç±»å®ç°çº¿ç¨‹æ±  newSingleThreadExecutor()ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œä»»åŠ¡æ˜¯é¡ºåºæ‰§è¡Œï¼Œé€‚ç”¨äºä¸€ä¸ªä¸€ä¸ªä»»åŠ¡æ‰§è¡Œçš„åœºæ™¯ newCachedThreadPool()ï¼šçº¿ç¨‹æ± é‡Œæœ‰å¾ˆå¤šçº¿ç¨‹éœ€è¦åŒæ—¶æ‰§è¡Œï¼Œ60så†…å¤ç”¨ï¼Œé€‚ç”¨æ‰§è¡Œå¾ˆå¤šçŸ­æœŸå¼‚æ­¥çš„å°ç¨‹åºæˆ–è€…è´Ÿè½½è¾ƒè½»çš„æœåŠ¡ newFixedThreadPool()ï¼šæ‹¥æœ‰å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± ï¼Œå¦‚æœæ²¡æœ‰ä»»åŠ¡æ‰§è¡Œï¼Œé‚£ä¹ˆçº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…ï¼Œé€‚ç”¨æ‰§è¡Œé•¿æœŸçš„ä»»åŠ¡ã€‚ newScheduledThreadPool()ï¼šç”¨æ¥è°ƒåº¦å³å°†æ‰§è¡Œçš„ä»»åŠ¡çš„çº¿ç¨‹æ±  **newWorkStealingPool()**ï¼šåº•å±‚é‡‡ç”¨forkjoinçš„Dequeï¼Œé‡‡ç”¨ç‹¬ç«‹çš„ä»»åŠ¡é˜Ÿåˆ—å¯ä»¥å‡å°‘ç«äº‰åŒæ—¶åŠ å¿«ä»»åŠ¡å¤„ç† å› ä¸ºä»¥ä¸Šæ–¹å¼éƒ½å­˜åœ¨å¼Šç«¯ï¼š FixedThreadPool å’Œ SingleThreadExecutor ï¼š å…è®¸è¯·æ±‚çš„é˜Ÿåˆ—â»“åº¦ä¸º Integer.MAX_VALUEï¼Œä¼šå¯¼è‡´OOMã€‚â€‹ CachedThreadPool å’Œ ScheduledThreadPool ï¼š å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º Integer.MAX_VALUEï¼Œä¼šå¯¼è‡´OOMã€‚ æ‰‹åŠ¨åˆ›å»ºçš„çº¿ç¨‹æ± åº•å±‚ä½¿ç”¨çš„æ˜¯ArrayBlockingQueueå¯ä»¥é˜²æ­¢OOMã€‚ 5ã€çº¿ç¨‹æ± å¤§å°è®¾ç½® CPU å¯†é›†å‹ï¼ˆn+1ï¼‰ CPU å¯†é›†çš„æ„æ€æ˜¯è¯¥ä»»åŠ¡éœ€è¦å¤§é‡çš„è¿ç®—ï¼Œè€Œæ²¡æœ‰é˜»å¡ï¼ŒCPU ä¸€ç›´å…¨é€Ÿè¿è¡Œã€‚ CPU å¯†é›†å‹ä»»åŠ¡å°½å¯èƒ½çš„å°‘çš„çº¿ç¨‹æ•°é‡ï¼Œä¸€èˆ¬ä¸º CPU æ ¸æ•° + 1 ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚ IO å¯†é›†å‹ï¼ˆ2*nï¼‰ ç”±äº IO å¯†é›†å‹ä»»åŠ¡çº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ç›´åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œå¯ä»¥å¤šåˆ†é…ä¸€ç‚¹çº¿ç¨‹æ•°ï¼Œå¦‚ CPU * 2 ä¹Ÿå¯ä»¥ä½¿ç”¨å…¬å¼ï¼šCPU æ ¸å¿ƒæ•° *ï¼ˆ1+å¹³å‡ç­‰å¾…æ—¶é—´/å¹³å‡å·¥ä½œæ—¶é—´ï¼‰ã€‚ çº¿ç¨‹å®‰å…¨1ã€ä¹è§‚é”ï¼ŒCASæ€æƒ³javaä¹è§‚é”æœºåˆ¶ï¼š ä¹è§‚é”ä½“ç°çš„æ˜¯æ‚²è§‚é”çš„åé¢ã€‚å®ƒæ˜¯ä¸€ç§ç§¯æçš„æ€æƒ³ï¼Œå®ƒæ€»æ˜¯è®¤ä¸ºæ•°æ®æ˜¯ä¸ä¼šè¢«ä¿®æ”¹çš„ï¼Œæ‰€ä»¥æ˜¯ä¸ä¼šå¯¹æ•°æ®ä¸Šé”çš„ã€‚ä½†æ˜¯ä¹è§‚é”åœ¨æ›´æ–°çš„æ—¶å€™ä¼šå»åˆ¤æ–­æ•°æ®æ˜¯å¦è¢«æ›´æ–°è¿‡ã€‚ä¹è§‚é”çš„å®ç°æ–¹æ¡ˆä¸€èˆ¬æœ‰ä¸¤ç§ï¼ˆç‰ˆæœ¬å·æœºåˆ¶å’ŒCASï¼‰ã€‚ä¹è§‚é”é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œè¿™æ ·å¯ä»¥æé«˜ç³»ç»Ÿçš„å¹¶å‘é‡ã€‚åœ¨Javaä¸­ java.util.concurrent.atomicä¸‹çš„åŸå­å˜é‡ç±»å°±æ˜¯ä½¿ç”¨äº†ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼CASå®ç°çš„ã€‚ ä¹è§‚é”ï¼Œå¤§å¤šæ˜¯åŸºäºæ•°æ®ç‰ˆæœ¬ (Version)è®°å½•æœºåˆ¶å®ç°ã€‚å³ä¸ºæ•°æ®å¢åŠ ä¸€ä¸ªç‰ˆæœ¬æ ‡è¯†ï¼Œåœ¨åŸºäºæ•°æ®åº“è¡¨çš„ç‰ˆæœ¬è§£å†³æ–¹æ¡ˆä¸­ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ä¸ºæ•°æ®åº“è¡¨å¢åŠ ä¸€ä¸ª â€œversionâ€ å­—æ®µæ¥ å®ç°ã€‚ è¯»å–å‡ºæ•°æ®æ—¶ï¼Œå°†æ­¤ç‰ˆæœ¬å·ä¸€åŒè¯»å‡ºï¼Œä¹‹åæ›´æ–°æ—¶ï¼Œå¯¹æ­¤ç‰ˆæœ¬å·åŠ ä¸€ã€‚æ­¤æ—¶ï¼Œå°†æ äº¤æ•°æ®çš„ç‰ˆæœ¬æ•°æ®ä¸æ•°æ®åº“è¡¨å¯¹åº”è®°å½•çš„å½“å‰ç‰ˆæœ¬ä¿¡æ¯è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæäº¤çš„æ•°æ® ç‰ˆæœ¬å·å¤§äºæ•°æ®åº“è¡¨å½“å‰ç‰ˆæœ¬å·ï¼Œåˆ™äºˆä»¥æ›´æ–°ï¼Œå¦åˆ™è®¤ä¸ºæ˜¯è¿‡æœŸæ•°æ®ã€‚ CASæ€æƒ³ï¼š CASå°±æ˜¯compare and swapï¼ˆæ¯”è¾ƒäº¤æ¢ï¼‰ï¼Œæ˜¯ä¸€ç§å¾ˆå‡ºåçš„æ— é”çš„ç®—æ³•ï¼Œå°±æ˜¯å¯ä»¥ä¸ä½¿ç”¨é”æœºåˆ¶å®ç°çº¿ç¨‹é—´çš„åŒæ­¥ã€‚ä½¿ç”¨CASçº¿ç¨‹æ˜¯ä¸ä¼šè¢«é˜»å¡çš„ï¼Œæ‰€ä»¥åˆç§°ä¸ºéé˜»å¡åŒæ­¥ã€‚CASç®—æ³•æ¶‰åŠåˆ°ä¸‰ä¸ªæ“ä½œï¼š éœ€è¦è¯»å†™å†…å­˜å€¼Vï¼›è¿›è¡Œæ¯”è¾ƒçš„å€¼Aï¼›å‡†å¤‡å†™å…¥çš„å€¼B å½“ä¸”ä»…å½“Vçš„å€¼ç­‰äºAçš„å€¼ç­‰äºVçš„å€¼çš„æ—¶å€™ï¼Œæ‰ç”¨Bçš„å€¼å»æ›´æ–°Vçš„å€¼ï¼Œå¦åˆ™ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œï¼ˆæ¯”è¾ƒå’Œæ›¿æ¢æ˜¯ä¸€ä¸ªåŸå­æ“ä½œ-Aå’ŒVæ¯”è¾ƒï¼ŒVå’ŒBæ›¿æ¢ï¼‰ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸€ä¸ªè‡ªæ—‹æ“ä½œï¼Œå³ä¸æ–­é‡è¯• ç¼ºç‚¹ï¼š ABAé—®é¢˜-çŸ¥ä¹ é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¾ˆå®¹æ˜“å‘ç”Ÿå¹¶å‘å†²çªï¼Œå¦‚æœCASä¸€ç›´å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¼šä¸€ç›´é‡è¯•ï¼Œæµªè´¹CPUèµ„æº åŸå­æ€§ï¼š åŠŸèƒ½é™åˆ¶CASæ˜¯èƒ½ä¿è¯å•ä¸ªå˜é‡çš„æ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œåœ¨Javaä¸­è¦é…åˆä½¿ç”¨volatileå…³é”®å­—æ¥ä¿è¯çº¿ç¨‹çš„å®‰å…¨ï¼›å½“æ¶‰åŠåˆ°å¤šä¸ªå˜é‡çš„æ—¶å€™CASæ— èƒ½ä¸ºåŠ›ï¼›é™¤æ­¤ä¹‹å¤–CASå®ç°éœ€è¦ç¡¬ä»¶å±‚é¢çš„æ”¯æŒï¼Œåœ¨Javaçš„æ™®é€šç”¨æˆ·ä¸­æ— æ³•ç›´æ¥ä½¿ç”¨ï¼Œåªèƒ½å€ŸåŠ©atomicåŒ…ä¸‹çš„åŸå­ç±»å®ç°ï¼Œçµæ´»æ€§å—åˆ°äº†é™åˆ¶ 2ã€synchronizedåº•å±‚å®ç°ä½¿ç”¨æ–¹æ³•ï¼šä¸»è¦çš„ä¸‰ç§ä½¿â½¤â½…å¼ ä¿®é¥°å®ä¾‹â½…æ³•: ä½œâ½¤äºå½“å‰å¯¹è±¡å®ä¾‹åŠ é”ï¼Œè¿›â¼ŠåŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰å¯¹è±¡å®ä¾‹çš„é” ä¿®é¥°é™æ€â½…æ³•: ä¹Ÿå°±æ˜¯ç»™å½“å‰ç±»åŠ é”ï¼Œä¼šä½œâ½¤äºç±»çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹ï¼Œå› ä¸ºé™æ€æˆå‘˜ä¸å±äºä»»ä½•â¼€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œæ˜¯ç±»æˆå‘˜ã€‚ ä¿®é¥°ä»£ç å—: æŒ‡å®šåŠ é”å¯¹è±¡ï¼Œå¯¹ç»™å®šå¯¹è±¡åŠ é”ï¼Œè¿›â¼ŠåŒæ­¥ä»£ç åº“å‰è¦è·å¾—ç»™å®šå¯¹è±¡çš„é”ã€‚ æ€»ç»“ï¼šsynchronizedé”ä½çš„èµ„æºåªæœ‰ä¸¤ç±»ï¼šä¸€ä¸ªæ˜¯å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯ç±»ã€‚ åº•å±‚å®ç°ï¼š å¯¹è±¡å¤´æ˜¯æˆ‘ä»¬éœ€è¦å…³æ³¨çš„é‡ç‚¹ï¼Œå®ƒæ˜¯synchronizedå®ç°é”çš„åŸºç¡€ï¼Œå› ä¸ºsynchronizedç”³è¯·é”ã€ä¸Šé”ã€é‡Šæ”¾é”éƒ½ä¸å¯¹è±¡å¤´æœ‰å…³ã€‚å¯¹è±¡å¤´ä¸»è¦ç»“æ„æ˜¯ç”±Mark Word ç»„æˆï¼Œå…¶ä¸­Mark Wordå­˜å‚¨å¯¹è±¡çš„hashCodeã€é”ä¿¡æ¯æˆ–åˆ†ä»£å¹´é¾„æˆ–GCæ ‡å¿—ç­‰ä¿¡æ¯ã€‚ é”ä¹Ÿåˆ†ä¸åŒçŠ¶æ€ï¼ŒJDK6ä¹‹å‰åªæœ‰ä¸¤ä¸ªçŠ¶æ€ï¼šæ— é”ã€æœ‰é”ï¼ˆé‡é‡çº§é”ï¼‰ï¼Œè€Œåœ¨JDK6ä¹‹åå¯¹synchronizedè¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ–°å¢äº†ä¸¤ç§çŠ¶æ€ï¼Œæ€»å…±å°±æ˜¯å››ä¸ªçŠ¶æ€ï¼šæ— é”çŠ¶æ€ã€åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ï¼Œå…¶ä¸­æ— é”å°±æ˜¯ä¸€ç§çŠ¶æ€äº†ã€‚é”çš„ç±»å‹å’ŒçŠ¶æ€åœ¨å¯¹è±¡å¤´Mark Wordä¸­éƒ½æœ‰è®°å½•ï¼Œåœ¨ç”³è¯·é”ã€é”å‡çº§ç­‰è¿‡ç¨‹ä¸­JVMéƒ½éœ€è¦è¯»å–å¯¹è±¡çš„Mark Wordæ•°æ®ã€‚ åŒæ­¥ä»£ç å—æ˜¯åˆ©ç”¨ monitorenter å’Œ monitorexit æŒ‡ä»¤å®ç°çš„ï¼Œè€ŒåŒæ­¥æ–¹æ³•åˆ™æ˜¯åˆ©ç”¨ flags å®ç°çš„ã€‚ 3ã€ReenTrantLockåº•å±‚å®ç° ç”±äºReentrantLockæ˜¯java.util.concurrentåŒ…ä¸‹æä¾›çš„ä¸€å¥—äº’æ–¥é”ï¼Œç›¸æ¯”Synchronizedï¼ŒReentrantLockç±»æä¾›äº†ä¸€äº›é«˜çº§åŠŸèƒ½ ä½¿ç”¨æ–¹æ³•ï¼š åŸºäºAPIå±‚é¢çš„äº’æ–¥é”ï¼Œéœ€è¦lock()å’Œunlock()æ–¹æ³•é…åˆtry/finallyè¯­å¥å—æ¥å®Œæˆ åº•å±‚å®ç°ï¼š ReenTrantLockçš„å®ç°æ˜¯ä¸€ç§è‡ªæ—‹é”ï¼Œé€šè¿‡å¾ªç¯è°ƒç”¨CASæ“ä½œæ¥å®ç°åŠ é”ã€‚å®ƒçš„æ€§èƒ½æ¯”è¾ƒå¥½ä¹Ÿæ˜¯å› ä¸ºé¿å…äº†ä½¿çº¿ç¨‹è¿›å…¥å†…æ ¸æ€çš„é˜»å¡çŠ¶æ€ã€‚æƒ³å°½åŠæ³•é¿å…çº¿ç¨‹è¿›å…¥å†…æ ¸çš„é˜»å¡çŠ¶æ€æ˜¯æˆ‘ä»¬å»åˆ†æå’Œç†è§£é”è®¾è®¡çš„å…³é”®é’¥åŒ™ã€‚ å’ŒsynchronizedåŒºåˆ«ï¼š 1ã€åº•å±‚å®ç°ï¼šsynchronized æ˜¯JVMå±‚é¢çš„é”ï¼Œæ˜¯Javaå…³é”®å­—ï¼Œé€šè¿‡monitorå¯¹è±¡æ¥å®Œæˆï¼ˆmonitorenterä¸monitorexitï¼‰ï¼ŒReentrantLock æ˜¯ä»jdk1.5ä»¥æ¥ï¼ˆjava.util.concurrent.locks.Lockï¼‰æä¾›çš„APIå±‚é¢çš„é”ã€‚ 2ã€å®ç°åŸç†****ï¼šsynchronized çš„å®ç°æ¶‰åŠåˆ°**é”çš„å‡çº§ï¼Œå…·ä½“ä¸ºæ— é”ã€åå‘é”ã€è‡ªæ—‹é”ã€å‘OSç”³è¯·é‡é‡çº§é”ï¼›ReentrantLockå®ç°åˆ™æ˜¯é€šè¿‡åˆ©ç”¨CASï¼ˆCompareAndSwapï¼‰è‡ªæ—‹æœºåˆ¶ä¿è¯çº¿ç¨‹æ“ä½œçš„åŸå­æ€§å’Œvolatileä¿è¯æ•°æ®å¯è§æ€§ä»¥å®ç°é”çš„åŠŸèƒ½ã€‚ 3ã€æ˜¯å¦å¯æ‰‹åŠ¨é‡Šæ”¾ï¼šsynchronized ä¸éœ€è¦ç”¨æˆ·å»æ‰‹åŠ¨é‡Šæ”¾é”ï¼Œsynchronized ä»£ç æ‰§è¡Œå®Œåç³»ç»Ÿä¼šè‡ªåŠ¨è®©çº¿ç¨‹é‡Šæ”¾å¯¹é”çš„å ç”¨ï¼› ReentrantLockåˆ™éœ€è¦ç”¨æˆ·å»æ‰‹åŠ¨é‡Šæ”¾é”ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨é‡Šæ”¾é”ï¼Œå°±å¯èƒ½å¯¼è‡´æ­»é”ç°è±¡ã€‚ 4ã€æ˜¯å¦å¯ä¸­æ–­synchronizedæ˜¯ä¸å¯ä¸­æ–­ç±»å‹çš„é”ï¼Œé™¤éåŠ é”çš„ä»£ç ä¸­å‡ºç°å¼‚å¸¸æˆ–æ­£å¸¸æ‰§è¡Œå®Œæˆï¼› ReentrantLockåˆ™å¯ä»¥ä¸­æ–­ï¼Œå¯é€šè¿‡trylock(long timeout,TimeUnit unit)è®¾ç½®è¶…æ—¶æ–¹æ³•æˆ–è€…å°†lockInterruptibly()æ”¾åˆ°ä»£ç å—ä¸­ï¼Œè°ƒç”¨interruptæ–¹æ³•è¿›è¡Œä¸­æ–­ã€‚ 5ã€æ˜¯å¦å…¬å¹³é”synchronizedä¸ºéå…¬å¹³é” ReentrantLockåˆ™å³å¯ä»¥é€‰å…¬å¹³é”ä¹Ÿå¯ä»¥é€‰éå…¬å¹³é”ï¼Œé€šè¿‡æ„é€ æ–¹æ³•new ReentrantLockæ—¶ä¼ å…¥booleanå€¼è¿›è¡Œé€‰æ‹©ï¼Œä¸ºç©ºé»˜è®¤falseéå…¬å¹³é”ï¼Œtrueä¸ºå…¬å¹³é”,å…¬å¹³é”æ€§èƒ½éå¸¸ä½ã€‚ 4ã€å…¬å¹³é”å’Œéå…¬å¹³é”åŒºåˆ«å…¬å¹³é”ï¼š å…¬å¹³é”è‡ªç„¶æ˜¯éµå¾ªFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰åŸåˆ™çš„ï¼Œå…ˆåˆ°çš„çº¿ç¨‹ä¼šä¼˜å…ˆè·å–èµ„æºï¼Œååˆ°çš„ä¼šè¿›è¡Œæ’é˜Ÿç­‰å¾… ä¼˜ç‚¹ï¼šæ‰€æœ‰çš„çº¿ç¨‹éƒ½èƒ½å¾—åˆ°èµ„æºï¼Œä¸ä¼šé¥¿æ­»åœ¨é˜Ÿåˆ—ä¸­ã€‚é€‚åˆå¤§ä»»åŠ¡ ç¼ºç‚¹ï¼šååé‡ä¼šä¸‹é™ï¼Œé˜Ÿåˆ—é‡Œé¢é™¤äº†ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œå…¶ä»–çš„çº¿ç¨‹éƒ½ä¼šé˜»å¡ï¼Œcpuå”¤é†’é˜»å¡çº¿ç¨‹çš„å¼€é”€å¤§ éå…¬å¹³é”ï¼š å¤šä¸ªçº¿ç¨‹å»è·å–é”çš„æ—¶å€™ï¼Œä¼šç›´æ¥å»å°è¯•è·å–ï¼Œè·å–ä¸åˆ°ï¼Œå†å»è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœèƒ½è·å–åˆ°ï¼Œå°±ç›´æ¥è·å–åˆ°é”ã€‚ ä¼˜ç‚¹ï¼šå¯ä»¥å‡å°‘CPUå”¤é†’çº¿ç¨‹çš„å¼€é”€ï¼Œæ•´ä½“çš„ååæ•ˆç‡ä¼šé«˜ç‚¹ï¼ŒCPUä¹Ÿä¸å¿…å–å”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œä¼šå‡å°‘å”¤èµ·çº¿ç¨‹çš„æ•°é‡ã€‚ ç¼ºç‚¹ï¼šä½ ä»¬å¯èƒ½ä¹Ÿå‘ç°äº†ï¼Œè¿™æ ·å¯èƒ½å¯¼è‡´é˜Ÿåˆ—ä¸­é—´çš„çº¿ç¨‹ä¸€ç›´è·å–ä¸åˆ°é”æˆ–è€…é•¿æ—¶é—´è·å–ä¸åˆ°é” å…¬å¹³é”æ•ˆç‡ä½åŸå› ï¼š å…¬å¹³é”è¦ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ï¼Œåæ¥çš„çº¿ç¨‹è¦åŠ é”ï¼Œå³ä½¿é”ç©ºé—²ï¼Œä¹Ÿè¦å…ˆæ£€æŸ¥æœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨ waitï¼Œå¦‚æœæœ‰è‡ªå·±è¦æŒ‚èµ·ï¼ŒåŠ åˆ°é˜Ÿåˆ—åé¢ï¼Œç„¶åå”¤é†’é˜Ÿåˆ—æœ€å‰é¢çº¿ç¨‹ã€‚è¿™ç§æƒ…å†µä¸‹ç›¸æ¯”è¾ƒéå…¬å¹³é”å¤šäº†ä¸€æ¬¡æŒ‚èµ·å’Œå”¤é†’ã€‚ çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œå…¶å®å°±æ˜¯éå…¬å¹³é”æ•ˆç‡é«˜äºå…¬å¹³é”çš„åŸå› ï¼Œå› ä¸ºéå…¬å¹³é”å‡å°‘äº†çº¿ç¨‹æŒ‚èµ·çš„å‡ ç‡ï¼Œåæ¥çš„çº¿ç¨‹æœ‰ä¸€å®šå‡ ç‡é€ƒç¦»è¢«æŒ‚èµ·çš„å¼€é”€ã€‚ 5ã€ä½¿ç”¨å±‚é¢é”ä¼˜åŒ– ã€1ã€‘å‡å°‘é”çš„æ—¶é—´ï¼šâ€‹ ä¸éœ€è¦åŒæ­¥æ‰§è¡Œçš„ä»£ç ï¼Œèƒ½ä¸æ”¾åœ¨åŒæ­¥å¿«é‡Œé¢æ‰§è¡Œå°±ä¸è¦æ”¾åœ¨åŒæ­¥å¿«å†…ï¼Œå¯ä»¥è®©é”å°½å¿«é‡Šæ”¾ï¼› ã€2ã€‘å‡å°‘é”çš„ç²’åº¦ï¼šâ€‹ å®ƒçš„æ€æƒ³æ˜¯å°†ç‰©ç†ä¸Šçš„ä¸€ä¸ªé”ï¼Œæ‹†æˆé€»è¾‘ä¸Šçš„å¤šä¸ªé”ï¼Œå¢åŠ å¹¶è¡Œåº¦ï¼Œä»è€Œé™ä½é”ç«äº‰ã€‚å®ƒçš„æ€æƒ³ä¹Ÿæ˜¯ç”¨ç©ºé—´æ¥æ¢æ—¶é—´ï¼›javaä¸­å¾ˆå¤šæ•°æ®ç»“æ„éƒ½æ˜¯é‡‡ç”¨è¿™ç§æ–¹æ³•æé«˜å¹¶å‘æ“ä½œçš„æ•ˆç‡ï¼Œæ¯”å¦‚ï¼š ConcurrentHashMapï¼š javaä¸­çš„ConcurrentHashMapåœ¨jdk1.8ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä½¿ç”¨ä¸€ä¸ªSegment æ•°ç»„ï¼šSegment&lt; K,V &gt;[] segments Segmentç»§æ‰¿è‡ªReenTrantLockï¼Œæ‰€ä»¥æ¯ä¸ªSegmentæ˜¯ä¸ªå¯é‡å…¥é”ï¼Œæ¯ä¸ªSegment æœ‰ä¸€ä¸ªHashEntry&lt; K,V &gt;æ•°ç»„ç”¨æ¥å­˜æ”¾æ•°æ®ï¼Œputæ“ä½œæ—¶ï¼Œå…ˆç¡®å®šå¾€å“ªä¸ªSegmentæ”¾æ•°æ®ï¼Œåªéœ€è¦é”å®šè¿™ä¸ªSegmentï¼Œæ‰§è¡Œputï¼Œå…¶å®ƒçš„Segmentä¸ä¼šè¢«é”å®šï¼›æ‰€ä»¥æ•°ç»„ä¸­æœ‰å¤šå°‘ä¸ªSegmentå°±å…è®¸åŒä¸€æ—¶åˆ»å¤šå°‘ä¸ªçº¿ç¨‹å­˜æ”¾æ•°æ®ï¼Œè¿™æ ·å¢åŠ äº†å¹¶å‘èƒ½åŠ›ã€‚ ã€3ã€‘é”ç²—åŒ–ï¼šâ€‹ å¤§éƒ¨åˆ†æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯è¦è®©é”çš„ç²’åº¦æœ€å°åŒ–ï¼Œé”çš„ç²—åŒ–åˆ™æ˜¯è¦å¢å¤§é”çš„ç²’åº¦; å‡å¦‚æœ‰ä¸€ä¸ªå¾ªç¯ï¼Œå¾ªç¯å†…çš„æ“ä½œéœ€è¦åŠ é”ï¼Œæˆ‘ä»¬åº”è¯¥æŠŠé”æ”¾åˆ°å¾ªç¯å¤–é¢ï¼Œå¦åˆ™æ¯æ¬¡è¿›å‡ºå¾ªç¯ï¼Œéƒ½è¿›å‡ºä¸€æ¬¡ä¸´ç•ŒåŒºï¼Œæ•ˆç‡æ˜¯éå¸¸å·®çš„ï¼› ã€4ã€‘ä½¿ç”¨è¯»å†™é”ï¼š ReentrantReadWriteLock æ˜¯ä¸€ä¸ªè¯»å†™é”ï¼Œè¯»æ“ä½œåŠ è¯»é”ï¼Œå¯å¹¶å‘è¯»ï¼Œå†™æ“ä½œä½¿ç”¨å†™é”ï¼Œåªèƒ½å•çº¿ç¨‹å†™ï¼› ã€5ã€‘ä½¿ç”¨CASï¼š å¦‚æœéœ€è¦åŒæ­¥çš„æ“ä½œæ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œå¹¶ä¸”çº¿ç¨‹ç«äº‰å¹¶ä¸æ¿€çƒˆï¼Œè¿™æ—¶å€™ä½¿ç”¨casæ•ˆç‡ä¼šæ›´é«˜ï¼Œå› ä¸ºåŠ é”ä¼šå¯¼è‡´çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¦‚æœä¸Šä¸‹æ–‡åˆ‡æ¢çš„è€—æ—¶æ¯”åŒæ­¥æ“ä½œæœ¬èº«æ›´è€—æ—¶ï¼Œä¸”çº¿ç¨‹å¯¹èµ„æºçš„ç«äº‰ä¸æ¿€çƒˆï¼Œä½¿ç”¨volatiled+casæ“ä½œä¼šæ˜¯éå¸¸é«˜æ•ˆçš„é€‰æ‹©ï¼› 6ã€ç³»ç»Ÿå±‚é¢é”ä¼˜åŒ–è‡ªé€‚åº”è‡ªæ—‹é”ï¼š è‡ªæ—‹é”å¯ä»¥é¿å…ç­‰å¾…ç«äº‰é”è¿›å…¥é˜»å¡æŒ‚èµ·çŠ¶æ€è¢«å”¤é†’é€ æˆçš„å†…æ ¸æ€å’Œç”¨æˆ·æ€ä¹‹é—´çš„åˆ‡æ¢çš„æŸè€—ï¼Œå®ƒä»¬åªéœ€è¦ç­‰ä¸€ç­‰ï¼ˆè‡ªæ—‹ï¼‰ï¼Œä½†æ˜¯å¦‚æœé”è¢«å…¶ä»–çº¿ç¨‹é•¿æ—¶é—´å ç”¨ï¼Œä¸€ç›´ä¸é‡Šæ”¾CPUï¼Œæ­»ç­‰ä¼šå¸¦æ¥æ›´å¤šçš„æ€§èƒ½å¼€é”€ï¼›è‡ªæ—‹æ¬¡æ•°é»˜è®¤å€¼æ˜¯10 å¯¹ä¸Šé¢è‡ªæ—‹é”ä¼˜åŒ–æ–¹å¼çš„è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå®ƒçš„è‡ªæ—‹çš„æ¬¡æ•°ä¸å†å›ºå®šï¼Œå…¶è‡ªæ—‹çš„æ¬¡æ•°ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šï¼Œè¿™å°±è§£å†³äº†è‡ªæ—‹é”å¸¦æ¥çš„ç¼ºç‚¹ é”æ¶ˆé™¤ï¼š é”å‰Šé™¤æ˜¯æŒ‡è™šæ‹Ÿæœºå³æ—¶ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶ï¼Œå¯¹ä¸€äº›ä»£ç ä¸Šè¦æ±‚åŒæ­¥ï¼Œä½†æ˜¯è¢«æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”è¿›è¡Œå‰Šé™¤ã€‚Nettyä¸­æ— é”åŒ–è®¾è®¡pipelineä¸­channelhandlerä¼šè¿›è¡Œé”æ¶ˆé™¤çš„ä¼˜åŒ–ã€‚ é”å‡çº§ï¼š åå‘é”ï¼š å¦‚æœçº¿ç¨‹å·²ç»å æœ‰è¿™ä¸ªé”ï¼Œå½“ä»–åœ¨æ¬¡è¯•å›¾å»è·å–è¿™ä¸ªé”çš„æ—¶å€™ï¼Œä»–ä¼šå·²æœ€å¿«çš„æ–¹å¼å»æ‹¿åˆ°è¿™ä¸ªé”ï¼Œè€Œä¸éœ€è¦åœ¨è¿›è¡Œä¸€äº›monitoræ“ä½œï¼Œå› ä¸ºåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯æ²¡æœ‰ç«äº‰çš„ï¼Œæ‰€ä»¥ä½¿ç”¨åå‘é”æ˜¯å¯ä»¥æé«˜æ€§èƒ½çš„ï¼› è½»é‡çº§é”ï¼š åœ¨ç«äº‰ä¸æ¿€çƒˆçš„æƒ…å†µä¸‹ï¼Œé€šè¿‡CASé¿å…çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¯ä»¥æ˜¾è‘—çš„æé«˜æ€§èƒ½ã€‚ é‡é‡çº§é”ï¼š é‡é‡çº§é”çš„åŠ é”ã€è§£é”è¿‡ç¨‹é€ æˆçš„æŸè€—æ˜¯å›ºå®šçš„ï¼Œé‡é‡çº§é”é€‚åˆäºç«äº‰æ¿€çƒˆã€é«˜å¹¶å‘ã€åŒæ­¥å—æ‰§è¡Œæ—¶é—´é•¿çš„æƒ…å†µã€‚ 7ã€ThreadLocalåŸç†ThreadLocalç®€ä»‹ï¼š é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å˜é‡æ˜¯å¯ä»¥è¢«ä»»ä½•â¼€ä¸ªçº¿ç¨‹è®¿é—®å¹¶ä¿®æ”¹çš„ã€‚å¦‚æœæƒ³å®ç°æ¯â¼€ä¸ªçº¿ç¨‹éƒ½æœ‰â¾ƒâ¼°çš„ä¸“å±æœ¬åœ°å˜é‡è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ JDKä¸­æä¾›çš„ ThreadLocal ç±»æ­£æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚ç±»ä¼¼æ“ä½œç³»ç»Ÿä¸­çš„TLAB åŸç†ï¼š é¦–å…ˆ ThreadLocal æ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼Œä¿è¯å¯ä»¥æ¥å—ä»»ä½•ç±»å‹çš„å¯¹è±¡ã€‚å› ä¸ºä¸€ä¸ªçº¿ç¨‹å†…å¯ä»¥å­˜åœ¨å¤šä¸ª ThreadLocal å¯¹è±¡ï¼Œæ‰€ä»¥å…¶å®æ˜¯ ThreadLocal å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Map ï¼Œæ˜¯ ThreadLocal å®ç°çš„ä¸€ä¸ªå«åš ThreadLocalMap çš„é™æ€å†…éƒ¨ç±»ã€‚ æœ€ç»ˆçš„å˜é‡æ˜¯æ”¾åœ¨äº†å½“å‰çº¿ç¨‹çš„ ThreadLocalMap ä¸­ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨ ThreadLocal ä¸Šï¼ŒThreadLocal å¯ä»¥ç†è§£ä¸ºåªæ˜¯ThreadLocalMapçš„å°è£…ï¼Œä¼ é€’äº†å˜é‡å€¼ã€‚ æˆ‘ä»¬ä½¿ç”¨çš„ get()ã€set() æ–¹æ³•å…¶å®éƒ½æ˜¯è°ƒç”¨äº†è¿™ä¸ªThreadLocalMapç±»å¯¹åº”çš„ get()ã€set() æ–¹æ³•ã€‚ä¾‹å¦‚ä¸‹é¢çš„ å¦‚ä½•ä½¿ç”¨ï¼š 1ï¼‰å­˜å‚¨ç”¨æˆ·Session 1private static final ThreadLocal threadSession = new ThreadLocal(); 2ï¼‰è§£å†³çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ 1private static ThreadLocal&lt;SimpleDateFormat&gt; format1 = new ThreadLocal&lt;SimpleDateFormat&gt;() ThreadLocalå†…å­˜æ³„æ¼çš„åœºæ™¯ å®é™…ä¸Š ThreadLocalMap ä¸­ä½¿ç”¨çš„ key ä¸º ThreadLocal çš„å¼±å¼•ç”¨ï¼Œâ½½ value æ˜¯å¼ºå¼•â½¤ã€‚å¼±å¼•ç”¨çš„ç‰¹ç‚¹æ˜¯ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡æŒæœ‰å¼±å¼•ç”¨ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶çš„æ—¶å€™å¿…ç„¶ä¼šè¢«æ¸…ç†æ‰ã€‚ æ‰€ä»¥å¦‚æœ ThreadLocal æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ä¼šè¢«æ¸…ç†æ‰çš„ï¼Œè¿™æ ·ä¸€æ¥ ThreadLocalMapä¸­ä½¿ç”¨è¿™ä¸ª ThreadLocal çš„ key ä¹Ÿä¼šè¢«æ¸…ç†æ‰ã€‚ä½†æ˜¯ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ï¼Œä¸ä¼šè¢«æ¸…ç†ï¼Œè¿™æ ·ä¸€æ¥å°±ä¼šå‡ºç° key ä¸º null çš„ valueã€‚ å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œvalue æ°¸è¿œâ½†æ³•è¢«GC å›æ”¶ï¼Œå¦‚æœçº¿ç¨‹é•¿æ—¶é—´ä¸è¢«é”€æ¯ï¼Œå¯èƒ½ä¼šäº§â½£å†…å­˜æ³„éœ²ã€‚ ThreadLocalMapå®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œåœ¨è°ƒç”¨ set()ã€get()ã€remove() æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ key ä¸º null çš„è®°å½•ã€‚å¦‚æœè¯´ä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼Œé‚£åªæœ‰åœ¨å‡ºç°äº† key ä¸º null çš„è®°å½•åï¼Œæ²¡æœ‰æ‰‹åŠ¨è°ƒç”¨ remove() æ–¹æ³•ï¼Œå¹¶ä¸”ä¹‹åä¹Ÿä¸å†è°ƒç”¨ get()ã€set()ã€remove() æ–¹æ³•çš„æƒ…å†µä¸‹ã€‚å› æ­¤ä½¿â½¤å®ŒThreadLocal â½…æ³•åï¼Œæœ€å¥½â¼¿åŠ¨è°ƒâ½¤ remove() â½…æ³•ã€‚ 8ã€HashMapçº¿ç¨‹å®‰å…¨ æ­»å¾ªç¯é€ æˆ CPU 100% HashMap æœ‰å¯èƒ½ä¼šå‘ç”Ÿæ­»å¾ªç¯å¹¶ä¸”é€ æˆ CPU 100% ï¼Œè¿™ç§æƒ…å†µå‘ç”Ÿæœ€ä¸»è¦çš„åŸå› å°±æ˜¯åœ¨æ‰©å®¹çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨æ–°å»ºæ–°çš„ HashMap çš„æ—¶å€™ï¼Œæ‰©å®¹çš„é€»è¾‘ä¼šåè½¬æ•£åˆ—æ¡¶ä¸­çš„èŠ‚ç‚¹é¡ºåºï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ï¼Œç”±äº HashMap å¹¶éçº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶åè½¬çš„è¯ï¼Œä¾¿å¯èƒ½å½¢æˆä¸€ä¸ªå¾ªç¯ï¼Œå¹¶ä¸”è¿™ç§å¾ªç¯æ˜¯é“¾è¡¨çš„å¾ªç¯ï¼Œç›¸å½“äº A èŠ‚ç‚¹æŒ‡å‘ B èŠ‚ç‚¹ï¼ŒB èŠ‚ç‚¹åˆæŒ‡å›åˆ° A èŠ‚ç‚¹ï¼Œè¿™æ ·ä¸€æ¥ï¼Œåœ¨ä¸‹ä¸€æ¬¡æƒ³è¦è·å–è¯¥ key æ‰€å¯¹åº”çš„ value çš„æ—¶å€™ï¼Œä¾¿ä¼šåœ¨éå†é“¾è¡¨çš„æ—¶å€™å‘ç”Ÿæ°¸è¿œæ— æ³•éå†ç»“æŸçš„æƒ…å†µï¼Œä¹Ÿå°±å‘ç”Ÿ CPU 100% çš„æƒ…å†µã€‚ æ‰€ä»¥ç»¼ä¸Šæ‰€è¿°ï¼ŒHashMap æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œåœ¨å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯ä¸­æ¨èä½¿ç”¨çº¿ç¨‹å®‰å…¨åŒæ—¶æ€§èƒ½æ¯”è¾ƒå¥½çš„ ConcurrentHashMapã€‚ 9ã€Stringä¸å¯å˜åŸå›  å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¤šæ¬¡åˆ›å»ºåŒæ ·çš„å­—ç¬¦ä¸²ä¼šæŒ‡å‘åŒä¸€ä¸ªå†…å­˜åœ°å€ å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç”¨ä½œ HashMap çš„ keyã€‚é€šå¸¸å»ºè®®æŠŠä¸å¯å˜å¯¹è±¡ä½œä¸º HashMapçš„ key hashCodeç”Ÿæˆåå°±ä¸ä¼šæ”¹å˜ï¼Œä½¿ç”¨æ—¶æ— éœ€é‡æ–°è®¡ç®— çº¿ç¨‹å®‰å…¨ï¼Œå› ä¸ºå…·å¤‡ä¸å˜æ€§çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ å†…å­˜æ¨¡å‹ Java å†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰å°±æ˜¯ä¸€ç§ç¬¦åˆå†…å­˜æ¨¡å‹è§„èŒƒçš„ï¼Œå±è”½äº†å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„è®¿é—®å·®å¼‚çš„ï¼Œä¿è¯äº† Java ç¨‹åºåœ¨å„ç§å¹³å°ä¸‹å¯¹å†…å­˜çš„è®¿é—®éƒ½èƒ½ä¿è¯æ•ˆæœä¸€è‡´çš„æœºåˆ¶åŠè§„èŒƒã€‚ JMM æ˜¯ä¸€ç§è§„èŒƒï¼Œæ˜¯è§£å†³ç”±äºå¤šçº¿ç¨‹é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡æ—¶ï¼Œå­˜åœ¨çš„æœ¬åœ°å†…å­˜æ•°æ®ä¸ä¸€è‡´ã€ç¼–è¯‘å™¨ä¼šå¯¹ä»£ç æŒ‡ä»¤é‡æ’åºã€å¤„ç†å™¨ä¼šå¯¹ä»£ç ä¹±åºæ‰§è¡Œç­‰å¸¦æ¥çš„é—®é¢˜ã€‚ç›®çš„æ˜¯ä¿è¯å¹¶å‘ç¼–ç¨‹åœºæ™¯ä¸­çš„åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ã€‚ åŸå­æ€§ï¼š åœ¨ Java ä¸­ï¼Œä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œæä¾›äº†ä¸¤ä¸ªé«˜çº§çš„å­—èŠ‚ç æŒ‡ä»¤ Monitorenter å’Œ Monitorexitã€‚è¿™ä¸¤ä¸ªå­—èŠ‚ç ï¼Œåœ¨ Java ä¸­å¯¹åº”çš„å…³é”®å­—å°±æ˜¯ Synchronizedã€‚å› æ­¤ï¼Œåœ¨ Java ä¸­å¯ä»¥ä½¿ç”¨ Synchronized æ¥ä¿è¯æ–¹æ³•å’Œä»£ç å—å†…çš„æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚ å¯è§æ€§ï¼š Java ä¸­çš„ Volatile å…³é”®å­—ä¿®é¥°çš„å˜é‡åœ¨è¢«ä¿®æ”¹åå¯ä»¥ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜ã€‚è¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨æ¯æ¬¡ä½¿ç”¨ä¹‹å‰éƒ½ä»ä¸»å†…å­˜åˆ·æ–°ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨ Volatile æ¥ä¿è¯å¤šçº¿ç¨‹æ“ä½œæ—¶å˜é‡çš„å¯è§æ€§ã€‚é™¤äº† Volatileï¼ŒJava ä¸­çš„ Synchronized å’Œ Final ä¸¤ä¸ªå…³é”®å­—ä¹Ÿå¯ä»¥å®ç°å¯è§æ€§ã€‚åªä¸è¿‡å®ç°æ–¹å¼ä¸åŒ æœ‰åºæ€§ åœ¨ Java ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ Synchronized å’Œ Volatile æ¥ä¿è¯å¤šçº¿ç¨‹ä¹‹é—´æ“ä½œçš„æœ‰åºæ€§ã€‚åŒºåˆ«ï¼šVolatile ç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚Synchronized ä¿è¯åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹æ“ä½œã€‚ 1ã€volatileåº•å±‚å®ç°ä½œç”¨ï¼š ä¿è¯æ•°æ®çš„â€œå¯è§æ€§â€ï¼šè¢«volatileä¿®é¥°çš„å˜é‡èƒ½å¤Ÿä¿è¯æ¯ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å–è¯¥å˜é‡çš„æœ€æ–°å€¼ï¼Œä»è€Œé¿å…å‡ºç°æ•°æ®è„è¯»çš„ç°è±¡ã€‚ ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼šåœ¨å¤šçº¿ç¨‹æ“ä½œæƒ…å†µä¸‹ï¼ŒæŒ‡ä»¤é‡æ’ä¼šå¯¼è‡´è®¡ç®—ç»“æœä¸ä¸€è‡´ åº•å±‚å®ç°ï¼š â€œè§‚å¯ŸåŠ å…¥volatileå…³é”®å­—å’Œæ²¡æœ‰åŠ å…¥volatileå…³é”®å­—æ—¶æ‰€ç”Ÿæˆçš„æ±‡ç¼–ä»£ç å‘ç°ï¼ŒåŠ å…¥volatileå…³é”®å­—æ—¶ï¼Œä¼šå¤šå‡ºä¸€ä¸ªlockå‰ç¼€æŒ‡ä»¤â€ lockå‰ç¼€æŒ‡ä»¤å®é™…ä¸Šç›¸å½“äºä¸€ä¸ªå†…å­˜å±éšœï¼ˆä¹Ÿæˆå†…å­˜æ …æ ï¼‰ï¼Œå†…å­˜å±éšœä¼šæä¾›3ä¸ªåŠŸèƒ½ï¼š 1ï¼‰å®ƒç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ä¸ä¼šæŠŠå…¶åé¢çš„æŒ‡ä»¤æ’åˆ°å†…å­˜å±éšœä¹‹å‰çš„ä½ç½®ï¼Œä¹Ÿä¸ä¼šæŠŠå‰é¢çš„æŒ‡ä»¤æ’åˆ°å†…å­˜å±éšœçš„åé¢ï¼› 2ï¼‰å®ƒä¼šå¼ºåˆ¶å°†å¯¹ç¼“å­˜çš„ä¿®æ”¹æ“ä½œç«‹å³å†™å…¥ä¸»å­˜ï¼› 3ï¼‰å¦‚æœæ˜¯å†™æ“ä½œï¼Œå®ƒä¼šå¯¼è‡´å…¶ä»–CPUä¸­å¯¹åº”çš„ç¼“å­˜è¡Œæ— æ•ˆã€‚ å•ä¾‹æ¨¡å¼ä¸­volatileçš„ä½œç”¨ï¼š é˜²æ­¢ä»£ç è¯»å–åˆ°instanceä¸ä¸ºnullæ—¶ï¼Œinstanceå¼•ç”¨çš„å¯¹è±¡æœ‰å¯èƒ½è¿˜æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ã€‚ 1class Singleton{ private volatile static Singleton instance = null; //ç¦æ­¢æŒ‡ä»¤é‡æ’ private Singleton() { } public static Singleton getInstance() { if(instance==null) { //å‡å°‘åŠ é”çš„æŸè€— synchronized (Singleton.class) { if(instance==null) //ç¡®è®¤æ˜¯å¦åˆå§‹åŒ–å®Œæˆ instance = new Singleton(); } } return instance; }} 2ã€AQSæ€æƒ³ AQSçš„å…¨ç§°ä¸ºï¼ˆAbstractQueuedSynchronizerï¼‰æŠ½è±¡çš„é˜Ÿåˆ—å¼çš„åŒæ­¥å™¨ï¼Œæ˜¯â¼€ä¸ªâ½¤æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨çš„æ¡†æ¶ï¼Œä½¿â½¤AQSèƒ½ç®€å•ä¸”â¾¼æ•ˆåœ°æ„é€ å‡ºåº”â½¤â¼´æ³›çš„â¼¤é‡çš„åŒæ­¥å™¨ï¼Œå¦‚ï¼šåŸºäºAQSå®ç°çš„lock, CountDownLatchã€CyclicBarrierã€Semaphoreéœ€è§£å†³çš„é—®é¢˜ï¼š 1çŠ¶æ€çš„åŸå­æ€§ç®¡ç†çº¿ç¨‹çš„é˜»å¡ä¸è§£é™¤é˜»å¡é˜Ÿåˆ—çš„ç®¡ç† AQSæ ¸â¼¼æ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„â¼¯ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å â½¤ï¼Œé‚£ä¹ˆå°±éœ€è¦â¼€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶AQSæ˜¯â½¤CLHï¼ˆè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—ï¼‰é˜Ÿåˆ—é”å®ç°çš„ï¼Œå³å°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ â¼Šåˆ°é˜Ÿåˆ—ä¸­ã€‚ lockï¼š æ˜¯ä¸€ç§å¯é‡å…¥é”ï¼Œé™¤äº†èƒ½å®Œæˆ synchronized æ‰€èƒ½å®Œæˆçš„æ‰€æœ‰å·¥ä½œå¤–ï¼Œè¿˜æä¾›äº†è¯¸å¦‚å¯å“åº”ä¸­æ–­é”ã€å¯è½®è¯¢é”è¯·æ±‚ã€å®šæ—¶é”ç­‰é¿å…å¤šçº¿ç¨‹æ­»é”çš„æ–¹æ³•ã€‚é»˜è®¤ä¸ºéå…¬å¹³é”ï¼Œä½†å¯ä»¥åˆå§‹åŒ–ä¸ºå…¬å¹³é”ï¼› é€šè¿‡æ–¹æ³• lock()ä¸ unlock()æ¥è¿›è¡ŒåŠ é”ä¸è§£é”æ“ä½œï¼› CountDownLatchï¼š é€šè¿‡è®¡æ•°æ³•ï¼ˆå€’è®¡æ—¶å™¨ï¼‰ï¼Œè®©ä¸€äº›çº¿ç¨‹å µå¡ç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹å®Œæˆä¸€ç³»åˆ—æ“ä½œåæ‰è¢«å”¤é†’ï¼›è¯¥â¼¯å…·é€šå¸¸â½¤æ¥æ§åˆ¶çº¿ç¨‹ç­‰å¾…ï¼Œå®ƒå¯ä»¥è®©æŸâ¼€ä¸ªçº¿ç¨‹ç­‰å¾…ç›´åˆ°å€’è®¡æ—¶ç»“æŸï¼Œå†å¼€å§‹æ‰§â¾ã€‚å…·ä½“å¯ä»¥ä½¿ç”¨countDownLatch.await()æ¥ç­‰å¾…ç»“æœã€‚å¤šç”¨äºå¤šçº¿ç¨‹ä¿¡æ¯æ±‡æ€»ã€‚ CompletableFutureï¼š é€šè¿‡è®¾ç½®å‚æ•°ï¼Œå¯ä»¥å®ŒæˆCountDownLatchåŒæ ·çš„å¤šå¹³å°å“åº”é—®é¢˜ï¼Œä½†æ˜¯å¯ä»¥é’ˆå¯¹å…¶ä¸­éƒ¨åˆ†è¿”å›ç»“æœåšæ›´åŠ çµæ´»çš„å±•ç¤ºã€‚ CyclicBarrierï¼š å­—é¢æ„æ€æ˜¯å¯å¾ªç¯(Cyclic)ä½¿ç”¨çš„å±éšœï¼ˆBarrierï¼‰ã€‚ä»–è¦åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ï¼Œçº¿ç¨‹è¿›å…¥å±éšœé€šè¿‡CyclicBarrierçš„await()æ–¹æ³•ã€‚å¯ä»¥ç”¨äºæ‰¹é‡å‘é€æ¶ˆæ¯é˜Ÿåˆ—ä¿¡æ¯ã€å¼‚æ­¥é™æµã€‚ Semaphoreï¼š ä¿¡å·é‡ä¸»è¦ç”¨äºä¸¤ä¸ªç›®çš„ï¼Œä¸€ä¸ªæ˜¯ç”¨äºå¤šä¸ªå…±äº«èµ„æºçš„äº’æ–¥ä½œç”¨ï¼Œå¦ä¸€ä¸ªç”¨äºå¹¶å‘çº¿ç¨‹æ•°çš„æ§åˆ¶ã€‚SpringHystrixé™æµçš„æ€æƒ³ 3ã€happens-before ç”¨æ¥æè¿°å’Œå¯è§æ€§ç›¸å…³é—®é¢˜ï¼šå¦‚æœç¬¬ä¸€ä¸ªæ“ä½œ happens-before ç¬¬äºŒä¸ªæ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯´ç¬¬ä¸€ä¸ªæ“ä½œå¯¹äºç¬¬äºŒä¸ªæ“ä½œæ˜¯å¯è§çš„ å¸¸è§çš„happens-beforeï¼švolatile ã€é”ã€çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸã€‚","link":"/2022/07/05/Full-QA/"},{"title":"mmkv","text":"MMKV æ˜¯åŸºäº mmap å†…å­˜æ˜ å°„çš„ key-value ç»„ä»¶ï¼Œåº•å±‚åºåˆ—åŒ–/ååºåˆ—åŒ–ä½¿ç”¨ protobuf å®ç°ï¼Œæ€§èƒ½é«˜ï¼Œç¨³å®šæ€§å¼ºã€‚å¤šè¿›ç¨‹åŒæ­¥å®ç°æ˜¯ä¾é æ–‡ä»¶é” Android å­˜å‚¨ä¼˜åŒ– â€”â€” MMKV é›†æˆä¸åŸç† - æ˜é‡‘ (juejin.cn) design Â· Tencent/MMKV Wiki (github.com) android_ipc Â· Tencent/MMKV Wiki (github.com) ä¸€äº›å¯¹æ¯”ï¼š è™½ç„¶ MMKV ä¸€äº›åœºæ™¯ä¸‹æ¯” SP ç¨æ…¢(å¦‚: é¦–æ¬¡å®ä¾‹åŒ–ä¼šè¿›è¡Œæ•°æ®çš„å¤å†™å‰”é™¤é‡å¤æ•°æ®, æ¯” SP ç¨æ…¢, æŸ¥è¯¢æ•°æ®æ—¶å­˜åœ¨ ProtocolBuffer è§£ç , æ¯” SP ç¨æ…¢), ä½†å…¶é€†å¤©çš„æ•°æ®å†™å…¥é€Ÿåº¦ã€mmap Linux å†…æ ¸ä¿è¯æ•°æ®çš„åŒæ­¥, ä»¥åŠ ProtocolBuffer ç¼–ç å¸¦æ¥çš„æ›´å°çš„æœ¬åœ°å­˜å‚¨ç©ºé—´å ç”¨ç­‰éƒ½æ˜¯éå¸¸æ£’çš„é—ªå…‰ç‚¹ mmapï¼š å®˜æ–¹ç®€è¿°ï¼šMMKV æœ¬è´¨ä¸Šæ˜¯å°†æ–‡ä»¶ mmap åˆ°å†…å­˜å—ä¸­ï¼Œå°†æ–°å¢çš„ key-value ç»Ÿç»Ÿ append åˆ°å†…å­˜ä¸­ï¼›åˆ°è¾¾è¾¹ç•Œåï¼Œè¿›è¡Œé‡æ•´å›å†™ä»¥è…¾å‡ºç©ºé—´ï¼Œç©ºé—´è¿˜æ˜¯ä¸å¤Ÿçš„è¯ï¼Œå°± double å†…å­˜ç©ºé—´ï¼›å¯¹äºå†…å­˜æ–‡ä»¶ä¸­å¯èƒ½å­˜åœ¨çš„é‡å¤é”®å€¼ï¼ŒMMKV åªé€‰ç”¨æœ€åå†™å…¥çš„ä½œä¸ºæœ‰æ•ˆé”®å€¼ã€‚ ProtocolBuffer: å¤šè¿›ç¨‹åŒæ­¥ï¼š MMKV æ˜¯é‡‡ç”¨ æ–‡ä»¶é” çš„æ–¹å¼æ¥è¿›è¡Œè¿›ç¨‹é—´çš„åŒæ­¥æ“ä½œ LOCK_SH(å…±äº«é”): å¤šä¸ªè¿›ç¨‹å¯ä»¥ä½¿ç”¨åŒä¸€æŠŠé”, å¸¸è¢«ç”¨ä½œè¯»å…±äº«é” LOCK_EX(æ’ä»–é”): åŒæ—¶åªå…è®¸ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨, å¸¸è¢«ç”¨ä½œå†™é” LOCK_UN: é‡Šæ”¾é”","link":"/2021/10/28/Mmkv/"},{"title":"okhttp","text":"é“¾æ¥ï¼šhttps://juejin.cn/post/6887896333685161992 ç®€è¿°ï¼š é€šè¿‡å¯¹å¤–æä¾›çš„OkHttpClientå’ŒRequestçš„builderå®ç°åŸºç¡€ä¿¡æ¯å’Œå¿…è¦ä¿¡æ¯çš„é…ç½®ï¼Œç›´åˆ°å°è£…æ„å»ºæˆäº†RealCallå¯¹è±¡ï¼ˆRealCall implement Callï¼‰å¹¶æ–°å»ºCallBackå®ä¾‹ä¼ å…¥realCall.equeue(callback)ï¼Œæ‰çœŸæ­£å®Œæˆäº†è¯·æ±‚å®ä½“çš„å®ä¾‹åŒ–ã€‚ ä¹‹årealCall.enqueue(call)æ–¹æ³•çš„è°ƒç”¨æ‰æ˜¯å®é™…ä¸Šå¼€å§‹è¿›è¡Œè¯·æ±‚ï¼šå…ˆåˆ¤æ–­æ˜¯å¦callå·²ç»æ‰§è¡Œè¿‡äº†ï¼ˆexecuted = AtomicBoolean()ï¼‰ï¼Œè‹¥æœªæ‰§è¡Œåˆ™ç»§ç»­ ä¹‹åç”±Dispatcherè°ƒç”¨enqueueè¿›è¡Œåˆ¤æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„è¯·æ±‚æ•°åŠå½“å‰ç½‘ç»œè¯·æ±‚çš„ä¸»æœºæ•°æ˜¯å¦è¶…è¿‡äº†æœ€å¤§å€¼ã€‚è¦æ˜¯è¶…è¿‡äº†æœ€å¤§å€¼ï¼Œå°±å°†è¯·æ±‚æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œè¦æ˜¯æ²¡è¶…è¿‡ï¼Œå°±æ”¾åˆ°æ­£åœ¨æ‰§è¡Œçš„é˜Ÿåˆ—ä¸­ï¼Œç„¶åè°ƒç”¨çº¿ç¨‹æ± ï¼ˆé»˜è®¤å•ä¾‹åˆå§‹åŒ–äº†ä¸€ä¸ªç¼“å­˜çº¿ç¨‹æ± (å³æ— æ ¸å¿ƒçº¿ç¨‹ã€æ— é™çº¿ç¨‹æ± æ•°é‡ã€SynchronousQueue)ï¼‰æ‰§è¡Œå®ƒè°ƒåº¦ï¼Œæ‰§è¡Œçš„è¿‡ç¨‹ä¹Ÿå°±æ˜¯asyncCallçš„run()æ–¹æ³•é€šè¿‡è´£ä»»é“¾äº”å¤§æ‹¦æˆªå™¨è¿›è¡Œå±‚å±‚å¤„ç†çš„è¿‡ç¨‹ã€‚ å¦‚ RetryAndFollowUpInterceptoræ˜¯åœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­è¿›è¡Œæœ€å¤§æ¬¡æ•°ä¸º20(MAX_FOLLOW_UPS)çš„é‡è¯•ï¼ˆè¶…è¿‡æŠ›ProtocolException(â€œToo many follow-up requests: $followUpCountâ€)ï¼‰, æ¯æ¬¡é‡è¯•æ ¹æ®ä¸åŒçš„responseCodeè¿›è¡Œè¡¥å¿ã€æ¯”å¦‚30xï¼ˆé™¤304å¤–ï¼Œ304ä¸ºåå•†ç¼“å­˜ï¼‰è¿›è¡Œé‡å®šå‘ï¼Œ503ã€‘ï¼Œå¯¹äºä¸å¿…è¦çš„æƒ…å†µä¹Ÿä¼šç›´æ¥ç»ˆæ­¢(HTTP_CLIENT_TIMEOUT 408)ã€‚ CacheInterceptoræ˜¯å½“è¯·æ±‚å‘èµ·æ—¶ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼ˆå¼ºåˆ¶ç¼“å­˜æˆ–åå•†ç¼“å­˜ï¼‰ï¼Œæ— å‘½ä¸­ç¼“å­˜æˆ–ç¼“å­˜å¤±æ•ˆï¼Œåˆ™å°†è¯·æ±‚å‘ä¸‹ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ã€‚ è·å¾—äº†å“åº”æ•°æ®åï¼Œæ£€æŸ¥å“åº”å¤´çš„Cache-Controlï¼ŒExpiresï¼Œno-storeä¸å­˜å‚¨ï¼Œimmutableç­‰åˆ¤æ–­æ˜¯å¦å†™å…¥ç¼“å­˜ ç”¨äº† è´£ä»»é“¾è®¾è®¡æ¨¡å¼ ,å®ƒå°†è¯·æ±‚ä¸€å±‚ä¸€å±‚å‘ä¸‹ä¼ ï¼Œç›´åˆ°æœ‰ä¸€å±‚èƒ½å¤Ÿå¾—åˆ°Resposneå°±åœæ­¢å‘ä¸‹ä¼ é€’ï¼Œå¹¶ Response å‘ä¸Šé¢çš„æ‹¦æˆªå™¨ä¼ é€’ï¼Œç„¶åå„ä¸ªæ‹¦æˆªå™¨ä¼šå¯¹ respone è¿›è¡Œä¸€äº›å¤„ç†ï¼Œæœ€åä¼šä¼ åˆ° RealCall ç±»ä¸­é€šè¿‡ execute æ¥å¾—åˆ° Response ã€‚ 3.1.1 é€šè¿‡ OkHttpClient å®ä¾‹åŒ– åˆå§‹åŒ–æˆ‘ä»¬éœ€è¦åˆå§‹åŒ–çš„ httpè¿æ¥åè®® ä»£ç†åœ°å€ ç¼“å­˜æ§åˆ¶ Cookie è¯ä¹¦è¿æ¥ ä»£ç†é€‰æ‹©å™¨ç­‰ 3.1.2 é€šè¿‡ Request Builderæ¨¡å¼ æ‹¿åˆ°æˆ‘ä»¬ä¼ å…¥çš„ url method Headers RequestBody ä»¥åŠ tags åœ¨ OkHttpClient æˆ‘ä»¬ç”¨RealCallæ¥å£å›è°ƒæ‰§è¡ŒDispacherçš„ å›è°ƒå®ç°,å…¥: equeqe(åŒæ­¥) ennque(å¼‚æ­¥è¯·æ±‚) å…¶ä¸­ Dispacher çš„åŒæ­¥è¯·æ±‚ æ˜¯ å°†æˆ‘ä»¬çš„è¯·æ±‚å¡åˆ°åŒæ­¥é˜Ÿåˆ—é‡Œé¢,è¿™ä¸ªæœ‰å¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ ennque(å¼‚æ­¥è¯·æ±‚) æ˜¯ ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ ä¼šå°†æ»¡è¶³ å°äºå¹¶å‘64 åŒhostè¯·æ±‚å°äº4 çš„è¯·æ±‚å¡åˆ°æˆ‘ä»¬çš„ è¿è¡Œé˜Ÿåˆ—é‡Œé¢ æ‰§è¡Œ,ä¸æ»¡è¶³è¯¥æ¡ä»¶æ”¾åˆ° ç­‰å¾…é˜Ÿåˆ—é‡Œé¢ ç„¶åäº¤ç»™çº¿ç¨‹æ±  å»æ‰§è¡Œå…·ä½“è¯·æ±‚äº‹å®œ ,æ‹¿åˆ°å“åº”å 3.1.3 æˆ‘ä»¬ ä¼šå°† å“åº” é€šè¿‡ getResourceChainPain é€šè¿‡æ‹¦æˆªå™¨ç½‘ä¸‹é€ä¼ åˆ° é‡å®šå‘æ‹¦æˆªå™¨, æ¡¥æ‹¦æˆªå™¨ ,ç¼“å­˜æ‹¦æˆªå™¨ ,è¿æ¥æ± æ‹¦æˆªå™¨,ç½‘ç»œæ‹¦æˆªå™¨,è¯·æ±‚æ‹¦æˆªå™¨ å¦‚æœä¸­é—´æœ‰è¢«æ‹¦æˆª,å°±è¿›è¡Œä¸€ç³»åˆ—çš„æ‹¦æˆªå¤„ç†,è¿½é’Ÿä¼šè¿”å›æˆ‘ä»¬å®¢æˆ·ç«¯,æˆ‘ä»¬å®¢æˆ·ç«¯å†é€šè¿‡ Response å»è§£æ code message Header ReponseBody è¿™äº›å‚æ•°ä¿¡æ¯ ä»£ç è§£æï¼šä¸€ï¼šæ„å»ºrealCall1ã€2ã€3æ­¥å…¶å®éƒ½æ˜¯åŸºç¡€ä¿¡æ¯å’Œå¿…è¦ä¿¡æ¯çš„é…ç½®ï¼ŒåŸºæœ¬ç”¨æ„å»ºè€…æ¨¡å¼æ¥å®Œæˆï¼Œç›´åˆ°æœ€åæ„å»ºæˆäº†realCallï¼Œæ‰çœŸæ­£å®Œæˆäº†è¯·æ±‚å®ä½“ï¼Œä¹‹årealCall.enqueueæ–¹æ³•çš„è°ƒç”¨æ‰æ˜¯å®é™…ä¸Šå¼€å§‹ä¸ºè¯·æ±‚è°ƒåº¦çº¿ç¨‹ï¼Œå¼€å§‹é€šè¿‡è´£ä»»é“¾ä¸€èŠ‚èŠ‚çš„å¤„ç†è¯·æ±‚å‘èµ·ã€‚ äºŒï¼šå°è£…CallBackæˆAsyncCallï¼Œé€šè¿‡dispatcher.equeueè°ƒåº¦åœ¨call.enqueue(new Callback(){ â€¦ }) æ‰§è¡Œä¹‹åï¼Œé¦–å…ˆåšçš„æ˜¯ 1. è°ƒç”¨RealCall.enqueue()æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰callæ˜¯å¦å·²ç»è¢«æ‰§è¡Œè¿‡äº†ï¼Œè¢«æ‰§è¡Œè¿‡äº†ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœæ²¡æœ‰æ‰§è¡Œè¿‡ï¼Œå°±å…ˆå°†callbackå°è£…æˆAsyncCallï¼Œç„¶åè°ƒç”¨dispatcher.enqueue()æ–¹æ³•ï¼ˆdispatcherè°ƒåº¦å™¨ï¼Œåœ¨okHttpClienté‡Œé¢åˆ›å»ºçš„ï¼‰ 2. åœ¨dispatcher.enqueue()æ–¹æ³•ä¸­ï¼Œåˆ¤æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„è¯·æ±‚æ•°åŠå½“å‰ç½‘ç»œè¯·æ±‚çš„ä¸»æœºæ•°æ˜¯å¦è¶…è¿‡äº†æœ€å¤§å€¼ã€‚è¦æ˜¯è¶…è¿‡äº†æœ€å¤§å€¼ï¼Œå°±å°†è¯·æ±‚æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œè¦æ˜¯æ²¡è¶…è¿‡ï¼Œå°±æ”¾åˆ°æ­£åœ¨æ‰§è¡Œçš„é˜Ÿåˆ—ä¸­ï¼Œç„¶åè°ƒç”¨çº¿ç¨‹æ± æ‰§è¡Œå®ƒã€‚ ä¸‰ .realcallçš„å¼‚æ­¥è¯·æ±‚çš„æ‰§è¡Œé€šè¿‡getResponseWithInterceptorChain()è´£ä»»é“¾å¤„ç†å¹¶æœ€ç»ˆå‘èµ·è¯·æ±‚æ¥æ”¶å¤„ç†å›è°ƒ 1 executorService.executeåƒè¿‡äº†åˆé¥­ï¼Œç»§ç»­åˆ†ææºç ï¼Œæ‰¿æ¥ä¸Šæ–‡ï¼Œæˆ‘ä»¬åˆ†æåˆ°äº†ï¼Œå¦‚æœç¬¦åˆæ¡ä»¶ï¼Œå°±ç”¨çº¿ç¨‹æ± å»æ‰§è¡Œå®ƒï¼Œä¹Ÿå°±æ˜¯è¿™å¥ 1executorService().execute(call); çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„çº¿ç¨‹æ±  12345678910111213141516public synchronized ExecutorService executorService() { if (executorService == null) { 1.executorService = new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(&quot;OkHttp Dispatcher&quot;, false)); } return executorService;}//å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªç¼“å­˜çº¿ç¨‹æ± ï¼Œä½†æ˜¯ç”±äºdispatcherçš„enqueueä¸­å·²ç»å¯¹è¯·æ±‚æ•°åšäº†é™å®šï¼Œæ•…ä¸ä¼šç”±å¤ªå¤§çš„æ€§èƒ½è´Ÿæ‹…ã€‚//æ— æ ¸å¿ƒçº¿ç¨‹ã€MAX_VALUEä¸ªæœ€å¤§çº¿ç¨‹ã€é—²ç½®60ç§’å›æ”¶ã€‚//Excutors.classpublic static ExecutorService newCachedThreadPool() { return new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;()); } æ— æ ¸å¿ƒçº¿ç¨‹ã€MAX_VALUEä¸ªæœ€å¤§çº¿ç¨‹ã€éæ ¸å¿ƒçº¿ç¨‹é—²ç½®60ç§’å›æ”¶ã€‚äºdispatcherçš„enqueueä¸­å·²ç»å¯¹è¯·æ±‚æ•°åšäº†é™å®šï¼Œæ•…ä¸ä¼šç”±å¤ªå¤§çš„æ€§èƒ½è´Ÿæ‹…ã€‚ å¥½ï¼Œç»§ç»­å†çœ‹ä¸‹çº¿ç¨‹æ± executorService.execute(call)æ–¹æ³• å®ƒä¼šæ‰§è¡Œé‡Œé¢callæ–¹æ³•çš„run()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯AsyncCallçš„runæ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†execute()ï¼Œè¯¥æ–¹æ³•ç”±å­ç±»å®ç°ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†AsyncCall.execute() ç®€å•æ¥è¯´ï¼Œå°±æ˜¯executorService.execute(call) -&gt; AsyncCall.run() -&gt; AsyncCall.execute() çœ‹åˆ°è¿™ä¸ªå†™æ³•ï¼Œå†…å¿ƒä¸­å°±æƒ³åæ§½ä¸€å¥è¯ï¼ŒçœŸé¸¡å„¿ç§€ï¼ æ¥ç»§ç»­çœ‹ä¸‹ï¼ŒAsyncCall.execute() 2 AsyncCall.execute()çœ‹æºç  æ–‡ä»¶ä½ç½®ï¼šrealcall.java 1234567891011121314151617181920212223@Overrideprotected void execute() { boolean signalledCallback = false; try { 1.Response response = getResponseWithInterceptorChain(); 2.if (retryAndFollowUpInterceptor.isCanceled()) { signalledCallback = true; responseCallback.onFailure(RealCall.this, new IOException(&quot;Canceled&quot;)); } else { signalledCallback = true; 3.responseCallback.onResponse(RealCall.this, response); } } catch (IOException e) { if (signalledCallback) { // Do not signal the callback twice! Platform.get().log(INFO, &quot;Callback failure for &quot; + toLoggableString(), e); } else { responseCallback.onFailure(RealCall.this, e); } } finally { 4.client.dispatcher().finished(this); } } æ‰§è¡Œæ‹¦æˆªå™¨é“¾ï¼Œè¿”å›Response åˆ¤æ–­æ‹¦æˆªå™¨é“¾ä¸­çš„é‡å®šå‘æ‹¦æˆªå™¨æ˜¯å¦å·²ç»å–æ¶ˆäº†ï¼Œå¦‚æœå–æ¶ˆäº†ï¼Œå°±æ‰§è¡ŒresponseCallback.onFailure() ï¼Œè¿™ä¸ªä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å¤–è¾¹åœ¨ç¬¬3æ­¥ï¼Œä¼ è¿‡æ¥çš„å›è°ƒæ–¹æ³•Callback()ä¸­çš„onFailure()æ–¹æ³•ã€‚ å¦‚æœæ²¡å–æ¶ˆï¼Œåˆ™èµ°onResponseä¹Ÿå°±æ˜¯Callback()ä¸­çš„onResponse()æ–¹æ³•ã€‚è¿”å›ç»“æœã€‚å½“ç„¶è¿™é‡Œéƒ½æ˜¯åœ¨å­çº¿ç¨‹é‡Œé¢çš„ã€‚ è¿™å¥å…¶å®å°±æ˜¯è°ƒç”¨äº†ï¼Œdispatcheræ–¹æ³•ä¸­çš„finishedæ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹ 3 dispatcher.finished()123456789101112131415161718void finished(RealCall call) { finished(runningSyncCalls, call, false);}private &lt;T&gt; void finished(Deque&lt;T&gt; calls, T call, boolean promoteCalls) { int runningCallsCount; Runnable idleCallback; synchronized (this) { 1.if (!calls.remove(call)) throw new AssertionError(&quot;Call wasn't in-flight!&quot;); 2.if (promoteCalls) promoteCalls(); 3.runningCallsCount = runningCallsCount(); idleCallback = this.idleCallback; } if (runningCallsCount == 0 &amp;&amp; idleCallback != null) { idleCallback.run(); }} å°†è¯¥è¯·æ±‚ä»æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢åˆ é™¤ è°ƒç”¨promoteCalls() è°ƒæ•´è¯·æ±‚é˜Ÿåˆ— é‡æ–°è®¡ç®—è¯·æ±‚æ•°é‡ 4 dispatcher.promoteCalls()12345678910111213141516private void promoteCalls() { if (runningAsyncCalls.size() &gt;= maxRequests) return; // Already running max capacity. if (readyAsyncCalls.isEmpty()) return; // No ready calls to promote. for (Iterator&lt;AsyncCall&gt; i = readyAsyncCalls.iterator(); i.hasNext(); ) { AsyncCall call = i.next(); if (runningCallsForHost(call) &lt; maxRequestsPerHost) { i.remove(); runningAsyncCalls.add(call); executorService().execute(call); } if (runningAsyncCalls.size() &gt;= maxRequests) return; // Reached max capacity. } } å¾ˆç®€å•ï¼Œè¿™é‡Œæ— éå°±æ˜¯éå†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼Œç„¶ååŠ å…¥åˆ°æ‰§è¡Œè¯·æ±‚é˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°å¹¶å‘æ•°å’Œå½“å‰ç½‘ç»œè¯·æ±‚çš„ä¸»æœºæ•°è¾¾åˆ°ä¸Šé™ã€‚ è‡³æ­¤ï¼Œokhttpçš„å¼‚æ­¥å·²ç»åˆ†æå®Œæ¯•äº† é¢è¯•é¢˜ 1.ä»€ä¹ˆæ˜¯dispatcher? dispatcherä½œç”¨æ˜¯ä¸ºç»´æŠ¤è¯·æ±‚çš„çŠ¶æ€ï¼Œå¹¶ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± ã€‚ç”¨äºæ‰§è¡Œè¯·æ±‚ã€‚ å°ä¼™å­ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•å‘€ï¼Ÿæ˜¯ä¸æ˜¯å·²ç»å®Œäº†ï¼Ÿä½ æƒ³å¤šäº†ï¼Œæ¥åˆ†ææœ€æ ¸å¿ƒçš„ä¸€éƒ¨åˆ† ç»†è¯´ getResponseWithInterceptorChain()123456789101112131415161718192021222324252627282930313233343536Response getResponseWithInterceptorChain() throws IOException { // æ·»åŠ æ‹¦æˆªå™¨ï¼Œè´£ä»»é“¾æ¨¡å¼ List&lt;Interceptor&gt; interceptors = new ArrayList&lt;&gt;(); // åœ¨é…ç½®okhttpClient æ—¶è®¾ç½®çš„intercept ç”±ç”¨æˆ·è‡ªå·±è®¾ç½® interceptors.addAll(client.interceptors()); // è´Ÿè´£å¤„ç†å¤±è´¥åçš„é‡è¯•ä¸é‡å®šå‘ interceptors.add(retryAndFollowUpInterceptor); /** è´Ÿè´£æŠŠç”¨æˆ·æ„é€ çš„è¯·æ±‚è½¬æ¢ä¸ºå‘é€åˆ°æœåŠ¡å™¨çš„è¯·æ±‚ ã€æŠŠæœåŠ¡å™¨è¿”å›çš„å“åº”è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„å“åº” å¤„ç† é…ç½®è¯·æ±‚å¤´ç­‰ä¿¡æ¯. ä»åº”ç”¨ç¨‹åºä»£ç åˆ°ç½‘ç»œä»£ç çš„æ¡¥æ¢ã€‚é¦–å…ˆï¼Œå®ƒæ ¹æ®ç”¨æˆ·è¯·æ±‚æ„å»ºç½‘ç»œè¯·æ±‚ã€‚ç„¶åå®ƒç»§ç»­å‘¼å«ç½‘ç»œã€‚æœ€åï¼Œå®ƒæ ¹æ®ç½‘ç»œå“åº”æ„å»ºç”¨æˆ·å“åº”ã€‚ */ interceptors.add(new BridgeInterceptor(client.cookieJar())); // å¤„ç† ç¼“å­˜é…ç½® æ ¹æ®æ¡ä»¶(å­˜åœ¨å“åº”ç¼“å­˜å¹¶è¢«è®¾ç½®ä¸ºä¸å˜çš„æˆ–è€…å“åº”åœ¨æœ‰æ•ˆæœŸå†…)è¿”å›ç¼“å­˜å“åº” // è®¾ç½®è¯·æ±‚å¤´(If-None-Matchã€If-Modified-Sinceç­‰) æœåŠ¡å™¨å¯èƒ½è¿”å›304(æœªä¿®æ”¹) // å¯é…ç½®ç”¨æˆ·è‡ªå·±è®¾ç½®çš„ç¼“å­˜æ‹¦æˆªå™¨ interceptors.add(new CacheInterceptor(client.internalCache())); // è¿æ¥æœåŠ¡å™¨ è´Ÿè´£å’ŒæœåŠ¡å™¨å»ºç«‹è¿æ¥ è¿™é‡Œæ‰æ˜¯çœŸæ­£çš„è¯·æ±‚ç½‘ç»œ interceptors.add(new ConnectInterceptor(client)); if (!forWebSocket) { interceptors.addAll(client.networkInterceptors()); } // æ‰§è¡Œæµæ“ä½œ(å†™å‡ºè¯·æ±‚ä½“ã€è·å¾—å“åº”æ•°æ®) è´Ÿè´£å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ•°æ®ã€ä»æœåŠ¡å™¨è¯»å–å“åº”æ•°æ® // è¿›è¡Œhttpè¯·æ±‚æŠ¥æ–‡çš„å°è£…ä¸è¯·æ±‚æŠ¥æ–‡çš„è§£æ interceptors.add(new CallServerInterceptor(forWebSocket)); // è´£ä»»é“¾ï¼Œå°†ä¸Šè¿°çš„æ‹¦æˆªå™¨æ·»åŠ åˆ°è´£ä»»é“¾é‡Œé¢ Interceptor.Chain chain = new RealInterceptorChain(interceptors, null, null, null, 0, originalRequest); return chain.proceed(originalRequest); } æ‹¦æˆªå™¨ ä½œç”¨ Interceptoråº”ç”¨æ‹¦æˆªå™¨ æ‹¿åˆ°çš„æ˜¯åŸå§‹è¯·æ±‚ï¼Œå¯ä»¥æ·»åŠ ä¸€äº›è‡ªå®šä¹‰headerã€é€šç”¨å‚æ•°ã€å‚æ•°åŠ å¯†ã€ç½‘å…³æ¥å…¥ç­‰ç­‰ã€‚ RetryAndFollowUpInterceptor å¤„ç†é”™è¯¯é‡è¯•å’Œé‡å®šå‘ BridgeInterceptor åº”ç”¨å±‚å’Œç½‘ç»œå±‚çš„æ¡¥æ¥æ‹¦æˆªå™¨ï¼Œä¸»è¦å·¥ä½œæ˜¯ä¸ºè¯·æ±‚æ·»åŠ cookieã€æ·»åŠ å›ºå®šçš„headerï¼Œæ¯”å¦‚Hostã€Content-Lengthã€Content-Typeã€User-Agentç­‰ç­‰ï¼Œç„¶åä¿å­˜å“åº”ç»“æœçš„cookieï¼Œå¦‚æœå“åº”ä½¿ç”¨gzipå‹ç¼©è¿‡ï¼Œåˆ™è¿˜éœ€è¦è¿›è¡Œè§£å‹ã€‚ CacheInterceptor ç¼“å­˜æ‹¦æˆªå™¨ï¼Œå¦‚æœå‘½ä¸­ç¼“å­˜åˆ™ä¸ä¼šå‘èµ·ç½‘ç»œè¯·æ±‚ã€‚ ConnectInterceptor è¿æ¥æ‹¦æˆªå™¨ï¼Œå†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªè¿æ¥æ± ï¼Œè´Ÿè´£è¿æ¥å¤ç”¨ã€åˆ›å»ºè¿æ¥ï¼ˆä¸‰æ¬¡æ¡æ‰‹ç­‰ç­‰ï¼‰ã€é‡Šæ”¾è¿æ¥ä»¥åŠåˆ›å»ºè¿æ¥ä¸Šçš„socketæµã€‚ networkInterceptorsï¼ˆç½‘ç»œæ‹¦æˆªå™¨ï¼‰ ç”¨æˆ·è‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼Œé€šå¸¸ç”¨äºç›‘æ§ç½‘ç»œå±‚çš„æ•°æ®ä¼ è¾“ã€‚ CallServerInterceptor è¯·æ±‚æ‹¦æˆªå™¨ï¼Œåœ¨å‰ç½®å‡†å¤‡å·¥ä½œå®Œæˆåï¼ŒçœŸæ­£å‘èµ·äº†ç½‘ç»œè¯·æ±‚ã€‚ OtheraddInterceptorä¸addNetworkInterceptorçš„åŒºåˆ«äºŒè€…é€šå¸¸çš„å«æ³•ä¸ºåº”ç”¨æ‹¦æˆªå™¨å’Œç½‘ç»œæ‹¦æˆªå™¨ï¼Œä»æ•´ä¸ªè´£ä»»é“¾è·¯æ¥çœ‹ï¼Œåº”ç”¨æ‹¦æˆªå™¨æ˜¯æœ€å…ˆæ‰§è¡Œçš„æ‹¦æˆªå™¨ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·è‡ªå·±è®¾ç½®requestå±æ€§åçš„åŸå§‹è¯·æ±‚ï¼Œè€Œç½‘ç»œæ‹¦æˆªå™¨ä½äºConnectInterceptorå’ŒCallServerInterceptorä¹‹é—´ï¼Œæ­¤æ—¶ç½‘ç»œé“¾è·¯å·²ç»å‡†å¤‡å¥½ï¼Œåªç­‰å¾…å‘é€è¯·æ±‚æ•°æ®ã€‚ é¦–å…ˆï¼Œåº”ç”¨æ‹¦æˆªå™¨åœ¨RetryAndFollowUpInterceptorå’ŒCacheInterceptorä¹‹å‰ï¼Œæ‰€ä»¥ä¸€æ—¦å‘ç”Ÿé”™è¯¯é‡è¯•æˆ–è€…ç½‘ç»œé‡å®šå‘ï¼Œç½‘ç»œæ‹¦æˆªå™¨å¯èƒ½æ‰§è¡Œå¤šæ¬¡ï¼Œå› ä¸ºç›¸å½“äºè¿›è¡Œäº†äºŒæ¬¡è¯·æ±‚ï¼Œä½†æ˜¯åº”ç”¨æ‹¦æˆªå™¨æ°¸è¿œåªä¼šè§¦å‘ä¸€æ¬¡ã€‚å¦å¤–å¦‚æœåœ¨CacheInterceptorä¸­å‘½ä¸­äº†ç¼“å­˜å°±ä¸éœ€è¦èµ°ç½‘ç»œè¯·æ±‚äº†ï¼Œå› æ­¤ä¼šå­˜åœ¨çŸ­è·¯ç½‘ç»œæ‹¦æˆªå™¨çš„æƒ…å†µã€‚ å…¶æ¬¡ï¼Œå¦‚ä¸Šæ–‡æåˆ°é™¤äº†CallServerInterceptorï¼Œæ¯ä¸ªæ‹¦æˆªå™¨éƒ½åº”è¯¥è‡³å°‘è°ƒç”¨ä¸€æ¬¡realChain.proceedæ–¹æ³•ã€‚å®é™…ä¸Šåœ¨åº”ç”¨æ‹¦æˆªå™¨è¿™å±‚å¯ä»¥å¤šæ¬¡è°ƒç”¨proceedæ–¹æ³•ï¼ˆæœ¬åœ°å¼‚å¸¸é‡è¯•ï¼‰æˆ–è€…ä¸è°ƒç”¨proceedæ–¹æ³•ï¼ˆä¸­æ–­ï¼‰ï¼Œä½†æ˜¯ç½‘ç»œæ‹¦æˆªå™¨è¿™å±‚è¿æ¥å·²ç»å‡†å¤‡å¥½ï¼Œå¯ä¸”ä»…å¯è°ƒç”¨ä¸€æ¬¡proceedæ–¹æ³•ã€‚ æœ€åï¼Œä»ä½¿ç”¨åœºæ™¯çœ‹ï¼Œåº”ç”¨æ‹¦æˆªå™¨å› ä¸ºåªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œé€šå¸¸ç”¨äºç»Ÿè®¡å®¢æˆ·ç«¯çš„ç½‘ç»œè¯·æ±‚å‘èµ·æƒ…å†µï¼›è€Œç½‘ç»œæ‹¦æˆªå™¨ä¸€æ¬¡è°ƒç”¨ä»£è¡¨äº†ä¸€å®šä¼šå‘èµ·ä¸€æ¬¡ç½‘ç»œé€šä¿¡ï¼Œå› æ­¤é€šå¸¸å¯ç”¨äºç»Ÿè®¡ç½‘ç»œé“¾è·¯ä¸Šä¼ è¾“çš„æ•°æ®ã€‚ ç½‘ç»œç¼“å­˜æœºåˆ¶CacheInterceptorè¿™é‡Œçš„ç¼“å­˜æ˜¯æŒ‡åŸºäºHttpç½‘ç»œåè®®çš„æ•°æ®ç¼“å­˜ç­–ç•¥ï¼Œä¾§é‡ç‚¹åœ¨å®¢æˆ·ç«¯ç¼“å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆæ¥å¤ä¹ ä¸€ä¸‹Httpåè®®å¦‚ä½•æ ¹æ®è¯·æ±‚å’Œå“åº”å¤´æ¥æ ‡è¯†ç¼“å­˜çš„å¯ç”¨æ€§ã€‚ æåˆ°ç¼“å­˜ï¼Œå°±å¿…é¡»è¦èŠèŠç¼“å­˜çš„æœ‰æ•ˆæ€§ã€æœ‰æ•ˆæœŸã€‚ HTTPç¼“å­˜åŸç†åœ¨HTTP 1.0æ—¶ä»£ï¼Œå“åº”ä½¿ç”¨Expireså¤´æ ‡è¯†ç¼“å­˜çš„æœ‰æ•ˆæœŸï¼Œå…¶å€¼æ˜¯ä¸€ä¸ªç»å¯¹æ—¶é—´ï¼Œæ¯”å¦‚Expires:Thu,31 Dec 2020 23:59:59 GMTã€‚å½“å®¢æˆ·ç«¯å†æ¬¡å‘å‡ºç½‘ç»œè¯·æ±‚æ—¶å¯æ¯”è¾ƒå½“å‰æ—¶é—´ å’Œä¸Šæ¬¡å“åº”çš„expiresæ—¶é—´è¿›è¡Œæ¯”è¾ƒï¼Œæ¥å†³å®šæ˜¯ä½¿ç”¨ç¼“å­˜è¿˜æ˜¯å‘èµ·æ–°çš„è¯·æ±‚ã€‚ ä½¿ç”¨Expireså¤´æœ€å¤§çš„é—®é¢˜æ˜¯å®ƒä¾èµ–å®¢æˆ·ç«¯çš„æœ¬åœ°æ—¶é—´ï¼Œå¦‚æœç”¨æˆ·è‡ªå·±ä¿®æ”¹äº†æœ¬åœ°æ—¶é—´ï¼Œå°±ä¼šå¯¼è‡´æ— æ³•å‡†ç¡®çš„åˆ¤æ–­ç¼“å­˜æ˜¯å¦è¿‡æœŸã€‚ å› æ­¤ï¼Œä»HTTP 1.1 å¼€å§‹ä½¿ç”¨Cache-Controlå¤´è¡¨ç¤ºç¼“å­˜çŠ¶æ€ï¼Œå®ƒçš„ä¼˜å…ˆçº§é«˜äºExpiresï¼Œå¸¸è§çš„å–å€¼ä¸ºä¸‹é¢çš„ä¸€ä¸ªæˆ–å¤šä¸ªã€‚ privateï¼Œé»˜è®¤å€¼ï¼Œæ ‡è¯†é‚£äº›ç§æœ‰çš„ä¸šåŠ¡é€»è¾‘æ•°æ®ï¼Œæ¯”å¦‚æ ¹æ®ç”¨æˆ·è¡Œä¸ºä¸‹å‘çš„æ¨èæ•°æ®ã€‚è¯¥æ¨¡å¼ä¸‹ç½‘ç»œé“¾è·¯ä¸­çš„ä»£ç†æœåŠ¡å™¨ç­‰èŠ‚ç‚¹ä¸åº”è¯¥ç¼“å­˜è¿™éƒ¨åˆ†æ•°æ®ï¼Œå› ä¸ºæ²¡æœ‰å®é™…æ„ä¹‰ã€‚ public ä¸privateç›¸åï¼Œpublicç”¨äºæ ‡è¯†é‚£äº›é€šç”¨çš„ä¸šåŠ¡æ•°æ®ï¼Œæ¯”å¦‚è·å–æ–°é—»åˆ—è¡¨ï¼Œæ‰€æœ‰äººçœ‹åˆ°çš„éƒ½æ˜¯åŒä¸€ä»½æ•°æ®ï¼Œå› æ­¤å®¢æˆ·ç«¯ã€ä»£ç†æœåŠ¡å™¨éƒ½å¯ä»¥ç¼“å­˜ã€‚ no-cache å¯è¿›è¡Œç¼“å­˜ï¼Œä½†åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ç¼“å­˜å‰å¿…é¡»è¦å»æœåŠ¡ç«¯è¿›è¡Œç¼“å­˜èµ„æºæœ‰æ•ˆæ€§çš„éªŒè¯ï¼Œå³ä¸‹æ–‡çš„å¯¹æ¯”ç¼“å­˜éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç¨åä»‹ç»ã€‚ max-age è¡¨ç¤ºç¼“å­˜æ—¶é•¿å•ä½ä¸ºç§’ï¼ŒæŒ‡ä¸€ä¸ªæ—¶é—´æ®µï¼Œæ¯”å¦‚ä¸€å¹´ï¼Œé€šå¸¸ç”¨äºä¸ç»å¸¸å˜åŒ–çš„é™æ€èµ„æºã€‚ no-store ä»»ä½•èŠ‚ç‚¹ç¦æ­¢ä½¿ç”¨ç¼“å­˜ã€‚ å¼ºåˆ¶ç¼“å­˜åœ¨ä¸Šè¿°ç¼“å­˜å¤´è§„çº¦åŸºç¡€ä¹‹ä¸Šï¼Œå¼ºåˆ¶ç¼“å­˜æ˜¯æŒ‡ç½‘ç»œè¯·æ±‚å“åº”headeræ ‡è¯†äº†Expiresæˆ–Cache-Controlå¸¦äº†max-ageä¿¡æ¯ï¼Œè€Œæ­¤æ—¶å®¢æˆ·ç«¯è®¡ç®—ç¼“å­˜å¹¶æœªè¿‡æœŸï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜å†…å®¹ï¼Œè€Œä¸ç”¨çœŸæ­£çš„å‘èµ·ä¸€æ¬¡ç½‘ç»œè¯·æ±‚ã€‚ åå•†ç¼“å­˜å¼ºåˆ¶ç¼“å­˜æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œä¸€æ—¦æœåŠ¡ç«¯èµ„æºæœ‰æ›´æ–°ï¼Œç›´åˆ°ç¼“å­˜æ—¶é—´æˆªæ­¢å‰ï¼Œå®¢æˆ·ç«¯æ— æ³•è·å–åˆ°æœ€æ–°çš„èµ„æºï¼ˆé™¤éè¯·æ±‚æ—¶æ‰‹åŠ¨æ·»åŠ no-storeå¤´ï¼‰ï¼Œå¦å¤–å¤§éƒ¨åˆ†æƒ…å†µä¸‹æœåŠ¡å™¨çš„èµ„æºæ— æ³•ç›´æ¥ç¡®å®šç¼“å­˜å¤±æ•ˆæ—¶é—´ï¼Œæ‰€ä»¥ä½¿ç”¨å¯¹æ¯”ç¼“å­˜æ›´çµæ´»ä¸€äº›ã€‚ ä½¿ç”¨Last-Modify / If-Modify-Sinceå¤´å®ç°åå•†ç¼“å­˜ï¼Œå…·ä½“æ–¹æ³•æ˜¯æœåŠ¡ç«¯å“åº”å¤´æ·»åŠ Last-Modifyå¤´æ ‡è¯†èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼Œå½“å®¢æˆ·ç«¯å†æ¬¡å‘èµ·è¯·æ±‚æ—¶æ·»åŠ If-Modify-Sinceå¤´å¹¶èµ‹å€¼ä¸ºä¸Šæ¬¡è¯·æ±‚æ‹¿åˆ°çš„Last-Modifyå¤´çš„å€¼ã€‚ æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åè‡ªè¡Œåˆ¤æ–­ç¼“å­˜èµ„æºæ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼Œå¦‚æœæœ‰æ•ˆåˆ™è¿”å›çŠ¶æ€ç 304åŒæ—¶bodyä½“ä¸ºç©ºï¼Œå¦åˆ™ä¸‹å‘æœ€æ–°çš„èµ„æºæ•°æ®ã€‚å®¢æˆ·ç«¯å¦‚æœå‘ç°çŠ¶æ€ç æ˜¯304ï¼Œåˆ™å–å‡ºæœ¬åœ°çš„ç¼“å­˜æ•°æ®ä½œä¸ºå“åº”ã€‚ ä½¿ç”¨è¿™å¥—æ–¹æ¡ˆæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯èµ„æºæ–‡ä»¶ä½¿ç”¨æœ€åä¿®æ”¹æ—¶é—´æœ‰ä¸€å®šçš„å±€é™æ€§ï¼š Last-Modifyå•ä½ä¸ºç§’ï¼Œå¦‚æœæŸäº›æ–‡ä»¶åœ¨ä¸€ç§’å†…è¢«ä¿®æ”¹åˆ™å¹¶ä¸èƒ½å‡†ç¡®çš„æ ‡è¯†ä¿®æ”¹æ—¶é—´ã€‚ èµ„æºä¿®æ”¹æ—¶é—´å¹¶ä¸èƒ½ä½œä¸ºèµ„æºæ˜¯å¦ä¿®æ”¹çš„å”¯ä¸€ä¾æ®ï¼Œæ¯”å¦‚èµ„æºæ–‡ä»¶æ˜¯Daily Buildçš„ï¼Œæ¯å¤©éƒ½ä¼šç”Ÿæˆæ–°çš„ï¼Œä½†æ˜¯å…¶å®é™…å†…å®¹å¯èƒ½å¹¶æœªæ”¹å˜ã€‚ å› æ­¤ï¼ŒHTTP è¿˜æä¾›äº†å¦å¤–ä¸€ç»„å¤´ä¿¡æ¯æ¥å¤„ç†ç¼“å­˜ï¼ŒETag/If-None-Matchã€‚æµç¨‹ä¸Last-Modifyä¸€æ ·ï¼Œåªæ˜¯æŠŠæœåŠ¡ç«¯å“åº”çš„å¤´å˜æˆLast-Modifyï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„å¤´å˜æˆIf-None-Matchã€‚ETagæ˜¯èµ„æºçš„å”¯ä¸€æ ‡è¯†ç¬¦ ï¼ŒæœåŠ¡ç«¯èµ„æºå˜åŒ–ä¸€å®šä¼šå¯¼è‡´ETagå˜åŒ–ã€‚å…·ä½“çš„ç”Ÿæˆæ–¹å¼æœ‰æœåŠ¡ç«¯æ§åˆ¶ï¼Œåœºæ™¯çš„å½±å“å› ç´ åŒ…æ‹¬ï¼Œæ–‡ä»¶æœ€ç»ˆä¿®æ”¹æ—¶é—´ã€æ–‡ä»¶å¤§å°ã€æ–‡ä»¶ç¼–å·ç­‰ç­‰ã€‚ OKHttpçš„ç¼“å­˜å®ç°ä¸Šé¢è®²äº†è¿™ä¹ˆå¤šï¼Œå®é™…ä¸ŠOKHttpå°±æ˜¯å°†ä¸Šè¿°æµç¨‹ç”¨ä»£ç å®ç°äº†ä¸€ä¸‹ï¼Œå³ï¼š ç¬¬ä¸€æ¬¡æ‹¿åˆ°å“åº”åæ ¹æ®å¤´ä¿¡æ¯å†³å®šæ˜¯å¦ç¼“å­˜ã€‚ ä¸‹æ¬¡è¯·æ±‚æ—¶åˆ¤æ–­æ˜¯å¦å­˜åœ¨æœ¬åœ°ç¼“å­˜ï¼Œæ˜¯å¦éœ€è¦ä½¿ç”¨å¯¹æ¯”ç¼“å­˜ã€å°è£…è¯·æ±‚å¤´ä¿¡æ¯ç­‰ç­‰ã€‚ å¦‚æœç¼“å­˜å¤±æ•ˆæˆ–è€…éœ€è¦å¯¹æ¯”ç¼“å­˜åˆ™å‘å‡ºç½‘ç»œè¯·æ±‚ï¼Œå¦åˆ™ä½¿ç”¨æœ¬åœ°ç¼“å­˜ã€‚ OKHttpå†…éƒ¨ä½¿ç”¨Okioæ¥å®ç°ç¼“å­˜æ–‡ä»¶çš„è¯»å†™ã€‚ ç¼“å­˜æ–‡ä»¶åˆ†ä¸ºCleanFileså’ŒDirtyFilesï¼ŒCleanFilesç”¨äºè¯»ï¼ŒDirtyFilesç”¨äºå†™ï¼Œä»–ä»¬éƒ½æ˜¯æ•°ç»„ï¼Œé•¿åº¦ä¸º2ï¼Œè¡¨ç¤ºä¸¤ä¸ªæ–‡ä»¶ï¼Œå³ç¼“å­˜çš„è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ï¼›åŒæ—¶è®°å½•äº†ç¼“å­˜çš„æ“ä½œæ—¥å¿—ï¼Œè®°å½•åœ¨journalFileä¸­ã€‚ å¼€å¯ç¼“å­˜éœ€è¦åœ¨OkHttpClientåˆ›å»ºæ—¶è®¾ç½®ä¸€ä¸ªCacheå¯¹è±¡ï¼Œå¹¶æŒ‡å®šç¼“å­˜ç›®å½•å’Œç¼“å­˜å¤§å°ï¼Œç¼“å­˜ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨LRUä½œä¸ºç¼“å­˜çš„æ·˜æ±°ç®—æ³•ã€‚ 1234567## Cache.ktclass Cache internal constructor( directory: File, maxSize: Long, fileSystem: FileSystem): Closeable, Flushableå¤åˆ¶ä»£ç  OkHttpæ—©æœŸçš„ç‰ˆæœ¬æœ‰ä¸ªä¸€ä¸ªInternalCacheæ¥å£ï¼Œæ”¯æŒè‡ªå®šä¹‰å®ç°ç¼“å­˜ï¼Œä½†åˆ°äº†4.xçš„ç‰ˆæœ¬ååˆ å‡äº†InternalCacheï¼ŒCacheç±»åˆä¸ºfinalçš„ï¼Œç›¸å½“äºå…³é—­äº†æ‰©å±•åŠŸèƒ½ã€‚ å…·ä½“æºç å®ç°éƒ½åœ¨CacheInterceptorç±»ä¸­ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚ é€šè¿‡OkHttpClientè®¾ç½®ç¼“å­˜æ˜¯å…¨å±€çŠ¶æ€çš„ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å¯¹æŸä¸ªç‰¹å®šçš„requestä½¿ç”¨æˆ–ç¦ç”¨ç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡CacheControlç›¸å…³çš„APIå®ç°ï¼š 123456//ç¦ç”¨ç¼“å­˜Request request = new Request.Builder() .cacheControl(new CacheControl.Builder().noCache().build()) .url(&quot;http://publicobject.com/helloworld.txt&quot;) .build();å¤åˆ¶ä»£ç  OKHttpä¸æ”¯æŒçš„ç¼“å­˜æƒ…å†µæœ€åéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼ŒOKHttpé»˜è®¤åªæ”¯æŒgetè¯·æ±‚çš„ç¼“å­˜ã€‚ 12345678910111213141516171819# okhttp3.Cache.java@Nullable CacheRequest put(Response response) { String requestMethod = response.request().method(); ... //ç¼“å­˜ä»…æ”¯æŒGETè¯·æ±‚ if (!requestMethod.equals(&quot;GET&quot;)) { // Don't cache non-GET responses. We're technically allowed to cache // HEAD requests and some POST requests, but the complexity of doing // so is high and the benefit is low. return null; } //å¯¹äºvaryå¤´çš„å€¼ä¸º*çš„æƒ…å†µï¼Œç»Ÿä¸€ä¸ç¼“å­˜ if (HttpHeaders.hasVaryAll(response)) { return null; } ...}å¤åˆ¶ä»£ç  è¿™æ˜¯å½“ç½‘ç»œè¯·æ±‚å“åº”åï¼Œå‡†å¤‡è¿›è¡Œç¼“å­˜æ—¶çš„é€»è¾‘ä»£ç ï¼Œå½“è¿”å›nullæ—¶è¡¨ç¤ºä¸ç¼“å­˜ã€‚ä»ä»£ç æ³¨é‡Šä¸­ä¸éš¾çœ‹å‡ºï¼Œæˆ‘ä»¬ä»æŠ€æœ¯ä¸Šå¯ä»¥ç¼“å­˜methodä¸ºHEADå’Œéƒ¨åˆ†POSTè¯·æ±‚ï¼Œä½†å®ç°èµ·æ¥çš„å¤æ‚æ€§å¾ˆé«˜è€Œæ”¶ç›Šç”šå¾®ã€‚è¿™æœ¬è´¨ä¸Šæ˜¯ç”±å„ä¸ªmethodçš„ä½¿ç”¨åœºæ™¯å†³å®šçš„ã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¸¸è§çš„methodç±»å‹åŠå…¶ç”¨é€”ã€‚ GET è¯·æ±‚èµ„æºï¼Œå‚æ•°éƒ½åœ¨URLä¸­ã€‚ HEAD ä¸GETåŸºæœ¬ä¸€è‡´ï¼Œåªä¸è¿‡å…¶ä¸è¿”å›æ¶ˆæ¯ä½“ï¼Œé€šå¸¸ç”¨äºé€Ÿåº¦æˆ–å¸¦å®½ä¼˜å…ˆçš„åœºæ™¯ï¼Œæ¯”å¦‚æ£€æŸ¥èµ„æºæœ‰æ•ˆæ€§ï¼Œå¯è®¿é—®æ€§ç­‰ç­‰ã€‚ POST æäº¤è¡¨å•ï¼Œä¿®æ”¹æ•°æ®ï¼Œå‚æ•°åœ¨bodyä¸­ã€‚ PUT ä¸POSTåŸºæœ¬ä¸€è‡´ï¼Œæœ€å¤§ä¸åŒä¸ºPUTæ˜¯å¹‚ç­‰çš„ã€‚ DELETE åˆ é™¤æŒ‡å®šèµ„æºã€‚ å¯ä»¥çœ‹åˆ°å¯¹äºæ ‡å‡†çš„RESTfulè¯·æ±‚ï¼ŒGETå°±æ˜¯ç”¨æ¥è·å–æ•°æ®ï¼Œæœ€é€‚åˆä½¿ç”¨ç¼“å­˜ï¼Œè€Œå¯¹äºæ•°æ®çš„å…¶ä»–æ“ä½œç¼“å­˜æ„ä¹‰ä¸å¤§æˆ–è€…æ ¹æœ¬ä¸éœ€è¦ç¼“å­˜ã€‚ ä¹Ÿæ˜¯åŸºäºæ­¤åœ¨ä»…æ”¯æŒGETè¯·æ±‚çš„æ¡ä»¶ä¸‹ï¼ŒOKHTTPä½¿ç”¨request URLä½œä¸ºç¼“å­˜çš„keyï¼ˆå½“ç„¶è¿˜ä¼šç»è¿‡ä¸€ç³»åˆ—æ‘˜è¦ç®—æ³•ï¼‰ã€‚ OkHttpçš„çº¿ç¨‹æ± OkHttpä¸­çš„çº¿ç¨‹æ± æ˜¯å®šä¹‰åœ¨åˆ†å‘å™¨ä¸­çš„ï¼Œå³å®šä¹‰åœ¨Dispatcher 1234567public synchronized ExecutorService executorService() { if (executorService == null) { executorService = new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60, TimeUnit.SECONDS, new SynchronousQueue&lt;&gt;(), Util.threadFactory(&quot;OkHttp Dispatcher&quot;, false)); } return executorService;} é«˜å¹¶å‘ï¼Œæœ€å¤§ååé‡ã€‚SynchronousQueueé˜Ÿåˆ—æ˜¯æ— å®¹é‡é˜Ÿåˆ—ï¼Œ åœ¨OkHttpä¸­ï¼Œé…ç½®çš„çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸ºInteger.MAX_VALUEï¼Œçº¿ç¨‹çš„å­˜æ´»æ—¶é—´ä¸º60sï¼Œé‡‡ç”¨çš„é˜Ÿåˆ—æ˜¯SynchronousQueueã€‚ okhttp é»˜è®¤åŒæ—¶æ”¯æŒ 64 ä¸ªå¼‚æ­¥è¯·æ±‚(ä¸è€ƒè™‘åŒæ­¥è¯·æ±‚)ï¼Œä¸€ä¸ª host åŒæ—¶æœ€å¤šè¯·æ±‚ 5 ä¸ª okhttp å†…éƒ¨çš„çº¿ç¨‹æ± éƒ½æ˜¯ CacheThreadPoolï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 0ï¼Œéæ ¸å¿ƒçº¿ç¨‹æ•°æ— é™ï¼Œæ°¸è¿œæ·»åŠ ä¸åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ okhttpClient å¦‚æœä¸å•ä¾‹ï¼Œä¼šå‡ºç° oomï¼šå› ä¸ºå¤§é‡çš„ Dispatcher å¯¹è±¡ï¼Œä¸åŒçš„å¯¹è±¡ä¼šä½¿ç”¨ä¸åŒçš„çº¿ç¨‹å»å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œä»è€Œå¯¼è‡´çº¿ç¨‹è¿‡å¤šï¼ŒOOM","link":"/2021/04/07/Okhttp/"},{"title":"HighFrequencyIssue","text":"æ“ä½œç³»ç»Ÿï¼šï¼ˆ1ï¼‰çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«ï¼Ÿ ï¼ˆ2ï¼‰çº¿ç¨‹ä¹‹é—´æ€ä¹ˆå…±äº«èµ„æºï¼Ÿ ï¼ˆ3ï¼‰è¿›ç¨‹ä¹‹é—´æ€ä¹ˆé€šä¿¡ï¼Ÿ ï¼ˆ4ï¼‰è¿›ç¨‹æ± çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ è¿›ç¨‹ä¸çº¿ç¨‹çš„æ¦‚å¿µï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦æœ‰è¿›ç¨‹çº¿ç¨‹ï¼Œå…¶ä¸­æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä»–ä»¬å„è‡ªåˆæ˜¯æ€ä¹ˆåŒæ­¥çš„?1. åŸºæœ¬æ¦‚å¿µï¼šè¿›ç¨‹æ˜¯å¯¹è¿è¡Œæ—¶ç¨‹åºçš„å°è£…ï¼Œæ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºè°ƒåº¦å’Œåˆ†é…çš„çš„åŸºæœ¬å•ä½ï¼Œå®ç°äº†æ“ä½œç³»ç»Ÿçš„å¹¶å‘ï¼› çº¿ç¨‹æ˜¯è¿›ç¨‹çš„å­ä»»åŠ¡ï¼Œæ˜¯CPUè°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½ï¼Œç”¨äºä¿è¯ç¨‹åºçš„å®æ—¶æ€§ï¼Œå®ç°è¿›ç¨‹å†…éƒ¨çš„å¹¶å‘ï¼›çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿå¯è¯†åˆ«çš„æœ€å°æ‰§è¡Œå’Œè°ƒåº¦å•ä½ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ç‹¬è‡ªå ç”¨ä¸€ä¸ªè™šæ‹Ÿå¤„ç†å™¨ï¼šç‹¬è‡ªçš„å¯„å­˜å™¨ç»„ï¼ŒæŒ‡ä»¤è®¡æ•°å™¨å’Œå¤„ç†å™¨çŠ¶æ€ã€‚æ¯ä¸ªçº¿ç¨‹å®Œæˆä¸åŒçš„ä»»åŠ¡ï¼Œä½†æ˜¯å…±äº«åŒä¸€åœ°å€ç©ºé—´ï¼ˆä¹Ÿå°±æ˜¯åŒæ ·çš„åŠ¨æ€å†…å­˜ï¼Œæ˜ å°„æ–‡ä»¶ï¼Œç›®æ ‡ä»£ç ç­‰ç­‰ï¼‰ï¼Œæ‰“å¼€çš„æ–‡ä»¶é˜Ÿåˆ—å’Œå…¶ä»–å†…æ ¸èµ„æºã€‚ 2. åŒºåˆ«ï¼š ä¸€ä¸ªçº¿ç¨‹åªèƒ½å±äºä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œä½†è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚çº¿ç¨‹ä¾èµ–äºè¿›ç¨‹è€Œå­˜åœ¨ã€‚ è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ‹¥æœ‰ç‹¬ç«‹çš„å†…å­˜å•å…ƒï¼Œè€Œå¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„å†…å­˜ã€‚ï¼ˆèµ„æºåˆ†é…ç»™è¿›ç¨‹ï¼ŒåŒä¸€è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹å…±äº«è¯¥è¿›ç¨‹çš„æ‰€æœ‰èµ„æºã€‚åŒä¸€è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å…±äº«ä»£ç æ®µï¼ˆä»£ç å’Œå¸¸é‡ï¼‰ï¼Œæ•°æ®æ®µï¼ˆå…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼‰ï¼Œæ‰©å±•æ®µï¼ˆå †å­˜å‚¨ï¼‰ã€‚ä½†æ˜¯æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„æ ˆæ®µï¼Œæ ˆæ®µåˆå«è¿è¡Œæ—¶æ®µï¼Œç”¨æ¥å­˜æ”¾æ‰€æœ‰å±€éƒ¨å˜é‡å’Œä¸´æ—¶å˜é‡ã€‚ï¼‰ è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„æœ€å°å•ä½ï¼› ç³»ç»Ÿå¼€é”€ï¼š ç”±äºåœ¨åˆ›å»ºæˆ–æ’¤æ¶ˆè¿›ç¨‹æ—¶ï¼Œç³»ç»Ÿéƒ½è¦ä¸ºä¹‹åˆ†é…æˆ–å›æ”¶èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ã€Iï¼oè®¾å¤‡ç­‰ã€‚å› æ­¤ï¼Œæ“ä½œç³»ç»Ÿæ‰€ä»˜å‡ºçš„å¼€é”€å°†æ˜¾è‘—åœ°å¤§äºåœ¨åˆ›å»ºæˆ–æ’¤æ¶ˆçº¿ç¨‹æ—¶çš„å¼€é”€ã€‚ç±»ä¼¼åœ°ï¼Œåœ¨è¿›è¡Œè¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œæ¶‰åŠåˆ°æ•´ä¸ªå½“å‰è¿›ç¨‹CPUç¯å¢ƒçš„ä¿å­˜ä»¥åŠæ–°è¢«è°ƒåº¦è¿è¡Œçš„è¿›ç¨‹çš„CPUç¯å¢ƒçš„è®¾ç½®ã€‚è€Œçº¿ç¨‹åˆ‡æ¢åªé¡»ä¿å­˜å’Œè®¾ç½®å°‘é‡å¯„å­˜å™¨çš„å†…å®¹ï¼Œå¹¶ä¸æ¶‰åŠå­˜å‚¨å™¨ç®¡ç†æ–¹é¢çš„æ“ä½œã€‚å¯è§ï¼Œè¿›ç¨‹åˆ‡æ¢çš„å¼€é”€ä¹Ÿè¿œå¤§äºçº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ã€‚ é€šä¿¡ï¼šç”±äºåŒä¸€è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å…·æœ‰ç›¸åŒçš„åœ°å€ç©ºé—´ï¼Œè‡´ä½¿å®ƒä»¬ä¹‹é—´çš„åŒæ­¥å’Œé€šä¿¡çš„å®ç°ï¼Œä¹Ÿå˜å¾—æ¯”è¾ƒå®¹æ˜“ã€‚è¿›ç¨‹é—´é€šä¿¡IPCï¼Œçº¿ç¨‹é—´å¯ä»¥ç›´æ¥è¯»å†™è¿›ç¨‹æ•°æ®æ®µï¼ˆå¦‚å…¨å±€å˜é‡ï¼‰æ¥è¿›è¡Œé€šä¿¡â€”â€”éœ€è¦è¿›ç¨‹åŒæ­¥å’Œäº’æ–¥æ‰‹æ®µçš„è¾…åŠ©ï¼Œä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚åœ¨æœ‰çš„ç³»ç»Ÿä¸­ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ã€åŒæ­¥å’Œé€šä¿¡éƒ½æ— é¡»æ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹²é¢„ è¿›ç¨‹ç¼–ç¨‹è°ƒè¯•ç®€å•å¯é æ€§é«˜ï¼Œä½†æ˜¯åˆ›å»ºé”€æ¯å¼€é”€å¤§ï¼›çº¿ç¨‹æ­£ç›¸åï¼Œå¼€é”€å°ï¼Œåˆ‡æ¢é€Ÿåº¦å¿«ï¼Œä½†æ˜¯ç¼–ç¨‹è°ƒè¯•ç›¸å¯¹å¤æ‚ã€‚ è¿›ç¨‹é—´ä¸ä¼šç›¸äº’å½±å“ ï¼›çº¿ç¨‹ä¸€ä¸ªçº¿ç¨‹æŒ‚æ‰å°†å¯¼è‡´æ•´ä¸ªè¿›ç¨‹æŒ‚æ‰ è¿›ç¨‹é€‚åº”äºå¤šæ ¸ã€å¤šæœºåˆ†å¸ƒï¼›çº¿ç¨‹é€‚ç”¨äºå¤šæ ¸ è¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼šè¿›ç¨‹é—´é€šä¿¡ä¸»è¦åŒ…æ‹¬ç®¡é“ã€ç³»ç»ŸIPCï¼ˆåŒ…æ‹¬æ¶ˆæ¯é˜Ÿåˆ—ã€ä¿¡å·é‡ã€ä¿¡å·ã€å…±äº«å†…å­˜ç­‰ï¼‰ã€ä»¥åŠå¥—æ¥å­—socketã€‚ 1.ç®¡é“ï¼šç®¡é“ä¸»è¦åŒ…æ‹¬åŒ¿åç®¡é“å’Œå‘½åç®¡é“:ç®¡é“å¯ç”¨äºå…·æœ‰äº²ç¼˜å…³ç³»çš„çˆ¶å­è¿›ç¨‹é—´çš„é€šä¿¡ï¼Œå‘½åç®¡é“é™¤äº†å…·æœ‰ç®¡é“æ‰€å…·æœ‰çš„åŠŸèƒ½å¤–ï¼Œå®ƒè¿˜å…è®¸æ— äº²ç¼˜å…³ç³»è¿›ç¨‹é—´çš„é€šä¿¡ 1.1 åŒ¿åç®¡é“PIPEï¼š å®ƒæ˜¯åŠåŒå·¥çš„ï¼ˆå³æ•°æ®åªèƒ½åœ¨ä¸€ä¸ªæ–¹å‘ä¸ŠæµåŠ¨ï¼‰ï¼Œå…·æœ‰å›ºå®šçš„è¯»ç«¯å’Œå†™ç«¯ å®ƒåªèƒ½ç”¨äºå…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼ˆä¹Ÿæ˜¯çˆ¶å­è¿›ç¨‹æˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´ï¼‰ å®ƒå¯ä»¥çœ‹æˆæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå¯¹äºå®ƒçš„è¯»å†™ä¹Ÿå¯ä»¥ä½¿ç”¨æ™®é€šçš„readã€writeç­‰å‡½æ•°ã€‚ä½†æ˜¯å®ƒä¸æ˜¯æ™®é€šçš„æ–‡ä»¶ï¼Œå¹¶ä¸å±äºå…¶ä»–ä»»ä½•æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”åªå­˜åœ¨äºå†…å­˜ä¸­ã€‚ 1.2 å‘½åç®¡é“FIFOï¼š FIFOå¯ä»¥åœ¨æ— å…³çš„è¿›ç¨‹ä¹‹é—´äº¤æ¢æ•°æ® FIFOæœ‰è·¯å¾„åä¸ä¹‹ç›¸å…³è”ï¼Œå®ƒä»¥ä¸€ç§ç‰¹æ®Šè®¾å¤‡æ–‡ä»¶å½¢å¼å­˜åœ¨äºæ–‡ä»¶ç³»ç»Ÿä¸­ã€‚ 2. ç³»ç»ŸIPCï¼š 2.1 æ¶ˆæ¯é˜Ÿåˆ— æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ˜¯æ¶ˆæ¯çš„é“¾æ¥è¡¨ï¼Œå­˜æ”¾åœ¨å†…æ ¸ä¸­ã€‚ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ç”±ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼ˆå³é˜Ÿåˆ—IDï¼‰æ¥æ ‡è®°ã€‚ (æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº†ä¿¡å·ä¼ é€’ä¿¡æ¯å°‘ï¼Œç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ç­‰ç‰¹ç‚¹)å…·æœ‰å†™æƒé™å¾—è¿›ç¨‹å¯ä»¥æŒ‰ç…§ä¸€å®šå¾—è§„åˆ™å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ·»åŠ æ–°ä¿¡æ¯ï¼›å¯¹æ¶ˆæ¯é˜Ÿåˆ—æœ‰è¯»æƒé™å¾—è¿›ç¨‹åˆ™å¯ä»¥ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–ä¿¡æ¯ï¼› ç‰¹ç‚¹ï¼š æ¶ˆæ¯é˜Ÿåˆ—æ˜¯é¢å‘è®°å½•çš„ï¼Œå…¶ä¸­çš„æ¶ˆæ¯å…·æœ‰ç‰¹å®šçš„æ ¼å¼ä»¥åŠç‰¹å®šçš„ä¼˜å…ˆçº§ã€‚ æ¶ˆæ¯é˜Ÿåˆ—ç‹¬ç«‹äºå‘é€ä¸æ¥æ”¶è¿›ç¨‹ã€‚è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—åŠå…¶å†…å®¹å¹¶ä¸ä¼šè¢«åˆ é™¤ã€‚ æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å®ç°æ¶ˆæ¯çš„éšæœºæŸ¥è¯¢,æ¶ˆæ¯ä¸ä¸€å®šè¦ä»¥å…ˆè¿›å…ˆå‡ºçš„æ¬¡åºè¯»å–,ä¹Ÿå¯ä»¥æŒ‰æ¶ˆæ¯çš„ç±»å‹è¯»å–ã€‚ 2.2 ä¿¡å·é‡semaphore ä¿¡å·é‡ï¼ˆsemaphoreï¼‰ä¸å·²ç»ä»‹ç»è¿‡çš„ IPC ç»“æ„ä¸åŒï¼Œå®ƒæ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶å¤šä¸ªè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚ä¿¡å·é‡ç”¨äºå®ç°è¿›ç¨‹é—´çš„äº’æ–¥ä¸åŒæ­¥ï¼Œè€Œä¸æ˜¯ç”¨äºå­˜å‚¨è¿›ç¨‹é—´é€šä¿¡æ•°æ®ã€‚ ç‰¹ç‚¹ï¼š ä¿¡å·é‡ç”¨äºè¿›ç¨‹é—´åŒæ­¥ï¼Œè‹¥è¦åœ¨è¿›ç¨‹é—´ä¼ é€’æ•°æ®éœ€è¦ç»“åˆå…±äº«å†…å­˜ã€‚ ä¿¡å·é‡åŸºäºæ“ä½œç³»ç»Ÿçš„ PV æ“ä½œï¼Œç¨‹åºå¯¹ä¿¡å·é‡çš„æ“ä½œéƒ½æ˜¯åŸå­æ“ä½œã€‚ æ¯æ¬¡å¯¹ä¿¡å·é‡çš„ PV æ“ä½œä¸ä»…é™äºå¯¹ä¿¡å·é‡å€¼åŠ  1 æˆ–å‡ 1ï¼Œè€Œä¸”å¯ä»¥åŠ å‡ä»»æ„æ­£æ•´æ•°ã€‚ æ”¯æŒä¿¡å·é‡ç»„ã€‚ 2.3 ä¿¡å·signalä¿¡å·æ˜¯ä¸€ç§æ¯”è¾ƒå¤æ‚çš„é€šä¿¡æ–¹å¼ï¼Œç”¨äºé€šçŸ¥æ¥æ”¶è¿›ç¨‹æŸä¸ªäº‹ä»¶å·²ç»å‘ç”Ÿã€‚ 2.4 å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰å®ƒä½¿å¾—å¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹å¯ä»¥åŠæ—¶çœ‹åˆ°å¯¹æ–¹è¿›ç¨‹ä¸­å¯¹å…±äº«å†…å­˜ä¸­æ•°æ®å¾—æ›´æ–°ã€‚è¿™ç§æ–¹å¼éœ€è¦ä¾é æŸç§åŒæ­¥æ“ä½œï¼Œå¦‚äº’æ–¥é”å’Œä¿¡å·é‡ç­‰ ç‰¹ç‚¹ï¼š å…±äº«å†…å­˜æ˜¯æœ€å¿«çš„ä¸€ç§IPCï¼Œå› ä¸ºè¿›ç¨‹æ˜¯ç›´æ¥å¯¹å†…å­˜è¿›è¡Œå­˜å– å› ä¸ºå¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶æ“ä½œï¼Œæ‰€ä»¥éœ€è¦è¿›è¡ŒåŒæ­¥ ä¿¡å·é‡+å…±äº«å†…å­˜é€šå¸¸ç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ï¼Œä¿¡å·é‡ç”¨æ¥åŒæ­¥å¯¹å…±äº«å†…å­˜çš„è®¿é—® 3.å¥—æ¥å­—SOCKETï¼šsocketä¹Ÿæ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œä¸å…¶ä»–é€šä¿¡æœºåˆ¶ä¸åŒçš„æ˜¯ï¼Œå®ƒå¯ç”¨äºä¸åŒä¸»æœºä¹‹é—´çš„è¿›ç¨‹é€šä¿¡ã€‚ çº¿ç¨‹é—´é€šä¿¡çš„æ–¹å¼: ä¸´ç•ŒåŒºï¼šé€šè¿‡å¤šçº¿ç¨‹çš„ä¸²è¡ŒåŒ–æ¥è®¿é—®å…¬å…±èµ„æºæˆ–ä¸€æ®µä»£ç ï¼Œé€Ÿåº¦å¿«ï¼Œé€‚åˆæ§åˆ¶æ•°æ®è®¿é—®ï¼› äº’æ–¥é‡Synchronized/Lockï¼šé‡‡ç”¨äº’æ–¥å¯¹è±¡æœºåˆ¶ï¼Œåªæœ‰æ‹¥æœ‰äº’æ–¥å¯¹è±¡çš„çº¿ç¨‹æ‰æœ‰è®¿é—®å…¬å…±èµ„æºçš„æƒé™ã€‚å› ä¸ºäº’æ–¥å¯¹è±¡åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯å…¬å…±èµ„æºä¸ä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—® ä¿¡å·é‡Semphareï¼šä¸ºæ§åˆ¶å…·æœ‰æœ‰é™æ•°é‡çš„ç”¨æˆ·èµ„æºè€Œè®¾è®¡çš„ï¼Œå®ƒå…è®¸å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶åˆ»å»è®¿é—®åŒä¸€ä¸ªèµ„æºï¼Œä½†ä¸€èˆ¬éœ€è¦é™åˆ¶åŒä¸€æ—¶åˆ»è®¿é—®æ­¤èµ„æºçš„æœ€å¤§çº¿ç¨‹æ•°ç›®ã€‚ äº‹ä»¶(ä¿¡å·)ï¼ŒWait/Notifyï¼šé€šè¿‡é€šçŸ¥æ“ä½œçš„æ–¹å¼æ¥ä¿æŒå¤šçº¿ç¨‹åŒæ­¥ï¼Œè¿˜å¯ä»¥æ–¹ä¾¿çš„å®ç°å¤šçº¿ç¨‹ä¼˜å…ˆçº§çš„æ¯”è¾ƒæ“ä½œè¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼š è¿›ç¨‹é—´é€šä¿¡ä¸»è¦åŒ…æ‹¬ç®¡é“ã€ç³»ç»ŸIPCï¼ˆåŒ…æ‹¬æ¶ˆæ¯é˜Ÿåˆ—ã€ä¿¡å·é‡ã€ä¿¡å·ã€å…±äº«å†…å­˜ç­‰ï¼‰ã€ä»¥åŠå¥—æ¥å­—socketã€‚ ç®—æ³•105. ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘ - LeetCode ç”¨æ ˆå®ç°é˜Ÿåˆ—äºŒå‰æ ‘å±‚åºéå†Kä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨https://leetcode-cn.com/problems/reverse-nodes-in-k-group/LeetCode 680. éªŒè¯å›æ–‡å­—ç¬¦ä¸² â…¡Leetcode easy 617. åˆå¹¶äºŒå‰æ ‘ æ±‚æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹æ•°å­—ä¹‹å’Œ","link":"/2021/11/22/HighFrequencyIssue/"},{"title":"LiveData","text":"ç®€è¿°ï¼š æ•°æ®å®æ—¶æ›´æ–°ã€å®‰å…¨æ›´æ–°ï¼šå½“liveDataçš„setValueè¢«è°ƒç”¨æ—¶ï¼Œä¼šéå†è‡ªèº«æ‰€æœ‰observerå¹¶considerNotifyï¼Œæ­¤æ—¶ä¼šåˆ¤æ–­observerçš„æ´»è·ƒçŠ¶æ€ï¼ˆshouldBeActiveï¼‰å’Œå†…éƒ¨ç‰ˆæœ¬ï¼Œå†³å®šæ˜¯å¦å‘å…¶å‘é€é€šçŸ¥ã€‚ é¿å…å†…å­˜æ³„æ¼ï¼šä¼ å…¥lifeCycleOwnerå³èµ°observe()çš„LiveDataä¼šåœ¨lifeCycleOwnerå›è°ƒonStateChangedä¸ºDESTROYEDçš„æ—¶å€™ç§»é™¤æ‰observeré˜²æ­¢å†…å­˜æ³„éœ²ï¼Œè€Œç›¸å¯¹çš„observeForeveråˆ™ç”±äºæ²¡æœ‰ownerè€Œæ— æ­¤ç‰¹æ€§ã€‚ è§£å†³Configuration Changeé—®é¢˜ã€ç²˜æ€§æ•°æ®ï¼šä¸€èˆ¬è€Œè¨€observeræ˜¯åœ¨onCreateä¸­è°ƒç”¨çš„ï¼ŒliveData.observeræ–¹æ³•åœ¨è°ƒç”¨æ—¶ä¹Ÿä¼šç«‹å³è¢«æ¨é€liveDataä¸­æœ€åä¸€æ¬¡æ•°æ®ã€‚ï¼ˆä¼šå¯¼è‡´æ‰€è°“çš„æ•°æ®å€’çŒï¼‰ã€‚Configuration Changeæ—¶ä¼šViewModelä¼šä»å½“å‰Activityæˆ–fragmentManagerçš„viewModelStoreçš„ç¼“å­˜ä¸­é‡æ–°å–å‡ºï¼Œè€ŒViewModelä¸­çš„liveDataè‡ªç„¶ä¹Ÿä¼šä¿ç•™ã€‚ https://zhuanlan.zhihu.com/p/593472898 Featrue UIå’Œå®æ—¶æ•°æ®ä¿æŒä¸€è‡´ å› ä¸ºLiveDataé‡‡ç”¨çš„æ˜¯è§‚å¯Ÿè€…æ¨¡å¼ï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥åœ¨æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶è·å¾—é€šçŸ¥ï¼Œæ›´æ–°UIã€‚ é¿å…å†…å­˜æ³„æ¼ è§‚å¯Ÿè€…è¢«ç»‘å®šåˆ°ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸä¸Šï¼Œå½“è¢«ç»‘å®šçš„ç»„ä»¶é”€æ¯ï¼ˆdestroyï¼‰æ—¶ï¼Œè§‚å¯Ÿè€…ä¼šç«‹åˆ»è‡ªåŠ¨æ¸…ç†è‡ªèº«çš„æ•°æ®ã€‚ ä¸ä¼šå†äº§ç”Ÿç”±äºActivityå¤„äºstopçŠ¶æ€è€Œå¼•èµ·çš„å´©æºƒï¼Œä¾‹å¦‚ï¼šå½“Activityå¤„äºåå°çŠ¶æ€æ—¶ï¼Œæ˜¯ä¸ä¼šæ”¶åˆ°LiveDataçš„ä»»ä½•äº‹ä»¶çš„ã€‚ ä¸éœ€è¦å†è§£å†³ç”Ÿå‘½å‘¨æœŸå¸¦æ¥çš„é—®é¢˜ LiveDataå¯ä»¥æ„ŸçŸ¥è¢«ç»‘å®šçš„ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œåªæœ‰åœ¨æ´»è·ƒçŠ¶æ€æ‰ä¼šé€šçŸ¥æ•°æ®å˜åŒ–ã€‚ å®æ—¶æ•°æ®åˆ·æ–° å½“ç»„ä»¶å¤„äºæ´»è·ƒçŠ¶æ€æˆ–è€…ä»ä¸æ´»è·ƒçŠ¶æ€åˆ°æ´»è·ƒçŠ¶æ€æ—¶æ€»æ˜¯èƒ½æ”¶åˆ°æœ€æ–°çš„æ•°æ®ã€‚ è§£å†³Configuration Changeé—®é¢˜ åœ¨å±å¹•å‘ç”Ÿæ—‹è½¬æˆ–è€…è¢«å›æ”¶å†æ¬¡å¯åŠ¨ï¼Œç«‹åˆ»å°±èƒ½æ”¶åˆ°æœ€æ–°çš„æ•°æ®ã€‚ å¸¸ç”¨å®ç°ç±»https://chatgpt.com/c/21580ee8-b685-48be-a510-712388ae346e LiveDataå¸¸ç”¨äºMVVMä¸­ï¼ŒViewModelå‘Viewå±‚æä¾›è®¢é˜…çš„å•å‘æ•°æ®æºã€‚ä¸€èˆ¬å®è·µä¸­ä¼šæ ¹æ®â€å•ä¸€æ•°æ®æºçœŸç›¸â€åŸåˆ™ï¼Œåœ¨ViewModelå±‚ä¸­æ”¶æ•›æ‰€æœ‰çš„å¯å˜MutableLiveDataï¼Œåªå¯¹Viewå±‚æä¾›ä¸å¯å˜çš„LiveDataã€‚Viewå±‚è¡Œä¸ºåº”é€šè¿‡è°ƒç”¨ViewModelçš„æ–¹æ³•å˜æ›´æ•°æ®ã€‚ åœ¨MVVMæ¶æ„ä¸­ï¼ŒViewå±‚ä¸åº”è¯¥ç›´æ¥æ”¹å˜ViewModelä¸­çš„æ•°æ®çŠ¶æ€ã€‚è¿™æ˜¯ä¸ºäº†ä¿æŒæ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ã€‚å…·ä½“æ¥è¯´ï¼š Viewå±‚ï¼šä¸»è¦è´Ÿè´£æ˜¾ç¤ºæ•°æ®å’Œå¤„ç†ç”¨æˆ·äº¤äº’ã€‚å®ƒå¯ä»¥è§‚å¯ŸLiveDataå¹¶æ ¹æ®æ•°æ®å˜åŒ–æ›´æ–°UIã€‚ ViewModelå±‚ï¼šè´Ÿè´£å‡†å¤‡å’Œç®¡ç†ä¸UIç›¸å…³çš„æ•°æ®ã€‚å®ƒé€šè¿‡MutableLiveDataæ›´æ–°æ•°æ®ï¼Œå¹¶æš´éœ²LiveDataç»™Viewå±‚ä»¥ä¾›è§‚å¯Ÿã€‚ Modelå±‚ï¼šè´Ÿè´£æ•°æ®æ“ä½œï¼Œå¦‚ç½‘ç»œè¯·æ±‚å’Œæ•°æ®åº“æ“ä½œã€‚ å·¥ä½œæµç¨‹ Viewè§‚å¯ŸViewModelä¸­çš„LiveDataï¼šViewå±‚é€šè¿‡è§‚å¯ŸViewModelä¸­æš´éœ²çš„LiveDataï¼Œæ¥æ”¶æ•°æ®å˜åŒ–å¹¶æ›´æ–°UIã€‚ ç”¨æˆ·äº¤äº’é€šè¿‡Viewé€šçŸ¥ViewModelï¼šå½“ç”¨æˆ·ä¸UIäº¤äº’æ—¶ï¼ŒViewå±‚è°ƒç”¨ViewModelä¸­çš„æ–¹æ³•ï¼Œä¼ é€’ç”¨æˆ·åŠ¨ä½œæˆ–è¾“å…¥ã€‚ ViewModelæ›´æ–°æ•°æ®ï¼šViewModelå¤„ç†ç”¨æˆ·çš„è¾“å…¥ï¼Œè¿›è¡Œå¿…è¦çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œå¹¶é€šè¿‡æ›´æ–°MutableLiveDataæ¥æ”¹å˜æ•°æ®çŠ¶æ€ã€‚ Viewå±‚æ”¶åˆ°æ›´æ–°å¹¶æ›´æ–°UIï¼šç”±äºViewè§‚å¯Ÿäº†LiveDataï¼Œå½“ViewModelä¸­çš„æ•°æ®çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒViewä¼šè‡ªåŠ¨æ”¶åˆ°é€šçŸ¥å¹¶æ›´æ–°UIã€‚ å‡è®¾ä½ æœ‰ä¸€ä¸ªæŒ‰é’®ç‚¹å‡»äº‹ä»¶æ¥æ›´æ–°æ•°æ®ï¼š 12345678// åœ¨Viewå±‚ï¼ˆä¾‹å¦‚Activityæˆ–Fragmentï¼‰ä¸­viewModel.buttonClicked.observe(this, Observer { newText -&gt; textView.text = newText})button.setOnClickListener { viewModel.onButtonClicked()} åœ¨ViewModelä¸­ï¼š 123456789class TestViewModel : ViewModel() { private val _buttonClicked: MutableLiveData&lt;String&gt; = MutableLiveData() val buttonClicked: LiveData&lt;String&gt; = _buttonClicked fun onButtonClicked() { // æ›´æ–°æ•°æ® _buttonClicked.value = &quot;æŒ‰é’®ç‚¹å‡»äº†&quot; }} å…³é”®ç‚¹ Viewå±‚ä¸ç›´æ¥ä¿®æ”¹æ•°æ®ï¼šViewå±‚é€šè¿‡è°ƒç”¨ViewModelä¸­çš„æ–¹æ³•æ¥è¯·æ±‚æ•°æ®æ›´æ–°ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹LiveDataã€‚ ViewModelè´Ÿè´£æ•°æ®æ›´æ–°ï¼šViewModelæ¥æ”¶Viewå±‚çš„è¯·æ±‚ï¼Œæ›´æ–°MutableLiveDataä¸­çš„æ•°æ®ã€‚ æ•°æ®å˜åŒ–é€šçŸ¥Viewå±‚ï¼šLiveDataçš„æ•°æ®å˜åŒ–ä¼šé€šçŸ¥è§‚å¯Ÿè€…ï¼ˆViewå±‚ï¼‰ï¼Œå¹¶æ›´æ–°UIã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç¡®ä¿äº†Viewå±‚ä¸ViewModelå±‚ä¹‹é—´çš„èŒè´£æ¸…æ™°åˆ†ç¦»ï¼Œå¹¶ä¸”æ•°æ®çŠ¶æ€çš„ç®¡ç†æ˜¯é›†ä¸­ä¸”å¯æ§çš„ã€‚ LiveData ä¸å¯å˜çš„ï¼ˆä¸€èˆ¬ä½œä¸ºViewModelå¯¹Viewå±‚æä¾›çš„å•å‘æ•°æ®æºï¼‰ MutableLiveDataå¯å˜çš„ï¼ˆä¸€èˆ¬ç”¨äºViewModelå±‚å†…éƒ¨å˜æ›´æ•°æ®ï¼Œä¼šç”¨å¯¹å¤–æä¾›LiveDataåŒååŠ ä¸‹åˆ’çº¿å‰ç¼€å‘½åï¼‰ https://developer.android.com/reference/android/arch/lifecycle/MutableLiveData MediatorLiveDataå¯å˜çš„ã€ç›‘å¬å¤šæºçš„ https://developer.android.com/reference/android/arch/lifecycle/MediatorLiveData åŸç†æˆ‘ä»¬çŸ¥é“ livedata çš„ä½¿ç”¨å¾ˆç®€å•ï¼Œå®ƒæ˜¯é‡‡ç”¨è§‚å¯Ÿè€…æ¨¡å¼å®ç°çš„ æ·»åŠ è§‚å¯Ÿè€… åœ¨æ•°æ®æ”¹å˜çš„æ—¶å€™è®¾ç½® valueï¼Œè¿™æ ·ä¼šå›è°ƒ Observer çš„ onChanged æ–¹æ³• 1234567public interface Observer&lt;T&gt; { /** * Called when the data is changed. * @param t The new data */ void onChanged(T t);} observeæ–¹æ³•LiveDataåŒ…å«ä¸¤ä¸ªç”¨äºæ·»åŠ æ•°æ®è§‚å¯Ÿè€…ï¼ˆObserverï¼‰çš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ observe(LifecycleOwner , Observer) ç”Ÿå‘½å‘¨æœŸå®‰å…¨çš„ observeForever(Observer) ä¸¤ä¸ªæ–¹æ³•çš„åŒºåˆ«å¯¹äºå¤–éƒ¨æ¥è¯´åªåœ¨äºæ˜¯å¦æä¾›äº†ç”Ÿå‘½å‘¨æœŸå®‰å…¨çš„ä¿éšœã€‚ ç”Ÿå‘½å‘¨æœŸå®‰å…¨çš„observe12345678910111213141516171819202122232425262728@MainThread public void observe(@NonNull LifecycleOwner owner, @NonNull Observer&lt;? super T&gt; observer) { //é™å®šåªèƒ½åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ observe æ–¹æ³• assertMainThread(&quot;observe&quot;); //å½“ Lifecycle å·²ç»å¤„äº DESTROYED çŠ¶æ€æ—¶ï¼Œæ­¤æ—¶è¿›è¡Œ observe æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œç›´æ¥è¿”å› if (owner.getLifecycle().getCurrentState() == DESTROYED) { // ignore return; } //æ ¹æ®ä¼ å…¥å‚æ•°æ„å»ºä¸€ä¸ªæ–°çš„ä»£ç† Observer LifecycleBoundObserver wrapper = new LifecycleBoundObserver(owner, observer); //å°† observer ä½œä¸º keyï¼Œwrapper ä½œä¸º value è¿›è¡Œå­˜å‚¨ //å½“ mObservers ä¸åŒ…å«è¯¥ key æ—¶ï¼Œè°ƒç”¨ putIfAbsent ä¼šè¿”å› null //å½“ mObservers å·²åŒ…å«è¯¥ key æ—¶ï¼Œè°ƒç”¨ putIfAbsent ä¸ä¼šå­˜å‚¨ key-valueï¼Œå¹¶ä¼šè¿”å›ä¹‹å‰ä¿å­˜çš„ value ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper); if (existing != null &amp;&amp; !existing.isAttachedTo(owner)) { //èµ°åˆ°æ­¤æ­¥ï¼Œè¯´æ˜ä¹‹å‰ LiveData å†…éƒ¨å·²ç»æŒæœ‰äº† observer å¯¹è±¡ï¼Œ //ä¸”è¯¥ observer å¯¹è±¡å·²ç»ç»‘å®šäº†å…¶å®ƒçš„ LifecycleOwner å¯¹è±¡ //æ­¤æ—¶ç›´æ¥æŠ›å‡ºå¼‚å¸¸ throw new IllegalArgumentException(&quot;Cannot add the same observer&quot; + &quot; with different lifecycles&quot;); } if (existing != null) { //observer ä¹‹å‰å·²ç»ä¼ è¿›æ¥è¿‡äº†ï¼Œæ­¤å¤„ç›´æ¥è¿”å› return; } owner.getLifecycle().addObserver(wrapper); } ä¼ å…¥çš„LifecycleOwnerå‚æ•°æ„å‘³ç€æºå¸¦äº†Lifecycleå¯¹è±¡ï¼ŒLiveDataå†…éƒ¨å°±æ ¹æ® Lifecycleçš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„å›è°ƒå˜åŒ–åœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œæ•°æ®é€šçŸ¥ï¼Œå¹¶åœ¨ Lifecycleå¯¹è±¡å¤„äºDESTROYEDçŠ¶æ€æ—¶è‡ªåŠ¨ç§»é™¤Observerï¼Œè¿™ä¹Ÿæ˜¯LiveDataé¿å…å†…å­˜æ³„æ¼çš„æœ€é‡è¦çš„ä¸€ä¸ªç‚¹ã€‚ ä¸Šé¢çš„ä»£ç ä½¿ç”¨åˆ°äº†LifecycleBoundObserverï¼Œå®ƒæ˜¯æŠ½è±¡ç±»ObserverWrapperçš„å®ç°ç±»ã€‚ObserverWrapperç”¨äºåŒ…è£…å¤–éƒ¨ä¼ è¿›æ¥çš„Observerå¯¹è±¡ï¼Œä¸ºå­ç±»å®šä¹‰å¥½ç‰¹å®šçš„æŠ½è±¡æ–¹æ³•å’Œå…±ç”¨é€»è¾‘ï¼Œä¸»è¦æ˜¯æä¾›äº†å…±ç”¨çš„çŠ¶æ€åˆ†å‘å‡½æ•°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041class LifecycleBoundObserver extends ObserverWrapper implements LifecycleEventObserver { @NonNull final LifecycleOwner mOwner; LifecycleBoundObserver(@NonNull LifecycleOwner owner, Observer&lt;? super T&gt; observer) { super(observer); mOwner = owner; } @Override boolean shouldBeActive() { //åªæœ‰å½“ Lifecycle çš„å½“å‰çŠ¶æ€æ˜¯ STARTED æˆ–è€… RESUMED æ—¶ //æ‰è®¤ä¸º Lifecycle æ˜¯å¤„äºæ´»è·ƒçŠ¶æ€ return mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED); } //LifecycleEventObserver çš„å®ç°æ–¹æ³• //å½“ Lifecycle çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å°±ä¼šè°ƒç”¨æ­¤æ–¹æ³• @Override public void onStateChanged(@NonNull LifecycleOwner source, @NonNull Lifecycle.Event event) { //å¦‚æœ Lifecycle å·²ç»å¤„äº DESTROYED çŠ¶æ€äº†,åˆ™ä¸»åŠ¨ç§»é™¤ mObserver //è¿™å°±æ˜¯ LiveData å¯ä»¥é¿å…å†…å­˜æ³„éœ²æœ€é‡è¦çš„ä¸€ä¸ªç‚¹ if (mOwner.getLifecycle().getCurrentState() == DESTROYED) { removeObserver(mObserver); return; } activeStateChanged(shouldBeActive()); } @Override boolean isAttachedTo(LifecycleOwner owner) { return mOwner == owner; } @Override void detachObserver() { //ç§»é™¤ mObserver mOwner.getLifecycle().removeObserver(this); }} LifecycleBoundObserverä¼šä¿è¯å½“LiveDataä¾èµ–çš„ç”Ÿå‘½å‘¨æœŸè½¬åˆ°éæ´»è·ƒæ—¶ï¼Œä¸è¿›è¡Œé€šçŸ¥ï¼ˆå¦‚æœDESTROYä¼šç›´æ¥ç§»é™¤Observerï¼‰ï¼›å½“è½¬åˆ°æ´»è·ƒæ—¶ä¸”æ•°æ®ç‰ˆæœ¬æ›´æ–°äº†åˆ™å‘å…¶å‘èµ·å›è°ƒã€‚ LifecycleBoundObserverçš„æ•´ä¸ªäº‹ä»¶æµç¨‹æ˜¯è¿™æ ·çš„ï¼š Lifecycleçš„ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–ï¼Œä»è€Œå›è°ƒäº†onStateChangedå‡½æ•° onStateChangedå‡½æ•°é¦–å…ˆåˆ¤æ–­Lifecycleæ˜¯å¦å·²å¤„äºDESTROYEDçŠ¶æ€ï¼Œæ˜¯çš„è¯åˆ™ç›´æ¥ç§»é™¤Observerï¼Œæ•´ä¸ªå›è°ƒæµç¨‹ç»“æŸï¼Œå¦åˆ™åˆ™ç»§ç»­ä»¥ä¸‹æµç¨‹ onStateChangedè°ƒç”¨äº†activeStateChanged()å‡½æ•°ï¼ŒactiveStateChanged()å‡½æ•°åˆ¤æ–­Lifecycleçš„æ´»è·ƒçŠ¶æ€æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœä»éæ´»è·ƒçŠ¶æ€åˆ‡æ¢åˆ°äº†æ´»è·ƒçŠ¶æ€ï¼Œæ˜¯çš„è¯åˆ™è°ƒç”¨dispatchingValue()å‡½æ•°æ¥åˆ†å‘å€¼ï¼Œæœ€ç»ˆå†æ ¹æ®ObserverWrapperå†…éƒ¨çš„valueç‰ˆæœ¬å·mLastVersionæ¥åˆ¤æ–­æ˜¯å¦æœ‰æ–°å€¼éœ€è¦å‘å…¶å›è°ƒï¼Œæ˜¯çš„è¯åˆ™å‘å…¶å›è°ƒæ–°å€¼ï¼Œå¦åˆ™åˆ™è¿”å› 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354private abstract class ObserverWrapper { //å¤–éƒ¨ä¼ è¿›æ¥çš„å¯¹ LiveData è¿›è¡Œæ•°æ®ç›‘å¬çš„ Observer final Observer&lt;? super T&gt; mObserver; //ç”¨äºæ ‡è®° mObserver æ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€ boolean mActive; //ç”¨äºæ ‡è®° Observer å†…æœ€åä¸€ä¸ªè¢«å›è°ƒçš„ value çš„æ–°æ—§ç¨‹åº¦ int mLastVersion = START_VERSION; ObserverWrapper(Observer&lt;? super T&gt; observer) { mObserver = observer; } //ç”¨äºè·å–å½“å‰ Lifecycle æ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€ abstract boolean shouldBeActive(); //ç”¨äºåˆ¤æ–­ mObserver æ˜¯å¦å’Œ LifecycleOwnerï¼ˆå³ Lifecycleï¼‰æœ‰ç»‘å®šå…³ç³» boolean isAttachedTo(LifecycleOwner owner) { return false; } //ç§»é™¤ mObserver void detachObserver() { } void activeStateChanged(boolean newActive) { if (newActive == mActive) { return; } // immediately set active state, so we'd never dispatch anything to inactive // owner mActive = newActive; //åˆ¤æ–­å½“å‰ LiveData æ‰€æœ‰çš„ Observer æ˜¯å¦éƒ½å¤„äºéæ´»è·ƒçŠ¶æ€ boolean wasInactive = LiveData.this.mActiveCount == 0; //æ›´æ–° LiveData å½“å‰æ‰€æœ‰å¤„äºæ´»è·ƒçŠ¶æ€çš„ Observer çš„æ•°é‡ LiveData.this.mActiveCount += mActive ? 1 : -1; if (wasInactive &amp;&amp; mActive) { //å¦‚æœ LiveData å¤„äºæ´»è·ƒçŠ¶æ€çš„ Observer æ•°é‡ä» 0 å˜æˆäº† 1, //åˆ™å›è°ƒ onActive æ–¹æ³• onActive(); } if (LiveData.this.mActiveCount == 0 &amp;&amp; !mActive) { //å¦‚æœ LiveData å¤„äºæ´»è·ƒçŠ¶æ€çš„ Observer æ•°é‡ä» 1 å˜æˆäº† 0, //åˆ™å›è°ƒ onInactive æ–¹æ³• onInactive(); } if (mActive) { //å¦‚æœ mObserver å˜æˆäº†æ´»è·ƒçŠ¶æ€ï¼Œåˆ™å‘å…¶å›è°ƒæ–°å€¼ dispatchingValue(this); } }} ObserverWrapperä¸€å…±æœ‰ä¸¤ä¸ªå­ç±»ï¼š LifecycleBoundObserverå’ŒAlwaysActiveObserverï¼Œä¸¤è€…çš„å·®åˆ«å°±åœ¨äºæ˜¯å¦å’Œç”Ÿå‘½å‘¨æœŸç›¸ç»‘å®šã€‚ éç”Ÿå‘½å‘¨æœŸå®‰å…¨çš„observeForever12345678910111213141516171819@MainThreadpublic void observeForever(@NonNull Observer&lt;? super T&gt; observer) { //é™å®šåªèƒ½åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ observe æ–¹æ³• assertMainThread(&quot;observeForever&quot;); AlwaysActiveObserver wrapper = new AlwaysActiveObserver(observer); ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper); if (existing instanceof LiveData.LifecycleBoundObserver) { //ä¼šèµ°åˆ°è¿™ä¸€æ­¥ï¼Œæ˜¯å› ä¸ºä¹‹å‰å·²ç»å…ˆç”¨è¯¥ observer å¯¹è±¡è°ƒç”¨äº† observe(LifecycleOwner,Observer) //è¿™é‡Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ throw new IllegalArgumentException(&quot;Cannot add the same observer&quot; + &quot; with different lifecycles&quot;); } if (existing != null) { //å¦‚æœä¹‹å‰å·²ç»æ·»åŠ è¿‡ observer å¯¹è±¡äº†çš„è¯ï¼Œåˆ™ç›´æ¥è¿”å› return; } //ä¸»åŠ¨è§¦å‘ activeStateChanged å‡½æ•°ï¼Œå› ä¸ºå½“å‰ LiveData å¯èƒ½å·²ç»è¢«è®¾ç½®å€¼äº† wrapper.activeStateChanged(true);} ä¸Šé¢ä»£ç ä½¿ç”¨åˆ°äº†AlwaysActiveObserverï¼Œå®ƒä¹Ÿæ˜¯æŠ½è±¡ç±»ObserverWrapperçš„å®ç°ç±»ï¼Œå…¶shouldBeActive()è¿”å›å€¼å›ºå®šä¸ºtrueï¼Œæ„å‘³ç€åªè¦æœ‰æ•°æ®å˜åŒ–éƒ½ä¼šè¿›è¡Œå›è°ƒã€‚æ‰€ä»¥ä½¿ç”¨observeForever()å‡½æ•°ä¸€å®šè¦åœ¨è¿‡åä¸»åŠ¨ç§»é™¤Observerï¼Œé¿å…å†…å­˜æ³„éœ²å’ŒNPEã€‚ æ›´æ–°LiveDataçš„å€¼æ›´æ–°LiveDataçš„å€¼çš„æ–¹æ³•ä¸€å…±æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ï¼š setValue(T value) postValue(T value) setValuesetValue(T)å‡½æ•°è¢«é™å®šåœ¨åªèƒ½ä¸»çº¿ç¨‹è¿›è¡Œè°ƒç”¨ã€‚ 123456789101112131415161718/** * Sets the value. If there are active observers, the value will be dispatched to them. * &lt;p&gt; * This method must be called from the main thread. If you need set a value from a background * thread, you can use {@link #postValue(Object)} * * @param value The new value */@MainThreadprotected void setValue(T value) { assertMainThread(&quot;setValue&quot;); //æ›´æ–°å½“å‰ value çš„ç‰ˆæœ¬å·ï¼Œå³ value çš„æ–°æ—§ç¨‹åº¦ mVersion++; mData = value; dispatchingValue(null);} dispatchingValue()å‡½æ•°è®¾è®¡å¾—æ¯”è¾ƒå·§å¦™ï¼Œç”¨ä¸¤ä¸ªå…¨å±€çš„å¸ƒå°”å˜é‡mDispatchingValueå’ŒmDispatchInvalidatedå°±å®ç°äº†æ–°æ—§å€¼åˆ¤æ–­ã€æ—§å€¼èˆå¼ƒã€æ–°å€¼é‡æ–°å…¨å±€å‘å¸ƒçš„é€»è¾‘ã€‚ 123456789101112131415161718192021222324252627//initiator ä¸º null åˆ™è¯´æ˜éœ€è¦éå†å›è°ƒæ•´ä¸ª mObservers//initiator ä¸ä¸º null åˆ™è¯´æ˜ä»…å›è°ƒ initiator æœ¬èº«void dispatchingValue(@Nullable ObserverWrapper initiator) { //å¦‚æœå½“å‰æ­£å¤„äºå‘ mObservers å‘å¸ƒ mData çš„è¿‡ç¨‹ä¸­ï¼ˆå³ mDispatchingValue ä¸º trueï¼‰ //åˆ™å°† mDispatchInvalidated ç½®ä¸º trueï¼Œç”¨äºæ ‡æ˜æœ‰æ–°å€¼åˆ°æ¥ï¼Œæ­£åœ¨å›è°ƒçš„å€¼æ˜¯å·²ç»è¿‡æ—¶çš„äº† if (mDispatchingValue) { mDispatchInvalidated = true; return; } mDispatchingValue = true; do { mDispatchInvalidated = false; if (initiator != null) { considerNotify(initiator); initiator = null; } else { for (Iterator&lt;Map.Entry&lt;Observer&lt;? super T&gt;, ObserverWrapper&gt;&gt; iterator = mObservers.iteratorWithAdditions(); iterator.hasNext(); ) { considerNotify(iterator.next().getValue()); if (mDispatchInvalidated) { break; } } } } while (mDispatchInvalidated); mDispatchingValue = false;} 123456789101112131415161718192021// åˆ¤æ–­æ˜¯å¦è¦å°†æ•°æ®åˆ†å‘åˆ°æŒ‡å®šçš„ ObserverWrapperprivate void considerNotify(ObserverWrapper observer) { //å¦‚æœ observer å¤„äºéæ´»è·ƒçŠ¶æ€ï¼Œåˆ™ç›´æ¥è¿”å› if (!observer.mActive) { return; } //æ­¤å¤„åˆ¤æ–­ä¸»è¦æ˜¯ä¸ºäº†ç…§é¡¾ LifecycleBoundObserver //ç”±äº Lifecycle æœ‰å¯èƒ½çŠ¶æ€å€¼ State å·²ç»åˆ‡æ¢åˆ°äº†éæ´»è·ƒçŠ¶æ€ï¼Œä½† LifecycleBoundObserver è¿˜æœªæ”¶åˆ°äº‹ä»¶é€šçŸ¥ //æ‰€ä»¥ä¸ºäº†é¿å…æ„å¤–æƒ…å†µï¼Œæ­¤å¤„ä¸»åŠ¨æ£€æŸ¥ observer çš„æ´»è·ƒçŠ¶æ€å¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°å…¶æ´»è·ƒçŠ¶æ€ if (!observer.shouldBeActive()) { observer.activeStateChanged(false); return; } //æ ¹æ® observer æœ¬éƒ¨çš„ value ç‰ˆæœ¬å· mLastVersion æ¥å†³å®šæ˜¯å¦éœ€è¦å‘å…¶è¿›è¡Œå›è°ƒ //ä¸ºäº†é¿å…é‡å¤å‘æŸä¸ª observer å›è°ƒå€¼ï¼Œæ‰€ä»¥æ­¤å¤„éœ€è¦åˆ¤æ–­ä¸‹ if (observer.mLastVersion &gt;= mVersion) { return; } observer.mLastVersion = mVersion; observer.mObserver.onChanged((T) mData);} postValue1234567891011121314151617181920212223242526/** * Posts a task to a main thread to set the given value. So if you have a following code * executed in the main thread: * &lt;pre class=&quot;prettyprint&quot;&gt; * liveData.postValue(&quot;a&quot;); * liveData.setValue(&quot;b&quot;); * &lt;/pre&gt; * The value &quot;b&quot; would be set at first and later the main thread would override it with * the value &quot;a&quot;. * &lt;p&gt; * If you called this method multiple times before a main thread executed a posted task, only * the last value would be dispatched. * * @param value The new value */protected void postValue(T value) { boolean postTask; synchronized (mDataLock) { postTask = mPendingData == NOT_SET; mPendingData = value; } if (!postTask) { return; } ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);} postValue(T)å‡½æ•°ä¸é™å®šè°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹ï¼Œä¸ç®¡æ˜¯ä¸»çº¿ç¨‹è¿˜æ˜¯å­çº¿ç¨‹éƒ½å¯ä»¥è°ƒç”¨ï¼Œå› æ­¤æ˜¯å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰çš„å¯èƒ½æ€§çš„ï¼ŒpostValue(T)å‡½æ•°çš„é‡ç‚¹æ—§åœ¨äºéœ€è¦ç†è§£å…¶ä»å­çº¿ç¨‹åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ä¹‹é—´çš„çŠ¶æ€å˜åŒ–ã€‚ åœ¨mPostValueRunnableè¢«æ‰§è¡Œå‰ï¼Œæ‰€æœ‰é€šè¿‡postValue(T)å‡½æ•°ä¼ é€’çš„valueéƒ½ä¼šè¢«ä¿å­˜åˆ°å˜é‡mPendingDataä¸Šï¼Œä¸”åªä¼šä¿ç•™æœ€åä¸€ä¸ªï¼Œç›´åˆ°mPostValueRunnableè¢«æ‰§è¡ŒåmPendingDataæ‰ä¼šè¢«é‡ç½®ï¼Œæ‰€ä»¥ä½¿ç”¨ postValue(T) å‡½æ•°åœ¨å¤šçº¿ç¨‹åŒæ—¶è°ƒç”¨æˆ–è€…å•çº¿ç¨‹è¿ç»­è°ƒç”¨çš„æƒ…å†µä¸‹æ˜¯å­˜åœ¨ä¸¢å€¼ï¼ˆå¤–éƒ¨çš„ Observer åªèƒ½æ¥æ”¶åˆ°æœ€æ–°å€¼ï¼‰çš„å¯èƒ½æ€§çš„ã€‚ Issueç²˜æ€§äº‹ä»¶LiveData æœ¬èº«è¢«è®¾è®¡ä¸ºç²˜æ€§äº‹ä»¶ï¼Œä¹Ÿå³ï¼Œä¸€æ—¦ LiveData æŒæœ‰æ•°æ®ï¼Œé‚£ä¹ˆåœ¨è§‚å¯Ÿè€…è®¢é˜…è¯¥ LiveData æ—¶ï¼Œä¼šè¢«æ¨é€æœ€åä¸€æ¬¡æ•°æ®ã€‚ï¼ˆå½“observeæ—¶ä¼šç«‹å³å›è°ƒonChangeæ¨é€æ•°æ®ï¼‰ æ•°æ®å€’çŒï¼ˆå…¶å®å°±æ˜¯ç²˜æ€§äº‹ä»¶ï¼Œåœ¨å¤šçº§é¡µé¢ä¸­ï¼‰å½“é¡µé¢é‡å»ºæ—¶æˆ–å¤šçº§fragmentè®¢é˜…å…¶activityçš„ShareViewModelçš„liveDataæ—¶ è¢« LiveData å›æ¨è„æ•°æ® https://xiaozhuanlan.com/topic/6719328450 https://medium.com/@kunminx/livedata-%E6%95%B0%E6%8D%AE%E5%80%92%E7%81%8C-%E5%88%AB%E9%97%AE-%E9%97%AE%E5%B0%B1%E6%98%AF%E4%B8%8D%E5%8F%AF%E9%A2%84%E6%9C%9F-5fc02fec76e0 e.g:è®¾æƒ³ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼Œä¸€çº§é¡µé¢æ˜¯åˆ—è¡¨ï¼ŒäºŒçº§é¡µé¢æ˜¯åªè¯»çš„è¯¦æƒ…é¢„è§ˆï¼Œä¸‰çº§é¡µé¢æ˜¯å¯ç¼–è¾‘çš„è¯¦æƒ…ï¼Œ å½“æˆ‘ä»¬åœ¨ç¼–è¾‘é¡µä¿®æ”¹å®Œä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šé€šè¿‡å›è°ƒæ¥é€šçŸ¥ä¸€äºŒçº§é¡µé¢åˆ·æ–°ä¿¡æ¯ã€‚æ­¤æ—¶å¦‚æ˜¯é€šè¿‡ LiveData æ¥é€šçŸ¥ï¼Œä¾¿å­˜åœ¨éšæ‚£ï¼Œ å› ä¸ºè·¨é¡µé¢é€šä¿¡ä½¿ç”¨çš„æ˜¯ Activity çº§ä½œç”¨åŸŸçš„ SharedViewModelï¼Œå…¶ç”Ÿå‘½å‘¨æœŸé•¿äº Fragmentï¼Œä¹ƒè‡³å½“ â€œç¼–è¾‘é¡µâ€ã€â€œé¢„è§ˆé¡µâ€ å‡ºæ ˆæ—¶ï¼ŒSharedViewModel å’Œå…¶æ——ä¸‹çš„ LiveData è¿˜å­˜åœ¨äºå†…å­˜ä¸­ï¼Œ é‚£ä¹ˆä¸‹ä¸€æ¬¡ä» â€œåˆ—è¡¨é¡µâ€ è·³åˆ° â€œé¢„è§ˆé¡µâ€ï¼Œâ€œé¢„è§ˆé¡µâ€ ä¸€æ³¨å†Œ LiveDataï¼Œå°±ä¼šå› ä¸ºç²˜æ€§è®¾å®šï¼Œè€Œæ”¶åˆ°ä¸Šä¸€æ¬¡ä» â€œç¼–è¾‘é¡µâ€ å‘æ¥çš„æ—§ä¿¡æ¯ï¼Œè¿™æ˜æ˜¾ä¸ç¬¦åˆé¢„æœŸï¼Œ ç°æœ‰è§£å†³æ–¹æ¡ˆåŠå„è‡ªç¼ºé™·æˆ–åº”å‚è€ƒè¿™ç¯‡æ–‡ç« https://juejin.cn/post/7268622342728171572ï¼Œå…¶ä¸­è¯„è®ºä¸­æå‡º ä¸ªäººè§è§£ï¼Œæ–¹å¼æ˜¯å¥½æ–¹å¼ï¼Œçœ‹äº†è®¸å¤šè§£å†³æ•°æ®å€’çŒçš„æ–‡ç« ï¼Œä½†æ˜¯æ•°æ®å€’çŒæ„Ÿè§‰å¹¶ä¸æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚livedataæœ¬èº«æ˜¯ç”¨äºæè¿°çŠ¶æ€çš„ï¼Œè€Œä¸æ˜¯äº‹ä»¶çš„ã€‚æè¿°äº‹ä»¶ä¸€èˆ¬ç”¨publishsubjectæˆ–shareflowæˆ–eventbusï¼Œå†ä¸æµè‡ªå·±å†™ä¸ªlistenerä¹Ÿè¡Œã€‚ //ps:ä¸Šflowå› æ­¤æ„Ÿè§‰ç”¨livedataæè¿°äº‹ä»¶æœ¬èº«è¿èƒŒäº†livedataçš„è®¾è®¡åˆè¡·ã€‚ åœ¨ã€ŠJetpack MVVM ç²¾è®²ã€‹ä¸­æˆ‘åˆ†åˆ«æåˆ°äº† Event äº‹ä»¶åŒ…è£…å™¨ã€åå°„æ–¹å¼ã€SingleLiveEvent è¿™ä¸‰ç§æ–¹å¼æ¥è§£å†³ â€œæ•°æ®å€’çŒâ€ çš„é—®é¢˜ã€‚å®ƒä»¬åˆ†åˆ«æ¥è‡ªä¸Šæ–‡æˆ‘ä»¬æåˆ°çš„å¤–ç½‘ã€ç¾å›¢çš„æ–‡ç« ï¼Œå’Œå®˜æ–¹æœ€æ–° demoã€‚ åˆ†åˆ«å­˜åœ¨å¦‚ä¸‹é—®é¢˜ï¼š Event äº‹ä»¶åŒ…è£…å™¨å¯¹äºå¤šè§‚å¯Ÿè€…çš„æƒ…å†µï¼Œåªå…è®¸ç¬¬ä¸€ä¸ªè§‚å¯Ÿè€…æ¶ˆè´¹ï¼Œè¿™ä¸ç¬¦åˆç°å®éœ€æ±‚ï¼› è€Œä¸”æ‰‹å†™ Event äº‹ä»¶åŒ…è£…å™¨ï¼Œåœ¨ Java ä¸­å­˜åœ¨ null å®‰å…¨çš„ä¸€è‡´æ€§é—®é¢˜ã€‚ åå°„å¹²é¢„ Version çš„æ–¹å¼ï¼šç¾å›¢LiveDataBuså­˜åœ¨å»¶è¿Ÿï¼Œæ— æ³•ç”¨äºå¯¹å®æ—¶æ€§æœ‰è¦æ±‚çš„åœºæ™¯ï¼› å¹¶ä¸”æ•°æ®ä¼šéšç€ SharedViewModel é•¿ä¹…æ»ç•™åœ¨å†…å­˜ä¸­å¾—ä¸åˆ°é‡Šæ”¾ã€‚ https://github.com/JeremyLiao/LiveDataBus å®˜æ–¹æœ€æ–° demo ä¸­çš„ SingleLiveEvent ï¼ˆå·²ç§»é™¤ï¼‰æ˜¯å¯¹ Event äº‹ä»¶åŒ…è£…å™¨ ä¸€è‡´æ€§é—®é¢˜çš„æ”¹è¿›ï¼Œä½†æœªè§£å†³å¤šè§‚å¯Ÿè€…æ¶ˆè´¹çš„é—®é¢˜ï¼› è€Œä¸”é¢å¤–å¼•å…¥äº†æ¶ˆæ¯æœªèƒ½ä»å†…å­˜ä¸­é‡Šæ”¾çš„é—®é¢˜ã€‚ UnPeekLiveData ç‰¹ç‚¹UnPeekLiveData é€šè¿‡ ç‹¬åˆ›çš„ â€œå»¶æ—¶è‡ªåŠ¨æ¸…ç†æ¶ˆæ¯â€ çš„è®¾è®¡ï¼Œæ¥æ»¡è¶³ï¼š 1.æ¶ˆæ¯è¢«åˆ†å‘ç»™å¤šä¸ªè§‚å¯Ÿè€…æ—¶ï¼Œ*ä¸ä¼šå› ç¬¬ä¸€ä¸ªè§‚å¯Ÿè€…æ¶ˆè´¹äº†è€Œç›´æ¥è¢«ç½®ç©º* 2.æ—¶é™åˆ°äº†ï¼Œ*æ¶ˆæ¯ä¾¿ä¸å†ä¼šè¢«å€’çŒ* 3.æ—¶é™åˆ°äº†ï¼Œ*æ¶ˆæ¯è‡ªåŠ¨ä»å†…å­˜ä¸­æ¸…ç†é‡Šæ”¾* 4.ä½¿éå…¥ä¾µçš„è®¾è®¡æˆä¸ºå¯èƒ½ï¼Œå¹¶æœ€ç»ˆç»“åˆå®˜æ–¹ SingleLiveEvent çš„è®¾è®¡å®ç°äº† ***éµå¾ªå¼€é—­åŸåˆ™çš„éå…¥ä¾µé‡å†™***ã€‚ è¿ç»­postValue()åæ•°æ®Googleåœ¨postValueçš„æ³¨é‡Šä¸Šè¯´æ˜äº† If you called this method multiple times before a main thread executed a posted task, only the last value would be dispatched.å¦‚æœåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªå·²å‘å¸ƒçš„ä»»åŠ¡ä¹‹å‰å¤šæ¬¡è°ƒç”¨æ­¤æ–¹æ³•ï¼Œåˆ™åªä¼šåˆ†æ´¾æœ€åä¸€ä¸ªå€¼ã€‚ åªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ä¼šèµ°åˆ°postToMainThread(mPostValueRunnable)ï¼Œåé¢æ‰€æœ‰æ‰§è¡Œçš„postValueåœ¨æ‰§è¡Œå®ŒpostTask = mPendingData == NOT_SET å’Œ mPendingData = value åï¼Œç›´æ¥ç”±äºä¹‹åpostTask == falseï¼Œæ‰€ä»¥returnæ‰äº†ï¼Œä¹Ÿå°±ä¸ä¼šå†postToMainThreadä¸€æ¬¡è€Œæ˜¯åªä¿®æ”¹mPendingDataæ•°æ®ã€‚ ç›´åˆ°ä¸»çº¿ç¨‹ä¸­mPostValueRunableæ‰§è¡Œæ–¹æ³•ä¸­ä¼šå°†çœŸæ­£è°ƒç”¨setValueå¹¶å°†mPendingDataé‡ç½®ä¸ºNOT_SET. è¿™ä¸ªå®ç°å…¶å®å¬èµ·æ¥å¾ˆåƒViewçš„åˆ·æ–°ï¼Œæ¯”å¦‚TextViewè¿ç»­è®¾ç½®ä¸¤æ¬¡æ–‡æœ¬ï¼Œä¹Ÿæ˜¯åªæœ‰å½“Vsyncåˆ°æ¥æ—¶å–æœ€æ–°çš„æ–‡æœ¬è®¾ç½®åˆ°TextViewä¸­","link":"/2022/02/24/LiveData/"},{"title":"Mmap","text":"Binder | å†…å­˜æ‹·è´çš„æœ¬è´¨å’Œå˜è¿èŠ¦åŠå±± è™šæ‹Ÿåœ°å€å’Œæ•°æ®çš„å…³ç³»æ‰€æœ‰çš„æ•°æ®éƒ½å­˜å‚¨åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œè€Œè¿›ç¨‹è®¿é—®å†…å­˜åªèƒ½é€šè¿‡è™šæ‹Ÿåœ°å€ã€‚å› æ­¤ï¼Œè‹¥æ˜¯æƒ³æˆåŠŸè®¿é—®å¿…é¡»å¾—æœ‰ä¸ªå‰æï¼š è™šæ‹Ÿåœ°å€å’Œç‰©ç†å†…å­˜ä¹‹é—´å»ºç«‹æ˜ å°„å…³ç³» è‹¥æ˜¯è¿™å±‚æ˜ å°„å…³ç³»ä¸å»ºç«‹ï¼Œåˆ™è®¿é—®ä¼šå‡ºé”™ã€‚ä¿¡å·11(SIGSEGV)çš„MAPERRå°±æ˜¯ä¸“é—¨ç”¨æ¥æè¿°è¿™ç§é”™è¯¯çš„ã€‚ è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€é—´å»ºç«‹æ˜ å°„å…³ç³»é€šè¿‡mmapå®Œæˆã€‚è¿™é‡Œæˆ‘ä»¬ä¸è€ƒè™‘file-backçš„mappingï¼Œåªè€ƒè™‘anonymous mappingã€‚å½“mmapè¢«è°ƒç”¨(flag=MAP_ANONYMOUS)æ—¶ï¼Œå®é™…ä¸Šä¼šåšä»¥ä¸‹ä¸¤ä»¶äº‹ï¼š åˆ†é…ä¸€å—è¿ç»­çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚ æ›´æ–°è¿™äº›è™šæ‹Ÿåœ°å€å¯¹åº”çš„PTE(Page Table Entry)ã€‚ mmapåšå®Œè¿™ä¸¤ä»¶äº‹åï¼Œå°±ä¼šè¿”å›è¿ç»­è™šæ‹Ÿåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ã€‚åœ¨mmapè°ƒç”¨ç»“æŸåï¼Œå…¶å®å¹¶ä¸ä¼šç«‹å³åˆ†é…ç‰©ç†é¡µã€‚å¦‚æœæ­¤æ—¶ä¸åˆ†é…ç‰©ç†é¡µï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å¦‚ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š æ²¡æœ‰æ–°çš„ç‰©ç†é¡µåˆ†é…ï¼Œé‚£ä¹ˆPTEéƒ½æ›´æ–°äº†å“ªäº›å†…å®¹ï¼Ÿ å¦‚æœåç»­ä½¿ç”¨mmapè¿”å›çš„è™šæ‹Ÿåœ°å€è®¿é—®å†…å­˜ï¼Œä¼šæœ‰ä»€ä¹ˆæƒ…å†µäº§ç”Ÿå‘¢ï¼Ÿ 1.1.1 æ²¡æœ‰æ–°çš„ç‰©ç†é¡µåˆ†é…ï¼Œé‚£ä¹ˆPTEéƒ½æ›´æ–°äº†äº›ä»€ä¹ˆå†…å®¹å‘¢ï¼ŸPTEä¹Ÿå³é¡µè¡¨çš„æ¡ç›®ï¼Œå®ƒçš„å†…å®¹åæ˜ äº†ä¸€ä¸ªè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚å¦‚æœæ²¡æœ‰æ–°çš„ç‰©ç†é¡µåˆ†é…ï¼Œé‚£è¿™äº›æ–°çš„è™šæ‹Ÿåœ°å€éƒ½å’Œå“ªäº›ç‰©ç†åœ°å€ä¹‹é—´å»ºç«‹äº†æ˜ å°„å…³ç³»å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æ‰€æœ‰çš„è™šæ‹Ÿåœ°å€éƒ½å’ŒåŒä¸€ä¸ªzero pageï¼ˆé¡µå†…å®¹å…¨ä¸º0ï¼‰å»ºç«‹äº†æ˜ å°„å…³ç³»ã€‚ 1.1.2 å¦‚æœåç»­ä½¿ç”¨mmapè¿”å›çš„è™šæ‹Ÿåœ°å€è®¿é—®å†…å­˜ï¼Œä¼šæœ‰ä»€ä¹ˆæƒ…å†µäº§ç”Ÿå‘¢ï¼Ÿæ‹¿åˆ°mmapè¿”å›çš„è™šæ‹Ÿåœ°å€åï¼Œå¹¶ä¸ä¼šæœ‰æ–°çš„ç‰©ç†é¡µåˆ†é…ã€‚æ­¤æ—¶è‹¥æ˜¯ç›´æ¥è¯»å–è™šæ‹Ÿåœ°å€ä¸­çš„å€¼ï¼Œåˆ™ä¼šé€šè¿‡PTEè¿½è¸ªåˆ°åˆšåˆšå»ºç«‹æ˜ å°„å…³ç³»çš„zero pageï¼Œå› æ­¤è¯»å–å‡ºæ¥çš„å€¼éƒ½æ˜¯0ã€‚ å¦‚æœæ­¤æ—¶å¾€è™šæ‹Ÿåœ°å€ä¸­å†™å…¥æ•°æ®ï¼Œå°†ä¼šåœ¨page fault handlerä¸­è§¦å‘ä¸€ä¸ªæ­£å¸¸çš„copy-on-writeæœºåˆ¶ã€‚éœ€è¦å†™å¤šå°‘é¡µï¼Œå°±ä¼šæ–°åˆ†é…å¤šå°‘ç‰©ç†é¡µã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒçœŸå®çš„ç‰©ç†é¡µæ˜¯ç¬¦åˆlazy(on-demand) allocationåŸåˆ™çš„ã€‚è¿™ä¸€ç‚¹ï¼Œæå¤§åœ°ä¿è¯äº†ç‰©ç†èµ„æºçš„åˆç†åˆ†é…å’Œä½¿ç”¨ã€‚","link":"/2022/02/16/Mmap/"},{"title":"OperatingSystem","text":"æ“ä½œç³»ç»Ÿ è¿›ç¨‹å’Œçº¿ç¨‹ è¿›ç¨‹å’Œçº¿ç¨‹æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ è¿›ç¨‹é—´é€šä¿¡æœ‰å“ªäº›æ–¹å¼ï¼Ÿ è¿›ç¨‹åŒæ­¥é—®é¢˜ è¿›ç¨‹æœ‰å“ªå‡ ç§çŠ¶æ€ï¼Ÿ è¿›ç¨‹è°ƒåº¦ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ ä»€ä¹ˆæ˜¯åƒµå°¸è¿›ç¨‹ï¼Ÿ çº¿ç¨‹åŒæ­¥æœ‰å“ªäº›æ–¹å¼ï¼Ÿ ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ è¿›ç¨‹çš„å¼‚å¸¸æ§åˆ¶æµï¼šé™·é˜±ã€ä¸­æ–­ã€å¼‚å¸¸å’Œä¿¡å· ä»€ä¹ˆæ˜¯IOå¤šè·¯å¤ç”¨ï¼Ÿæ€ä¹ˆå®ç°ï¼Ÿ ä»€ä¹ˆæ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿ æ­»é” ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ æ­»é”äº§ç”Ÿçš„å¿…è¦æ¡ä»¶ï¼Ÿ æ­»é”æœ‰å“ªäº›å¤„ç†æ–¹æ³•ï¼Ÿ å†…å­˜ç®¡ç† åˆ†é¡µå’Œåˆ†æ®µæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ä»€ä¹ˆæ˜¯è™šæ‹Ÿå†…å­˜ï¼Ÿ æœ‰å“ªäº›é¡µé¢ç½®æ¢ç®—æ³•ï¼Ÿ ç¼“å†²åŒºæº¢å‡ºé—®é¢˜ ç£ç›˜è°ƒåº¦ å‚è€ƒ è¿›ç¨‹å’Œçº¿ç¨‹æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ è¿›ç¨‹ï¼ˆProcessï¼‰æ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹ï¼ˆThreadï¼‰æ˜¯CPUè°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½ï¼› çº¿ç¨‹ä¾èµ–äºè¿›ç¨‹è€Œå­˜åœ¨ï¼Œä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼› è¿›ç¨‹æœ‰è‡ªå·±çš„ç‹¬ç«‹åœ°å€ç©ºé—´ï¼Œçº¿ç¨‹å…±äº«æ‰€å±è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼› è¿›ç¨‹æ˜¯æ‹¥æœ‰ç³»ç»Ÿèµ„æºçš„ä¸€ä¸ªç‹¬ç«‹å•ä½ï¼Œè€Œçº¿ç¨‹è‡ªå·±åŸºæœ¬ä¸Šä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æºï¼Œåªæ‹¥æœ‰ä¸€ç‚¹åœ¨è¿è¡Œä¸­å¿…ä¸å¯å°‘çš„èµ„æº(å¦‚ç¨‹åºè®¡æ•°å™¨,ä¸€ç»„å¯„å­˜å™¨å’Œæ ˆ)ï¼Œå’Œå…¶ä»–çº¿ç¨‹å…±äº«æœ¬è¿›ç¨‹çš„ç›¸å…³èµ„æºå¦‚å†…å­˜ã€I/Oã€cpuç­‰ï¼› åœ¨è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œæ¶‰åŠåˆ°æ•´ä¸ªå½“å‰è¿›ç¨‹CPUç¯å¢ƒçš„ä¿å­˜ç¯å¢ƒçš„è®¾ç½®ä»¥åŠæ–°è¢«è°ƒåº¦è¿è¡Œçš„CPUç¯å¢ƒçš„è®¾ç½®ï¼Œè€Œçº¿ç¨‹åˆ‡æ¢åªéœ€ä¿å­˜å’Œè®¾ç½®å°‘é‡çš„å¯„å­˜å™¨çš„å†…å®¹ï¼Œå¹¶ä¸æ¶‰åŠå­˜å‚¨å™¨ç®¡ç†æ–¹é¢çš„æ“ä½œï¼Œå¯è§ï¼Œè¿›ç¨‹åˆ‡æ¢çš„å¼€é”€è¿œå¤§äºçº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼› çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ›´æ–¹ä¾¿ï¼ŒåŒä¸€è¿›ç¨‹ä¸‹çš„çº¿ç¨‹å…±äº«å…¨å±€å˜é‡ç­‰æ•°æ®ï¼Œè€Œè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡éœ€è¦ä»¥è¿›ç¨‹é—´é€šä¿¡(IPC)çš„æ–¹å¼è¿›è¡Œï¼› å¤šçº¿ç¨‹ç¨‹åºåªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹å´©æºƒï¼Œæ•´ä¸ªç¨‹åºå°±å´©æºƒäº†ï¼Œä½†å¤šè¿›ç¨‹ç¨‹åºä¸­ä¸€ä¸ªè¿›ç¨‹å´©æºƒå¹¶ä¸ä¼šå¯¹å…¶å®ƒè¿›ç¨‹é€ æˆå½±å“ï¼Œå› ä¸ºè¿›ç¨‹æœ‰è‡ªå·±çš„ç‹¬ç«‹åœ°å€ç©ºé—´ï¼Œå› æ­¤å¤šè¿›ç¨‹æ›´åŠ å¥å£® è¿›ç¨‹æ“ä½œä»£ç å®ç°ï¼Œå¯ä»¥å‚è€ƒï¼šå¤šè¿›ç¨‹ - å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ åŒä¸€è¿›ç¨‹ä¸­çš„çº¿ç¨‹å¯ä»¥å…±äº«å“ªäº›æ•°æ®ï¼Ÿ å±•å¼€ è¿›ç¨‹ä»£ç æ®µ è¿›ç¨‹çš„å…¬æœ‰æ•°æ®ï¼ˆå…¨å±€å˜é‡ã€é™æ€å˜é‡â€¦ï¼‰ è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ è¿›ç¨‹çš„å½“å‰ç›®å½• ä¿¡å·å¤„ç†å™¨/ä¿¡å·å¤„ç†å‡½æ•°ï¼šå¯¹æ”¶åˆ°çš„ä¿¡å·çš„å¤„ç†æ–¹å¼ è¿›ç¨‹IDä¸è¿›ç¨‹ç»„ID çº¿ç¨‹ç‹¬å å“ªäº›èµ„æºï¼Ÿ å±•å¼€ çº¿ç¨‹ID ä¸€ç»„å¯„å­˜å™¨çš„å€¼ çº¿ç¨‹è‡ªèº«çš„æ ˆï¼ˆå †æ˜¯å…±äº«çš„ï¼‰ é”™è¯¯è¿”å›ç ï¼šçº¿ç¨‹å¯èƒ½ä¼šäº§ç”Ÿä¸åŒçš„é”™è¯¯è¿”å›ç ï¼Œä¸€ä¸ªçº¿ç¨‹çš„é”™è¯¯è¿”å›ç ä¸åº”è¯¥è¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹ï¼› ä¿¡å·æ©ç /ä¿¡å·å±è”½å­—(Signal mask)ï¼šè¡¨ç¤ºæ˜¯å¦å±è”½/é˜»å¡ç›¸åº”çš„ä¿¡å·ï¼ˆSIGKILL,SIGSTOPé™¤å¤–ï¼‰ è¿›ç¨‹é—´é€šä¿¡æœ‰å“ªäº›æ–¹å¼ï¼Ÿ ç®¡é“(Pipe) å±•å¼€ ç®¡é“æ˜¯åŠåŒå·¥çš„ï¼Œæ•°æ®åªèƒ½å‘ä¸€ä¸ªæ–¹å‘æµåŠ¨ï¼›éœ€è¦åŒæ–¹é€šä¿¡æ—¶ï¼Œéœ€è¦å»ºç«‹èµ·ä¸¤ä¸ªç®¡é“ï¼› ä¸€ä¸ªè¿›ç¨‹å‘ç®¡é“ä¸­å†™çš„å†…å®¹è¢«ç®¡é“å¦ä¸€ç«¯çš„è¿›ç¨‹è¯»å‡ºã€‚å†™å…¥çš„å†…å®¹æ¯æ¬¡éƒ½æ·»åŠ åœ¨ç®¡é“ç¼“å†²åŒºçš„æœ«å°¾ï¼Œå¹¶ä¸”æ¯æ¬¡éƒ½æ˜¯ä»ç¼“å†²åŒºçš„å¤´éƒ¨è¯»å‡ºæ•°æ®ï¼› åªèƒ½ç”¨äºçˆ¶å­è¿›ç¨‹æˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´(å…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹) å‘½åç®¡é“ æ¶ˆæ¯é˜Ÿåˆ— ä¿¡å·(Signal) å…±äº«å†…å­˜ ä¿¡å·é‡(Semaphore)ï¼šåˆå§‹åŒ–æ“ä½œã€Pæ“ä½œã€Væ“ä½œï¼›Pæ“ä½œï¼šä¿¡å·é‡-1ï¼Œæ£€æµ‹æ˜¯å¦å°äº0ï¼Œå°äºåˆ™è¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼›Væ“ä½œï¼šä¿¡å·é‡+1ï¼Œè‹¥å°äºç­‰äº0ï¼Œåˆ™ä»é˜Ÿåˆ—ä¸­å”¤é†’ä¸€ä¸ªç­‰å¾…çš„è¿›ç¨‹è¿›å…¥å°±ç»ªæ€ å¥—æ¥å­—(Socket) æ›´è¯¦ç»†çš„å¯ä»¥å‚è€ƒï¼ˆå¾…æ•´ç†ï¼‰ï¼š https://imageslr.github.io/2020/02/26/ipc.html https://www.jianshu.com/p/c1015f5ffa74 è¿›ç¨‹åŒæ­¥é—®é¢˜ è¿›ç¨‹çš„åŒæ­¥æ˜¯ç›®çš„ï¼Œè€Œè¿›ç¨‹é—´é€šä¿¡æ˜¯å®ç°è¿›ç¨‹åŒæ­¥çš„æ‰‹æ®µ ç®¡ç¨‹ Monitor ç®¡ç¨‹å°†å…±äº«å˜é‡ä»¥åŠå¯¹è¿™äº›å…±äº«å˜é‡çš„æ“ä½œå°è£…èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªå…·æœ‰ä¸€å®šæ¥å£çš„åŠŸèƒ½æ¨¡å—ï¼Œè¿™æ ·åªèƒ½é€šè¿‡ç®¡ç¨‹æä¾›çš„æŸä¸ªè¿‡ç¨‹æ‰èƒ½è®¿é—®ç®¡ç¨‹ä¸­çš„èµ„æºã€‚è¿›ç¨‹åªèƒ½äº’æ–¥åœ°ä½¿ç”¨ç®¡ç¨‹ï¼Œä½¿ç”¨å®Œä¹‹åå¿…é¡»é‡Šæ”¾ç®¡ç¨‹å¹¶å”¤é†’å…¥å£ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹ã€‚ å½“ä¸€ä¸ªè¿›ç¨‹è¯•å›¾è¿›å…¥ç®¡ç¨‹æ—¶ï¼Œåœ¨å…¥å£ç­‰å¾…é˜Ÿåˆ—ç­‰å¾…ã€‚è‹¥Pè¿›ç¨‹å”¤é†’äº†Qè¿›ç¨‹ï¼Œåˆ™Qè¿›ç¨‹å…ˆæ‰§è¡Œï¼ŒPåœ¨ç´§æ€¥ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚ï¼ˆHOAREç®¡ç¨‹ï¼‰ waitæ“ä½œï¼šæ‰§è¡Œwaitæ“ä½œçš„è¿›ç¨‹è¿›å…¥æ¡ä»¶å˜é‡é“¾æœ«å°¾ï¼Œå”¤é†’ç´§æ€¥ç­‰å¾…é˜Ÿåˆ—æˆ–è€…å…¥å£é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹ï¼›signalæ“ä½œï¼šå”¤é†’æ¡ä»¶å˜é‡é“¾ä¸­çš„è¿›ç¨‹ï¼Œè‡ªå·±è¿›å…¥ç´§æ€¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè‹¥æ¡ä»¶å˜é‡é“¾ä¸ºç©ºï¼Œåˆ™ç»§ç»­æ‰§è¡Œã€‚ï¼ˆHOAREç®¡ç¨‹ï¼‰ MESAç®¡ç¨‹ï¼šå°†HOAREä¸­çš„signalæ¢æˆäº†notifyï¼ˆæˆ–è€…broadcasté€šçŸ¥æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ï¼‰ï¼Œè¿›è¡Œé€šçŸ¥è€Œä¸æ˜¯ç«‹é©¬äº¤æ¢ç®¡ç¨‹çš„ä½¿ç”¨æƒï¼Œåœ¨åˆé€‚çš„æ—¶å€™ï¼Œæ¡ä»¶é˜Ÿåˆ—é¦–ä½çš„è¿›ç¨‹å¯ä»¥è¿›å…¥ï¼Œè¿›å…¥ä¹‹å‰å¿…é¡»ç”¨whileæ£€æŸ¥æ¡ä»¶æ˜¯å¦åˆé€‚ã€‚ä¼˜ç‚¹ï¼šæ²¡æœ‰é¢å¤–çš„è¿›ç¨‹åˆ‡æ¢ ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ é—®é¢˜æè¿°ï¼šä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºæ¥å­˜æ”¾æ•°æ®ï¼Œåªæœ‰ç¼“å†²åŒºæ²¡æœ‰æ»¡ï¼Œç”Ÿäº§è€…æ‰å¯ä»¥å†™å…¥æ•°æ®ï¼›åªæœ‰ç¼“å†²åŒºä¸ä¸ºç©ºï¼Œæ¶ˆè´¹è€…æ‰å¯ä»¥è¯»å‡ºæ•°æ® ä»£ç å®ç°ï¼š 1234567891011121314151617181920212223242526272829// ä¼ªä»£ç æè¿° // å®šä¹‰ä¿¡å·é‡ fullè®°å½•ç¼“å†²åŒºç‰©å“æ•°é‡ emptyä»£è¡¨ç¼“å†²åŒºç©ºä½æ•°é‡ mutexä¸ºäº’æ–¥é‡semaphore full = 0, empty = n, mutex = 1;// ç”Ÿäº§è€…è¿›ç¨‹void producer(){ do{ P(empty); P(mutex); // ç”Ÿäº§è€…è¿›è¡Œç”Ÿäº§ V(mutex); V(full); } while(1);}void consumer(){ do{ P(full); P(mutex); // æ¶ˆè´¹è€…è¿›è¡Œæ¶ˆè´¹ V(mutex); V(empty); } while(1);} å“²å­¦å®¶å°±é¤é—®é¢˜ é—®é¢˜æè¿°ï¼šæœ‰äº”ä½å“²å­¦å®¶å›´ç»•ç€é¤æ¡Œåï¼Œæ¯ä¸€ä½å“²å­¦å®¶è¦ä¹ˆæ€è€ƒï¼Œè¦ä¹ˆåƒé¥­ã€‚ä¸ºäº†åƒé¥­ï¼Œå“²å­¦å®¶å¿…é¡»æ‹¿èµ·ä¸¤åŒç­·å­ï¼ˆåˆ†åˆ«æ”¾äºå·¦å³ä¸¤ç«¯ï¼‰ä¸å¹¸çš„æ˜¯ï¼Œç­·å­çš„æ•°é‡å’Œå“²å­¦å®¶ç›¸ç­‰ï¼Œæ‰€ä»¥æ¯åªç­·å­å¿…é¡»ç”±ä¸¤ä½å“²å­¦å®¶å…±äº«ã€‚ ä»£ç å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142#define N 5 // number of philosopher#define LEFT (i + N - 1)%N // number of i's left neighbors#define RIGHT (i + 1)%N // number of i's right neighbors#define THINKING 0#define HUNGRY 1#define EATING 2typedef int semaphore;int state[N]; // array to keep track of everyone's statesemaphore mutex = 1; // mutual exclusion of critical regionsemaphore s[N]; void philosopher(int i) { while (TRUE) { think(); take_forks(i); eat(); put_forks(i); }}void take_forks(int i) { down(&amp;mutex); // enter critical region state[i] = HUNGRY; // record that i is hungry test_forks(i); // try to acquire two forks up(&amp;mutex); // exit critical region down(&amp;s[i]); // block if forks are not acquired}void put_forks(int i) { down(&amp;mutex); // enter critical region state[i] = THINKING; // record that has finished eating test_forks(LEFT); // see if left neighbor can now eat test_forks(RIGHT); // see if right neighbor can now eat up(&amp;mutex); // exit critical region}void test_forks(int i) { if (state[i] == HUNGRY &amp;&amp; state[LEFT] != EATING &amp;&amp; state[RIGHT] != EATING) { state[i] = EATING; up(&amp;s[i]); }} è¯»è€…-å†™è€…é—®é¢˜ ä¸´ç•ŒåŒºçš„æ¦‚å¿µï¼Ÿ å±•å¼€ å„ä¸ªè¿›ç¨‹ä¸­å¯¹ä¸´ç•Œèµ„æºï¼ˆäº’æ–¥èµ„æº/å…±äº«å˜é‡ï¼Œä¸€æ¬¡åªèƒ½ç»™ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼‰è¿›è¡Œæ“ä½œçš„ç¨‹åºç‰‡æ®µ åŒæ­¥ä¸äº’æ–¥çš„æ¦‚å¿µï¼Ÿ å±•å¼€ åŒæ­¥ï¼šå¤šä¸ªè¿›ç¨‹å› ä¸ºåˆä½œè€Œä½¿å¾—è¿›ç¨‹çš„æ‰§è¡Œæœ‰ä¸€å®šçš„å…ˆåé¡ºåºã€‚æ¯”å¦‚æŸä¸ªè¿›ç¨‹éœ€è¦å¦ä¸€ä¸ªè¿›ç¨‹æä¾›çš„æ¶ˆæ¯ï¼Œè·å¾—æ¶ˆæ¯ä¹‹å‰è¿›å…¥é˜»å¡æ€ï¼› äº’æ–¥ï¼šå¤šä¸ªè¿›ç¨‹åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹èƒ½è¿›å…¥ä¸´ç•ŒåŒº å¹¶å‘ã€å¹¶è¡Œã€å¼‚æ­¥çš„åŒºåˆ«ï¼Ÿ å±•å¼€ å¹¶å‘ï¼šåœ¨ä¸€ä¸ªæ—¶é—´æ®µä¸­åŒæ—¶æœ‰å¤šä¸ªç¨‹åºåœ¨è¿è¡Œï¼Œä½†å…¶å®ä»»ä¸€æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªç¨‹åºåœ¨CPUä¸Šè¿è¡Œï¼Œå®è§‚ä¸Šçš„å¹¶å‘æ˜¯é€šè¿‡ä¸æ–­çš„åˆ‡æ¢å®ç°çš„ï¼› å¤šçº¿ç¨‹ï¼šå¹¶å‘è¿è¡Œçš„ä¸€æ®µä»£ç ã€‚æ˜¯å®ç°å¼‚æ­¥çš„æ‰‹æ®µ å¹¶è¡Œï¼ˆå’Œä¸²è¡Œç›¸æ¯”ï¼‰ï¼šåœ¨å¤šCPUç³»ç»Ÿä¸­ï¼Œå¤šä¸ªç¨‹åºæ— è®ºå®è§‚è¿˜æ˜¯å¾®è§‚ä¸Šéƒ½æ˜¯åŒæ—¶æ‰§è¡Œçš„ å¼‚æ­¥ï¼ˆå’ŒåŒæ­¥ç›¸æ¯”ï¼‰ï¼šåŒæ­¥æ˜¯é¡ºåºæ‰§è¡Œï¼Œå¼‚æ­¥æ˜¯åœ¨ç­‰å¾…æŸä¸ªèµ„æºçš„æ—¶å€™ç»§ç»­åšè‡ªå·±çš„äº‹ è¿›ç¨‹æœ‰å“ªå‡ ç§çŠ¶æ€ï¼Ÿ å°±ç»ªçŠ¶æ€ï¼šè¿›ç¨‹å·²è·å¾—é™¤å¤„ç†æœºä»¥å¤–çš„æ‰€éœ€èµ„æºï¼Œç­‰å¾…åˆ†é…å¤„ç†æœºèµ„æº è¿è¡ŒçŠ¶æ€ï¼šå ç”¨å¤„ç†æœºèµ„æºè¿è¡Œï¼Œå¤„äºæ­¤çŠ¶æ€çš„è¿›ç¨‹æ•°å°äºç­‰äºCPUæ•° é˜»å¡çŠ¶æ€ï¼š è¿›ç¨‹ç­‰å¾…æŸç§æ¡ä»¶ï¼Œåœ¨æ¡ä»¶æ»¡è¶³ä¹‹å‰æ— æ³•æ‰§è¡Œ è¿›ç¨‹è°ƒåº¦ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ æ‰¹å¤„ç†ç³»ç»Ÿï¼š å…ˆæ¥å…ˆæœåŠ¡ first-come first-serverdï¼ˆFCFSï¼‰ æŒ‰ç…§è¯·æ±‚çš„é¡ºåºè¿›è¡Œè°ƒåº¦ã€‚éæŠ¢å å¼ï¼Œå¼€é”€å°ï¼Œæ— é¥¥é¥¿é—®é¢˜ï¼Œå“åº”æ—¶é—´ä¸ç¡®å®šï¼ˆå¯èƒ½å¾ˆæ…¢ï¼‰ï¼› å¯¹çŸ­è¿›ç¨‹ä¸åˆ©ï¼Œå¯¹IOå¯†é›†å‹è¿›ç¨‹ä¸åˆ©ã€‚ æœ€çŸ­ä½œä¸šä¼˜å…ˆ shortest job firstï¼ˆSJFï¼‰ æŒ‰ä¼°è®¡è¿è¡Œæ—¶é—´æœ€çŸ­çš„é¡ºåºè¿›è¡Œè°ƒåº¦ã€‚éæŠ¢å å¼ï¼Œååé‡é«˜ï¼Œå¼€é”€å¯èƒ½è¾ƒå¤§ï¼Œå¯èƒ½å¯¼è‡´é¥¥é¥¿é—®é¢˜ï¼› å¯¹çŸ­è¿›ç¨‹æä¾›å¥½çš„å“åº”æ—¶é—´ï¼Œå¯¹é•¿è¿›ç¨‹ä¸åˆ©ã€‚ æœ€çŸ­å‰©ä½™æ—¶é—´ä¼˜å…ˆ shortest remaining time nextï¼ˆSRTNï¼‰ æŒ‰å‰©ä½™è¿è¡Œæ—¶é—´çš„é¡ºåºè¿›è¡Œè°ƒåº¦ã€‚(æœ€çŸ­ä½œä¸šä¼˜å…ˆçš„æŠ¢å å¼ç‰ˆæœ¬)ã€‚ååé‡é«˜ï¼Œå¼€é”€å¯èƒ½è¾ƒå¤§ï¼Œæä¾›å¥½çš„å“åº”æ—¶é—´ï¼› å¯èƒ½å¯¼è‡´é¥¥é¥¿é—®é¢˜ï¼Œå¯¹é•¿è¿›ç¨‹ä¸åˆ©ã€‚ æœ€é«˜å“åº”æ¯”ä¼˜å…ˆ Highest Response Ratio Nextï¼ˆHRRNï¼‰ å“åº”æ¯” = 1+ ç­‰å¾…æ—¶é—´/å¤„ç†æ—¶é—´ã€‚åŒæ—¶è€ƒè™‘äº†ç­‰å¾…æ—¶é—´çš„é•¿çŸ­å’Œä¼°è®¡éœ€è¦çš„æ‰§è¡Œæ—¶é—´é•¿çŸ­ï¼Œå¾ˆå¥½çš„å¹³è¡¡äº†é•¿çŸ­è¿›ç¨‹ã€‚éæŠ¢å ï¼Œååé‡é«˜ï¼Œå¼€é”€å¯èƒ½è¾ƒå¤§ï¼Œæä¾›å¥½çš„å“åº”æ—¶é—´ï¼Œæ— é¥¥é¥¿é—®é¢˜ã€‚ äº¤äº’å¼ç³»ç»Ÿäº¤äº’å¼ç³»ç»Ÿæœ‰å¤§é‡çš„ç”¨æˆ·äº¤äº’æ“ä½œï¼Œåœ¨è¯¥ç³»ç»Ÿä¸­è°ƒåº¦ç®—æ³•çš„ç›®æ ‡æ˜¯å¿«é€Ÿåœ°è¿›è¡Œå“åº”ã€‚ æ—¶é—´ç‰‡è½®è½¬ Round Robin å°†æ‰€æœ‰å°±ç»ªè¿›ç¨‹æŒ‰ FCFS çš„åŸåˆ™æ’æˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”¨å®Œæ—¶é—´ç‰‡çš„è¿›ç¨‹æ’åˆ°é˜Ÿåˆ—æœ€åã€‚æŠ¢å å¼ï¼ˆæ—¶é—´ç‰‡ç”¨å®Œæ—¶ï¼‰ï¼Œå¼€é”€å°ï¼Œæ— é¥¥é¥¿é—®é¢˜ï¼Œä¸ºçŸ­è¿›ç¨‹æä¾›å¥½çš„å“åº”æ—¶é—´ï¼› è‹¥æ—¶é—´ç‰‡å°ï¼Œè¿›ç¨‹åˆ‡æ¢é¢‘ç¹ï¼Œååé‡ä½ï¼›è‹¥æ—¶é—´ç‰‡å¤ªé•¿ï¼Œå®æ—¶æ€§å¾—ä¸åˆ°ä¿è¯ã€‚ ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³• ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªä¼˜å…ˆçº§ï¼ŒæŒ‰ä¼˜å…ˆçº§è¿›è¡Œè°ƒåº¦ã€‚ä¸ºäº†é˜²æ­¢ä½ä¼˜å…ˆçº§çš„è¿›ç¨‹æ°¸è¿œç­‰ä¸åˆ°è°ƒåº¦ï¼Œå¯ä»¥éšç€æ—¶é—´çš„æ¨ç§»å¢åŠ ç­‰å¾…è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚ å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ç®—æ³• Multilevel Feedback Queue è®¾ç½®å¤šä¸ªå°±ç»ªé˜Ÿåˆ—1ã€2ã€3â€¦ï¼Œä¼˜å…ˆçº§é€’å‡ï¼Œæ—¶é—´ç‰‡é€’å¢ã€‚åªæœ‰ç­‰åˆ°ä¼˜å…ˆçº§æ›´é«˜çš„é˜Ÿåˆ—ä¸ºç©ºæ—¶æ‰ä¼šè°ƒåº¦å½“å‰é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹ã€‚å¦‚æœè¿›ç¨‹ç”¨å®Œäº†å½“å‰é˜Ÿåˆ—çš„æ—¶é—´ç‰‡è¿˜æœªæ‰§è¡Œå®Œï¼Œåˆ™ä¼šè¢«ç§»åˆ°ä¸‹ä¸€é˜Ÿåˆ—ã€‚ æŠ¢å å¼ï¼ˆæ—¶é—´ç‰‡ç”¨å®Œæ—¶ï¼‰ï¼Œå¼€é”€å¯èƒ½è¾ƒå¤§ï¼Œå¯¹IOå‹è¿›ç¨‹æœ‰åˆ©ï¼Œå¯èƒ½ä¼šå‡ºç°é¥¥é¥¿é—®é¢˜ã€‚ ä»€ä¹ˆå«ä¼˜å…ˆçº§åè½¬ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ å±•å¼€ é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹ç­‰å¾…è¢«ä¸€ä¸ªä½ä¼˜å…ˆçº§è¿›ç¨‹å ç”¨çš„èµ„æºæ—¶ï¼Œå°±ä¼šå‡ºç°ä¼˜å…ˆçº§åè½¬ï¼Œå³ä¼˜å…ˆçº§è¾ƒä½çš„è¿›ç¨‹æ¯”ä¼˜å…ˆçº§è¾ƒé«˜çš„è¿›ç¨‹å…ˆæ‰§è¡Œã€‚æ­¤å¤„è¯¦ç»†è§£é‡Šä¼˜å…ˆçº§åè½¬å¸¦æ¥çš„é—®é¢˜ï¼šå¦‚æœæœ‰ä¸€ä¸ªä¸­ç­‰ä¼˜å…ˆçº§çš„è¿›ç¨‹å°†ä½ä¼˜å…ˆçº§çš„è¿›ç¨‹æŠ¢å ï¼Œé‚£ä¹ˆæ­¤æ—¶ä½ä¼˜å…ˆçº§çš„è¿›ç¨‹æ— æ³•æ­£å¸¸è¿›è¡Œå¹¶åœ¨åç»­é‡Šæ”¾è¢«å ç”¨çš„èµ„æºï¼Œå¯¼è‡´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ä¸€ç›´è¢«æŒ‚èµ·ï¼Œç›´åˆ°ä¸­ç­‰ä¼˜å…ˆçº§çš„è¿›ç¨‹å®Œæˆåï¼Œä½ä¼˜å…ˆçº§çš„è¿›ç¨‹æ‰å¯ä»¥ç»§ç»­å¹¶åœ¨åç»­é‡Šæ”¾å ç”¨çš„èµ„æºï¼Œæœ€åé«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹æ‰å¯ä»¥æ‰§è¡Œã€‚å¯¼è‡´çš„é—®é¢˜å°±æ˜¯é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹åœ¨ä¸­ç­‰ä¼˜å…ˆçº§çš„è¿›ç¨‹è°ƒåº¦ä¹‹åã€‚ è§£å†³æ–¹æ³•ï¼š ä¼˜å…ˆçº§å¤©èŠ±æ¿(priority ceiling)ï¼šå½“ä»»åŠ¡ç”³è¯·æŸèµ„æºæ—¶ï¼ŒæŠŠè¯¥ä»»åŠ¡çš„ä¼˜å…ˆçº§æå‡åˆ°å¯è®¿é—®è¿™ä¸ªèµ„æºçš„æ‰€æœ‰ä»»åŠ¡ä¸­çš„æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿™ä¸ªä¼˜å…ˆçº§ç§°ä¸ºè¯¥èµ„æºçš„ä¼˜å…ˆçº§å¤©èŠ±æ¿ã€‚ç®€å•æ˜“è¡Œã€‚ ä¼˜å…ˆçº§ç»§æ‰¿(priority inheritance)ï¼šå½“ä»»åŠ¡Aç”³è¯·å…±äº«èµ„æºSæ—¶ï¼Œå¦‚æœSæ­£åœ¨è¢«ä»»åŠ¡Cä½¿ç”¨ï¼Œé€šè¿‡æ¯”è¾ƒä»»åŠ¡Cä¸è‡ªèº«çš„ä¼˜å…ˆçº§ï¼Œå¦‚å‘ç°ä»»åŠ¡Cçš„ä¼˜å…ˆçº§å°äºè‡ªèº«çš„ä¼˜å…ˆçº§ï¼Œåˆ™å°†ä»»åŠ¡Cçš„ä¼˜å…ˆçº§æå‡åˆ°è‡ªèº«çš„ä¼˜å…ˆçº§ï¼Œä»»åŠ¡Cé‡Šæ”¾èµ„æºSåï¼Œå†æ¢å¤ä»»åŠ¡Cçš„åŸä¼˜å…ˆçº§ã€‚ ä»€ä¹ˆæ˜¯åƒµå°¸è¿›ç¨‹ï¼Ÿä¸€ä¸ªå­è¿›ç¨‹ç»“æŸåï¼Œå®ƒçš„çˆ¶è¿›ç¨‹å¹¶æ²¡æœ‰ç­‰å¾…å®ƒï¼ˆè°ƒç”¨waitæˆ–è€…waitpidï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªå­è¿›ç¨‹å°†æˆä¸ºä¸€ä¸ªåƒµå°¸è¿›ç¨‹ã€‚åƒµå°¸è¿›ç¨‹æ˜¯ä¸€ä¸ªå·²ç»æ­»äº¡çš„è¿›ç¨‹ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰çœŸæ­£è¢«é”€æ¯ã€‚å®ƒå·²ç»æ”¾å¼ƒäº†å‡ ä¹æ‰€æœ‰å†…å­˜ç©ºé—´ï¼Œæ²¡æœ‰ä»»ä½•å¯æ‰§è¡Œä»£ç ï¼Œä¹Ÿä¸èƒ½è¢«è°ƒåº¦ï¼Œä»…ä»…åœ¨è¿›ç¨‹è¡¨ä¸­ä¿ç•™ä¸€ä¸ªä½ç½®ï¼Œè®°è½½è¯¥è¿›ç¨‹çš„è¿›ç¨‹IDã€ç»ˆæ­¢çŠ¶æ€ä»¥åŠèµ„æºåˆ©ç”¨ä¿¡æ¯(CPUæ—¶é—´ï¼Œå†…å­˜ä½¿ç”¨é‡ç­‰ç­‰)ä¾›çˆ¶è¿›ç¨‹æ”¶é›†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œåƒµå°¸è¿›ç¨‹ä¸å†å æœ‰ä»»ä½•å†…å­˜ç©ºé—´ã€‚è¿™ä¸ªåƒµå°¸è¿›ç¨‹å¯èƒ½ä¼šä¸€ç›´ç•™åœ¨ç³»ç»Ÿä¸­ç›´åˆ°ç³»ç»Ÿé‡å¯ã€‚ å±å®³ï¼šå ç”¨è¿›ç¨‹å·ï¼Œè€Œç³»ç»Ÿæ‰€èƒ½ä½¿ç”¨çš„è¿›ç¨‹å·æ˜¯æœ‰é™çš„ï¼›å ç”¨å†…å­˜ã€‚ ä»¥ä¸‹æƒ…å†µä¸ä¼šäº§ç”Ÿåƒµå°¸è¿›ç¨‹ï¼š è¯¥è¿›ç¨‹çš„çˆ¶è¿›ç¨‹å…ˆç»“æŸäº†ã€‚æ¯ä¸ªè¿›ç¨‹ç»“æŸçš„æ—¶å€™ï¼Œç³»ç»Ÿéƒ½ä¼šæ‰«ææ˜¯å¦å­˜åœ¨å­è¿›ç¨‹ï¼Œå¦‚æœæœ‰åˆ™ç”¨Initè¿›ç¨‹æ¥ç®¡ï¼Œæˆä¸ºè¯¥è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œå¹¶ä¸”ä¼šè°ƒç”¨waitç­‰å¾…å…¶ç»“æŸã€‚ çˆ¶è¿›ç¨‹è°ƒç”¨waitæˆ–è€…waitpidç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼ˆéœ€è¦æ¯éš”ä¸€æ®µæ—¶é—´æŸ¥è¯¢å­è¿›ç¨‹æ˜¯å¦ç»“æŸï¼‰ã€‚waitç³»ç»Ÿè°ƒç”¨ä¼šä½¿çˆ¶è¿›ç¨‹æš‚åœæ‰§è¡Œï¼Œç›´åˆ°å®ƒçš„ä¸€ä¸ªå­è¿›ç¨‹ç»“æŸä¸ºæ­¢ã€‚waitpidåˆ™å¯ä»¥åŠ å…¥WNOHANG(wait-no-hang)é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰å‘ç°ç»“æŸçš„å­è¿›ç¨‹ï¼Œå°±ä¼šç«‹å³è¿”å›ï¼Œä¸ä¼šå°†è°ƒç”¨waitpidçš„è¿›ç¨‹é˜»å¡ã€‚åŒæ—¶ï¼Œwaitpidè¿˜å¯ä»¥é€‰æ‹©æ˜¯ç­‰å¾…ä»»ä¸€å­è¿›ç¨‹ï¼ˆåŒwaitï¼‰ï¼Œè¿˜æ˜¯ç­‰å¾…æŒ‡å®špidçš„å­è¿›ç¨‹ï¼Œè¿˜æ˜¯ç­‰å¾…åŒä¸€è¿›ç¨‹ç»„ä¸‹çš„ä»»ä¸€å­è¿›ç¨‹ï¼Œè¿˜æ˜¯ç­‰å¾…ç»„IDç­‰äºpidçš„ä»»ä¸€å­è¿›ç¨‹ï¼› å­è¿›ç¨‹ç»“æŸæ—¶ï¼Œç³»ç»Ÿä¼šäº§ç”ŸSIGCHLD(signal-child)ä¿¡å·ï¼Œå¯ä»¥æ³¨å†Œä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­è°ƒç”¨waitpidï¼Œç­‰å¾…æ‰€æœ‰ç»“æŸçš„å­è¿›ç¨‹ï¼ˆæ³¨æ„ï¼šä¸€èˆ¬éƒ½éœ€è¦å¾ªç¯è°ƒç”¨waitpidï¼Œå› ä¸ºåœ¨ä¿¡å·å¤„ç†å‡½æ•°å¼€å§‹æ‰§è¡Œä¹‹å‰ï¼Œå¯èƒ½å·²ç»æœ‰å¤šä¸ªå­è¿›ç¨‹ç»“æŸäº†ï¼Œè€Œä¿¡å·å¤„ç†å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥è¦å¾ªç¯è°ƒç”¨å°†æ‰€æœ‰ç»“æŸçš„å­è¿›ç¨‹å›æ”¶ï¼‰ï¼› ä¹Ÿå¯ä»¥ç”¨signal(SIGCLD, SIG_IGN)(signal-ignore)é€šçŸ¥å†…æ ¸ï¼Œè¡¨ç¤ºå¿½ç•¥SIGCHLDä¿¡å·ï¼Œé‚£ä¹ˆå­è¿›ç¨‹ç»“æŸåï¼Œå†…æ ¸ä¼šè¿›è¡Œå›æ”¶ã€‚ ä»€ä¹ˆæ˜¯å­¤å„¿è¿›ç¨‹ï¼Ÿ å±•å¼€ ä¸€ä¸ªçˆ¶è¿›ç¨‹å·²ç»ç»“æŸäº†ï¼Œä½†æ˜¯å®ƒçš„å­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆè¿™äº›å­è¿›ç¨‹å°†æˆä¸ºå­¤å„¿è¿›ç¨‹ã€‚å­¤å„¿è¿›ç¨‹ä¼šè¢«Initï¼ˆè¿›ç¨‹IDä¸º1ï¼‰æ¥ç®¡ï¼Œå½“è¿™äº›å­¤å„¿è¿›ç¨‹ç»“æŸæ—¶ç”±Initå®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚ çº¿ç¨‹åŒæ­¥æœ‰å“ªäº›æ–¹å¼ï¼Ÿ ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹åŒæ­¥ï¼šçº¿ç¨‹æœ‰æ—¶å€™ä¼šå’Œå…¶ä»–çº¿ç¨‹å…±äº«ä¸€äº›èµ„æºï¼Œæ¯”å¦‚å†…å­˜ã€æ•°æ®åº“ç­‰ã€‚å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™åŒä¸€ä»½å…±äº«èµ„æºçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå†²çªã€‚å› æ­¤éœ€è¦çº¿ç¨‹çš„åŒæ­¥ï¼Œå¤šä¸ªçº¿ç¨‹æŒ‰é¡ºåºè®¿é—®èµ„æºã€‚ äº’æ–¥é‡ Mutexï¼šäº’æ–¥é‡æ˜¯å†…æ ¸å¯¹è±¡ï¼Œåªæœ‰æ‹¥æœ‰äº’æ–¥å¯¹è±¡çš„çº¿ç¨‹æ‰æœ‰è®¿é—®äº’æ–¥èµ„æºçš„æƒé™ã€‚å› ä¸ºäº’æ–¥å¯¹è±¡åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯äº’æ–¥èµ„æºä¸ä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼›å½“å‰æ‹¥æœ‰äº’æ–¥å¯¹è±¡çš„çº¿ç¨‹å¤„ç†å®Œä»»åŠ¡åå¿…é¡»å°†äº’æ–¥å¯¹è±¡äº¤å‡ºï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹è®¿é—®è¯¥èµ„æºï¼› ä¿¡å·é‡ Semaphoreï¼šä¿¡å·é‡æ˜¯å†…æ ¸å¯¹è±¡ï¼Œå®ƒå…è®¸åŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€èµ„æºï¼Œä½†æ˜¯éœ€è¦æ§åˆ¶åŒä¸€æ—¶åˆ»è®¿é—®æ­¤èµ„æºçš„æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚ä¿¡å·é‡å¯¹è±¡ä¿å­˜äº†æœ€å¤§èµ„æºè®¡æ•°å’Œå½“å‰å¯ç”¨èµ„æºè®¡æ•°ï¼Œæ¯å¢åŠ ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ï¼Œå½“å‰å¯ç”¨èµ„æºè®¡æ•°å°±å‡1ï¼Œåªè¦å½“å‰å¯ç”¨èµ„æºè®¡æ•°å¤§äº0ï¼Œå°±å¯ä»¥å‘å‡ºä¿¡å·é‡ä¿¡å·ï¼Œå¦‚æœä¸º0ï¼Œåˆ™å°†çº¿ç¨‹æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚çº¿ç¨‹å¤„ç†å®Œå…±äº«èµ„æºåï¼Œåº”åœ¨ç¦»å¼€çš„åŒæ—¶é€šè¿‡ReleaseSemaphoreå‡½æ•°å°†å½“å‰å¯ç”¨èµ„æºæ•°åŠ 1ã€‚å¦‚æœä¿¡å·é‡çš„å–å€¼åªèƒ½ä¸º0æˆ–1ï¼Œé‚£ä¹ˆä¿¡å·é‡å°±æˆä¸ºäº†äº’æ–¥é‡ï¼› äº‹ä»¶ Eventï¼šå…è®¸ä¸€ä¸ªçº¿ç¨‹åœ¨å¤„ç†å®Œä¸€ä¸ªä»»åŠ¡åï¼Œä¸»åŠ¨å”¤é†’å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚äº‹ä»¶åˆ†ä¸ºæ‰‹åŠ¨é‡ç½®äº‹ä»¶å’Œè‡ªåŠ¨é‡ç½®äº‹ä»¶ã€‚æ‰‹åŠ¨é‡ç½®äº‹ä»¶è¢«è®¾ç½®ä¸ºæ¿€å‘çŠ¶æ€åï¼Œä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œè€Œä¸”ä¸€ç›´ä¿æŒä¸ºæ¿€å‘çŠ¶æ€ï¼Œç›´åˆ°ç¨‹åºé‡æ–°æŠŠå®ƒè®¾ç½®ä¸ºæœªæ¿€å‘çŠ¶æ€ã€‚è‡ªåŠ¨é‡ç½®äº‹ä»¶è¢«è®¾ç½®ä¸ºæ¿€å‘çŠ¶æ€åï¼Œä¼šå”¤é†’ä¸€ä¸ªç­‰å¾…ä¸­çš„çº¿ç¨‹ï¼Œç„¶åè‡ªåŠ¨æ¢å¤ä¸ºæœªæ¿€å‘çŠ¶æ€ã€‚ ä¸´ç•ŒåŒº Critical Sectionï¼šä»»æ„æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸´ç•Œèµ„æºè¿›è¡Œè®¿é—®ã€‚æ‹¥æœ‰ä¸´ç•ŒåŒºå¯¹è±¡çš„çº¿ç¨‹å¯ä»¥è®¿é—®è¯¥ä¸´ç•Œèµ„æºï¼Œå…¶å®ƒè¯•å›¾è®¿é—®è¯¥èµ„æºçš„çº¿ç¨‹å°†è¢«æŒ‚èµ·ï¼Œç›´åˆ°ä¸´ç•ŒåŒºå¯¹è±¡è¢«é‡Šæ”¾ã€‚ äº’æ–¥é‡å’Œä¸´ç•ŒåŒºæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ å±•å¼€ äº’æ–¥é‡æ˜¯å¯ä»¥å‘½åçš„ï¼Œå¯ä»¥ç”¨äºä¸åŒè¿›ç¨‹ä¹‹é—´çš„åŒæ­¥ï¼›è€Œä¸´ç•ŒåŒºåªèƒ½ç”¨äºåŒä¸€è¿›ç¨‹ä¸­çº¿ç¨‹çš„åŒæ­¥ã€‚åˆ›å»ºäº’æ–¥é‡éœ€è¦çš„èµ„æºæ›´å¤šï¼Œå› æ­¤ä¸´ç•ŒåŒºçš„ä¼˜åŠ¿æ˜¯é€Ÿåº¦å¿«ï¼ŒèŠ‚çœèµ„æºã€‚ ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿåç¨‹æ˜¯ä¸€ç§ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œåç¨‹çš„è°ƒåº¦å®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶ã€‚åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆï¼Œç›´æ¥æ“ä½œæ ˆåˆ™åŸºæœ¬æ²¡æœ‰å†…æ ¸åˆ‡æ¢çš„å¼€é”€ï¼Œå¯ä»¥ä¸åŠ é”çš„è®¿é—®å…¨å±€å˜é‡ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡çš„åˆ‡æ¢éå¸¸å¿«ã€‚ åç¨‹å¤šä¸çº¿ç¨‹è¿›è¡Œæ¯”è¾ƒï¼Ÿ å±•å¼€ ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‹¥æœ‰å¤šä¸ªåç¨‹ï¼Œä¸€ä¸ªè¿›ç¨‹ä¹Ÿå¯ä»¥å•ç‹¬æ‹¥æœ‰å¤šä¸ªåç¨‹ï¼Œè¿™æ ·pythonä¸­åˆ™èƒ½ä½¿ç”¨å¤šæ ¸CPUã€‚ çº¿ç¨‹è¿›ç¨‹éƒ½æ˜¯åŒæ­¥æœºåˆ¶ï¼Œè€Œåç¨‹åˆ™æ˜¯å¼‚æ­¥ åç¨‹èƒ½ä¿ç•™ä¸Šä¸€æ¬¡è°ƒç”¨æ—¶çš„çŠ¶æ€ï¼Œæ¯æ¬¡è¿‡ç¨‹é‡å…¥æ—¶ï¼Œå°±ç›¸å½“äºè¿›å…¥ä¸Šä¸€æ¬¡è°ƒç”¨çš„çŠ¶æ€ è¿›ç¨‹çš„å¼‚å¸¸æ§åˆ¶æµï¼šé™·é˜±ã€ä¸­æ–­ã€å¼‚å¸¸å’Œä¿¡å·é™·é˜±æ˜¯æœ‰æ„é€ æˆçš„â€œå¼‚å¸¸â€ï¼Œæ˜¯æ‰§è¡Œä¸€æ¡æŒ‡ä»¤çš„ç»“æœã€‚é™·é˜±æ˜¯åŒæ­¥çš„ã€‚é™·é˜±çš„ä¸»è¦ä½œç”¨æ˜¯å®ç°ç³»ç»Ÿè°ƒç”¨ã€‚æ¯”å¦‚ï¼Œè¿›ç¨‹å¯ä»¥æ‰§è¡Œ syscall n æŒ‡ä»¤å‘å†…æ ¸è¯·æ±‚æœåŠ¡ã€‚å½“è¿›ç¨‹æ‰§è¡Œè¿™æ¡æŒ‡ä»¤åï¼Œä¼šä¸­æ–­å½“å‰çš„æ§åˆ¶æµï¼Œé™·å…¥åˆ°å†…æ ¸æ€ï¼Œæ‰§è¡Œç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ã€‚å†…æ ¸çš„å¤„ç†ç¨‹åºåœ¨æ‰§è¡Œç»“æŸåï¼Œä¼šå°†ç»“æœè¿”å›ç»™è¿›ç¨‹ï¼ŒåŒæ—¶é€€å›åˆ°ç”¨æˆ·æ€ã€‚è¿›ç¨‹æ­¤æ—¶ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚ ä¸­æ–­ç”±å¤„ç†å™¨å¤–éƒ¨çš„ç¡¬ä»¶äº§ç”Ÿï¼Œä¸æ˜¯æ‰§è¡ŒæŸæ¡æŒ‡ä»¤çš„ç»“æœï¼Œä¹Ÿæ— æ³•é¢„æµ‹å‘ç”Ÿæ—¶æœºã€‚ç”±äºä¸­æ–­ç‹¬ç«‹äºå½“å‰æ‰§è¡Œçš„ç¨‹åºï¼Œå› æ­¤ä¸­æ–­æ˜¯å¼‚æ­¥äº‹ä»¶ã€‚ä¸­æ–­åŒ…æ‹¬ I/O è®¾å¤‡å‘å‡ºçš„ I/O ä¸­æ–­ã€å„ç§å®šæ—¶å™¨å¼•èµ·çš„æ—¶é’Ÿä¸­æ–­ã€è°ƒè¯•ç¨‹åºä¸­è®¾ç½®çš„æ–­ç‚¹ç­‰å¼•èµ·çš„è°ƒè¯•ä¸­æ–­ç­‰ã€‚ å¼‚å¸¸æ˜¯ä¸€ç§é”™è¯¯æƒ…å†µï¼Œæ˜¯æ‰§è¡Œå½“å‰æŒ‡ä»¤çš„ç»“æœï¼Œå¯èƒ½è¢«é”™è¯¯å¤„ç†ç¨‹åºä¿®æ­£ï¼Œä¹Ÿå¯èƒ½ç›´æ¥ç»ˆæ­¢åº”ç”¨ç¨‹åºã€‚å¼‚å¸¸æ˜¯åŒæ­¥çš„ã€‚è¿™é‡Œç‰¹æŒ‡å› ä¸ºæ‰§è¡Œå½“å‰æŒ‡ä»¤è€Œäº§ç”Ÿçš„é”™è¯¯æƒ…å†µï¼Œæ¯”å¦‚é™¤æ³•å¼‚å¸¸ã€ç¼ºé¡µå¼‚å¸¸ç­‰ã€‚æœ‰äº›ä¹¦ä¸Šä¸ºäº†åŒºåˆ†ï¼Œä¹Ÿå°†è¿™ç±»â€œå¼‚å¸¸â€ç§°ä¸ºâ€œæ•…éšœâ€ã€‚ ä¿¡å·æ˜¯ä¸€ç§æ›´é«˜å±‚çš„è½¯ä»¶å½¢å¼çš„å¼‚å¸¸ï¼ŒåŒæ ·ä¼šä¸­æ–­è¿›ç¨‹çš„æ§åˆ¶æµï¼Œå¯ä»¥ç”±è¿›ç¨‹è¿›è¡Œå¤„ç†ã€‚ä¸€ä¸ªä¿¡å·ä»£è¡¨äº†ä¸€ä¸ªæ¶ˆæ¯ã€‚ä¿¡å·çš„ä½œç”¨æ˜¯ç”¨æ¥é€šçŸ¥è¿›ç¨‹å‘ç”Ÿäº†æŸç§ç³»ç»Ÿäº‹ä»¶ã€‚ æ›´è¯¦ç»†çš„å¯ä»¥å‚è€ƒï¼šhttps://imageslr.github.io/2020/07/09/trap-interrupt-exception.html ä»€ä¹ˆæ˜¯IOå¤šè·¯å¤ç”¨ï¼Ÿæ€ä¹ˆå®ç°ï¼ŸIOå¤šè·¯å¤ç”¨ï¼ˆIO Multiplexingï¼‰æ˜¯æŒ‡å•ä¸ªè¿›ç¨‹/çº¿ç¨‹å°±å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªIOè¯·æ±‚ã€‚ å®ç°åŸç†ï¼šç”¨æˆ·å°†æƒ³è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile Descriptorï¼‰æ·»åŠ åˆ°select/poll/epollå‡½æ•°ä¸­ï¼Œç”±å†…æ ¸ç›‘è§†ï¼Œå‡½æ•°é˜»å¡ã€‚ä¸€æ—¦æœ‰æ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼ˆè¯»å°±ç»ªæˆ–å†™å°±ç»ªï¼‰ï¼Œæˆ–è€…è¶…æ—¶ï¼ˆè®¾ç½®timeoutï¼‰ï¼Œå‡½æ•°å°±ä¼šè¿”å›ï¼Œç„¶åè¯¥è¿›ç¨‹å¯ä»¥è¿›è¡Œç›¸åº”çš„è¯»/å†™æ“ä½œã€‚ select/poll/epollä¸‰è€…çš„åŒºåˆ«ï¼Ÿ selectï¼šå°†æ–‡ä»¶æè¿°ç¬¦æ”¾å…¥ä¸€ä¸ªé›†åˆä¸­ï¼Œè°ƒç”¨selectæ—¶ï¼Œå°†è¿™ä¸ªé›†åˆä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆç¼ºç‚¹1ï¼šæ¯æ¬¡éƒ½è¦å¤åˆ¶ï¼Œå¼€é”€å¤§ï¼‰ï¼Œç”±å†…æ ¸æ ¹æ®å°±ç»ªçŠ¶æ€ä¿®æ”¹è¯¥é›†åˆçš„å†…å®¹ã€‚ï¼ˆç¼ºç‚¹2ï¼‰é›†åˆå¤§å°æœ‰é™åˆ¶ï¼Œ32ä½æœºé»˜è®¤æ˜¯1024ï¼ˆ64ä½ï¼š2048ï¼‰ï¼›é‡‡ç”¨æ°´å¹³è§¦å‘æœºåˆ¶ã€‚selectå‡½æ•°è¿”å›åï¼Œéœ€è¦é€šè¿‡éå†è¿™ä¸ªé›†åˆï¼Œæ‰¾åˆ°å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆç¼ºç‚¹3ï¼šè½®è¯¢çš„æ–¹å¼æ•ˆç‡è¾ƒä½ï¼‰ï¼Œå½“æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡å¢åŠ æ—¶ï¼Œæ•ˆç‡ä¼šçº¿æ€§ä¸‹é™ï¼› pollï¼šå’Œselectå‡ ä¹æ²¡æœ‰åŒºåˆ«ï¼ŒåŒºåˆ«åœ¨äºæ–‡ä»¶æè¿°ç¬¦çš„å­˜å‚¨æ–¹å¼ä¸åŒï¼Œpollé‡‡ç”¨é“¾è¡¨çš„æ–¹å¼å­˜å‚¨ï¼Œæ²¡æœ‰æœ€å¤§å­˜å‚¨æ•°é‡çš„é™åˆ¶ï¼› epollï¼šé€šè¿‡å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å…±äº«å†…å­˜ï¼Œé¿å…äº†ä¸æ–­å¤åˆ¶çš„é—®é¢˜ï¼›æ”¯æŒçš„åŒæ—¶è¿æ¥æ•°ä¸Šé™å¾ˆé«˜ï¼ˆ1Gå·¦å³çš„å†…å­˜æ”¯æŒ10Wå·¦å³çš„è¿æ¥æ•°ï¼‰ï¼›æ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ—¶ï¼Œé‡‡ç”¨å›è°ƒæœºåˆ¶ï¼Œé¿å…äº†è½®è¯¢ï¼ˆå›è°ƒå‡½æ•°å°†å°±ç»ªçš„æè¿°ç¬¦æ·»åŠ åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œæ‰§è¡Œepoll_waitæ—¶ï¼Œè¿”å›è¿™ä¸ªé“¾è¡¨ï¼‰ï¼›æ”¯æŒæ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘ï¼Œé‡‡ç”¨è¾¹ç¼˜è§¦å‘æœºåˆ¶æ—¶ï¼Œåªæœ‰æ´»è·ƒçš„æè¿°ç¬¦æ‰ä¼šè§¦å‘å›è°ƒå‡½æ•°ã€‚ æ€»ç»“ï¼ŒåŒºåˆ«ä¸»è¦åœ¨äºï¼š ä¸€ä¸ªçº¿ç¨‹/è¿›ç¨‹æ‰€èƒ½æ‰“å¼€çš„æœ€å¤§è¿æ¥æ•° æ–‡ä»¶æè¿°ç¬¦ä¼ é€’æ–¹å¼ï¼ˆæ˜¯å¦å¤åˆ¶ï¼‰ æ°´å¹³è§¦å‘ or è¾¹ç¼˜è§¦å‘ æŸ¥è¯¢å°±ç»ªçš„æè¿°ç¬¦æ—¶çš„æ•ˆç‡ï¼ˆæ˜¯å¦è½®è¯¢ï¼‰ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨select/pollï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨epollï¼Ÿ å½“è¿æ¥æ•°è¾ƒå¤šå¹¶ä¸”æœ‰å¾ˆå¤šçš„ä¸æ´»è·ƒè¿æ¥æ—¶ï¼Œepollçš„æ•ˆç‡æ¯”å…¶å®ƒä¸¤è€…é«˜å¾ˆå¤šï¼›ä½†æ˜¯å½“è¿æ¥æ•°è¾ƒå°‘å¹¶ä¸”éƒ½ååˆ†æ´»è·ƒçš„æƒ…å†µä¸‹ï¼Œç”±äºepolléœ€è¦å¾ˆå¤šå›è°ƒï¼Œå› æ­¤æ€§èƒ½å¯èƒ½ä½äºå…¶å®ƒä¸¤è€…ã€‚ ä»€ä¹ˆæ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Ÿ æ–‡ä»¶æè¿°ç¬¦åœ¨å½¢å¼ä¸Šæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ã€‚å®é™…ä¸Šï¼Œå®ƒæ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼ŒæŒ‡å‘å†…æ ¸ä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹æ‰€ç»´æŠ¤çš„è¯¥è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„è®°å½•è¡¨ã€‚å½“ç¨‹åºæ‰“å¼€ä¸€ä¸ªç°æœ‰æ–‡ä»¶æˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶æ—¶ï¼Œå†…æ ¸å‘è¿›ç¨‹è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚ å†…æ ¸é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥è®¿é—®æ–‡ä»¶ã€‚æ–‡ä»¶æè¿°ç¬¦æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶ã€‚ ä»€ä¹ˆæ˜¯æ°´å¹³è§¦å‘ï¼Ÿä»€ä¹ˆæ˜¯è¾¹ç¼˜è§¦å‘ï¼Ÿ å±•å¼€ æ°´å¹³è§¦å‘ï¼ˆLTï¼ŒLevel Triggerï¼‰æ¨¡å¼ä¸‹ï¼Œåªè¦ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼Œå°±ä¼šè§¦å‘é€šçŸ¥ï¼Œå¦‚æœç”¨æˆ·ç¨‹åºæ²¡æœ‰ä¸€æ¬¡æ€§æŠŠæ•°æ®è¯»å†™å®Œï¼Œä¸‹æ¬¡è¿˜ä¼šé€šçŸ¥ï¼› è¾¹ç¼˜è§¦å‘ï¼ˆETï¼ŒEdge Triggerï¼‰æ¨¡å¼ä¸‹ï¼Œå½“æè¿°ç¬¦ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªæ—¶é€šçŸ¥ä¸€æ¬¡ï¼Œä¹‹åä¸ä¼šå†é€šçŸ¥ï¼Œç›´åˆ°å†æ¬¡ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªï¼ˆç¼“å†²åŒºä»ä¸å¯è¯»/å†™å˜ä¸ºå¯è¯»/å†™ï¼‰ã€‚ åŒºåˆ«ï¼šè¾¹ç¼˜è§¦å‘æ•ˆç‡æ›´é«˜ï¼Œå‡å°‘äº†è¢«é‡å¤è§¦å‘çš„æ¬¡æ•°ï¼Œå‡½æ•°ä¸ä¼šè¿”å›å¤§é‡ç”¨æˆ·ç¨‹åºå¯èƒ½ä¸éœ€è¦çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ ä¸ºä»€ä¹ˆè¾¹ç¼˜è§¦å‘ä¸€å®šè¦ç”¨éé˜»å¡ï¼ˆnon-blockï¼‰IOï¼šé¿å…ç”±äºä¸€ä¸ªæè¿°ç¬¦çš„é˜»å¡è¯»/é˜»å¡å†™æ“ä½œè®©å¤„ç†å…¶å®ƒæè¿°ç¬¦çš„ä»»åŠ¡å‡ºç°é¥¥é¥¿çŠ¶æ€ã€‚ æœ‰å“ªäº›å¸¸è§çš„IOæ¨¡å‹ï¼Ÿ å±•å¼€ åŒæ­¥é˜»å¡IOï¼ˆBlocking IOï¼‰ï¼šç”¨æˆ·çº¿ç¨‹å‘èµ·IOè¯»/å†™æ“ä½œä¹‹åï¼Œçº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°å¯ä»¥å¼€å§‹å¤„ç†æ•°æ®ï¼›å¯¹CPUèµ„æºçš„åˆ©ç”¨ç‡ä¸å¤Ÿï¼› åŒæ­¥éé˜»å¡IOï¼ˆNon-blocking IOï¼‰ï¼šå‘èµ·IOè¯·æ±‚ä¹‹åå¯ä»¥ç«‹å³è¿”å›ï¼Œå¦‚æœæ²¡æœ‰å°±ç»ªçš„æ•°æ®ï¼Œéœ€è¦ä¸æ–­åœ°å‘èµ·IOè¯·æ±‚ç›´åˆ°æ•°æ®å°±ç»ªï¼›ä¸æ–­é‡å¤è¯·æ±‚æ¶ˆè€—äº†å¤§é‡çš„CPUèµ„æºï¼› IOå¤šè·¯å¤ç”¨ å¼‚æ­¥IOï¼ˆAsynchronous IOï¼‰ï¼šç”¨æˆ·çº¿ç¨‹å‘å‡ºIOè¯·æ±‚ä¹‹åï¼Œç»§ç»­æ‰§è¡Œï¼Œç”±å†…æ ¸è¿›è¡Œæ•°æ®çš„è¯»å–å¹¶æ”¾åœ¨ç”¨æˆ·æŒ‡å®šçš„ç¼“å†²åŒºå†…ï¼Œåœ¨IOå®Œæˆä¹‹åé€šçŸ¥ç”¨æˆ·çº¿ç¨‹ç›´æ¥ä½¿ç”¨ã€‚ ä»€ä¹ˆæ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿä¸ºäº†é™åˆ¶ä¸åŒç¨‹åºçš„è®¿é—®èƒ½åŠ›ï¼Œé˜²æ­¢ä¸€äº›ç¨‹åºè®¿é—®å…¶å®ƒç¨‹åºçš„å†…å­˜æ•°æ®ï¼ŒCPUåˆ’åˆ†äº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¸¤ä¸ªæƒé™ç­‰çº§ã€‚ ç”¨æˆ·æ€åªèƒ½å—é™åœ°è®¿é—®å†…å­˜ï¼Œä¸”ä¸å…è®¸è®¿é—®å¤–å›´è®¾å¤‡ï¼Œæ²¡æœ‰å ç”¨CPUçš„èƒ½åŠ›ï¼ŒCPUèµ„æºå¯ä»¥è¢«å…¶å®ƒç¨‹åºè·å–ï¼› å†…æ ¸æ€å¯ä»¥è®¿é—®å†…å­˜æ‰€æœ‰æ•°æ®ä»¥åŠå¤–å›´è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç¨‹åºçš„åˆ‡æ¢ã€‚ æ‰€æœ‰ç”¨æˆ·ç¨‹åºéƒ½è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œä½†æœ‰æ—¶éœ€è¦è¿›è¡Œä¸€äº›å†…æ ¸æ€çš„æ“ä½œï¼Œæ¯”å¦‚ä»ç¡¬ç›˜æˆ–è€…é”®ç›˜è¯»æ•°æ®ï¼Œè¿™æ—¶å°±éœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä½¿ç”¨é™·é˜±æŒ‡ä»¤ï¼ŒCPUåˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œæ‰§è¡Œç›¸åº”çš„æœåŠ¡ï¼Œå†åˆ‡æ¢ä¸ºç”¨æˆ·æ€å¹¶è¿”å›ç³»ç»Ÿè°ƒç”¨çš„ç»“æœã€‚ ä¸ºä»€ä¹ˆè¦åˆ†ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Ÿ å±•å¼€ ï¼ˆæˆ‘è‡ªå·±çš„è§è§£ï¼šï¼‰ å®‰å…¨æ€§ï¼šé˜²æ­¢ç”¨æˆ·ç¨‹åºæ¶æ„æˆ–è€…ä¸å°å¿ƒç ´åç³»ç»Ÿ/å†…å­˜/ç¡¬ä»¶èµ„æºï¼› å°è£…æ€§ï¼šç”¨æˆ·ç¨‹åºä¸éœ€è¦å®ç°æ›´åŠ åº•å±‚çš„ä»£ç ï¼› åˆ©äºè°ƒåº¦ï¼šå¦‚æœå¤šä¸ªç”¨æˆ·ç¨‹åºéƒ½åœ¨ç­‰å¾…é”®ç›˜è¾“å…¥ï¼Œè¿™æ—¶å°±éœ€è¦è¿›è¡Œè°ƒåº¦ï¼›ç»Ÿä¸€äº¤ç»™æ“ä½œç³»ç»Ÿè°ƒåº¦æ›´åŠ æ–¹ä¾¿ã€‚ å¦‚ä½•ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Ÿ å±•å¼€ ç³»ç»Ÿè°ƒç”¨ï¼šæ¯”å¦‚è¯»å–å‘½ä»¤è¡Œè¾“å…¥ã€‚æœ¬è´¨ä¸Šè¿˜æ˜¯é€šè¿‡ä¸­æ–­å®ç° ç”¨æˆ·ç¨‹åºå‘ç”Ÿå¼‚å¸¸æ—¶ï¼šæ¯”å¦‚ç¼ºé¡µå¼‚å¸¸ å¤–å›´è®¾å¤‡çš„ä¸­æ–­ï¼šå¤–å›´è®¾å¤‡å®Œæˆç”¨æˆ·è¯·æ±‚çš„æ“ä½œä¹‹åï¼Œä¼šå‘CPUå‘å‡ºä¸­æ–­ä¿¡å·ï¼Œè¿™æ—¶CPUä¼šè½¬å»å¤„ç†å¯¹åº”çš„ä¸­æ–­å¤„ç†ç¨‹åº ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿåœ¨ä¸¤ä¸ªæˆ–è€…å¤šä¸ªå¹¶å‘è¿›ç¨‹ä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹æŒæœ‰æŸç§èµ„æºè€Œåˆç­‰å¾…å…¶å®ƒè¿›ç¨‹é‡Šæ”¾å®ƒä»¬ç°åœ¨ä¿æŒç€çš„èµ„æºï¼Œåœ¨æœªæ”¹å˜è¿™ç§çŠ¶æ€ä¹‹å‰éƒ½ä¸èƒ½å‘å‰æ¨è¿›ï¼Œç§°è¿™ä¸€ç»„è¿›ç¨‹äº§ç”Ÿäº†æ­»é”(deadlock)ã€‚ æ­»é”äº§ç”Ÿçš„å¿…è¦æ¡ä»¶ï¼Ÿ äº’æ–¥ï¼šä¸€ä¸ªèµ„æºä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼› å æœ‰å¹¶ç­‰å¾…ï¼šä¸€ä¸ªè¿›ç¨‹è‡³å°‘å æœ‰ä¸€ä¸ªèµ„æºï¼Œå¹¶åœ¨ç­‰å¾…å¦ä¸€ä¸ªè¢«å…¶å®ƒè¿›ç¨‹å ç”¨çš„èµ„æºï¼› éæŠ¢å ï¼šå·²ç»åˆ†é…ç»™ä¸€ä¸ªè¿›ç¨‹çš„èµ„æºä¸èƒ½è¢«å¼ºåˆ¶æ€§æŠ¢å ï¼Œåªèƒ½ç”±è¿›ç¨‹å®Œæˆä»»åŠ¡ä¹‹åè‡ªæ„¿é‡Šæ”¾ï¼› å¾ªç¯ç­‰å¾…ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„ç¯å½¢ç­‰å¾…èµ„æºå…³ç³»ï¼Œè¯¥ç¯è·¯ä¸­çš„æ¯ä¸ªè¿›ç¨‹éƒ½åœ¨ç­‰å¾…ä¸‹ä¸€ä¸ªè¿›ç¨‹æ‰€å æœ‰çš„èµ„æºã€‚ æ­»é”æœ‰å“ªäº›å¤„ç†æ–¹æ³•ï¼Ÿ é¸µé¸Ÿç­–ç•¥ ç›´æ¥å¿½ç•¥æ­»é”ã€‚å› ä¸ºè§£å†³æ­»é”é—®é¢˜çš„ä»£ä»·å¾ˆé«˜ï¼Œå› æ­¤é¸µé¸Ÿç­–ç•¥è¿™ç§ä¸é‡‡å–ä»»åŠ¡æªæ–½çš„æ–¹æ¡ˆä¼šè·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚å½“å‘ç”Ÿæ­»é”æ—¶ä¸ä¼šå¯¹ç”¨æˆ·é€ æˆå¤šå¤§å½±å“ï¼Œæˆ–å‘ç”Ÿæ­»é”çš„æ¦‚ç‡å¾ˆä½ï¼Œå¯ä»¥é‡‡ç”¨é¸µé¸Ÿç­–ç•¥ã€‚ æ­»é”é¢„é˜² åŸºæœ¬æ€æƒ³æ˜¯ç ´åå½¢æˆæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼š ç ´åäº’æ–¥æ¡ä»¶ï¼šå…è®¸æŸäº›èµ„æºåŒæ—¶è¢«å¤šä¸ªè¿›ç¨‹è®¿é—®ã€‚ä½†æ˜¯æœ‰äº›èµ„æºæœ¬èº«å¹¶ä¸å…·æœ‰è¿™ç§å±æ€§ï¼Œå› æ­¤è¿™ç§æ–¹æ¡ˆå®ç”¨æ€§æœ‰é™ï¼› ç ´åå æœ‰å¹¶ç­‰å¾…æ¡ä»¶ï¼š å®è¡Œèµ„æºé¢„å…ˆåˆ†é…ç­–ç•¥ï¼ˆå½“ä¸€ä¸ªè¿›ç¨‹å¼€å§‹è¿è¡Œä¹‹å‰ï¼Œå¿…é¡»ä¸€æ¬¡æ€§å‘ç³»ç»Ÿç”³è¯·å®ƒæ‰€éœ€è¦çš„å…¨éƒ¨èµ„æºï¼Œå¦åˆ™ä¸è¿è¡Œï¼‰ï¼› æˆ–è€…åªå…è®¸è¿›ç¨‹åœ¨æ²¡æœ‰å ç”¨èµ„æºçš„æ—¶å€™æ‰èƒ½ç”³è¯·èµ„æºï¼ˆç”³è¯·èµ„æºå‰å…ˆé‡Šæ”¾å æœ‰çš„èµ„æºï¼‰ï¼› ç¼ºç‚¹ï¼šå¾ˆå¤šæ—¶å€™æ— æ³•é¢„çŸ¥ä¸€ä¸ªè¿›ç¨‹æ‰€éœ€çš„å…¨éƒ¨èµ„æºï¼›åŒæ—¶ï¼Œä¼šé™ä½èµ„æºåˆ©ç”¨ç‡ï¼Œé™ä½ç³»ç»Ÿçš„å¹¶å‘æ€§ï¼› ç ´åéæŠ¢å æ¡ä»¶ï¼šå…è®¸è¿›ç¨‹å¼ºè¡ŒæŠ¢å è¢«å…¶å®ƒè¿›ç¨‹å æœ‰çš„èµ„æºã€‚ä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ï¼› ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šå¯¹æ‰€æœ‰èµ„æºç»Ÿä¸€ç¼–å·ï¼Œæ‰€æœ‰è¿›ç¨‹å¯¹èµ„æºçš„è¯·æ±‚å¿…é¡»æŒ‰ç…§åºå·é€’å¢çš„é¡ºåºæå‡ºï¼Œå³åªæœ‰å æœ‰äº†ç¼–å·è¾ƒå°çš„èµ„æºæ‰èƒ½ç”³è¯·ç¼–å·è¾ƒå¤§çš„èµ„æºã€‚è¿™æ ·é¿å…äº†å æœ‰å¤§å·èµ„æºçš„è¿›ç¨‹å»ç”³è¯·å°å·èµ„æºã€‚ æ­»é”é¿å… åŠ¨æ€åœ°æ£€æµ‹èµ„æºåˆ†é…çŠ¶æ€ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿå¤„äºå®‰å…¨çŠ¶æ€ï¼Œåªæœ‰å¤„äºå®‰å…¨çŠ¶æ€æ—¶æ‰ä¼šè¿›è¡Œèµ„æºçš„åˆ†é…ã€‚æ‰€è°“å®‰å…¨çŠ¶æ€æ˜¯æŒ‡ï¼šå³ä½¿æ‰€æœ‰è¿›ç¨‹çªç„¶è¯·æ±‚éœ€è¦çš„æ‰€æœ‰èµ„æºï¼Œä¹Ÿèƒ½å­˜åœ¨æŸç§å¯¹è¿›ç¨‹çš„èµ„æºåˆ†é…é¡ºåºï¼Œä½¿å¾—æ¯ä¸€ä¸ªè¿›ç¨‹è¿è¡Œå®Œæ¯•ã€‚ é“¶è¡Œå®¶ç®—æ³• æ­»é”è§£é™¤ å¦‚ä½•æ£€æµ‹æ­»é”ï¼šæ£€æµ‹æœ‰å‘å›¾æ˜¯å¦å­˜åœ¨ç¯ï¼›æˆ–è€…ä½¿ç”¨ç±»ä¼¼æ­»é”é¿å…çš„æ£€æµ‹ç®—æ³•ã€‚ æ­»é”è§£é™¤çš„æ–¹æ³•ï¼š åˆ©ç”¨æŠ¢å ï¼šæŒ‚èµ·æŸäº›è¿›ç¨‹ï¼Œå¹¶æŠ¢å å®ƒçš„èµ„æºã€‚ä½†åº”é˜²æ­¢æŸäº›è¿›ç¨‹è¢«é•¿æ—¶é—´æŒ‚èµ·è€Œå¤„äºé¥¥é¥¿çŠ¶æ€ï¼› åˆ©ç”¨å›æ»šï¼šè®©æŸäº›è¿›ç¨‹å›é€€åˆ°è¶³ä»¥è§£é™¤æ­»é”çš„åœ°æ­¥ï¼Œè¿›ç¨‹å›é€€æ—¶è‡ªæ„¿é‡Šæ”¾èµ„æºã€‚è¦æ±‚ç³»ç»Ÿä¿æŒè¿›ç¨‹çš„å†å²ä¿¡æ¯ï¼Œè®¾ç½®è¿˜åŸç‚¹ï¼› åˆ©ç”¨æ€æ­»è¿›ç¨‹ï¼šå¼ºåˆ¶æ€æ­»æŸäº›è¿›ç¨‹ç›´åˆ°æ­»é”è§£é™¤ä¸ºæ­¢ï¼Œå¯ä»¥æŒ‰ç…§ä¼˜å…ˆçº§è¿›è¡Œã€‚ åˆ†é¡µå’Œåˆ†æ®µæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ é¡µå¼å­˜å‚¨ï¼šç”¨æˆ·ç©ºé—´åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„éƒ¨åˆ†ç§°ä¸ºé¡µï¼ˆpageï¼‰ï¼Œå†…å­˜ç©ºé—´åˆ’åˆ†ä¸ºåŒæ ·å¤§å°çš„åŒºåŸŸç§°ä¸ºé¡µæ¡†ï¼Œåˆ†é…æ—¶ä»¥é¡µä¸ºå•ä½ï¼ŒæŒ‰è¿›ç¨‹éœ€è¦çš„é¡µæ•°åˆ†é…ï¼Œé€»è¾‘ä¸Šç›¸é‚»çš„é¡µç‰©ç†ä¸Šä¸ä¸€å®šç›¸é‚»ï¼› æ®µå¼å­˜å‚¨ï¼šç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´æŒ‰ç…§è‡ªèº«é€»è¾‘å…³ç³»åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªæ®µï¼ˆsegmentï¼‰ï¼ˆå¦‚ä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œå †æ ˆæ®µï¼‰ï¼Œå†…å­˜ç©ºé—´è¢«åŠ¨æ€åˆ’åˆ†ä¸ºé•¿åº¦ä¸åŒçš„åŒºåŸŸï¼Œåˆ†é…æ—¶ä»¥æ®µä¸ºå•ä½ï¼Œæ¯æ®µåœ¨å†…å­˜ä¸­å æ®è¿ç»­ç©ºé—´ï¼Œå„æ®µå¯ä»¥ä¸ç›¸é‚»ï¼› æ®µé¡µå¼å­˜å‚¨ï¼šç”¨æˆ·è¿›ç¨‹å…ˆæŒ‰æ®µåˆ’åˆ†ï¼Œæ®µå†…å†æŒ‰é¡µåˆ’åˆ†ï¼Œå†…å­˜åˆ’åˆ†å’Œåˆ†é…æŒ‰é¡µã€‚ åŒºåˆ«ï¼š ç›®çš„ä¸åŒï¼šåˆ†é¡µçš„ç›®çš„æ˜¯ç®¡ç†å†…å­˜ï¼Œç”¨äºè™šæ‹Ÿå†…å­˜ä»¥è·å¾—æ›´å¤§çš„åœ°å€ç©ºé—´ï¼›åˆ†æ®µçš„ç›®çš„æ˜¯æ»¡è¶³ç”¨æˆ·çš„éœ€è¦ï¼Œä½¿ç¨‹åºå’Œæ•°æ®å¯ä»¥è¢«åˆ’åˆ†ä¸ºé€»è¾‘ä¸Šç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼› å¤§å°ä¸åŒï¼šæ®µçš„å¤§å°ä¸å›ºå®šï¼Œç”±å…¶æ‰€å®Œæˆçš„åŠŸèƒ½å†³å®šï¼›é¡µçš„å¤§å°å›ºå®šï¼Œç”±ç³»ç»Ÿå†³å®šï¼› åœ°å€ç©ºé—´ç»´åº¦ä¸åŒï¼šåˆ†æ®µæ˜¯äºŒç»´åœ°å€ç©ºé—´ï¼ˆæ®µå·+æ®µå†…åç§»ï¼‰ï¼Œåˆ†é¡µæ˜¯ä¸€ç»´åœ°å€ç©ºé—´ï¼ˆæ¯ä¸ªè¿›ç¨‹ä¸€ä¸ªé¡µè¡¨/å¤šçº§é¡µè¡¨ï¼Œé€šè¿‡ä¸€ä¸ªé€»è¾‘åœ°å€å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ï¼‰ï¼› åˆ†æ®µä¾¿äºä¿¡æ¯çš„ä¿æŠ¤å’Œå…±äº«ï¼›åˆ†é¡µçš„å…±äº«æ”¶åˆ°é™åˆ¶ï¼› ç¢ç‰‡ï¼šåˆ†æ®µæ²¡æœ‰å†…ç¢ç‰‡ï¼Œä½†ä¼šäº§ç”Ÿå¤–ç¢ç‰‡ï¼›åˆ†é¡µæ²¡æœ‰å¤–ç¢ç‰‡ï¼Œä½†ä¼šäº§ç”Ÿå†…ç¢ç‰‡ï¼ˆä¸€ä¸ªé¡µå¡«ä¸æ»¡ï¼‰ ä»€ä¹ˆæ˜¯è™šæ‹Ÿå†…å­˜ï¼Ÿæ¯ä¸ªç¨‹åºéƒ½æ‹¥æœ‰è‡ªå·±çš„åœ°å€ç©ºé—´ï¼Œè¿™ä¸ªåœ°å€ç©ºé—´è¢«åˆ†æˆå¤§å°ç›¸ç­‰çš„é¡µï¼Œè¿™äº›é¡µè¢«æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼›ä½†ä¸éœ€è¦æ‰€æœ‰çš„é¡µéƒ½åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œå½“ç¨‹åºå¼•ç”¨åˆ°ä¸åœ¨ç‰©ç†å†…å­˜ä¸­çš„é¡µæ—¶ï¼Œç”±æ“ä½œç³»ç»Ÿå°†ç¼ºå¤±çš„éƒ¨åˆ†è£…å…¥ç‰©ç†å†…å­˜ã€‚è¿™æ ·ï¼Œå¯¹äºç¨‹åºæ¥è¯´ï¼Œé€»è¾‘ä¸Šä¼¼ä¹æœ‰å¾ˆå¤§çš„å†…å­˜ç©ºé—´ï¼Œåªæ˜¯å®é™…ä¸Šæœ‰ä¸€éƒ¨åˆ†æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œå› æ­¤å«åšè™šæ‹Ÿå†…å­˜ã€‚ è™šæ‹Ÿå†…å­˜çš„ä¼˜ç‚¹æ˜¯è®©ç¨‹åºå¯ä»¥è·å¾—æ›´å¤šçš„å¯ç”¨å†…å­˜ã€‚ è™šæ‹Ÿå†…å­˜çš„å®ç°æ–¹å¼ã€é¡µè¡¨/å¤šçº§é¡µè¡¨ã€ç¼ºé¡µä¸­æ–­ã€ä¸åŒçš„é¡µé¢æ·˜æ±°ç®—æ³•ï¼šç­”æ¡ˆã€‚ å¦‚ä½•è¿›è¡Œåœ°å€ç©ºé—´åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„ï¼Ÿ å±•å¼€ å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰ç®¡ç†ç€é€»è¾‘åœ°å€å’Œç‰©ç†åœ°å€çš„è½¬æ¢ï¼Œå…¶ä¸­çš„é¡µè¡¨ï¼ˆPage tableï¼‰å­˜å‚¨ç€é¡µï¼ˆé€»è¾‘åœ°å€ï¼‰å’Œé¡µæ¡†ï¼ˆç‰©ç†å†…å­˜ç©ºé—´ï¼‰çš„æ˜ å°„è¡¨ï¼Œé¡µè¡¨ä¸­è¿˜åŒ…å«åŒ…å«æœ‰æ•ˆä½ï¼ˆæ˜¯åœ¨å†…å­˜è¿˜æ˜¯ç£ç›˜ï¼‰ã€è®¿é—®ä½ï¼ˆæ˜¯å¦è¢«è®¿é—®è¿‡ï¼‰ã€ä¿®æ”¹ä½ï¼ˆå†…å­˜ä¸­æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼‰ã€ä¿æŠ¤ä½ï¼ˆåªè¯»è¿˜æ˜¯å¯è¯»å†™ï¼‰ã€‚é€»è¾‘åœ°å€ï¼šé¡µå·+é¡µå†…åœ°å€ï¼ˆåç§»ï¼‰ï¼›æ¯ä¸ªè¿›ç¨‹ä¸€ä¸ªé¡µè¡¨ï¼Œæ”¾åœ¨å†…å­˜ï¼Œé¡µè¡¨èµ·å§‹åœ°å€åœ¨PCB/å¯„å­˜å™¨ä¸­ã€‚ æœ‰å“ªäº›é¡µé¢ç½®æ¢ç®—æ³•ï¼Ÿåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¦è®¿é—®çš„é¡µé¢ä¸åœ¨å†…å­˜ä¸­ï¼Œå°±å‘ç”Ÿç¼ºé¡µä¸­æ–­ä»è€Œå°†è¯¥é¡µè°ƒå…¥å†…å­˜ä¸­ã€‚æ­¤æ—¶å¦‚æœå†…å­˜å·²æ— ç©ºé—²ç©ºé—´ï¼Œç³»ç»Ÿå¿…é¡»ä»å†…å­˜ä¸­è°ƒå‡ºä¸€ä¸ªé¡µé¢åˆ°ç£ç›˜ä¸­æ¥è…¾å‡ºç©ºé—´ã€‚é¡µé¢ç½®æ¢ç®—æ³•çš„ä¸»è¦ç›®æ ‡æ˜¯ä½¿é¡µé¢ç½®æ¢é¢‘ç‡æœ€ä½ï¼ˆä¹Ÿå¯ä»¥è¯´ç¼ºé¡µç‡æœ€ä½ï¼‰ã€‚ æœ€ä½³é¡µé¢ç½®æ¢ç®—æ³•OPTï¼ˆOptimal replacement algorithmï¼‰ï¼šç½®æ¢ä»¥åä¸éœ€è¦æˆ–è€…æœ€è¿œçš„å°†æ¥æ‰éœ€è¦çš„é¡µé¢ï¼Œæ˜¯ä¸€ç§ç†è®ºä¸Šçš„ç®—æ³•ï¼Œæ˜¯æœ€ä¼˜ç­–ç•¥ï¼› å…ˆè¿›å…ˆå‡ºFIFOï¼šç½®æ¢åœ¨å†…å­˜ä¸­é©»ç•™æ—¶é—´æœ€é•¿çš„é¡µé¢ã€‚ç¼ºç‚¹ï¼šæœ‰å¯èƒ½å°†é‚£äº›ç»å¸¸è¢«è®¿é—®çš„é¡µé¢ä¹Ÿè¢«æ¢å‡ºï¼Œä»è€Œä½¿ç¼ºé¡µç‡å‡é«˜ï¼› ç¬¬äºŒæ¬¡æœºä¼šç®—æ³•SCRï¼šæŒ‰FIFOé€‰æ‹©æŸä¸€é¡µé¢ï¼Œè‹¥å…¶è®¿é—®ä½ä¸º1ï¼Œç»™ç¬¬äºŒæ¬¡æœºä¼šï¼Œå¹¶å°†è®¿é—®ä½ç½®0ï¼› æ—¶é’Ÿç®—æ³• Clockï¼šSCRä¸­éœ€è¦å°†é¡µé¢åœ¨é“¾è¡¨ä¸­ç§»åŠ¨ï¼ˆç¬¬äºŒæ¬¡æœºä¼šçš„æ—¶å€™è¦å°†è¿™ä¸ªé¡µé¢ä»é“¾è¡¨å¤´ç§»åˆ°é“¾è¡¨å°¾ï¼‰ï¼Œæ—¶é’Ÿç®—æ³•ä½¿ç”¨ç¯å½¢é“¾è¡¨ï¼Œå†ä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æœ€è€çš„é¡µé¢ï¼Œé¿å…äº†ç§»åŠ¨é¡µé¢çš„å¼€é”€ï¼› æœ€è¿‘æœªä½¿ç”¨ç®—æ³•NRUï¼ˆNot Recently Usedï¼‰ï¼šæ£€æŸ¥è®¿é—®ä½Rã€ä¿®æ”¹ä½Mï¼Œä¼˜å…ˆç½®æ¢R=M=0ï¼Œå…¶æ¬¡æ˜¯ï¼ˆR=0, M=1ï¼‰ï¼› æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•LRUï¼ˆLeast Recently Usedï¼‰ï¼šç½®æ¢å‡ºæœªä½¿ç”¨æ—¶é—´æœ€é•¿çš„ä¸€é¡µï¼›å®ç°æ–¹å¼ï¼šç»´æŠ¤æ—¶é—´æˆ³ï¼Œæˆ–è€…ç»´æŠ¤ä¸€ä¸ªæ‰€æœ‰é¡µé¢çš„é“¾è¡¨ã€‚å½“ä¸€ä¸ªé¡µé¢è¢«è®¿é—®æ—¶ï¼Œå°†è¿™ä¸ªé¡µé¢ç§»åˆ°é“¾è¡¨è¡¨å¤´ã€‚è¿™æ ·å°±èƒ½ä¿è¯é“¾è¡¨è¡¨å°¾çš„é¡µé¢æ˜¯æœ€è¿‘æœ€ä¹…æœªè®¿é—®çš„ã€‚ æœ€ä¸ç»å¸¸ä½¿ç”¨ç®—æ³•NFUï¼šç½®æ¢å‡ºè®¿é—®æ¬¡æ•°æœ€å°‘çš„é¡µé¢ å±€éƒ¨æ€§åŸç† æ—¶é—´ä¸Šï¼šæœ€è¿‘è¢«è®¿é—®çš„é¡µåœ¨ä¸ä¹…çš„å°†æ¥è¿˜ä¼šè¢«è®¿é—®ï¼› ç©ºé—´ä¸Šï¼šå†…å­˜ä¸­è¢«è®¿é—®çš„é¡µå‘¨å›´çš„é¡µä¹Ÿå¾ˆå¯èƒ½è¢«è®¿é—®ã€‚ ä»€ä¹ˆæ˜¯é¢ ç°¸ç°è±¡ é¢ ç°¸æœ¬è´¨ä¸Šæ˜¯æŒ‡é¢‘ç¹çš„é¡µè°ƒåº¦è¡Œä¸ºã€‚è¿›ç¨‹å‘ç”Ÿç¼ºé¡µä¸­æ–­æ—¶å¿…é¡»ç½®æ¢æŸä¸€é¡µã€‚ç„¶è€Œï¼Œå…¶ä»–æ‰€æœ‰çš„é¡µéƒ½åœ¨ä½¿ç”¨ï¼Œå®ƒç½®æ¢ä¸€ä¸ªé¡µï¼Œä½†åˆç«‹åˆ»å†æ¬¡éœ€è¦è¿™ä¸ªé¡µã€‚å› æ­¤ä¼šä¸æ–­äº§ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„æ•ˆç‡æ€¥å‰§ä¸‹é™ï¼Œè¿™ç§ç°è±¡ç§°ä¸ºé¢ ç°¸ã€‚å†…å­˜é¢ ç°¸çš„è§£å†³ç­–ç•¥åŒ…æ‹¬ï¼š ä¿®æ”¹é¡µé¢ç½®æ¢ç®—æ³•ï¼› é™ä½åŒæ—¶è¿è¡Œçš„ç¨‹åºçš„æ•°é‡ï¼› ç»ˆæ­¢è¯¥è¿›ç¨‹æˆ–å¢åŠ ç‰©ç†å†…å­˜å®¹é‡ã€‚ ç¼“å†²åŒºæº¢å‡ºé—®é¢˜ ä»€ä¹ˆæ˜¯ç¼“å†²åŒºæº¢å‡ºï¼Ÿ C è¯­è¨€ä½¿ç”¨è¿è¡Œæ—¶æ ˆæ¥å­˜å‚¨è¿‡ç¨‹ä¿¡æ¯ã€‚æ¯ä¸ªå‡½æ•°çš„ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªæ ˆå¸§ä¸­ï¼ŒåŒ…æ‹¬å¯„å­˜å™¨ã€å±€éƒ¨å˜é‡ã€å‚æ•°ã€è¿”å›åœ°å€ç­‰ã€‚C å¯¹äºæ•°ç»„å¼•ç”¨ä¸è¿›è¡Œä»»ä½•è¾¹ç•Œæ£€æŸ¥ï¼Œå› æ­¤**å¯¹è¶Šç•Œçš„æ•°ç»„å…ƒç´ çš„å†™æ“ä½œä¼šç ´åå­˜å‚¨åœ¨æ ˆä¸­çš„çŠ¶æ€ä¿¡æ¯**ï¼Œè¿™ç§ç°è±¡ç§°ä¸ºç¼“å†²åŒºæº¢å‡ºã€‚ç¼“å†²åŒºæº¢å‡ºä¼šç ´åç¨‹åºè¿è¡Œï¼Œä¹Ÿå¯ä»¥è¢«ç”¨æ¥è¿›è¡Œæ”»å‡»è®¡ç®—æœºï¼Œå¦‚ä½¿ç”¨ä¸€ä¸ªæŒ‡å‘æ”»å‡»ä»£ç çš„æŒ‡é’ˆè¦†ç›–è¿”å›åœ°å€ã€‚ ç¼“å†²åŒºæº¢å‡ºçš„é˜²èŒƒæ–¹å¼ é˜²èŒƒç¼“å†²åŒºæº¢å‡ºæ”»å‡»çš„æœºåˆ¶æœ‰ä¸‰ç§ï¼šéšæœºåŒ–ã€æ ˆä¿æŠ¤å’Œé™åˆ¶å¯æ‰§è¡Œä»£ç åŒºåŸŸã€‚ éšæœºåŒ–ï¼šåŒ…æ‹¬æ ˆéšæœºåŒ–ï¼ˆç¨‹åºå¼€å§‹æ—¶åœ¨æ ˆä¸Šåˆ†é…ä¸€æ®µéšæœºå¤§å°çš„ç©ºé—´ï¼‰å’Œåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆAddress-Space Layout Randomizationï¼ŒASLRï¼Œå³æ¯æ¬¡è¿è¡Œæ—¶ç¨‹åºçš„ä¸åŒéƒ¨åˆ†ï¼ŒåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€æ ˆã€å †ç­‰éƒ½ä¼šè¢«åŠ è½½åˆ°å†…å­˜ç©ºé—´çš„ä¸åŒåŒºåŸŸï¼‰ï¼Œä½†åªèƒ½å¢åŠ æ”»å‡»ä¸€ä¸ªç³»ç»Ÿçš„éš¾åº¦ï¼Œä¸èƒ½å®Œå…¨ä¿è¯å®‰å…¨ã€‚ æ ˆä¿æŠ¤ï¼šåœ¨æ¯ä¸ªå‡½æ•°çš„æ ˆå¸§çš„å±€éƒ¨å˜é‡å’Œæ ˆçŠ¶æ€ä¹‹é—´å­˜å‚¨ä¸€ä¸ªéšæœºäº§ç”Ÿçš„ç‰¹æ®Šçš„å€¼ï¼Œç§°ä¸ºé‡‘ä¸é›€å€¼ï¼ˆcanaryï¼‰ã€‚åœ¨æ¢å¤å¯„å­˜å™¨çŠ¶æ€å’Œå‡½æ•°è¿”å›ä¹‹å‰ï¼Œç¨‹åºæ£€æµ‹è¿™ä¸ªé‡‘ä¸é›€å€¼æ˜¯å¦è¢«æ”¹å˜äº†ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆç¨‹åºå¼‚å¸¸ç»ˆæ­¢ã€‚ é™åˆ¶å¯æ‰§è¡Œä»£ç åŒºåŸŸï¼šå†…å­˜é¡µçš„è®¿é—®å½¢å¼æœ‰ä¸‰ç§ï¼šå¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼Œåªæœ‰ç¼–è¯‘å™¨äº§ç”Ÿçš„é‚£éƒ¨åˆ†ä»£ç æ‰€å¤„çš„å†…å­˜æ‰æ˜¯å¯æ‰§è¡Œçš„ï¼Œå…¶ä»–é¡µé™åˆ¶ä¸ºåªå…è®¸è¯»å’Œå†™ã€‚ æ›´è¯¦ç»†çš„å¯ä»¥å‚è€ƒï¼šhttps://imageslr.github.io/2020/07/08/tech-interview.html#stackoverflow ç£ç›˜è°ƒåº¦è¿‡ç¨‹ï¼šç£å¤´ï¼ˆæ‰¾åˆ°å¯¹åº”çš„ç›˜é¢ï¼‰ï¼›ç£é“ï¼ˆä¸€ä¸ªç›˜é¢ä¸Šçš„åŒå¿ƒåœ†ç¯ï¼Œå¯»é“æ—¶é—´ï¼‰ï¼›æ‰‡åŒºï¼ˆæ—‹è½¬æ—¶é—´ï¼‰ã€‚ä¸ºå‡å°å¯»é“æ—¶é—´çš„è°ƒåº¦ç®—æ³•ï¼š å…ˆæ¥å…ˆæœåŠ¡ æœ€çŸ­å¯»é“æ—¶é—´ä¼˜å…ˆ ç”µæ¢¯ç®—æ³•ï¼šç”µæ¢¯æ€»æ˜¯ä¿æŒä¸€ä¸ªæ–¹å‘è¿è¡Œï¼Œç›´åˆ°è¯¥æ–¹å‘æ²¡æœ‰è¯·æ±‚ä¸ºæ­¢ï¼Œç„¶åæ”¹å˜è¿è¡Œæ–¹å‘ã€‚ å‚è€ƒ è¿›ç¨‹é—´é€šä¿¡IPC â€“ ç®€ä¹¦ é¢è¯•/ç¬”è¯•ç¬¬äºŒå¼¹ â€”â€” æ“ä½œç³»ç»Ÿé¢è¯•é—®é¢˜é›†é”¦ - CSDNåšå®¢ çº¿ç¨‹åŒæ­¥ä¸å¹¶å‘ - - SegmentFault å½»åº•ææ‡‚epollé«˜æ•ˆè¿è¡Œçš„åŸç† ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢ å¾…å®Œæˆ IPC è¿›ç¨‹åŒæ­¥é—®é¢˜ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜â€¦ é“¶è¡Œå®¶ç®—æ³• æ–‡ä»¶ä¸æ–‡ä»¶ç³»ç»Ÿã€æ–‡ä»¶ç®¡ç†ï¼Ÿ","link":"/2021/11/22/OperatingSystem/"},{"title":"PackageManager","text":"PackageMangerçš„æ ¸å¿ƒä½œç”¨ï¼š åœ¨ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡**PackageManagerService(PKMS)*å¯¹ç‰¹å®šç³»ç»Ÿæ–‡ä»¶(å¦‚package.list, package.xml)è¿›è¡Œæ‰«æè§£æåï¼Œå°†æ‰€æœ‰appçš„ä¿¡æ¯æ•´åˆå­˜å‚¨ï¼Œé€šè¿‡IPackageManger*å¯¹å¤–æš´éœ² é€šè¿‡PackageInstallerServiceæä¾›Apk/Apexçš„å®‰è£…ã€æ›´æ–°ã€å¸è½½ç­‰æ“ä½œ(IPackageInstaller) åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­çš„æƒé™æ£€æŸ¥ å¯åŠ¨æ—¶PKMSè§£æè¿‡ç¨‹ï¼š PackageInstallerServiceçš„å®‰è£…è¿‡ç¨‹ï¼š","link":"/2022/02/16/PackageManager/"},{"title":"æ’ä»¶åŒ–&#x2F;çƒ­ä¿®å¤","text":"æ’ä»¶åŒ–å’Œçƒ­ä¿®å¤ä¸æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œè™½ç„¶ç«™åœ¨æŠ€æœ¯å®ç°çš„è§’åº¦æ¥è¯´ï¼Œä»–ä»¬éƒ½æ˜¯ä»ç³»ç»ŸåŠ è½½å™¨çš„è§’åº¦å‡ºå‘ï¼Œæ— è®ºæ˜¯é‡‡ç”¨hookæ–¹å¼ï¼Œäº¦æˆ–æ˜¯ä»£ç†æ–¹å¼æˆ–è€…æ˜¯å…¶ä»–åº•å±‚å®ç°ï¼Œéƒ½æ˜¯é€šè¿‡â€œæ¬ºéª—â€Android ç³»ç»Ÿçš„æ–¹å¼æ¥è®©å®¿ä¸»æ­£å¸¸çš„åŠ è½½å’Œè¿è¡Œæ’ä»¶ï¼ˆè¡¥ä¸ï¼‰ä¸­çš„å†…å®¹ï¼›ä½†æ˜¯äºŒè€…çš„å‡ºå‘ç‚¹æ˜¯ä¸åŒçš„ã€‚æ’ä»¶åŒ–é¡¾åæ€ä¹‰ï¼Œæ›´å¤šæ˜¯æƒ³æŠŠéœ€è¦å®ç°çš„æ¨¡å—æˆ–åŠŸèƒ½å½“åšä¸€ä¸ªç‹¬ç«‹çš„æå–å‡ºæ¥ï¼Œå‡å°‘å®¿ä¸»çš„è§„æ¨¡ï¼Œå½“éœ€è¦ä½¿ç”¨åˆ°ç›¸åº”çš„åŠŸèƒ½æ—¶å†å»åŠ è½½ç›¸åº”çš„æ¨¡å—ã€‚çƒ­ä¿®å¤åˆ™å¾€å¾€æ˜¯ä»ä¿®å¤bugçš„è§’åº¦å‡ºå‘ï¼Œå¼ºè°ƒçš„æ˜¯åœ¨ä¸éœ€è¦äºŒæ¬¡å®‰è£…åº”ç”¨çš„å‰æä¸‹ä¿®å¤å·²çŸ¥çš„bugã€‚ PathClassLoaderï¼šåªèƒ½åŠ è½½å·²ç»å®‰è£…åˆ°Androidç³»ç»Ÿä¸­çš„apkæ–‡ä»¶ï¼ˆ/data/appç›®å½•ï¼‰ï¼Œæ˜¯Androidé»˜è®¤ä½¿ç”¨çš„ç±»åŠ è½½å™¨ã€‚ DexClassLoaderï¼šå¯ä»¥åŠ è½½ä»»æ„ç›®å½•ä¸‹çš„dex/jar/apk/zipæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹æåˆ°çš„è¡¥ä¸ã€‚ BaseDexClassLoader: æ˜¯ PathClassLoader å’Œ DexClassLoader çš„çˆ¶ç±»ï¼Œå…¶å†…æœ‰ä¸€ä¸ª DexPathList å±æ€§ï¼Œå®ç°äº† findClass æ–¹æ³•é€»è¾‘ï¼ŒPathClassLoader å’Œ DexClassLoader éƒ½åªæ˜¯åœ¨æ„é€ å‡½æ•°ä¸Šå¯¹å…¶åšäº†ç®€å•å°è£…è€Œå·²ã€‚ ç±»åŠ è½½å™¨ æ¯ä¸ªç±»ç¼–è¯‘åäº§ç”Ÿä¸€ä¸ªClasså¯¹è±¡ï¼Œå­˜å‚¨åœ¨.classæ–‡ä»¶ä¸­ï¼ŒJVMä½¿ç”¨ç±»åŠ è½½å™¨ï¼ˆClass Loaderï¼‰æ¥åŠ è½½ç±»çš„å­—èŠ‚ç æ–‡ä»¶ï¼ˆ.classï¼‰ï¼Œç±»åŠ è½½å™¨å®è´¨ä¸Šæ˜¯ä¸€æ¡ç±»åŠ è½½å™¨é“¾ï¼Œä¸€èˆ¬çš„ï¼Œæˆ‘ä»¬åªä¼šç”¨åˆ°ä¸€ä¸ªåŸç”Ÿçš„ç±»åŠ è½½å™¨ï¼Œå®ƒåªåŠ è½½Java APIç­‰å¯ä¿¡ç±»ï¼Œé€šå¸¸åªæ˜¯åœ¨æœ¬åœ°ç£ç›˜ä¸­åŠ è½½ï¼Œè¿™äº›ç±»ä¸€èˆ¬å°±å¤Ÿæˆ‘ä»¬ä½¿ç”¨äº†ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦ä»è¿œç¨‹ç½‘ç»œæˆ–æ•°æ®åº“ä¸­ä¸‹è½½.classå­—èŠ‚ç æ–‡ä»¶ï¼Œé‚£å°±éœ€è¦æˆ‘ä»¬æ¥æŒ‚è½½é¢å¤–çš„ç±»åŠ è½½å™¨ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œç±»åŠ è½½å™¨æ˜¯æŒ‰ç…§æ ‘å½¢çš„å±‚æ¬¡ç»“æ„ç»„ç»‡çš„ï¼Œæ¯ä¸ªåŠ è½½å™¨éƒ½æœ‰ä¸€ä¸ªçˆ¶ç±»åŠ è½½å™¨ã€‚å¦å¤–ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½æ”¯æŒä»£ç†æ¨¡å¼ï¼Œå³å¯ä»¥è‡ªå·±å®ŒæˆJavaç±»çš„åŠ è½½å·¥ä½œï¼Œä¹Ÿå¯ä»¥ä»£ç†ç»™å…¶å®ƒç±»åŠ è½½å™¨ã€‚ ç±»åŠ è½½å™¨çš„åŠ è½½é¡ºåºæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯çˆ¶ç±»ä¼˜å…ˆç­–ç•¥ï¼Œä¸€ç§æ˜¯æ˜¯è‡ªå·±ä¼˜å…ˆç­–ç•¥ï¼Œçˆ¶ç±»ä¼˜å…ˆç­–ç•¥æ˜¯æ¯”è¾ƒä¸€èˆ¬çš„æƒ…å†µï¼ˆå¦‚JDKé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ–¹å¼ï¼‰ï¼Œåœ¨è¿™ç§ç­–ç•¥ä¸‹ï¼Œç±»åœ¨åŠ è½½æŸä¸ªJavaç±»ä¹‹å‰ï¼Œä¼šå°è¯•ä»£ç†ç»™å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåªæœ‰å½“çˆ¶ç±»åŠ è½½å™¨æ‰¾ä¸åˆ°æ—¶ï¼Œæ‰å°è¯•è‡ªå·±å»åŠ è½½ã€‚è‡ªå·±ä¼˜å…ˆçš„ç­–ç•¥ä¸çˆ¶ç±»ä¼˜å…ˆç›¸åï¼Œå®ƒä¼šé¦–å…ˆå°è¯•å­ç»æµåŠ è½½ï¼Œæ‰¾ä¸åˆ°çš„æ—¶å€™æ‰è¦çˆ¶ç±»åŠ è½½å™¨å»åŠ è½½ï¼Œè¿™ç§åœ¨webå®¹å™¨ï¼ˆå¦‚tomcatï¼‰ä¸­æ¯”è¾ƒå¸¸è§ã€‚ æ’ä»¶åŒ–ï¼š æ’ä»¶åŒ–ï¼šæ’ä»¶åŒ–æ˜¯ä½“ç°åœ¨åŠŸèƒ½æ‹†åˆ†æ–¹é¢çš„ï¼Œå®ƒå°†æŸä¸ªåŠŸèƒ½ç‹¬ç«‹æå–å‡ºæ¥ï¼Œç‹¬ç«‹å¼€å‘ï¼Œç‹¬ç«‹æµ‹è¯•ï¼Œå†æ’å…¥åˆ°ä¸»åº”ç”¨ä¸­ã€‚ä¾æ¬¡æ¥è¾ƒå°‘ä¸»åº”ç”¨çš„è§„æ¨¡ã€‚ æ—§æ’ä»¶åŒ–æ¡†æ¶æ–¹æ¡ˆæ ¸å¿ƒè§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š ä¸€ã€æ’ä»¶ç±»classçš„åŠ è½½é—®é¢˜è¿™ä¸ªé—®é¢˜å„å®¶çš„è§£å†³æ–¹æ¡ˆéƒ½æ˜¯ç»Ÿä¸€çš„ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡dexclassloaderï¼ŒåŠ è½½æ’ä»¶apkã€‚ äºŒã€activityä¸ºä¸»çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜è¿™ä¸ªé—®é¢˜åˆ†ä¸ºä¸¤ç§è§£å†³æ–¹å¼ï¼š 1ã€é€šè¿‡å£³Activityé€šè¿‡åœ¨å®¿ä¸»å·¥ç¨‹é¢„æ³¨å†Œ å£³Activityï¼Œé€šè¿‡å£³Activity æŒæœ‰å¹¶è½¬è°ƒ æ’ä»¶Activityçš„æ¯ä¸ªç”Ÿå‘½å‘¨æœŸ a. æ’ä»¶Activityç»§æ‰¿Activityç±»ï¼ˆéœ€è¦åå°„ï¼‰ç„¶åå£³Activityé€šè¿‡åå°„è½¬è°ƒå„ä¸ªç”Ÿå‘½å‘¨æœŸç”šè‡³è¿˜å¯èƒ½éœ€è¦é¿å…å®ƒçš„superæ–¹æ³•è¢«è°ƒç”¨ã€‚ è¿™æ ·åšè¦è§£å†³ä¸€ä¸ªé¢å¤–çš„é—®é¢˜ã€‚ Activityè¢«ç³»ç»Ÿæ„é€ å‡ºå®ä¾‹ä¹‹åï¼Œå¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨onCreateæ–¹æ³•çš„ã€‚é¦–å…ˆä¼šè°ƒç”¨å®ƒçš„attachæ–¹æ³•ã€‚attachæ–¹æ³•å®é™…ä¸Šå°±æ˜¯Activityçš„åˆå§‹åŒ–æ–¹æ³•ï¼Œç³»ç»Ÿé€šè¿‡è¿™ä¸ªæ–¹æ³•å‘Activityæ³¨å…¥ä¸€äº›ç§æœ‰å˜é‡ï¼Œæ¯”å¦‚Windowã€ActivityThreadç­‰ç­‰ã€‚æ’ä»¶Activityç”±äºæ˜¯æˆ‘ä»¬å£³å­Activityè‡ªå·±newå‡ºæ¥çš„ï¼Œæ‰€ä»¥ç³»ç»Ÿä¸ä¼šè°ƒç”¨æ’ä»¶Activityçš„attachæ–¹æ³•åˆå§‹åŒ–å®ƒã€‚Activityå¦‚æœæ²¡æœ‰åˆå§‹åŒ–å°±è¢«è°ƒç”¨äº†onCreateä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬å‰é¢è¯´äº†æˆ‘ä»¬çš„ä¸€ä¸ªå‰ææ˜¯æ’ä»¶Activityè¦æ±‚ä¹Ÿè¦èƒ½æ­£å¸¸ç¼–è¯‘å®‰è£…è¿è¡Œï¼Œæ‰€ä»¥æ’ä»¶Activityçš„onCreateæ–¹æ³•é‡Œä¸€å®šå†™äº†super.onCreate()è°ƒç”¨ã€‚æˆ‘ä»¬è¿˜è¦æ±‚å¯¹æ’ä»¶ä»£ç æ— ä¾µå…¥æ€§ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½åœ¨è¿™ä¸ªè°ƒç”¨å¤–é¢åŒ…ä¸€å±‚â€œif (ä¸æ˜¯æ’ä»¶æ¨¡å¼)â€ã€‚é‚£ä¹ˆåœ¨æ’ä»¶ç¯å¢ƒä¸‹ï¼Œè¿™ä¸ªsuper.onCreate()å°±ä¸€å®šä¼šæ‰§è¡Œã€‚ActivityåŸºç±»çš„onCreateæ–¹æ³•å°±ä¼šä½¿ç”¨é‚£äº›åº”è¯¥åˆå§‹åŒ–è¿‡çš„ç§æœ‰å˜é‡ï¼Œä½†æ˜¯ç°åœ¨å®ƒä»¬æ²¡æœ‰åˆå§‹åŒ–ã€‚æ‰€ä»¥è¿™ä¸€ç±»æ’ä»¶æ¡†æ¶æ–¹æ¡ˆå°±è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ‰€ä»¥è¦ä¹ˆæ˜¯åå°„è°ƒç”¨attachæ–¹æ³•ï¼Œä¼ å…¥ä»å£³å­Activityæ‹¿åˆ°çš„ç§æœ‰å˜é‡ï¼Œæ¯”å¦‚è¯´åå°„å‡ºå£³å­Activityçš„ActivityThreadå¯¹è±¡ï¼Œä¼ ç»™æ’ä»¶Activityçš„attachæ–¹æ³•ã€‚è¦ä¹ˆå°±å¹²è„†ç›´æ¥ç”¨åå°„æšä¸¾è¯»å†™å£³å­Activityå’Œæ’ä»¶Activityçš„ç§æœ‰å˜é‡ï¼ŒæŠŠå®ƒä»¬å†™æˆä¸€æ ·çš„å®Œæˆè¿™ä¸ªåˆå§‹åŒ–ã€‚æ‰€ä»¥è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ—§æ¡†æ¶éœ€è¦ä½¿ç”¨åå°„å’Œç§æœ‰APIã€‚ b. æ’ä»¶Activityç»§æ‰¿ æ™®é€šæ’ä»¶åŸºç±» ï¼ˆæ— éœ€åå°„ï¼‰Shadowä½¿ç”¨AOPçš„æ–¹å¼æ›¿æ¢æ‰€æœ‰æ’ä»¶ä¸­çš„activityç±»ä¸ºæ™®é€šæ’ä»¶åŸºç±»ï¼Œä½†æ’ä»¶åŸºç±»ç”³æ˜å„ä¸ªactivityçš„å®ç° 2ã€hook frameworkï¼ŒåŒ…æ‹¬Activityå¯åŠ¨æµç¨‹a .æ¯”å¦‚virtualApkæ˜¯æ›¿æ¢ç³»ç»Ÿçš„instrumentationï¼ˆæ›¿æ¢æˆè‡ªå®šä¹‰çš„å­ç±»ï¼‰ï¼Œåœ¨èµ°åˆ°AMSå‰çš„execStartActivityä¸­æŠŠä¼ å…¥çš„intentçš„componentæ”¹æˆå£³Activityï¼Œç„¶ååœ¨AMSå›è°ƒå›æ¥åçš„performLaunchActivityä¸­ï¼Œå†æŠŠintentçš„conponentæ”¹å›å»ã€‚è¾¾åˆ°æ¬ºéª—ç³»ç»Ÿçš„ç›®çš„ã€‚ b.æ¯”å¦‚Repluginæ¯”å¦‚RePluginä¸ºé¦–çš„hook ç³»ç»ŸclassLoaderæ”¹æˆè‡ªå®šä¹‰ClassLoaderï¼Œç„¶åhookäº† â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” æ—§æ¡†æ¶å°±æ˜¯ å£³Activity è½¬è°ƒ æ’ä»¶Activityçš„æ–¹æ¡ˆï¼Œå¸‚é¢ä¸Šè¿˜æœ‰å¾ˆå¤šæ’ä»¶æ¡†æ¶ä¹Ÿæ˜¯è¿™ç§æ–¹æ¡ˆã€‚å¤§å®¶åªæ˜¯åœ¨å®ç°è½¬è°ƒçš„æ‰‹æ®µä¸Šä¸ä¸€æ ·ã€‚ Android9.0ä¹‹åé™åˆ¶äº†åå°„çš„ä½¿ç”¨ï¼Œé»‘åå•ç›´æ¥ç¦æ­¢äº†ï¼Œè…¾è®¯å¼€æºçš„Shadowè§£å†³Activityç­‰ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•è§£æ - æ˜é‡‘ (juejin.cn) shadowæ¡†æ¶åŸºäº ç¬¬ä¸€ç§å£³ä»£ç†Activityçš„æ–¹å¼ï¼Œä½†æ˜¯ç¬¬ä¸€ç§ä»£ç†Activityçš„æ–¹å¼ä¸ºäº†å®ç°æ’ä»¶ä¹Ÿèƒ½ç‹¬ç«‹è¿è¡Œçš„ç‰¹æ€§ï¼Œéœ€è¦æ’ä»¶Activityç»§æ‰¿Activityï¼Œshadowå…¶å®å°±æ˜¯æŠŠ æŠŠä¸€ä¸ªæ’ä»¶Activityå¥—åœ¨ä¸€ä¸ªå®¿ä¸»Activityä¹‹ä¸­ï¼Œç„¶åæƒ³åŠæ³•å®ç°ä¸€ä¸ªè½¬è°ƒå…³ç³»ã€‚å¦‚æœæ’ä»¶Activityæ˜¯ä¸€ä¸ªçœŸçš„Activityï¼Œé‚£è¿™ä¸ªæ’ä»¶å°±å¯ä»¥æ­£å¸¸ç¼–è¯‘å®‰è£…è¿è¡Œï¼Œå¯¹å¼€å‘æ’ä»¶æˆ–è€…ç›´æ¥ä¸Šæ¶æ’ä»¶Appéå¸¸æœ‰åˆ©ã€‚ä½†æ˜¯ç”±äºå®ƒæ˜¯ä¸ªç³»ç»Ÿçš„Activityå­ç±»ï¼Œå®ƒå°±æœ‰å¾ˆå¤šæ–¹æ³•ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œç”šè‡³è¿˜å¯èƒ½éœ€è¦é¿å…å®ƒçš„superæ–¹æ³•è¢«è°ƒç”¨ã€‚å¦‚æœæ’ä»¶Activityä¸æ˜¯ä¸€ä¸ªçœŸçš„Activityï¼Œåªæ˜¯ä¸€ä¸ªè·ŸActivityæœ‰å·®ä¸å¤šæ–¹æ³•çš„æ™®é€šç±»ï¼Œè¿™ä»¶äº‹å°±ç®€å•å¤šäº†ï¼Œåªéœ€è¦è®©å£³å­ActivityæŒæœ‰å®ƒï¼Œè½¬è°ƒå®ƒå°±è¡Œäº†ã€‚ä½†è¿™ç§æ’ä»¶çš„ä»£ç æ­£å¸¸ç¼–è¯‘æˆç‹¬ç«‹Appå®‰è£…è¿è¡Œä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œä»£ç ä¸­å¯èƒ½ä¼šå‡ºç°å¾ˆå¤šæ’ä»¶ç›¸å…³çš„if-elseï¼Œä¹Ÿä¸å¥½ã€‚ çƒ­ä¿®å¤ çƒ­ä¿®å¤ï¼šçƒ­ä¿®å¤æ˜¯ä½“ç°åœ¨bugä¿®å¤æ–¹é¢çš„ï¼Œå®ƒå®ç°çš„æ˜¯ä¸éœ€è¦é‡æ–°å‘ç‰ˆå’Œé‡æ–°å®‰è£…ï¼Œå°±å¯ä»¥å»ä¿®å¤å·²çŸ¥çš„bugã€‚ Tinkerå®ç°åŸç†ç®€ä»‹ï¼š åœ¨ DexPathList.findClass() è¿‡ç¨‹ï¼Œä¸€ä¸ªClassloaderå¯ä»¥åŒ…å«å¤šä¸ªdexæ–‡ä»¶ï¼Œæ¯ä¸ªdexæ–‡ä»¶è¢«å°è£…åˆ°ä¸€ä¸ªElementå¯¹è±¡ï¼Œè¿™äº›Elementå¯¹è±¡æ’åˆ—æˆæœ‰åºçš„æ•°ç»„dexElementsã€‚å½“æŸ¥æ‰¾æŸä¸ªç±»æ—¶ï¼Œä¼šéå†æ‰€æœ‰çš„dexæ–‡ä»¶ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ç›´æ¥è¿”å›ï¼Œä¸å†ç»§ç»­éå†dexElementsã€‚ä¹Ÿå°±æ˜¯è¯´å½“ä¸¤ä¸ªç±»åœ¨ä¸åŒçš„dexä¸­å‡ºç°ï¼Œä¼šä¼˜å…ˆå¤„ç†æ’åœ¨å‰é¢çš„dexæ–‡ä»¶ï¼Œè¿™ä¾¿æ˜¯çƒ­ä¿®å¤çš„æ ¸å¿ƒç²¾é«“ï¼Œå°†éœ€è¦ä¿®å¤çš„ç±»æ‰€æ‰“åŒ…çš„dexæ–‡ä»¶æ’å…¥åˆ°dexElementså‰é¢ã€‚ åˆ©ç”¨PathClassLoaderå’ŒDexClassLoaderå»åŠ è½½ä¸bugç±»åŒåçš„ç±»ï¼Œæ›¿æ¢æ‰bugç±»ï¼Œè¿›è€Œè¾¾åˆ°ä¿®å¤bugçš„ç›®çš„ï¼ŒåŸç†æ˜¯åœ¨appæ‰“åŒ…çš„æ—¶å€™é˜»æ­¢ç±»æ‰“ä¸ŠCLASS_ISPREVERIFIEDæ ‡å¿—ï¼Œç„¶ååœ¨çƒ­ä¿®å¤çš„æ—¶å€™åŠ¨æ€æ”¹å˜BaseDexClassLoaderå¯¹è±¡é—´æ¥å¼•ç”¨çš„dexElementsï¼Œæ›¿æ¢æ‰æ—§çš„ç±»","link":"/2021/04/10/Pluggable-Hotfix/"},{"title":"serializable","text":"","link":"/2021/04/01/Serializable/"},{"title":"retrofit","text":"åŸç†-åŠ¨æ€ä»£ç†*Retrofité€šè¿‡ åå°„æ„å»ºä¸€ä¸ª æ¥å£çš„ å®ç°ç±»ï¼ˆåŠ¨æ€ä»£ç†æœ¬è´¨å°±æ˜¯åå°„ï¼‰ï¼Œå…¶ä¸­æ¯ä¸ªé‡å†™æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œéƒ½ä¼šå›è°ƒåˆ°InvocationHandler.invokeä¸­ï¼Œinvokeå›è°ƒæ—¶ï¼ˆåªè¦æ˜¯ä¸æ˜¯objectç±»ä¸­çš„æ–¹æ³•ï¼‰éƒ½ä¼šé€šè¿‡ è·å–åˆ°çš„æ–¹æ³•çš„æ³¨è§£ã€æ–¹æ³•çš„åç§°ã€æ–¹æ³•çš„è¿”å›å€¼ã€æ–¹æ³•å‚æ•°çš„æ³¨è§£ã€æ–¹æ³•å‚æ•°ç±»å‹ç­‰ç­‰æ‰€éœ€ä¿¡æ¯ï¼Œ è§£ææˆä¸€ä¸ªServiceMethodå¯¹è±¡(æ”¾å…¥ç¼“å­˜æ± )ï¼ŒServiceMethodæ ¹æ®è·å–åˆ°çš„æ–¹æ³•ä¿¡æ¯ï¼Œæ„å»ºOkHttpè¯·æ±‚ï¼Œå¹¶å°†ç»“æœé€šè¿‡converterè½¬æ¢åå›è°ƒç»™æœ€åˆä¼ å…¥çš„Callback* val service = retrofit.create(GitHubService::class.java) 123456789101112131415161718192021222324252627public &lt;T&gt; T create(final Class&lt;T&gt; service) { //æ ¡éªŒæ•°æ®ï¼Œæ˜¯å¦ä¸æ˜¯é»˜è®¤æ–¹æ³•ï¼ˆå…¬å…±éæŠ½è±¡æ–¹æ³•ï¼‰ validateServiceInterface(service); return (T) //ä»£ç†æ¨¡å¼ï¼Œé€šè¿‡åå°„ æ„å»ºä¸€ä¸ª å®ç°äº†æ‰€æœ‰ ä¼ å…¥interfaceçš„æ–¹æ³• çš„ç±»ï¼Œè¯¥ç±»ä¸­æ¯ä¸ªæ–¹æ³•éƒ½è°ƒç”¨äº†ä¼ å…¥InvacationHandlerå¯¹è±¡ä¸­invokeæ–¹æ³•ã€‚ //å³åå°„ æ„å»ºä¸€ä¸ª interfacesçš„å®ç°ç±»ï¼Œè¯¥å®ç°ç±»ä¸­æ¯ä¸ªé‡å†™æ–¹æ³•éƒ½ç”±å°†è‡ªèº«çš„ä¿¡æ¯ä¼ ç»™invokeæ–¹æ³•ï¼Œç”±invokeæ–¹æ³•ä»£ç†æ‰§è¡Œã€‚ Proxy.newProxyInstance( service.getClassLoader(), new Class&lt;?&gt;[] {service}, new InvocationHandler() { private final Platform platform = Platform.get(); private final Object[] emptyArgs = new Object[0]; @Override public @Nullable Object invoke(Object proxy, Method method, @Nullable Object[] args) throws Throwable { // If the method is a method from Object then defer to normal invocation. if (method.getDeclaringClass() == Object.class) { return method.invoke(this, args); } args = args != null ? args : emptyArgs; return platform.isDefaultMethod(method) ? platform.invokeDefaultMethod(method, service, proxy, args) : loadServiceMethod(method).invoke(args); } });} åŠ¨æ€ä»£ç†åŸç†æ ¸å¿ƒ API æ˜¯ Proxy ç±»å’Œ InvocationHandler æ¥å£ã€‚ å®ƒçš„åŸç†æ˜¯åˆ©ç”¨åå°„æœºåˆ¶åœ¨è¿è¡Œæ—¶ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç ã€‚ åŠ¨æ€ä»£ç†çš„åŸç†å°±æ˜¯ä¸€ä¸ªä»£ç†ç±»æ–‡ä»¶çš„åŠ¨æ€åŠ è½½è¿‡ç¨‹ï¼Œç”±äºJVMå¯ä»¥é€šè¿‡.classæ–‡ä»¶çš„äºŒè¿›åˆ¶ä¿¡æ¯åŠ è½½classå¯¹è±¡çš„ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬åœ¨ä»£ç è¿è¡Œæ—¶ï¼Œéµå¾ª.classæ–‡ä»¶çš„æ ¼å¼å’Œç»“æ„ï¼Œç”Ÿæˆç›¸åº”çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œç„¶åå†æŠŠè¿™ä¸ªäºŒè¿›åˆ¶æ•°æ®é€šè¿‡JVMåŠ è½½æˆå¯¹åº”çš„classå¯¹è±¡ï¼Œæœ‰äº†classå¯¹è±¡ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡åå°„åˆ›å»ºå‡ºä»£ç†å¯¹è±¡çš„å®ä¾‹ï¼Œè¿™æ ·å°±å®Œæˆäº†åœ¨ä»£ç è¿è¡Œæ—¶ï¼ŒåŠ¨æ€çš„åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡çš„èƒ½åŠ›ï¼Œè¿™å°±æ˜¯åŠ¨æ€ä»£ç†çš„åŸç†ã€‚ https://juejin.cn/post/6974018412158664734 ä½¿ç”¨ åˆ›å»ºä¸€ä¸ªinterfaceä½œä¸ºWeb Service çš„è¯·æ±‚é›†åˆï¼Œåœ¨é‡Œé¢ç”¨æ³¨è§£ï¼ˆAnnotation)å†™å…¥éœ€è¦é…ç½®çš„è¯·æ±‚æ–¹æ³• 1234public interface GitHubService { @GET(&quot;users/{user}/repos&quot;) Call&lt;List&lt;Repo&gt;&gt; listRepos(@Path(&quot;user&quot;) String user);} åœ¨æ­£å¼ä»£ç é‡Œç”¨ Retrofit åˆ›å»ºå‡ºinterfaceçš„å®ä¾‹ 1234Retrofit retrofit = new Retrofit.Builder() .baseUrl(&quot;https://api.github.com/&quot;) .build();GitHubService service = retrofit.create(GitHubService.class); è°ƒç”¨åˆ›å»ºå‡ºçš„Serviceå®ä¾‹çš„å¯¹åº”æ–¹æ³•ï¼Œåˆ›å»ºå‡ºç›¸åº”çš„å¯ä»¥ç”¨æ¥å‘èµ·ç½‘ç»œè¯·æ±‚çš„call å¯¹è±¡Call&lt;List&lt;Repo&gt;&gt; repos = service.listRepos(&quot;octocat&quot;); ä½¿ç”¨Call.execute()æˆ–è€…call.enqueue()æ¥å‘èµ·è¯·æ±‚repos.enqueue(callback);","link":"/2021/04/08/Retrofit/"},{"title":"ServiceManager","text":"ServiceManagerçš„å¯åŠ¨ServiceManagerè¿›ç¨‹service_manager.cå¹¶æ²¡æœ‰ä½¿ç”¨libbinderæ¡†æ¶ä»£ç ï¼Œè€Œæ˜¯è‡ªè¡Œç¼–å†™äº†binder.cç›´æ¥å’ŒBinderé©±åŠ¨æ¥é€šä¿¡ï¼ŒServiceManageræ˜¯å•çº¿ç¨‹çš„è¿›ç¨‹ï¼Œ ä¸æ–­åœ°å¾ªç¯åœ¨binder_loop()è¿‡ç¨‹æ¥è¯»å–å’Œå¤„ç†äº‹åŠ¡ï¼Œä»è€Œå¯¹å¤–æä¾›æŸ¥è¯¢å’Œæ³¨å†ŒæœåŠ¡çš„åŠŸèƒ½ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ç®€å•è€Œé«˜æ•ˆã€‚ 123456789101112131415161718192021222324// service_manager.cint main(int argc, char **argv) { struct binder_state *bs; char *driver; if (argc &gt; 1) { driver = argv[1]; } else { driver = &quot;/dev/binder&quot;; // é»˜è®¤çš„Binderè®¾å¤‡èŠ‚ç‚¹ } //Step 1: æ‰“å¼€binderé©±åŠ¨ï¼Œç”³è¯·128kå­—èŠ‚å†…å­˜ bs = binder_open(driver, 128*1024); ... //Step 2: æˆä¸ºä¸Šä¸‹æ–‡ç®¡ç†è€… if (binder_become_context_manager(bs)) { return -1; } ... //Step 3: è¿›å…¥æ— é™å¾ªç¯ï¼Œå¤„ç†clientç«¯å‘æ¥çš„è¯·æ±‚ binder_loop(bs, svcmgr_handler); return 0;} å¯åŠ¨è¿‡ç¨‹ä¸»è¦åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š(æ¯ä¸ªé˜¶æ®µå…·ä½“è§5.2.1 å¯åŠ¨ServiceManageræœåŠ¡) é¦–å…ˆï¼Œæ‰“å¼€è®¾å¤‡é©±åŠ¨ï¼šè°ƒç”¨binder_open()æ–¹æ³•æ¥æ‰“å¼€binderé©±åŠ¨ï¼Œé»˜è®¤åœ°é‡‡ç”¨/dev/binderè®¾å¤‡èŠ‚ç‚¹ï¼Œç”³è¯·åœ°å†…å­˜ç©ºé—´å¤§å°ä¸º128KBï¼› å…¶æ¬¡ï¼Œæ³¨å†Œæˆä¸ºå¤§ç®¡å®¶ï¼šè°ƒç”¨binder_become_context_manager()æ–¹æ³•ï¼Œå°†è‡ªå·±æ³¨å†Œæˆä¸ºbinderæœåŠ¡çš„å”¯ä¸€ç®¡å®¶ï¼› é€šè¿‡ioctlç³»ç»Ÿè°ƒç”¨å‘Binderé©±åŠ¨å‘é€å‘½ä»¤BINDER_SET_CONTEXT_MGRï¼Œæˆä¸ºä¸Šä¸‹æ–‡çš„ç®¡ç†è€…ï¼Œç”±äºservicemanagerè¿›ç¨‹å¯åŠ¨éå¸¸æ—©ï¼ˆå…ˆäºZygoteï¼‰ï¼Œå¯ä»¥ç¡®å®šåœ¨Binderæ•´ä½“æœºåˆ¶æ­£å¼æŠ•å…¥äº§çº¿ä¹‹å‰ï¼Œå°±èƒ½å®Œæˆå‘Binderé©±åŠ¨æ³¨å†Œæˆä¸ºå¤§ç®¡å®¶çš„å·¥ä½œã€‚ å…³äºé©±åŠ¨å±‚å¤„ç†BINDER_SET_CONTEXT_MGRå‘½ä»¤çš„ä¸»è¦ä»»åŠ¡ï¼š ä¿è¯æ¯ä¸ªBinderä¸Šä¸‹æ–‡æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªbinderç®¡å®¶å®ä½“ï¼Œå¦‚æœå·²å­˜åœ¨åˆ™ä¸å†åˆ›å»º åˆ›å»ºbinderç®¡å®¶å®ä½“ï¼Œåˆå§‹åŒ–å¼‚æ­¥äº‹åŠ¡å’Œbinderå·¥ä½œä¸¤ä¸ªé˜Ÿåˆ—ï¼Œå¹¶åˆ†åˆ«å¢åŠ å…¶å¼ºå¼±å¼•ç”¨è®¡æ•° åˆå§‹åŒ–å½“å‰binder_contextçš„ç®¡å®¶å®ä½“ï¼ˆbinder_context_mgr_nodeï¼‰å’Œç®¡å®¶uid(binder_context_mgr_uid)ä¿¡æ¯ handleç­‰äº0çš„æœåŠ¡å®ä½“éƒ½æ˜¯æŒ‡servicemanagerç®¡å®¶å®ä½“ æœ€åï¼Œç­‰å¾…å®¢æˆ·è¯·æ±‚ï¼šè°ƒç”¨binder_loop()æ–¹æ³•è¿›å…¥æ— é™å¾ªç¯ï¼Œä½œä¸ºå®ˆæŠ¤è¿›ç¨‹ï¼Œéšæ—¶å¾…å‘½ç­‰å¾…å¤„ç†clientç«¯å‘æ¥çš„è¯·æ±‚ã€‚ servicemanagerå…ˆå‘Binderé©±åŠ¨å‘é€BC_ENTER_LOOPERåè®®ï¼Œè®©ServiceManagerè¿›å…¥å¾ªç¯ã€‚ç„¶åå†å‘é©±åŠ¨å‘é€BINDER_WRITE_READå‘½ä»¤ï¼Œ è¿›å…¥å†…æ ¸æ€ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„è¯·æ±‚æ•°æ®ã€‚è‹¥æ²¡æœ‰æ•°æ®ï¼Œåˆ™è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°æ”¶åˆ°æ•°æ®åè¿”å›ç”¨æˆ·æ€ï¼Œè§£æå¹¶å¤„ç†ï¼Œå‘¨è€Œå¤å§‹åœ°ä¸æ–­å¾ªç¯è¯¥è¿‡ç¨‹ã€‚ 123456789101112131415161718192021222324// servicemanager/binder.cvoid binder_loop(struct binder_state *bs, binder_handler func) { int res; struct binder_write_read bwr; uint32_t readbuf[32]; bwr.write_size = 0; bwr.write_consumed = 0; bwr.write_buffer = 0; readbuf[0] = BC_ENTER_LOOPER; //å‘binderé©±åŠ¨å‘é€BC_ENTER_LOOPERåè®® binder_write(bs, readbuf, sizeof(uint32_t)); for (;;) { bwr.read_size = sizeof(readbuf); bwr.read_consumed = 0; bwr.read_buffer = (uintptr_t) readbuf; //ç­‰å¾…å®¢æˆ·çš„æ•°æ® res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr); //è§£æbinderä¿¡æ¯ res = binder_parse(bs, 0, (uintptr_t) readbuf, bwr.read_consumed, func); }} ServiceManageræä¾›çš„æœåŠ¡ServiceManagerå¯¹å¤–æä¾›æŸ¥è¯¢/æ³¨å†ŒåŠŸèƒ½ï¼Œé€šè¿‡æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¿›ç¨‹å‘é€è¿‡æ¥çš„BR_TRANSACTIONåè®®ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455// service_manager.cint svcmgr_handler(struct binder_state *bs, struct binder_transaction_data *txn, struct binder_io *msg, struct binder_io *reply){ struct svcinfo *si; uint16_t *s; size_t len; uint32_t handle; uint32_t strict_policy; int allow_isolated; ... strict_policy = bio_get_uint32(msg); s = bio_get_string16(msg, &amp;len); ... switch(txn-&gt;code) { case SVC_MGR_GET_SERVICE: case SVC_MGR_CHECK_SERVICE: s = bio_get_string16(msg, &amp;len); //æœåŠ¡å //æ ¹æ®åç§°æŸ¥æ‰¾ç›¸åº”æœåŠ¡ handle = do_find_service(bs, s, len, txn-&gt;sender_euid, txn-&gt;sender_pid); bio_put_ref(reply, handle); return 0; case SVC_MGR_ADD_SERVICE: s = bio_get_string16(msg, &amp;len); //æœåŠ¡å handle = bio_get_ref(msg); //æœåŠ¡å®ä½“åœ¨servicemanagerä¸­çš„handle allow_isolated = bio_get_uint32(msg) ? 1 : 0; //æ³¨å†ŒæŒ‡å®šæœåŠ¡ if (do_add_service(bs, s, len, handle, txn-&gt;sender_euid, allow_isolated, txn-&gt;sender_pid)) return -1; break; case SVC_MGR_LIST_SERVICES: { uint32_t n = bio_get_uint32(msg); if (!svc_can_list(txn-&gt;sender_pid)) { return -1; } si = svclist; while ((n-- &gt; 0) &amp;&amp; si) si = si-&gt;next; if (si) { bio_put_string16(reply, si-&gt;name); return 0; } return -1; } } bio_put_uint32(reply, 0); return 0;} è¯¥æ–¹æ³•çš„åŠŸèƒ½ï¼šæŸ¥è¯¢æœåŠ¡ï¼Œæ³¨å†ŒæœåŠ¡ï¼Œä»¥åŠåˆ—ä¸¾æ‰€æœ‰æœåŠ¡ã€‚ä¸åŒçš„codeå¯¹åº”ä¸åŒçš„å·¥ä½œï¼Œå®šä¹‰åœ¨IBinder.hæ–‡ä»¶ï¼Œè·ŸIServiceManager.hä¸­å®šä¹‰çš„codeå…·æœ‰ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œå…·ä½“å…³ç³»å¦‚ä¸‹æ‰€ç¤ºã€‚ code IBinder.h IServiceManager.h 1 SVC_MGR_GET_SERVICE GET_SERVICE_TRANSACTION 2 SVC_MGR_CHECK_SERVICE CHECK_SERVICE_TRANSACTION 3 SVC_MGR_ADD_SERVICE ADD_SERVICE_TRANSACTION 4 SVC_MGR_LIST_SERVICES LIST_SERVICES_TRANSACTION ServiceManagerservicemanagerè¿›ç¨‹é‡Œé¢æœ‰ä¸€ä¸ªé“¾è¡¨svclistï¼Œè®°å½•ç€æ‰€æœ‰æ³¨å†Œçš„æœåŠ¡svcinfoï¼Œæ¯ä¸€ä¸ªæœåŠ¡ç”¨svcinfoç»“æ„ä½“æ¥è¡¨ç¤ºï¼Œè¯¥handleå€¼æ˜¯åœ¨æ³¨å†ŒæœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œç”±æœåŠ¡æ‰€åœ¨è¿›ç¨‹é‚£ä¸€ç«¯æ‰€ç¡®å®šçš„ã€‚svcinfoç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤ºã€‚ 123456789struct svcinfo{ struct svcinfo *next; uint32_t handle; //æœåŠ¡çš„handleå€¼ struct binder_death death; int allow_isolated; size_t len; //æœåŠ¡åçš„é•¿åº¦ uint16_t name[0]; //æœåŠ¡å}; æ•´ä¸ªServiceManagerå¯åŠ¨è¿‡ç¨‹çš„å®Œæ•´æµç¨‹ï¼Œè¿™é‡Œæ•´ä¸ªè¿‡ç¨‹éƒ½çš„éƒ½ç¦»ä¸å¼€Binderé©±åŠ¨å±‚çš„å®ç°ã€‚ Othervndservicemanagerä»¥å‰ï¼ŒBinder æœåŠ¡é€šè¿‡ servicemanager æ³¨å†Œï¼Œå…¶ä»–è¿›ç¨‹å¯ä»ä¸­æ£€ç´¢è¿™äº›æœåŠ¡ã€‚åœ¨ Android 8 ä¸­ï¼Œservicemanager ç°åœ¨ä¸“ä¾›æ¡†æ¶ä½¿ç”¨ï¼Œè€Œåº”ç”¨è¿›ç¨‹å’Œä¾›åº”å•†è¿›ç¨‹æ— æ³•å†å¯¹å…¶è¿›è¡Œè®¿é—®ã€‚ ä¸è¿‡ï¼Œä¾›åº”å•†æœåŠ¡ç°åœ¨å¯ä»¥ä½¿ç”¨ vndservicemanagerï¼Œè¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ /dev/vndbinderï¼ˆä½œä¸ºæ„å»ºåŸºç¡€çš„æºä»£ç ä¸æ¡†æ¶ servicemanager çš„ç›¸åŒï¼‰è€Œé /dev/binder çš„ servicemanager çš„æ–°å®ä¾‹ã€‚ä¾›åº”å•†è¿›ç¨‹æ— éœ€æ›´æ”¹å³å¯ä¸ vndservicemanager é€šä¿¡ï¼›å½“ä¾›åº”å•†è¿›ç¨‹æ‰“å¼€ /dev/vndbinder æ—¶ï¼ŒæœåŠ¡æŸ¥è¯¢ä¼šè‡ªåŠ¨è½¬è‡³ vndservicemanagerã€‚ vndservicemanager äºŒè¿›åˆ¶æ–‡ä»¶åŒ…å«åœ¨ Android çš„é»˜è®¤è®¾å¤‡ Makefile ä¸­ã€‚","link":"/2023/12/20/ServiceManager/"},{"title":"Socket","text":"Socket1 ä»€ä¹ˆæ˜¯Socket ç½‘ç»œä¸Šçš„ä¸¤ä¸ªç¨‹åºé€šè¿‡ä¸€ä¸ªåŒå‘çš„é€šè®¯è¿æ¥å®ç°æ•°æ®çš„äº¤æ¢ï¼Œè¿™ä¸ªåŒå‘é“¾è·¯çš„ä¸€ç«¯ç§°ä¸ºä¸€ä¸ªSocketã€‚Socketé€šå¸¸ç”¨æ¥å®ç°å®¢æˆ·æ–¹å’ŒæœåŠ¡æ–¹çš„è¿æ¥ã€‚Socketæ˜¯TCP/IPåè®®çš„ä¸€ä¸ªååˆ†æµè¡Œçš„ç¼–ç¨‹ç•Œé¢ï¼Œä¸€ä¸ªSocketç”±ä¸€ä¸ªIPåœ°å€å’Œä¸€ä¸ªç«¯å£å·å”¯ä¸€ç¡®å®šã€‚ ä½†æ˜¯ï¼ŒSocketæ‰€æ”¯æŒçš„åè®®ç§ç±»ä¹Ÿä¸å…‰TCP/IPã€UDPï¼Œå› æ­¤ä¸¤è€…ä¹‹é—´æ˜¯æ²¡æœ‰å¿…ç„¶è”ç³»çš„ã€‚åœ¨Javaç¯å¢ƒä¸‹ï¼ŒSocketç¼–ç¨‹ä¸»è¦æ˜¯æŒ‡åŸºäºTCP/IPåè®®çš„ç½‘ç»œç¼–ç¨‹ã€‚ socketè¿æ¥å°±æ˜¯æ‰€è°“çš„é•¿è¿æ¥ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éœ€è¦äº’ç›¸è¿æ¥ï¼Œç†è®ºä¸Šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¸€æ—¦å»ºç«‹èµ·è¿æ¥å°†ä¸ä¼šä¸»åŠ¨æ–­æ‰çš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™ç½‘ç»œæ³¢åŠ¨è¿˜æ˜¯æœ‰å¯èƒ½çš„ Socketåå‘äºåº•å±‚ã€‚ä¸€èˆ¬å¾ˆå°‘ç›´æ¥ä½¿ç”¨Socketæ¥ç¼–ç¨‹ï¼Œæ¡†æ¶åº•å±‚ä½¿ç”¨Socketæ¯”è¾ƒå¤šï¼Œ 2 socketå±äºç½‘ç»œçš„é‚£ä¸ªå±‚é¢ Socketæ˜¯åº”ç”¨å±‚ä¸TCP/IPåè®®æ—é€šä¿¡çš„ä¸­é—´è½¯ä»¶æŠ½è±¡å±‚ï¼Œå®ƒæ˜¯ä¸€ç»„æ¥å£ã€‚åœ¨è®¾è®¡æ¨¡å¼ä¸­ï¼ŒSocketå…¶å®å°±æ˜¯ä¸€ä¸ªå¤–è§‚æ¨¡å¼ï¼Œå®ƒæŠŠå¤æ‚çš„TCP/IPåè®®æ—éšè—åœ¨Socketæ¥å£åé¢ï¼Œå¯¹ç”¨æˆ·æ¥è¯´ï¼Œä¸€ç»„ç®€å•çš„æ¥å£å°±æ˜¯å…¨éƒ¨ï¼Œè®©Socketå»ç»„ç»‡æ•°æ®ï¼Œä»¥ç¬¦åˆæŒ‡å®šçš„åè®®ã€‚ 3 Socketé€šè®¯çš„è¿‡ç¨‹ åŸºäºTCPï¼šæœåŠ¡å™¨ç«¯å…ˆåˆå§‹åŒ–Socketï¼Œç„¶åä¸ç«¯å£ç»‘å®š(bind)ï¼Œå¯¹ç«¯å£è¿›è¡Œç›‘å¬(listen)ï¼Œè°ƒç”¨accepté˜»å¡ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚åœ¨è¿™æ—¶å¦‚æœæœ‰ä¸ªå®¢æˆ·ç«¯åˆå§‹åŒ–ä¸€ä¸ªSocketï¼Œç„¶åè¿æ¥æœåŠ¡å™¨(connect)ï¼Œå¦‚æœè¿æ¥æˆåŠŸï¼Œè¿™æ—¶å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯çš„è¿æ¥å°±å»ºç«‹äº†ã€‚å®¢æˆ·ç«¯å‘é€æ•°æ®è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯æ¥æ”¶è¯·æ±‚å¹¶å¤„ç†è¯·æ±‚ï¼Œç„¶åæŠŠå›åº”æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¯»å–æ•°æ®ï¼Œæœ€åå…³é—­è¿æ¥ï¼Œä¸€æ¬¡äº¤äº’ç»“æŸã€‚ åŸºäºUDPï¼šUDP åè®®æ˜¯ç”¨æˆ·æ•°æ®æŠ¥åè®®çš„ç®€ç§°ï¼Œä¹Ÿç”¨äºç½‘ç»œæ•°æ®çš„ä¼ è¾“ã€‚è™½ç„¶ UDP åè®®æ˜¯ä¸€ç§ä¸å¤ªå¯é çš„åè®®ï¼Œä½†æœ‰æ—¶åœ¨éœ€è¦è¾ƒå¿«åœ°æ¥æ”¶æ•°æ®å¹¶ä¸”å¯ä»¥å¿å—è¾ƒå°é”™è¯¯çš„æƒ…å†µä¸‹ï¼ŒUDP å°±ä¼šè¡¨ç°å‡ºæ›´å¤§çš„ä¼˜åŠ¿ã€‚æˆ‘å®¢æˆ·ç«¯åªéœ€è¦å‘é€ï¼ŒæœåŠ¡ç«¯èƒ½ä¸èƒ½æ¥æ”¶çš„åˆ°æˆ‘ä¸ç®¡ 4 TCPåè®®Socketä»£ç ç¤ºä¾‹ï¼šå…ˆè¿è¡ŒæœåŠ¡ç«¯ï¼Œåœ¨è¿è¡Œå®¢æˆ·ç«¯ æœåŠ¡ç«¯ï¼š 123456789101112131415161718192021222324252627282930313233343536373839package com.test.io;import java.io.IOException;import java.io.InputStream;import java.io.OutputStream;import java.net.ServerSocket;import java.net.Socket;//TCPåè®®Socketä½¿ç”¨BIOè¿›è¡Œé€šè¡Œï¼šæœåŠ¡ç«¯public class BIOServer { // åœ¨mainçº¿ç¨‹ä¸­æ‰§è¡Œä¸‹é¢è¿™äº›ä»£ç  public static void main(String[] args) { //1å•çº¿ç¨‹æœåŠ¡ ServerSocket server = null; Socket socket = null; InputStream in = null; OutputStream out = null; try { server = new ServerSocket(8000); System.out.println(&quot;æœåŠ¡ç«¯å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£ä¸º8000ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥...&quot;); while (true){ socket = server.accept(); //ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ System.out.println(&quot;å®¢æˆ·è¿æ¥æˆåŠŸï¼Œå®¢æˆ·ä¿¡æ¯ä¸ºï¼š&quot; + socket.getRemoteSocketAddress()); in = socket.getInputStream(); byte[] buffer = new byte[1024]; int len = 0; //è¯»å–å®¢æˆ·ç«¯çš„æ•°æ® while ((len = in.read(buffer)) &gt; 0) { System.out.println(new String(buffer, 0, len)); } //å‘å®¢æˆ·ç«¯å†™æ•°æ® out = socket.getOutputStream(); out.write(&quot;hello!&quot;.getBytes()); } } catch (IOException e) { e.printStackTrace(); } }} å®¢æˆ·ç«¯ï¼š 12345678910111213141516171819202122232425package com.test.io;import java.io.IOException;import java.io.OutputStream;import java.net.Socket;import java.util.Scanner;//TCPåè®®Socketï¼šå®¢æˆ·ç«¯public class Client01 { public static void main(String[] args) throws IOException { //åˆ›å»ºå¥—æ¥å­—å¯¹è±¡socketå¹¶å°è£…ipä¸port Socket socket = new Socket(&quot;127.0.0.1&quot;, 8000); //æ ¹æ®åˆ›å»ºçš„socketå¯¹è±¡è·å¾—ä¸€ä¸ªè¾“å‡ºæµ OutputStream outputStream = socket.getOutputStream(); //æ§åˆ¶å°è¾“å…¥ä»¥IOçš„å½¢å¼å‘é€åˆ°æœåŠ¡å™¨ System.out.println(&quot;TCPè¿æ¥æˆåŠŸ \\nè¯·è¾“å…¥ï¼š&quot;); while(true){ byte[] car = new Scanner(System.in).nextLine().getBytes(); outputStream.write(car); System.out.println(&quot;TCPåè®®çš„Socketå‘é€æˆåŠŸ&quot;); //åˆ·æ–°ç¼“å†²åŒº outputStream.flush(); } }} å…ˆè¿è¡ŒæœåŠ¡ç«¯ï¼Œåœ¨è¿è¡Œå®¢æˆ·ç«¯ã€‚æµ‹è¯•ç»“æœå‘é€æˆåŠŸï¼š Â· 5 UDPåè®®Socketä»£ç ç¤ºä¾‹ï¼š1å…ˆè¿è¡ŒæœåŠ¡ç«¯ï¼Œåœ¨è¿è¡Œå®¢æˆ·ç«¯ æœåŠ¡ç«¯ï¼š 1234567891011121314151617181920212223//UDPåè®®Socketï¼šæœåŠ¡ç«¯public class Server1 { public static void main(String[] args) { try { //DatagramSocketä»£è¡¨å£°æ˜ä¸€ä¸ªUDPåè®®çš„Socket DatagramSocket socket = new DatagramSocket(8888); //byteæ•°ç»„ç”¨äºæ•°æ®å­˜å‚¨ã€‚ byte[] car = new byte[1024]; //DatagramPacket ç±»ç”¨æ¥è¡¨ç¤ºæ•°æ®æŠ¥åŒ…DatagramPacket DatagramPacket packet = new DatagramPacket(car, car.length); // //åˆ›å»ºDatagramPacketçš„receive()æ–¹æ³•æ¥è¿›è¡Œæ•°æ®çš„æ¥æ”¶,ç­‰å¾…æ¥æ”¶ä¸€ä¸ªsocketè¯·æ±‚åæ‰æ‰§è¡Œåç»­æ“ä½œï¼› System.out.println(&quot;ç­‰å¾…UDPåè®®ä¼ è¾“æ•°æ®&quot;); socket.receive(packet); //packet.getLengthè¿”å›å°†è¦å‘é€æˆ–è€…æ¥æ”¶çš„æ•°æ®çš„é•¿åº¦ã€‚ int length = packet.getLength(); System.out.println(&quot;å•¥ä¸œè¥¿æ¥äº†ï¼š&quot; + new String(car, 0, length)); socket.close(); System.out.println(&quot;UDPåè®®Socketæ¥å—æˆåŠŸ&quot;); } catch (IOException e) { e.printStackTrace(); } }} å®¢æˆ·ç«¯ï¼š 123456789101112131415161718192021//UDPåè®®Socketï¼šå®¢æˆ·ç«¯public class Client1 { public static void main(String[] args) { try { //DatagramSocketä»£è¡¨å£°æ˜ä¸€ä¸ªUDPåè®®çš„Socket DatagramSocket socket = new DatagramSocket(2468); //å­—ç¬¦ä¸²å­˜å‚¨äººByteæ•°ç»„ byte[] car = &quot;UDPåè®®çš„Socketè¯·æ±‚ï¼Œæœ‰å¯èƒ½å¤±è´¥å“Ÿ&quot;.getBytes(); //InetSocketAddressç±»ä¸»è¦ä½œç”¨æ˜¯å°è£…ç«¯å£ InetSocketAddress address = new InetSocketAddress(&quot;127.0.0.1&quot;, 8888); //DatagramPacket ç±»ç”¨æ¥è¡¨ç¤ºæ•°æ®æŠ¥åŒ…DatagramPacket DatagramPacket packet = new DatagramPacket(car, car.length, address); //send() æ–¹æ³•å‘é€æ•°æ®åŒ…ã€‚ socket.send(packet); System.out.println(&quot;UDPåè®®çš„Socketå‘é€æˆåŠŸ&quot;); socket.close(); } catch (Exception e) { e.printStackTrace(); } }} å…ˆè¿è¡ŒæœåŠ¡ç«¯ï¼Œåœ¨è¿è¡Œå®¢æˆ·ç«¯ã€‚æµ‹è¯•ç»“æœæˆåŠŸå‘é€æˆåŠŸï¼š 6 Socketçš„å¸¸ç”¨ç±» ç±»å ç”¨äº ä½œç”¨ Socket TCPåè®® Socketç±»åŒæ—¶å·¥ä½œäºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯é€šç”¨çš„ï¼Œè¿™ä¸ªç±»ä¸‰ä¸ªä¸»è¦ä½œç”¨ï¼Œæ ¡éªŒåŒ…ä¿¡æ¯ï¼Œå‘èµ·è¿æ¥ï¼ˆClientï¼‰ï¼Œæ“ä½œæµæ•°æ®ï¼ˆClient/Serverï¼‰ ServerSocket TCPåè®® ServerSocketè¡¨ç¤ºä¸ºæœåŠ¡ç«¯ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯ç»‘å®šå¹¶ç›‘å¬ä¸€ä¸ªæœåŠ¡å™¨ç«¯å£ï¼Œä¸ºæ¯ä¸ªå»ºç«‹è¿æ¥çš„å®¢æˆ·ç«¯â€œå…‹éš†/æ˜ å°„â€ä¸€ä¸ªSocketå¯¹è±¡ï¼Œå…·ä½“æ•°æ®æ“ä½œéƒ½æ˜¯é€šè¿‡è¿™ä¸ªSocketå¯¹è±¡å®Œæˆçš„ï¼ŒServerSocketåªå…³æ³¨å¦‚ä½•å’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ DatagramSocket UDPåè®® DatagramSocket ç±»ç”¨äºè¡¨ç¤ºå‘é€å’Œæ¥æ”¶æ•°æ®æŠ¥åŒ…çš„å¥—æ¥å­—ã€‚ DatagramPacket UDPåè®® DatagramPacket ç±»ç”¨æ¥è¡¨ç¤ºæ•°æ®æŠ¥åŒ…ï¼Œæ•°æ®æŠ¥åŒ…ç”¨æ¥å®ç°æ— è¿æ¥åŒ…æŠ•é€’æœåŠ¡ã€‚ InetAddress IP+ç«¯å£å· Javaæä¾›äº†InetAddressç±»æ¥ä»£è¡¨äº’è”ç½‘åè®®ï¼ˆIPï¼‰åœ°å€ï¼ŒInetAddressç±»æ²¡æœ‰æä¾›æ„é€ å™¨ï¼Œè€Œæ˜¯æä¾›äº†å¦‚ä¸‹ä¸¤ä¸ªé™æ€æ–¹æ³•æ¥è·å–InetAddresså®ä¾‹ï¼š InetSocketAddress IP+ç«¯å£å· åœ¨ä½¿ç”¨Socketæ¥è¿æ¥æœåŠ¡å™¨æ—¶æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ç›´æ¥ä½¿ç”¨IPå’Œç«¯å£ï¼Œä½†Socketç±»ä¸­å¹¶æœªæä¾›è¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯é SocketAddressçš„å­ç±»InetSocketAddressæ¥å®ç° IP åœ°å€ + ç«¯å£å·çš„åˆ›å»ºï¼Œä¸ä¾èµ–ä»»ä½•åè®®ã€‚","link":"/2021/11/11/Socket/"},{"title":"recyclerView","text":"ç¼“å­˜æœºåˆ¶ç®€è¿°ï¼š ä¸€çº§ç¼“å­˜ä¸ºå±å†…ç¼“å­˜ï¼Œåˆ†ä¸ºæ²¡æœ‰å˜åŒ–çš„å¯ä»¥ç›´æ¥å¤ç”¨çš„ViewHolderå’Œè¢«notifyXXXæ ‡è®°ä¸ºéœ€è¦é‡æ–°ç»‘å®šçš„ViewHolderï¼› äºŒçº§ç¼“å­˜ä¸ºç¦»å±2ä¸ªçš„ViewHolderç¼“å­˜ï¼Œç›´æ¥å¤ç”¨ ä¸‰çº§ç¼“å­˜ä¸ºè‡ªå®šä¹‰ç¼“å­˜ï¼Œè¾ƒå°‘ç”¨ å››çº§ç¼“å­˜ä¸ºè¶…å‡ºä¸Šè¿°ç¼“å­˜çš„éœ€è¦é‡æ–°ç»‘å®šçš„ViewHolder Recyclerviewç¼“å­˜é›†åˆå¯ä»¥åˆ†ä¸º 4 ä¸ªçº§åˆ«ï¼ŒæŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°åº•ä¸ºï¼š ä¸€çº§ç¼“å­˜ï¼šmAttachedScrap å’Œ mChangedScrap ï¼Œç”¨æ¥ç¼“å­˜è¿˜åœ¨å±å¹•å†…çš„ ViewHolder mAttachedScrap å­˜å‚¨çš„æ˜¯å½“å‰è¿˜åœ¨å±å¹•ä¸­çš„ ViewHolderï¼›æŒ‰ç…§ id å’Œ position æ¥æŸ¥æ‰¾ ViewHolder mChangedScrap è¡¨ç¤ºæ•°æ®å·²ç»æ”¹å˜çš„ ViewHolder åˆ—è¡¨, å­˜å‚¨ notifyXXX æ–¹æ³•æ—¶éœ€è¦æ”¹å˜çš„ ViewHolder äºŒçº§ç¼“å­˜ï¼šmCachedViews ï¼Œç”¨æ¥ç¼“å­˜ç§»é™¤å±å¹•ä¹‹å¤–çš„ ViewHolderï¼Œé»˜è®¤æƒ…å†µä¸‹ç¼“å­˜å®¹é‡æ˜¯ 2ï¼Œå¯ä»¥é€šè¿‡ setViewCacheSize æ–¹æ³•æ¥æ”¹å˜ç¼“å­˜çš„å®¹é‡å¤§å°ã€‚å¦‚æœ mCachedViews çš„å®¹é‡å·²æ»¡ï¼Œåˆ™ä¼šæ ¹æ® FIFO çš„è§„åˆ™ç§»é™¤æ—§ ViewHolder ä¸‰çº§ç¼“å­˜ï¼šViewCacheExtension ï¼Œå¼€å‘ç»™ç”¨æˆ·çš„è‡ªå®šä¹‰æ‰©å±•ç¼“å­˜ï¼Œéœ€è¦ç”¨æˆ·è‡ªå·±ç®¡ç† View çš„åˆ›å»ºå’Œç¼“å­˜ã€‚ä¸ªäººæ„Ÿè§‰è¿™ä¸ªæ‹“å±•è„±ç¦»äº† Adapter.createViewHolder ä½¿ç”¨çš„è¯ä¼šé€ æˆ View åˆ›å»º ä¸ æ•°æ®ç»‘å®šåŠå…¶å®ƒä»£ç å¤ªåˆ†æ•£ï¼Œä¸åˆ©äºç»´æŠ¤ï¼Œä½¿ç”¨åœºæ™¯å¾ˆå°‘ä»…åšäº†è§£ å››çº§ç¼“å­˜ï¼šRecycledViewPool ï¼ŒViewHolder ç¼“å­˜æ± ï¼Œåœ¨æœ‰é™çš„ mCachedViews ä¸­å¦‚æœå­˜ä¸ä¸‹æ–°çš„ ViewHolder æ—¶ï¼Œå°±ä¼šæŠŠ ViewHolder å­˜å…¥RecyclerViewPool ä¸­ã€‚ æŒ‰ç…§ Type æ¥æŸ¥æ‰¾ ViewHolder æ¯ä¸ª Type é»˜è®¤æœ€å¤šç¼“å­˜ 5 ä¸ª å¯ä»¥å¤šä¸ª RecyclerView å…±äº« RecycledViewPool 1.1ã€å››çº§ç¼“å­˜Recyclerç¼“å­˜ViewHolderå¯¹è±¡æœ‰4ä¸ªç­‰çº§ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°åº•ä¾æ¬¡ä¸ºï¼š ä¸€çº§ã€mAttachedScrapï¼šç¼“å­˜å±å¹•ä¸­å¯è§èŒƒå›´çš„ViewHolderï¼›äºŒçº§ã€mCachedViewsï¼šç¼“å­˜æ»‘åŠ¨æ—¶å³å°†ä¸RecyclerViewåˆ†ç¦»çš„ViewHolderï¼Œé»˜è®¤æœ€å¤§2ä¸ªï¼›ä¸‰çº§ã€ViewCacheExtensionï¼šè‡ªå®šä¹‰å®ç°çš„ç¼“å­˜ï¼›å››çº§ã€RecycledViewPool ï¼šViewHolderç¼“å­˜æ± ï¼Œå¯ä»¥æ”¯æŒä¸åŒçš„ViewTypeï¼› ä¸€çº§ç¼“å­˜ï¼šmAttachedScrapä¸mChangedScrap1.1.1 mAttachedScrap ï¼ˆå®Œå…¨å¤ç”¨ï¼‰mAttachedScrapå­˜å‚¨çš„æ˜¯å½“å‰å±å¹•ä¸­çš„ViewHolderï¼ŒmAttachedScrapçš„å¯¹åº”æ•°æ®ç»“æ„æ˜¯ArrayListï¼Œåœ¨è°ƒç”¨LayoutManager#onLayoutChildrenæ–¹æ³•æ—¶å¯¹viewsè¿›è¡Œå¸ƒå±€ï¼Œæ­¤æ—¶ä¼šå°†RecyclerViewä¸Šçš„Viewså…¨éƒ¨æš‚å­˜åˆ°è¯¥é›†åˆä¸­ï¼Œè¯¥ç¼“å­˜ä¸­çš„ViewHolderçš„ç‰¹æ€§æ˜¯ï¼Œå¦‚æœå’ŒRVä¸Šçš„positionæˆ–è€…itemIdåŒ¹é…ä¸Šäº†é‚£ä¹ˆå¯ä»¥ç›´æ¥æ‹¿æ¥ä½¿ç”¨çš„ï¼Œæ— éœ€è°ƒç”¨onBindViewHolderæ–¹æ³•ã€‚ 1.1.2 mChangedScrap ï¼ˆéœ€è¦onBindViewHolderï¼‰mChangedScrapå’ŒmAttachedScrapå±äºåŒä¸€çº§åˆ«çš„ç¼“å­˜ï¼Œä¸è¿‡mChangedScrapçš„è°ƒç”¨åœºæ™¯æ˜¯notifyItemChangedå’ŒnotifyItemRangeChangedï¼Œåªæœ‰å‘ç”Ÿå˜åŒ–çš„ViewHolderæ‰ä¼šæ”¾å…¥åˆ°mChangedScrapä¸­ã€‚mChangedScrapç¼“å­˜ä¸­çš„ViewHolderæ˜¯éœ€è¦è°ƒç”¨onBindViewHolderæ–¹æ³•é‡æ–°ç»‘å®šæ•°æ®çš„ã€‚ äºŒçº§ç¼“å­˜ï¼š mCachedViews ï¼ˆå®Œå…¨å¤ç”¨ï¼‰mCachedViewsç¼“å­˜æ»‘åŠ¨æ—¶å³å°†ä¸RecyclerViewåˆ†ç¦»çš„ViewHolderï¼ŒæŒ‰å­Viewçš„positionæˆ–idç¼“å­˜ï¼Œé»˜è®¤æœ€å¤šå­˜æ”¾2ä¸ªã€‚mCachedViewså¯¹åº”çš„æ•°æ®ç»“æ„æ˜¯ArrayListï¼Œä½†æ˜¯è¯¥ç¼“å­˜å¯¹é›†åˆçš„å¤§å°æ˜¯æœ‰é™åˆ¶çš„ã€‚ è¯¥ç¼“å­˜ä¸­ViewHolderçš„ç‰¹æ€§å’ŒmAttachedScrapä¸­çš„ç‰¹æ€§æ˜¯ä¸€æ ·çš„ï¼Œåªè¦positionæˆ–è€…itemIdå¯¹åº”å°±æ— éœ€é‡æ–°ç»‘å®šæ•°æ®ã€‚å¼€å‘è€…å¯ä»¥è°ƒç”¨setItemViewCacheSize(size)æ–¹æ³•æ¥æ”¹å˜ç¼“å­˜çš„å¤§å°ï¼Œè¯¥å±‚çº§ç¼“å­˜è§¦å‘çš„ä¸€ä¸ªå¸¸è§çš„åœºæ™¯æ˜¯æ»‘åŠ¨RecyclerViewã€‚å½“ç„¶è°ƒç”¨notify()ä¹Ÿä¼šè§¦å‘è¯¥ç¼“å­˜ã€‚ ä¸‰çº§ç¼“å­˜ï¼š ViewCacheExtensionViewCacheExtensionæ˜¯éœ€è¦å¼€å‘è€…è‡ªå·±å®ç°çš„ç¼“å­˜ï¼ŒåŸºæœ¬ä¸Šé¡µé¢ä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½å¯ä»¥é€šè¿‡å®ƒè¿›è¡Œå®ç°ã€‚ å››çº§ç¼“å­˜ï¼š RecyclerViewPool ï¼ˆé‡æ–°onBindViewHolderï¼‰ViewHolderç¼“å­˜æ± ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªSparseArrayï¼Œå…¶ä¸­keyæ˜¯ViewType(intç±»å‹)ï¼Œvalueå­˜æ”¾çš„æ˜¯ ArrayList&lt; ViewHolder&gt;ï¼Œé»˜è®¤æ¯ä¸ªArrayListä¸­æœ€å¤šå­˜æ”¾5ä¸ªViewHolderã€‚ 1.2 å››çº§ç¼“å­˜å¯¹æ¯” ç¼“å­˜çº§åˆ« æ¶‰åŠå¯¹è±¡ è¯´æ˜ æ˜¯å¦é‡æ–°åˆ›å»ºè§†å›¾View æ˜¯å¦é‡æ–°ç»‘å®šæ•°æ® ä¸€çº§ç¼“å­˜ mAttachedScrap mChangedScrap ç¼“å­˜å±å¹•ä¸­å¯è§èŒƒå›´çš„ViewHolder false mAttachedScrapä¸éœ€è¦mChangedScrapéœ€è¦ äºŒçº§ç¼“å­˜ mCachedViews ç¼“å­˜æ»‘åŠ¨æ—¶å³å°†ä¸RecyclerViewåˆ†ç¦»çš„ViewHolderï¼ŒæŒ‰å­Viewçš„positionæˆ–idç¼“å­˜ false false ä¸‰çº§ç¼“å­˜ mViewCacheExtension å¼€å‘è€…è‡ªè¡Œå®ç°çš„ç¼“å­˜ å››çº§ç¼“å­˜ mRecyclerPool ViewHolderç¼“å­˜æ± ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªSparseArrayï¼Œå…¶ä¸­keyæ˜¯ViewType(intç±»å‹)ï¼Œvalueå­˜æ”¾çš„æ˜¯ ArrayList&lt; ViewHolder&gt;ï¼Œé»˜è®¤æ¯ä¸ªArrayListä¸­æœ€å¤šå­˜æ”¾5ä¸ªViewHolder false true ItemDecorationgetItemOffsets()viewä¹‹é—´çš„åˆ†å‰²è·ç¦» 1234567891011121314151617181920212223242526RecyclerView.java { Rect getItemDecorInsetsForChild(View child) { final LayoutParams lp = (LayoutParams) child.getLayoutParams(); if (!lp.mInsetsDirty) { return lp.mDecorInsets; } if (mState.isPreLayout() &amp;&amp; (lp.isItemChanged() || lp.isViewInvalid())) { // changed/invalid items should not be updated until they are rebound. return lp.mDecorInsets; } final Rect insets = lp.mDecorInsets; insets.set(0, 0, 0, 0); final int decorCount = mItemDecorations.size(); for (int i = 0; i &lt; decorCount; i++) { mTempRect.set(0, 0, 0, 0); mItemDecorations.get(i).getItemOffsets(mTempRect, child, this, mState); insets.left += mTempRect.left; insets.top += mTempRect.top; insets.right += mTempRect.right; insets.bottom += mTempRect.bottom; } lp.mInsetsDirty = false; return insets; }} onDrawã€onDrawOverç”±äºViewç»˜åˆ¶é¡ºåºæ˜¯(å¿½è§†æœªæ ‡å‡ºçš„ä¸å¸¸ç”¨æ­¥éª¤)ï¼š 1234567891011121314151617181920212223View.java { public void draw(Canvas canvas) { // Step 1, draw the background, if needed drawBackground(canvas); // Step 3, draw the content onDraw(canvas); // Step 4, draw the children dispatchDraw(canvas); // Step 6, draw decorations (foreground, scrollbars) onDrawForeground(canvas); }}RecyclerView.java { public void onDraw(Canvas c) { super.onDraw(c); final int count = mItemDecorations.size(); for (int i = 0; i &lt; count; i++) { mItemDecorations.get(i).onDraw(c, this, mState); } }} å…¶ä¸­ï¼ŒRecyclerView.onDrawä¼šå…ˆç»˜åˆ¶ItemDecoration.onDrawï¼Œç„¶åå†èµ°dispatchDrawç»˜åˆ¶å­Viewï¼ˆå³itemView) æ•…è€Œï¼ŒItemDecorationçš„onDrawå†…å®¹æ˜¯ä¼šè¢«itemViewæ‰€é®æŒ¡ï¼Œå¦‚æœ‰éœ€è¦ï¼Œè°ƒç”¨onDrawOverå¯è¦†ç›–itemViewçš„onDrawå†…å®¹ã€‚ â€‹ ä¼˜åŒ–æªæ–½ï¼š1ã€é¢„å–æœºåˆ¶Prefetch : å¼•å…¥RenderThreadåï¼Œåœ¨UIçº¿ç¨‹å°†é¡µé¢æ•°æ®äº¤ç”±Renderçº¿ç¨‹æ¸²æŸ“ä»¥åï¼ŒUIçº¿ç¨‹ä¼šå‡ºç°å¤§é‡çš„ç©ºé—²æ—¶é—´è¿™äº›ç©ºé—²ç­‰å¾…æ—¶é—´å°±è¢«æµªè´¹äº†ã€‚Prefetchçš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯åˆ©ç”¨è¿™éƒ¨åˆ†ç©ºé—²æ—¶é—´æ¥é¢„å…ˆå¤„ç† itemçš„åˆ›å»ºï¼ˆå¦‚æœæ²¡æœ‰ç¼“å­˜ï¼‰å’Œæ•°æ®ç»‘å®šã€‚ å¯¹æ¯”ä¸€ä¸‹ä½¿ç”¨äº†Prefetchä»¥åçš„æ¸²æŸ“æ—¶åºå›¾å¦‚ä¸‹ï¼š åœ¨UIçº¿ç¨‹å°†é¡µé¢æ•°æ®äº¤ç”±Renderçº¿ç¨‹æ¸²æŸ“ä»¥åï¼Œä¼šå‡ºç°å¤§é‡çš„ç©ºé—²æ—¶é—´ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ—¶ç©ºä¸Šçš„å¤ç”¨ï¼Œä¼šå¤§å¤§æé«˜é¡µé¢æ¸²æŸ“çš„æ•ˆç‡ï¼Œæé«˜é¡µé¢æµç•…åº¦ã€‚ è¯¥æœºåˆ¶æ˜¯é»˜è®¤æ‰“å¼€çš„ï¼Œä½†å¦‚æœå‡ºç°rvåµŒå¥—rvçš„æƒ…å†µï¼Œç”±äºæƒ…å†µè¾ƒä¸ºå¤æ‚ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨setInitialPrefetchItemCount å°±æ˜¯æŒ‡å®šè¿™ä¸ªrecyclerviewé¢„å–æ—¶çš„æ•°é‡ï¼ˆåˆé€‚çš„ï¼‰ï¼Œæ¥è¾¾åˆ°æ›´å¥½çš„åŠ è½½æ•ˆæœã€‚ setInitialPrefetchItemCountè¿™ä¸ªAPIå¯ä»¥è®¾ç½®é¢„åŠ è½½çš„Itemæ•°ï¼Œä½¿ç”¨è¿™ä¸ªAPIæœ‰ä¸‰ä¸ªå‰æï¼š 1ï¼šå½“å‰recyclerviewæ˜¯åµŒå¥—åœ¨å¦ä¸€ä¸ªRecyclerviewä¹‹ä¸­çš„ï¼› 2ï¼šå½“å‰recyclerviewæ˜¯LinearLayoutManagerå¹¶ä¸”æ¨ªå‘çš„ï¼ˆåªæœ‰LinearLayoutManager æ‰æœ‰è¿™ä¸ªAPIï¼‰ï¼› 3ï¼šAndroid 5.0ï¼ˆå¼•å…¥RenderThreadï¼Œå¹¶é»˜è®¤æ‰“å¼€recyclerviewçš„mItemPrefetchEableï¼‰ 2ã€setHasFixedSize(true)å¦‚æœRecyclerviewçš„å®½é«˜ä¸ä¼šéšç€å®ƒçš„å†…å®¹æ”¹å˜è€Œæ”¹å˜ï¼Œåˆ™å¯ä»¥ç”¨è¿™ä¸ªAPIï¼Œé¿å…ä¸å¿…è¦çš„requestLayoutå¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ã€‚ï¼ˆnotifydatasetchangeæ— æ•ˆï¼‰ 1234567void onItemsInsertedOrRemoved() { if (hasFixedSize) layoutChildren(); else requestLayout(); } 3ã€å°½é‡ä½¿ç”¨notifyItemChangeè€ŒénotifyDataSetChangeæ•°æ®å˜åŒ–æœ‰ä¸¤ç§æƒ…å†µï¼š ä¸€ç§æ˜¯item change ä¸€ç§æ˜¯ structure changeï¼› å‰è€…æ˜¯å•ä¸ªitemæ•°æ®æ›´æ–°ä½†ä¸ä¼šå¯¼è‡´ä½ç½®å˜æ¢ï¼› åè€…æ˜¯æ•°æ®é›†ä¸­items å‘ç”Ÿæ’å…¥ï¼Œåˆ é™¤ï¼Œç§»åŠ¨çš„æƒ…å†µä¸‹ã€‚ Notifydatasetchangeè®¤ä¸ºç°æœ‰æ‰€æœ‰çš„ç°æœ‰é¡¹å’Œç»“æ„ä¸å†æœ‰æ•ˆï¼Œä¼šä½¿Layoutmanagerå¼ºåˆ¶å®Œå…¨é‡æ–°ç»‘å®šå’Œé‡æ–°å¸ƒå±€æ‰€æœ‰çš„å¯è§itemã€‚ Googleå»ºè®®å°½é‡ä½¿ç”¨åˆ·æ–°ç‰¹å®šitemchangeçš„é«˜æ•ˆæ–¹æ³•ã€‚è€ŒæŠŠæ­¤æ–¹æ³•è§†ä¸ºå¯ä»¥ç”¨çš„æœ€åçš„æ‰‹æ®µã€‚ 4ã€RecyclerView RecycledViewPoolå¤ç”¨å…¶å®å°±æ˜¯è®©ä¸€ä¸ªRecyclerview å¯ä»¥å¤ç”¨å…¶ä»–å…·æœ‰ç›¸åŒViewTypeçš„Recyclerviewã€‚ 5ã€DiffUtil DifferResult.dispatchUpdatesTo(final RecyclerView.Adapter adapter) æˆ–è€… AysncListData.submitList() èµ°åˆ°æœ€åå…¶å®ä¹Ÿæ˜¯ notifyItemChanged(); â€‹ notifyItemInserted(); â€‹ notifyItemRangeRemoved(); â€‹ notifyItemMoved(); 6ã€other å¦‚æœå‘ç°itemå› ä¸ºmeasureä»»åŠ¡è¿‡é‡ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰viewæ¥ä¼˜åŒ–æ­¤itemï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªViewHolderé‡Œé¢æœ‰å¾ˆå¤šæ ‡ç­¾çš„æƒ…å†µã€‚ åœ¨å¿«é€Ÿæ»‘åŠ¨æ—¶ä¸åŠ è½½ç½‘ç»œå›¾ç‰‡æˆ–åœæ­¢gifå›¾å’Œè§†é¢‘çš„æ’­æ”¾ è®¾ç½®åˆé€‚çš„ç¼“å­˜ç­–ç•¥","link":"/2021/10/15/RecyclerView/"},{"title":"Surface","text":"SurfaceView: View çš„å­ç±»ï¼Œä½†ä¸ä¸å®¿ä¸» Window å…±äº« Surface, è€Œæ˜¯æœ‰è‡ªå·±ç‹¬ç«‹çš„ Surface, ä¸”å¯ä»¥åœ¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸­è¿›è¡Œç»˜åˆ¶ï¼Œå› æ­¤ SurfaceView ä¸€èˆ¬ç”¨æ¥å®ç°æ¯”è¾ƒå¤æ‚çš„å›¾åƒæˆ–åŠ¨ç”»/è§†é¢‘çš„æ˜¾ç¤ºã€‚å¯ä»¥å‚è€ƒ AndroidåŒç¼“å­˜ä¸SurfaceViewã€‚ç”±äºå…¶å†…å®¹æ˜¯ç»˜åˆ¶åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ Surface ä¸Šï¼Œå› æ­¤æ— æ³•ç”¨ scrollTo/By ç­‰æ–¹æ³•å»ç§»åŠ¨æ“ä½œ Canvas é‡Œçš„å†…å®¹ï¼Œä½†æ˜¯å¯å¯¹æ•´ä¸ª View è¿›è¡Œå¹³ç§»ï¼Œç¼©æ”¾ï¼Œæ—‹è½¬ç­‰å˜æ¢æ“ä½œã€‚ GLSurfaceView: åŸºäº SurfaceView å†æ¬¡è¿›è¡Œæ‰©å±•ï¼Œåœ¨ SurfaceView åŸºç¡€ä¸Šå°è£…äº† EGL ç¯å¢ƒç®¡ç†ä»¥åŠ Render çº¿ç¨‹ï¼Œä¸“é—¨ä¸º OpenGl æ˜¾ç¤ºæ¸²æŸ“ä½¿ç”¨ã€‚å‚è€ƒ Android-OpenGL-ESç¬”è®°ã€‚ TextrueView: Android 4.0 åå¼•å…¥ TextureView, å®ƒå°† SurfaceTexture å’Œ View ç»“åˆåˆ°äº†ä¸€èµ·ã€‚ä¸ SurfaceView ç›¸æ¯”ï¼Œå®ƒå¹¶æ²¡æœ‰åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ Surface æ¥ç»˜åˆ¶ï¼Œè§£å†³äº† SurfaceView æ— æ³•åœ¨ Canvas å†…å®¹ä¸ŠåšåŠ¨ç”»çš„é—®é¢˜ã€‚å¦å¤– TextureView å¿…é¡»åœ¨ç¡¬ä»¶åŠ é€Ÿå¼€å¯çš„çª—å£ä¸­ä½¿ç”¨ã€‚ Viewçš„å®Œæ•´å·¥ä½œæµç¨‹ï¼Œä»cpuè®¡ç®—æ§ä»¶æ•°æ®ï¼Œåˆ°surfaceFlingeråˆæˆè¿™äº›æ•°æ®ï¼Œå†åˆ°vsyncä¿¡å·è¾¾åˆ°åå¼€å§‹ç»˜åˆ¶ï¼ˆè§/ScreenDrawç« ï¼‰ï¼› SurfaceWindowçš„æ ¸å¿ƒå˜é‡ã€‚ Android ç³»ç»Ÿé‡‡ç”¨ä¸€ç§ç§°ä¸º Surface çš„å›¾å½¢æ¶æ„ï¼Œç®€è€Œè¨€ä¹‹ï¼Œæ¯ä¸€ä¸ª Activity éƒ½å…³è”æœ‰è‡³å°‘ä¸€ä¸ª Windowï¼ˆçª—å£ï¼‰ï¼Œæ¯ä¸€ä¸ª Window éƒ½å¯¹åº”æœ‰ä¸€ä¸ª Surfaceã€‚ Surface è¿™é‡Œç›´è¯‘è¿‡æ¥å«åš ç»˜å›¾è¡¨é¢ ï¼Œé¡¾åæ€ä¹‰ï¼Œå…¶å¯åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºé˜Ÿåˆ—ï¼Œç”¨äºæè¿° UIï¼Œç»ä¸ç³»ç»ŸæœåŠ¡çš„WindowServiceManager é€šä¿¡åã€é€šè¿‡ SurfaceFlinger æœåŠ¡æŒç»­åˆæˆå¹¶é€æ˜¾åˆ°æ˜¾ç¤ºå±ã€‚ ç”±æ­¤å¯è§ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ª Activity çš„ UI æ¸²æŸ“æœ¬è´¨æ˜¯ ç³»ç»Ÿæä¾›ä¸€å—å†…å­˜ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºè¿›è¡Œç»´æŠ¤ï¼›è¿™å—å†…å­˜å°±æ˜¯ Surfaceï¼Œæœ€ç»ˆé¡µé¢æ‰€æœ‰ View çš„ UI çŠ¶æ€æ•°æ®ï¼Œéƒ½ä¼šè¢«å¡«å……åˆ°åŒä¸€ä¸ª Surface ä¸­ã€‚ SurfaceView &amp; TextureViewSurfaceView æœ¬èº«çš„è¾“å‡ºä¸æ˜¯é€šè¿‡ Android çš„ UI Rendererï¼ˆHWUIï¼‰ï¼Œè€Œæ˜¯ç›´æ¥èµ°ç³»ç»Ÿçš„çª—å£åˆæˆå™¨ SurfaceFlingerï¼Œ //æš‚æ—¶CVï¼Œå¾…å®Œå–„ 1 SurfaceSurface å°±æ˜¯â€œè¡¨é¢â€çš„æ„æ€ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºå†…å­˜ä¸­çš„ä¸€æ®µç»˜å›¾ç¼“å†²åŒºã€‚åœ¨ SDK çš„æ–‡æ¡£ä¸­ï¼Œå¯¹ Surface çš„æè¿°æ˜¯è¿™æ ·çš„ï¼šâ€œHandle onto a raw buffer that is being managed by the screen compositorâ€ï¼Œæ„æ€æ˜¯â€œç”±å±å¹•æ˜¾ç¤ºå†…å®¹åˆæˆå™¨ï¼ˆscreen compositorï¼‰æ‰€ç®¡ç†çš„åŸç”Ÿç¼“å†²å™¨çš„å¥æŸ„â€ï¼Œ è¿™å¥è¯åŒ…æ‹¬ä¸‹é¢ä¸¤ä¸ªæ„æ€ï¼š é€šè¿‡ Surfaceï¼ˆå› ä¸º Surface æ˜¯å¥æŸ„ï¼‰å°±å¯ä»¥è·å¾—åŸç”Ÿç¼“å†²å™¨ä»¥åŠå…¶ä¸­çš„å†…å®¹ã€‚å°±åƒåœ¨Cè¯­è¨€ä¸­ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªæ–‡ä»¶çš„å¥æŸ„ï¼Œå°±å¯ä»¥è·å¾—æ–‡ä»¶çš„å†…å®¹ä¸€æ ·ï¼› åŸç”Ÿç¼“å†²å™¨ï¼ˆrawbufferï¼‰æ˜¯ç”¨äºä¿å­˜å½“å‰çª—å£çš„åƒç´ æ•°æ®çš„ã€‚ ç®€å•çš„è¯´ Surface å¯¹åº”äº†ä¸€å—å±å¹•ç¼“å†²åŒºï¼Œæ¯ä¸ª Window å¯¹åº”ä¸€ä¸ª Surfaceï¼Œä»»ä½• View éƒ½æ˜¯ç”»åœ¨ Surface ä¸Šçš„ï¼Œä¼ ç»Ÿçš„ view å…±äº«ä¸€å—å±å¹•ç¼“å†²åŒºï¼Œæ‰€æœ‰çš„ç»˜åˆ¶å¿…é¡»åœ¨ UI çº¿ç¨‹ä¸­è¿›è¡Œã€‚æˆ‘ä»¬ä¸èƒ½ç›´æ¥æ“ä½œ Surface å®ä¾‹ï¼Œè¦é€šè¿‡ SurfaceHolderï¼Œåœ¨ SurfaceView ä¸­å¯ä»¥é€šè¿‡ getHolder() æ–¹æ³•è·å–åˆ° SurfaceHolder å®ä¾‹ã€‚ Surface æ˜¯ä¸€ä¸ªç”¨æ¥ç”»å›¾å½¢çš„åœ°æ–¹ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ç”»å›¾éƒ½æ˜¯åœ¨ä¸€ä¸ª Canvas å¯¹è±¡ä¸Šé¢è¿›è¡Œçš„ï¼ŒSurface ä¸­çš„ Canvas æˆå‘˜ï¼Œæ˜¯ä¸“é—¨ç”¨äºæä¾›ç”»å›¾çš„åœ°æ–¹ï¼Œå°±åƒé»‘æ¿ä¸€æ ·ï¼Œå…¶ä¸­çš„åŸå§‹ç¼“å†²åŒºæ˜¯ç”¨æ¥ä¿å­˜æ•°æ®çš„åœ°æ–¹ã€‚ Surface æœ¬èº«çš„ä½œç”¨ç±»ä¼¼ä¸€ä¸ªå¥æŸ„ï¼Œå¾—åˆ°äº†è¿™ä¸ªå¥æŸ„å°±å¯ä»¥å¾—åˆ°å…¶ä¸­çš„Canvasã€åŸå§‹ç¼“å†²åŒºä»¥åŠå…¶ä»–æ–¹é¢çš„å†…å®¹ï¼Œæ‰€ä»¥ç®€å•çš„è¯´ Surface æ˜¯ç”¨æ¥ç®¡ç†æ•°æ®çš„ï¼ˆå¥æŸ„ï¼‰ã€‚ è¯´å®Œ surface å°±å¯ä»¥è¯´ SurfaceView äº†ã€‚ 2 SurfaceView2.1 SurfaceView ç®€ä»‹ç®€å•çš„è¯´ SurfaceView å°±æ˜¯ä¸€ä¸ªæœ‰ Surface çš„ Viewï¼ŒSurfaceView æ§åˆ¶è¿™ä¸ª Surface çš„æ ¼å¼å’Œå°ºå¯¸ä»¥åŠç»˜åˆ¶ä½ç½®ã€‚ä¼ ç»Ÿ View åŠå…¶æ´¾ç”Ÿç±»çš„æ›´æ–°åªèƒ½åœ¨ UI çº¿ç¨‹ï¼Œç„¶è€Œ UI çº¿ç¨‹è¿˜åŒæ—¶å¤„ç†å…¶ä»–äº¤äº’é€»è¾‘ï¼Œè¿™å°±æ— æ³•ä¿è¯ view æ›´æ–°çš„é€Ÿåº¦å’Œå¸§ç‡äº†ï¼Œè€Œ SurfaceView å¯ä»¥ç”¨ç‹¬ç«‹çš„çº¿ç¨‹æ¥è¿›è¡Œç»˜åˆ¶ã€‚å› æ­¤å¯ä»¥æä¾›æ›´é«˜çš„å¸§ç‡ï¼Œä¾‹å¦‚æ¸¸æˆï¼Œæ‘„åƒå¤´å–æ™¯ç­‰åœºæ™¯å°±æ¯”è¾ƒé€‚åˆç”¨ SurfaceView æ¥å®ç°ã€‚ SurfaceView çš„æ ¸å¿ƒåœ¨äºæä¾›äº†ä¸¤ä¸ªçº¿ç¨‹ï¼šUIçº¿ç¨‹å’Œæ¸²æŸ“çº¿ç¨‹ï¼Œä¸¤ä¸ªçº¿ç¨‹é€šè¿‡â€œåŒç¼“å†²â€æœºåˆ¶æ¥è¾¾åˆ°é«˜æ•ˆçš„ç•Œé¢åˆ·æ–°æ•ˆæœã€‚ 2.2 SurfaceView å®ç°æœºåˆ¶SurfaceView ç»§æ‰¿è‡ª Viewï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯ä¸€ä¸ª Viewã€‚ä½†æ˜¯è¿™ä¸ª View å’Œæ™®é€šçš„ View æœ‰ç‚¹ä¸åŒã€‚SurfaceView æœ‰è‡ªå·±çš„ Surfaceï¼Œåœ¨ Android ä¸­ï¼Œä¸€ä¸ª View æœ‰è‡ªå·±çš„ Surfaceï¼Œåœ¨ WMS ä¸­ä¸­å°±æœ‰å¯¹åº”çš„ WindowStateï¼Œå¯¹åº”åœ¨ SurfaceFlinger ä¸­å°±æœ‰ Layerã€‚ ä¸€èˆ¬çš„ Activity åŒ…å«çš„å¤šä¸ª View ä¼šç»„æˆ View hierachy çš„æ ‘å½¢ç»“æ„ï¼Œåªæœ‰æœ€é¡¶å±‚çš„ DectorView æ‰æ˜¯å¯¹ WMS å¯è§çš„ï¼Œè¿™ä¸ª DecorView åœ¨ WMS ä¸­æœ‰ä¸€ä¸ªå¯¹åº”çš„ WindowStateï¼Œç›¸åº”çš„ï¼Œåœ¨ SurfaceFlinger ä¸­æœ‰å¯¹åº”çš„ Layerã€‚è€Œ SurfaceView æ­£å› ä¸ºå®ƒæœ‰è‡ªå·±çš„ Surfaceï¼Œæœ‰è‡ªå·±çš„ Windowï¼Œå®ƒåœ¨ WMS ä¸­æœ‰å¯¹åº”çš„ WindowStateï¼Œåœ¨ SurfaceFlinger ä¸­æœ‰ Layerã€‚ è™½ç„¶åœ¨ App ç«¯å®ƒä»åœ¨ View hierachy ä¸­ï¼Œä½†åœ¨ Server ç«¯ï¼ˆWMS å’Œ SurfaceFlingerï¼‰ä¸­ï¼Œå®ƒä¸å®¿ä¸»çª—å£æ˜¯åˆ†ç¦»çš„ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯å¯¹è¿™ä¸ª Surface çš„æ¸²æŸ“å¯ä»¥æ”¾åˆ°å•ç‹¬çš„çº¿ç¨‹ä¸­å»åšï¼Œæ¸²æŸ“æ—¶å¯ä»¥æœ‰è‡ªå·±çš„ GL contextã€‚è¿™å¯¹äºä¸€äº›æ¸¸æˆã€è§†é¢‘ç­‰æ€§èƒ½ç›¸å…³çš„åº”ç”¨éå¸¸æœ‰ç›Šï¼Œå› ä¸ºå®ƒä¸ä¼šå½±å“ä¸»çº¿ç¨‹å¯¹äº‹ä»¶çš„å“åº”ã€‚ ä½†æ˜¯è¿™ä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå› ä¸ºè¿™ä¸ª Surface ä¸åœ¨ View hierachy ä¸­ï¼Œå®ƒçš„æ˜¾ç¤ºä¹Ÿä¸å— View çš„å±æ€§æ§åˆ¶ï¼Œæ‰€ä»¥ä¸èƒ½è¿›è¡Œå¹³ç§»ã€ç¼©æ”¾ç­‰åŠ¨ç”»ï¼Œå®ƒä¹Ÿä¸èƒ½æ”¾åœ¨å…¶å®ƒ ViewGroup ä¸­ï¼ŒSurfaceView ä¸èƒ½åµŒå¥—ä½¿ç”¨ï¼Œè€Œä¸”ä¸èƒ½ä½¿ç”¨æŸäº› View çš„ç‰¹æ€§ï¼Œä¾‹å¦‚ View.setAlpha()ã€‚ ä» Android7.0 å¼€å§‹ï¼ŒSurfaceView çš„çª—å£ä½ç½®ä¸å…¶ä»– View æ¸²æŸ“åŒæ­¥æ›´æ–°ã€‚è¿™æ„å‘³ç€åœ¨å±å¹•ä¸Šå¹³ç§»å’Œç¼©æ”¾ SurfaceView ä¸ä¼šå¯¼è‡´æ¸²æŸ“å¤±çœŸã€‚ 3 TextureViewå› ä¸ºä¸Šé¢æ‰€è¯´çš„ SurfaceView ä¸åœ¨ä¸»çª—å£ä¸­ï¼Œå®ƒæ²¡æ³•åšåŠ¨ç”»æ²¡æ³•ä½¿ç”¨ä¸€äº› View çš„ç‰¹æ€§æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨ Android 4.0ä¸­å¼•å…¥äº† TextureViewï¼Œå®ƒæ˜¯ä¸€ä¸ªç»“åˆäº† View å’Œ SurfaceTexture çš„ View å¯¹è±¡ã€‚ TextureView æ˜¯ä¸€ä¸ªå¯ä»¥æŠŠå†…å®¹æµä½œä¸ºå¤–éƒ¨çº¹ç†è¾“å‡ºåœ¨ä¸Šé¢çš„ Viewï¼Œå’Œ SurfaceView ä¸åŒï¼Œå®ƒä¸ä¼šåœ¨ WMS ä¸­å•ç‹¬åˆ›å»ºçª—å£ï¼Œè€Œæ˜¯ä½œä¸º View hierachy ä¸­çš„ä¸€ä¸ªæ™®é€š viewï¼Œå› æ­¤å®ƒå¯ä»¥å’Œå…¶ä»–æ™®é€š View ä¸€æ ·è¿›è¡Œå¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾ç­‰åŠ¨ç”»ã€‚ä½†æ˜¯ TextureView å¿…é¡»åœ¨ç¡¬ä»¶åŠ é€Ÿçš„çª—å£ä¸­ï¼Œå®ƒæ˜¾ç¤ºçš„å†…å®¹æµæ•°æ®å¯ä»¥æ¥è‡ª App è¿›ç¨‹æˆ–è€…è¿œç¨‹è¿›ç¨‹ã€‚ TextureView ç»§æ‰¿è‡ª Viewï¼Œå®ƒä¸å…¶å®ƒçš„ View ä¸€æ ·åœ¨ View hierachy ä¸­ç®¡ç†ä¸ç»˜åˆ¶ã€‚TextureView é‡è½½äº† draw() æ–¹æ³•ï¼Œå…¶ä¸­ä¸»è¦ SurfaceTexture ä¸­æ”¶åˆ°çš„å›¾åƒæ•°æ®ä½œä¸ºçº¹ç†æ›´æ–°åˆ°å¯¹åº”çš„ HardwareLayer ä¸­ã€‚ SurfaceTexture.OnFrameAvailableListener ç”¨äºé€šçŸ¥ TextureView å†…å®¹æµæœ‰æ–°å›¾åƒåˆ°æ¥ã€‚SurfaceTextureListener æ¥å£ç”¨äºè®© TextureView çš„ä½¿ç”¨è€…çŸ¥é“ SurfaceTexture å·²å‡†å¤‡å¥½ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠ SurfaceTexture äº¤ç»™ç›¸åº”çš„å†…å®¹æºã€‚ Surface ä¸º BufferQueue çš„ Producer æ¥å£å®ç°ç±»ï¼Œä½¿ç”Ÿäº§è€…å¯ä»¥é€šè¿‡å®ƒçš„è½¯ä»¶æˆ–ç¡¬ä»¶æ¸²æŸ“æ¥å£ä¸º SurfaceTexture å†…éƒ¨çš„ BufferQueue æä¾› graphic bufferã€‚ SurfaceTexture å¯ä»¥ç”¨ä½œéç›´æ¥è¾“å‡ºçš„å†…å®¹æµï¼Œè¿™æ ·å°±æä¾›äºŒæ¬¡å¤„ç†çš„æœºä¼šã€‚ä¸ SurfaceView ç›´æ¥è¾“å‡ºç›¸æ¯”ï¼Œè¿™æ ·ä¼šæœ‰è‹¥å¹²å¸§çš„å»¶è¿Ÿã€‚åŒæ—¶ï¼Œç”±äºå®ƒæœ¬èº«ç®¡ç† BufferQueueï¼Œå› æ­¤å†…å­˜æ¶ˆè€—ä¹Ÿä¼šç¨å¾®å¤§ä¸€äº›ã€‚ 4 SurfaceTextureSurfaceTexture æ˜¯ Surface å’Œ OpenGL ES(GLES) çº¹ç†çš„ç»„åˆã€‚SurfaceTexture ç”¨äºæä¾›è¾“å‡ºåˆ° GLES çº¹ç†çš„ Surfaceã€‚ SurfaceTexture æ˜¯ä» Android 3.0(API level 11)å¼€å§‹åŠ å…¥ï¼Œä¸ SurfaceView ä¸åŒçš„æ˜¯ï¼Œå®ƒå¯¹å›¾åƒæµçš„å¤„ç†å¹¶ä¸ç›´æ¥æ˜¾ç¤ºï¼Œè€Œæ˜¯è½¬ä¸º GL å¤–éƒ¨çº¹ç†ï¼Œå› æ­¤ç”¨äºå›¾åƒæµæ•°æ®çš„äºŒæ¬¡å¤„ç†ã€‚ æ¯”å¦‚ Camera çš„é¢„è§ˆæ•°æ®ï¼Œå˜æˆçº¹ç†åå¯ä»¥äº¤ç»™ GLSurfaceView ç›´æ¥æ˜¾ç¤ºï¼Œä¹Ÿå¯ä»¥é€šè¿‡ SurfaceTexture äº¤ç»™TextureView ä½œä¸º View heirachy ä¸­çš„ä¸€ä¸ªç¡¬ä»¶åŠ é€Ÿå±‚æ¥æ˜¾ç¤ºã€‚ é¦–å…ˆï¼ŒSurfaceTexture ä»å›¾åƒæµ ï¼ˆæ¥è‡ª Camera é¢„è§ˆã€è§†é¢‘è§£ç ã€GL ç»˜åˆ¶åœºæ™¯ç­‰ï¼‰ä¸­è·å¾—å¸§æ•°æ®ï¼Œå½“è°ƒç”¨updateTexImage()æ—¶ï¼Œæ ¹æ®å†…å®¹æµä¸­æœ€è¿‘çš„å›¾åƒæ›´æ–° SurfaceTexture å¯¹åº”çš„ GL çº¹ç†å¯¹è±¡ã€‚ SurfaceTexture åŒ…å«ä¸€ä¸ªåº”ç”¨æ˜¯å…¶ä½¿ç”¨æ–¹çš„ BufferQueueã€‚å½“ç”Ÿäº§æ–¹å°†æ–°çš„ç¼“å†²åŒºæ’å…¥é˜Ÿåˆ—æ—¶ï¼ŒonFrameAvailable() å›è°ƒä¼šé€šçŸ¥åº”ç”¨ã€‚ç„¶åï¼Œåº”ç”¨è°ƒç”¨ updateTexImage()ï¼Œè¿™ä¼šé‡Šæ”¾å…ˆå‰å æœ‰çš„ç¼“å†²åŒºï¼Œä»é˜Ÿåˆ—ä¸­è·å–æ–°ç¼“å†²åŒºå¹¶æ‰§è¡Œ EGL è°ƒç”¨ï¼Œä»è€Œä½¿ GLES å¯å°†æ­¤ç¼“å†²åŒºä½œä¸ºå¤–éƒ¨çº¹ç†ä½¿ç”¨ã€‚ 5 SurfaceView ä¸ TextureView çš„å¯¹æ¯” é¡¹ç›® SurfaceView TextureView å†…å­˜ ä½ é«˜ è€—ç”µ ä½ é«˜ ç»˜åˆ¶ åŠæ—¶ 1-3å¸§å»¶è¿Ÿ åŠ¨ç”»å’Œæˆªå›¾ ä¸æ”¯æŒ æ”¯æŒ ä»æ€§èƒ½å’Œå®‰å…¨æ€§è§’åº¦å‡ºå‘ï¼Œä¼˜å…ˆé€‰ SurfaceViewï¼ŒTextureView æ˜¯ä¸€ä¸ªä¸å¾—å·²çš„é€‰æ‹©ï¼š åœ¨ Android 7.0 ä¸Šç³»ç»Ÿ Surfaceview çš„æ€§èƒ½æ¯” TextureView æ›´æœ‰ä¼˜åŠ¿ï¼Œæ”¯æŒå¯¹è±¡çš„å†…å®¹ä½ç½®å’ŒåŒ…å«çš„åº”ç”¨å†…å®¹åŒæ­¥æ›´æ–°ï¼Œå¹³ç§»ã€ç¼©æ”¾ä¸ä¼šäº§ç”Ÿé»‘è¾¹ã€‚ åœ¨7.0ä»¥ä¸‹ç³»ç»Ÿå¦‚æœä½¿ç”¨åœºæ™¯æœ‰åŠ¨ç”»æ•ˆæœï¼Œå¯ä»¥é€‰æ‹©æ€§ä½¿ç”¨TextureViewã€‚ ç”±äºå¤±æ•ˆï¼ˆinvalidationï¼‰å’Œç¼“å†²çš„ç‰¹æ€§ï¼ŒTextureView å¢åŠ äº†é¢å¤–1~3å¸§çš„å»¶è¿Ÿæ˜¾ç¤ºç”»é¢æ›´æ–°ã€‚ TextureView æ€»æ˜¯ä½¿ç”¨ GL åˆæˆï¼Œè€Œ SurfaceView å¯ä»¥ä½¿ç”¨ç¡¬ä»¶ overlay åç«¯ï¼Œå¯ä»¥å ç”¨æ›´å°‘çš„å†…å­˜ã€‚ TextureView çš„å†…éƒ¨ç¼“å†²é˜Ÿåˆ—å¯¼è‡´æ¯” SurfaceView ä½¿ç”¨æ›´å¤šçš„å†…å­˜ã€‚ SurfaceView å†…éƒ¨è‡ªå·±æŒæœ‰ Surfaceï¼ŒSurface åˆ›å»ºã€é”€æ¯ã€å¤§å°æ”¹å˜æ—¶ç³»ç»Ÿæ¥å¤„ç†çš„ï¼Œé€šè¿‡ SurfaceHolder çš„ callback å›è°ƒé€šçŸ¥ã€‚ å½“ç”»å¸ƒåˆ›å»ºå¥½æ—¶ï¼Œå¯ä»¥å°† surface ç»‘å®šåˆ° MediaPlayer ä¸­ã€‚SurfaceView å¦‚æœä¸ºç”¨æˆ·å¯è§çš„æ—¶å€™ï¼Œåˆ›å»º SurfaceView çš„ SurfaceHolder ç”¨äºæ˜¾ç¤ºè§†é¢‘æµè§£æçš„å¸§å›¾ç‰‡ï¼Œå¦‚æœå‘ç° SurfaceView å˜ä¸ºç”¨æˆ·ä¸å¯è§çš„æ—¶å€™ï¼Œåˆ™ç«‹å³é”€æ¯ SurfaceView çš„ SurfaceHolderï¼Œä»¥è¾¾åˆ°èŠ‚çº¦ç³»ç»Ÿèµ„æºçš„ç›®çš„ã€‚ ä½œè€…ï¼šByteSaidé“¾æ¥ï¼šhttps://juejin.cn/post/7156157715230752782æ¥æºï¼šç¨€åœŸæ˜é‡‘è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚ SurfaceFlinger SurfaceFlinger æ¥å—ç¼“å†²åŒºï¼Œå¯¹å®ƒä»¬è¿›è¡Œåˆæˆï¼Œç„¶åå‘é€åˆ°å±å¹•ã€‚WindowManager ä¸º SurfaceFlinger æä¾›ç¼“å†²åŒºå’Œçª—å£å…ƒæ•°æ®ï¼Œè€Œ SurfaceFlinger å¯ä½¿ç”¨è¿™äº›ä¿¡æ¯å°† Surface åˆæˆåˆ°å±å¹•ã€‚ SurfaceFlinger ç”¨æ¥ç®¡ç†æ¶ˆè´¹å½“å‰å¯è§çš„ Surface, æ‰€æœ‰è¢«æ¸²æŸ“çš„å¯è§ Surface éƒ½ä¼šè¢« SurfaceFlinger é€šè¿‡ WindowManager æä¾›çš„ä¿¡æ¯åˆæˆ(ä½¿ç”¨ OpenGL å’Œ HardWare Composer)æäº¤åˆ°å±å¹•çš„åç¼“å†²åŒºï¼Œç­‰å¾…å±å¹•çš„ä¸‹ä¸€ä¸ª Vsync ä¿¡å·åˆ°æ¥ï¼Œå†æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚SufaceFlinger é€šè¿‡å±å¹•åç¼“å†²åŒºä¸å±å¹•å»ºç«‹è”ç³»ï¼ŒåŒæ—¶é€šè¿‡ Surface ä¸ä¸Šå±‚å»ºç«‹è”ç³»ï¼Œèµ·åˆ°äº†ä¸€ä¸ªæ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ã€‚ å¯åŠ¨åœ¨ SurfaceFlinger çš„å¯åŠ¨æµç¨‹ä¸­ï¼š é¦–å…ˆä¼šåˆ›å»º SurfaceFlinger å¯¹è±¡ï¼Œåœ¨æ„é€ å™¨ä¸­åˆ›å»ºäº† DispSync åŒæ­¥æ¨¡å‹å¯¹è±¡ï¼› ç„¶åæ‰§è¡Œåˆå§‹åŒ– SurfaceFlinger çš„é€»è¾‘ï¼š æ³¨å†Œç›‘å¬ï¼Œæ¥æ”¶ HWC çš„ç›¸å…³äº‹ä»¶ã€‚ å¯åŠ¨ APP å’Œ SF çš„ EventThread çº¿ç¨‹ï¼Œç”¨æ¥ç®¡ç†åŸºäº DispSync åˆ›å»ºçš„ä¸¤ä¸ª DispSyncSource å»¶æ—¶æºå¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯ç”¨äºç»˜åˆ¶(appâ€“mEventThreadSource)å’Œåˆæˆ(SurfaceFlingerâ€“mSfEventThreadSource)ã€‚å¯åŠ¨äº† EventThread çº¿ç¨‹åï¼Œä¼šä¸€ç›´é˜»å¡åœ¨ waitForEventLocked æ–¹æ³•ä¸­(æœŸé—´ä¼šæ ¹æ®éœ€è¦è®¾ç½®ç›‘å¬å™¨)ï¼Œç›´åˆ°æ¥æ”¶åˆ° Vsync ä¿¡å·ä¸”è‡³å°‘æœ‰ä¸€ä¸ªè¿æ¥æ­£åœ¨ç­‰å¾… Vsync ä¿¡å·æ‰ä¼šç»§ç»­æ‰§è¡Œçº¿ç¨‹é€»è¾‘ï¼Œå³é€šçŸ¥ç›‘å¬è€…ï¼› é€šè¿‡ MessageQueue.setEventThread æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªè¿æ¥ï¼Œå¹¶é€šè¿‡ Looper.addFd æ–¹æ³•ç›‘å¬ BitTube æ•°æ®ã€‚ åˆ›å»º HWComposer å¯¹è±¡(é€šè¿‡ HAL å±‚çš„ HWComposer ç¡¬ä»¶æ¨¡å— æˆ– è½¯ä»¶æ¨¡æ‹Ÿäº§ç”Ÿ Vsync ä¿¡å·)ï¼Œç°åœ¨çš„ Android ç³»ç»ŸåŸºæœ¬ä¸Šéƒ½å¯ä»¥çœ‹æˆæ˜¯é€šè¿‡ç¡¬ä»¶ HWComposer äº§ç”Ÿ Vsync ä¿¡å·ï¼Œè€Œä¸ä½¿ç”¨è½¯ä»¶æ¨¡æ‹Ÿï¼Œæ‰€ä»¥ä¸‹é¢è§£æéƒ½åªè°ˆåŠç¡¬ä»¶ HWComposer çš„ Vsync ä¿¡å·ï¼› åˆå§‹åŒ–éè™šæ‹Ÿçš„æ˜¾ç¤ºå±ï¼› å¯åŠ¨å¼€æœºåŠ¨ç”»æœåŠ¡ï¼› æœ€åæ‰§è¡Œ SurfaceFlinger.run é€»è¾‘ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨ SurfaceFlinger ä¸»çº¿ç¨‹é€šè¿‡æ­»å¾ªç¯æ‰§è¡Œ MessageQueue.waitMessage æ–¹æ³•ç­‰å¾…æ¶ˆæ¯çš„åˆ°æ¥ï¼Œå…¶å†…éƒ¨è°ƒç”¨äº† Looper.pollOnce æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šä» Looper.addFd æ–¹æ³•ç›‘å¬çš„ BitTube ä¸­è¯»å–æ•°æ®ï¼Œå½“æœ‰æ•°æ®åˆ°æ¥æ—¶æ‰§è¡Œå¯¹åº”çš„å›è°ƒæ–¹æ³•ã€‚ å½“ç¡¬ä»¶æˆ–è½¯ä»¶æ¨¡æ‹Ÿå‘å‡º Vsync ä¿¡å·æ—¶ï¼š å›è°ƒ SF ç›¸å…³æ–¹æ³•ï¼ŒSF è°ƒç”¨ DispSync åŒæ­¥æ¨¡å‹çš„æ–¹æ³•å¤„ç† Vsync ä¿¡å·(ç»Ÿè®¡å’Œè®¡ç®—æ¨¡å‹çš„åç§»å’Œå‘¨æœŸ)ï¼Œå¹¶æ ¹æ®è¿”å›å€¼åˆ¤æ–­æ˜¯å¦ä½¿èƒ½/å…³é—­ HWC Vsync ä¿¡å·çš„å‘å‡ºã€‚ DispSync æ ¹æ®è®¡ç®—çš„åç§»å’Œå‘¨æœŸè®¡ç®—ä¸‹æ¬¡ Vsync ä¿¡å·å‘ç”Ÿæ—¶é—´ï¼Œå¹¶é€šçŸ¥ç›‘å¬è€… Vsync ä¿¡å·åˆ°è¾¾çš„äº‹ä»¶ï¼Œä¼ é€’ç»™ DispSyncSource å»¶æ—¶æºï¼Œå»¶æ—¶æºé€šè¿‡ EventThread æ¥ç®¡ç† Vsync ä¿¡å·çš„æ”¶å‘ã€‚ EventThread è°ƒç”¨è¿æ¥ Connection å¯¹è±¡å‘ BitTube å‘é€æ•°æ®ï¼Œè§¦å‘ addFd å‡½æ•°ä¸­è®¾ç½®çš„å›è°ƒæ–¹æ³•ï¼Œå›è°ƒæ–¹æ³•è¿›è€Œè°ƒç”¨ SF.onMessageReceived å‡½æ•°ï¼Œç„¶åè¿›è¡Œå›¾åƒçš„åˆæˆç­‰å·¥ä½œã€‚ å¦ä¸€æ–¹é¢ï¼ŒChoreographer ä¼šé€šè¿‡ä¸Šé¢åˆ›å»ºçš„ APP å»¶æ—¶æº mEventThreadSource å¯¹è±¡åŠå…¶å¯¹åº”çš„ EventThread çº¿ç¨‹æ¥ç›‘å¬åŒæ­¥æ¨¡æ‹Ÿå‘å‡ºçš„ Vsync ä¿¡å·ï¼Œç„¶åè¿›è¡Œç»˜åˆ¶(measure/layout/draw)æ“ä½œã€‚å…·ä½“é€»è¾‘è§ Android-ChoreographeråŸç†ã€‚ å°† SurfaceFlinger çš„å·¥ä½œæµç¨‹æ€»ç»“å¦‚ä¸‹å›¾ï¼š åˆæˆBufferQueue","link":"/2021/07/29/Surface/"},{"title":"SystemStartProcess","text":"ç®€è¿°ï¼š å¼€æœºåç³»ç»Ÿå°†Romæ–‡ä»¶åŠ è½½è¿›Ramå†…å­˜ä¸­ï¼Œloaderæ£€æŸ¥Ramï¼Œkernelå¯åŠ¨Swapperè¿›ç¨‹å’Œkthreaddè¿›ç¨‹ï¼ˆåˆ›å»ºå†…æ ¸å®ˆæŠ¤è¿›ç¨‹ï¼‰ã€‚ NativeFrameworkä¸­init.cppè¿è¡Œåå¯åŠ¨initè¿›ç¨‹ï¼Œinitè¿›ç¨‹è§£æinit.rcæ–‡ä»¶åï¼Œå­µåŒ–å¦‚installdã€logdã€adbdç­‰ç”¨æˆ·å®ˆæŠ¤è¿›ç¨‹ã€å¯åŠ¨servicemanagerã€surfaceflingerã€bootanimç­‰æœåŠ¡ã€å­µåŒ–å‡ºZygoteè™šæ‹Ÿæœºè¿›ç¨‹(javaè¿›ç¨‹)ã€‚ JavaFrameworkä¸­Zygoteæ³¨å†ŒZygoteSocketã€åŠ è½½è™šæ‹Ÿæœºã€é¢„åŠ è½½é€šç”¨ç±»ã€èµ„æºï¼›ä¹‹åå­µåŒ–system_serverè¿›ç¨‹ï¼Œå¯åŠ¨å¦‚AMS(startServiceå¯ç›‘å¬RootPhase)ã€WMSã€PKMSã€PMSç­‰æœåŠ¡ã€‚ Appï¼šç”±Zygoteå­µåŒ–çš„ç¬¬ä¸€ä¸ªAppâ€”â€”Launcher(æ¡Œé¢)ï¼Œç”¨æˆ·ç‚¹å‡»Launcherä¸Šçš„appå›¾ç‰‡ï¼Œé€šè¿‡JNIè°ƒç”¨AMSä»Zygoteè¿›ç¨‹ä¸­forkå‡ºæ–°çš„Appã€‚ ps:ServiceManager.addService()å¯åŠ¨WMSã€PKMSã€IMSç­‰æœåŠ¡ï¼ŒSystemServiceManager.startService()å¯åŠ¨AMSã€PMS ç³»ç»Ÿå¯åŠ¨æµç¨‹ï¼šBootRom-&gt;BootLoader-&gt;Linux Kernel-&gt;Init-&gt;Zygote-&gt;SystemServer-&gt;Launcher(UI) BootLoaderå±‚ï¼šä¸»è¦åŒ…æ‹¬Boot Romå’ŒBoot Loader Kernelå±‚ï¼šä¸»è¦æ˜¯Androidå†…æ ¸å±‚ Nativeå±‚ï¼šä¸»è¦æ˜¯åŒ…æ‹¬initè¿›ç¨‹ä»¥åŠå…¶forkå‡º æ¥çš„ç”¨æˆ·ç©ºé—´çš„å®ˆæŠ¤è¿›ç¨‹ã€HALå±‚ã€å¼€æœºåŠ¨ç”»ç­‰ JAVA Frameworkå±‚ï¼šä¸»è¦æ˜¯AMSã€WMSã€PMSç­‰Serviceçš„åˆå§‹åŒ– Applicationå±‚ï¼šä¸»è¦æŒ‡SystemUIã€Launcherçš„å¯åŠ¨ ç”µæºé”®æŒ‰ä¸‹ -&gt; Loader &amp; Kernel BootLoader åŠ è½½ rom åˆ° ram linuxå†…æ ¸è¿›ç¨‹ - åˆ›å»ºswapper(pid=0) ;å†…æ ¸å®ˆæŠ¤è¿›ç¨‹kthreadd(pid=2) ä¸ å„ç±»é©±åŠ¨å¦‚binder driver -&gt; native framework init(pid=1)è¿›ç¨‹ï¼Œ è§£æå¹¶è¿è¡Œæ‰€æœ‰çš„init.rcç›¸å…³æ–‡ä»¶ï¼Œå­µåŒ–å‡ºinstalldã€adbdç­‰ç”¨æˆ·å®ˆæŠ¤è¿›ç¨‹ï¼›å¯åŠ¨zygoteã€servicemanagerå’ŒsurfaceflingeræœåŠ¡è¿›ç¨‹ï¼›å­µåŒ–Zygoteè¿›ç¨‹(java) initè¿›ç¨‹ä¼šå­µåŒ–å‡ºueventdã€logdã€healthdã€installdã€adbdã€lmkdç­‰ç”¨æˆ·å®ˆæŠ¤è¿›ç¨‹ï¼› initè¿›ç¨‹è¿˜å¯åŠ¨servicemanagerã€surfaceflingerã€bootanim(å¼€æœºåŠ¨ç”»)ç­‰é‡è¦æœåŠ¡è¿›ç¨‹ initè¿›ç¨‹å­µåŒ–å‡ºZygoteè¿›ç¨‹ï¼ŒZygoteè¿›ç¨‹æ˜¯Androidç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªJavaè¿›ç¨‹(å³è™šæ‹Ÿæœºè¿›ç¨‹) (Native FrameWorkå±‚)Media Serverè¿›ç¨‹ï¼Œæ˜¯ç”±initè¿›ç¨‹forkè€Œæ¥ï¼Œè´Ÿè´£å¯åŠ¨å’Œç®¡ç†æ•´ä¸ªC++ frameworkï¼ŒåŒ…å«AudioFlingerï¼ŒCamera Serviceç­‰æœåŠ¡ã€‚ -&gt; java framework - Zygote Zygote ï¼ˆåˆ›å»ºè™šæ‹ŸæœºAndroidRunTime/VM + é¢„åŠ è½½ç±»å’Œèµ„æº ï¼ŒåŒæ—¶æ‰€æœ‰appè¿›ç¨‹ï¼ŒåŒ…æ‹¬â€ç¬¬ä¸€ä¸ªappï¼šæ¡Œé¢/Launchâ€ï¼Œç”±zygote forkå‡ºï¼Œç»§æ‰¿zygoteæ‹¥æœ‰çš„ä¸€åˆ‡ï¼‰ Zygoteè¿›ç¨‹ï¼Œæ˜¯ç”±initè¿›ç¨‹é€šè¿‡è§£æinit.rcæ–‡ä»¶åforkç”Ÿæˆçš„ï¼ŒZygoteè¿›ç¨‹ä¸»è¦åŒ…å«ï¼š åŠ è½½ZygoteInitç±»ï¼Œæ³¨å†ŒZygote SocketæœåŠ¡ç«¯å¥—æ¥å­— åŠ è½½è™šæ‹Ÿæœº Dalivk/ART æå‰åŠ è½½ç±»preloadClasses æå‰åŠ è½½èµ„æºpreloadResouces -&gt; java framework - system_server system_server (å› ä»zygote forkè€Œæ¥ï¼Œæ•…å…·æœ‰AndroidRunTime/VM ä¸é¢„åŠ è½½çš„ç±»ä¸èµ„æº copy on writeæœºåˆ¶ ï¼Œç”±æ­¤å¼€å§‹å¯åŠ¨çº¿ç¨‹æ‰¿è½½ActivityManagerï¼ŒWindowManagerï¼ŒPackageManagerï¼ŒPowerManagerç­‰æœåŠ¡ã€‚ç®¡ç†æ‰€æœ‰app) System Serverè¿›ç¨‹ï¼Œæ˜¯ç”±Zygoteè¿›ç¨‹forkè€Œæ¥ï¼ŒSystem Serveræ˜¯Zygoteå­µåŒ–çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ŒSystem Serverè´Ÿè´£å¯åŠ¨å’Œç®¡ç†æ•´ä¸ªJava frameworkï¼ŒåŒ…å«ActivityManagerï¼ŒWindowManagerï¼ŒPackageManagerï¼ŒPowerManagerç­‰æœåŠ¡ï¼ˆé€šè¿‡context.getSystemService(String)å¯è·å¾—ï¼‰ã€‚ é™„å½• initå¯åŠ¨è¿‡ç¨‹init.cppè¿›ç¨‹è§£æçš„init.rcæ–‡ä»¶ initè¿›ç¨‹æ˜¯Linuxç³»ç»Ÿä¸­ç”¨æˆ·ç©ºé—´çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹å·å›ºå®šä¸º1ã€‚Kernelå¯åŠ¨åï¼Œåœ¨ç”¨æˆ·ç©ºé—´å¯åŠ¨initè¿›ç¨‹ï¼Œå¹¶è°ƒç”¨initä¸­çš„main()æ–¹æ³•æ‰§è¡Œinitè¿›ç¨‹çš„èŒè´£ã€‚å¯¹äºinitè¿›ç¨‹çš„åŠŸèƒ½åˆ†ä¸º4éƒ¨åˆ†ï¼š åˆ›å»ºä¸€å—å…±äº«çš„å†…å­˜ç©ºé—´ï¼Œç”¨äºå±æ€§æœåŠ¡å™¨; è§£æå¹¶è¿è¡Œæ‰€æœ‰çš„init.rcç›¸å…³æ–‡ä»¶ï¼ˆå­µåŒ–å‡ºueventdã€logdã€healthdã€installdã€adbdã€lmkdç­‰ç”¨æˆ·å®ˆæŠ¤è¿›ç¨‹ï¼›å¯åŠ¨zygoteã€servicemanagerå’ŒsurfaceflingeræœåŠ¡è¿›ç¨‹ï¼‰ //æ³¨ï¼š7.0ä¹‹å‰çš„ç‰ˆæœ¬ï¼ŒæœåŠ¡è¿›ç¨‹çš„å¯åŠ¨éƒ½æ˜¯ç›´æ¥å†™åœ¨init.rcä¸­çš„ï¼Œ7.0ä¹‹åinit.rcè¢«æ‹†åˆ†æˆå¤šä¸ªï¼Œæ¯”å¦‚bootanimation.rc,surfacefligner.rcç­‰ ã€epollæœºåˆ¶ã€‘è¿›å…¥æ­»å¾ªç¯epoll_waitç­‰å¾…æ¶ˆæ¯ï¼Œç›´åˆ°ç³»ç»Ÿå±æ€§å˜åŒ–äº‹ä»¶(property_setæ”¹å˜å±æ€§å€¼)ï¼Œæˆ–è€…æ”¶åˆ°å­è¿›ç¨‹çš„ä¿¡å·SIGCHLDï¼Œå†æˆ–è€…keychord é”®ç›˜è¾“å…¥äº‹ä»¶åˆ™å”¤é†’ é™„å½• Zygoteå¯åŠ¨è¿‡ç¨‹Zygoteæ˜¯ç”±initè¿›ç¨‹é€šè¿‡è§£æinit.zygote.rcæ–‡ä»¶è€Œåˆ›å»ºçš„ï¼Œzygoteæ‰€å¯¹åº”çš„å¯æ‰§è¡Œç¨‹åºapp_processï¼Œæ‰€å¯¹åº”çš„æºæ–‡ä»¶æ˜¯App_main.cppï¼Œè¿›ç¨‹åä¸ºzygoteã€‚ Zygoteè¿›ç¨‹ ï¼Œ å®ƒç”± initè¿›ç¨‹ å¯åŠ¨ï¼Œå¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªDavlikè™šæ‹Ÿæœºå®ä¾‹ï¼Œå¹¶æŠŠJavaè¿è¡Œæ—¶åº“åŠ è½½åˆ°è¿›ç¨‹ä¸­ï¼Œå¹¶æ³¨å†Œä¸€äº›Androidæ ¸å¿ƒç±»çš„JNIåˆ°å‰é¢åˆ›å»ºçš„Dalvikè™šæ‹Ÿæœºå®ä¾‹ä¸­ã€‚ 123456789101112131415service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server class main socket zygote stream 660 root system onrestart write /sys/android_power/request_state wake onrestart write /sys/power/state on onrestart restart media onrestart restart netd //service â†’ ATLè¯­è¨€è¯­æ³•ï¼Œå¯åŠ¨ä¸€ä¸ªæœåŠ¡è¿›ç¨‹ï¼›zygote â†’ å¯åŠ¨çš„ç¨‹åºåç§°ï¼Œè¿™æŒ‡zygoteè¿›ç¨‹ï¼›/system/bin/app_process â†’ å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„( app_main.cpp )ï¼›-Xzygote /system/bin â†’ æŒ‡å®šå‚æ•°ä¼ åˆ°app_main.cppä¸­ï¼›--zygote --start-system-server â†’ ä¼ çš„å…·ä½“å‚æ•°å€¼ï¼›ç®€å•ç‚¹è¯´å°±æ˜¯ï¼šå¯åŠ¨äº†Zygoteè¿›ç¨‹ï¼Œä¼ é€’çš„å‚æ•°å¯åœ¨ /frameworks/base/cmds/app_process/app_main.cpp ä¸­æ‰¾åˆ°. //app_main.cpp: å¯¹ä¼ è¿›æ¥çš„å‚æ•°åšåŒ¹é…ï¼Œzygoteã€startSystemæ ‡å¿—ä½è®¾ç½®ä¸ºtrueï¼Œæ¥ç€å®šä½ä¸‹å“ªé‡Œç”¨åˆ°äº†zygoteè¿™ä¸ªæ ‡è®°ï¼š è·Ÿä¸‹ï¼š**runtime.start()** å®šä½åˆ° frameworks/base/core/jni/**AndroidRuntime.cpp**ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132// â‘  åˆå§‹åŒ–jniæ¥å£JniInvocation jni_invocation;jni_invocation.Init(NULL);// â‘¡ åˆ›å»ºVMè™šæ‹ŸæœºJNIEnv* env;if (startVm(&amp;mJavaVM, &amp;env) != 0) { return;}onVmCreated(env);// â‘¢ æ³¨å†ŒJNIæ–¹æ³•if (startReg(env) &lt; 0) { ALOGE(&quot;Unable to register all android natives\\n&quot;); return;}// â‘£ è°ƒç”¨classNameç±»çš„static void main(String args[]) æ–¹æ³•slashClassName = toSlashClassName(className);jclass startClass = env-&gt;FindClass(slashClassName);// æ‰¾åˆ°mainå‡½æ•°jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, &quot;main&quot;, &quot;([Ljava/lang/String;)V&quot;);if (startMeth == NULL) { ALOGE(&quot;JavaVM unable to find main() in '%s'\\n&quot;, className); /* keep going */} else { // é€šè¿‡ JNI è°ƒç”¨ main å‡½æ•°ï¼Œä» C++ åˆ° Java env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray); if (env-&gt;ExceptionCheck()) threadExitUncaughtException(env);} æ‰€ä»¥è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œæ³¨å†ŒJNIæ–¹æ³•ï¼Œç„¶åè°ƒç”¨ com.android.internal.os.ZygoteInit çš„ **main()ï¼Œè·Ÿä¸‹frameworks/base/core/java/com/android/internal/os/ZygoteInit.java**ï¼š 123456789101112131415161718192021222324252627282930313233public static void main(String argv[]) { try { ... // â‘  æ³¨å†Œä¸€ä¸ªnameä¸ºzygoteçš„socketï¼Œç”¨äºå’Œå…¶ä»–è¿›ç¨‹é€šä¿¡ registerZygoteSocket(socketName); // â‘¡ é¢„åŠ è½½æ‰€éœ€èµ„æºåˆ°VMä¸­ï¼Œå¦‚classã€resourceã€OpenGLã€å…¬ç”¨Libraryç­‰ï¼› // æ‰€æœ‰forkçš„å­è¿›ç¨‹å…±äº«è¿™ä»½ç©ºé—´è€Œæ— éœ€é‡æ–°åŠ è½½ï¼Œå‡å°‘äº†åº”ç”¨ç¨‹åºçš„å¯åŠ¨æ—¶é—´ï¼Œ // ä½†ä¹Ÿå¢åŠ äº†ç³»ç»Ÿçš„å¯åŠ¨æ—¶é—´ï¼ŒAndroidå¯åŠ¨æœ€è€—æ—¶çš„éƒ¨åˆ†ä¹‹ä¸€ã€‚ preload(); // â‘¢ åˆå§‹åŒ–gcï¼Œåªæ˜¯é€šçŸ¥VMè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå…·ä½“å›æ”¶æ—¶é—´ã€æ€ä¹ˆå›æ”¶ï¼Œç”±VMå†…éƒ¨ç®—æ³•å†³å®šã€‚ // gc()éœ€åœ¨forkå‰å®Œæˆï¼Œè¿™æ ·å°†æ¥å¤åˆ¶çš„å­è¿›ç¨‹æ‰èƒ½æœ‰å°½å¯èƒ½å°‘çš„åƒåœ¾å†…å­˜æ²¡é‡Šæ”¾ï¼› gcAndFinalize(); // â‘£ å¯åŠ¨system_serverï¼Œå³forkä¸€ä¸ªZygoteå­è¿›ç¨‹ if (startSystemServer) { startSystemServer(abiList, socketName); } // â‘¤ è¿›å…¥å¾ªç¯æ¨¡å¼ï¼Œè·å–å®¢æˆ·ç«¯è¿æ¥å¹¶å¤„ç† runSelectLoop(abiList); // â‘¥ å…³é—­å’Œæ¸…ç†zygote socket closeServerSocket(); } catch (MethodAndArgsCaller caller) { caller.run(); } catch (RuntimeException ex) { Log.e(TAG, &quot;Zygote died with exception&quot;, ex); closeServerSocket(); throw ex; }} è·Ÿä¸‹ **startSystemServer()**ï¼š 1234567891011121314151617181920212223242526272829private static boolean startSystemServer(String abiList, String socketName) throws MethodAndArgsCaller, RuntimeException { int pid; try { ... // forkå‡ºsystem_serverè¿›ç¨‹ï¼Œè¿”å›pidï¼Œæ­¤å¤„pidä¸º0 pid = Zygote.forkSystemServer( parsedArgs.uid, parsedArgs.gid, parsedArgs.gids, parsedArgs.debugFlags, null, parsedArgs.permittedCapabilities, parsedArgs.effectiveCapabilities); } catch (IllegalArgumentException ex) { throw new RuntimeException(ex); } /* è¿›å…¥å­è¿›ç¨‹ */ if (pid == 0) { // Android 5.0ä¸Šæœ‰ä¸¤ä¸ªZygoteè¿›ç¨‹ï¼šzygote å’Œ zygote64 // å¯¹äºæœ‰ä¸¤ä¸ªzygoteè¿›ç¨‹çš„æƒ…å†µï¼Œéœ€ç­‰å¾…ç¬¬äºŒä¸ªzygoteåˆ›å»ºå®Œæˆï¼› if (hasSecondZygote(abiList)) { waitForSecondaryZygote(socketName); } // å®Œæˆsystem_serverè¿›ç¨‹çš„å‰©ä½™å·¥ä½œ handleSystemServerProcess(parsedArgs); } return true;} Tipsï¼šfork()æ–¹æ³•è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œè¿”å›ä¸¤æ¬¡ï¼ŒåŒºåˆ«æ˜¯ï¼šå­è¿›ç¨‹çš„è¿”å›å€¼æ˜¯0ï¼Œçˆ¶è¿›ç¨‹çš„è¿”å›å€¼æ˜¯å­è¿›ç¨‹çš„è¿›ç¨‹idï¼Œå¯ä»¥ä¿è¯å­è¿›ç¨‹çš„è¿›ç¨‹idä¸å¯èƒ½ä¸º0ã€‚ è§£æinit.zygote.rcä¸­çš„å‚æ•°ï¼Œåˆ›å»ºAppRuntimeå¹¶è°ƒç”¨AppRuntime.start()æ–¹æ³•ï¼› è°ƒç”¨AndroidRuntimeçš„startVM()æ–¹æ³•åˆ›å»ºè™šæ‹Ÿæœºï¼Œå†è°ƒç”¨startReg()æ³¨å†ŒJNIå‡½æ•°ï¼› é€šè¿‡JNIæ–¹å¼è°ƒç”¨ZygoteInit.main()ï¼Œç¬¬ä¸€æ¬¡è¿›å…¥Javaä¸–ç•Œï¼› registerZygoteSocket()å»ºç«‹socketé€šé“ï¼Œzygoteä½œä¸ºé€šä¿¡çš„æœåŠ¡ç«¯ï¼Œç”¨äºå“åº”å®¢æˆ·ç«¯è¯·æ±‚ï¼› preload()é¢„åŠ è½½é€šç”¨ç±»ã€drawableå’Œcolorèµ„æºã€openGLä»¥åŠå…±äº«åº“ä»¥åŠWebViewï¼Œç”¨äºæé«˜appå¯åŠ¨æ•ˆç‡ï¼› zygoteå®Œæ¯•å¤§éƒ¨åˆ†å·¥ä½œï¼Œæ¥ä¸‹æ¥å†é€šè¿‡**startSystemServer()**ï¼Œforkå¾—åŠ›å¸®æ‰‹system_serverè¿›ç¨‹ï¼Œä¹Ÿæ˜¯ä¸Šå±‚JavaFrameworkçš„è¿è¡Œè½½ä½“ã€‚ æ‰€æœ‰APPè¿›ç¨‹éƒ½æ˜¯ç”±Zygoteè¿›ç¨‹å­µåŒ–(fork) è€Œæ¥çš„ï¼Œforkæ—¶ä¸ä»…ä»…ä¼šè·å¾—Zygoteè¿›ç¨‹ä¸­çš„Dalvikè™šæ‹Ÿæœºå®ä¾‹æ‹·è´ï¼Œè¿˜ä¼šä¸Zygoteä¸€èµ· **å…±äº«Javaè¿è¡Œæ—¶åº“**ã€‚ zygoteåŠŸæˆèº«é€€ï¼Œè°ƒç”¨runSelectLoop()ï¼Œéšæ—¶å¾…å‘½ï¼Œå½“æ¥æ”¶åˆ°è¯·æ±‚åˆ›å»ºæ–°è¿›ç¨‹è¯·æ±‚æ—¶ç«‹å³å”¤é†’å¹¶æ‰§è¡Œç›¸åº”å·¥ä½œã€‚ é™„å½• system_serverå¯åŠ¨çš„æœåŠ¡12345678try { startBootstrapServices(); // å¯åŠ¨å¼•å¯¼æœåŠ¡:AMSã€PKMS startCoreServices(); // å¯åŠ¨æ ¸å¿ƒæœåŠ¡ startOtherServices(); // å¯åŠ¨å…¶ä»–æœåŠ¡:WMS } catch (Throwable ex) { Slog.e(&quot;System&quot;, &quot;************ Failure starting system services&quot;, ex); throw ex; } å¼•å¯¼æœåŠ¡(7ä¸ª)ï¼šActivityManagerServiceã€PowerManagerServiceã€LightsServiceã€DisplayManagerServiceã€PackageManagerServiceã€UserManagerServiceã€SensorServiceï¼› æ ¸å¿ƒæœåŠ¡(3ä¸ª)ï¼šBatteryServiceã€UsageStatsServiceã€WebViewUpdateServiceï¼› å…¶ä»–æœåŠ¡(70ä¸ª+)ï¼šWindowManagerServiceã€AlarmManagerServiceã€VibratorServiceç­‰ã€‚ åˆè®¡æ€»å¤§çº¦80ä¸ªç³»ç»ŸæœåŠ¡ï¼š ActivityManagerService PackageManagerService WindowManagerService PowerManagerService BatteryService BatteryStatsService DreamManagerService DropBoxManagerService SamplingProfilerService UsageStatsService DiskStatsService DeviceStorageMonitorService SchedulingPolicyService AlarmManagerService DeviceIdleController ThermalObserver JobSchedulerService AccessibilityManagerService DisplayManagerService LightsService GraphicsStatsService StatusBarManagerService NotificationManagerService WallpaperManagerService UiModeManagerService AppWidgetService LauncherAppsService TextServicesManagerService ContentService LockSettingsService InputMethodManagerService InputManagerService MountService FingerprintService TvInputManagerService DockObserver NetworkManagementService NetworkScoreService NetworkStatsService NetworkPolicyManagerService ConnectivityService BluetoothService WifiP2pService WifiService WifiScanningService AudioService MediaRouterService VoiceInteractionManagerService MediaProjectionManagerService MediaSessionService DevicePolicyManagerService PrintManagerService BackupManagerService UserManagerService AccountManagerService TrustManagerService SensorService LocationManagerService VibratorService CountryDetectorService GestureLauncherService PersistentDataBlockService EthernetService WebViewUpdateService ClipboardService TelephonyRegistry TelecomLoaderService NsdService UpdateLockService SerialService SearchManagerService CommonTimeManagementService AssetAtlasService ConsumerIrService MidiServiceCameraService TwilightService RestrictionsManagerService MmsServiceBroker RttService UsbService system_serverè¿›ç¨‹ï¼Œä»æºç è§’åº¦åˆ’åˆ†ä¸ºå¼•å¯¼æœåŠ¡ã€æ ¸å¿ƒæœåŠ¡ã€å…¶ä»–æœåŠ¡3ç±»ã€‚ ä»¥ä¸‹è¿™äº›ç³»ç»ŸæœåŠ¡çš„æ³¨å†Œè¿‡ç¨‹, è§Androidç³»ç»ŸæœåŠ¡çš„æ³¨å†Œæ–¹å¼æ–¹å¼1. ServiceManager.addService(): åŠŸèƒ½ï¼šå‘ServiceManageræ³¨å†Œè¯¥æœåŠ¡. ç‰¹ç‚¹ï¼šæœåŠ¡å¾€å¾€ç›´æ¥æˆ–é—´æ¥ç»§æ‰¿äºBinderæœåŠ¡ï¼› ä¸¾ä¾‹ï¼šinput, window, packageï¼› æ–¹å¼2. SystemServiceManager.startService: åŠŸèƒ½ï¼š åˆ›å»ºæœåŠ¡å¯¹è±¡ï¼› æ‰§è¡Œè¯¥æœåŠ¡çš„onStart()æ–¹æ³•ï¼›è¯¥æ–¹æ³•ä¼šæ‰§è¡Œä¸Šé¢çš„SM.addService()ï¼› æ ¹æ®å¯åŠ¨åˆ°ä¸åŒçš„é˜¶æ®µä¼šå›è°ƒonBootPhase()æ–¹æ³•ï¼› å¦å¤–ï¼Œè¿˜æœ‰å¤šç”¨æˆ·æ¨¡å¼ä¸‹ç”¨æˆ·çŠ¶æ€çš„æ”¹å˜ä¹Ÿä¼šæœ‰å›è°ƒæ–¹æ³•ï¼›ä¾‹å¦‚onStartUser(); ç‰¹ç‚¹ï¼šæœåŠ¡å¾€å¾€è‡ªèº«æˆ–å†…éƒ¨ç±»ç»§æ‰¿äºSystemServiceï¼› ä¸¾ä¾‹ï¼špower, activityï¼› ä¸¤ç§æ–¹å¼çœŸæ­£æ³¨å†ŒæœåŠ¡çš„è¿‡ç¨‹éƒ½ä¼šè°ƒç”¨åˆ°ServiceManager.addService()æ–¹æ³•. å¯¹äºæ–¹å¼2å¤šäº†ä¸€ä¸ªæœåŠ¡å¯¹è±¡åˆ›å»ºä»¥åŠ æ ¹æ®ä¸åŒå¯åŠ¨é˜¶æ®µé‡‡ç”¨ä¸åŒçš„åŠ¨ä½œçš„è¿‡ç¨‹ã€‚å¯ä»¥ç†è§£ä¸ºæ–¹å¼2æ¯”æ–¹å¼1çš„åŠŸèƒ½æ›´ä¸°å¯Œã€‚ é™„å½• BootPhaseç³»ç»Ÿå¼€æœºå¯åŠ¨è¿‡ç¨‹, å½“æ‰§è¡Œåˆ°system_serverè¿›ç¨‹æ—¶, å°†å¯åŠ¨è¿‡ç¨‹åˆ’åˆ†äº†å‡ ä¸ªé˜¶æ®µ, å®šä¹‰åœ¨SystemService.javaæ–‡ä»¶ 123456public static final int PHASE_WAIT_FOR_DEFAULT_DISPLAY = 100; public static final int PHASE_LOCK_SETTINGS_READY = 480;public static final int PHASE_SYSTEM_SERVICES_READY = 500;public static final int PHASE_ACTIVITY_MANAGER_READY = 550;public static final int PHASE_THIRD_PARTY_APPS_CAN_START = 600;public static final int PHASE_BOOT_COMPLETED = 1000; è¿™äº›é˜¶æ®µè·Ÿç³»ç»ŸæœåŠ¡å¤§è‡´çš„é¡ºåºå›¾,å¦‚ä¸‹: PHASE_BOOT_COMPLETED=1000ï¼Œè¯¥é˜¶æ®µæ˜¯å‘ç”Ÿåœ¨Bootå®Œæˆå’Œhomeåº”ç”¨å¯åŠ¨å®Œæ¯•, å¯¹äºç³»ç»ŸæœåŠ¡æ›´å€¾å‘äºç›‘å¬è¯¥é˜¶æ®µï¼Œè€Œéç›‘å¬å¹¿æ’­ACTION_BOOT_COMPLETED é™„å½• Androidç³»ç»Ÿæ¶æ„ ç¬¬ä¸€æ­¥ï¼šæ‰‹æœºå¼€æœºåï¼Œå¼•å¯¼èŠ¯ç‰‡å¯åŠ¨ï¼Œå¼•å¯¼èŠ¯ç‰‡å¼€å§‹ä»å›ºåŒ–åœ¨ROMé‡Œçš„é¢„è®¾ä»£ç æ‰§è¡Œï¼ŒåŠ è½½å¼•å¯¼ç¨‹åºåˆ°åˆ°RAMï¼Œbootloaderæ£€æŸ¥RAMï¼Œåˆå§‹åŒ–ç¡¬ä»¶å‚æ•°ç­‰åŠŸèƒ½ï¼› ç¬¬äºŒæ­¥ï¼šç¡¬ä»¶ç­‰å‚æ•°åˆå§‹åŒ–å®Œæˆåï¼Œè¿›å…¥åˆ°Kernelå±‚ï¼ŒKernelå±‚ä¸»è¦åŠ è½½ä¸€äº›ç¡¬ä»¶è®¾å¤‡é©±åŠ¨ï¼Œåˆå§‹åŒ–è¿›ç¨‹ç®¡ç†ç­‰æ“ä½œã€‚åœ¨Kernelä¸­é¦–å…ˆå¯åŠ¨swapperè¿›ç¨‹ï¼ˆpid=0ï¼‰ï¼Œç”¨äºåˆå§‹åŒ–è¿›ç¨‹ç®¡ç†ã€å†…ç®¡ç®¡ç†ã€åŠ è½½Driverç­‰æ“ä½œï¼Œå†å¯åŠ¨kthreadè¿›ç¨‹(pid=2),è¿™äº›linuxç³»ç»Ÿçš„å†…æ ¸è¿›ç¨‹ï¼Œkthreadæ˜¯æ‰€æœ‰å†…æ ¸è¿›ç¨‹çš„é¼»ç¥–ï¼› ç¬¬ä¸‰æ­¥ï¼šKernelå±‚åŠ è½½å®Œæ¯•åï¼Œç¡¬ä»¶è®¾å¤‡é©±åŠ¨ä¸HALå±‚è¿›è¡Œäº¤äº’ã€‚åˆå§‹åŒ–è¿›ç¨‹ç®¡ç†ç­‰æ“ä½œä¼šå¯åŠ¨INITè¿›ç¨‹ ï¼Œè¿™äº›åœ¨Nativeå±‚ä¸­ï¼› ç¬¬å››æ­¥ï¼šinitè¿›ç¨‹(pid=1ï¼Œinitè¿›ç¨‹æ˜¯æ‰€æœ‰è¿›ç¨‹çš„é¼»ç¥–ï¼Œç¬¬ä¸€ä¸ªå¯åŠ¨)å¯åŠ¨åï¼Œä¼šå¯åŠ¨adbdï¼Œlogdç­‰ç”¨æˆ·å®ˆæŠ¤è¿›ç¨‹ï¼Œå¹¶ä¸”ä¼šå¯åŠ¨servicemanager(binderæœåŠ¡ç®¡å®¶)ç­‰é‡è¦æœåŠ¡ï¼ŒåŒæ—¶å­µåŒ–å‡ºzygoteè¿›ç¨‹ï¼Œè¿™é‡Œå±äºC++ Frameworkï¼Œä»£ç ä¸ºC++ç¨‹åºï¼› ç¬¬äº”æ­¥ï¼šzygote è¿›ç¨‹æ˜¯ç”± **initè¿›ç¨‹è§£æinit.rcæ–‡ä»¶åforkç”Ÿæˆï¼Œå®ƒä¼šåŠ è½½è™šæ‹Ÿæœºï¼Œå¯åŠ¨System Server(zygoteå­µåŒ–çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹)**ï¼›System Serverè´Ÿè´£å¯åŠ¨å’Œç®¡ç†æ•´ä¸ªJava Frameworkï¼ŒåŒ…å«ActivityManagerï¼ŒWindowManagerï¼ŒPackageManagerï¼ŒPowerManagerç­‰æœåŠ¡ï¼› ç¬¬å…­æ­¥ï¼šzygoteåŒæ—¶ä¼šå¯åŠ¨ç›¸å…³çš„APPè¿›ç¨‹ï¼Œå®ƒå¯åŠ¨çš„ç¬¬ä¸€ä¸ªAPPè¿›ç¨‹ä¸ºLauncher(UI) ï¼Œç„¶åå¯åŠ¨Emailï¼ŒSMSç­‰è¿›ç¨‹ï¼Œæ‰€æœ‰çš„APPè¿›ç¨‹éƒ½æœ‰zygote forkç”Ÿæˆã€‚ å…³é”®æ¦‚å¿µå˜æ¸…swapperè¿›ç¨‹æ˜¯å”¯ä¸€ä¸€ä¸ªä¸ç”±å…¶ä»–è¿›ç¨‹fork/cloneå‡ºæ¥çš„è¿›ç¨‹ï¼Œå®ƒæ˜¯ç›´æ¥ç”±å†…æ ¸åˆ›å»ºï¼Œpidä¸º0ï¼› swapperè¿›ç¨‹forkå‡ºä¸¤ä¸ªå…³é”®è¿›ç¨‹ï¼š Initè¿›ç¨‹(pid=1)ï¼Œä¸€åˆ‡ç”¨æˆ·ç©ºé—´è¿›ç¨‹é¼»ç¥– kthreaddè¿›ç¨‹(pid=2)ï¼Œä¸€åˆ‡å†…æ ¸ç©ºé—´è¿›ç¨‹é¼»ç¥– å­è¿›ç¨‹çš„åˆ›å»ºInitè¿›ç¨‹é‡‡ç”¨è¢«åŠ¨åˆ›å»ºçš„æ–¹å¼æ¥åˆ›å»ºå­è¿›ç¨‹ï¼šå“ªäº›å­è¿›ç¨‹éœ€è¦åˆ›å»ºï¼Œé‚£å°±ä½¿ç”¨è„šæœ¬è¯­è¨€.rcæ¥é…ç½®ç›¸åº”çš„ä¿¡æ¯ï¼ŒInitè¿›ç¨‹ä¼šåœ¨LoadBootScriptsæ–¹æ³•ä¸­æŠŠæ‰€æœ‰çš„é…ç½®å¥½ä¿¡æ¯éƒ½æ”¶é›†èµ·æ¥ï¼Œå½“initè¿›ç¨‹å¯åŠ¨åä¼šæ ¹æ®é…ç½®ä¿¡æ¯æ¥åˆ›å»ºå­è¿›ç¨‹ã€‚ xxx.rc é…ç½®å­è¿›ç¨‹åŸºç¡€ä¿¡æ¯ï¼šè¿™ä¸€æ­¥ä¸»è¦ç”¨æ¥é…ç½®å­è¿›ç¨‹çš„åŸºç¡€ä¿¡æ¯ï¼Œæ¯”å¦‚å­è¿›ç¨‹çš„åå­—ã€å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ç­‰ï¼Œinitè¿›ç¨‹å°±å¯ä»¥ç«‹é©¬æ˜ç™½æ˜¯å“ªä¸ªå­è¿›ç¨‹è¢«åˆ›å»º é…ç½®è§¦å‘æ¡ä»¶ï¼šä¸»è¦é…ç½®å­è¿›ç¨‹ä½•æ—¶æˆ–è€…æ»¡è¶³ä»€ä¹ˆæ¡ä»¶çš„æƒ…å†µä¸‹è¢«åˆ›å»ºï¼Œå› ä¸ºä¸åŒå­è¿›ç¨‹çš„åˆ›å»ºæ¡ä»¶éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå› æ­¤initè¿›ç¨‹å¯ä»¥ä»è¿™ä¸€æ­¥å¾—çŸ¥æ˜¯åœ¨â€œä»€ä¹ˆæ—¶å€™â€æˆ–è€…â€œä»€ä¹ˆæ¡ä»¶æ»¡è¶³â€çš„æ—¶å€™æ¥åˆ›å»ºå­è¿›ç¨‹ é…ç½®å‰ç½®å‘½ä»¤ï¼šä¸»è¦é…ç½®å­è¿›ç¨‹åœ¨åˆ›å»ºä¹‹å‰éœ€è¦æ‰§è¡Œä¸€äº›æå‰æ“ä½œæˆ–è€…æå‰æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ¯”å¦‚æœ‰çš„å­è¿›ç¨‹åœ¨åˆ›å»ºä¹‹å‰éœ€è¦æå‰åˆ›å»ºä¸€äº›ç›®å½•ç­‰æ“ä½œ é…ç½®åˆ›å»ºå­è¿›ç¨‹å‘½ä»¤ï¼šè¿™ä¸€æ­¥éå¸¸çš„ç®€å•ï¼Œinitè¿›ç¨‹é‡åˆ°è¿™ä¸ªå‘½ä»¤ï¼Œå°±å¼€å§‹æ‰§è¡Œåˆ›å»ºå­è¿›ç¨‹çš„æ“ä½œ ç”¨initè„šæœ¬è¯­è¨€æ¥é…ç½®åˆ›å»ºå­è¿›ç¨‹çš„æ­¥éª¤å¦‚ä¸‹ï¼š é¦–å…ˆå­è¿›ç¨‹åœ¨ä»¥.rcçš„è„šæœ¬æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨serviceå…³é”®å­—æ¥é…ç½®å­è¿›ç¨‹ç›¸å…³çš„ä¿¡æ¯ å…¶æ¬¡ åœ¨init.rcæ–‡ä»¶ä¸­ä½¿ç”¨importå…³é”®å­—å¼•å…¥è„šæœ¬æ–‡ä»¶ï¼Œä½¿ç”¨onå…³é”®å­—æ¥é…ç½®å­è¿›ç¨‹çš„è§¦å‘æ¡ä»¶ è§¦å‘æ¡ä»¶é…ç½®å®Œæ¯•åï¼Œå¦‚è‹¥å­è¿›ç¨‹åœ¨åˆ›å»ºä¹‹å‰éœ€è¦é…ç½®ä¸€äº›å‰ç½®æ“ä½œæˆ–å‘½ä»¤ï¼Œåˆ™åŸºäºè§¦å‘æ¡ä»¶ä¸‹é…ç½®è¿™äº›ä¿¡æ¯ æœ€åä½¿ç”¨startå…³é”®å­—æ¥é…ç½®åˆ›å»ºå­è¿›ç¨‹çš„å‘½ä»¤ã€‚ Initè¿›ç¨‹çš„è¿è¡ŒInitè¿›ç¨‹è¿›å…¥å¾ªç¯å·¥ä½œæ¨¡å¼ æ˜¯å¦æœ‰å…³æœºæˆ–é‡å¯çš„æ¶ˆæ¯ï¼Œæœ‰çš„è¯æ‰§è¡Œå…³æœºæˆ–é‡å¯ è°ƒç”¨ActionManagerçš„ExecuteOneCommandæ–¹æ³•ï¼ŒActionManagerä¼šæ£€æŸ¥æ˜¯å¦æœ‰è§¦å‘å™¨ï¼Œæœ‰çš„è¯è§¦å‘å¯¹åº”çš„Actionæ‰§è¡Œï¼Œæœ‰äº›Actionä¼šåŒ…å«åˆ›å»ºå­è¿›ç¨‹çš„startå‘½ä»¤ï¼Œæ ¹æ®startå‘½ä»¤åé¢çš„servicenameï¼Œå¼€å§‹åˆ›å»ºå¯¹åº”çš„å­è¿›ç¨‹ è‹¥æœ‰controlç±»å‹çš„messageï¼Œåˆ™æŠŠå®ƒäº¤ç»™å¯¹åº”çš„Service å­è¿›ç¨‹çš„é”€æ¯ä¸Šé¢è°ˆåˆ°äº†å­è¿›ç¨‹â€ç”Ÿâ€œçš„é—®é¢˜ï¼Œé‚£ç°åœ¨å’±ä»¬èŠèŠå­è¿›ç¨‹â€æ­»â€œçš„é—®é¢˜ã€‚ä½œä¸ºAndroidç”¨æˆ·ç©ºé—´æ‰€æœ‰è¿›ç¨‹çš„é¼»ç¥–ï¼Œä»ç”Ÿç‰©å­¦çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘è‚¯å®šæ¯”æˆ‘çš„å­©å­ã€å­™å­ä»¬è¦å…ˆæ­»æ‰ï¼Œä½†æ˜¯åœ¨Androidç³»ç»Ÿå´æ°æ°ç›¸åï¼Œæˆ‘çš„ç”Ÿå‘½å‘¨æœŸå°½ç„¶æ˜¯æœ€é•¿çš„ï¼Œæˆ‘çš„å¾ˆå¤šå­å­å­™å­™éƒ½æ­»äº†å¾ˆå¤šæ¬¡äº†ï¼Œæˆ‘è¿˜ä¾ç„¶æ´»ç€ï¼Œå› æ­¤æˆ‘åˆ›å»ºçš„å­è¿›ç¨‹ä¸‡ä¸€æ­»æ‰çš„è¯ï¼Œé‚£å®ƒçš„å–„åäº‹æƒ…éœ€è¦æˆ‘æ¥å¤„ç†ï¼ˆçœŸæ˜¯ç™½å‘äººé€é»‘å‘äººå•Šï¼‰ã€‚ é‚£æœ‰äººå°±ä¼šé—®äº†ï¼Œä½ æ˜¯å¦‚ä½•çŸ¥é“ä½ åˆ›å»ºçš„å­è¿›ç¨‹æ­»æ‰çš„ï¼Œè¿™æ˜¯ä¸ªå¥½é—®é¢˜ï¼Œé‚£æˆ‘å°±æ¥è®²ç»™å¤§å®¶å¬ã€‚ ç›‘å¬å­è¿›ç¨‹æ­»æ‰ç›‘å¬å­è¿›ç¨‹æ­»æ‰éå¸¸çš„ç®€å•ï¼Œä¸»è¦æ˜¯ç”¨åˆ°äº†Linuxçš„ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼šsignalæœºåˆ¶ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å®ç°è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œsignalæœºåˆ¶æ˜¯æœ€â€œåå•¬â€çš„ã€ä½†æ˜¯æ˜¯æœ€ç®€å•çš„è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡æ–¹å¼ã€‚ä¸ºå•¥è¦è¯´å®ƒæ˜¯æœ€â€œåå•¬â€å‘¢ï¼Ÿä¸»è¦åŸå› æ˜¯signalå¯¹è¿›ç¨‹ä¹‹é—´ä¼ é€’çš„æ•°æ®ä»…ä¸”åªèƒ½åªèƒ½ä¼ é€’ä¸€ä¸ªintç±»å‹çš„ä¿¡å·ï¼Œä½†æ˜¯åƒsocketç­‰é€šä¿¡æ–¹æ¡ˆå¯¹ä¼ é€’çš„æ•°æ®å¹¶æ²¡æœ‰è¿™æ ·çš„é™åˆ¶ï¼Œä½ è¯´å®ƒâ€œåå•¬â€ä¸ã€‚ ç®€å•ä¸»è¦ä½“ç°åœ¨ï¼šè‹¥å¯¹å“ªä¸ªä¿¡å·æœ‰å…´è¶£ï¼Œå¯ä»¥ä½¿ç”¨sigactionå‡½æ•°æ³¨å†Œè¿™ä¸ªä¿¡å·ï¼Œå½“è¿™ä¸ªä¿¡å·å‘ç”Ÿæ—¶ï¼Œæ³¨å†Œçš„å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ã€‚è¿™é‡Œä¸€ç›´åœ¨æä¿¡å·ï¼Œç›‘å¬å­è¿›ç¨‹çŠ¶æ€æœ‰ä¸€ä¸ªä¿¡å·æ˜¯SIGCHLDï¼Œçˆ¶è¿›ç¨‹å¯ä»¥æ³¨å†Œè¿™ä¸ªSIGCHLDæ¥ç›‘å¬å­è¿›ç¨‹çš„çŠ¶æ€ï¼ŒçŠ¶æ€ä¸»è¦åŒ…æ‹¬æ­»æ‰ï¼ˆæ­»æ‰åŒ…å«æ­£å¸¸æ­»æ‰æˆ–è€…å¼‚å¸¸æ­»æ‰æ¯”å¦‚crashï¼‰ã€åœæ­¢ã€ç»§ç»­ç­‰ã€‚ epollæœºåˆ¶ epollæ˜¯â€œå¤šè·¯å¤ç”¨â€œæŠ€æœ¯æœ€å¥½çš„å®ç°æ–¹æ¡ˆï¼Œâ€œå¤šè·¯å¤ç”¨â€çœ‹åˆ°è¿™ç§ä¸“ä¸šæ€§çš„è¯æ˜¯ä¸æ˜¯ä¸€å¤´é›¾æ°´å•Šï¼Œå’±ä»¬ä¸¾ä¸ªä¾‹å­ï¼šæ­£å¸¸å’±ä»¬è¿›è¡Œé˜»å¡ç±»å‹çš„IOè¯»æ“ä½œï¼ˆæ¯”å¦‚ä»ä¸€ä¸ªsocketä¸­è¯»å–æ•°æ®ï¼‰ï¼Œæ˜¯ä¸æ˜¯éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥ç›‘å¬æ˜¯å¦æœ‰æ•°æ®åˆ°è¾¾ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ°è¾¾åˆ™çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæœ‰çš„è¯åˆ™çº¿ç¨‹å°±å¼€å§‹è¯»å–æ•°æ®ã€‚é‚£å‡å¦‚æœ‰20ä¸ªç”šè‡³æ›´å¤šçš„é˜»å¡IOè¯»æ“ä½œï¼Œæ˜¯ä¸æ˜¯éœ€è¦åˆ›å»ºå¯¹åº”ä¸ªæ•°çš„çº¿ç¨‹ã€‚ è¿™äº›çº¿ç¨‹å¦‚æœå¤§éƒ¨åˆ†éƒ½æ²¡æœ‰å¯è¯»æ•°æ®çš„æƒ…å†µä¸‹æ˜¯ä¸æ˜¯éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œè¿™éš¾é“ä¸æ˜¯å¤§å¤§å¾—æµªè´¹å—ï¼Ÿå› æ­¤â€œå¤šè·¯å¤ç”¨â€æŠ€æœ¯å°±å‡ºç°äº†ï¼Œå®ƒçš„è®¾è®¡ç†å¿µæ˜¯ï¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œè°æœ‰éœ€è¦ç›‘å¬IOæ˜¯å¦æœ‰å¯è¯»æ•°æ®åˆ°è¾¾çš„æ“ä½œéƒ½å¯ä»¥äº¤ç»™è¿™ä¸ªçº¿ç¨‹ã€‚è¿™é‡Œçš„â€œå¤šè·¯â€æŒ‡çš„å°±æ˜¯ä¸Šé¢ä¾‹å­ä¸­åˆ›å»ºçš„å¤šä¸ªçº¿ç¨‹ï¼Œâ€œå¤ç”¨â€æŒ‡çš„å°±æ˜¯æŒ‡ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œç›‘å¬æ“ä½œã€‚ epollæœºåˆ¶åœ¨Androidä¸­ä½¿ç”¨éå¸¸çš„å¹¿æ³›ï¼Œæ¯”å¦‚Handlerçš„MessageQueueåœ¨æ²¡æœ‰Messageçš„æƒ…å†µä¸‹è¿›å…¥é˜»å¡ï¼Œä»¥åŠinputäº‹ä»¶ä»systemserverè¿›ç¨‹ä¼ é€’åˆ°appè¿›ç¨‹ï¼Œç”šè‡³vsynä¿¡å·ä»surfaceflingerä¼ é€’åˆ°appè¿›ç¨‹éƒ½ç”¨åˆ°äº†epollæœºåˆ¶ã€‚ å¥½äº†ï¼Œæœ‰äº†ä¸Šé¢çš„çŸ¥è¯†ï¼Œé‚£æˆ‘å°±æ¥ä»‹ç»ä¸‹æˆ‘ç›‘å¬å­è¿›ç¨‹æ­»æ‰çš„æ€è·¯ï¼š é¦–å…ˆæˆ‘å…ˆä½¿ç”¨sigactionå‡½æ•°æ¥æ³¨å†ŒSIGCHLDä¿¡å·ï¼Œè¿™æ ·å°±å¯ä»¥ç›‘å¬åˆ°å­è¿›ç¨‹çš„çŠ¶æ€äº† å…¶æ¬¡ä½¿ç”¨signalfdå‡½æ•°ä¸ºSIGCHLDä¿¡å·ç”Ÿæˆä¸€ä¸ªfdï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ å†æ¬¡ä½¿ç”¨epollæ¥è§ç›‘å¬ä¸Šä¸€æ­¥ç”Ÿæˆçš„fdæ˜¯å¦æœ‰å¯è¯»æ•°æ® å¦‚ç›‘å¬åˆ°fdä¸Šæœ‰å¯è¯»æ•°æ®ï¼Œåˆ™è¯æ˜å­è¿›ç¨‹çš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿˜éœ€è¦ä½¿ç”¨waitpidå‡½æ•°æ¥è·å–æ˜¯å“ªä¸ªå­è¿›ç¨‹æ­»æ‰äº† å¦‚ä¸Š4æ­¥å°±å¯ä»¥ç›‘å¬åˆ°å­è¿›ç¨‹æ­»æ‰äº†ï¼Œä¸‹é¢æ˜¯å…·ä½“çš„ä»£ç ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹ã€‚ system/core/init/init.cpp 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485static void InstallSignalFdHandler(Epoll* epoll) { //åˆå§‹åŒ–sigactionï¼ŒSIG_DFLï¼šä»£è¡¨ä½¿ç”¨é»˜è®¤çš„ä¿¡å·å¤„ç†è¡Œä¸ºã€‚ const struct sigaction act { .sa_handler = SIG_DFL, .sa_flags = SA_NOCLDSTOP }; //æ³¨å†ŒSIGCHLDä¿¡å· sigaction(SIGCHLD, &amp;act, nullptr); //å£°æ˜maskä¿¡å·é›† sigset_t mask; //åˆå§‹åŒ–å¹¶æ¸…ç©ºä¸€ä¸ªä¿¡å·é›†ï¼Œä½¿å…¶ä¸åŒ…å«ä»»ä½•ä¿¡å· sigemptyset(&amp;mask); //æŠŠSIGCHLDä¿¡å·åŠ å…¥maskä¿¡å·é›†ä¸­ sigaddset(&amp;mask, SIGCHLD); çœç•¥ä»£ç ...... //SIG_BLOCKï¼šä»£è¡¨å°†maskæ·»åŠ åˆ°å½“å‰çš„ä¿¡å·å±è”½é›†ä¸­ if (sigprocmask(SIG_BLOCK, &amp;mask, nullptr) == -1) { PLOG(FATAL) &lt;&lt; &quot;failed to block signals&quot;; } // Register a handler to unblock signals in the child processes. //åœ¨å­è¿›ç¨‹åˆ›å»ºæˆåŠŸåï¼Œæ¢å¤SIGCHLDä¸ºéå±è”½ const int result = pthread_atfork(nullptr, nullptr, &amp;UnblockSignals); if (result != 0) { LOG(FATAL) &lt;&lt; &quot;Failed to register a fork handler: &quot; &lt;&lt; strerror(result); } //è°ƒç”¨signalfdå‡½æ•°ä¸ºmaskç”Ÿæˆä¸€ä¸ªfd signal_fd = signalfd(-1, &amp;mask, SFD_CLOEXEC); if (signal_fd == -1) { PLOG(FATAL) &lt;&lt; &quot;failed to create signalfd&quot;; } constexpr int flags = EPOLLIN | EPOLLPRI; //ä½¿ç”¨epollæ¥ç›‘å¬signal_fdä¸Šçš„æ•°æ® if (auto result = epoll-&gt;RegisterHandler(signal_fd, HandleSignalFd, flags); !result.ok()) { LOG(FATAL) &lt;&lt; result.error(); }}//å¦‚æœfdä¸Šæœ‰æ•°æ®å°±ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•static void HandleSignalFd() { //è¯»å–åˆ°siginfoä¿¡æ¯ signalfd_siginfo siginfo; ssize_t bytes_read = TEMP_FAILURE_RETRY(read(signal_fd, &amp;siginfo, sizeof(siginfo))); if (bytes_read != sizeof(siginfo)) { PLOG(ERROR) &lt;&lt; &quot;Failed to read siginfo from signal_fd&quot;; return; } //åˆ¤æ–­å½“å‰çš„ssi_signo switch (siginfo.ssi_signo) { case SIGCHLD: //åªçœ‹SIGCHLD ReapAnyOutstandingChildren(); break; çœç•¥æ— å…³ä»£ç ...... }}system/core/init/sigchld_handler.cppvoid ReapAnyOutstandingChildren() { while (ReapOneProcess() != 0) { }}static pid_t ReapOneProcess() { siginfo_t siginfo = {}; //è°ƒç”¨waitpidæ–¹æ³•æ¥è·å–æ­»æ‰çš„å­è¿›ç¨‹çš„ä¿¡æ¯ if (TEMP_FAILURE_RETRY(waitid(P_ALL, 0, &amp;siginfo, WEXITED | WNOHANG | WNOWAIT)) != 0) { PLOG(ERROR) &lt;&lt; &quot;waitid failed&quot;; return 0; } const pid_t pid = siginfo.si_pid; if (pid == 0) { DCHECK_EQ(siginfo.si_signo, 0); return 0; } çœç•¥æ— å…³ä»£ç ......} å¦‚ä¸Šé¢ç›‘å¬åˆ°å­è¿›ç¨‹æ­»æ‰çš„æ—¶å€™ä¼šé€šè¿‡waitpidæ–¹æ³•è·å–åˆ°å­è¿›ç¨‹çš„pidï¼Œè¿˜è®°å¾—åœ¨åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™ï¼Œå­è¿›ç¨‹çš„é…ç½®ä¿¡æ¯éƒ½ä¼šæ”¾åœ¨Serviceç±»ä¸­ï¼Œæ ¹æ®pidå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„Serviceï¼ŒServiceæŒæœ‰äº†åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™æŒæœ‰çš„å„ç§socketç­‰èµ„æºï¼Œè¿™äº›èµ„æºä¼šè¢«æ¸…é™¤æ‰ï¼Œå¹¶ä¸”ä¼šé€šçŸ¥kernelå±‚æ€æ‰å­è¿›ç¨‹ï¼Œè¿›è€Œåœ¨kernelå±‚æ¸…é™¤æ‰å­è¿›ç¨‹å æ®çš„å„ç§èµ„æºã€‚","link":"/2021/06/30/SystemStartProcess/"},{"title":"ScreenDraw","text":"å½“æ‰‹æŒ‡ç‚¹å‡»äº†æ¡Œé¢çš„Appå›¾æ ‡æ—¶å‘ç”Ÿäº†ä»€ä¹ˆ - ProcessOn Android å±å¹•åˆ·æ–°æœºåˆ¶ä¸»è¦å‚è€ƒ https://juejin.cn/post/6863756420380196877#heading-12 çœæµç‰ˆï¼š åŒç¼“å­˜ï¼šä¸ºäº†è§£å†³ç”»é¢æ’•è£‚ï¼›ç”»é¢æ’•è£‚æ¥è‡ªäºåªæœ‰ä¸€ä¸ªbufferæ—¶ï¼Œæ­£åœ¨displayçš„é‚£ä¸€å¸§æ•°æ®è¢«åä¸€å¸§çš„æ•°æ®è¦†ç›–äº† Vsyncï¼šç³»ç»Ÿåœ¨æ”¶åˆ°VSync pulseï¼ˆVsyncè„‰å†²ï¼‰åï¼Œå°†é©¬ä¸Šå¼€å§‹ä¸‹ä¸€å¸§çš„æ¸²æŸ“ï¼Œï¼ˆCPUå¼€å§‹è®¡ç®—æ•°æ®ï¼‰ã€‚ ä¸‰ç¼“å†²ï¼šå½“æ˜¾ç¤ºå™¨æ­£åœ¨å†™å…¥FrameBufferåŒæ—¶GPUä¹Ÿæ­£åœ¨å†™å…¥BackBufferæ—¶ï¼Œä¸‹ä¸€æ¬¡æ¸²æŸ“å¼€å§‹äº†ï¼Œæ­¤æ—¶CPUå¯ä»¥ä½¿ç”¨æ–°å¢çš„GraphicBufferè¿›è¡Œè®¡ç®—ã€‚å‡å°‘äº†Jankã€‚ï¼ˆæ›´å¤šç¼“å†²éœ€è¦è€—è´¹æ›´å¤§çš„å†…å­˜ï¼‰ ChoreoGrapheræœºåˆ¶ï¼šè§„å®šäº†æ•°æ®è®¡ç®—å¼€å§‹ï¼ˆmeasureã€layoutã€drawï¼‰çš„æ—¶æœºï¼ˆvsyncä¿¡å·ï¼‰ï¼Œä½¿è®¡ç®—åˆ°æ¸²æŸ“å›¾åƒæ•°æ®èƒ½æœ‰ä¸€ä¸ªå®Œæ•´çš„16.6msï¼šæ›´æ–°uiï¼ˆrequest()/invalidate()ï¼‰åç¼–èˆè€…æ³¨å†Œvsyncä¿¡å·å›è°ƒï¼Œåœ¨ä¸‹ä¸€ä¸ªvsyncä¿¡å·åˆ°æ—¶å€™ç«‹åˆ»è¿›è¡Œviewçš„æµ‹é‡å¸ƒå±€ç»˜åˆ¶ ä¸€ã€ç¼“å†²å’ŒVsynchttps://juejin.cn/post/6863756420380196877 1ã€å•ç¼“å†²ï¼Œtearing ç”±äºGpuè·Ÿæ˜¾ç¤ºå™¨ä½¿ç”¨åŒä¸€ä¸ªç¼“å†²ï¼Œå¯¼è‡´å¯èƒ½å±å¹•æ‰«æåˆ·æ–°æ—¶ï¼Œå¯èƒ½è¯»å–åˆ°çš„ä¸æ˜¯åŒä¸€å¸§é‡Œçš„å›¾åƒæ•°æ®ï¼Œé€ æˆç”»é¢æ’•è£‚ 2ã€â†“ åŒç¼“å†² â†“åŒç¼“å†²æ˜¯ä¸ºäº†è§£å†³â€œç”±äºGpuè·Ÿæ˜¾ç¤ºå™¨ä½¿ç”¨åŒä¸€ä¸ªç¼“å†²ï¼Œå¯¼è‡´å¯èƒ½å±å¹•æ‰«æåˆ·æ–°æ—¶ï¼Œå¯èƒ½è¯»å–åˆ°çš„ä¸æ˜¯åŒä¸€å¸§é‡Œçš„å›¾åƒæ•°æ®ï¼Œé€ æˆç”»é¢æ’•è£‚â€ï¼Œè®©ç»˜åˆ¶å’Œæ˜¾ç¤ºå™¨æ‹¥æœ‰å„è‡ªçš„bufferï¼š GPU çš„å›¾åƒæ•°æ®å†™å…¥åˆ° Back Bufferï¼Œè€Œæ˜¾ç¤ºå™¨ä½¿ç”¨ Frame Bufferï¼Œå½“å±å¹•åˆ·æ–°æ—¶ï¼ŒFrame Buffer å¹¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå½“Back bufferå‡†å¤‡å°±ç»ªåï¼Œå®ƒä»¬æ‰è¿›è¡Œåœ°å€äº¤æ¢ã€‚ï¼ˆç¼“å­˜åŒºäº¤æ¢è¢«ç§°ä¸ºBufferSwapï¼Œå¸§ä¼ é€’ã€‚ï¼‰ ä¸Šé¢è¯´åˆ°çš„Back Buffer è·Ÿ Frame Bufferåœ°å€äº¤æ¢ï¼Œæ—¶é—´ç‚¹é€‰æ‹©åœ¨äº† Back bufferå®Œæ•´å†™å…¥ä¹‹åï¼Œåœ¨ä¹‹åå±å¹•æ‰«æå®Œä¸€ä¸ªå±å¹•ï¼ˆä»å·¦åˆ°å³ï¼Œä»ä¸Šåˆ°ä¸‹é€è¡Œæ˜¾ç¤ºæ¯ä¸€ä¸ªåƒç´ ç‚¹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä»¥60Hzå±ä¸ºä¾‹æ˜¯16.6msï¼‰åï¼Œè®¾å¤‡ä»å³ä¸‹å›åˆ°å·¦ä¸Šçš„è¿™ä¸ªæ—¶é—´åŒºé—´ï¼ˆå³VBI VerticalBlackingIntervalå‚ç›´åŒæ­¥é—´éš™ï¼‰ï¼Œè€Œå‚ç›´åŒæ­¥è„‰å†²ï¼ˆvertical sync pulseï¼‰å°±æ˜¯åœ¨VBIæ—¶æœŸå‘å‡ºçš„ï¼Œè„‰å†²å‘å‡ºæ—¶é—´æ—¶ç«‹å³è¿›è¡Œå¸§ä¼ é€’ã€‚ æ€»ç»“ä¸‹å°±æ˜¯ï¼šå‚ç›´åŒæ­¥è„‰å†²æ˜¯åœ¨å±å¹•æ‰«æåˆ°å³ä¸‹æœ€åä¸€ä¸ªåƒç´ åï¼Œé‡ç½®å›åˆ°å·¦ä¸Šçš„è¿™ä¸ªæ—¶é—´ç©ºéš™å‘å‡ºçš„ï¼Œæ‰€ä»¥æ¯16.6msï¼ˆ60HZå±ï¼‰å‘å‡ºä¸€ä¸ªè„‰å†²ä¿¡å·ã€‚æ”¶åˆ°è„‰å†²ä¿¡å·åï¼Œå¦‚æœGPUçš„ç¼“å†²å·²ç»å‡†å¤‡å¥½äº†ï¼Œå°±ä¼šç«‹å³è¿›è¡Œå¸§ä¼ é€’ã€‚ ä½†æ˜¯ï¼ŒåŒç¼“å­˜åªæ˜¯è§„å®šäº†å›¾åƒæ•°æ®æ•°æ®å†™å…¥BackBufferå®Œæˆåï¼ŒFrameBufferä¸BackBufferäº¤æ¢çš„æ—¶æœºï¼Œè€Œæ•°æ®å¼€å§‹è®¡ç®—æ—¶é—´çš„ä¸ç¡®å®šï¼Œåˆ™å¯¼è‡´äº†ä¸‹ä¸€å¸§ä¸­ï¼ŒCPU/GPUæœªèƒ½åœ¨å¸§å¼€å§‹çš„æ—¶å€™å°±è¿›è¡Œè®¡ç®—ï¼Œè¿›è€Œå¯¼è‡´å¸§ç»“æŸæ—¶CPU/GPUå·¥ä½œæœªå®Œæˆï¼ˆæ˜æ˜CPU/GPUå·¥ä½œæ—¶é•¿å°äº16.6msï¼‰ï¼Œå´è¿˜æ˜¯é€ æˆæ‰å¸§ï¼ˆjankï¼‰ã€‚ 3ã€â†“ ä¸‰ç¼“å†² + Vsync â†“Android 4.xç‰ˆæœ¬çš„é»„æ²¹å·¥ç¨‹ project butterå¼•å…¥ä¸‰ç¼“å†²ä¸Vsyncï¼Œæå‡äº†æ€§èƒ½ï¼Œä¿ƒä½¿äº†Androidçš„æ™®åŠ 3.1ã€ VSync æœºåˆ¶Androidå®ç°å³ä¸‹è¿°ç¬¬äºŒèŠ‚choreographeræœºåˆ¶ ç³»ç»Ÿåœ¨æ”¶åˆ°VSync pulseï¼ˆVsyncè„‰å†²ï¼‰åï¼Œå°†é©¬ä¸Šå¼€å§‹ä¸‹ä¸€å¸§çš„æ¸²æŸ“ã€‚å³ä¸€æ—¦æ”¶åˆ°VSyncé€šçŸ¥ï¼ˆ16msè§¦å‘ä¸€æ¬¡ï¼‰ï¼ŒCPUå’ŒGPU æ‰ç«‹åˆ»å¼€å§‹è®¡ç®—ç„¶åæŠŠæ•°æ®å†™å…¥bufferã€‚VSyncåŒæ­¥ä½¿å¾—CPU/GPUå……åˆ†åˆ©ç”¨äº†16.6msæ—¶é—´ï¼Œå‡å°‘jank 3.2ã€ ä¸‰ç¼“å†² CPUã€GPUã€æ˜¾ç¤ºå™¨éƒ½èƒ½å°½å¿«æ‹¿åˆ° bufferï¼Œå‡å°‘ä¸å¿…è¦çš„ç­‰å¾…ã€‚å¦‚æœæ˜¾ç¤ºå™¨å’Œ GPU ç°åœ¨éƒ½ä½¿ç”¨ç€ä¸€ä¸ª bufferï¼Œå¦‚æœä¸‹ä¸€æ¬¡æ¸²æŸ“å¼€å§‹äº†ï¼Œå› ä¸ºè¿˜æœ‰ä¸€ä¸ª buffer å¯ä»¥ç”¨äº CPU æ•°æ®çš„å†™å…¥ï¼Œæ‰€ä»¥å¯ä»¥é©¬ä¸Šå¼€å§‹ä¸‹ä¸€å¸§æ•°æ®çš„æ¸²æŸ“ã€‚ ä¸‰ç¼“å†²å°±æ˜¯åœ¨åŒç¼“å†²æœºåˆ¶åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ä¸ª Graphic Buffer ç¼“å†²åŒºï¼Œè¿™æ ·å¯ä»¥æœ€å¤§é™åº¦çš„åˆ©ç”¨ç©ºé—²æ—¶é—´ï¼Œå¸¦æ¥çš„åå¤„æ˜¯å¤šä½¿ç”¨çš„ä¸€ä¸ª Graphic Buffer æ‰€å ç”¨çš„å†…å­˜ã€‚ä¸‰ç¼“å†²æœ‰æ•ˆåˆ©ç”¨äº†ç­‰å¾…vysncçš„æ—¶é—´ï¼Œå‡å°‘äº†jankï¼Œä½†æ˜¯å¸¦æ¥äº†å»¶è¿Ÿã€‚ äºŒã€Choreographeræœºåˆ¶ æˆ–ç§° â€œdrawing with vysncâ€ -&gt; requestLayout() / invalidate() æ‰€æœ‰UIçš„å˜åŒ–éƒ½æ˜¯èµ°åˆ°ViewRootImplçš„scheduleTraversals()æ–¹æ³•ã€‚ -&gt; scheduleTraversals() 123456789101112131415161718void scheduleTraversals() { if (!mTraversalScheduled) { // ä¿è¯åŒæ—¶é—´å¤šæ¬¡æ›´æ”¹åªä¼šåˆ·æ–°ä¸€æ¬¡ï¼Œä¾‹å¦‚TextViewè¿ç»­ä¸¤æ¬¡setText()ä¹Ÿåªä¼šèµ°ä¸€æ¬¡ç»˜åˆ¶æµç¨‹ mTraversalScheduled = true; // æ·»åŠ åŒæ­¥å±éšœï¼Œä¿è¯ Vsync åˆ°æ¥ç«‹å³æ‰§è¡Œç»˜åˆ¶ mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier(); mChoreographer.postCallback(Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null); // ... }}// mTraversalRunnable æ˜¯Vsyncä¿¡å·å›è°ƒåæ‰§è¡Œçš„Runnable å®ä¾‹final class TraversalRunnable implements Runnable { @Override public void run() { doTraversal(); }} mChoreographer.postCallback() // æ³¨å†Œç›‘å¬Vsyncä¿¡å·ï¼ˆåªæœ‰æ³¨å†Œäº†ç›‘å¬çš„Vsyncæ‰ä¼šå›è°ƒæ‰§è¡Œï¼‰å›è°ƒå¤„ç†å†…å®¹ä¸ºmTraversalRunnableï¼Œäº‹ä»¶ç±»å‹ä¸ºCALLBACK_TRAVERSALï¼ˆCALLBACK_INPUTè¾“å…¥äº‹ä»¶ã€CALLBACK_ANIMATIONåŠ¨ç”»ã€CALLBACK_INSETS_ANIMATIONæ’å…¥æ›´æ–°åŠ¨ç”»ã€CALLBACK_TRAVERSALç»˜åˆ¶ã€CALLBACK_COMMITæäº¤ï¼Œäº”ç§ç±»å‹é¡ºåºæ‰§è¡Œï¼‰ postCallbackDelayedInternal if (dueTime &lt;= now) ï¼š ç›´æ¥æ‰§è¡ŒscheduleFrameLocked else ï¼š msg.setAsynchronous(true); å‘é€å»¶è¿Ÿåˆ°ç‚¹åçš„å¼‚æ­¥æ¶ˆæ¯æ‰§è¡ŒscheduleFrameLocked -&gt; scheduleFrameLocked() æ ¹æ® ç‰ˆæœ¬æœªå¼€å¯VSYNï¼ˆ4.1ä»¥ä¸‹ï¼‰ç›´æ¥èµ°doFrame ç¡®è®¤å¹¶åˆ‡æ¢åˆ°Choreographerçš„handlerï¼ˆå¼‚æ­¥æ¶ˆæ¯ï¼‰æ‰§è¡Œ scheduleVsyncLocked() -&gt; scheduleVsncLocked() -&gt; scheduleVsync() -&gt; nativeScheduleVsync(mReceiverPtr); æ³¨å†ŒVSYNCä¿¡å·å›è°ƒï¼Œåªæœ‰æ³¨å†Œç›‘å¬çš„é‚£ä¸€ä¸ªVsyncä¿¡å·æ‰ä¼šæ¥æ”¶å›è°ƒæœ€ååœ¨onVsync() è¿™é‡Œä¸åº”è¯¥ä¸ºè½¯ä»¶ç”³è¯·äº†Vsyncä¿¡å·ï¼ŒVsyncä¿¡å·æ˜¯ç”±å±å¹•/æ˜¾ç¤ºè®¾å¤‡å‘å‡ºçš„ï¼Œæ— è®ºchoreographeræ˜¯å¦ç›‘å¬éƒ½ä¼šåœ¨å›ºå®šçš„æ—¶é—´é—´éš”å‘å‡ºï¼ˆ60fps-&gt;16.6msï¼‰ï¼ŒViewæ›´æ–°åç”±choreographeræ³¨å†Œç›‘å¬åæ‰ä¼šå¯¹ä¸‹ä¸€ä¸ªVsyncä¿¡å·å›è°ƒå›æ¥åå¤„ç†ï¼Œèµ°doCallbacks ï¼Œä¹Ÿå°±æ˜¯æœ€åˆç”±choreographeræ³¨å†Œçš„å›è°ƒmChoreographer.postCallback() -&gt; doTraversal() -&gt; ç§»é™¤åŒæ­¥å±éšœå¹¶çœŸæ­£æ‰§è¡ŒViewçš„measureã€layoutã€drawæµç¨‹ æ‰€ä»¥æ¯16mséƒ½ä¼šå‘å‡ºVsyncä¿¡å·ï¼Œæ¯16mså±å¹•éƒ½åœ¨åˆ·æ–°ï¼Œä½†ä¸æ˜¯æ¯16mséƒ½ä¼šèµ°measureã€layoutã€draw nativeå±‚æ³¨å†Œç›‘å¬Vsyncå›è°ƒï¼ŒDisplayEventReceiver::requestNextVsync() 123456789101112131415161718192021222324252627// frameworks/base/core/jni/android_view_DisplayEventReceiver.cppstatic void nativeScheduleVsync(JNIEnv* env, jclass clazz, jlong receiverPtr) { sp&lt;NativeDisplayEventReceiver&gt; receiver = reinterpret_cast&lt;NativeDisplayEventReceiver*&gt;(receiverPtr); status_t status = receiver-&gt;scheduleVsync(); // ...}// frameworks/base/libs/androidfw/DisplayEventDispatcher.cppstatus_t DisplayEventDispatcher::scheduleVsync() { if (!mWaitingForVsync) { // ... // mReceiver æ˜¯ DisplayEventReceiver å®ä¾‹ status_t status = mReceiver.requestNextVsync(); mWaitingForVsync = true; } return OK;}// frameworks/native/libs/gui/DisplayEventReceiver.cppstatus_t DisplayEventReceiver::requestNextVsync() { if (mEventConnection != NULL) { // è¯·æ±‚æ¥æ”¶ä¸‹ä¸€æ¬¡Vsyncä¿¡å·çš„å›è°ƒ mEventConnection-&gt;requestNextVsync(); return NO_ERROR; } return NO_INIT;} native Vsyncä¿¡å·å›è°ƒå›æ¥äº†ï¼Œç”±FrameDisplayEventReceiverçš„onVsyncæ–¹æ³•æ¥æ”¶ï¼š -&gt; onVsync() -&gt; doFrame() 123456789101112131415161718192021222324252627282930313233void doFrame(long frameTimeNanos, int frame) { final long startNanos; synchronized (mLock) { if (!mFrameScheduled) { return; // no work to do } //... // è®¡ç®—æ‰å¸§æƒ…å†µ frameTimeNanosæ˜¯onVsync()çš„å‚æ•°ï¼Œå³vsyncä¿¡å·å¼€å§‹æ—¶é—´ï¼Œä»¥frameTimeNanosä¸ºstart_timeï¼Œ //ä»¥doFrameæ–¹æ³•æ‰§è¡Œå¼€å§‹æ—¶é—´ä¸ºend_timeï¼Œ start_time - end_timeä¸ºå¸§å»¶è¿Ÿï¼Œä»¥æ­¤ æ—¶é—´å·®/æ ‡å‡†å¸§æ—¶é—´ è®¡ç®—æ‰å¸§æƒ…å†µ //æ ‡å‡†å¸§æ—¶é—´ = 1000000000 / å±å¹•å¸§ç‡ å•ä½çº³ç§’ ï¼ˆ1çº³ç§’=0.000 000 001ç§’ ï¼‰ //... try { // æŒ‰ç±»å‹é¡ºåº æ‰§è¡Œä»»åŠ¡ Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;Choreographer#doFrame&quot;); AnimationUtils.lockAnimationClock(frameTimeNanos / TimeUtils.NANOS_PER_MS); mFrameInfo.markInputHandlingStart(); doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos); //è¾“å…¥äº‹ä»¶ï¼Œå³ç†Ÿæ‚‰çš„äº‹ä»¶åˆ†å‘ä½“ç³» mFrameInfo.markAnimationsStart(); doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos); //åŠ¨ç”» doCallbacks(Choreographer.CALLBACK_INSETS_ANIMATION, frameTimeNanos); //åŠ¨ç”» mFrameInfo.markPerformTraversalsStart(); doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos); //æµ‹ç»˜ doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos); //æäº¤ï¼Œå¤„ç†ç»˜åˆ¶åçš„å¸§æ›´æ–° } finally { AnimationUtils.unlockAnimationClock(); Trace.traceEnd(Trace.TRACE_TAG_VIEW); }} doFrame()-&gt; æŒ‰callbacktypeä¾æ¬¡æ‰§è¡Œå°†doCallbacks()ï¼Œå³æ‰§è¡ŒdoCallbacks(0ã€1ã€2ã€3ã€4,? frameTimeNanos) doCallbacks(int callbackType, long frameTimeNanos)-&gt; æ ¹æ®ä¼ å…¥çš„callbackTypeä»mCallbackQuesuä¸­å–å‡ºå¯¹åº”çš„é˜Ÿåˆ—ï¼Œæ‰§è¡Œé˜Ÿåˆ—ä¸­åˆ°è¾¾æ‰§è¡Œæ—¶é—´çš„CallbackRecord å³ä¾æ¬¡ å°† è¾“å…¥é˜Ÿåˆ—ã€ åŠ¨ç”»é˜Ÿåˆ—ã€ç»˜åˆ¶é˜Ÿåˆ—ã€æäº¤é˜Ÿåˆ— ä¸­æ‰€æœ‰çš„åˆ°è¾¾æ‰§è¡Œæ—¶é—´çš„ å…ƒç´ ï¼ˆCallbackRecordï¼‰æ‰§è¡Œå…¶ä¸­çš„actionï¼ˆviewRootImpl ä¸­mChoreographer.mpostCallbackæ—¶ä¼ é€’çš„mTraversalsRunnableï¼‰ 12345678910111213141516171819202122void doCallbacks(int callbackType, long frameTimeNanos) { CallbackRecord callbacks; synchronized (mLock) { final long now = System.nanoTime(); // æ ¹æ®æŒ‡å®šçš„ç±»å‹CallbackkQueueä¸­æŸ¥æ‰¾åˆ°è¾¾æ‰§è¡Œæ—¶é—´çš„CallbackRecord callbacks = mCallbackQueues[callbackType].extractDueCallbacksLocked(now / TimeUtils.NANOS_PER_MS); //... try { // è¿­ä»£æ‰§è¡Œé˜Ÿåˆ—æ‰€æœ‰ä»»åŠ¡ for (CallbackRecord c = callbacks; c != null; c = c.next) { // å›è°ƒCallbackRecordçš„runï¼Œå…¶å†…éƒ¨å›è°ƒCallbackçš„run c.run(frameTimeNanos); } } finally { synchronized (mLock) { //... //é€’å½’å›æ”¶CallbackRecord //... } } } callbacktypeåˆ†ä¸º5ç§ï¼ˆå®é™…ä¸Šæ˜¯å››ç§ï¼Œæ–°ç‰ˆæœ¬Androidåˆå¹¶ååªå‰©å››ç§äº‹ä»¶ï¼šè¾“å…¥ã€åŠ¨ç”»ã€éå†traversalã€æäº¤ï¼‰ï¼š 123456789//è¾“å…¥äº‹ä»¶ï¼Œé¦–å…ˆæ‰§è¡Œ public static final int CALLBACK_INPUT = 0; //åŠ¨ç”»åˆå¹¶æˆä¸€ç§//åŠ¨ç”»ï¼Œç¬¬äºŒæ‰§è¡Œ public static final int CALLBACK_ANIMATION = 1;//æ’å…¥æ›´æ–°çš„åŠ¨ç”»ï¼Œç¬¬ä¸‰æ‰§è¡Œ public static final int CALLBACK_INSETS_ANIMATION = 2; //ç»˜åˆ¶ï¼Œç¬¬å››æ‰§è¡Œ public static final int CALLBACK_TRAVERSAL = 3; //æäº¤ï¼Œæœ€åæ‰§è¡Œï¼Œ public static final int CALLBACK_COMMIT = 4; ä¼˜å…ˆçº§çš„é«˜ä½å’Œå¤„ç†é¡ºåºæœ‰å…³ï¼Œæ¯å½“æ”¶åˆ° VSYNC ä¿¡å·æ—¶ï¼ŒChoreographer å°†é¦–å…ˆå¤„ç† INPUT ç±»å‹çš„ä»»åŠ¡ï¼Œç„¶åæ˜¯ ANIMATION ç±»å‹ï¼Œæœ€åæ‰æ˜¯ TRAVERSAL ç±»å‹ã€‚ -&gt; doCallbacks() -&gt; mTraversalRunnable -&gt; doTraversal() 123456789void doTraversal() { if (mTraversalScheduled) { mTraversalScheduled = false; // ç§»é™¤åŒæ­¥å±éšœ mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier); // çœŸæ­£æ‰§è¡ŒViewçš„measureï¼Œlayoutï¼Œdrawæµç¨‹ performTraversals(); }} é™„å½• Choreographeréƒ¨åˆ†æºç ï¼ˆAndroid4.1æ–°å¢ï¼‰Choreographer æ˜¯çº¿ç¨‹å•ä¾‹çš„ï¼ˆThreadLocalå®ç°ï¼‰ï¼Œè€Œä¸”å¿…é¡»è¦å’Œä¸€ä¸ª Looper ç»‘å®šï¼Œå› ä¸ºå…¶å†…éƒ¨æœ‰ä¸€ä¸ª Handler éœ€è¦å’Œ Looper ç»‘å®šï¼Œä¸€èˆ¬æ˜¯ App ä¸»çº¿ç¨‹çš„ Looper ç»‘å®š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960//Choreographer.class //postCallback(int callbackType, Object action, Object token) ä¼šä¸€æ­¥æ­¥èµ°åˆ°postCallbackDelayedInternal(delayMills = 0) private void postCallbackDelayedInternal(int callbackType, Object action, Object token, long delayMillis) { //... synchronized (mLock) { // å½“å‰æ—¶é—´ final long now = SystemClock.uptimeMillis(); // åŠ ä¸Šå»¶è¿Ÿæ—¶é—´ final long dueTime = now + delayMillis; //å–å¯¹åº”ç±»å‹çš„CallbackQueueæ·»åŠ ä»»åŠ¡ mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token); if (dueTime &lt;= now) { //ç«‹å³æ‰§è¡Œ scheduleFrameLocked(now); } else { //å»¶è¿Ÿè¿è¡Œï¼Œæœ€ç»ˆä¹Ÿä¼šèµ°åˆ°scheduleFrameLocked() Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action); msg.arg1 = callbackType; msg.setAsynchronous(true); mHandler.sendMessageAtTime(msg, dueTime); } } } private void scheduleFrameLocked(long now) { if (!mFrameScheduled) { mFrameScheduled = true; //å¼€å¯äº†VSYNC if (USE_VSYNC) { if (DEBUG_FRAMES) { Log.d(TAG, &quot;Scheduling next frame on vsync.&quot;); } //å½“å‰æ‰§è¡Œçš„çº¿ç¨‹ï¼Œæ˜¯å¦æ˜¯mLooperæ‰€åœ¨çº¿ç¨‹ if (isRunningOnLooperThreadLocked()) { //ç”³è¯· VSYNC ä¿¡å· scheduleVsyncLocked(); } else { // è‹¥ä¸åœ¨ï¼Œå°±ç”¨mHandlerå‘é€æ¶ˆæ¯åˆ°åŸçº¿ç¨‹ï¼Œæœ€åè¿˜æ˜¯è°ƒç”¨scheduleVsyncLockedæ–¹æ³• Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_VSYNC); msg.setAsynchronous(true);//å¼‚æ­¥ mHandler.sendMessageAtFrontOfQueue(msg); } } else { // å¦‚æœæœªå¼€å¯VSYNCåˆ™ç›´æ¥doFrameæ–¹æ³•ï¼ˆ4.1åé»˜è®¤å¼€å¯ï¼‰ final long nextFrameTime = Math.max( mLastFrameTimeNanos / TimeUtils.NANOS_PER_MS + sFrameDelay, now); if (DEBUG_FRAMES) { Log.d(TAG, &quot;Scheduling next frame in &quot; + (nextFrameTime - now) + &quot; ms.&quot;); } Message msg = mHandler.obtainMessage(MSG_DO_FRAME); msg.setAsynchronous(true);//å¼‚æ­¥ mHandler.sendMessageAtTime(msg, nextFrameTime); } }} ä¸‰ã€invalidate/requestLayoutæµç¨‹invalidate/postInvalidat/requestLayoutç®€è¦åŒºåˆ«: invalidateåªä¼šè°ƒonDrawæ–¹æ³•ä¸”å¿…é¡»åœ¨UIçº¿ç¨‹ä¸­è°ƒç”¨ postInvalidateåªä¼šè°ƒonDrawæ–¹æ³•ï¼Œå¯åœ¨éUIçº¿ç¨‹ä¸­å›è°ƒ requestLayoutä¼šè°ƒonMeasureã€onLayoutå’ŒonDraw(ç‰¹å®šæ¡ä»¶ä¸‹)æ–¹æ³• invalidateè°ƒç”¨ View.invalidate() æ–¹æ³•åä¼šé€çº§å¾€ä¸Šè°ƒç”¨çˆ¶ View çš„ç›¸å…³æ–¹æ³•ï¼Œæœ€ç»ˆåœ¨ Choreographer çš„æ§åˆ¶ä¸‹è°ƒç”¨ ViewRootImpl.performTraversals() æ–¹æ³•ã€‚åªæœ‰æ»¡è¶³ å¯è§æ€§ã€å°ºå¯¸å‘ç”Ÿå˜åŒ–æ—¶ ç­‰æ¡ä»¶æ‰ä¼šæ‰§è¡Œ measure å’Œ layout æµç¨‹ï¼Œå¦åˆ™åªæ‰§è¡Œ draw æµç¨‹ï¼Œdraw æµç¨‹çš„æ‰§è¡Œè¿‡ç¨‹ä¸æ˜¯å¦å¼€å¯ç¡¬ä»¶åŠ é€Ÿæœ‰å…³ï¼š å…³é—­ç¡¬ä»¶åŠ é€Ÿåˆ™ä» DecorView å¼€å§‹å¾€ä¸‹çš„æ‰€æœ‰å­ View éƒ½ä¼šè¢«é‡æ–°ç»˜åˆ¶ã€‚å¼€å¯ç¡¬ä»¶åŠ é€Ÿåˆ™åªæœ‰è°ƒç”¨ invalidate æ–¹æ³•çš„ View æ‰ä¼šé‡æ–°ç»˜åˆ¶ã€‚ requestLayoutè°ƒç”¨ View.requestLayout æ–¹æ³•åä¼šä¾æ¬¡è°ƒç”¨ performMeasure, performLayout å’Œ performDraw æ–¹æ³•ï¼Œè°ƒç”¨è€… View åŠå…¶çˆ¶ View ä¼šé‡æ–°ä»ä¸Šå¾€ä¸‹è¿›è¡Œ measure, layout æµç¨‹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šæ‰§è¡Œ draw æµç¨‹(å­ View ä¼šé€šè¿‡åˆ¤æ–­å…¶å°ºå¯¸/é¡¶ç‚¹æ˜¯å¦å‘ç”Ÿæ”¹å˜è€Œå†³å®šæ˜¯å¦é‡æ–° measure/layout/draw æµç¨‹)ã€‚ å°ç»“ï¼šå› æ­¤ï¼Œå½“åªéœ€è¦è¿›è¡Œé‡ç»˜æ—¶å¯ä»¥ä½¿ç”¨ invalidate æ–¹æ³•ï¼Œå¦‚æœéœ€è¦é‡æ–°æµ‹é‡å’Œå¸ƒå±€åˆ™å¯ä»¥ä½¿ç”¨ requestLayout æ–¹æ³•ï¼Œè€Œ requestLayout æ–¹æ³•ä¸ä¸€å®šä¼šé‡ç»˜ï¼Œå› æ­¤å¦‚æœè¦è¿›è¡Œé‡ç»˜å¯ä»¥å†æ‰‹åŠ¨è°ƒç”¨ invalidate æ–¹æ³•ã€‚ å­çº¿ç¨‹æ›´æ–°UI1ã€ä¸ºå•¥ä¼šå´©ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455-&gt; è§†å›¾æ›´æ–°æ“ä½œinvalidata-&gt; View.invalidate -&gt; View.invalidateInternal -&gt; ViewGroup.invalidateChild //æ­£å¸¸æƒ…å†µViewä¸Šä¸€å±‚çº§ä¸ºViewGroupï¼Œå¦‚æœä¸Šä¸€å±‚ç›´æ¥æ—¶ViewRootImplåˆ™æ²¡æœ‰è¿™å±‚-&gt; ViewParent.invalidateChildInParent //è¿™é‡Œä¼šä¸æ–­do whileå»å–ä¸Šä¸€ä¸ªç»“ç‚¹çš„mParentï¼Œä»ViewGroupä¸€ç›´åˆ°ViewRootImplä¸ºæ­¢-&gt; ViewRootImpl.invalidateChildInParent //DecorViewçš„mParentæ˜¯ViewRootImpl-&gt; ViewRootImpl.checkThread //åœ¨è¿™é‡Œæ‰§è¡ŒcheckThreadï¼Œå¦‚æœéViewRootImplåˆ›å»ºçº¿ç¨‹åˆ™æŠ›å‡ºå¼‚å¸¸ ViewRootImpl.class final Thread mThread; ...public ViewRootImpl(Context context, Display display) { mcontext = context; mWindowSession = WindowMangerGlobal.getWindowSession(); ... mThread = Thread.currentThread(); ...} ... @Override //override from ViewParent interfacepublic ViewParent invalidateChildInParent(int[] location, Rect dirty) { checkThread(); if (DEBUG_DRAW) Log.v(mTag, &quot;Invalidate child: &quot; + dirty); if (dirty == null) { invalidate(); return null; } else if (dirty.isEmpty() &amp;&amp; !mIsAnimating) { return null; } if (mCurScrollY != 0 || mTranslator != null) { mTempRect.set(dirty); dirty = mTempRect; if (mCurScrollY != 0) { dirty.offset(0, -mCurScrollY); } if (mTranslator != null) { mTranslator.translateRectInAppWindowToScreen(dirty); } if (mAttachInfo.mScalingRequired) { dirty.inset(-1, -1); } } invalidateRectOnScreen(dirty); return null;} 123456789101112-&gt; è§†å›¾æ›´æ–°æ“ä½œrequestLayout-&gt; mParent.reqeustLayout // ä¸æ–­å‘çˆ¶æ§ä»¶(mparentå³ViewParentæ¥å£ï¼ŒViewGroupä¸ViewRootImpléƒ½å®ç°äº†è¯¥æ¥å£,å¯åšä¸ºviewçš„parent)è¯·æ±‚å¸ƒå±€ï¼Œæœ€åè°ƒç”¨åˆ°ViewRootImplçš„requestLayout-&gt; ViewRootImpl.requestLayoutViewRootImpl.classpublic void requestLayout() { if (!mHandlingLayoutInLayoutRequest) { checkThread(); mLayoutRequested = true; scheduleTraversals(); }} 123456void checkThread() { if (mThread != Thread.currentThread()) { throw new CalledFromWrongThreadException( &quot;Only the original thread that created a view hierarchy can touch its views.&quot;); }} 2ã€å­çº¿ç¨‹æ›´æ–°UIæ€ä¹ˆä¸å´©ï¼š å­çº¿ç¨‹åœ¨ViewRootImplåˆå§‹åŒ–ä¹‹å‰ï¼ˆhandleResumeActivityä¹‹ååˆå§‹åŒ–ï¼‰ ViewRootImplåˆ›å»ºçº¿ç¨‹ åªéœ€è¦ä¸ Viewçš„æ›´æ–°çº¿ç¨‹ æ˜¯åŒä¸€ä¸ªå°±è¡Œï¼ˆåˆå§‹åŒ–åœ¨å­çº¿ç¨‹ï¼Œæ›´æ–°åœ¨ä¸»çº¿ç¨‹ä¸€æ ·ä¼šå´©ï¼‰ View.postä¸getHandler.postview.poståœ¨å†…éƒ¨ç±»AttachInfoæœªå®ä¾‹åŒ–ä¹‹å‰æ˜¯ä¼šå°†actioné€šè¿‡getRunQueue().post(action)ç¼“å­˜èµ·æ¥ï¼Œå»¶ååˆ°handleResumeActivityä¸­åˆå§‹åŒ–ViewRootImpæ—¶è°ƒç”¨setViewæ—¶ï¼Œä¼šä»é¡¶å‘ä¸‹è°ƒç”¨View/ViewGroupçš„dispatchAttachToWindowæ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•å†…ç¼“å­˜çš„actionä¼šè¢«æ‰§è¡Œ Activityçš„ViewRootImplåœ¨onResumeæ–¹æ³•ä¸­åˆ›å»ºçš„ï¼Œå…·ä½“è§ä¸‹ å››ã€åŒæ­¥æ¶ˆæ¯å±éšœåœ¨invalidate/requestLayoutæ‰§è¡Œæ—¶ï¼Œæœ€åéƒ½ä¼šèµ°å‘ViewRootImplçš„scheduleTraversals()æ–¹æ³•ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­ä¼šè°ƒç”¨mHandler.getLooper().getQueue().postSyncBarrier();ï¼Œæœ¬è´¨ä¸Šæ˜¯å¾€ä¸»çº¿ç¨‹Looperä¸­postä¸€ä¸ªtarget==nullçš„æ¶ˆæ¯ï¼Œä½œä¸ºåŒæ­¥æ¶ˆæ¯å±éšœï¼Œè¿‡æ»¤æ‰æ‰€æœ‰éå¼‚æ­¥çš„æ¶ˆæ¯ï¼Œåªæ‰§è¡Œå¼‚æ­¥æ¶ˆæ¯ã€‚ åŒæ—¶Choreographeræ³¨å†ŒVsyncå›è°ƒï¼Œä¸‹ä¸€ä¸ªVsyncæ¶ˆæ¯å‘å‡ºåå›è°ƒå›æ¥ç§»é™¤åŒæ­¥æ¶ˆæ¯å±éšœå¹¶æ‰§è¡Œ performTraversals(ä¹Ÿå°±æ˜¯measureã€layoutã€draw) äº”ã€ChoreoGrapherä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–Activityå¯åŠ¨åï¼Œæ‰§è¡Œå®ŒActivitityThread.performResumeActivity()ï¼Œå†æ‰§è¡ŒWindowManagerImpl.addView()ï¼Œåœ¨å…¶å†…éƒ¨ä¼šæ‰§è¡ŒViewRootImplçš„åˆå§‹åŒ–ã€‚Choreographerçš„åˆå§‹åŒ–å°±æ˜¯åœ¨ViewRootImplçš„æ„é€ æ–¹æ³•ä¸­æ‰§è¡Œçš„ã€‚ ViewRootImplçš„å…³é”®å…¨å±€å˜é‡é™¤äº†Choreographerï¼ˆæŒç®¡ç»˜åˆ¶ç›¸å…³ï¼‰å¤–ï¼Œè¿˜æœ‰attachInfoï¼ˆï¼‰","link":"/2021/04/01/ScreenDraw/"},{"title":"","text":"JMM30 å¼ å›¾ï¼Œä»¥ DEBUG æ–¹å¼æ·±å…¥ç†è§£çº¿ç¨‹çš„åº•å±‚è¿è¡ŒåŸç†https://cloud.tencent.com/developer/article/1818100 JVMæ ˆ20å¼ å›¾åŠ©ä½ äº†è§£JVMè¿è¡Œæ—¶æ•°æ®åŒºï¼Œä½ è¿˜è§‰å¾—æ¯ç‡¥å—ï¼Ÿhttps://cloud.tencent.com/developer/article/1823397?areaId=106001","link":"/2024/04/19/TempEdit/"},{"title":"tcp","text":"ç®€è¿°ï¼š Tcpæ˜¯ é¢å‘é“¾æ¥çš„é¢å‘å­—èŠ‚æµçš„å¯é çš„ï¼ˆå‡ ä¸ªç‚¹ï¼‰ ä¿è¯å¯é çš„æ‰‹æ®µï¼š æ•°æ®åˆ†å—â€”â€”æ¡æ‰‹æ—¶åå•†ç¡®å®šMSSï¼Œå¤§äºMSSçš„tcpæ•°æ®åŒ…åˆ†æ®µï¼ˆä¹Ÿå°±æ˜¯æ‹†åŒ…ï¼‰ï¼›åºåˆ—å·ï¼›æ ¡éªŒå’Œï¼›ç¡®è®¤ackåŒ…ï¼› è¶…æ—¶é‡ä¼ â€”â€”å‘é€æ–¹ä½¿ç”¨ä¸€ä¸ªä¿å®ˆä¼°è®¡çš„æ—¶é—´ä½œä¸ºæ”¶åˆ°æ•°æ®åŒ…çš„ç¡®è®¤çš„è¶…æ—¶ä¸Šé™RTOã€‚å¦‚æœè¶…è¿‡è¿™ä¸ªä¸Šé™ä»æœªæ”¶åˆ°ç¡®è®¤åŒ…ï¼Œå‘é€æ–¹å°†é‡ä¼ è¿™ä¸ªæ•°æ®åŒ…ã€‚æ¯å½“å‘é€æ–¹æ”¶åˆ°ç¡®è®¤åŒ…åï¼Œä¼šé‡ç½®è¿™ä¸ªé‡ä¼ å®šæ—¶å™¨ã€‚ è¶…æ—¶é‡ä¼ ä¼šè§¦å‘æ‹¥å¡æ§åˆ¶ä¹‹é‡ç½®æ‹¥å¡çª—å£ä¸º1ä¸ªMSSï¼Œé˜ˆå€¼å‡ä¸ºå½“å‰cwndä¸€åŠï¼Œæ‰§è¡Œæ…¢å¯åŠ¨æ¯è½®å¾€è¿”æ‹¥å¡å€å¢ æ»‘åŠ¨çª—å£å®ç°çš„æµé‡æ§åˆ¶ï¼›æ¥æ”¶æ–¹åœ¨ackåŒ…ä¸­è®¾ç½®rwndæ§åˆ¶å‘é€æ–¹å‘é€é€Ÿåº¦ã€‚ æ‹¥å¡æ§åˆ¶ç®—æ³•â€”â€”å°äºé˜ˆå€¼ä¹‹å‰ä»1å¼€å§‹æ¯è½®å¾€è¿”æ‹¥å¡çª—å£cwndå€å¢ï¼ˆæ…¢å¯åŠ¨ï¼‰ï¼Œæ‹¥å¡çª—å£å¤§äºé˜ˆå€¼åæ­¥é•¿ä¸ºä¸€çš„é€’å¢ï¼ˆæ‹¥å¡é¿å…ï¼‰ã€‚æ¥æ”¶æ–¹æ”¶åˆ°å¤±åºæŠ¥æ–‡æ®µåç«‹å³å‘å‡ºé‡å¤ç¡®è®¤ackåŒ…ï¼Œå‘é€æ–¹è¿ç»­ä¸‰æ¬¡é‡å¤ç¡®è®¤åˆ™ç›´æ¥å‘é€ç¼ºä¹ackçš„ä¸¢åŒ…ï¼ˆå¿«é€Ÿé‡ä¼ ï¼‰ï¼ŒåŒæ—¶æŠŠé˜ˆå€¼å‡ä¸ºcwnd/2å¹¶è°ƒæ•´æ‹¥å¡çª—å£ä¸ºæ–°é˜ˆå€¼è€Œåæ‰§è¡Œæ‹¥å¡é¿å…ç®—æ³•ï¼ˆå¿«é€Ÿæ¢å¤ï¼‰ï¼› Ps: è¶…æ—¶é‡ä¼ ä¼šè§¦å‘æ‹¥å¡æ§åˆ¶ä¹‹é‡ç½®æ‹¥å¡çª—å£ä¸º1ä¸ªMSSï¼Œé˜ˆå€¼å‡ä¸ºå½“å‰cwndä¸€åŠï¼Œæ‰§è¡Œæ…¢å¯åŠ¨æ¯è½®å¾€è¿”æ‹¥å¡å€å¢ï¼› ä¸‰æ¬¡é‡å¤ç¡®è®¤ä¼šæ‰§è¡Œå¿«é€Ÿé‡ä¼ å¿«é€Ÿæ¢å¤ï¼Œé˜ˆå€¼å‡ä¸ºå½“å‰cwndä¸€åŠï¼Œæ‹¥å¡çª—å£ä¸ºæ–°é˜ˆå€¼å€¼ï¼Œæ‰§è¡Œæ‹¥å¡é¿å…ï¼Œæ¯è½®å¾€è¿”é€’å¢ï¼› First of AllåºŸè¯å°‘è¯´ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“TCPåœ¨ç½‘ç»œOSIçš„ä¸ƒå±‚æ¨¡å‹ä¸­çš„ç¬¬å››å±‚â€”â€”Transportå±‚ï¼ŒIPåœ¨ç¬¬ä¸‰å±‚â€”â€”Networkå±‚ï¼ŒARPåœ¨ç¬¬äºŒå±‚â€”â€”Data Linkå±‚ï¼Œåœ¨ç¬¬äºŒå±‚ä¸Šçš„æ•°æ®ï¼Œæˆ‘ä»¬å«Frameï¼Œåœ¨ç¬¬ä¸‰å±‚ä¸Šçš„æ•°æ®å«Packetï¼Œç¬¬å››å±‚çš„æ•°æ®å«Segmentã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼Œæˆ‘ä»¬ç¨‹åºçš„æ•°æ®é¦–å…ˆä¼šæ‰“åˆ°TCPçš„Segmentä¸­ï¼Œç„¶åTCPçš„Segmentä¼šæ‰“åˆ°IPçš„Packetä¸­ï¼Œç„¶åå†æ‰“åˆ°ä»¥å¤ªç½‘Ethernetçš„Frameä¸­ï¼Œä¼ åˆ°å¯¹ç«¯åï¼Œå„ä¸ªå±‚è§£æè‡ªå·±çš„åè®®ï¼Œç„¶åæŠŠæ•°æ®äº¤ç»™æ›´é«˜å±‚çš„åè®®å¤„ç†ã€‚ TCP segmentï¼ˆæ®µï¼‰, IP packetï¼ˆåŒ…ï¼‰ UDP å’Œ TCP çš„ç‰¹ç‚¹ä¸åŒºåˆ«ç”¨æˆ·æ•°æ®æŠ¥åè®® UDPï¼ˆUser Datagram Protocolï¼‰ æ˜¯æ— è¿æ¥çš„ï¼Œå°½æœ€å¤§å¯èƒ½äº¤ä»˜ï¼Œæ²¡æœ‰æ‹¥å¡æ§åˆ¶ï¼Œé¢å‘æŠ¥æ–‡ï¼ˆå¯¹äºåº”ç”¨ç¨‹åºä¼ ä¸‹æ¥çš„æŠ¥æ–‡ä¸åˆå¹¶ä¹Ÿä¸æ‹†åˆ†ï¼Œåªæ˜¯æ·»åŠ  UDP é¦–éƒ¨ï¼‰ï¼Œæ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šçš„äº¤äº’é€šä¿¡ã€‚æ•ˆç‡é«˜ã€‚ ä¼ è¾“æ§åˆ¶åè®® TCPï¼ˆTransmission Control Protocolï¼‰ æ˜¯é¢å‘è¿æ¥çš„ï¼Œæä¾›å¯é äº¤ä»˜ï¼Œæœ‰æµé‡æ§åˆ¶ï¼Œæ‹¥å¡æ§åˆ¶ï¼Œæä¾›å…¨åŒå·¥é€šä¿¡ï¼Œé¢å‘å­—èŠ‚æµï¼ˆæŠŠåº”ç”¨å±‚ä¼ ä¸‹æ¥çš„æŠ¥æ–‡çœ‹æˆå­—èŠ‚æµï¼ŒæŠŠå­—èŠ‚æµç»„ç»‡æˆå¤§å°ä¸ç­‰çš„æ•°æ®å—ï¼‰ï¼Œæ¯ä¸€æ¡ TCP è¿æ¥åªèƒ½æ˜¯ç‚¹å¯¹ç‚¹çš„ï¼ˆä¸€å¯¹ä¸€ï¼‰ã€‚æ•ˆç‡ä½ã€‚ Tcpåè®®æ˜¯æ€ä¹ˆä¿è¯å¯é ä¼ è¾“ æ•°æ®åˆ†å—ï¼šåº”ç”¨æ•°æ®è¢«åˆ†å‰²æˆ TCP è®¤ä¸ºæœ€é€‚åˆå‘é€çš„æ•°æ®å—ï¼ˆMTU=1500= MSS1460 + TCPå¤´20+IPå¤´20ï¼‰ã€‚ å¤§äºä¸€ä¸ªMSSçš„ä¼šè¢«æ‹†åŒ…ï¼Œå°äºMSSçš„ç›¸è¿å‘å‡ºçš„åŒ…ä¼šç²˜åŒ…ã€‚ åºåˆ—å·ï¼šTCP ç»™å‘é€çš„æ¯ä¸€ä¸ªåŒ…è¿›è¡Œç¼–å·ï¼Œæ¥æ”¶æ–¹å¯¹æ•°æ®åŒ…è¿›è¡Œæ’åºï¼ŒæŠŠæœ‰åºæ•°æ®ä¼ é€ç»™åº”ç”¨å±‚ã€‚ é¦–éƒ¨ä¸­çš„seqå­—æ®µ32ä½ï¼Œå¦‚æœSYNæ ‡è®°ä½æ‰“å¼€ï¼Œåˆ™ä¸ºæ¡æ‰‹æ—¶åˆå§‹åŒ–éšæœºåºåˆ—å·ã€‚ä¿è¯æ¯ä¸ªåŒ…çš„æœ‰åº æ ¡éªŒå’Œï¼šå‘é€çš„æ•°æ®åŒ…çš„äºŒè¿›åˆ¶ç›¸åŠ ç„¶åå–åï¼Œç›®çš„æ˜¯æ£€æµ‹æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„ä»»ä½•å˜åŒ–ã€‚å¦‚æœæ”¶åˆ°æ®µçš„æ£€éªŒå’Œæœ‰å·®é”™ï¼ŒTCPå°†ä¸¢å¼ƒè¿™ä¸ªæŠ¥æ–‡æ®µå’Œä¸ç¡®è®¤æ”¶åˆ°æ­¤æŠ¥æ–‡æ®µã€‚ ç¡®è®¤åº”ç­”ï¼šTCP ä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡æ¥æ”¶æ–¹æ”¶åˆ°æ•°æ®åï¼Œéƒ½ä¼šå¯¹ä¼ è¾“æ–¹è¿›è¡Œç¡®è®¤åº”ç­”ã€‚ä¹Ÿå°±æ˜¯å‘é€ ACK æŠ¥æ–‡ã€‚è¿™ä¸ª ACK æŠ¥æ–‡å½“ä¸­å¸¦æœ‰å¯¹åº”çš„ç¡®è®¤åºåˆ—å·ï¼Œå‘Šè¯‰å‘é€æ–¹ï¼Œæ¥æ”¶åˆ°äº†å“ªäº›æ•°æ®ï¼Œä¸‹ä¸€æ¬¡çš„æ•°æ®ä»å“ªé‡Œå‘ã€‚ ACKåŒ…=ackæ ‡è®°ä½ç½®1æ¥å—åˆ°çš„seq+1 æµé‡æ§åˆ¶ï¼š TCP è¿æ¥çš„æ¯ä¸€æ–¹éƒ½æœ‰å›ºå®šå¤§å°çš„ç¼“å†²ç©ºé—´ï¼ŒTCPçš„æ¥æ”¶ç«¯åªå…è®¸å‘é€ç«¯å‘é€æ¥æ”¶ç«¯ç¼“å†²åŒºèƒ½æ¥çº³çš„æ•°æ®ã€‚å½“æ¥æ”¶æ–¹æ¥ä¸åŠå¤„ç†å‘é€æ–¹çš„æ•°æ®ï¼Œèƒ½æç¤ºå‘é€æ–¹é™ä½å‘é€çš„é€Ÿç‡ï¼Œé˜²æ­¢åŒ…ä¸¢å¤±ã€‚TCP ä½¿ç”¨çš„æµé‡æ§åˆ¶åè®®æ˜¯å¯å˜å¤§å°çš„æ»‘åŠ¨çª—å£åè®®ã€‚ ï¼ˆTCP åˆ©ç”¨æ»‘åŠ¨çª—å£å®ç°æµé‡æ§åˆ¶ï¼‰ é¦–éƒ¨ä¸­çš„16ä½WINå­—æ®µï¼Œç”±æ¥æ”¶æ–¹è¿”å›ç»™å‘é€ç«¯çš„ackä¸­æºå¸¦ï¼Œé€šçŸ¥å‘é€ç«¯è‡ªèº«ç¼“å†²åŒºè¿˜èƒ½æ¥çº³çš„æ•°æ®ã€‚ æ‹¥å¡æ§åˆ¶ï¼š å½“ç½‘ç»œæ‹¥å¡æ—¶ï¼Œå‡å°‘æ•°æ®çš„å‘é€ã€‚ ä¸€ä¸ºæ…¢å¯åŠ¨å’Œæ‹¥å¡é¿å…ç®—æ³•ï¼ˆå°äºé˜ˆå€¼å€å¢å¤§äºé˜ˆå€¼åŠ ä¸€é€’å¢ï¼Œè¶…æ—¶é‡ä¼ è§¦å‘é‡ç½®cwndä¸º1å¹¶æ…¢å¯åŠ¨ï¼‰ äºŒä¸ºå¿«é€Ÿé‡ä¼ å’Œå¿«é€Ÿå›å¤ï¼ˆè¿ç»­ä¸‰æ¬¡é‡å¤ç¡®è®¤ä¼šè§¦å‘å¿«é€Ÿæ¢å¤ï¼Œå³é˜ˆå€¼å‡åŠï¼Œcwnd=æ–°é˜ˆå€¼ï¼Œæ‹¥å¡é¿å…ï¼‰ è¶…æ—¶é‡ä¼ ï¼š å½“ TCP å‘å‡ºä¸€ä¸ªæ®µåï¼Œå®ƒå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ï¼ˆä¸€ä¸ªè¶…æ—¶æ—¶é—´RTOï¼‰ï¼Œç­‰å¾…ç›®çš„ç«¯ç¡®è®¤æ”¶åˆ°è¿™ä¸ªæŠ¥æ–‡æ®µã€‚å¦‚æœä¸èƒ½åŠæ—¶æ”¶åˆ°ä¸€ä¸ªç¡®è®¤ï¼Œå°†é‡å‘è¿™ä¸ªæŠ¥æ–‡æ®µã€‚ å¦‚æœä¸€ä¸ªå·²ç»å‘é€çš„æŠ¥æ–‡æ®µåœ¨è¶…æ—¶æ—¶é—´RTOå†…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼Œé‚£ä¹ˆå°±é‡ä¼ è¿™ä¸ªæŠ¥æ–‡æ®µï¼Œé˜ˆå€¼å‡åŠï¼Œé‡ç½®cwndä¸º1åæ…¢å¯åŠ¨ Tcpçš„è¿æ¥å’Œæ–­å¼€è¿‡ç¨‹ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹tcpæ¡æ‰‹æŒ¥æ‰‹å’ŒçŠ¶æ€æœº ä¸‰æ¬¡æ¡æ‰‹ï¼šå³ï¼šclientå‘èµ·ä¸€ä¸ªSynåŒ…åŒ…å«clientåºåˆ—å· -&gt; serveræ”¶åˆ°åè¿”å›ack(clientåºåˆ—å·+1)åŒ…å’ŒSynåŒ…åŒ…å«serveråºåˆ—å· -&gt; clientå›é¦ˆä¸€ä¸ªackåŒ…(serveråºåˆ—å·+1)ï¼Œä¸‰æ¬¡ä¹‹åclientå’Œserveréƒ½ç¡®è®¤äº†å¯¹æ–¹çš„è¯»å†™èƒ½åŠ› TCP è¿›è¡Œæ¡æ‰‹åˆå§‹åŒ–ä¸€ä¸ªè¿æ¥çš„ç›®æ ‡æ˜¯ï¼š**åˆ†é…èµ„æºã€åˆå§‹åŒ–åºåˆ—å·(é€šçŸ¥ peer å¯¹ç«¯æˆ‘çš„åˆå§‹åºåˆ—å·æ˜¯å¤šå°‘)**ï¼ŒçŸ¥é“åˆå§‹åŒ–è¿æ¥çš„ç›®æ ‡ï¼Œé‚£ä¹ˆè¦è¾¾æˆè¿™ä¸ªç›®æ ‡çš„è¿‡ç¨‹å°±ç®€å•äº†ï¼Œæ¡æ‰‹è¿‡ç¨‹å¯ä»¥ç®€åŒ–ä¸ºä¸‹é¢çš„å››æ¬¡äº¤äº’ï¼š ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼š1ï¼‰client ç«¯é¦–å…ˆå‘é€ä¸€ä¸ª SYN åŒ…å‘Šè¯‰ Server ç«¯æˆ‘çš„åˆå§‹åºåˆ—å·æ˜¯ Xï¼› ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼š2ï¼‰Server ç«¯æ”¶åˆ° SYN åŒ…åå›å¤ç»™ client ä¸€ä¸ª ACK ç¡®è®¤åŒ…ï¼Œå‘Šè¯‰ client è¯´æˆ‘æ”¶åˆ°äº†ï¼› 3ï¼‰æ¥ç€ Server ç«¯ä¹Ÿéœ€è¦å‘Šè¯‰ client ç«¯è‡ªå·±çš„åˆå§‹åºåˆ—å·ï¼Œäºæ˜¯ Server ä¹Ÿå‘é€ä¸€ä¸ª SYN åŒ…å‘Šè¯‰ client æˆ‘çš„åˆå§‹åºåˆ—å·æ˜¯ Yï¼› ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼š4ï¼‰Client æ”¶åˆ°åï¼Œå›å¤ Server ä¸€ä¸ª ACK ç¡®è®¤åŒ…è¯´æˆ‘çŸ¥é“äº†ã€‚ å…¶ä¸­2ï¼‰3ï¼‰åˆå¹¶åœ¨ä¸€èµ·å½¢æˆç¬¬äºŒæ¬¡æ¡æ‰‹ï¼Œä¹Ÿå°±æ˜¯serverå›ä¸€ä¸ªSYN+ACKåŒ…ï¼Œåºåˆ—å·ä¸ºYï¼Œackä¸ºX+1ï¼› Question: ä¸€å®šæ˜¯ä¸‰æ¬¡å—ï¼Ÿ å¤§éƒ¨åˆ†æƒ…å†µä¸‹å»ºç«‹è¿æ¥éœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œä¹Ÿä¸ä¸€å®šéƒ½æ˜¯ä¸‰æ¬¡ï¼Œæœ‰å¯èƒ½å‡ºç°å››æ¬¡æ¡æ‰‹æ¥å»ºç«‹è¿æ¥çš„ã€‚å¦‚ä¸‹å›¾ï¼Œå½“ Peer ä¸¤ç«¯åŒæ—¶å‘èµ· SYN æ¥å»ºç«‹è¿æ¥çš„æ—¶å€™ï¼Œå°±å‡ºç°äº†å››æ¬¡æ¡æ‰‹æ¥å»ºç«‹è¿æ¥(å¯¹äºæœ‰äº› TCP/IP çš„å®ç°ï¼Œå¯èƒ½ä¸æ”¯æŒè¿™ç§åŒæ—¶æ‰“å¼€çš„æƒ…å†µ)ã€‚ åˆå§‹åŒ–åºåˆ—å· Xã€Y æ˜¯å¯ä»¥æ˜¯å†™æ­»å›ºå®šçš„å—ï¼Œä¸ºä»€ä¹ˆä¸èƒ½å‘¢ï¼Ÿ ä¸èƒ½ï¼Œå‡å¦‚åºåˆ—å·å›ºå®šçš„è¯ï¼Œå‡è®¾ä¸º1ï¼Œå¦‚æœåˆšå¼€å§‹clientç»™serverå‘é€çš„10ä¸ªåŒ…è¢«ç¼“å­˜ä½äº†ï¼Œåˆæ°å¥½clientæ‰äº†ã€‚è¿‡äº†ä¸€ä¼šï¼Œclientåˆç”¨åŒæ ·çš„ç«¯å£é‡è¿å›æ¥äº†ï¼Œåºåˆ—å·é‡æ–°ä»1å¼€å§‹å‘é€ï¼Œè¿å‘5ä¸ªåŒ…ã€‚è¿™æ—¶å€™åˆæ°å¥½ä¹‹å‰è¢«è·¯ç”±å™¨ç¼“å­˜ä½çš„10ä¸ªåŒ…å…¨éƒ¨è¢«è·¯ç”±åˆ°serverç«¯äº†ï¼Œç„¶åserverç»™clientå›ack=10çš„åŒ…ã€‚é‚£ä¹ˆclientå°±ä¹±äº†ï¼Œæ‰å‘äº†5ä¸ªï¼ˆé‡è¿åçš„ï¼‰serverå°±è¿”å›äº†ç¡®è®¤å·ä¸º10çš„ï¼Ÿæ•…æ˜¾ç„¶ä¸è¡Œã€‚ ISNæ˜¯ä¸èƒ½hard codeçš„ï¼Œä¸ç„¶ä¼šå‡ºé—®é¢˜çš„â€”â€”æ¯”å¦‚ï¼šå¦‚æœè¿æ¥å»ºå¥½åå§‹ç»ˆç”¨1æ¥åšISNï¼Œå¦‚æœclientå‘äº†30ä¸ªsegmentè¿‡å»ï¼Œä½†æ˜¯ç½‘ç»œæ–­äº†ï¼Œäºæ˜¯ clienté‡è¿ï¼Œåˆç”¨äº†1åšISNï¼Œä½†æ˜¯ä¹‹å‰è¿æ¥çš„é‚£äº›åŒ…åˆ°äº†ï¼Œäºæ˜¯å°±è¢«å½“æˆäº†æ–°è¿æ¥çš„åŒ…ï¼Œæ­¤æ—¶ï¼Œclientçš„Sequence Number å¯èƒ½æ˜¯3ï¼Œè€ŒServerç«¯è®¤ä¸ºclientç«¯çš„è¿™ä¸ªå·æ˜¯30äº†ã€‚å…¨ä¹±äº†ã€‚RFC793ä¸­è¯´ï¼ŒISNä¼šå’Œä¸€ä¸ªå‡çš„æ—¶é’Ÿç»‘åœ¨ä¸€èµ·ï¼Œè¿™ä¸ªæ—¶é’Ÿä¼šåœ¨æ¯4å¾®ç§’å¯¹ISNåšåŠ ä¸€æ“ä½œï¼Œç›´åˆ°è¶…è¿‡2^32ï¼Œåˆä»0å¼€å§‹ã€‚è¿™æ ·ï¼Œä¸€ä¸ªISNçš„å‘¨æœŸå¤§çº¦æ˜¯4.55ä¸ªå°æ—¶ã€‚å› ä¸ºï¼Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬çš„TCP Segmentåœ¨ç½‘ç»œä¸Šçš„å­˜æ´»æ—¶é—´ä¸ä¼šè¶…è¿‡Maximum Segment Lifetimeï¼ˆç¼©å†™ä¸ºMSL â€“ Wikipediaè¯­æ¡ï¼‰ï¼Œæ‰€ä»¥ï¼Œåªè¦MSLçš„å€¼å°äº4.55å°æ—¶ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å°±ä¸ä¼šé‡ç”¨åˆ°ISNã€‚ å¦‚ Client å‘é€ä¸€ä¸ª SYN åŒ…ç»™ Server åå°±æŒ‚äº†æˆ–æ˜¯ä¸ç®¡äº†ï¼Œè¿™ä¸ªæ—¶å€™è¿™ä¸ªè¿æ¥å¤„äºä»€ä¹ˆçŠ¶æ€å‘¢ï¼Ÿä¼šè¶…æ—¶å—ï¼Ÿä¸ºä»€ä¹ˆå‘¢ï¼Ÿ é‡è¯•5æ¬¡ï¼Œä»1så¼€å§‹ï¼Œæ¯æ¬¡æ˜¯ä¹‹å‰çš„2å€ï¼Œ1s + 2s +4s+ 8s+ 16s + 32s =63s Linux ä¸‹é»˜è®¤ä¼šè¿›è¡Œ 5 æ¬¡é‡å‘ SYN-ACK åŒ…ï¼Œé‡è¯•çš„é—´éš”æ—¶é—´ä» 1s å¼€å§‹ï¼Œä¸‹æ¬¡çš„é‡è¯•é—´éš”æ—¶é—´æ˜¯å‰ä¸€æ¬¡çš„åŒå€ï¼Œ5 æ¬¡çš„é‡è¯•æ—¶é—´é—´éš”ä¸º 1s,2s, 4s, 8s,16sï¼Œæ€»å…± 31sï¼Œç¬¬ 5 æ¬¡å‘å‡ºåè¿˜è¦ç­‰ 32s éƒ½çŸ¥é“ç¬¬ 5 æ¬¡ä¹Ÿè¶…æ—¶äº†ï¼Œæ‰€ä»¥ï¼Œæ€»å…±éœ€è¦ 1s + 2s +4s+ 8s+ 16s + 32s =63sï¼ŒTCP æ‰ä¼šæŠŠæ–­å¼€è¿™ä¸ªè¿æ¥ã€‚ å…³äºSYN Floodæ”»å‡»ã€‚ä¸€äº›æ¶æ„çš„äººå°±ä¸ºæ­¤åˆ¶é€ äº†SYN Floodæ”»å‡»â€”â€”ç»™æœåŠ¡å™¨å‘äº†ä¸€ä¸ªSYNåï¼Œå°±ä¸‹çº¿äº†ï¼Œäºæ˜¯æœåŠ¡å™¨éœ€è¦é»˜è®¤ç­‰63sæ‰ä¼šæ–­å¼€è¿æ¥ï¼Œè¿™æ ·ï¼Œæ”»å‡»è€…å°±å¯ä»¥æŠŠæœåŠ¡å™¨çš„synè¿æ¥çš„é˜Ÿåˆ—è€—å°½ï¼Œè®©æ­£å¸¸çš„è¿æ¥è¯·æ±‚ä¸èƒ½å¤„ç†ã€‚äºæ˜¯ï¼ŒLinuxä¸‹ç»™äº†ä¸€ä¸ªå«tcp_syncookiesçš„å‚æ•°æ¥åº”å¯¹è¿™ä¸ªäº‹â€”â€”å½“SYNé˜Ÿåˆ—æ»¡äº†åï¼ŒTCPä¼šé€šè¿‡æºåœ°å€ç«¯å£ã€ç›®æ ‡åœ°å€ç«¯å£å’Œæ—¶é—´æˆ³æ‰“é€ å‡ºä¸€ä¸ªç‰¹åˆ«çš„Sequence Numberå‘å›å»ï¼ˆåˆå«cookieï¼‰ï¼Œå¦‚æœæ˜¯æ”»å‡»è€…åˆ™ä¸ä¼šæœ‰å“åº”ï¼Œå¦‚æœæ˜¯æ­£å¸¸è¿æ¥ï¼Œåˆ™ä¼šæŠŠè¿™ä¸ª SYN Cookieå‘å›æ¥ï¼Œç„¶åæœåŠ¡ç«¯å¯ä»¥é€šè¿‡cookieå»ºè¿æ¥ï¼ˆå³ä½¿ä½ ä¸åœ¨SYNé˜Ÿåˆ—ä¸­ï¼‰ã€‚è¯·æ³¨æ„ï¼Œè¯·å…ˆåƒä¸‡åˆ«ç”¨tcp_syncookiesæ¥å¤„ç†æ­£å¸¸çš„å¤§è´Ÿè½½çš„è¿æ¥çš„æƒ…å†µã€‚å› ä¸ºï¼Œsynccookiesæ˜¯å¦¥åç‰ˆçš„TCPåè®®ï¼Œå¹¶ä¸ä¸¥è°¨ã€‚å¯¹äºæ­£å¸¸çš„è¯·æ±‚ï¼Œä½ åº”è¯¥è°ƒæ•´ä¸‰ä¸ªTCPå‚æ•°å¯ä¾›ä½ é€‰æ‹©ï¼Œç¬¬ä¸€ä¸ªæ˜¯ï¼štcp_synack_retries å¯ä»¥ç”¨ä»–æ¥å‡å°‘é‡è¯•æ¬¡æ•°ï¼›ç¬¬äºŒä¸ªæ˜¯ï¼štcp_max_syn_backlogï¼Œå¯ä»¥å¢å¤§SYNè¿æ¥æ•°ï¼›ç¬¬ä¸‰ä¸ªæ˜¯ï¼štcp_abort_on_overflow å¤„ç†ä¸è¿‡æ¥å¹²è„†å°±ç›´æ¥æ‹’ç»è¿æ¥äº†ã€‚ å››æ¬¡æŒ¥æ‰‹å³ï¼šclientå‘èµ·FINåŒ… -&gt; serverå›ä¸€ä¸ªackåŒ… -&gt; serveræ•°æ®å‘å®Œäº†å°±ä¹Ÿå‘ä¸€ä¸ªFINåŒ… -&gt; clientå›ä¸€ä¸ªackåŒ…åŒæ—¶è¿›å…¥TIME_WAITé˜²æ­¢ackåŒ…ä¸¢å¤± TCP è¿›è¡Œæ–­å¼€è¿æ¥çš„ç›®æ ‡æ˜¯ï¼šå›æ”¶èµ„æºã€ç»ˆæ­¢æ•°æ®ä¼ è¾“ã€‚ç”±äº TCP æ˜¯å…¨åŒå·¥çš„ï¼Œéœ€è¦ Peer ä¸¤ç«¯åˆ†åˆ«å„è‡ªæ‹†é™¤è‡ªå·±é€šå‘ Peer å¯¹ç«¯çš„æ–¹å‘çš„é€šä¿¡ä¿¡é“ã€‚è¿™æ ·éœ€è¦å››æ¬¡æŒ¥æ‰‹æ¥åˆ†åˆ«æ‹†é™¤é€šä¿¡ä¿¡é“ï¼Œå°±æ¯”è¾ƒæ¸…æ™°æ˜äº†äº†ã€‚ ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼š 1ï¼‰Client å‘é€ä¸€ä¸ª FIN åŒ…æ¥å‘Šè¯‰ Server æˆ‘å·²ç»æ²¡æ•°æ®éœ€è¦å‘ç»™ Server äº†ï¼› ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼š 2ï¼‰Server æ”¶åˆ°åå›å¤ä¸€ä¸ª ACK ç¡®è®¤åŒ…è¯´æˆ‘çŸ¥é“äº†ï¼› ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼š 3ï¼‰ç„¶å server åœ¨è‡ªå·±ä¹Ÿæ²¡æ•°æ®å‘é€ç»™ client åï¼ŒServer ä¹Ÿå‘é€ä¸€ä¸ª FIN åŒ…ç»™ Client å‘Šè¯‰ Client æˆ‘ä¹Ÿå·²ç»æ²¡æ•°æ®å‘ç»™ client äº†ï¼› ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼š 4ï¼‰Client æ”¶åˆ°åï¼Œå°±ä¼šå›å¤ä¸€ä¸ª ACK ç¡®è®¤åŒ…è¯´æˆ‘çŸ¥é“äº†ã€‚ TCP ä¸»åŠ¨å…³é—­è¿æ¥çš„é‚£ä¸€æ–¹(Client)ä¼šæœ€åè¿›å…¥ TIME_WAITï¼ˆè¶…æ—¶è®¾ç½®æ˜¯ 2*MSï¼Œå³Linuxä¸º30sï¼‰ Question: ä¸ºä»€ä¹ˆå»ºç«‹è¿æ¥æ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Œå…³é—­è¿æ¥ç¡®æ˜¯å››æ¬¡æŒ¥æ‰‹å‘¢ï¼Ÿ ç®€å•æ¥è®²å°±æ˜¯ç¬¬äºŒä¸‰æ¬¡æŒ¥æ‰‹ä¸èƒ½åƒç¬¬äºŒä¸‰æ¬¡æ¡æ‰‹çš„æ—¶å€™ä¸€æ ·åˆå¹¶æˆä¸€ä¸ªï¼Œå› ä¸ºå¯èƒ½serverç«¯è¿˜æœ‰æ•°æ®æ²¡æœ‰å‘å®Œã€‚æ‰€ä»¥éœ€è¦åœ¨å¯èƒ½çš„æ•°æ®å‘å®Œä¹‹åå†è¿›è¡Œç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ ä¸ºä»€ä¹ˆä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€æ–¹è¦è¿›å…¥TIME_WAITï¼Ÿä¸ºä»€ä¹ˆæ˜¯2MS ä¸»åŠ¨å…³é—­æ–¹éœ€è¦è¿›å…¥ TIME_WAIT ä»¥ä¾¿èƒ½å¤Ÿé‡å‘ä¸¢æ‰çš„è¢«åŠ¨å…³é—­æ–¹ FIN åŒ…çš„ ACKã€‚ TIME_WAITçŠ¶æ€ä¹Ÿæˆä¸º2MSLç­‰å¾…çŠ¶æ€ã€‚æ¯ä¸ªå…·ä½“TCPå®ç°å¿…é¡»é€‰æ‹©ä¸€ä¸ªæŠ¥æ–‡æ®µæœ€å¤§ç”Ÿå­˜æ—¶é—´MSLï¼ˆMaximum Segment Lifetimeï¼‰ï¼Œå®ƒæ˜¯ä»»ä½•æŠ¥æ–‡æ®µè¢«ä¸¢å¼ƒå‰åœ¨ç½‘ç»œå†…çš„æœ€é•¿æ—¶é—´ã€‚ä¹Ÿå°±æ˜¯ä¸€æ¥ä¸€å›çš„æ—¶é—´ã€‚ ç¬¬å››æ¬¡æŒ¥æ‰‹æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨çš„ACKæœ‰å¯èƒ½ä¸¢å¤±ï¼ŒTIME_WAITçŠ¶æ€å°±æ˜¯ç”¨æ¥é‡å‘å¯èƒ½ä¸¢å¤±çš„ACKæŠ¥æ–‡ã€‚å¦‚æœServeræ²¡æœ‰æ”¶åˆ°ACKï¼Œå°±ä¼šé‡å‘FINï¼Œå¦‚æœClientåœ¨2*MSLçš„æ—¶é—´å†…æ”¶åˆ°äº†FINï¼Œå°±ä¼šé‡æ–°å‘é€ACKå¹¶å†æ¬¡ç­‰å¾…2MSLï¼Œé˜²æ­¢Serveræ²¡æœ‰æ”¶åˆ°ACKè€Œä¸æ–­é‡å‘FINã€‚ MSL(Maximum Segment Lifetime)ï¼ŒæŒ‡ä¸€ä¸ªç‰‡æ®µåœ¨ç½‘ç»œä¸­æœ€å¤§çš„å­˜æ´»æ—¶é—´ï¼Œ2MSLå°±æ˜¯ä¸€ä¸ªå‘é€å’Œä¸€ä¸ªå›å¤æ‰€éœ€çš„æœ€å¤§æ—¶é—´ã€‚å¦‚æœç›´åˆ°2MSLï¼ŒClientéƒ½æ²¡æœ‰å†æ¬¡æ”¶åˆ°FINï¼Œé‚£ä¹ˆClientæ¨æ–­ACKå·²ç»è¢«æˆåŠŸæ¥æ”¶ï¼Œåˆ™ç»“æŸTCPè¿æ¥ã€‚ æ•°æ®ä¼ è¾“ä¸­çš„Sequence Numberä¸‹å›¾æ˜¯æˆ‘ä»Wiresharkä¸­æˆªäº†ä¸ªæˆ‘åœ¨è®¿é—®coolshell.cnæ—¶çš„æœ‰æ•°æ®ä¼ è¾“çš„å›¾ç»™ä½ çœ‹ä¸€ä¸‹ï¼ŒSeqNumæ˜¯æ€ä¹ˆå˜çš„ã€‚ï¼ˆä½¿ç”¨Wiresharkèœå•ä¸­çš„Statistics -&gt;Flow Graphâ€¦ ï¼‰ ä½ å¯ä»¥çœ‹åˆ°ï¼ŒSeqNumçš„å¢åŠ æ˜¯å’Œä¼ è¾“çš„å­—èŠ‚æ•°ç›¸å…³çš„ã€‚ä¸Šå›¾ä¸­ï¼Œä¸‰æ¬¡æ¡æ‰‹åï¼Œæ¥äº†ä¸¤ä¸ªLen:1440çš„åŒ…ï¼Œè€Œç¬¬äºŒä¸ªåŒ…çš„SeqNumå°±æˆäº†1441ã€‚ç„¶åç¬¬ä¸€ä¸ªACKå›çš„æ˜¯1441ï¼Œè¡¨ç¤ºç¬¬ä¸€ä¸ª1440æ”¶åˆ°äº†ã€‚ æ³¨æ„ï¼šå¦‚æœä½ ç”¨WiresharkæŠ“åŒ…ç¨‹åºçœ‹3æ¬¡æ¡æ‰‹ï¼Œä½ ä¼šå‘ç°SeqNumæ€»æ˜¯ä¸º0ï¼Œä¸æ˜¯è¿™æ ·çš„ï¼ŒWiresharkä¸ºäº†æ˜¾ç¤ºæ›´å‹å¥½ï¼Œä½¿ç”¨äº†Relative SeqNumâ€”â€”ç›¸å¯¹åºå·ï¼Œä½ åªè¦åœ¨å³é”®èœå•ä¸­çš„protocol preference ä¸­å–æ¶ˆæ‰å°±å¯ä»¥çœ‹åˆ°â€œAbsolute SeqNumâ€äº† æ•°æ®åˆ†å—&amp;é¢å‘å­—èŠ‚æµåˆ†å—ä¼ è¾“æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè¿è¾“å±‚åœ¨ä¼ è¾“æ•°æ®çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯æŠŠæ•´ä¸ªæ•°æ®åŒ…åŠ ä¸ªé¦–éƒ¨ç›´æ¥å‘é€è¿‡å»ï¼Œè€Œæ˜¯ä¼šæ‹†åˆ†æˆå¤šä¸ªæŠ¥æ–‡åˆ†å¼€å‘é€ï¼›é‚£ä»–è¿™æ ·åšåŸå› æ˜¯ä»€ä¹ˆï¼Ÿ æœ‰è¯»è€…å¯èƒ½ä¼šæƒ³åˆ°ï¼šæ•°æ®é“¾è·¯å±‚é™åˆ¶äº†æ•°æ®é•¿åº¦åªèƒ½æœ‰1460ï¼ˆMSSï¼‰ã€‚é‚£æ•°æ®é“¾è·¯å±‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆé™åˆ¶ï¼Ÿä»–çš„æœ¬è´¨åŸå› å°±æ˜¯ï¼šç½‘ç»œæ˜¯ä¸ç¨³å®šçš„ã€‚å¦‚æœæŠ¥æ–‡å¤ªé•¿ï¼Œé‚£ä¹ˆææœ‰å¯èƒ½åœ¨ä¼ è¾“ä¸€èˆ¬çš„æ—¶å€™çªç„¶ä¸­æ–­äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦æ•´ä¸ªæ•°æ®é‡ä¼ ï¼Œæ•ˆç‡å°±é™ä½äº†ã€‚æŠŠæ•°æ®æ‹†åˆ†æˆå¤šä¸ªæ•°æ®æŠ¥ï¼Œé‚£ä¹ˆå½“æŸä¸ªæ•°æ®æŠ¥ä¸¢å¤±ï¼Œåªéœ€è¦é‡ä¼ è¯¥æ•°æ®æŠ¥å³å¯ã€‚ é‚£æ˜¯ä¸æ˜¯æ‹†åˆ†å¾—è¶Šç»†è¶Šå¥½ï¼ŸæŠ¥æ–‡ä¸­æ•°æ®å­—æ®µé•¿åº¦å¤ªä½ï¼Œä¼šä½¿å¾—é¦–éƒ¨çš„å æ¯”å¤ªå¤§ï¼Œè¿™æ ·é¦–éƒ¨å°±ä¼šæˆä¸ºç½‘ç»œä¼ è¾“æœ€å¤§çš„è´Ÿæ‹…äº†ã€‚ä¾‹å¦‚1000å­—èŠ‚ï¼Œæ¯ä¸ªæŠ¥æ–‡é¦–éƒ¨æ˜¯40å­—èŠ‚ï¼Œå¦‚æœæ‹†åˆ†æˆ10ä¸ªæŠ¥æ–‡ï¼Œé‚£ä¹ˆåªéœ€è¦ä¼ è¾“400å­—èŠ‚çš„é¦–éƒ¨ï¼›è€Œå¦‚æœæ‹†åˆ†æˆ1000ä¸ªï¼Œé‚£ä¹ˆéœ€è¦ä¼ è¾“40000å­—èŠ‚çš„é¦–éƒ¨ï¼Œæ•ˆç‡å°±æå¤§åœ°é™ä½äº†ã€‚ é¢å‘å­—èŠ‚æµTCPå¹¶ä¸æ˜¯æŠŠåº”ç”¨å±‚ä¼ è¾“è¿‡æ¥çš„æ•°æ®ç›´æ¥åŠ ä¸Šé¦–éƒ¨ç„¶åå‘é€ç»™ç›®æ ‡ï¼Œè€Œæ˜¯æŠŠæ•°æ®çœ‹æˆä¸€ä¸ªå­—èŠ‚ æµï¼Œç»™ä»–ä»¬æ ‡ä¸Šåºå·ä¹‹ååˆ†éƒ¨åˆ†å‘é€ã€‚è¿™å°±æ˜¯TCPçš„ é¢å‘å­—èŠ‚æµ ç‰¹æ€§ï¼š TCPä¼šä»¥æµçš„å½¢å¼ä»åº”ç”¨å±‚è¯»å–æ•°æ®å¹¶å­˜æ”¾åœ¨è‡ªå·±çš„å‘é€ç¼“å­˜åŒºä¸­ï¼ŒåŒæ—¶ä¸ºè¿™äº›å­—èŠ‚æ ‡ä¸Šåºå· TCPä¼šä»å‘é€æ–¹ç¼“å†²åŒºé€‰æ‹©é€‚é‡çš„å­—èŠ‚ç»„æˆTCPæŠ¥æ–‡ï¼Œé€šè¿‡ç½‘ç»œå±‚å‘é€ç»™ç›®æ ‡ ç›®æ ‡ä¼šè¯»å–å­—èŠ‚å¹¶å­˜æ”¾åœ¨è‡ªå·±çš„æ¥æ”¶æ–¹ç¼“å†²åŒºä¸­ï¼Œå¹¶åœ¨åˆé€‚çš„æ—¶å€™äº¤ä»˜ç»™åº”ç”¨å±‚ TCPçš„ç²˜åŒ…å’Œæ‹†åŒ…ç¨‹åºéœ€è¦å‘é€çš„æ•°æ®å¤§å°å’ŒTCPæŠ¥æ–‡æ®µèƒ½å‘é€MSSï¼ˆMaximum Segment Sizeï¼Œæœ€å¤§æŠ¥æ–‡é•¿åº¦ï¼‰æ˜¯ä¸ä¸€æ ·çš„å¤§äºMSSæ—¶ï¼Œè€Œéœ€è¦æŠŠç¨‹åºæ•°æ®æ‹†åˆ†ä¸ºå¤šä¸ªTCPæŠ¥æ–‡æ®µï¼Œç§°ä¹‹ä¸ºæ‹†åŒ…ï¼›å°äºæ—¶ï¼Œåˆ™ä¼šè€ƒè™‘åˆå¹¶å¤šä¸ªç¨‹åºæ•°æ®ä¸ºä¸€ä¸ªTCPæŠ¥æ–‡æ®µï¼Œåˆ™æ˜¯ç²˜åŒ…ï¼›åœ¨IPåè®®å±‚æˆ–è€…é“¾è·¯å±‚ã€ç‰©ç†å±‚ï¼Œéƒ½å­˜åœ¨æ‹†åŒ…ã€ç²˜åŒ…ç°è±¡ è§£å†³ç²˜åŒ…å’Œæ‹†åŒ…çš„æ–¹æ³•éƒ½æœ‰å“ªäº›ï¼Ÿ1ï¼‰åœ¨æ•°æ®å°¾éƒ¨å¢åŠ ç‰¹æ®Šå­—ç¬¦è¿›è¡Œåˆ†å‰²2ï¼‰å°†æ•°æ®å®šä¸ºå›ºå®šå¤§å°3ï¼‰å°†æ•°æ®åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ æµé‡æ§åˆ¶ï¼šæ»‘åŠ¨çª—å£TCPå¤´é‡Œæœ‰ä¸€ä¸ªå­—æ®µå«Windowï¼Œè¿™ä¸ªå­—æ®µæ˜¯æ¥æ”¶ç«¯å‘Šè¯‰å‘é€ç«¯è‡ªå·±è¿˜æœ‰å¤šå°‘ç¼“å†²åŒºå¯ä»¥æ¥æ”¶æ•°æ®ã€‚äºæ˜¯å‘é€ç«¯å°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ¥æ”¶ç«¯çš„å¤„ç†èƒ½åŠ›æ¥å‘é€æ•°æ®ï¼Œè€Œä¸ä¼šå¯¼è‡´æ¥æ”¶ç«¯å¤„ç†ä¸è¿‡æ¥ã€‚ TCP åˆ©ç”¨æ»‘åŠ¨çª—å£å®ç°æµé‡æ§åˆ¶ã€‚æµé‡æ§åˆ¶æ˜¯ä¸ºäº†æ§åˆ¶å‘é€æ–¹å‘é€é€Ÿç‡ï¼Œä¿è¯æ¥æ”¶æ–¹æ¥å¾—åŠæ¥æ”¶ã€‚å°†çª—å£å­—æ®µè®¾ç½®ä¸º 0ï¼Œåˆ™å‘é€æ–¹ä¸èƒ½å‘é€æ•°æ®ã€‚ ç”±æ¥æ”¶æ–¹ å‘ å‘é€æ–¹é€šçŸ¥è‡ªå·±è¿˜æœ‰å¤šå°‘ç¼“å†²åŒºæ¥å—æ•°æ® è®¾Aå‘Bå‘é€æ•°æ®ã€‚åœ¨è¿æ¥å»ºç«‹æ—¶ï¼ŒBå‘Šè¯‰äº†Aï¼šâ€œæˆ‘çš„æ¥æ”¶çª—å£æ˜¯ rwnd = 400 â€(è¿™é‡Œçš„ rwnd è¡¨ç¤º receiver window) ã€‚å› æ­¤ï¼Œå‘é€æ–¹çš„å‘é€çª—å£ä¸èƒ½è¶…è¿‡æ¥æ”¶æ–¹ç»™å‡ºçš„æ¥æ”¶çª—å£çš„æ•°å€¼ã€‚è¯·æ³¨æ„ï¼ŒTCPçš„çª—å£å•ä½æ˜¯å­—èŠ‚ï¼Œä¸æ˜¯æŠ¥æ–‡æ®µã€‚å‡è®¾æ¯ä¸€ä¸ªæŠ¥æ–‡æ®µä¸º100å­—èŠ‚é•¿ï¼Œè€Œæ•°æ®æŠ¥æ–‡æ®µåºå·çš„åˆå§‹å€¼è®¾ä¸º1ã€‚å¤§å†™ACKè¡¨ç¤ºé¦–éƒ¨ä¸­çš„ç¡®è®¤ä½ACKï¼Œå°å†™ackè¡¨ç¤ºç¡®è®¤å­—æ®µçš„å€¼ackã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒBè¿›è¡Œäº†ä¸‰æ¬¡æµé‡æ§åˆ¶ã€‚ç¬¬ä¸€æ¬¡æŠŠçª—å£å‡å°‘åˆ° rwnd = 300 ï¼Œç¬¬äºŒæ¬¡åˆå‡åˆ°äº† rwnd = 100 ï¼Œæœ€åå‡åˆ° rwnd = 0 ï¼Œå³ä¸å…è®¸å‘é€æ–¹å†å‘é€æ•°æ®äº†ã€‚è¿™ç§ä½¿å‘é€æ–¹æš‚åœå‘é€çš„çŠ¶æ€å°†æŒç»­åˆ°ä¸»æœºBé‡æ–°å‘å‡ºä¸€ä¸ªæ–°çš„çª—å£å€¼ä¸ºæ­¢ã€‚Bå‘Aå‘é€çš„ä¸‰ä¸ªæŠ¥æ–‡æ®µéƒ½è®¾ç½®äº† ACK = 1 ï¼Œåªæœ‰åœ¨ACK=1æ—¶ç¡®è®¤å·å­—æ®µæ‰æœ‰æ„ä¹‰ã€‚ é›¶çª—å£(Zero Window) å¦‚æœWindowå˜æˆ0äº†ï¼ŒTCPä¼šæ€ä¹ˆæ ·ï¼Ÿæ˜¯ä¸æ˜¯å‘é€ç«¯å°±ä¸å‘æ•°æ®äº†ï¼Ÿæ˜¯çš„ï¼Œå‘é€ç«¯å°±ä¸å‘æ•°æ®äº†ï¼Œä½ å¯ä»¥æƒ³åƒæˆâ€œWindow Closedâ€ï¼Œé‚£ä½ ä¸€å®šè¿˜ä¼šé—®ï¼Œå¦‚æœå‘é€ç«¯ä¸å‘æ•°æ®äº†ï¼Œæ¥æ”¶æ–¹ä¸€ä¼šå„¿Window size å¯ç”¨äº†ï¼Œæ€ä¹ˆé€šçŸ¥å‘é€ç«¯å‘¢ï¼Ÿ è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒTCPä½¿ç”¨äº†é›¶çª—å£æ¢æµ‹Zero Window Probeï¼ˆZWPï¼‰æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€ç«¯åœ¨çª—å£å˜æˆ0åï¼Œä¼šå‘ZWPçš„åŒ…ç»™æ¥æ”¶æ–¹ï¼Œè®©æ¥æ”¶æ–¹æ¥ackä»–çš„Windowå°ºå¯¸ï¼Œä¸€èˆ¬è¿™ä¸ªå€¼ä¼šè®¾ç½®æˆ3æ¬¡ï¼Œæ¯æ¬¡å¤§çº¦30-60ç§’ï¼ˆä¸åŒçš„å®ç°å¯èƒ½ä¼šä¸ä¸€æ ·ï¼‰ã€‚å¦‚æœ3æ¬¡è¿‡åè¿˜æ˜¯0çš„è¯ï¼Œæœ‰çš„TCPå®ç°å°±ä¼šå‘RSTæŠŠé“¾æ¥æ–­äº†ã€‚ ç³Šæ¶‚çª—å£ç»¼åˆç—‡(Silly Window Syndrome) å¦‚æœæˆ‘ä»¬çš„æ¥æ”¶æ–¹å¤ªå¿™äº†ï¼Œæ¥ä¸åŠå–èµ°Receive Windowsé‡Œçš„æ•°æ®ï¼Œé‚£ä¹ˆï¼Œå°±ä¼šå¯¼è‡´å‘é€æ–¹è¶Šæ¥è¶Šå°ã€‚åˆ°æœ€åï¼Œå¦‚æœæ¥æ”¶æ–¹è…¾å‡ºå‡ ä¸ªå­—èŠ‚å¹¶å‘Šè¯‰å‘é€æ–¹ç°åœ¨æœ‰å‡ ä¸ªå­—èŠ‚çš„windowï¼Œè€Œæˆ‘ä»¬çš„å‘é€æ–¹ä¼šä¹‰æ— åé¡¾åœ°å‘é€è¿™å‡ ä¸ªå­—èŠ‚ã€‚è¦çŸ¥é“ï¼Œæˆ‘ä»¬çš„TCP+IPå¤´æœ‰40ä¸ªå­—èŠ‚ï¼Œä¸ºäº†å‡ ä¸ªå­—èŠ‚ï¼Œè¦è¾¾ä¸Šè¿™ä¹ˆå¤§çš„å¼€é”€ï¼Œè¿™å¤ªä¸ç»æµäº†ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ä¹Ÿä¸éš¾ï¼Œå°±æ˜¯é¿å…å¯¹å°çš„window sizeåšå‡ºå“åº”ï¼Œç›´åˆ°æœ‰è¶³å¤Ÿå¤§çš„window sizeå†å“åº”ï¼Œè¿™ä¸ªæ€è·¯å¯ä»¥åŒæ—¶å®ç°åœ¨senderå’Œreceiverä¸¤ç«¯ã€‚ å¦‚æœè¿™ä¸ªé—®é¢˜æ˜¯ç”±æ¥æ”¶ç«¯å¼•èµ·çš„ï¼ˆæ¯”å¦‚æ¥æ”¶ç«¯å¤„ç†ç¼“å†²åŒºæ•°æ®å¤„ç†ä¸è¿‡æ¥ï¼Œå¤ªå¿™äº†ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨ Clark æ–¹æ¡ˆã€‚åœ¨receiverç«¯ï¼Œå¦‚æœæ”¶åˆ°çš„æ•°æ®å¯¼è‡´window sizeå°äºæŸä¸ªå€¼ï¼Œå¯ä»¥ç›´æ¥ack(0)å›senderï¼Œè¿™æ ·å°±æŠŠwindowç»™å…³é—­äº†ï¼Œä¹Ÿé˜»æ­¢äº†senderå†å‘æ•°æ®è¿‡æ¥ï¼Œç­‰åˆ°receiverç«¯å¤„ç†äº†ä¸€äº›æ•°æ®åwindows size å¤§äºç­‰äºäº†MSSï¼Œæˆ–è€…ï¼Œreceiver bufferæœ‰ä¸€åŠä¸ºç©ºï¼Œå°±å¯ä»¥æŠŠwindowæ‰“å¼€è®©send å‘é€æ•°æ®è¿‡æ¥ã€‚ ï¼ˆç®€è¿°ï¼šæ¥æ”¶ç«¯å¼•èµ·çš„SWSï¼ŒClarkæ–¹æ¡ˆï¼šæ¥æ”¶åˆ°çš„æ•°æ®å¯¼è‡´æ»‘çª—è¿‡å°ï¼Œack(window=0)è®©å‘é€ç«¯å…ˆæš‚åœå‘é€ï¼Œç›´åˆ°æ¥æ”¶ç«¯å¤„ç†å®Œä¸€äº›æ•°æ®åwindowå¤§äºMSSäº†æˆ–è€…ç¼“å†²åŒºä¸€åŠç©ºäº†ï¼Œå°±å¯ä»¥ack(æ–°å€¼)äº†ï¼‰ å¦‚æœè¿™ä¸ªé—®é¢˜æ˜¯ç”±å‘é€ç«¯å¼•èµ·çš„ï¼ˆæ¯”å¦‚å‘é€ç«¯çš„å†…å®¹æ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚äº§ç”Ÿçš„ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨è‘—åçš„ Nagleâ€™s algorithmã€‚è¿™ä¸ªç®—æ³•çš„æ€è·¯ä¹Ÿæ˜¯å»¶æ—¶å¤„ç†ï¼Œä»–æœ‰ä¸¤ä¸ªä¸»è¦çš„æ¡ä»¶ï¼š1ï¼‰è¦ç­‰åˆ° Window Size&gt;=MSS æˆ–æ˜¯ Data Size &gt;=MSSï¼Œ2ï¼‰æ”¶åˆ°ä¹‹å‰å‘é€æ•°æ®çš„ackå›åŒ…ï¼Œä»–æ‰ä¼šå‘æ•°æ®ï¼Œå¦åˆ™å°±æ˜¯åœ¨æ”’æ•°æ®ã€‚ ï¼ˆç®€è¿°ï¼šå‘é€ç«¯å¼•èµ·çš„SWSï¼Œnagleç®—æ³•ï¼šæ”’æ•°æ®ç›´åˆ°WindowSize &gt;= MSSæˆ–è€…Data Szie &gt;= MSSï¼ŒåŒæ—¶è¦æ”¶åˆ°ä¹‹å‰å‘é€æ•°æ®çš„ackå›åŒ…ï¼‰ å¦å¤–ï¼ŒNagleç®—æ³•é»˜è®¤æ˜¯æ‰“å¼€çš„ï¼Œæ‰€ä»¥ï¼Œå¯¹äºä¸€äº›éœ€è¦å°åŒ…åœºæ™¯çš„ç¨‹åºâ€”â€”æ¯”å¦‚åƒtelnetæˆ–sshè¿™æ ·çš„äº¤äº’æ€§æ¯”è¾ƒå¼ºçš„ç¨‹åºï¼Œä½ éœ€è¦å…³é—­è¿™ä¸ªç®—æ³•ã€‚ä½ å¯ä»¥åœ¨Socketè®¾ç½®TCP_NODELAYé€‰é¡¹æ¥å…³é—­è¿™ä¸ªç®—æ³•ï¼ˆå…³é—­Nagleç®—æ³•æ²¡æœ‰å…¨å±€å‚æ•°ï¼Œéœ€è¦æ ¹æ®æ¯ä¸ªåº”ç”¨è‡ªå·±çš„ç‰¹ç‚¹æ¥å…³é—­ï¼‰ æ‹¥å¡æ§åˆ¶ï¼šæ…¢å¼€å§‹é—¨é™ssthreshçŠ¶æ€å˜é‡ï¼ˆå‡è®¾ä¸º8ä¸ªMSSï¼‰ swnd = min(rwnd, cwnd) å‘é€æ–¹çš„çª—å£ä¸Šé™ï¼Œæ˜¯å–å€¼æ»‘åŠ¨çª—å£å’Œæ‹¥å¡çª—å£ä¸¤è€…çš„æœ€å°å€¼ æ»‘åŠ¨çª—å£å’Œæ‹¥å¡çª—å£åŒºåˆ«ï¼šç›¸åŒç‚¹éƒ½æ˜¯æ§åˆ¶ä¸¢åŒ…ç°è±¡ï¼Œå®ç°æœºåˆ¶éƒ½æ˜¯è®©å‘é€æ–¹å‘å¾—æ…¢ä¸€ç‚¹ ä¸åŒç‚¹åœ¨äºæ§åˆ¶çš„å¯¹è±¡ä¸åŒ1ï¼‰æµé‡æ§åˆ¶çš„å¯¹è±¡æ˜¯æ¥æ”¶æ–¹ï¼Œæ€•å‘é€æ–¹å‘çš„å¤ªå¿«ï¼Œä½¿å¾—æ¥æ”¶æ–¹æ¥ä¸åŠå¤„ç†2ï¼‰æ‹¥å¡æ§åˆ¶çš„å¯¹è±¡æ˜¯ç½‘ç»œæ‹¥å¡ï¼Œæ€•å‘é€æ–¹å‘çš„å¤ªå¿«ï¼Œé€ æˆç½‘ç»œæ‹¥å¡ï¼Œä½¿å¾—ç½‘ç»œæ¥ä¸åŠå¤„ç† æ…¢å¯åŠ¨å³ï¼šæ‹¥å¡çª—å£ä»1MSSå¼€å§‹ï¼Œæ¯è½®å¾€è¿”(å³å‘é€çš„TCPæ®µéƒ½æ”¶åˆ°äº†ack)åŠ å€ï¼Œç›´åˆ°ssthreshå€¼ä¸ºæ­¢ï¼Œåˆ‡æ¢æ‹¥å¡é¿å… å½“ä¸»æœºå¼€å§‹å‘é€æ•°æ®æ—¶ï¼Œå¦‚æœç«‹å³æ‰€å¤§é‡æ•°æ®å­—èŠ‚æ³¨å…¥åˆ°ç½‘ç»œï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½å¼•èµ·ç½‘ç»œæ‹¥å¡ï¼Œå› ä¸ºç°åœ¨å¹¶ä¸æ¸…æ¥šç½‘ç»œçš„è´Ÿè·æƒ…å†µã€‚ å› æ­¤ï¼Œè¾ƒå¥½çš„æ–¹æ³•æ˜¯ å…ˆæ¢æµ‹ä¸€ä¸‹ï¼Œå³ç”±å°åˆ°å¤§é€æ¸å¢å¤§å‘é€çª—å£ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”±å°åˆ°å¤§é€æ¸å¢å¤§æ‹¥å¡çª—å£æ•°å€¼ã€‚ é€šå¸¸åœ¨åˆšåˆšå¼€å§‹å‘é€æŠ¥æ–‡æ®µæ—¶ï¼Œå…ˆæŠŠæ‹¥å¡çª—å£ cwnd è®¾ç½®ä¸ºä¸€ä¸ªæœ€å¤§æŠ¥æ–‡æ®µMSSçš„æ•°å€¼ã€‚è€Œåœ¨æ¯æ”¶åˆ°ä¸€ä¸ªå¯¹æ–°çš„æŠ¥æ–‡æ®µçš„ç¡®è®¤åï¼ŒæŠŠæ‹¥å¡çª—å£å¢åŠ è‡³å¤šä¸€ä¸ªMSSçš„æ•°å€¼ã€‚ç”¨è¿™æ ·çš„æ–¹æ³•é€æ­¥å¢å¤§å‘é€æ–¹çš„æ‹¥å¡çª—å£ cwnd ï¼Œå¯ä»¥ä½¿åˆ†ç»„æ³¨å…¥åˆ°ç½‘ç»œçš„é€Ÿç‡æ›´åŠ åˆç†ã€‚ â€‹ cwndçª—å£ 1 -&gt; 2 -&gt; 4 -&gt; 8 â€‹ æ¯ç»è¿‡ä¸€ä¸ªä¼ è¾“è½®æ¬¡ï¼Œæ‹¥å¡çª—å£ cwnd å°±åŠ å€ã€‚ä¸€ä¸ªä¼ è¾“è½®æ¬¡æ‰€ç»å†çš„æ—¶é—´å…¶å®å°±æ˜¯å¾€è¿”æ—¶é—´RTTã€‚ä¸è¿‡â€œä¼ è¾“è½®æ¬¡â€æ›´åŠ å¼ºè°ƒï¼šæŠŠæ‹¥å¡çª—å£cwndæ‰€å…è®¸å‘é€çš„æŠ¥æ–‡æ®µéƒ½è¿ç»­å‘é€å‡ºå»ï¼Œå¹¶æ”¶åˆ°äº†å¯¹å·²å‘é€çš„æœ€åä¸€ä¸ªå­—èŠ‚çš„ç¡®è®¤ã€‚ å¦ï¼Œæ…¢å¼€å§‹çš„â€œæ…¢â€å¹¶ä¸æ˜¯æŒ‡cwndçš„å¢é•¿é€Ÿç‡æ…¢ï¼Œè€Œæ˜¯æŒ‡åœ¨TCPå¼€å§‹å‘é€æŠ¥æ–‡æ®µæ—¶å…ˆè®¾ç½®cwnd=1ï¼Œä½¿å¾—å‘é€æ–¹åœ¨å¼€å§‹æ—¶åªå‘é€ä¸€ä¸ªæŠ¥æ–‡æ®µï¼ˆç›®çš„æ˜¯è¯•æ¢ä¸€ä¸‹ç½‘ç»œçš„æ‹¥å¡æƒ…å†µï¼‰ï¼Œç„¶åå†é€æ¸å¢å¤§cwndã€‚ ä¸ºäº†é˜²æ­¢æ‹¥å¡çª—å£cwndå¢é•¿è¿‡å¤§å¼•èµ·ç½‘ç»œæ‹¥å¡ï¼Œè¿˜éœ€è¦è®¾ç½®ä¸€ä¸ªæ…¢å¼€å§‹é—¨é™ssthreshçŠ¶æ€å˜é‡ã€‚æ…¢å¼€å§‹é—¨é™ssthreshçš„ç”¨æ³•å¦‚ä¸‹ï¼š å½“ cwnd &lt; ssthresh æ—¶ï¼Œä½¿ç”¨ä¸Šè¿°çš„æ…¢å¼€å§‹ç®—æ³•ã€‚ å½“ cwnd &gt; ssthresh æ—¶ï¼Œåœæ­¢ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•è€Œæ”¹ç”¨æ‹¥å¡é¿å…ç®—æ³•ã€‚ å½“ cwnd = ssthresh æ—¶ï¼Œæ—¢å¯ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•ï¼Œä¹Ÿå¯ä½¿ç”¨æ‹¥å¡æ§åˆ¶é¿å…ç®—æ³•ã€‚ æ‹¥å¡é¿å…ç®—æ³•å³ï¼šå¤§äºssthreshå€¼æ—¶æ‹¥å¡çª—å£æ¯è½®å¾€è¿”åŠ ä¸€ è®©æ‹¥å¡çª—å£cwndç¼“æ…¢åœ°å¢å¤§ï¼Œå³æ¯ç»è¿‡ä¸€ä¸ªå¾€è¿”æ—¶é—´RTTå°±æŠŠå‘é€æ–¹çš„æ‹¥å¡çª—å£cwndåŠ 1ï¼Œè€Œä¸æ˜¯åŠ å€ã€‚è¿™æ ·æ‹¥å¡çª—å£cwndæŒ‰çº¿æ€§è§„å¾‹ç¼“æ…¢å¢é•¿ï¼Œæ¯”æ…¢å¼€å§‹ç®—æ³•çš„æ‹¥å¡çª—å£å¢é•¿é€Ÿç‡ç¼“æ…¢å¾—å¤šã€‚ â€‹ ï¼ˆå‡è£…æœ‰å›¾ï¼‰ â€‹ cwndçª—å£ 8 -&gt; 9 -&gt; 10 -&gt; 11 æ…¢çƒ­å¯åŠ¨ç®—æ³• â€“ Slow Starté¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹TCPçš„æ…¢çƒ­å¯åŠ¨ã€‚æ…¢å¯åŠ¨çš„æ„æ€æ˜¯ï¼ŒåˆšåˆšåŠ å…¥ç½‘ç»œçš„è¿æ¥ï¼Œä¸€ç‚¹ä¸€ç‚¹åœ°æé€Ÿï¼Œä¸è¦ä¸€ä¸Šæ¥å°±åƒé‚£äº›ç‰¹æƒè½¦ä¸€æ ·éœ¸é“åœ°æŠŠè·¯å æ»¡ã€‚æ–°åŒå­¦ä¸Šé«˜é€Ÿè¿˜æ˜¯è¦æ…¢ä¸€ç‚¹ï¼Œä¸è¦æŠŠå·²ç»åœ¨é«˜é€Ÿä¸Šçš„ç§©åºç»™æä¹±äº†ã€‚ æ…¢å¯åŠ¨çš„ç®—æ³•å¦‚ä¸‹(cwndå…¨ç§°Congestion Window)ï¼š 1ï¼‰è¿æ¥å»ºå¥½çš„å¼€å§‹å…ˆåˆå§‹åŒ–cwnd = 1ï¼Œè¡¨æ˜å¯ä»¥ä¼ ä¸€ä¸ªMSSå¤§å°çš„æ•°æ®ã€‚ 2ï¼‰æ¯å½“æ”¶åˆ°ä¸€ä¸ªACKï¼Œcwnd++; å‘ˆçº¿æ€§ä¸Šå‡ 3ï¼‰æ¯å½“è¿‡äº†ä¸€ä¸ªRTTï¼Œcwnd = cwnd*2; å‘ˆæŒ‡æ•°è®©å‡ 4ï¼‰è¿˜æœ‰ä¸€ä¸ªssthreshï¼ˆslow start thresholdï¼‰ï¼Œæ˜¯ä¸€ä¸ªä¸Šé™ï¼Œå½“cwnd &gt;= ssthreshæ—¶ï¼Œå°±ä¼šè¿›å…¥â€œæ‹¥å¡é¿å…ç®—æ³•â€ï¼ˆåé¢ä¼šè¯´è¿™ä¸ªç®—æ³•ï¼‰ æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœç½‘é€Ÿå¾ˆå¿«çš„è¯ï¼ŒACKä¹Ÿä¼šè¿”å›å¾—å¿«ï¼ŒRTTä¹Ÿä¼šçŸ­ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªæ…¢å¯åŠ¨å°±ä¸€ç‚¹ä¹Ÿä¸æ…¢ã€‚ä¸‹å›¾è¯´æ˜äº†è¿™ä¸ªè¿‡ç¨‹ã€‚ è¿™é‡Œï¼Œæˆ‘éœ€è¦æä¸€ä¸‹çš„æ˜¯ä¸€ç¯‡Googleçš„è®ºæ–‡ã€ŠAn Argument for Increasing TCPâ€™s Initial Congestion Windowã€‹Linux 3.0åé‡‡ç”¨äº†è¿™ç¯‡è®ºæ–‡çš„å»ºè®®â€”â€”æŠŠcwnd åˆå§‹åŒ–æˆäº† 10ä¸ªMSSã€‚ è€ŒLinux 3.0ä»¥å‰ï¼Œæ¯”å¦‚2.6ï¼ŒLinuxé‡‡ç”¨äº†RFC3390ï¼Œcwndæ˜¯è·ŸMSSçš„å€¼æ¥å˜çš„ï¼Œå¦‚æœMSS&lt; 1095ï¼Œåˆ™cwnd = 4ï¼›å¦‚æœMSS&gt;2190ï¼Œåˆ™cwnd=2ï¼›å…¶å®ƒæƒ…å†µä¸‹ï¼Œåˆ™æ˜¯3ã€‚ æ‹¥å¡é¿å…ç®—æ³• â€“ Congestion Avoidanceå‰é¢è¯´è¿‡ï¼Œè¿˜æœ‰ä¸€ä¸ªssthreshï¼ˆslow start thresholdï¼‰ï¼Œæ˜¯ä¸€ä¸ªä¸Šé™ï¼Œå½“cwnd &gt;= ssthreshæ—¶ï¼Œå°±ä¼šè¿›å…¥â€œæ‹¥å¡é¿å…ç®—æ³•â€ã€‚ä¸€èˆ¬æ¥è¯´ssthreshçš„å€¼æ˜¯65535ï¼Œå•ä½æ˜¯å­—èŠ‚ï¼Œå½“cwndè¾¾åˆ°è¿™ä¸ªå€¼æ—¶åï¼Œç®—æ³•å¦‚ä¸‹ï¼š 1ï¼‰æ”¶åˆ°ä¸€ä¸ªACKæ—¶ï¼Œcwnd = cwnd + 1/cwnd 2ï¼‰å½“æ¯è¿‡ä¸€ä¸ªRTTæ—¶ï¼Œcwnd = cwnd + 1 è¿™æ ·å°±å¯ä»¥é¿å…å¢é•¿è¿‡å¿«å¯¼è‡´ç½‘ç»œæ‹¥å¡ï¼Œæ…¢æ…¢çš„å¢åŠ è°ƒæ•´åˆ°ç½‘ç»œçš„æœ€ä½³å€¼ã€‚å¾ˆæ˜æ˜¾ï¼Œæ˜¯ä¸€ä¸ªçº¿æ€§ä¸Šå‡çš„ç®—æ³•ã€‚ å¿«é€Ÿé‡ä¼ å’Œå¿«é€Ÿæ¢å¤æ¥æ”¶æ–¹æ¯æ”¶åˆ°ä¸€ä¸ªå¤±åºæŠ¥æ–‡æ®µå°±ç«‹å³å‘å‡ºé‡å¤ç¡®è®¤ï¼Œå‘é€æ–¹å¦‚æœä¸€è¿ä¸‰æ¬¡æ”¶åˆ°é‡å¤ç¡®è®¤ç«‹å³é‡ä¼ ï¼Œssthreshå€¼å‡åŠï¼Œå¹¶cwndçª—å£å˜æ›´ä¸ºæ–°ssthreshï¼Œæ¥ä¸‹æ¥æ‰§è¡Œæ‹¥å¡é¿å…ç®—æ³•åŠ æ³•å¢å¤§ å¿«é€Ÿé‡ä¼ å³ï¼šæ¥æ”¶æ–¹æ¯æ”¶åˆ°ä¸€ä¸ªå¤±åºæŠ¥æ–‡æ®µå°±ç«‹å³å‘å‡ºé‡å¤ç¡®è®¤ï¼Œå‘é€æ–¹å¦‚æœä¸€è¿ä¸‰æ¬¡æ”¶åˆ°é‡å¤ç¡®è®¤ç«‹å³é‡ä¼  é¦–å…ˆè¦æ±‚æ¥æ”¶æ–¹æ¯æ”¶åˆ°ä¸€ä¸ªå¤±åºçš„æŠ¥æ–‡æ®µåå°±ç«‹å³å‘å‡ºé‡å¤ç¡®è®¤ï¼ˆä¸ºçš„æ˜¯ä½¿å‘é€æ–¹åŠæ—©çŸ¥é“æœ‰æŠ¥æ–‡æ®µæ²¡æœ‰åˆ°è¾¾å¯¹æ–¹ï¼‰è€Œä¸è¦ç­‰åˆ°è‡ªå·±å‘é€æ•°æ®æ—¶æ‰è¿›è¡Œæå¸¦ç¡®è®¤ã€‚ å‘é€æ–¹åªè¦ä¸€è¿æ”¶åˆ°ä¸‰ä¸ªé‡å¤ç¡®è®¤M2å°±åº”å½“ç«‹å³é‡ä¼ å¯¹æ–¹å°šæœªæ”¶åˆ°çš„æŠ¥æ–‡æ®µM3 å¿«é€Ÿæ¢å¤(Renoç®—æ³•)å³å‘é€æ–¹æ¥å—åˆ°ä¸‰ä¸ªé‡å¤ç¡®è®¤æ—¶ï¼Œssthreshå€¼å‡åŠï¼Œå¹¶cwndçª—å£å˜æ›´ä¸ºæ–°ssthreshï¼Œæ¥ä¸‹æ¥æ‰§è¡ŒåŠ æ³•å¢å¤§ å½“å‘é€æ–¹è¿ç»­æ”¶åˆ°ä¸‰ä¸ªé‡å¤ç¡®è®¤ï¼Œå°±æ‰§è¡Œâ€œä¹˜æ³•å‡å°â€ç®—æ³•ï¼ŒæŠŠæ…¢å¼€å§‹é—¨é™ssthreshå‡åŠï¼Œcwndçª—å£å˜æ›´ä¸ºæ–°ssthreshå€¼ï¼ˆæ—§å€¼çš„ä¸€åŠï¼‰ã€‚ï¼ˆå³ä¸æ‰§è¡Œâ€œæ…¢å¼€å§‹æŒ‡æ•°å¢å¤§â€ï¼Œçª—å£ä¸é‡ç½®ä¸º1ï¼Œè€Œæ˜¯è®¾ç½®ä¸ºssthreshäºŒåˆ†ä¹‹ä¸€ï¼Œåé¢æ‰§è¡Œæ‹¥å¡é¿å…ç®—æ³•â€œåŠ æ³•å¢å¤§â€ï¼‰ è¶…æ—¶é‡ä¼ ç®€è¿°ï¼šå¦‚æœä¸€ä¸ªå·²ç»å‘é€çš„æŠ¥æ–‡æ®µåœ¨è¶…æ—¶æ—¶é—´RTOå†…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼Œé‚£ä¹ˆå°±é‡ä¼ è¿™ä¸ªæŠ¥æ–‡æ®µã€‚ å¾€è¿”æ—¶é—´Round Trip Timeâ€”â€”RTTï¼šå®¢æˆ·åˆ°æœåŠ¡å™¨å¾€è¿”æ‰€èŠ±æ—¶é—´ï¼Œå¸¸è¯´çš„å»¶è¿Ÿ è¶…æ—¶æ—¶é—´Retransmission TimeOutâ€”â€”RTOï¼šç”±RTTåŠ æƒè®¡ç®—å‡ºæ¥çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…å‡ºRTOæ²¡æœ‰ackåˆ™é‡ä¼  ç­‰åˆ°RTOè¶…æ—¶ï¼Œé‡ä¼ æ•°æ®åŒ…ã€‚TCPè®¤ä¸ºè¿™ç§æƒ…å†µå¤ªç³Ÿç³•ï¼Œååº”ä¹Ÿå¾ˆå¼ºçƒˆã€‚ sshthresh = cwnd /2 cwnd é‡ç½®ä¸º 1 è¿›å…¥æ…¢å¯åŠ¨è¿‡ç¨‹ ä¸€ä¸ªæŠ¥æ–‡æ®µä»å‘é€å†åˆ°æ¥æ”¶åˆ°ç¡®è®¤æ‰€ç»è¿‡çš„æ—¶é—´ç§°ä¸ºå¾€è¿”æ—¶é—´ RTTï¼ŒåŠ æƒå¹³å‡å¾€è¿”æ—¶é—´ RTTs è®¡ç®—å¦‚ä¸‹ï¼š å…¶ä¸­ï¼Œ0 â‰¤ a ï¼œ 1ï¼ŒRTTs éšç€ a çš„å¢åŠ æ›´å®¹æ˜“å—åˆ° RTT çš„å½±å“ã€‚è¶…æ—¶æ—¶é—´ RTO åº”è¯¥ç•¥å¤§äº RTTsï¼ŒTCP ä½¿ç”¨çš„è¶…æ—¶æ—¶é—´è®¡ç®—å¦‚ä¸‹ï¼š å…¶ä¸­ RTTd ä¸ºåå·®çš„åŠ æƒå¹³å‡å€¼ã€‚ å¿«é€Ÿé‡ä¼ å’Œè¶…æ—¶é‡ä¼ åŒºåˆ«è¶…æ—¶é‡ä¼ ï¼šå¦‚æœä¸€ä¸ªå·²ç»å‘é€çš„æŠ¥æ–‡æ®µåœ¨è¶…æ—¶æ—¶é—´RTOå†…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼Œé‚£ä¹ˆå°±é‡ä¼ è¿™ä¸ªæŠ¥æ–‡æ®µï¼Œé˜ˆå€¼å‡åŠï¼Œé‡ç½®cwndä¸º1åæ…¢å¯åŠ¨ å¿«é€Ÿé‡ä¼ ï¼šå®¢æˆ·ç«¯è¿ç»­æ”¶åˆ°ä¸‰æ¬¡é‡å¤ç¡®è®¤ï¼ˆå³æœåŠ¡å™¨è¿ç»­ä¸‰æ¬¡æ”¶åˆ°ä¹±åºçš„åŒ…ï¼‰ï¼Œç«‹å³é‡ä¼ å¯¹åº”ä¸¢å¤±åŒ…ï¼Œé˜ˆå€¼å‡åŠï¼Œcwndè®¾ä¸ºæ–°é˜ˆå€¼åæ‹¥å¡é¿å… å¿«é€Ÿé‡ä¼ æœºåˆ¶ã€ŒRFC5681ã€åŸºäºæ¥æ”¶ç«¯çš„åé¦ˆä¿¡æ¯æ¥å¼•å‘é‡ä¼ ï¼Œè€Œéé‡ä¼ è®¡æ—¶å™¨è¶…æ—¶ã€‚åŸºäºè®¡æ—¶å™¨çš„é‡ä¼ å¾€å¾€è¦ç­‰å¾…å¾ˆé•¿æ—¶é—´ï¼Œè€Œå¿«é€Ÿé‡ä¼ ä½¿ç”¨äº†å¾ˆå·§å¦™çš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼šæœåŠ¡å™¨å¦‚æœæ”¶åˆ°ä¹±åºçš„åŒ…ï¼Œä¹Ÿç»™å®¢æˆ·ç«¯å›å¤ ACKï¼Œåªä¸è¿‡æ˜¯é‡å¤çš„ ACKã€‚å°±æ‹¿åˆšåˆšçš„ä¾‹å­æ¥è¯´ï¼Œæ”¶åˆ°ä¹±åºçš„åŒ… 6,7,8,9 æ—¶ï¼ŒæœåŠ¡å™¨å…¨éƒ½å‘ ACK = 5ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯å°±çŸ¥é“ 5 å‘ç”Ÿäº†ç©ºç¼ºã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯è¿ç»­ä¸‰æ¬¡æ”¶åˆ°é‡å¤çš„ ACKï¼Œå°±ä¼šé‡ä¼ å¯¹åº”åŒ…ï¼Œè€Œä¸éœ€è¦ç­‰åˆ°è®¡æ—¶å™¨è¶…æ—¶ã€‚ é™„å½•ä¸€ï¼š MSLã€ttlåŠRTT&amp;RTOçš„åŒºåˆ«MSLï¼ˆ30sï¼‰æœ€å¤§æŠ¥æ–‡ç”Ÿå­˜æ—¶é—´Maximum Segment Lifetime ç®€è¿°ï¼šæœ€å¤§æŠ¥æ–‡ç”Ÿå­˜æ—¶é—´ï¼Œä¸€èˆ¬æ˜¯30sï¼Œç”¨äºå…³é—­é“¾æ¥TIME_WAITçŠ¶æ€åœç•™2MSL æ¯ä¸ªTCPå®ç°å¿…é¡»é€‰æ‹©ä¸€ä¸ªMSLã€‚å®ƒæ˜¯ä»»ä½•æŠ¥æ–‡æ®µè¢«ä¸¢å¼ƒå‰åœ¨ç½‘ç»œå†…çš„æœ€é•¿æ—¶é—´ã€‚è¿™ä¸ªæ—¶é—´æ˜¯æœ‰é™çš„ï¼Œå› ä¸ºTCPæŠ¥æ–‡æ®µä»¥IPæ•°æ®æŠ¥åœ¨ç½‘ç»œå†…ä¼ è¾“ï¼Œè€ŒIPæ•°æ®æŠ¥åˆ™æœ‰é™åˆ¶å…¶ç”Ÿå­˜æ—¶é—´çš„TTLæ—¶é—´ã€‚RFC 793æŒ‡å‡ºMSLä¸º2åˆ†é’Ÿï¼ŒLinuxä¸º30s 2MSLï¼ˆ2*30sï¼‰å½“TCPæ‰§è¡Œä¸»åŠ¨å…³é—­ï¼Œå¹¶å‘å‡ºæœ€åä¸€ä¸ªACKï¼Œè¯¥é“¾æ¥å¿…é¡»åœ¨TIME_WAITçŠ¶æ€ä¸‹åœç•™çš„æ—¶é—´ä¸º2MSLã€‚è¿™æ ·å¯ä»¥ï¼ˆ1ï¼‰è®©TCPå†æ¬¡å‘é€æœ€åçš„ACKä»¥é˜²è¿™ä¸ªACKä¸¢å¤±ï¼ˆè¢«åŠ¨å…³é—­çš„ä¸€æ–¹è¶…æ—¶å¹¶é‡å‘æœ€åçš„FINï¼‰ï¼›ä¿è¯TCPçš„å¯é çš„å…¨åŒå·¥è¿æ¥çš„ç»ˆæ­¢ã€‚ï¼ˆ2ï¼‰å…è®¸è€çš„é‡å¤åˆ†èŠ‚åœ¨ç½‘ç»œä¸­æ¶ˆå¤±ã€‚å‚è€ƒæ–‡ç« ã€Šunixç½‘ç»œç¼–ç¨‹ã€‹ï¼ˆ3ï¼‰TCPè¿æ¥çš„å»ºç«‹å’Œç»ˆæ­¢ RTTå¾€è¿”æ—¶é—´ï¼ŒRTOè¶…æ—¶æ—¶é—´round-trip-time ç®€è¿°ï¼šRTTå®¢æˆ·åˆ°æœåŠ¡å™¨å¾€è¿”æ‰€èŠ±æ—¶é—´ï¼ŒRTOç”±RTTåŠ æƒè®¡ç®—å‡ºçš„ç”¨äºè¶…æ—¶é‡ä¼ çš„è¶…æ—¶æ—¶é—´ç”¨äº å¾€è¿”æ—¶é—´Round Trip Timeâ€”â€”RTTï¼šå®¢æˆ·åˆ°æœåŠ¡å™¨å¾€è¿”æ‰€èŠ±æ—¶é—´ï¼Œå¸¸è¯´çš„å»¶è¿Ÿï¼ŒPingå‘½ä»¤å‡ºæ¥çš„ è¶…æ—¶æ—¶é—´Retransmission TimeOutâ€”â€”RTOï¼šç”±RTTåŠ æƒè®¡ç®—å‡ºæ¥çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…å‡ºRTOæ²¡æœ‰ackåˆ™é‡ä¼  TCPè¶…æ—¶é‡ä¼ ä¸­æœ€é‡è¦çš„éƒ¨åˆ†å°±æ˜¯å¯¹ä¸€ä¸ªç»™å®šè¿æ¥çš„å¾€è¿”æ—¶é—´RTTçš„æµ‹é‡ã€‚ç”±äºè·¯ç”±å™¨å’Œç½‘ç»œæµé‡å‡ä¼šå˜åŒ–ï¼Œå› æ­¤è¿™ä¸ªæ—¶é—´å¯èƒ½ç»å¸¸ä¼šå˜åŒ–ï¼ŒTCPåº”è¯¥è·Ÿè¸ªè¿™äº›å˜åŒ–å¹¶ç›¸åº”åœ°æ”¹å˜å…¶è¶…æ—¶æ—¶é—´ã€‚ TTLç”Ÿå­˜æ—¶é—´å­—æ®µtime-to-live åœ¨IPé¦–éƒ¨ä¸­çš„8ä½å­—æ®µã€‚è¯¥å­—æ®µä¸æ˜¯å­˜çš„å…·ä½“æ—¶é—´ï¼Œè€Œæ˜¯è®¾ç½®äº†æ•°æ®æŠ¥å¯ä»¥ç»è¿‡çš„æœ€å¤šè·¯ç”±å™¨æ•°ã€‚å®ƒåˆ¶å®šäº†æ•°æ®æŠ¥çš„ç”Ÿå­˜æ—¶é—´ã€‚TTLçš„åˆå§‹å€¼ç”±æºä¸»æœºè®¾ç½®ï¼ˆé€šå¸¸ä¸º32æˆ–64ï¼‰ï¼Œä¸€æ—¦ç»è¿‡ä¸€ä¸ªå¤„ç†å®ƒçš„è·¯ç”±å™¨ï¼Œå®ƒçš„å€¼å°±å‡å»1.å½“è¯¥å­—æ®µå€¼ä¸º0æ—¶ï¼Œæ•°æ®æŠ¥å°±è¢«ä¸¢å¼ƒï¼Œå¹¶å‘é€ICMPæŠ¥æ–‡é€šçŸ¥æºä¸»æœºã€‚ é™„å½•äºŒï¼šMSSã€MTUä½ éœ€è¦çŸ¥é“ç½‘ç»œä¸Šæœ‰ä¸ªMTUï¼Œå¯¹äºä»¥å¤ªç½‘æ¥è¯´ï¼ŒMTUæ˜¯1500å­—èŠ‚ï¼Œé™¤å»TCP+IPå¤´çš„40ä¸ªå­—èŠ‚ï¼ŒçœŸæ­£çš„æ•°æ®ä¼ è¾“å¯ä»¥æœ‰1460ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„MSSï¼ˆMax Segment Sizeï¼‰æ³¨æ„ï¼ŒTCPçš„RFCå®šä¹‰è¿™ä¸ªMSSçš„é»˜è®¤å€¼æ˜¯536ï¼Œè¿™æ˜¯å› ä¸º RFC 791é‡Œè¯´äº†ä»»ä½•ä¸€ä¸ªIPè®¾å¤‡éƒ½å¾—æœ€å°‘æ¥æ”¶576å°ºå¯¸çš„å¤§å°ï¼ˆå®é™…ä¸Šæ¥è¯´576æ˜¯æ‹¨å·çš„ç½‘ç»œçš„MTUï¼Œè€Œ576å‡å»IPå¤´çš„20ä¸ªå­—èŠ‚å°±æ˜¯536ï¼‰ã€‚ é™„å½•ä¸‰ï¼šUDP ã€TCP é¦–éƒ¨æ ¼å¼UDPé¦–éƒ¨ï¼š8ä¸ªå­—èŠ‚ UDP é¦–éƒ¨å­—æ®µåªæœ‰ 8 ä¸ªå­—èŠ‚ï¼ŒåŒ…æ‹¬æºç«¯å£ã€ç›®çš„ç«¯å£ã€é•¿åº¦ã€æ£€éªŒå’Œã€‚12 å­—èŠ‚çš„ä¼ªé¦–éƒ¨æ˜¯ä¸ºäº†è®¡ç®—æ£€éªŒå’Œä¸´æ—¶æ·»åŠ çš„ã€‚ TCPé¦–éƒ¨ï¼š20ä¸ªå­—èŠ‚ä»¥ä¸Š TCP é¦–éƒ¨æ ¼å¼æ¯” UDP å¤æ‚ã€‚ åºå·ï¼šç”¨äºå¯¹å­—èŠ‚æµè¿›è¡Œç¼–å·ï¼Œä¾‹å¦‚åºå·ä¸º 301ï¼Œè¡¨ç¤ºç¬¬ä¸€ä¸ªå­—èŠ‚çš„ç¼–å·ä¸º 301ï¼Œå¦‚æœæºå¸¦çš„æ•°æ®é•¿åº¦ä¸º 100 å­—èŠ‚ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µçš„åºå·åº”ä¸º 401ã€‚ ç¡®è®¤å·ï¼šæœŸæœ›æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µçš„åºå·ã€‚ä¾‹å¦‚ B æ­£ç¡®æ”¶åˆ° A å‘é€æ¥çš„ä¸€ä¸ªæŠ¥æ–‡æ®µï¼Œåºå·ä¸º 501ï¼Œæºå¸¦çš„æ•°æ®é•¿åº¦ä¸º 200 å­—èŠ‚ï¼Œå› æ­¤ B æœŸæœ›ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µçš„åºå·ä¸º 701ï¼ŒB å‘é€ç»™ A çš„ç¡®è®¤æŠ¥æ–‡æ®µä¸­ç¡®è®¤å·å°±ä¸º 701ã€‚ æ•°æ®åç§»ï¼šæŒ‡çš„æ˜¯æ•°æ®éƒ¨åˆ†è·ç¦»æŠ¥æ–‡æ®µèµ·å§‹å¤„çš„åç§»é‡ï¼Œå®é™…ä¸ŠæŒ‡çš„æ˜¯é¦–éƒ¨çš„é•¿åº¦ã€‚ æ§åˆ¶ä½ï¼šå…«ä½ä»å·¦åˆ°å³åˆ†åˆ«æ˜¯ CWRï¼ŒECEï¼ŒURGï¼ŒACKï¼ŒPSHï¼ŒRSTï¼ŒSYNï¼ŒFINã€‚ CWRï¼šCWR æ ‡å¿—ä¸åé¢çš„ ECE æ ‡å¿—éƒ½ç”¨äº IP é¦–éƒ¨çš„ ECN å­—æ®µï¼ŒECE æ ‡å¿—ä¸º 1 æ—¶ï¼Œåˆ™é€šçŸ¥å¯¹æ–¹å·²å°†æ‹¥å¡çª—å£ç¼©å°ï¼› ECEï¼šè‹¥å…¶å€¼ä¸º 1 åˆ™ä¼šé€šçŸ¥å¯¹æ–¹ï¼Œä»å¯¹æ–¹åˆ°è¿™è¾¹çš„ç½‘ç»œæœ‰é˜»å¡ã€‚åœ¨æ”¶åˆ°æ•°æ®åŒ…çš„ IP é¦–éƒ¨ä¸­ ECN ä¸º 1 æ—¶å°† TCP é¦–éƒ¨ä¸­çš„ ECE è®¾ä¸º 1ï¼› URGï¼šè¯¥ä½è®¾ä¸º 1ï¼Œè¡¨ç¤ºåŒ…ä¸­æœ‰éœ€è¦ç´§æ€¥å¤„ç†çš„æ•°æ®ï¼Œå¯¹äºéœ€è¦ç´§æ€¥å¤„ç†çš„æ•°æ®ï¼Œä¸åé¢çš„ç´§æ€¥æŒ‡é’ˆæœ‰å…³ï¼› ACKï¼šè¯¥ä½è®¾ä¸º 1ï¼Œç¡®è®¤åº”ç­”çš„å­—æ®µæœ‰æ•ˆï¼ŒTCPè§„å®šé™¤äº†æœ€åˆå»ºç«‹è¿æ¥æ—¶çš„ SYN åŒ…ä¹‹å¤–è¯¥ä½å¿…é¡»è®¾ä¸º 1ï¼› PSHï¼šè¯¥ä½è®¾ä¸º 1ï¼Œè¡¨ç¤ºéœ€è¦å°†æ”¶åˆ°çš„æ•°æ®ç«‹åˆ»ä¼ ç»™ä¸Šå±‚åº”ç”¨åè®®ï¼Œè‹¥è®¾ä¸º 0ï¼Œåˆ™å…ˆå°†æ•°æ®è¿›è¡Œç¼“å­˜ï¼› RSTï¼šè¯¥ä½è®¾ä¸º 1ï¼Œè¡¨ç¤º TCP è¿æ¥å‡ºç°å¼‚å¸¸å¿…é¡»å¼ºåˆ¶æ–­å¼€è¿æ¥ï¼› SYNï¼šç”¨äºå»ºç«‹è¿æ¥ï¼Œè¯¥ä½è®¾ä¸º 1ï¼Œè¡¨ç¤ºå¸Œæœ›å»ºç«‹è¿æ¥ï¼Œå¹¶åœ¨å…¶åºåˆ—å·çš„å­—æ®µè¿›è¡Œåºåˆ—å·åˆå€¼è®¾å®šï¼› FINï¼šè¯¥ä½è®¾ä¸º 1ï¼Œè¡¨ç¤ºä»Šåä¸å†æœ‰æ•°æ®å‘é€ï¼Œå¸Œæœ›æ–­å¼€è¿æ¥ã€‚å½“é€šä¿¡ç»“æŸå¸Œæœ›æ–­å¼€è¿æ¥æ—¶ï¼Œé€šä¿¡åŒæ–¹çš„ä¸»æœºä¹‹é—´å°±å¯ä»¥ç›¸äº’äº¤æ¢ FIN ä½ç½®ä¸º 1 çš„ TCP æ®µã€‚ æ¯ä¸ªä¸»æœºåˆå¯¹å¯¹æ–¹çš„ FIN åŒ…è¿›è¡Œç¡®è®¤åº”ç­”ä¹‹åå¯ä»¥æ–­å¼€è¿æ¥ã€‚ä¸è¿‡ï¼Œä¸»æœºæ”¶åˆ° FIN è®¾ç½®ä¸º 1 çš„ TCP æ®µä¹‹åä¸å¿…é©¬ä¸Šå›å¤ä¸€ä¸ª FIN åŒ…ï¼Œè€Œæ˜¯å¯ä»¥ç­‰åˆ°ç¼“å†²åŒºä¸­çš„æ‰€æœ‰æ•°æ®éƒ½å› ä¸ºå·²æˆåŠŸå‘é€è€Œè¢«è‡ªåŠ¨åˆ é™¤ä¹‹åå†å‘ FIN åŒ…ï¼› çª—å£ï¼šçª—å£å€¼ä½œä¸ºæ¥æ”¶æ–¹è®©å‘é€æ–¹è®¾ç½®å…¶å‘é€çª—å£çš„ä¾æ®ã€‚ä¹‹æ‰€ä»¥è¦æœ‰è¿™ä¸ªé™åˆ¶ï¼Œæ˜¯å› ä¸ºæ¥æ”¶æ–¹çš„æ•°æ®ç¼“å­˜ç©ºé—´æ˜¯æœ‰é™çš„ã€‚ TCPå¤´æ ¼å¼æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹TCPå¤´çš„æ ¼å¼ TCPå¤´æ ¼å¼ï¼ˆå›¾ç‰‡æ¥æºï¼‰ ä½ éœ€è¦æ³¨æ„è¿™ä¹ˆå‡ ç‚¹ï¼š TCPçš„åŒ…æ˜¯æ²¡æœ‰IPåœ°å€çš„ï¼Œé‚£æ˜¯IPå±‚ä¸Šçš„äº‹ã€‚ä½†æ˜¯æœ‰æºç«¯å£å’Œç›®æ ‡ç«¯å£ã€‚ ä¸€ä¸ªTCPè¿æ¥éœ€è¦å››ä¸ªå…ƒç»„æ¥è¡¨ç¤ºæ˜¯åŒä¸€ä¸ªè¿æ¥ï¼ˆsrc_ip, src_port, dst_ip, dst_portï¼‰å‡†ç¡®è¯´æ˜¯äº”å…ƒç»„ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯åè®®ã€‚ä½†å› ä¸ºè¿™é‡Œåªæ˜¯è¯´TCPåè®®ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘åªè¯´å››å…ƒç»„ã€‚ æ³¨æ„ä¸Šå›¾ä¸­çš„å››ä¸ªéå¸¸é‡è¦çš„ä¸œè¥¿ï¼š Sequence Numberæ˜¯åŒ…çš„åºå·ï¼Œç”¨æ¥è§£å†³ç½‘ç»œåŒ…ä¹±åºï¼ˆreorderingï¼‰é—®é¢˜ã€‚ Acknowledgement Numberå°±æ˜¯ACKâ€”â€”ç”¨äºç¡®è®¤æ”¶åˆ°ï¼Œç”¨æ¥è§£å†³ä¸ä¸¢åŒ…çš„é—®é¢˜ã€‚ Windowåˆå«Advertised-Windowï¼Œä¹Ÿå°±æ˜¯è‘—åçš„æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰ï¼Œç”¨äºè§£å†³æµæ§çš„ã€‚ TCP Flag ï¼Œä¹Ÿå°±æ˜¯åŒ…çš„ç±»å‹ï¼Œä¸»è¦æ˜¯ç”¨äºæ“æ§TCPçš„çŠ¶æ€æœºçš„ã€‚ å…³äºå…¶å®ƒçš„ä¸œè¥¿ï¼Œå¯ä»¥å‚çœ‹ä¸‹é¢çš„å›¾ç¤º ï¼ˆå›¾ç‰‡æ¥æºï¼‰ IPé¦–éƒ¨ï¼š20ä¸ªå­—èŠ‚ä»¥ä¸Š 1ã€ç¬¬ä¸€ä¸ª4å­—èŠ‚ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€è¡Œï¼‰ï¼šï¼ˆ1ï¼‰ç‰ˆæœ¬å·ï¼ˆVersionï¼‰ï¼Œ4ä½ï¼›ç”¨äºæ ‡è¯†IPåè®®ç‰ˆæœ¬ï¼ŒIPv4æ˜¯0100ï¼ŒIPv6æ˜¯0110ï¼Œä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶çš„4å’Œ6ã€‚ï¼ˆ2ï¼‰é¦–éƒ¨é•¿åº¦ï¼ˆInternet Header Lengthï¼‰ï¼Œ4ä½ï¼›ç”¨äºæ ‡è¯†é¦–éƒ¨çš„é•¿åº¦ï¼Œå•ä½ä¸º4å­—èŠ‚ï¼Œæ‰€ä»¥é¦–éƒ¨é•¿åº¦æœ€å¤§å€¼ä¸ºï¼š(2^4 - 1) * 4 = 60å­—èŠ‚ï¼Œä½†ä¸€èˆ¬åªæ¨èä½¿ç”¨20å­—èŠ‚çš„å›ºå®šé•¿åº¦ã€‚ï¼ˆ3ï¼‰æœåŠ¡ç±»å‹ï¼ˆType Of Serviceï¼‰ï¼Œ8ä½ï¼›ç”¨äºæ ‡è¯†IPåŒ…çš„ä¼˜å…ˆçº§ï¼Œä½†ç°åœ¨å¹¶æœªä½¿ç”¨ã€‚ï¼ˆ4ï¼‰æ€»é•¿åº¦ï¼ˆTotal Lengthï¼‰ï¼Œ16ä½ï¼›æ ‡è¯†IPæ•°æ®æŠ¥çš„æ€»é•¿åº¦ï¼Œæœ€å¤§ä¸ºï¼š2^16 -1 = 65535å­—èŠ‚ã€‚2ã€ç¬¬äºŒä¸ªå››å­—èŠ‚ï¼šï¼ˆ1ï¼‰æ ‡è¯†ï¼ˆIdentificationï¼‰ï¼Œ16ä½ï¼›ç”¨äºæ ‡è¯†IPæ•°æ®æŠ¥ï¼Œå¦‚æœå› ä¸ºæ•°æ®é“¾è·¯å±‚å¸§æ•°æ®æ®µé•¿åº¦é™åˆ¶ï¼ˆä¹Ÿå°±æ˜¯MTUï¼Œæ”¯æŒçš„æœ€å¤§ä¼ è¾“å•å…ƒï¼‰ï¼ŒIPæ•°æ®æŠ¥éœ€è¦è¿›è¡Œåˆ†ç‰‡å‘é€ï¼Œåˆ™æ¯ä¸ªåˆ†ç‰‡çš„IPæ•°æ®æŠ¥æ ‡è¯†éƒ½æ˜¯ä¸€è‡´çš„ã€‚ï¼ˆ2ï¼‰æ ‡è¯†ï¼ˆFlagï¼‰ï¼Œ3ä½ï¼Œä½†ç›®å‰åªæœ‰2ä½æœ‰æ„ä¹‰ï¼›æœ€ä½ä½ä¸ºMFï¼ŒMF=1ä»£è¡¨åé¢è¿˜æœ‰åˆ†ç‰‡çš„æ•°æ®æŠ¥ï¼ŒMF=0ä»£è¡¨å½“å‰æ•°æ®æŠ¥å·²æ˜¯æœ€åçš„æ•°æ®æŠ¥ã€‚æ¬¡ä½ä½ä¸ºDFï¼ŒDF=1ä»£è¡¨ä¸èƒ½åˆ†ç‰‡ï¼ŒDF=0ä»£è¡¨å¯ä»¥åˆ†ç‰‡ã€‚ï¼ˆ3ï¼‰ç‰‡åç§»ï¼ˆFragment Offsetï¼‰ï¼Œ13ä½ï¼›ä»£è¡¨æŸä¸ªåˆ†ç‰‡åœ¨åŸå§‹æ•°æ®ä¸­çš„ç›¸å¯¹ä½ç½®ã€‚3ã€ç¬¬ä¸‰ä¸ªå››å­—èŠ‚ï¼šï¼ˆ1ï¼‰ç”Ÿå­˜æ—¶é—´ï¼ˆTTLï¼‰ï¼Œ8ä½ï¼›ä»¥å‰ä»£è¡¨IPæ•°æ®æŠ¥æœ€å¤§çš„ç”Ÿå­˜æ—¶é—´ï¼Œç°åœ¨æ ‡è¯†IPæ•°æ®æŠ¥å¯ä»¥ç»è¿‡çš„è·¯ç”±å™¨æ•°ã€‚ï¼ˆ2ï¼‰åè®®ï¼ˆProtocolï¼‰ï¼Œ8ä½ï¼›ä»£è¡¨ä¸Šå±‚ä¼ è¾“å±‚åè®®çš„ç±»å‹ï¼Œ1ä»£è¡¨ICMPï¼Œ2ä»£è¡¨IGMPï¼Œ6ä»£è¡¨TCPï¼Œ17ä»£è¡¨UDPã€‚ï¼ˆ3ï¼‰æ ¡éªŒå’Œï¼ˆHeader Checksumï¼‰ï¼Œ16ä½ï¼›ç”¨äºéªŒè¯æ•°æ®å®Œæ•´æ€§ï¼Œè®¡ç®—æ–¹æ³•ä¸ºï¼Œé¦–å…ˆå°†æ ¡éªŒå’Œä½ç½®é›¶ï¼Œç„¶åå°†æ¯16ä½äºŒè¿›åˆ¶åç æ±‚å’Œå³ä¸ºæ ¡éªŒå’Œï¼Œæœ€åå†™å…¥æ ¡éªŒå’Œä½ç½®ã€‚4ã€ç¬¬å››ä¸ªå››å­—èŠ‚ï¼šæºIPåœ°å€5ã€ç¬¬äº”ä¸ªå››å­—èŠ‚ï¼šç›®çš„IPåœ°å€ é™„å½•ï¼šå‚è€ƒQAç½‘ç»œç¯‡ï¼šæœ‹å‹é¢è¯•ä¹‹TCP/IPï¼Œå›å»ç­‰é€šçŸ¥å§ - æ˜é‡‘ (juejin.cn) TCP çš„é‚£äº›äº‹å„¿ï¼ˆä¸Šï¼‰ | é…· å£³ - CoolShell TCP çš„é‚£äº›äº‹å„¿ï¼ˆä¸‹ï¼‰ | é…· å£³ - CoolShell","link":"/2021/11/11/Tcp/"},{"title":"TaskPerFrame","text":"16ms å†…éƒ½éœ€è¦å®Œæˆä»€ä¹ˆï¼Ÿfrom : https://juejin.cn/post/7062552765117136903 // Vsyncé¡¶å±‚ Vsync è°ƒåº¦ï¼šç¡¬ä»¶æ¯éš”16.6mså‘å‡ºç¡¬ä»¶Vsyncä¿¡å·ï¼Œéœ€è¦ç»è¿‡è½¯ä»¶è°ƒåº¦ï¼Œç±»ä¼¼æ³¨å†Œï¼Œæ‰èƒ½æ”¶åˆ°å›è°ƒ æ¶ˆæ¯è°ƒåº¦ï¼šä¸»è¦æ˜¯ doframe çš„æ¶ˆæ¯è°ƒåº¦ï¼Œå¦‚æœæ¶ˆæ¯è¢«é˜»å¡ï¼Œä¼šç›´æ¥é€ æˆå¡é¡¿ï¼› input å¤„ç†ï¼šè§¦æ‘¸äº‹ä»¶çš„å¤„ç†ï¼› åŠ¨ç”»å¤„ç†ï¼šanimator åŠ¨ç”»æ‰§è¡Œå’Œæ¸²æŸ“ï¼› view å¤„ç†ï¼šä¸»è¦æ˜¯ view ç›¸å…³çš„éå†å’Œä¸‰å¤§æµç¨‹ï¼› measureã€layoutã€drawï¼šview ä¸‰å¤§æµç¨‹çš„æ‰§è¡Œï¼› //Vsyncåº•å±‚ DisplayList æ›´æ–°ï¼šview ç¡¬ä»¶åŠ é€Ÿåçš„ draw opï¼› OpenGL æŒ‡ä»¤è½¬æ¢ï¼šcanvasæŒ‡ä»¤è½¬æ¢ä¸º OpenGL æŒ‡ä»¤ï¼› æŒ‡ä»¤ buffer äº¤æ¢ï¼šOpenGL çš„æŒ‡ä»¤äº¤æ¢åˆ° GPU å†…éƒ¨æ‰§è¡Œï¼› GPU å¤„ç†ï¼šGPU å¯¹æ•°æ®çš„å¤„ç†è¿‡ç¨‹ï¼› layer åˆæˆï¼šsurface buffer åˆæˆå±å¹•æ˜¾ç¤º buffer çš„æµç¨‹ï¼› å…‰æ …åŒ–ï¼šå°†çŸ¢é‡å›¾è½¬æ¢ä¸ºä½å›¾ï¼› Displayï¼šæ˜¾ç¤ºæ§åˆ¶ï¼› buffer åˆ‡æ¢ï¼šåˆ‡æ¢å±å¹•æ˜¾ç¤ºçš„å¸§ bufferï¼› Google å°†è¿™ä¸ªè¿‡ç¨‹åˆ’åˆ†ä¸ºï¼šå…¶ä»–æ—¶é—´/VSync å»¶è¿Ÿã€è¾“å…¥å¤„ç†ã€åŠ¨ç”»ã€æµ‹é‡/å¸ƒå±€ã€ç»˜åˆ¶ã€åŒæ­¥å’Œä¸Šä¼ ã€å‘½ä»¤é—®é¢˜ã€äº¤æ¢ç¼“å†²åŒºã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ GPU ä¸¥æ ¼æ¨¡å¼ï¼Œå…¶å®é“ç†æ˜¯ä¸€æ ·çš„ã€‚åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå°±å›ç­”å‡ºæ¥äº†ç¬¬äºŒä¸ªé—®é¢˜ï¼š å‡†ç¡®åœ°è¯´ï¼Œè¿™é‡Œä»å¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–ï¼š16ms å†…å®Œæˆ APP ä¾§æ•°æ®çš„ç”Ÿäº§ï¼›16ms å†…å®Œæˆ sf layer çš„åˆæˆ View çš„è§†è§‰æ•ˆæœæ­£æ˜¯é€šè¿‡è¿™ä¸€æ•´æ¡å¤æ‚çš„é“¾è·¯ä¸€æ­¥æ­¥å±•ç¤ºå‡ºæ¥çš„ï¼Œæœ‰äº†è¿™ä¸ªå‰æï¼Œé‚£å°±å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šä¸Šè¿°ä»»æ„é“¾è·¯å‘ç”Ÿå¡é¡¿ï¼Œå‡ä¼šé€ æˆå¡é¡¿ã€‚ *å¸¸è§é—®é¢˜ï¼šçº¢è‰²ï¼ˆCommand Issueï¼‰ï¼šå¤ªå¤šdisplay lists æµ…è“è‰²ï¼ˆuploadï¼‰ï¼šåŠ è½½äº†å¤§é‡å›¾å½¢(bitmap, graphics) æ·±è“è‰²ï¼ˆDrawï¼‰ï¼šå¤§æ¦‚ç‡åœ¨onDrawä¸­æ‰§è¡Œäº†æœ‰ç‚¹è€—æ—¶çš„ä»»åŠ¡ æœ€æµ…çš„ç»¿è‰²ï¼ˆæµ‹ç»˜ï¼‰:éœ€è¦æ’æŸ¥viewæ ‘å±‚çº§ view hierarchy è¿‡æ·± æµ…ç»¿è‰²ï¼ˆå¤„ç†è¾“å…¥å’ŒåŠ¨ç”»ï¼‰ï¼šéœ€è¦æ’æŸ¥æ»šåŠ¨ä¸­çš„view Bindingï¼Œå¦‚RV çš„onBindViewHolder æ·±ç»¿è‰²ï¼ˆå»¶è¿ŸVSyncï¼‰ï¼šç›´æ¥åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº†è€—æ—¶ä»»åŠ¡","link":"/2022/03/16/TaskPerFrame/"},{"title":"ThreadLocal","text":"ThreadLocalï¼šThreadLocalï¼š çº¿ç¨‹æœ¬åœ°å­˜å‚¨åŒºï¼ˆThread Local Storageï¼Œç®€ç§°ä¸ºTLSï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ç§æœ‰çš„æœ¬åœ°å­˜å‚¨åŒºåŸŸï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´å½¼æ­¤ä¸èƒ½è®¿é—®å¯¹æ–¹çš„TLSåŒºåŸŸã€‚ ThreadLocalç±»ä¸è¿‡æ˜¯ä¸ºäº†æ‰§è¡Œset/getï¼Œç¡®å®šæ³›å‹çš„å·¥å…·äººè€Œå·²ã€‚çœŸæ­£æ•°æ®æ˜¯é çš„æ¯ä¸ªThreadå†…éƒ¨ç»´æŠ¤ã€‚ å®é™…ä¸Šå°±æ˜¯ æ¯ä¸ªThreadå¯¹è±¡ä¸­ ç»´æŠ¤äº†ä¸€ä¸ª å«ThreadLocal.ThreadLocalMapçš„ **keyä¸º ThreadLocalå¯¹è±¡, valueä¸º å­˜å‚¨çš„å€¼ ** çš„key-valeæ˜ å°„ç»“æ„ï¼Œ(å®é™…ä¸Šæ˜¯ä¸€ä¸ªé”®å€¼å¯¹ç»„æˆentryçš„å”¯ä¸€ç¯å½¢æ•°ç»„ï¼Œçº¿æ€§æ¢æµ‹ï¼Œåˆå§‹å€¼3/4å®¹é‡æ‰©å®¹) å½“è°ƒç”¨threadLocalInstance.set(value)æ—¶ï¼Œå…¶å®æ—¶è°ƒç”¨çš„CurrentThread.threadLocalMap.set(threadLocalInstance, value) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475public class Main { public static void main(String[] args) { ThreadLocal&lt;String&gt; threadLocalOne = new ThreadLocal&lt;&gt;(); ThreadLocal&lt;String&gt; threadLocalTwo = new ThreadLocal&lt;&gt;(); new Thread(new Runnable() { @Override public void run() { threadLocalOne.set(&quot;çº¿ç¨‹ä¸€çš„æ•°æ® --- threadLocalOne&quot;); threadLocalTwo.set(&quot;çº¿ç¨‹ä¸€çš„æ•°æ® --- threadLocalTwo&quot;); System.out.println(threadLocalOne.get()); System.out.println(threadLocalTwo.get()); } }).start(); new Thread(new Runnable() { @Override public void run() { System.out.println(threadLocalOne.get()); System.out.println(threadLocalTwo.get()); threadLocalOne.set(&quot;çº¿ç¨‹äºŒçš„æ•°æ® --- threadLocalOne&quot;); threadLocalTwo.set(&quot;çº¿ç¨‹äºŒçš„æ•°æ® --- threadLocalTwo&quot;); System.out.println(threadLocalOne.get()); System.out.println(threadLocalTwo.get()); } }).start(); }}//çº¿ç¨‹ä¸€çš„æ•°æ® --- threadLocalOne//çº¿ç¨‹ä¸€çš„æ•°æ® --- threadLocalTwo//null//null//çº¿ç¨‹äºŒçš„æ•°æ® --- threadLocalOne//çº¿ç¨‹äºŒçš„æ•°æ® --- threadLocalTwo#ThreadLocal.class { //å­˜æ•°æ®ï¼Œè‹¥å½“å‰çº¿ç¨‹æœªæ›¾è°ƒç”¨è¿‡ThreadLocal.set,åˆ™ä¸ºthreadåˆå§‹åŒ–ä¸€ä¸ªThreadLocalMap public void set(T value) { Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else createMap(t, value); } //è·å–å½“å‰Threadçš„threadLocalMapå˜é‡,ä»¥ThreadLocalä¸ºkeyï¼Œä»threadLocalMapä¸­å–å€¼ public T get() { Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) { ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) { @SuppressWarnings(&quot;unchecked&quot;) T result = (T)e.value; return result; } } //å½“çº¿ç¨‹å¯¹åº”ThreadLocalMapæœªå­˜å‚¨è¯¥keyæ—¶ï¼Œè¿”å›null return setInitialValue(); } ThreadLocalMap getMap(Thread t) { return t.threadLocals; } void createMap(Thread t, T firstValue) { t.threadLocals = new ThreadLocalMap(this, firstValue); }} 12Entry[] tab = table;tab[i] = new Entry(key, value); 1234567891011121314public class ThreadLocal&lt;T&gt; { ... static class ThreadLocalMap { ... private static int nextIndex(int i, int len) { return ((i + 1 &lt; len) ? i + 1 : 0); } ... }} åº”ç”¨åœºæ™¯1ï¼šæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªLooperLooper.prepare()ï¼šåœ¨æ¯ä¸ªçº¿ç¨‹åªå…è®¸æ‰§è¡Œä¸€æ¬¡ï¼Œè¯¥æ–¹æ³•ä¼šåˆ›å»ºLooperå¯¹è±¡ï¼ŒLooperçš„æ„é€ æ–¹æ³•ä¸­ä¼šåˆ›å»ºä¸€ä¸ªMessageQueueå¯¹è±¡ï¼Œå†å°†Looperå¯¹è±¡ä¿å­˜åˆ°å½“å‰çº¿ç¨‹TLS 12345678private static void prepare(boolean quitAllowed) { //æ¯ä¸ªçº¿ç¨‹åªå…è®¸æ‰§è¡Œä¸€æ¬¡è¯¥æ–¹æ³•ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œæ—¶çº¿ç¨‹çš„TLSå·²æœ‰æ•°æ®ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ if (sThreadLocal.get() != null) { throw new RuntimeException(&quot;Only one Looper may be created per thread&quot;); } //åˆ›å»ºLooperå¯¹è±¡ï¼Œå¹¶ä¿å­˜åˆ°å½“å‰çº¿ç¨‹çš„TLSåŒºåŸŸ sThreadLocal.set(new Looper(quitAllowed));} åº”ç”¨åœºæ™¯2ï¼šChoreographeræ˜¯ä¸»çº¿ç¨‹çš„ThradLocalå˜é‡123456789101112131415161718192021222324252627public final class Choreographer { // Thread local storage for the choreographer. private static final ThreadLocal&lt;Choreographer&gt; sThreadInstance = new ThreadLocal&lt;Choreographer&gt;() { @Override protected Choreographer initialValue() { Looper looper = Looper.myLooper(); if (looper == null) { throw new IllegalStateException(&quot;The current thread must have a looper!&quot;); } // åˆ›å»º Choreographer å¯¹è±¡ Choreographer choreographer = new Choreographer(looper, VSYNC_SOURCE_APP); if (looper == Looper.getMainLooper()) { mMainInstance = choreographer; } return choreographer; } }; private static volatile Choreographer mMainInstance; public static Choreographer getInstance() { return sThreadInstance.get(); } } ä» Choreographer çš„ getInstance æ–¹æ³•ä¸­, æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨ ThreadLocal.get æ–¹æ³•, ä»å½“å‰çº¿ç¨‹çš„ ThreadLocalMap æ•£åˆ—è¡¨ä¸­è·å–ä»¥è¿™ä¸ª ThreadLocal ä¸º Key çš„ Value å€¼, è‹¥ Value ä¸å­˜åœ¨, åˆ™ä¼šè°ƒç”¨ initialValue åˆ›å»º Choreographer å®ä¾‹å¯¹è±¡ ç”±æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡º Choreographer æ˜¯çº¿ç¨‹å•ä¾‹çš„, å¹¶ä¸”å®ƒåªèƒ½è¿è¡Œåœ¨å­˜åœ¨ Looper çš„çº¿ç¨‹ä¸­,","link":"/2021/05/14/ThreadLocal/"},{"title":"Throwable","text":"","link":"/2022/08/10/Throwable/"},{"title":"sharePreference","text":"SharedPreferencesåŸç†-xmind \u0010SharedPreferencesæ˜¯ç³»ç»Ÿæä¾›çš„ä¸€ç§ç®€æ˜“æ•°æ®æŒä¹…åŒ–çš„æ‰‹æ®µï¼Œé€‚åˆå•è¿›ç¨‹ã€å°æ‰¹é‡çš„æ•°æ®å­˜å‚¨ä¸è®¿é—®ã€‚ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨åœ¨xmlæ–‡ä»¶ä¸­ã€‚æ–‡ä»¶å­˜å‚¨è·¯å¾„ä¸ºdata/data/package_name/shared_prefs/ç›®å½•ã€‚ æºç è§£æ æºç è§£æ è·å–SharedPerferenceså¯¹è±¡ è·å–SharedPerferenceså¯¹è±¡ è·å–æ–¹æ³•ä»getSharedPreferences(name,mode)å¼€å§‹ï¼Œæ­¤æ—¶å°±éœ€è¦å»åŠ è½½å¯¹åº”nameçš„xmlæ–‡ä»¶ 12345678910class MainActivity : AppCompatActivity() { lateinit var sharedPreferences: SharedPreferences override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContentView(R.layout.activity_main) sharedPreferences = getSharedPreferences(&quot;test&quot;, MODE_PRIVATE); }}Copytest`è¡¨ç¤ºç”Ÿæˆçš„xmlæ–‡ä»¶åä¸º`test.xml modeå¯¹åº”çš„æ˜¯xmlæ–‡ä»¶çš„è®¿é—®æƒé™ä»¥åŠæ•°æ®çš„å†™å…¥æ–¹å¼ æƒé™æ§åˆ¶æ ¼å¼ ä½œç”¨ å¤‡æ³¨ Context.MODE_PRIVATE ä»£è¡¨è¯¥æ–‡ä»¶æ˜¯ç§æœ‰æ•°æ®ï¼Œåªèƒ½è¢«å½“å‰åº”ç”¨è®¿é—®ã€‚ å†™å…¥çš„å†…å®¹ä¼šè¦†ç›–æºæ–‡ä»¶çš„å†…å®¹ã€‚ é»˜è®¤æ“ä½œæ¨¡å¼ Context.MODE_WORLD_READABLE è¡¨ç¤ºå½“å‰æ–‡ä»¶å¯ä»¥è¢«å…¶ä»–åº”ç”¨è¯»å– Context.MODE_WORLE_WRITEABLE è¡¨ç¤ºå½“å‰æ–‡ä»¶å¯ä»¥è¢«å…¶ä»–åº”ç”¨å†™å…¥ Context.MODE_APPEND ä¼šæ£€æŸ¥å½“å‰æ˜¯å¦æœ‰æ–‡ä»¶å­˜åœ¨ï¼Ÿ åœ¨åœ¨åé¢è¿½åŠ å†…å®¹ ä¸å­˜åœ¨åˆ™å»åˆ›å»ºæ–°æ–‡ä»¶ Context.MODE_MULTI_PROCESS éƒ¨åˆ†æ”¯æŒè·¨è¿›ç¨‹ä½¿ç”¨ åŸç†å°±æ˜¯é‡æ–°è¯»å–xmlæ–‡ä»¶å†…å®¹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152//ContextImpl.javaprivate static ArrayMap&lt;String, ArrayMap&lt;File, SharedPreferencesImpl&gt;&gt; sSharedPrefsCache;private ArrayMap&lt;String, File&gt; mSharedPrefsPaths; public SharedPreferences getSharedPreferences(String name, int mode) { File file; synchronized (ContextImpl.class) { if (mSharedPrefsPaths == null) { mSharedPrefsPaths = new ArrayMap&lt;&gt;(); } file = mSharedPrefsPaths.get(name); if (file == null) { //æ ¹æ®åå­— è·å–å¯¹åº”è·¯å¾„æ–‡ä»¶ file = getSharedPreferencesPath(name); mSharedPrefsPaths.put(name, file); } } return getSharedPreferences(file, mode); } @Override public File getSharedPreferencesPath(String name) { return makeFilename(getPreferencesDir(), name + &quot;.xml&quot;); } public SharedPreferences getSharedPreferences(File file, int mode) { SharedPreferencesImpl sp; //ä¿è¯åˆ›å»ºè¿‡ç¨‹çº¿ç¨‹å®‰å…¨ synchronized (ContextImpl.class) { final ArrayMap&lt;File, SharedPreferencesImpl&gt; cache = getSharedPreferencesCacheLocked(); //è·å–ç¼“å­˜sp sp = cache.get(file); if (sp == null) { checkMode(mode); ... //æ–°å»ºSPå¯¹è±¡ sp = new SharedPreferencesImpl(file, mode); //å­˜å…¥ç¼“å­˜ cache.put(file, sp); return sp; } } if ((mode &amp; Context.MODE_MULTI_PROCESS) != 0 || getApplicationInfo().targetSdkVersion &lt; android.os.Build.VERSION_CODES.HONEYCOMB) { //é‡æ–°åŠ è½½XMLæ–‡ä»¶ sp.startReloadIfChangedUnexpectedly(); } return sp; }Copy ä¸»è¦æ‰§è¡Œäº†ä¸‰æ­¥ï¼š æ ¹æ®ä¼ å…¥çš„nameåœ¨å¯¹åº”è·¯å¾„ä¸‹ç”Ÿæˆå¯¹åº”çš„xmlæ–‡ä»¶ï¼Œå¹¶å­˜å…¥mSharedPrefsPathsè¿›è¡Œç¼“å­˜ã€‚ åˆ›å»ºæ–‡ä»¶å®Œæ¯•åï¼Œå†å»åˆ›å»ºå¯¹åº”çš„SharedPreferencesImplå¯¹è±¡ï¼Œåˆ›å»ºå®Œæˆåç¼“å­˜åˆ°cacheä¸­ã€‚æ¯ä¸€ä¸ªxmlæ–‡ä»¶éƒ½ä¼šå¯¹åº”ä¸€ä¸ªSPå¯¹è±¡ è‹¥è®¾ç½®äº†modeä¸ºContext.MODE_MULTI_PROCESSï¼Œå°±éœ€è¦é‡æ–°å»åŠ è½½ä¸€æ¬¡xmlæ–‡ä»¶ã€‚ åˆå§‹åŒ–SPå¯¹è±¡æœ€åéƒ½æ˜¯ç”±SharedPreferencesImplè¿›è¡Œæ„å»º 12345678910111213SharedPreferencesImpl(File file, int mode) { mFile = file; //æ„å»ºå¤‡ä»½æ–‡ä»¶ mBackupFile = makeBackupFile(file); mMode = mode; mLoaded = false; //ç¼“å­˜å½“å‰SPå­˜å‚¨çš„é”®å€¼å¯¹ mMap = null; mThrowable = null; //å¼€å§‹åŠ è½½ç£ç›˜çš„xmlæ–‡ä»¶ startLoadFromDisk();}Copy åŠ è½½æ–‡ä»¶ åŠ è½½æ–‡ä»¶ å¼€å¯ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹å»åŠ è½½xmlæ–‡ä»¶ï¼Œé˜²æ­¢é˜»å¡ä¸»çº¿ç¨‹ 123456789101112private void startLoadFromDisk() { //ä¸Šé”ä¿è¯çº¿ç¨‹å®‰å…¨ synchronized (mLock) { mLoaded = false; } new Thread(&quot;SharedPreferencesImpl-load&quot;) { public void run() { loadFromDisk(); } }.start();}Copy loadFromDisk()æ—¶ï¼Œéœ€è¦åˆ¤æ–­å½“å‰æ˜¯å¦å­˜åœ¨å¤‡ä»½æ–‡ä»¶ï¼Œè‹¥å­˜åœ¨å¤‡ä»½æ–‡ä»¶å°±æ„å‘³ç€ä¸Šä¸€æ¬¡å†™å…¥æ–‡ä»¶çš„è¿‡ç¨‹å‡ºç°äº†å¼‚å¸¸ï¼Œå¯¼è‡´å†™å…¥å¤±è´¥ã€‚ 123456789101112131415161718192021222324252627282930313233343536private void loadFromDisk() { synchronized (mLock) { if (mLoaded) { return; } if (mBackupFile.exists()) { //åˆ é™¤æºæ–‡ä»¶ mFile.delete(); //å¤‡ä»½æ–‡ä»¶é‡å‘½åä¸º æºæ–‡ä»¶ mBackupFile.renameTo(mFile); } } ... synchronized (mLock) { mLoaded = true; mThrowable = thrown; try { if (thrown == null) { if (map != null) { //è§£ææˆåŠŸ èµ‹å€¼åˆ°mMapè¿›è¡Œç¼“å­˜ mMap = map; mStatTimestamp = stat.st_mtim; mStatSize = stat.st_size; } else { mMap = new HashMap&lt;&gt;(); } } } catch (Throwable t) { mThrowable = t; } finally { //é‡Šæ”¾é” é€šçŸ¥å…¶ä»–çº¿ç¨‹å¯ä»¥å¼€å§‹ä½¿ç”¨SPå¯¹è±¡ mLock.notifyAll(); } }}Copy è¿™é‡Œå°±è¡¨ç°äº†SPçš„æ–‡ä»¶æŸåæ—¶çš„å¤‡ä»½æœºåˆ¶ï¼Œå½“æ–‡ä»¶å†™å…¥å¼‚å¸¸æ—¶ï¼Œå¯ç”¨å¤‡ä»½æ–‡ä»¶ä¿è¯ä¹‹å‰çš„æ•°æ®ä¸ä¼šå‡ºç°å¼‚å¸¸ã€‚ è·å–æ•°æ® è·å–æ•°æ® 123... åˆå§‹åŒ–å®Œæˆ spå¯¹è±¡sp.getString(&quot;a&quot;,&quot;b&quot;); //ä»spè·å–açš„å€¼Copy è·å–æ•°æ®æ”¯æŒéƒ¨åˆ†æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚intã€longã€Stringç­‰ 123456789101112131415161718192021222324252627282930//SharedPreferencesImpl.javapublic String getString(key){}public Set&lt;String&gt; getStringSet(key){}public int getInt(key){}public long getLong(key){}public float getFloat(key){}public boolean getBoolean(key){}//ä»¥ä¸‹æ‹¿ getString() ä¸¾ä¾‹åˆ†æè·å–æ•°æ®æµç¨‹ public String getString(String key, @Nullable String defValue) { synchronized (mLock) { awaitLoadedLocked(); String v = (String)mMap.get(key); return v != null ? v : defValue; } } private void awaitLoadedLocked() { while (!mLoaded) { try { //ç­‰å¾…mLocké‡Šæ”¾ mLock.wait(); } catch (InterruptedException unused) { } } if (mThrowable != null) { throw new IllegalStateException(mThrowable); } }Copy getXX()éƒ½æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹çš„ï¼Œå¹¶ä¸”æƒ³è¦è·å–æ•°æ®å°±å¿…é¡»ç­‰å¾…åŠ è½½æ–‡ä»¶è¿™ä¸€æ­¥å®Œæˆã€‚ç­‰å¾…mLock.notifyAll()æ‰å¯ä»¥ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚ å¦‚æœéœ€è¦è¯»å–ä¸€ä¸ªå¾ˆå¤§çš„æ–‡ä»¶ï¼Œåœ¨è°ƒç”¨getXX()ä¹‹åï¼Œå°±éœ€è¦ä¸€ç›´è¿›è¡Œç­‰å¾…ï¼Œè€Œå¯¼è‡´ä¸»çº¿ç¨‹å‘ç”Ÿé˜»å¡ã€‚ xmlæ–‡ä»¶åŠ è½½å®Œæ¯•åï¼ŒgetXX()ä»mMapè·å–æ•°æ®ï¼Œå°±ä¸éœ€è¦é‡æ–°è¯»å–æ–‡ä»¶ã€‚ è·å–æ•°æ®å¼‚å¸¸SPä¸­è¿›è¡Œå­˜å‚¨æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´åŒä¸€ä¸ªkeyå­˜å‚¨ä¸åŒç±»å‹çš„å€¼ï¼Œå¯¼è‡´è·å–æ•°æ®çš„æ—¶å€™æŠ›å‡ºClassCastExceptionå¼‚å¸¸ã€‚ å†™å…¥æ•°æ® å†™å…¥æ•°æ® 12345... åˆå§‹åŒ–å®Œæˆ spå¯¹è±¡SharedPreferences.Editor mEditor = sharedPreferences.edit();//å†™å…¥æ•°æ®mEditor.putString(&quot;a&quot;,&quot;c&quot;);Copy å†™å…¥æ•°æ®åŒæ ·æ”¯æŒéƒ¨åˆ†æ•°æ®ç±»å‹ã€‚ä½†æ˜¯ä¸æ˜¯é€šè¿‡SPå¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡Editorå¯¹è±¡è¿›è¡Œæ•°æ®çš„å†™å…¥ Editorå¯¹è±¡å†™å…¥æ•°æ®çš„ç›¸å…³æ“ä½œéƒ½è¦é€šè¿‡Editorï¼Œæœ¬ä½“æ˜¯ä¸€ä¸ªæ¥å£ 1234567891011121314151617//SharedPreferences.javapublic interface Editor { //æ”¾å…¥å¯¹åº”ç±»å‹çš„å¯¹è±¡ Editor putString(String key, @Nullable String value); Editor putStringSet(String key, @Nullable Set&lt;String&gt; values); Editor putInt(String key, int value); Editor putLong(String key, long value); Editor putFloat(String key, float value); Editor putBoolean(String key, boolean value); //åˆ é™¤æ•°æ® Editor remove(String key); Editor clear(); //æäº¤æ•°æ® boolean commit(); void apply();}Copy Editoråªæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒEditorImplæ‰æ˜¯å…·ä½“çš„å®ç°ç±»ã€‚ 123456789101112131415161718//SharedPreferencesImpl.java public final class EditorImpl implements Editor { private final Object mEditorLock = new Object(); @GuardedBy(&quot;mEditorLock&quot;) private final Map&lt;String, Object&gt; mModified = new HashMap&lt;&gt;(); @Override public Editor putString(String key, @Nullable String value) { //é€šè¿‡synchronizedä¿®é¥°ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ synchronized (mEditorLock) { //å­˜å…¥ä¸´æ—¶mapä¸­ï¼Œåç»­æœ‰ç”¨ mModified.put(key, value); return this; } } }Copy mModifiedä¿å­˜çš„æ˜¯ç”¨æˆ·é€šè¿‡putXX()æ–°å¢çš„æ•°æ®ï¼Œæ•°æ®æœ‰æ•ˆæœŸä½äºç¬¬ä¸€æ¬¡putXX åˆ°\u0010 commit()/apply(). æäº¤æ•°æ®ä¸Šé¢å†™å…¥æ•°æ®å®Œæ¯•åï¼Œæœ€åè¦è°ƒç”¨ä¸€æ¬¡commit()/apply()å‡†å¤‡æŠŠæ•°æ®å†™å…¥åˆ°å¯¹åº”xmlæ–‡ä»¶ä¸­ã€‚ â€œåŠåŒæ­¥â€æäº¤æ•°æ®â€”â€”commit commit 12345678910111213141516171819202122232425262728293031... åˆå§‹åŒ–å®Œæˆ spå¯¹è±¡SharedPreferences.Editor mEditor = sharedPreferences.edit();//å†™å…¥æ•°æ®mEditor.putString(&quot;a&quot;,&quot;c&quot;);//æäº¤æ•°æ®mEditor.commit();Copy//SharedPreferencesImpl.java @Override public boolean commit() { long startTime = 0; if (DEBUG) { startTime = System.currentTimeMillis(); } MemoryCommitResult mcr = commitToMemory();//å†™å…¥å†…å­˜ SharedPreferencesImpl.this.enqueueDiskWrite( mcr, null /* sync write on this thread okay */);//å†™å…¥ç£ç›˜ try { //ç­‰å¾…å†™å…¥ç£ç›˜ä»»åŠ¡æ‰§è¡Œå®Œæ¯• æ­¤å¤„å¯èƒ½å¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ mcr.writtenToDiskLatch.await(); } catch (InterruptedException e) { return false; } finally { } notifyListeners(mcr);//é€šçŸ¥ç›‘å¬ return mcr.writeToDiskResult; }Copy commit()å…ˆåè°ƒç”¨äº†commitToMemory()/*å†™å…¥æ•°æ®åˆ°mMapä¸­ï¼Œç­‰å¾…å†™å…¥ç£ç›˜*/ã€enqueueDiskWrite()/*å°†æ•°æ®å†™å…¥åˆ°ç£ç›˜ä¸­*/ï¼Œé€šè¿‡writeToFile()å†™å…¥åˆ°ç£ç›˜ä¸­å¹¶ä¼šè¿”å›å¯¹åº”å†™å…¥ç»“æœã€‚ commit()å¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹åœ¨å†™å…¥æ–‡ä»¶æ—¶ï¼Œå°±ä¼šç›´æ¥åœ¨å½“å‰çº¿ç¨‹å¼€å¯å†™å…¥ç£ç›˜ä»»åŠ¡ï¼Œå¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡(å¯èƒ½å‘ç”ŸANR)ï¼Œç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚å¦‚æœåœ¨å†™å…¥æ–‡ä»¶ï¼Œå°±ä¼šé€šè¿‡QueuedWorkå¼€å¯å¼‚æ­¥æ‰§è¡Œã€‚(è¿™å°±æ˜¯åŠåŒæ­¥çš„åŸå› ) commit()æ‰§è¡Œéƒ½æ˜¯åŒæ­¥çš„ï¼Œè€Œä¸”æ¯æ¬¡éƒ½æ˜¯å†™å…¥å…¨é‡çš„æ•°æ®ï¼Œä¼šå¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ã€‚ SharedPreferences-commit å¼‚æ­¥æäº¤æ•°æ®â€”â€”apply apply 1234567891011121314151617181920212223242526272829303132333435363738... åˆå§‹åŒ–å®Œæˆ spå¯¹è±¡SharedPreferences.Editor mEditor = sharedPreferences.edit();//å†™å…¥æ•°æ®mEditor.putString(&quot;a&quot;,&quot;c&quot;);//æäº¤æ•°æ®mEditor.apply();Copy@Overridepublic void apply() { final long startTime = System.currentTimeMillis(); final MemoryCommitResult mcr = commitToMemory();//å†™å…¥å†…å­˜ final Runnable awaitCommit = new Runnable() { @Override public void run() { try { mcr.writtenToDiskLatch.await();//ç­‰å¾…ç£ç›˜å†™å…¥ä»»åŠ¡å®Œæˆ } catch (InterruptedException ignored) { } } }; //æ·»åŠ  QueuedWorkæ‰§è¡Œå®Œæ¯•çš„å›è°ƒç›‘å¬ QueuedWork.addFinisher(awaitCommit); Runnable postWriteRunnable = new Runnable() { @Override public void run() { awaitCommit.run(); QueuedWork.removeFinisher(awaitCommit); } }; //å¼€å¯å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå†™å…¥ä»»åŠ¡ SharedPreferencesImpl.this.enqueueDiskWrite(mcr, postWriteRunnable); notifyListeners(mcr);}Copy apply()ä¹Ÿå…ˆè°ƒç”¨commitToMemory()å°†æ›´æ”¹æäº¤åˆ°å†…å­˜ï¼Œä¹‹åè°ƒç”¨enqueueDiskWriter()å¼€å¯å†™å…¥ç£ç›˜ä»»åŠ¡ã€‚ apply()æ˜¯æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± åï¼Œå°±ç›´æ¥é€šçŸ¥å†™å…¥æˆåŠŸï¼Œä¸éœ€è¦ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæˆã€‚ è™½ç„¶apply()æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä½†æ˜¯å­˜åœ¨æŸäº›åœºæ™¯ä¸‹ä¹Ÿä¼šå‘ç”ŸANRã€‚åæ–‡ä¼šåˆ†æ ç¼“å­˜å†™å…¥å†…å­˜ å†™å…¥å†…å­˜ å°†ç¼“å­˜æ–‡ä»¶å†™å…¥å†…å­˜ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465// Returns true if any changes were madeprivate MemoryCommitResult commitToMemory() { long memoryStateGeneration; List&lt;String&gt; keysModified = null; Set&lt;OnSharedPreferenceChangeListener&gt; listeners = null; Map&lt;String, Object&gt; mapToWriteToDisk; synchronized (SharedPreferencesImpl.this.mLock) { if (mDiskWritesInFlight &gt; 0) { mMap = new HashMap&lt;String, Object&gt;(mMap); } //è½¯æ‹·è´ mapToWriteToDisk = mMap; mDiskWritesInFlight++; synchronized (mEditorLock) { boolean changesMade = false; //è°ƒç”¨äº† clear() æ¸…ç†çš„æ˜¯æ‰€æœ‰æ•°æ® if (mClear) { if (!mapToWriteToDisk.isEmpty()) { changesMade = true; mapToWriteToDisk.clear(); } mClear = false; } //mModifiedçš„å€¼å†™å…¥åˆ° mapToWriteToDiskä¸­ï¼Œå‡†å¤‡å†™å…¥åˆ°æ–‡ä»¶ä¸­ for (Map.Entry&lt;String, Object&gt; e : mModified.entrySet()) { String k = e.getKey(); Object v = e.getValue(); // &quot;this&quot; is the magic value for a removal mutation. In addition, // setting a value to &quot;null&quot; for a given key is specified to be // equivalent to calling remove on that key. if (v == this || v == null) { if (!mapToWriteToDisk.containsKey(k)) { continue; } mapToWriteToDisk.remove(k); } else { if (mapToWriteToDisk.containsKey(k)) { Object existingValue = mapToWriteToDisk.get(k); if (existingValue != null &amp;&amp; existingValue.equals(v)) { continue; } } mapToWriteToDisk.put(k, v); } //å‘ç”Ÿäº†å˜åŒ– changesMade = true; } //æ‰§è¡Œå®Œæ¯•å mMapå’Œ mapToWriteToDiskå†…å®¹ä¸€è‡´ //å†™å…¥å†…å­˜åï¼Œæ¸…é™¤åŸå…ˆæœªå†™å…¥çš„æ•°æ® mModified.clear(); if (changesMade) { //å·®å¼‚è®¡æ•° +1 mCurrentMemoryStateGeneration++; } } } return new MemoryCommitResult(memoryStateGeneration, keysModified, listeners, mapToWriteToDisk);}Copy å°†mModifiedçš„å€¼å†™å…¥åˆ°mapToWriteToDiskï¼Œå…¶å®mMapä¸­ä¹Ÿæ˜¯ä¸€æ ·çš„å†…å®¹ï¼Œç„¶åæ¸…ç©ºmModifiedçš„æ•°æ®ï¼Œæ‹¼æ¥å¾—åˆ°ä¸€ä¸ªMemoryCommitResultå¯¹è±¡ï¼Œé‡Œé¢æŒæœ‰çš„å°±æ˜¯è¦å†™å…¥xmlæ–‡ä»¶çš„å†…å®¹ã€‚ å†…å­˜å†™å…¥ç£ç›˜ å†™å…¥ç£ç›˜ æŠŠå­˜å…¥å†…å­˜çš„æ•°æ®mapToWriteToDiskå†™å…¥åˆ°å¯¹åº”çš„xmlæ–‡ä»¶ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788private void enqueueDiskWrite(final MemoryCommitResult mcr, //commit() ä¼ å…¥ä¸ºnull apply() ä¼ å…¥ä¸ä¸ºnull final Runnable postWriteRunnable) { final boolean isFromSyncCommit = (postWriteRunnable == null);//commit ä¸º true applyä¸ºfalse final Runnable writeToDiskRunnable = new Runnable() { @Override public void run() { synchronized (mWritingToDiskLock) { //å†™å…¥å†…å®¹åˆ°æ–‡ä»¶ writeToFile(mcr, isFromSyncCommit); } synchronized (mLock) { mDiskWritesInFlight--; } if (postWriteRunnable != null) { //ç›´æ¥æ‰§è¡Œä¼ å…¥çš„ ä»»åŠ¡ postWriteRunnable.run(); } } }; //å½“å‰ä¸º commit() if (isFromSyncCommit) { boolean wasEmpty = false; synchronized (mLock) { //å½“å‰æ˜¯å¦åªæœ‰ä¸€ä¸ªå†™å…¥ç¡¬ç›˜çš„éœ€æ±‚ wasEmpty = mDiskWritesInFlight == 1; } if (wasEmpty) { //åªæœ‰ä¸€ä¸ªç¡¬ç›˜å†™å…¥è¯·æ±‚ï¼Œåœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ writeToDiskRunnable.run(); return; } } //å­˜åœ¨å¤šä¸ªå†™å…¥ç¡¬ç›˜è¯·æ±‚ï¼Œéƒ½è¦é€šè¿‡ QueuedWork æ‰§è¡Œå†™å…¥ä»»åŠ¡ QueuedWork.queue(writeToDiskRunnable, !isFromSyncCommit); }Copy/* * å†™å…¥æ•°æ®åˆ°ç£ç›˜ä¸­ * æŠŠå·²å­˜åœ¨çš„æ–‡ä»¶è¿›è¡Œé‡å‘½å æ·»åŠ .bakåç¼€ï¼Œä½œä¸ºå¤‡ä»½æ–‡ä»¶å­˜åœ¨ã€‚åˆ é™¤æºæ–‡ä»¶ * æ–°å»º æºæ–‡ä»¶ï¼Œé‡æ–°å†™å…¥æ‰€æœ‰æ•°æ®ï¼ŒåŒæ—¶è®°å½•å†™å…¥æ—¶é—´ * å¦‚æœå†™å…¥æ–‡ä»¶å¤±è´¥ï¼Œåˆ é™¤æ–°å»ºçš„æ–‡ä»¶ï¼Œå¹¶è¿”å›å¤±è´¥ * å¦‚æœå†™å…¥æ–‡ä»¶æˆåŠŸï¼Œåˆ é™¤å¤‡ä»½æ–‡ä»¶ï¼Œè¿”å›æˆåŠŸ */private void writeToFile(MemoryCommitResult mcr, boolean isFromSyncCommit) { //æŠŠå½“å‰æ–‡ä»¶åšä¸€ä»½å¤‡ä»½æ–‡ä»¶ if (!backupFileExists) { if (!mFile.renameTo(mBackupFile)) { Log.e(TAG, &quot;Couldn't rename file &quot; + mFile + &quot; to backup file &quot; + mBackupFile); mcr.setDiskWriteResult(false, false); return; } } else { mFile.delete(); } ... } void setDiskWriteResult(boolean wasWritten, boolean result) { this.wasWritten = wasWritten; writeToDiskResult = result; //æ¯”è¾ƒä¸¤æ¬¡è¯·æ±‚çš„ç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬å·ä¸ä¸€è‡´è¡¨ç¤ºå‘ç”Ÿäº†æ”¹å˜ if (mDiskStateGeneration &lt; mcr.memoryStateGeneration) { if (isFromSyncCommit) { needsWrite = true; } else { synchronized (mLock) { // No need to persist intermediate states. Just wait for the latest state to // be persisted. if (mCurrentMemoryStateGeneration == mcr.memoryStateGeneration) { needsWrite = true; } } } } //ç‰ˆæœ¬å·ä¸€è‡´ï¼Œå°±ä¸é‡å¤æ‰§è¡Œå†™å…¥ç£ç›˜ä»»åŠ¡ if (!needsWrite) { mcr.setDiskWriteResult(false, true); return; } //æ‰§è¡Œå®Œæ¯•ä¸€æ¬¡ä»»åŠ¡ è‡ªåŠ¨-1 writtenToDiskLatch.countDown(); }Copy å†™å…¥åˆ°xmlæ–‡ä»¶ä¹‹å‰ï¼Œä¼šæŠŠåŸæœ‰çš„æ•°æ®ä¿å­˜åœ¨.bakæ–‡ä»¶è¿›è¡Œå¤‡ä»½ï¼Œç”¨äºå†™å…¥ç£ç›˜è¿‡ç¨‹ä¸­å‘ç”Ÿä»»ä½•å¼‚å¸¸éƒ½å¯ä»¥æ¢å¤åŸæœ‰æ•°æ®ã€‚ æ ¹æ®ä¸Šè¿°æµç¨‹commit()/apply()æäº¤æ•°æ® -&gt; å†™å…¥å†…å­˜ -&gt; å†™å…¥ç¡¬ç›˜ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šèµ°ä¸€éå®Œæ•´æµç¨‹ï¼Œå¯¼è‡´é¢‘ç¹çš„IOä½¿ç”¨ã€‚ å®˜æ–¹æ›´å»ºè®®å°†æ•°æ®çš„æ›´æ–°åˆå¹¶åˆ°ä¸€æ¬¡å†™æ“ä½œä¸­ï¼Œå³å¤šæ¬¡å†™å…¥ä¸€æ¬¡æäº¤ã€‚ commitä¸applyçš„æ¯”è¾ƒ apply()æ²¡æœ‰è¿”å›å€¼ï¼Œcommit()æœ‰è¿”å›å€¼å¯ä»¥çŸ¥é“æ–‡ä»¶æ˜¯å¦å†™å…¥æˆåŠŸ apply()å°†ä¿®æ”¹æäº¤å†…å­˜ï¼Œå†å¼‚æ­¥å†™å…¥æ–‡ä»¶ï¼›commit()åŒæ­¥å†™å…¥æ–‡ä»¶ã€‚ å¹¶å‘commit()æ—¶ï¼Œéœ€è¦ç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶åæ‰ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼›apply()å…ˆæ›´æ–°åˆ°å†…å­˜ï¼Œåé¢å†æ¬¡è°ƒç”¨ä¼šè¦†ç›–åŸæœ‰çš„å†…å­˜æ•°æ®ï¼Œæ¥ä¸‹æ¥å†å¼‚æ­¥å†™å…¥æ–‡ä»¶å³å¯ã€‚ åˆ é™¤æ•°æ®12345678910111213141516171819202122232425262728293031323334SharedPreferences sp = getSharedPreferences(&quot;a&quot;,MODE_PRIVATE);SharedPreferences.Editor editor = sp.edit();//å†™å…¥æ•°æ®editor.putString(&quot;a&quot;,&quot;b&quot;);//é€šè¿‡remove æ¸…é™¤å•ä¸ªæ•°æ®editor.remove(&quot;a&quot;);//æäº¤æ•°æ®editor.commit();//æ¸…é™¤æ‰€æœ‰æ•°æ®editor.clear();editor.commit();Copy private MemoryCommitResult commitToMemory() { Map&lt;String, Object&gt; mapToWriteToDisk; ... synchronized (SharedPreferencesImpl.this.mLock) { //èµ‹å€¼åŸæœ‰æ•°æ® mapToWriteToDisk = mMap; ... synchronized (mEditorLock) { boolean changesMade = false; if (!mapToWriteToDisk.isEmpty()) { changesMade = true; //æ¸…é™¤åŸæœ‰æ•°æ® mapToWriteToDisk.clear(); } mClear = false; } } }//æœ€åå†™å…¥çš„å°±æ˜¯ä¸€ä¸ªç©ºmapï¼Œå¯¼è‡´æ‰€æœ‰å­˜å‚¨çš„æ•°æ®éƒ½è¢«æ¸…ç©ºCopy æ•°æ®æ”¹å˜ç›‘å¬SPæ”¯æŒç›‘å¬æ•°æ®çš„æ”¹å˜ï¼Œè¿”å›çš„æ˜¯ä¿®æ”¹çš„å†…å®¹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556SharedPreferences sp = getSharedPreferences(&quot;a&quot;,MODE_PRIVATE);SharedPreferences.Editor editor = sp.edit();SharedPreferences.OnSharedPreferenceChangeListener listener = new SharedPreferences.OnSharedPreferenceChangeListener() { @Override public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String key) { //æ‰“å°å‘ç”Ÿäº†æ”¹å˜çš„å€¼ } };//å¯¹åº”çš„éœ€è¦åœ¨ é¡µé¢é”€æ¯æ—¶ï¼ŒåŠæ—¶å–æ¶ˆç›‘å¬sp.unregisterOnSharedPreferenceChangeListener(listener);Copy//SharedPreferencesImpl.java public void registerOnSharedPreferenceChangeListener(OnSharedPreferenceChangeListener listener) { synchronized(mLock) { mListeners.put(listener, CONTENT); } } private MemoryCommitResult commitToMemory() { ... boolean hasListeners = mListeners.size() &gt; 0; if (hasListeners) { keysModified = new ArrayList&lt;String&gt;(); //è½¬åŒ– å»é‡ listeners = new HashSet&lt;OnSharedPreferenceChangeListener&gt;(mListeners.keySet()); } ... //ä½œä¸ºå‚æ•° ä¼ å…¥ MCR return new MemoryCommitResult(memoryStateGeneration, keysModified, listeners, mapToWriteToDisk); }//å‘ç”Ÿå˜åŒ–åé€šçŸ¥å›è°ƒ private void notifyListeners(final MemoryCommitResult mcr) { if (mcr.listeners == null || mcr.keysModified == null || mcr.keysModified.size() == 0) { return; } if (Looper.myLooper() == Looper.getMainLooper()) { //åœ¨ä¸»çº¿ç¨‹ç›´æ¥å›è°ƒ for (int i = mcr.keysModified.size() - 1; i &gt;= 0; i--) { final String key = mcr.keysModified.get(i); for (OnSharedPreferenceChangeListener listener : mcr.listeners) { if (listener != null) { listener.onSharedPreferenceChanged(SharedPreferencesImpl.this, key); } } } } else { // ä¸åœ¨ä¸»çº¿ç¨‹åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹å›è°ƒ ActivityThread.sMainThreadHandler.post(() -&gt; notifyListeners(mcr)); } }Copy commit()éœ€è¦åœ¨æ•°æ®å†™å…¥æ–‡ä»¶åï¼Œæ‰å¯ä»¥å›è°ƒåˆ°notifyListeners()é€šçŸ¥æ•°æ®å‘ç”Ÿå˜åŒ–ã€‚ apply()åªè¦æ•°æ®åœ¨å†™å…¥å†…å­˜åï¼Œå°±ä¼šç›´æ¥å›è°ƒã€‚ QueuedWork SP-QueuedWork ç³»ç»Ÿæä¾›çš„å¼‚æ­¥å·¥å…·ç±»ï¼Œå†…éƒ¨é€šè¿‡HandlerThreadä½œä¸ºå·¥ä½œçº¿ç¨‹ï¼Œç”¨äºè·Ÿè¸ªé‚£äº›æœªå®Œæˆæˆ–å°šæœªç»“æŸçš„å…¨å±€ä»»åŠ¡ã€‚ åˆå§‹åŒ–1234567891011121314private static Handler getHandler() { synchronized (sLock) { if (sHandler == null) { //æ–°å»ºHandlerThreadæ‰§è¡Œä»»åŠ¡ HandlerThread handlerThread = new HandlerThread(&quot;queued-work-looper&quot;, Process.THREAD_PRIORITY_FOREGROUND); handlerThread.start(); sHandler = new QueuedWorkHandler(handlerThread.getLooper()); } return sHandler; }}Copy queue()å‘QueuedWorkä¸­æ·»åŠ ä»»åŠ¡ 1234567891011121314public static void queue(Runnable work, boolean shouldDelay) { Handler handler = getHandler(); synchronized (sLock) { sWork.add(work); if (shouldDelay &amp;&amp; sCanDelay) { handler.sendEmptyMessageDelayed(QueuedWorkHandler.MSG_RUN, DELAY); } else { handler.sendEmptyMessage(QueuedWorkHandler.MSG_RUN); } }}Copy commit()æ—¶ï¼ŒshouldDelayä¸ºfalseï¼Œç›´æ¥å‘é€æ¶ˆæ¯ apply()æ—¶ï¼ŒshouldDelayä¸ºtrueï¼Œéœ€è¦å»¶è¿Ÿ100mså†å‘é€æ¶ˆæ¯ï¼Œé¿å…é¢‘ç¹çš„ç£ç›˜å†™å…¥æ“ä½œ addFinisher()æ·»åŠ å®Œæˆä»»åŠ¡å®Œæˆå›è°ƒ 12345678910@GuardedBy(&quot;sLock&quot;)private static final LinkedList&lt;Runnable&gt; sFinishers = new LinkedList&lt;&gt;();public static void addFinisher(Runnable finisher) { synchronized (sLock) { //å°†å®Œæˆä»»åŠ¡åçš„Runnableæ·»åŠ è¿›å»ï¼Œç­‰å¾…ä»»åŠ¡å®Œæˆåæ‰§è¡Œ sFinishers.add(finisher); }}Copy processPendingWork()æ‰§è¡Œå†™å…¥ç£ç›˜ä»»åŠ¡ 123456789101112131415161718192021private static void processPendingWork() { long startTime = 0; synchronized (sProcessingWork) { LinkedList&lt;Runnable&gt; work; synchronized (sLock) { work = (LinkedList&lt;Runnable&gt;) sWork.clone(); sWork.clear(); getHandler().removeMessages(QueuedWorkHandler.MSG_RUN); } if (work.size() &gt; 0) { for (Runnable w : work) { //æ‰§è¡Œä»»åŠ¡ w.run(); } } }}Copy QueuedWorkæ‰§è¡Œæµç¨‹ * waitToFinish()ç­‰å¾…ä»»åŠ¡å®Œæˆã€‚è¿™é‡Œä¹Ÿå°±æ˜¯ANRå‘ç”Ÿçš„æ ¹æœ¬åŸå›  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152//ä¸»çº¿ç¨‹è°ƒç”¨ public static void waitToFinish() { long startTime = System.currentTimeMillis(); boolean hadMessages = false; Handler handler = getHandler(); try { //æ‰§è¡Œæœªå®Œæˆçš„ä»»åŠ¡ processPendingWork(); } finally { StrictMode.setThreadPolicy(oldPolicy); } try { while (true) { Runnable finisher; synchronized (sLock) { finisher = sFinishers.poll();//å–å‡º ä»»åŠ¡å®Œæˆåçš„å›è°ƒ } if (finisher == null) { break; } //æ­¤å¤„ä¼šå¯¼è‡´é˜»å¡çš„å‘ç”Ÿ finisher.run();//æ‰§è¡Œ ä»»åŠ¡å®Œæˆåçš„å›è°ƒ å¯¹åº”æ‰§è¡Œçš„å°±æ˜¯ writtenToDiskLatch.await() } } finally { sCanDelay = true; } }//SharedPreferencesImpl.javaapply(){ final Runnable awaitCommit = new Runnable() { @Override public void run() { try { //éœ€è¦ç­‰å¾…ä¸»çº¿ç¨‹å†™å…¥ä»»åŠ¡å®Œæ¯• mcr.writtenToDiskLatch.await();//ç­‰å¾…ç£ç›˜å†™å…¥ä»»åŠ¡å®Œæˆ } catch (InterruptedException ignored) { } } }; //æ·»åŠ  QueuedWorkæ‰§è¡Œå®Œæ¯•çš„å›è°ƒç›‘å¬ QueuedWork.addFinisher(awaitCommit);}Copy è°ƒç”¨waitToFinish()æ—¶ï¼Œä¼šä¸»åŠ¨è°ƒç”¨processPendingWork()å»æ‰§è¡Œä»»åŠ¡ï¼Œåœ¨HandlerThreadæ‰§è¡Œå†™å…¥ç£ç›˜ä»»åŠ¡ã€‚ waitToFinish()ä¼šä¸€ç›´ç­‰å¾…å†™å…¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå…¶ä»–ä»€ä¹ˆéƒ½ä¸åšï¼Œå½“å­˜åœ¨å¾ˆå¤šå†™å…¥ä»»åŠ¡æ—¶ï¼Œä¼šä¾æ¬¡æ‰§è¡Œï¼Œæ–‡ä»¶å¾ˆå¤§æ—¶æ•ˆç‡å¾ˆä½ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´ANRã€‚ çº¿ç¨‹å®‰å…¨ çº¿ç¨‹å®‰å…¨ SPçš„çº¿ç¨‹å®‰å…¨åˆ†ä¸ºä¸¤éƒ¨åˆ†åˆ†æ è¯»çº¿ç¨‹å®‰å…¨1234567891011 @GuardedBy(&quot;mLock&quot;) private Map&lt;String, Object&gt; mMap;//é€šè¿‡æ³¨è§£çš„å½¢å¼ å‘ŠçŸ¥è¯¥å¯¹è±¡ç”±å“ªæŠŠé”æ§åˆ¶public String getString(String key, @Nullable String defValue) { synchronized (mLock) { String v = (String)mMap.get(key); return v != null ? v : defValue; }}Copy è¯»æ“ä½œä¸»è¦æ˜¯ä»mMapè¯»å–ç¼“å­˜çš„å€¼ï¼Œé¿å…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå†™æ“ä½œå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨ï¼Œé€šè¿‡mLockä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ å†™çº¿ç¨‹å®‰å…¨å†™æ“ä½œï¼Œä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼Œæ¯ä¸€æ­¥éƒ½æœ‰ä¸åŒçš„é”è¿›è¡Œæ§åˆ¶ã€‚ å†™å…¥å¯¹è±¡1234567891011@GuardedBy(&quot;mEditorLock&quot;)private final Map&lt;String, Object&gt; mModified = new HashMap&lt;&gt;();@Overridepublic Editor putString(String key, @Nullable String value) { synchronized (mEditorLock) { mModified.put(key, value); return this; }}Copy ç¬¬ä¸€æŠŠé”mEditorLockä¿è¯å†™å…¥åˆ°mModifiedçº¿ç¨‹å®‰å…¨ å†™å…¥å†…å­˜123456789101112131415synchronized (SharedPreferencesImpl.this.mLock) { //æ§åˆ¶mMapèµ‹å€¼ if (mDiskWritesInFlight &gt; 0) { mMap = new HashMap&lt;String, Object&gt;(mMap); } mapToWriteToDisk = mMap; synchronized (mEditorLock) { boolean changesMade = false; //ä¿è¯mModified ä¸ mapToWriteToDiskçš„åˆå¹¶å®‰å…¨ for (Map.Entry&lt;String, Object&gt; e : mModified.entrySet()) { mapToWriteToDisk.put(k, v); } }Copy å†™å…¥å†…å­˜æ—¶ï¼Œéœ€è¦æŠŠmModifyå¾…æ·»åŠ çš„æ•°æ®åˆå¹¶åˆ°mapToWriteToDiskä¸­ï¼Œè¿™æ—¶éœ€è¦é€šè¿‡ä¸¤æŠŠé”ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ ä¿è¯mapToWriteToDiskèµ‹å€¼æ—¶æ•°æ®æ­£ç¡® ä¿è¯mModifiedåˆå¹¶åˆ°mapToWriteToDiskæ—¶çº¿ç¨‹å®‰å…¨ å†™å…¥ç¡¬ç›˜12345//å°†mapToWriteToDiskçš„å†…å®¹å†™å…¥åˆ° xmlæ–‡ä»¶ä¸­synchronized (mWritingToDiskLock) { writeToFile(mcr, isFromSyncCommit);}Copy å†™å…¥ç¡¬ç›˜æ—¶ï¼Œä¿è¯å†™å…¥æ—¶å†…å®¹ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚ è¿›ç¨‹å®‰å…¨ è¿›ç¨‹å®‰å…¨ SharedPreferencesä¸æ˜¯è¿›ç¨‹å®‰å…¨çš„ã€‚ MODE_MULTI_PROCESS123456if ((mode &amp; Context.MODE_MULTI_PROCESS) != 0 || getApplicationInfo().targetSdkVersion &lt; android.os.Build.VERSION_CODES.HONEYCOMB) { //é‡æ–°åŠ è½½XMLæ–‡ä»¶ sp.startReloadIfChangedUnexpectedly();}Copy å”¯ä¸€çš„ä½œç”¨å°±æ˜¯ åˆ‡æ¢è¿›ç¨‹æ—¶é‡æ–°åŠ è½½XMLæ–‡ä»¶å†…å®¹ã€‚ å½“åœ¨é¢‘ç¹è·¨è¿›ç¨‹è¯»å†™æ—¶å°±ä¼šæœ‰æ•°æ®ä¸¢å¤±çš„å¯èƒ½ã€‚ ContentProvider(å®˜æ–¹æ¨è)ContentProvideræ˜¯Androidæä¾›çš„è·¨è¿›ç¨‹ç»„ä»¶ï¼Œå¯ä»¥æ›¿æ¢å…¶åº•å±‚å®ç°ä¸ºSPï¼Œæ¥ä¿è¯SPçš„è¿›ç¨‹å®‰å…¨ã€‚ //TODO å®ç°å¾…æ·»åŠ  æ–‡ä»¶é”SharedPreferences æœ¬è´¨æ˜¯å¯¹xmlæ–‡ä»¶çš„è¯»å†™ï¼Œå¯ä»¥é€šè¿‡å¯¹xmlæ–‡ä»¶æ·»åŠ æ–‡ä»¶é”ï¼Œå°±èƒ½ä¿è¯è¿›ç¨‹å®‰å…¨ã€‚ FileLock(æ–‡ä»¶é”)ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶åŒºåŸŸé”å®šæ ‡è®°ï¼Œå¯ä»¥é€šè¿‡å¯¹ä¸€ä¸ªå¯å†™æ–‡ä»¶åŠ é”ï¼Œä¿è¯åŒæ—¶åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‹¿åˆ°æ–‡ä»¶çš„é”ï¼Œè¿™ä¸ªè¿›ç¨‹å°±å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œè®¿é—®ï¼›å…¶ä»–æ‹¿ä¸åˆ°é”çš„è¿›ç¨‹è¦ä¹ˆé€‰æ‹©è¢«æŒ‚èµ·ç­‰å¾…ï¼Œè¦ä¹ˆå»åšä¸€äº›å…¶ä»–çš„äº‹æƒ…ã€‚ å¯ä»¥ä¿è¯ä¼—è¿›ç¨‹å¯ä»¥é¡ºåºè®¿é—®æ–‡ä»¶ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡FileLockè¿›è¡Œå¹¶å‘æ§åˆ¶ï¼Œä¿è¯è¿›ç¨‹çš„é¡ºåºæ‰§è¡Œã€‚ è·å–é” FileChannel.lock()ï¼šé˜»å¡ç›´è‡³è·å¾—æ–‡ä»¶é”ã€‚é»˜è®¤é”å®šæ•´ä¸ªæ–‡ä»¶ FileChannel.lock(position,size,shared)ï¼šé˜»å¡ç›´è‡³è·å–æ–‡ä»¶çš„éƒ¨åˆ†æ•°æ®çš„æ–‡ä»¶é” FileChannel.tryLock()ï¼šç«‹å³è¿”å›ï¼Œè¦ä¹ˆè¿”å›é”ï¼Œè¦ä¹ˆè¿”å›null(è·å–é”å¤±è´¥) é‡Šæ”¾é” FileLock.release()ï¼šé‡Šæ”¾å½“å‰æ–‡ä»¶é” æ£€æµ‹é” FileLock.isValid()ï¼šæ£€æµ‹æ–‡ä»¶é”çš„æœ‰æ•ˆæ€§ //TODO å®ç°å¾…æ·»åŠ  ANRåˆ†æ ANRåˆ†æ åœ¨ä¸Šé¢æœ‰æåˆ°QueuedWork.waitToFinish()æ˜¯è¦åœ¨å†™å…¥æ–‡ä»¶çš„æ“ä½œå®Œæˆåæ‰ä¼šç»“æŸï¼Œä¸”è¿™ä¸ªæ–¹æ³•ä¼šè¿è¡Œåœ¨å½“å‰çº¿ç¨‹ï¼Œææœ‰å¯èƒ½å¯¼è‡´é˜»å¡/ANRã€‚ waitToFinish()è°ƒç”¨åœºæ™¯é€šè¿‡å…¨å±€æœç´¢QueuedWork.waitToFinish()æ‰¾åˆ°åœ¨ActivityThreadä½¿ç”¨çš„è¾ƒå¤š 12345678910111213141516171819202122//ActivityThread.java public void handleStopActivity(IBinder token, boolean show, int configChanges, PendingTransactionActions pendingActions, boolean finalStateRequest, String reason) { ... if (!r.isPreHoneycomb()) { QueuedWork.waitToFinish(); } } private void handleSleeping(IBinder token, boolean sleeping) { ... if (sleeping) { if (!r.stopped &amp;&amp; !r.isPreHoneycomb()) { callActivityOnStop(r, true /* saveState */, &quot;sleeping&quot;); } // Make sure any pending writes are now committed. if (!r.isPreHoneycomb()) { QueuedWork.waitToFinish(); } }Copy ä¼šåœ¨onStop()æ—¶è°ƒç”¨QueuedWork.waitToFinish()ç­‰å¾…å½“å‰æœªæ‰§è¡Œå®Œæ¯•çš„å†™å…¥ä»»åŠ¡ç»“æŸï¼Œæ‰å¯ä»¥é‡Šæ”¾é”ã€‚æ­¤æ—¶å°±ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œå¯èƒ½å¯¼è‡´ANRã€‚ è§£å†³æ–¹æ¡ˆ åå°„åœ¨ActivityThreadä¸­çš„Hå˜é‡æ·»åŠ ä¸€ä¸ªcallbackï¼Œå¯ä»¥æ‹¦æˆªHandlerçš„äº‹ä»¶åˆ†å‘ã€‚åœ¨å‡ ä¸ªå…³é”®çš„èŠ‚ç‚¹ä¾‹å¦‚stopã€pauseåŠæ—¶é€šè¿‡åå°„æ¸…ç†QueuedWorkä¸­çš„sFinishersè¯·æ±‚ç­‰å¾…é˜Ÿåˆ—ã€‚ å¼€å¯ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹åœ¨å…¶å†…éƒ¨è°ƒç”¨commit()å»å†™å…¥æ•°æ® ä½¿ç”¨æ³¨æ„äº‹é¡¹ å»ºè®®ä¸è¦åœ¨SPé‡Œå­˜å‚¨ç‰¹åˆ«å¤§çš„key/value,å› ä¸ºå†…å®¹éƒ½æ˜¯ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¿‡å¤§ä¼šå¯¼è‡´å¡é¡¿/ANRã€‚ ä¸è¦é¢‘ç¹è°ƒç”¨commit()/apply()ï¼ŒSPçš„æ•°æ®æ¯æ¬¡éƒ½æ˜¯å…¨é‡å†™å…¥æ–‡ä»¶ï¼Œå°¤å…¶æ˜¯commit()ç›´æ¥åŒæ­¥æ“ä½œï¼Œæ›´å®¹æ˜“å¡é¡¿ã€‚å»ºè®®æ‰¹é‡å†™ä¸€æ¬¡æäº¤ MODE_MULTI_PROCESSæ˜¯åœ¨æ¯æ¬¡getSharedPreferencesæ—¶æ£€æŸ¥ç£ç›˜ä¸Šé…ç½®æ–‡ä»¶ä¸Šæ¬¡ä¿®æ”¹æ—¶é—´å’Œæ–‡ä»¶å¤§å°ï¼Œä¸€æ—¦æ‰€æœ‰ä¿®æ”¹åˆ™ä¼šé‡æ–°ä»ç£ç›˜åŠ è½½æ–‡ä»¶ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ä¿è¯å¤šè¿›ç¨‹æ•°æ®çš„å®æ—¶åŒæ­¥ã€‚ é«˜é¢‘å†™æ“ä½œçš„keyä¸é«˜é¢‘è¯»æ“ä½œçš„keyå¯ä»¥é€‚å½“çš„æ‹†åˆ†æ–‡ä»¶ï¼Œå‡å°‘åŒæ­¥é”çš„ç«äº‰ã€‚ æœ€å¥½å†™å…¥è½»é‡çº§çš„æ•°æ®ï¼Œä¸è¦å­˜å‚¨å¤§é‡çš„æ•°æ®ã€‚ æ›¿æ¢æ–¹æ¡ˆMMKV é€šè¿‡mmapå†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œæä¾›ä¸€æ®µå¯éšæ—¶å†™å…¥çš„å†…å­˜å—ï¼ŒAPPåªç®¡å¾€é‡Œå†™æ•°æ®ï¼Œç”±æ“ä½œç³»ç»Ÿè´Ÿè´£å°†å†…å­˜å›å†™åˆ°æ–‡ä»¶ï¼Œè€Œä¸å¿…æ‹…å¿ƒCrashå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ å†™å…¥çš„æ•°æ®æ ¼å¼ä¸º Protobuf Github-MMKV MMKVåŸç† MMKV for Android å¤šè¿›ç¨‹è®¾è®¡ä¸å®ç° å‚è€ƒé“¾æ¥å…¨é¢è§£æSharedPReferences SharedPreferencesçš„è®¾è®¡ä¸å®ç° Jetpack DataStore åˆ†æ å‰–æ SharedPreference apply å¼•èµ·çš„ ANR é—®é¢˜ Android æºç ä»“åº“","link":"/2021/11/15/SharePreference/"},{"title":"Tools","text":"AOSPAndroid ä»£ç æœç´¢ ( cs.android.com ) ä»£ç æœç´¢æ–‡æ¡£ã€‚ ClipBoardDownload the application apk and manually install application on your android device. 12# am broadcast -a clipper.set -e text &quot;this can be pasted now&quot;# am broadcast -a clipper.get BookMarkProcessOn è¯­æ³• API Levels | Android versions, SDK/API levels, version codes, codenames, and cumulative usage QRCodeç”Ÿæˆ Androidå†…å­˜åˆ†æå‘½ä»¤ - Gityuanåšå®¢ | è¢è¾‰è¾‰çš„æŠ€æœ¯åšå®¢ Color Converter - RGB, HEX, HSL, ARGB, RGBA Unix Time Stamp - Epoch Converter Time æ´›æ‰çŸ¶: 01:04 chatGpt-New chat Watching TechPlatformè½¯ä»¶åŒ…åˆ—è¡¨Linuxå‘½ä»¤å¤§å…¨(æ‰‹å†Œ) â€“ çœŸæ­£å¥½ç”¨çš„Linuxå‘½ä»¤åœ¨çº¿æŸ¥è¯¢ç½‘ç«™Learning the shell - Lesson 1: What is the shell?å­—èŠ‚è·³åŠ¨æŠ€æœ¯å›¢é˜Ÿ çš„å›¢é˜Ÿä¸»é¡µInfoQ - ä¿ƒè¿›è½¯ä»¶å¼€å‘åŠç›¸å…³é¢†åŸŸçŸ¥è¯†ä¸åˆ›æ–°çš„ä¼ æ’­-æå®¢é‚¦æå®¢æ—¶é—´-è½»æ¾å­¦ä¹ ï¼Œé«˜æ•ˆå­¦ä¹ -æå®¢é‚¦ Inputç³»ç»Ÿâ€”ANRåŸç†åˆ†æ - Gityuanåšå®¢ | è¢è¾‰è¾‰çš„æŠ€æœ¯åšå®¢ å¾®ä¿¡Androidå®¢æˆ·ç«¯çš„ANRç›‘æ§æ–¹æ¡ˆ ä»Šæ—¥å¤´æ¡ ANR ä¼˜åŒ–å®è·µç³»åˆ— - è®¾è®¡åŸç†åŠå½±å“å› ç´  æ·±å…¥ç†è§£ Android ANR è§¦å‘åŸç†ä»¥åŠä¿¡æ¯æ”¶é›†è¿‡ç¨‹ - huansky - åšå®¢å›­ ä¸€æ–‡è¯»æ‡‚ç›´æ’­å¡é¡¿ä¼˜åŒ–é‚£äº›äº‹å„¿ - æ˜é‡‘ ä¸€æ–‡è¯»æ‡‚ Android FFmpeg è§†é¢‘è§£ç è¿‡ç¨‹ä¸å®æˆ˜åˆ†æ - æ˜é‡‘ btrace å¼€æºï¼åŸºäº Systrace é«˜æ€§èƒ½ Trace å·¥å…· - æ˜é‡‘ æ·±å…¥å‰–æè™šæ‹Ÿå†…å­˜å·¥ä½œåŸç† - äº‘+ç¤¾åŒº - è…¾è®¯äº‘ OutOfMemoryError å¯ä»¥è¢« try catch å—ï¼Ÿ - æ˜é‡‘ Androidé«˜æ€§èƒ½é«˜ç¨³å®šæ€§ä»£ç è¦†ç›–ç‡æ–¹æ¡ˆæ¢ç´¢å®è·µ - ATA word list 1_å“”å“©å“”å“©_bilibili é¢å‘è´¡çŒ®è€…çš„ AOSP ä»£ç æ ·å¼æŒ‡å— | Android å¼€æºé¡¹ç›® | Android Open Source Project Docdoc Articles technology Other","link":"/2023/03/14/Tools/"},{"title":"ThreadPool","text":"https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html 12345678910111213141516171819202122232425262728293031323334/** * Creates a new {@code ThreadPoolExecutor} with the given initial * parameters. * * @param corePoolSize the number of threads to keep in the pool, even * if they are idle, unless {@code allowCoreThreadTimeOut} is set * æ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼Œçº¿ç¨‹å¸¸é©»å³ä½¿ç©ºé—²ï¼Œé™¤éè®¾ç½®äº†allowCoreThreadTimeOut * @param maximumPoolSize the maximum number of threads to allow in the * pool * æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ•´ä¸ªçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•°+æ™®é€šçº¿ç¨‹æ•°ï¼‰ * @param keepAliveTime when the number of threads is greater than * the core, this is the maximum time that excess idle threads * will wait for new tasks before terminating. * è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°åçš„ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ * @param unit the time unit for the {@code keepAliveTime} argument * æ—¶é—´å•ä½ * @param workQueue the queue to use for holding tasks before they are * executed. This queue will hold only the {@code Runnable} * tasks submitted by the {@code execute} method. * å·¥ä½œé˜Ÿåˆ—ï¼šä»»åŠ¡è¢«æ‰§è¡Œå‰çš„å­˜æ”¾é˜Ÿåˆ— * @param threadFactory the factory to use when the executor * creates a new thread * executoråˆ›å»ºçº¿ç¨‹çš„å·¥å‚ * @param handler the handler to use when execution is blocked * because the thread bounds and queue capacities are reached * ... */public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) é€šè¿‡Executorså·¥å…·ç±»å¯ä»¥åˆ›å»ºå¤šç§ç±»å‹çš„çº¿ç¨‹æ± ï¼ŒåŒ…æ‹¬ï¼š FixedThreadPoolï¼šå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚è¯¥çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å§‹ç»ˆä¸å˜ã€‚å½“æœ‰ä¸€ä¸ªæ–°çš„ä»»åŠ¡æäº¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸­è‹¥æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ç«‹å³æ‰§è¡Œã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ–°çš„ä»»åŠ¡ä¼šè¢«æš‚å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…æœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¾¿å¤„ç†åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºnï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸ºnï¼Œä»»åŠ¡é˜Ÿåˆ—é•¿åº¦ä¸ºInterger.MAX_VALUEçš„LinkedBlockingQueue SingleThreadExecutorï¼š åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚è‹¥å¤šä½™ä¸€ä¸ªä»»åŠ¡è¢«æäº¤åˆ°è¯¥çº¿ç¨‹æ± ï¼Œä»»åŠ¡ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…çº¿ç¨‹ç©ºé—²ï¼ŒæŒ‰å…ˆå…¥å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚æ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°éƒ½ä¸º1ï¼Œä»»åŠ¡é˜Ÿåˆ—é•¿åº¦ä¸ºInterger.MAX_VALUEçš„LinkedBlockingQueue CachedThreadPoolï¼š å¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´çº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ä¸ç¡®å®šï¼Œä½†è‹¥æœ‰ç©ºé—²çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œåˆ™ä¼šä¼˜å…ˆä½¿ç”¨å¯å¤ç”¨çš„çº¿ç¨‹ã€‚è‹¥æ‰€æœ‰çº¿ç¨‹å‡åœ¨å·¥ä½œï¼Œåˆæœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚æ‰€æœ‰çº¿ç¨‹åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå°†è¿”å›çº¿ç¨‹æ± è¿›è¡Œå¤ç”¨ã€‚æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸ºInterger.MAX_VAULEï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸ºæ— å®¹é‡çš„SynchronousQueue ScheduledThreadPoolï¼šç»™å®šçš„å»¶è¿Ÿåè¿è¡Œä»»åŠ¡æˆ–è€…å®šæœŸæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± ã€‚æ ¸å¿ƒçº¿ç¨‹ä¸ºnï¼Œæœ€å¤§çº¿ç¨‹ä¸ºInterger.MAX_VALUEï¼Œä»»åŠ¡é˜Ÿåˆ—é•¿åº¦ä¸ºæœ€å¤§Interger_MAX_VALUEçš„DelayQueue ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­å¼ºåˆ¶çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor æ„é€ å‡½æ•°çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™© Executors è¿”å›çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š FixedThreadPool å’Œ SingleThreadExecutor:ä½¿ç”¨çš„æ˜¯æ— ç•Œçš„ LinkedBlockingQueueï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º Integer.MAX_VALUE,å¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚ CachedThreadPool:ä½¿ç”¨çš„æ˜¯åŒæ­¥é˜Ÿåˆ— SynchronousQueue, å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º Integer.MAX_VALUE ï¼Œå¦‚æœä»»åŠ¡æ•°é‡è¿‡å¤šä¸”æ‰§è¡Œé€Ÿåº¦è¾ƒæ…¢ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚ ScheduledThreadPool å’Œ SingleThreadScheduledExecutor:ä½¿ç”¨çš„æ— ç•Œçš„å»¶è¿Ÿé˜»å¡é˜Ÿåˆ—DelayedWorkQueueï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º Integer.MAX_VALUE,å¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚ ThreadPoolExecutorä½¿ç”¨è¯¦è§£å…¶å®javaçº¿ç¨‹æ± çš„å®ç°åŸç†å¾ˆç®€å•ï¼Œè¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹é›†åˆworkerSetå’Œä¸€ä¸ªé˜»å¡é˜Ÿåˆ—workQueueã€‚å½“ç”¨æˆ·å‘çº¿ç¨‹æ± æäº¤ä¸€ä¸ªä»»åŠ¡(ä¹Ÿå°±æ˜¯çº¿ç¨‹)æ—¶ï¼Œçº¿ç¨‹æ± ä¼šå…ˆå°†ä»»åŠ¡æ”¾å…¥workQueueä¸­ã€‚workerSetä¸­çš„çº¿ç¨‹ä¼šä¸æ–­çš„ä»workQueueä¸­è·å–çº¿ç¨‹ç„¶åæ‰§è¡Œã€‚å½“workQueueä¸­æ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼Œworkerå°±ä¼šé˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡äº†å°±å–å‡ºæ¥ç»§ç»­æ‰§è¡Œã€‚ # ExecuteåŸç†https://excalidraw.com/#json=Y7a8uMRrIrZNGfr7GnQ0M,2qUB-ZmXM-hwP0a3MWnA1A å½“ä¸€ä¸ªä»»åŠ¡æäº¤è‡³çº¿ç¨‹æ± ä¹‹å: çº¿ç¨‹æ± é¦–å…ˆå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦å°‘äºcorePoolSizeã€‚å¦‚æœæ˜¯ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœéƒ½åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™è¿›å…¥2. åˆ¤æ–­BlockingQueueæ˜¯å¦å·²ç»æ»¡äº†ï¼Œå€˜è‹¥è¿˜æ²¡æœ‰æ»¡ï¼Œåˆ™å°†çº¿ç¨‹æ”¾å…¥BlockingQueueã€‚å¦åˆ™è¿›å…¥3. å¦‚æœåˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹å°†ä½¿å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¶…è¿‡maximumPoolSizeï¼Œåˆ™äº¤ç»™RejectedExecutionHandleræ¥å¤„ç†ä»»åŠ¡ã€‚ è¿è¡Œæœºåˆ¶ï¼ˆå½“ä»»åŠ¡æ¥äº†ä¹‹åçš„æ‰§è¡Œæµç¨‹ï¼‰ï¼š åˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯å¦å·²æ»¡ï¼›å¦‚æœæœªæ»¡åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼›å¦‚æœæ»¡äº†æ‰§è¡Œåç»­æ“ä½œã€‚ åˆ¤æ–­ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼›å¦‚æœæœªæ»¡å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ï¼›å¦‚æœæ»¡äº†æ‰§è¡Œåç»­æµç¨‹ã€‚ åˆ¤æ–­æœ€å¤§çº¿ç¨‹æ•°æ˜¯å¦å·²æ»¡ï¼›å¦‚æœæœªæ»¡åˆ›å»ºä¸´æ—¶çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼›å¦‚æœæ»¡äº†æ‰§è¡Œåç»­æµç¨‹ã€‚ æ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼ˆå†…ç½®4ç§æ‹’ç»ç­–ç•¥+è‡ªå®šä¹‰çš„æ‹’ç»ç­–ç•¥ï¼‰ã€‚ å½“ThreadPoolExecutoråˆ›å»ºæ–°çº¿ç¨‹æ—¶ï¼Œé€šè¿‡CASæ¥æ›´æ–°çº¿ç¨‹æ± çš„çŠ¶æ€ctl. # å‚æ•°123456public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, RejectedExecutionHandler handler) corePoolSize çº¿ç¨‹æ± ä¸­çš„æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå½“æäº¤ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹æ•°ç­‰äºcorePoolSize, å³ä½¿æœ‰å…¶ä»–ç©ºé—²çº¿ç¨‹èƒ½å¤Ÿæ‰§è¡Œæ–°æ¥çš„ä»»åŠ¡, ä¹Ÿä¼šç»§ç»­åˆ›å»ºçº¿ç¨‹ï¼›å¦‚æœå½“å‰çº¿ç¨‹æ•°ä¸ºcorePoolSizeï¼Œç»§ç»­æäº¤çš„ä»»åŠ¡è¢«ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è¢«æ‰§è¡Œï¼›å¦‚æœæ‰§è¡Œäº†çº¿ç¨‹æ± çš„prestartAllCoreThreads()æ–¹æ³•ï¼Œçº¿ç¨‹æ± ä¼šæå‰åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹ã€‚ workQueue ç”¨æ¥ä¿å­˜ç­‰å¾…è¢«æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—. åœ¨JDKä¸­æä¾›äº†å¦‚ä¸‹é˜»å¡é˜Ÿåˆ—: å…·ä½“å¯ä»¥å‚è€ƒJUC é›†åˆ: BlockQueueè¯¦è§£ ArrayBlockingQueue: åŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰FIFOæ’åºä»»åŠ¡ï¼› LinkedBlockingQueue: åŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰FIFOæ’åºä»»åŠ¡ï¼Œååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueueï¼› SynchronousQueue: ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œååé‡é€šå¸¸è¦é«˜äºLinkedBlockingQueueï¼› PriorityBlockingQueue: å…·æœ‰ä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼› LinkedBlockingQueueæ¯”ArrayBlockingQueueåœ¨æ’å…¥åˆ é™¤èŠ‚ç‚¹æ€§èƒ½æ–¹é¢æ›´ä¼˜ï¼Œä½†æ˜¯äºŒè€…åœ¨put(), take()ä»»åŠ¡çš„æ—¶å‡éœ€è¦åŠ é”ï¼ŒSynchronousQueueä½¿ç”¨æ— é”ç®—æ³•ï¼Œæ ¹æ®èŠ‚ç‚¹çš„çŠ¶æ€åˆ¤æ–­æ‰§è¡Œï¼Œè€Œä¸éœ€è¦ç”¨åˆ°é”ï¼Œå…¶æ ¸å¿ƒæ˜¯Transfer.transfer(). maximumPoolSize çº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚å¦‚æœå½“å‰é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”ç»§ç»­æäº¤ä»»åŠ¡ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå‰ææ˜¯å½“å‰çº¿ç¨‹æ•°å°äºmaximumPoolSizeï¼›å½“é˜»å¡é˜Ÿåˆ—æ˜¯æ— ç•Œé˜Ÿåˆ—, åˆ™maximumPoolSizeåˆ™ä¸èµ·ä½œç”¨, å› ä¸ºæ— æ³•æäº¤è‡³æ ¸å¿ƒçº¿ç¨‹æ± çš„çº¿ç¨‹ä¼šä¸€ç›´æŒç»­åœ°æ”¾å…¥workQueue. keepAliveTime çº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´ï¼Œå³å½“çº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œè¯¥çº¿ç¨‹ç»§ç»­å­˜æ´»çš„æ—¶é—´ï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å‚æ•°åªåœ¨çº¿ç¨‹æ•°å¤§äºcorePoolSizeæ—¶æ‰æœ‰ç”¨, è¶…è¿‡è¿™ä¸ªæ—¶é—´çš„ç©ºé—²çº¿ç¨‹å°†è¢«ç»ˆæ­¢ï¼› unit keepAliveTimeçš„å•ä½ threadFactory åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ï¼Œé€šè¿‡è‡ªå®šä¹‰çš„çº¿ç¨‹å·¥å‚å¯ä»¥ç»™æ¯ä¸ªæ–°å»ºçš„çº¿ç¨‹è®¾ç½®ä¸€ä¸ªå…·æœ‰è¯†åˆ«åº¦çš„çº¿ç¨‹åã€‚é»˜è®¤ä¸ºDefaultThreadFactory handler çº¿ç¨‹æ± çš„é¥±å’Œç­–ç•¥ï¼Œå½“é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”æ²¡æœ‰ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœç»§ç»­æäº¤ä»»åŠ¡ï¼Œå¿…é¡»é‡‡å–ä¸€ç§ç­–ç•¥å¤„ç†è¯¥ä»»åŠ¡ï¼Œçº¿ç¨‹æ± æä¾›äº†4ç§ç­–ç•¥: AbortPolicy: ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé»˜è®¤ç­–ç•¥ï¼› CallerRunsPolicy: ç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼› DiscardOldestPolicy: ä¸¢å¼ƒé˜»å¡é˜Ÿåˆ—ä¸­é æœ€å‰çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ï¼› DiscardPolicy: ç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼› å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®åº”ç”¨åœºæ™¯å®ç°RejectedExecutionHandleræ¥å£ï¼Œè‡ªå®šä¹‰é¥±å’Œç­–ç•¥ï¼Œå¦‚è®°å½•æ—¥å¿—æˆ–æŒä¹…åŒ–å­˜å‚¨ä¸èƒ½å¤„ç†çš„ä»»åŠ¡ã€‚ â€»çº¿ç¨‹æ± ThreadPoolExecutorå¸¸è§çš„çº¿ç¨‹æ± æœ‰ï¼šæ— ç¼“å­˜çº¿ç¨‹Â· å®šé•¿çº¿ç¨‹æ± ï¼ˆæœ€å¸¸è§ï¼Œå¦‚Glideï¼‰FixedThreadPoolï¼šæ ¹æ®å…¥å‚å†³å®šæœ‰å¤šå°‘ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼Œæ— ç¼“å­˜çº¿ç¨‹ã€‚ å¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± ã€‚ï¼ˆé€‚ç”¨äºè´Ÿè½½æ¯”è¾ƒé‡çš„æœåŠ¡å™¨ï¼‰ FixedThreadPoolä½¿ç”¨æ— ç•Œé˜Ÿåˆ—LinkedBlockingQueueä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ï¼Œè¯¥çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å§‹ç»ˆä¸å˜ã€‚å½“æœ‰ä¸€ä¸ªæ–°çš„ä»»åŠ¡æäº¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸­è‹¥æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ç«‹å³æ‰§è¡Œã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ–°çš„ä»»åŠ¡ä¼šè¢«æš‚å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…æœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¾¿å¤„ç†åœ¨ä»»åŠ¡é˜Ÿåˆ— ä¸­çš„ä»»åŠ¡ã€‚ Â· å•çº¿ç¨‹çº¿ç¨‹æ± SingleThreadExecutorï¼šåªæœ‰ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼Œæœ€å¤§çº¿ç¨‹ä¹Ÿä¸º1ï¼Œæ— ç¼“å­˜çº¿ç¨‹ã€‚æ‰€æœ‰ä»»åŠ¡åœ¨æ­¤çº¿ç¨‹ä¸­FIFOè¿›è¡Œåªä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚ï¼ˆé€‚ç”¨äºéœ€è¦ä¿è¯é¡ºåºæ‰§è¡Œå„ä¸ªä»» åŠ¡ï¼›å¹¶ä¸”åœ¨ä»»æ„æ—¶é—´ç‚¹ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹æ´»åŠ¨çš„åœºæ™¯ã€‚ï¼‰ SingleThreadExecutorlä¹Ÿä½¿ç”¨æ— ç•Œé˜Ÿåˆ—LinkedBlockingQueueä½œä¸ºå·¥ä½œé˜Ÿåˆ— è‹¥å¤šä½™ä¸€ä¸ªä»»åŠ¡è¢«æäº¤åˆ°è¯¥çº¿ç¨‹æ± ï¼Œä»»åŠ¡ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…çº¿ç¨‹ç©ºé—²ï¼ŒæŒ‰å…ˆå…¥å…ˆ å‡ºçš„é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚ Â· å®šæ—¶çº¿ç¨‹æ± ScheduledThreadPoolï¼šåªæœ‰å…¥å‚æ•°é‡çš„æ ¸å¿ƒçº¿ç¨‹ï¼Œæ— ç¼“å­˜çº¿ç¨‹ã€‚ç»§æ‰¿è‡ªThreadPoolExecutorã€‚å®ƒä¸»è¦ç”¨æ¥åœ¨ç»™å®šçš„å»¶è¿Ÿä¹‹åè¿è¡Œ ä»»åŠ¡ï¼Œæˆ–è€…å®šæœŸæ‰§è¡Œä»»åŠ¡ã€‚ä½¿ç”¨DelayQueueä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ã€‚å¦‚newScheduledThreadPoolï¼Œç”¨äºå®šæ—¶ä»»åŠ¡ã€‚ æ— æ ¸å¿ƒçº¿ç¨‹Â· ç¼“å­˜çº¿ç¨‹æ± CachedThreadPoolï¼šæ— æ ¸å¿ƒçº¿ç¨‹ï¼Œæ— é™åˆ¶åœ°å¢åŠ æ‰§è¡Œå®Œæˆå°±é”€æ¯(æ ¹æ®keepaliveTimeå†³å®š)çš„ç¼“å­˜çº¿ç¨‹ï¼Œæ˜¯ä¸€ä¸ªä¼šæ ¹æ®éœ€è¦è°ƒæ•´çº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚ï¼ˆå¤§å°æ— ç•Œï¼Œé€‚ç”¨äºæ‰§è¡Œå¾ˆ å¤šçš„çŸ­æœŸå¼‚æ­¥ä»»åŠ¡çš„å°ç¨‹åºï¼Œæˆ–è´Ÿè½½è¾ƒè½»çš„æœåŠ¡å™¨ï¼‰ CachedThreadPoolä½¿ç”¨æ²¡æœ‰å®¹é‡çš„SynchronousQueueä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ï¼Œä½† CachedThreadPoolçš„maximumPoolæ˜¯æ— ç•Œçš„ã€‚çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ä¸ç¡®å®šï¼Œä½†è‹¥æœ‰ç©ºé—²çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œåˆ™ä¼šä¼˜å…ˆä½¿ç”¨å¯å¤ç”¨çš„çº¿ç¨‹ã€‚è‹¥æ‰€æœ‰çº¿ ç¨‹å‡åœ¨å·¥ä½œï¼Œåˆæœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚æ‰€æœ‰çº¿ç¨‹åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯• åï¼Œå°†è¿”å›çº¿ç¨‹æ± è¿›è¡Œå¤ç”¨ã€‚ ä½œç”¨ é™ä½èµ„æºæ¶ˆè€—ï¼šé€šè¿‡é‡å¤åˆ©ç”¨ç°æœ‰çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œé¿å…å¤šæ¬¡åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ã€‚ä¸€ä¸ªçº¿ç¨‹ä¿ç•™1Må¤§å°çš„å†…å­˜ç©ºé—´ï¼Œæœ‰æ•ˆé™ä½OOM æé«˜ç›¸åº”é€Ÿåº¦ï¼šå› ä¸ºçœå»äº†åˆ›å»ºçº¿ç¨‹è¿™ä¸ªæ­¥éª¤ï¼Œæ‰€ä»¥åœ¨æ‹¿åˆ°ä»»åŠ¡æ—¶ï¼Œå¯ä»¥ç«‹åˆ»å¼€å§‹æ‰§è¡Œã€‚ çº¿ç¨‹æ•°åº”è¯¥æ€ä¹ˆè®¾ç½® å¦‚æœä»»åŠ¡æ˜¯IOå¯†é›†å‹ï¼Œä¸€èˆ¬çº¿ç¨‹æ•°éœ€è¦è®¾ç½®2å€CPUæ•°ä»¥ä¸Šï¼ˆ2Nï¼‰ï¼Œä»¥æ­¤æ¥å°½é‡åˆ©ç”¨CPUèµ„æºã€‚ å¦‚æœä»»åŠ¡æ˜¯CPUå¯†é›†å‹ï¼Œä¸€èˆ¬çº¿ç¨‹æ•°é‡åªéœ€è¦è®¾ç½®CPUæ•°åŠ 1å³å¯ï¼Œæ›´å¤šçš„çº¿ç¨‹æ•°ä¹Ÿåªèƒ½å¢åŠ ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¸èƒ½å¢åŠ CPUåˆ©ç”¨ç‡ã€‚ åœ¨è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¸­ï¼Œå°†çº¿ç¨‹æ± å¤§å°è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•° + 1 çš„åŸå› æ˜¯ä¸ºäº†åº”å¯¹å¯èƒ½å‡ºç°çš„é˜»å¡æƒ…å†µã€‚ è™½ç„¶è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¸»è¦æ¶ˆè€— CPU èµ„æºï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä»»åŠ¡å†…éƒ¨å¯èƒ½ä»ç„¶å­˜åœ¨ä¸€äº›é˜»å¡æ“ä½œï¼Œ ä¾‹å¦‚ï¼šåŒæ­¥ IOï¼š å¦‚æœä»»åŠ¡éœ€è¦è¿›è¡Œç£ç›˜è¯»å†™æˆ–ç½‘ç»œé€šä¿¡ç­‰ IO æ“ä½œï¼Œå¹¶ä¸”è¿™äº›æ“ä½œæ˜¯åŒæ­¥é˜»å¡çš„ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œ æ— æ³•ç»§ç»­æ‰§è¡Œè®¡ç®—ä»»åŠ¡ã€‚é”ç«äº‰ï¼š å¦‚æœä»»åŠ¡ä¸­å­˜åœ¨å¯¹å…±äº«èµ„æºçš„è®¿é—®ï¼Œå¹¶ä¸”ä½¿ç”¨äº†é”æœºåˆ¶è¿›è¡ŒåŒæ­¥ï¼Œ é‚£ä¹ˆå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰é”æ—¶ï¼Œ éƒ¨åˆ†çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œ ç­‰å¾…è·å–é”ã€‚é¡µé¢é”™è¯¯ï¼š å½“çº¿ç¨‹è®¿é—®çš„å†…å­˜é¡µé¢ä¸åœ¨ç‰©ç†å†…å­˜ä¸­æ—¶ï¼Œä¼šå‘ç”Ÿé¡µé¢é”™è¯¯ï¼Œ å¯¼è‡´çº¿ç¨‹è¢«é˜»å¡ï¼Œ ç­‰å¾…æ“ä½œç³»ç»Ÿå°†é¡µé¢ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ã€‚ å¦‚æœçº¿ç¨‹æ± å¤§å°åˆšå¥½ç­‰äº CPU æ ¸å¿ƒæ•°ï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªçº¿ç¨‹è¢«é˜»å¡æ—¶ï¼ŒCPU å°±æ— æ³•å……åˆ†åˆ©ç”¨ï¼Œå¯¼è‡´æ•´ä½“æ€§èƒ½ä¸‹é™ã€‚ è€Œå¢åŠ ä¸€ä¸ªé¢å¤–çš„çº¿ç¨‹ï¼Œå¯ä»¥ç¡®ä¿åœ¨æŸä¸ªçº¿ç¨‹è¢«é˜»å¡æ—¶ï¼Œ ä»ç„¶æœ‰è¶³å¤Ÿçš„çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œè®¡ç®—ä»»åŠ¡ï¼Œ ä»è€Œæé«˜ CPU åˆ©ç”¨ç‡å’Œæ•´ä½“æ€§èƒ½ã€‚ å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç»éªŒæ³•åˆ™ï¼Œå¹¶ä¸æ˜¯ç»å¯¹çš„ã€‚ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ å¦‚æœä»»åŠ¡ä¸­ä¸å­˜åœ¨é˜»å¡æ“ä½œï¼Œ æˆ–è€…é˜»å¡æƒ…å†µéå¸¸å°‘è§ï¼Œ é‚£ä¹ˆå°†çº¿ç¨‹æ± å¤§å°è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°ä¹Ÿå¯èƒ½è¶³å¤Ÿã€‚ æœ€ä½³çš„çº¿ç¨‹æ± å¤§å°ä»ç„¶éœ€è¦æ ¹æ®ä½ çš„å…·ä½“åº”ç”¨åœºæ™¯å’Œç¡¬ä»¶ç¯å¢ƒè¿›è¡Œè°ƒæ•´å’Œæµ‹è¯•ã€‚ ç®€å•æ¥è¯´å°±æ˜¯ ioå¤šï¼Œåˆ™ç”¨æ›´å¤šçº¿ç¨‹å……åˆ†åˆ©ç”¨cpuï¼›è®¡ç®—å¤šï¼Œåˆ™ç”¨å°‘çš„çº¿ç¨‹æ•°å‡å°‘çº¿ç¨‹åˆ‡æ¢ï¼Œä½†ä»å­˜åœ¨çš„ioæ“ä½œä½¿æ•°é‡åº”ä¸ºn+1; Androidä¸€èˆ¬è®¤ä¸ºå¤šæ•°æ“ä½œæ˜¯IOå¯†é›†ï¼Œå¦‚ç½‘ç»œioï¼Œæœ¬åœ°æ–‡ä»¶ioï¼Œæ‰€ä»¥ä¼šè®¾ç½®2N Androidç³»ç»Ÿå¯¹æ¯ä¸ªè¿›ç¨‹çº¿ç¨‹æ•°é™åˆ¶root ä¸‹adb shell cat /proc/sys/kernel/threads-max ç»“æœå¦‚ï¼š57439 ä½†æ¯ä¸ªçº¿ç¨‹1Må·¦å³ï¼ŒåŸºæœ¬ä¸Šå‡ ç™¾ä¸ªçº¿ç¨‹å°±å¯èƒ½OOMäº† å¸¸è§çš„ä¸‰æ–¹åº“çº¿ç¨‹æ± é»˜è®¤æ•°é‡OkhttpOkHttpä¸­çš„çº¿ç¨‹æ± æ˜¯å®šä¹‰åœ¨åˆ†å‘å™¨ä¸­çš„ï¼Œå³å®šä¹‰åœ¨Dispatcher 1234567public synchronized ExecutorService executorService() { if (executorService == null) { executorService = new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60, TimeUnit.SECONDS, new SynchronousQueue&lt;&gt;(), Util.threadFactory(&quot;OkHttp Dispatcher&quot;, false)); } return executorService;} ç”¨çš„å…¶å®ç›¸å½“äºå°±æ˜¯ä¸€ä¸ªæ— æ ¸å¿ƒçº¿ç¨‹ï¼Œæœ€å¤§çº¿ç¨‹æ± ä¸ºInteger.MAX_VALUEï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸ºSynchronousQueueçš„ç¼“å­˜çº¿ç¨‹æ±  é«˜å¹¶å‘ï¼Œæœ€å¤§ååé‡ã€‚SynchronousQueueé˜Ÿåˆ—æ˜¯æ— å®¹é‡é˜Ÿåˆ—ï¼Œ åœ¨OkHttpä¸­ï¼Œé…ç½®çš„çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸ºInteger.MAX_VALUEï¼Œçº¿ç¨‹çš„å­˜æ´»æ—¶é—´ä¸º60sï¼Œé‡‡ç”¨çš„é˜Ÿåˆ—æ˜¯SynchronousQueueã€‚ okhttp é»˜è®¤åŒæ—¶æ”¯æŒ 64 ä¸ªå¼‚æ­¥è¯·æ±‚(ä¸è€ƒè™‘åŒæ­¥è¯·æ±‚)ï¼Œä¸€ä¸ª host åŒæ—¶æœ€å¤šè¯·æ±‚ 5 ä¸ª okhttp å†…éƒ¨çš„çº¿ç¨‹æ± éƒ½æ˜¯ CacheThreadPoolï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 0ï¼Œéæ ¸å¿ƒçº¿ç¨‹æ•°æ— é™ï¼Œæ°¸è¿œæ·»åŠ ä¸åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ okhttpClient å¦‚æœä¸å•ä¾‹ï¼Œä¼šå‡ºç° oomï¼šå› ä¸ºå¤§é‡çš„ Dispatcher å¯¹è±¡ï¼Œä¸åŒçš„å¯¹è±¡ä¼šä½¿ç”¨ä¸åŒçš„çº¿ç¨‹å»å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œä»è€Œå¯¼è‡´çº¿ç¨‹è¿‡å¤šï¼ŒOOM GlideGlideç”¨çš„éƒ½æ˜¯æ ¸å¿ƒçº¿ç¨‹æ•°ä¸æœ€å¤§çº¿ç¨‹æ•°ä¸€è‡´ï¼ˆcpuæ•°é‡ä¸4çš„æœ€å°å€¼ï¼‰ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸ºPriorityBlockingQueueçš„å®šé•¿çº¿ç¨‹æ± ã€‚ï¼ˆæ‰€ä»¥Glideçš„æœ€å¤§å¹¶å‘é‡æ˜¯å››ä¸ªå›¾ç‰‡?ï¼‰ glideåŠ è½½çš„çº¿ç¨‹æ± çš„é…ç½®ï¼Œä½¿ç”¨cpuæ•°é‡ä¸4çš„æœ€å°å€¼ï¼Œå³çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹å’Œæœ€å¤§çº¿ç¨‹æ•°ä¸è¶…è¿‡4ä¸ª çº¿ç¨‹æ± å…³é—­æ–¹æ³•åŒºåˆ«shutdown() ã€ shutdownNow() ã€ awaitTermination() çš„ç”¨æ³•å’ŒåŒºåˆ« shutdown()å°†çº¿ç¨‹æ± çŠ¶æ€ç½®ä¸ºSHUTDOWN,å¹¶ä¸ä¼šç«‹å³åœæ­¢ï¼š åœæ­¢æ¥æ”¶å¤–éƒ¨submitçš„ä»»åŠ¡ å†…éƒ¨æ­£åœ¨è·‘çš„ä»»åŠ¡å’Œé˜Ÿåˆ—é‡Œç­‰å¾…çš„ä»»åŠ¡ï¼Œä¼šæ‰§è¡Œå®Œ ç­‰åˆ°ç¬¬äºŒæ­¥å®Œæˆåï¼Œæ‰çœŸæ­£åœæ­¢ shutdownNow()å°†çº¿ç¨‹æ± çŠ¶æ€ç½®ä¸ºSTOPã€‚ä¼å›¾ç«‹å³åœæ­¢ï¼Œäº‹å®ä¸Šä¸ä¸€å®šï¼š è·Ÿshutdown()ä¸€æ ·ï¼Œå…ˆåœæ­¢æ¥æ”¶å¤–éƒ¨æäº¤çš„ä»»åŠ¡ å¿½ç•¥é˜Ÿåˆ—é‡Œç­‰å¾…çš„ä»»åŠ¡ å°è¯•å°†æ­£åœ¨è·‘çš„ä»»åŠ¡interruptä¸­æ–­ è¿”å›æœªæ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ awaitTermination()awaitTermination(long timeOut, TimeUnit unit) å½“å‰çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ° ç­‰æ‰€æœ‰å·²æäº¤çš„ä»»åŠ¡ï¼ˆåŒ…æ‹¬æ­£åœ¨è·‘çš„å’Œé˜Ÿåˆ—ä¸­ç­‰å¾…çš„ï¼‰æ‰§è¡Œå®Œ æˆ–è€…ç­‰è¶…æ—¶æ—¶é—´åˆ° æˆ–è€…çº¿ç¨‹è¢«ä¸­æ–­ï¼ŒæŠ›å‡ºInterruptedException ç„¶åè¿”å›trueï¼ˆshutdownè¯·æ±‚åæ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼‰æˆ–falseï¼ˆå·²è¶…æ—¶ï¼‰ å°ç»“ï¼š ä¼˜é›…çš„å…³é—­ï¼Œç”¨shutdown()ï¼Œåœæ­¢æ¥å—ä»»åŠ¡å¹¶ç­‰å¾…è¿›è¡Œä¸­çš„å’Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œååœæ­¢ã€‚ æƒ³ç«‹é©¬ä¸­æ–­å¹¶å…³é—­ï¼Œå¹¶å¾—åˆ°æœªæ‰§è¡Œä»»åŠ¡åˆ—è¡¨ï¼Œç”¨shutdownNow()ï¼Œä¼šinterruptæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡å¹¶å¿½ç•¥é˜Ÿåˆ—ä¸­ä»»åŠ¡ï¼Œè¿”å›æœªæ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ— ä¼˜é›…çš„å…³é—­ï¼Œå¹¶å…è®¸å…³é—­å£°æ˜åæ–°ä»»åŠ¡èƒ½æäº¤ï¼Œç”¨awaitTermination() çº¿ç¨‹æ± éƒ½æœ‰å“ªå‡ ç§å·¥ä½œé˜Ÿåˆ—ï¼ŸArrayBlockingQueueï¼šæ˜¯ä¸€ä¸ªåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ LinkedBlockingQueueï¼šæ˜¯ä¸€ä¸ªåŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰FIFOæ’åºå…ƒç´ ï¼Œååé‡ é€šå¸¸è¦é«˜äºArrayBlockingQueueã€‚é™æ€å·¥å‚æ–¹æ³•Executors.newFixedThreadPool()ã€newSingleThreadExecutorä½¿ç”¨äº† è¿™ä¸ªé˜Ÿåˆ—ã€‚ SynchronousQueueï¼šæ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚æ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œååé‡é€šå¸¸è¦é«˜äºLinkedBlockingQueueã€‚ DelayedWorkQueueï¼šæ˜¯ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚ä¿è¯æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¼šæŒ‰ç…§ä»»åŠ¡çš„å»¶æ—¶æ—¶é—´è¿›è¡Œæ’åºï¼Œå»¶æ—¶æ—¶é—´å°‘çš„ä»»åŠ¡é¦–å…ˆè¢«è·å–ã€‚newScheduledThreadPoolä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—ã€‚ å‡è®¾å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡æ—¶ï¼Œæ ¸å¿ƒçº¿ç¨‹éƒ½è¢«å ç”¨çš„æƒ…å†µä¸‹ï¼š ArrayBlockingQueueï¼šåŸºäºæ•°ç»„çš„é˜»å¡é˜Ÿåˆ—ï¼Œåˆå§‹åŒ–éœ€è¦æŒ‡å®šå›ºå®šå¤§å°ã€‚ â€‹ å½“ä½¿ç”¨æ­¤é˜Ÿåˆ—æ—¶ï¼Œå‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œä¼šé¦–å…ˆåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå½“ç­‰å¾…é˜Ÿåˆ—æ»¡äº†ä¹‹åï¼Œå†æ¬¡æäº¤ä»»åŠ¡ï¼Œå°è¯•åŠ å…¥é˜Ÿåˆ—å°±ä¼šå¤±è´¥ï¼Œè¿™æ—¶å°±ä¼šæ£€æŸ¥å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°æœªè¾¾åˆ°æœ€å¤§çº¿ç¨‹ï¼Œåˆ™ä¼šæ–°å»ºçº¿ç¨‹æ‰§è¡Œæ–°æäº¤çš„ä»»åŠ¡ã€‚æ‰€ä»¥æœ€ç»ˆå¯èƒ½å‡ºç°åæäº¤çš„ä»»åŠ¡å…ˆæ‰§è¡Œï¼Œè€Œå…ˆæäº¤çš„ä»»åŠ¡ä¸€ç›´åœ¨ç­‰å¾…ã€‚ LinkedBlockingQueueï¼šåŸºäºé“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—ï¼Œåˆå§‹åŒ–å¯ä»¥æŒ‡å®šå¤§å°ï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®šã€‚ â€‹ å½“æŒ‡å®šå¤§å°åï¼Œè¡Œä¸ºå°±å’ŒArrayBlockingQueuä¸€è‡´ã€‚è€Œå¦‚æœæœªæŒ‡å®šå¤§å°ï¼Œåˆ™ä¼šä½¿ç”¨é»˜è®¤çš„Integer.MAX_VALUEä½œä¸ºé˜Ÿåˆ—å¤§å°ã€‚è¿™æ—¶å€™å°±ä¼šå‡ºç°çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°å‚æ•°æ— ç”¨ï¼Œå› ä¸ºæ— è®ºå¦‚ä½•ï¼Œå‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡åŠ å…¥ç­‰å¾…é˜Ÿåˆ—éƒ½ä¼šæˆåŠŸã€‚æœ€ç»ˆæ„å‘³ç€æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯åœ¨æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œã€‚å¦‚æœæ ¸å¿ƒçº¿ç¨‹ä¸€ç›´è¢«å ï¼Œé‚£å°±ä¸€ç›´ç­‰å¾…ã€‚ SynchronousQueue : æ— å®¹é‡çš„é˜Ÿåˆ—ã€‚ â€‹ ä½¿ç”¨æ­¤é˜Ÿåˆ—æ„å‘³ç€å¸Œæœ›è·å¾—æœ€å¤§å¹¶å‘é‡ã€‚å› ä¸ºæ— è®ºå¦‚ä½•ï¼Œå‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œå¾€é˜Ÿåˆ—æäº¤ä»»åŠ¡éƒ½ä¼šå¤±è´¥ã€‚è€Œå¤±è´¥åå¦‚æœæ²¡æœ‰ç©ºé—²çš„éæ ¸å¿ƒçº¿ç¨‹ï¼Œå°±ä¼šæ£€æŸ¥å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°æœªè¾¾åˆ°æœ€å¤§çº¿ç¨‹ï¼Œåˆ™ä¼šæ–°å»ºçº¿ç¨‹æ‰§è¡Œæ–°æäº¤çš„ä»»åŠ¡ã€‚å®Œå…¨æ²¡æœ‰ä»»ä½•ç­‰å¾…ï¼Œå”¯ä¸€åˆ¶çº¦å®ƒçš„å°±æ˜¯æœ€å¤§çº¿ç¨‹æ•°çš„ä¸ªæ•°ã€‚å› æ­¤ä¸€èˆ¬é…åˆInteger.MAX_VALUEå°±å®ç°äº†çœŸæ­£çš„æ— ç­‰å¾…ã€‚ //lqr:TODO https://juejin.cn/post/6847902225730109454 æ‹’ç»ç­–ç•¥rejectHanderå½“ Executor å·²å…³é—­æ—¶ï¼Œä»¥åŠå½“ Executor å¯¹æœ€å¤§çº¿ç¨‹å’Œå·¥ä½œé˜Ÿåˆ—å®¹é‡ä½¿ç”¨æœ‰é™ç•Œé™ä¸”å·²é¥±å’Œæ—¶ï¼Œåœ¨æ–¹æ³•execute(Runnable)ä¸­æäº¤çš„æ–°ä»»åŠ¡å°†è¢«æ‹’ç»ã€‚åœ¨ä»»ä¸€æƒ…å†µä¸‹ï¼Œ executeæ–¹æ³•éƒ½ä¼šè°ƒç”¨å…¶RejectedExecutionHandlerçš„RejectedExecutionHandler.rejectedExecution(Runnable, ThreadPoolExecutor)æ–¹æ³•ã€‚æä¾›äº†å››ç§é¢„å®šä¹‰çš„å¤„ç†ç¨‹åºç­–ç•¥ï¼š åœ¨é»˜è®¤çš„ThreadPoolExecutor.AbortPolicyä¸­ï¼Œå¤„ç†ç¨‹åºåœ¨è¢«æ‹’ç»æ—¶ä¼šæŠ›å‡ºè¿è¡Œæ—¶RejectedExecutionException ã€‚ 123throw new RejectedExecutionException(&quot;Task &quot; + r.toString() + &quot; rejected from &quot; + e.toString()); åœ¨ThreadPoolExecutor.CallerRunsPolicyä¸­ï¼Œè°ƒç”¨executeçš„çº¿ç¨‹æœ¬èº«ä¼šè¿è¡Œä»»åŠ¡ã€‚è¿™æä¾›äº†ä¸€ç§ç®€å•çš„åé¦ˆæ§åˆ¶æœºåˆ¶ï¼Œå¯ä»¥å‡æ…¢æäº¤æ–°ä»»åŠ¡çš„é€Ÿåº¦ã€‚ 123if (!e.isShutdown()) { r.run();} åœ¨ThreadPoolExecutor.DiscardPolicyä¸­ï¼Œæ— æ³•æ‰§è¡Œçš„ä»»åŠ¡å°†è¢«ç›´æ¥ä¸¢å¼ƒã€‚ 1//do nothing åœ¨ThreadPoolExecutor.DiscardOldestPolicyä¸­ï¼Œå¦‚æœæ‰§è¡Œå™¨æœªå…³é—­ï¼Œåˆ™å·¥ä½œé˜Ÿåˆ—å¤´éƒ¨çš„ä»»åŠ¡å°†è¢«åˆ é™¤ï¼Œç„¶åé‡è¯•æ‰§è¡Œï¼ˆè¿™å¯èƒ½ä¼šå†æ¬¡å¤±è´¥ï¼Œå¯¼è‡´é‡å¤æ­¤æ“ä½œã€‚ï¼‰ 1234if (!e.isShutdown()) { e.getQueue().poll(); e.execute(r);} å¦‚æœæäº¤ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± é˜Ÿåˆ—å·²æ»¡ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå¦‚æœä½¿ç”¨çš„LinkedBlockingQueueï¼Œä¹Ÿå°±æ˜¯æ— ç•Œé˜Ÿåˆ—çš„è¯ï¼Œç»§ç»­æ·»åŠ ä»»åŠ¡åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œï¼Œå› ä¸ºLinkedBlockingQueueå¯ä»¥æ— é™å­˜æ”¾ä»»åŠ¡ï¼›å¦‚æœä½¿ç”¨çš„æ˜¯æœ‰ç•Œé˜Ÿåˆ—æ¯”æ–¹è¯´ArrayBlockingQueueçš„è¯ï¼Œåˆ™ä¼šä½¿ç”¨æ‹’ç»ç­–ç•¥RejectedExecutionHandlerå¤„ç†æ»¡äº†çš„ä»»åŠ¡ã€‚","link":"/2024/04/24/ThreadPool/"},{"title":"ViewModel","text":"ç®€è¿°ï¼šfragmentæˆ–componentActivityå®ç°äº†ViewModelStoreOwneræ¥å£ï¼Œå®ç°è¯¥æ¥å£æ–¹æ³•getViewModelStore()ï¼Œå½“è°ƒç”¨ViewModelProvider(ViewModelStoreOwner owner).get(Class&lt;T&gt; modelClass)æ—¶ï¼Œä¼šä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºviewModelï¼Œä¹‹åå°†å…¶ä»¥canonicalNameï¼ˆå…¨é™å®šåï¼‰ä¸ºkeyå­˜å…¥mViewModelStoreä¸­ï¼ŒViewModelStoreå†…éƒ¨æ˜¯ä¸ªHashMap&lt;String, ViewModel&gt;ã€‚ å½“å±å¹•æ—‹è½¬æˆ–åˆ‡æ¢ç³»ç»Ÿè¯­è¨€ç­‰é…ç½®ä¿®æ”¹çš„è¡Œä¸ºå‘ç”Ÿæ—¶ï¼ŒActivity ç”Ÿå‘½å‘¨æœŸä»é”€æ¯å†é‡å»ºï¼Œåœ¨é”€æ¯æ—¶ï¼ˆç³»ç»Ÿæ€æ­»æˆ–é…ç½®ä¿®æ”¹ï¼‰ï¼Œå¦‚æœåˆ¤æ–­ç³»ç»Ÿé…ç½®æ²¡æœ‰å˜åŒ–ï¼ˆå³!isChangingConfigurationsï¼‰æ¸…ç©ºä¿å­˜çš„ViewModelï¼ˆå³ getViewModelStore().clear();ï¼‰ å¦‚æœå‘ç”Ÿå˜åŒ–åˆ™è°ƒç”¨onRetainNonConfigurationInstance() æ–¹æ³•å°† viewModelStore ä¿å­˜èµ·æ¥ï¼Œå½“Activityé‡å»ºæ—¶åˆ™ä»getLastNonConfigurationInstance()ä¸­è·å–ä¿å­˜çš„mViewModelStore psï¼šå¦‚æœViewModelProviderä¼ å…¥Activityï¼Œåˆ™å–å¾—æ˜¯Activityçš„ViewModelStoreï¼Œå¦‚æœä¼ å…¥äº†fragmentï¼Œåˆ™æ ¹æ®ä»¥ä¸‹ä»£ç å–ViewModelStoreï¼Œå³å…ˆå–çˆ¶fragmentçš„FragmentManagerçš„ViewModelStoreï¼Œå†å–hostActivtyçš„ViewModelStoreï¼Œæœ€åæ‰æ˜¯æ–°å»ºä¸€ä¸ªã€‚ 12345678if (parent != null) { this.mNonConfig = parent.mFragmentManager.getChildNonConfig(parent);} else if (host instanceof ViewModelStoreOwner) { ViewModelStore viewModelStore = ((ViewModelStoreOwner)host).getViewModelStore(); this.mNonConfig = FragmentManagerViewModel.getInstance(viewModelStore);} else { this.mNonConfig = new FragmentManagerViewModel(false);} å½“å±å¹•æ—‹è½¬æˆ–è€…åˆ‡æ¢ç³»ç»Ÿè¯­è¨€æ—¶ï¼ŒActivity ç”Ÿå‘½å‘¨æœŸä»é”€æ¯å†é‡å»ºï¼Œä½†æ˜¯ViewModelé‡Œé¢çš„å˜é‡å€¼ä¸å—åˆ°å½±å“ï¼Œè¯´æ˜ViewModelä¸­çš„å˜é‡åœ¨å±å¹•æ—‹è½¬å‰è¿›è¡Œäº†å­˜å‚¨ï¼Œåœ¨å±å¹•æ—‹è½¬ååˆè¿›è¡Œäº†æ¢å¤ã€‚ é‡Œé¢çš„åŸç†æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ ä¸€ã€è·å–ViewModelå®ä¾‹12// MainActivity.ktval viewModel = ViewModelProvider(this).get(MainViewModel::class.java) è¿™ä¸ªä»£ç æ‹†åˆ†æˆ2æ®µæ¥åˆ†æï¼šViewModelProvider(this)å’Œget(MainViewModel::class.java) äºŒã€ViewModelProvider(this)ç”¨äºè·å– ViewModelProvider å®ä¾‹ 123456789101112131415161718192021222324252627282930313233// ViewModelProvider.javapublic ViewModelProvider(@NonNull ViewModelStoreOwner owner) { this(owner.getViewModelStore(), owner instanceof HasDefaultViewModelProviderFactory ? ((HasDefaultViewModelProviderFactory) owner).getDefaultViewModelProviderFactory() : NewInstanceFactory.getInstance());}// ComponentActivity.java public ViewModelStore getViewModelStore() { if (getApplication() == null) { throw new IllegalStateException(&quot;Your activity is not yet attached to the &quot; + &quot;Application instance. You can't request ViewModel before onCreate call.&quot;); } ensureViewModelStore(); return mViewModelStore;}@SuppressWarnings(&quot;WeakerAccess&quot;) /* synthetic access */void ensureViewModelStore() { if (mViewModelStore == null) { // å…ˆä» NonConfigurationInstances è·å– NonConfigurationInstances nc = (NonConfigurationInstances) getLastNonConfigurationInstance(); if (nc != null) { // Restore the ViewModelStore from NonConfigurationInstances // ä»ç¼“å­˜ä¸­æ¢å¤ mViewModelStore = nc.viewModelStore; } // å¦‚æœç¼“å­˜é‡Œé¢æ²¡æœ‰ï¼Œç›´æ¥åˆ›å»ºæ–°çš„ if (mViewModelStore == null) { mViewModelStore = new ViewModelStore(); } }} ä»£ç å¾ˆç®€å•ï¼Œå¯ä»¥çœ‹å‡ºï¼Œæœ€åè°ƒç”¨çš„æ˜¯ComponentActivityä¸­çš„ensureViewModelStore()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ã€‚ è¿™ä¸ªæ–¹æ³•æ¶‰åŠ2ä¸ªå¾ˆé‡è¦çš„ç±»ï¼šViewModelStore å’Œ NonConfigurationInstancesã€‚ ViewModelStoreViewModelStoreä»åå­—å¯ä»¥çœ‹å‡ºï¼Œæ˜¯ç”¨æ¥å­˜å‚¨ViewModleå¯¹è±¡çš„ï¼Œåšä¸€ä¸ªç¼“å­˜çš„ä½œç”¨ï¼Œåº•å±‚ç”¨Mapå®ç°ã€‚æºç ï¼š 123456789101112131415161718192021222324252627282930// ViewModelStore.javapublic class ViewModelStore { private final HashMap&lt;String, ViewModel&gt; mMap = new HashMap&lt;&gt;(); final void put(String key, ViewModel viewModel) { ViewModel oldViewModel = mMap.put(key, viewModel); if (oldViewModel != null) { oldViewModel.onCleared(); } } final ViewModel get(String key) { return mMap.get(key); } Set&lt;String&gt; keys() { return new HashSet&lt;&gt;(mMap.keySet()); } /** * Clears internal storage and notifies ViewModels that they are no longer used. */ public final void clear() { for (ViewModel vm : mMap.values()) { vm.clear(); } mMap.clear(); }} ä»£ç å¾ˆç®€å•ï¼Œå¯ä»¥çœ‹å‡ºViewModelStore é‡Œé¢å°±æ˜¯ä¸€ä¸ªHashMapï¼Œç”¨äºç¼“å­˜ViewModelå®ä¾‹å¯¹è±¡ã€‚ NonConfigurationInstances12345// ComponentActivity$NonConfigurationInstances.javastatic final class NonConfigurationInstances { Object custom; ViewModelStore viewModelStore;} è¿™å…¶å®å°±æ˜¯ä¸€ä¸ªJava Beanç±»ï¼Œé‡Œé¢å­˜åœ¨2ä¸ªå­—æ®µï¼ŒåŒ…è¿‡ viewModelStore å­—æ®µã€‚ ä¸‰ã€get(MainViewModel::class.java)12345678910111213141516171819202122232425262728293031323334// ViewModelProvider.javaprivate static final String DEFAULT_KEY =&quot;androidx.lifecycle.ViewModelProvider.DefaultKey&quot;;public &lt;T extends ViewModel&gt; T get(@NonNull Class&lt;T&gt; modelClass) { String canonicalName = modelClass.getCanonicalName(); if (canonicalName == null) { throw new IllegalArgumentException(&quot;Local and anonymous classes can not be ViewModels&quot;); } return get(DEFAULT_KEY + &quot;:&quot; + canonicalName, modelClass);}// ViewModelProvider.javapublic &lt;T extends ViewModel&gt; T get(@NonNull String key, @NonNull Class&lt;T&gt; modelClass) { ViewModel viewModel = mViewModelStore.get(key); if (modelClass.isInstance(viewModel)) { if (mFactory instanceof OnRequeryFactory) { ((OnRequeryFactory) mFactory).onRequery(viewModel); } return (T) viewModel; } else { //noinspection StatementWithEmptyBody if (viewModel != null) { // TODO: log a warning. } } if (mFactory instanceof KeyedFactory) { viewModel = ((KeyedFactory) mFactory).create(key, modelClass); } else { viewModel = mFactory.create(modelClass); } mViewModelStore.put(key, viewModel); return (T) viewModel;} å…ˆæ ¹æ®keyä»mViewModelStoreè·å–ç¼“å­˜ä¸­çš„ViewModelï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å›viewModelå®ä¾‹ã€‚ å¦‚æœmViewModelStoreç¼“å­˜ä¸­ä¸å­˜åœ¨å½“å‰modelClassçš„å®ä¾‹ï¼Œåˆ™ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºä¸€ä¸ªï¼Œå†å°†æ–°åˆ›å»ºçš„åŠ å…¥ç¼“å­˜ã€‚ æˆ‘ä»¬åœ¨Activityä¸­å¹¶æ²¡æœ‰è®¾ç½®keyï¼Œé»˜è®¤çš„keyåˆæ˜¯ä¸€ä¸ªå¸¸é‡ï¼ŒçŒœæµ‹ï¼š å±å¹•æ—‹è½¬å‰åï¼ŒmViewModelStoreåº”è¯¥æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¾—åˆ°çš„è·ŸviewModelä¹Ÿæ˜¯åŒä¸€ä»½å®ä¾‹å¯¹è±¡ã€‚ æ‰€ä»¥æˆ‘ä»¬åªè¦æ‰¾å‡ºå±å¹•æ—‹è½¬å‰åï¼ŒmViewModelStoreå¦‚ä½•ä¿å­˜å’Œæ¢å¤å³å¯ã€‚ éªŒè¯çŒœæµ‹æœ€ç›´æ¥çš„æ–¹æ³•å°±æ˜¯logæ‰“å°ï¼š 12val viewModel = ViewModelProvider(this).get(MainViewModel::class.java)Log.i(&quot;wutao--&gt; &quot;, &quot;viewModel--&gt; $viewModel&quot; + &quot; getViewModelStore--&gt; ${getViewModelStore()}&quot;) å±å¹•æ—‹è½¬åï¼ŒmViewModelStoreå’ŒviewModelå¯¹è±¡åœ°å€ç¡®å®æ˜¯åŒä¸€ä¸ªã€‚ å››ã€mViewModelStore çš„æ¢å¤è·å– mViewModelStore ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415// ComponentActivity.javavoid ensureViewModelStore() { if (mViewModelStore == null) { NonConfigurationInstances nc = (NonConfigurationInstances) getLastNonConfigurationInstance(); if (nc != null) { // Restore the ViewModelStore from NonConfigurationInstances // å±å¹•æ—‹è½¬åœ¨è¿™é‡Œæ¢å¤ mViewModelStore = nc.viewModelStore; } // å±å¹•æ—‹è½¬åï¼Œæ•°æ®æ¢å¤ä¸æ˜¯newå‡ºæ¥çš„å¯¹è±¡ if (mViewModelStore == null) { mViewModelStore = new ViewModelStore(); } }} å±å¹•æ—‹è½¬å‰åï¼ŒmViewModelStore åœ¨å±å¹•æ—‹è½¬å‰åéƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸å¯èƒ½æ˜¯newå‡ºæ¥çš„ï¼Œé‚£å°±æ˜¯èµ°çš„ mViewModelStore = nc.viewModelStore;ï¼Œä¹Ÿå°±æ˜¯ä»getLastNonConfigurationInstance() å¾—åˆ°çš„å±å¹•æ—‹è½¬å‰ä¿å­˜çš„æ•°æ®ã€‚ å±å¹•æ—‹è½¬åï¼ŒActivityé‡å»ºåä» getLastNonConfigurationInstance() ä¸­è·å–åˆ°äº†å±å¹•æ—‹è½¬å‰ä¿å­˜çš„ NonConfigurationInstances å®ä¾‹å¯¹è±¡ï¼Œç„¶åä»ncå¯¹è±¡ä¸­è·å–å­˜å‚¨çš„mViewModelStoreå¯¹è±¡ã€‚ æˆ‘ä»¬ä¸€èˆ¬æ˜¯åœ¨ onCreate() ä¸­å»è·å–ViewModel å®ä¾‹å¯¹è±¡çš„ï¼Œè¯´æ˜getLastNonConfigurationInstance()è¿™ä¸ªæ–¹æ³•åœ¨ onCreate() æ–¹æ³•å‰è°ƒç”¨ã€‚ é‚£å½“å±å¹•æ—‹è½¬å‰ï¼Œ mViewModelStore å®ä¾‹æ˜¯åœ¨å“ªå­˜å‚¨çš„å‘¢ï¼Ÿ äº”ã€mViewModelStore çš„å­˜å‚¨ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œå±å¹•æ—‹è½¬å®Œæˆï¼ŒActivityé‡å»ºåmViewModelStoreæ˜¯ä»NonConfigurationInstancesè·å–çš„ï¼Œé‚£å±å¹•æ—‹è½¬å‰è‚¯å®šä¹Ÿæ˜¯åœ¨è¿™é‡Œå­˜å‚¨çš„ã€‚ æœç´¢è°ƒç”¨çš„åœ°æ–¹ï¼š ä»ä¸Šå›¾ç‰‡å¯ä»¥çœ‹åˆ°æ˜¯åœ¨ç¬¬äºŒå¤„ï¼Œä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425// ComponentActivity.javapublic final Object onRetainNonConfigurationInstance() { // Maintain backward compatibility. Object custom = onRetainCustomNonConfigurationInstance(); ViewModelStore viewModelStore = mViewModelStore; if (viewModelStore == null) { // No one called getViewModelStore(), so see if there was an existing // ViewModelStore from our last NonConfigurationInstance NonConfigurationInstances nc = (NonConfigurationInstances) getLastNonConfigurationInstance(); if (nc != null) { viewModelStore = nc.viewModelStore; } } if (viewModelStore == null &amp;&amp; custom == null) { return null; } // åœ¨è¿™é‡Œå­˜å‚¨çš„ NonConfigurationInstances nci = new NonConfigurationInstances(); nci.custom = custom; nci.viewModelStore = viewModelStore; return nci;} å¯ä»¥å¾—å‡ºç»“è®ºï¼šå±å¹•æ—‹è½¬å‰ï¼Œæ•°æ®åœ¨ onRetainNonConfigurationInstance() ä¿å­˜ï¼ŒActivity é‡å»ºåï¼Œåœ¨ getLastNonConfigurationInstance() ä¸­æ¢å¤ã€‚ Activityç”Ÿå‘½å‘¨æœŸè°ƒç”¨å¦‚ä¸‹ï¼š ç»§ç»­è·Ÿä¸€ä¸‹æºç ï¼Œå¯»æ‰¾æ•°æ®å…·ä½“å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ å…­ã€ä¸€æ¢åˆ°åº•Activityé‡å¯åæ•°æ®çš„æ¢å¤Activity é‡å»ºåï¼Œåœ¨ getLastNonConfigurationInstance() ä¸­æ¢å¤ã€‚ 12345// Activity.javapublic Object getLastNonConfigurationInstance() { return mLastNonConfigurationInstances != null ? mLastNonConfigurationInstances.activity : null;} mLastNonConfigurationInstances èµ‹å€¼çš„åœ°æ–¹ï¼š 1234567891011121314// Activity.javafinal void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config, String referrer, IVoiceInteractor voiceInteractor, Window window, ActivityConfigCallback activityConfigCallback, IBinder assistToken) { attachBaseContext(context); Â·Â·Â· mLastNonConfigurationInstances = lastNonConfigurationInstances; Â·Â·Â· } ä»Activityçš„å¯åŠ¨æµç¨‹å¯çŸ¥ï¼ŒActivity$attach()æ–¹æ³•æ˜¯åœ¨ActivityThreadè°ƒç”¨çš„ï¼š 123456789101112// ActivityThread.javaActivity.NonConfigurationInstances lastNonConfigurationInstances;/** Core implementation of activity launch. */private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) { activity.attach(appContext, this, getInstrumentation(), r.token, r.ident, app, r.intent, r.activityInfo, title, r.parent, r.embeddedID, r.lastNonConfigurationInstances, config, r.referrer, r.voiceInteractor, window, r.configCallback, r.assistToken); } ä»ä¸Šå¾—çŸ¥ï¼Œæ•°æ®å­˜å‚¨åœ¨ActivityClientRecordä¸­ï¼Œåœ¨Activityå¯åŠ¨æ—¶å°†ActivityClientRecordä¸­çš„lastNonConfigurationInstancesé€šè¿‡attach()æ–¹æ³•èµ‹å€¼åˆ°å¯¹åº”çš„Activityä¸­ï¼Œç„¶åé€šè¿‡getLastNonConfigurationInstance()æ¢å¤æ•°æ®ã€‚ å±å¹•æ—‹è½¬å‰æ•°æ®çš„å­˜å‚¨å±å¹•æ—‹è½¬å‰ï¼Œæ•°æ®åœ¨ onRetainNonConfigurationInstance() ä¿å­˜ã€‚ åœ¨Activityçš„retainNonConfigurationInstances()æ–¹æ³•ä¸­è¢«è°ƒç”¨ã€‚ é‚£retainNonConfigurationInstances()æ–¹æ³•åˆæ˜¯åœ¨å“ªè°ƒç”¨çš„å‘¢ï¼Ÿè‚¯å®šä¹Ÿè·ŸActivityThreadæœ‰å…³ï¼Œåœ¨ActivityThreadæœç´¢ä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516// ActivityThread.java ActivityClientRecord performDestroyActivity(IBinder token, boolean finishing, int configChanges, boolean getNonConfigInstance, String reason) { ActivityClientRecord r = mActivities.get(token); Â·Â·Â· if (getNonConfigInstance) { try { r.lastNonConfigurationInstances = r.activity.retainNonConfigurationInstances(); } catch (Exception e) { Â·Â·Â· } } Â·Â·Â· return r;} ä»ä¸Šå¾—çŸ¥ï¼ŒperformDestroyActivity() è°ƒç”¨äº†retainNonConfigurationInstances() æ–¹æ³•å¹¶æŠŠæ•°æ®ä¿å­˜åˆ°äº†ActivityClientRecordçš„lastNonConfigurationInstancesä¸­ã€‚ ä¸ƒã€ç‰¹ä¾‹-ç³»ç»Ÿæ€åå°ç”±äºä¸Šæ–‡å·²ç»åšè¿‡å®éªŒäº†ï¼Œæˆ‘è¿™é‡Œç›´æ¥è´´ä¸Šå®éªŒçš„æ‰“å°ç»“æœ ç¬¬ä¸€å¼ å›¾æ˜¯æ¨¡æ‹Ÿæ€åå°çš„ç”Ÿå‘½å‘¨æœŸæ‰“å°ï¼Œç¬¬äºŒå¼ å›¾æ˜¯å±å¹•æ—‹è½¬ã€‚ å¯ä»¥çœ‹å‡ºï¼š ç³»ç»Ÿæ€åå°ï¼ŒActivityä¸ä¼šèµ°onDestory()å’ŒonRetainCustomNonConfigurationInstance()æ–¹æ³•ã€‚ å¯ä»¥è¯´æ€æ‰åå°ï¼ŒActivityé”€æ¯çš„ç”Ÿå‘½å‘¨æœŸéƒ½ä¸ä¼šèµ°ï¼Œåªæœ‰Appå†å›åˆ°å‰å°æ—¶ï¼Œæ‰ä¼šèµ°Activityé‡å»ºç”Ÿå‘½å‘¨æœŸã€‚ å› ä¸ºæ²¡æœ‰æ‰§è¡ŒonRetainCustomNonConfigurationInstance()æ–¹æ³•ï¼ŒActivityçš„æ•°æ®ä¹Ÿæ²¡æœ‰ç¼“å­˜ä¸‹æ¥ï¼Œæ‰€ä»¥Activityé‡å»ºä¹Ÿæ²¡æœ‰æ•°æ®å¯ä»¥æ¢å¤ã€‚ ä¸‹å›¾æ˜¯Activityä¸­çš„ViewModelå®ä¾‹å¯¹è±¡åœ°å€æ‰“å°ï¼š å¯ä»¥çœ‹å‡ºï¼Œadbæ¨¡æ‹Ÿæ€æ‰åå°åï¼ŒViewModelåœ°å€å€¼å˜äº†ï¼Œæ˜¯ä¸€ä¸ªå…¨æ–°çš„åœ°å€ã€‚ å¦‚æœæƒ³è¦ç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œæ€æ‰åå°ï¼ŒAppå†æ¬¡å›åˆ°å‰å°ï¼Œä¹‹å‰çš„æ•°æ®è¿›è¡Œæ¢å¤ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ è¯·å¬ä¸‹å›åˆ†æã€‚ğŸ˜ å…«ã€æ€»ç»“å±å¹•æ—‹è½¬å‰ï¼ŒActivityé”€æ¯æ—¶ï¼š ComponentActivityè°ƒç”¨onRetainNonConfigurationInstance()æ–¹æ³•ï¼Œå°†è¦é”€æ¯çš„Activityçš„mViewModelStoreè½¬åŒ–ä¸ºNonConfigurationInstanceså¯¹è±¡ï¼Œç»§ç»­è°ƒç”¨Activityçš„retainNonConfigurationInstances()æ–¹æ³•ï¼Œæœ€ç»ˆåœ¨ActivityThreadçš„performDestroyActivity()ä¸­å°†æ•°æ®ä¿å­˜åœ¨ActivityClientRecordä¸­ã€‚ Activityé‡å»ºåï¼š åœ¨Activityå¯åŠ¨æ—¶ï¼ŒActivityThreadè°ƒç”¨performLaunchActivity()æ–¹æ³•ï¼Œå°†å­˜å‚¨åœ¨ActivityClientRecordä¸­çš„lastNonConfigurationInstancesé€šè¿‡Activityçš„attach()æ–¹æ³•ä¼ é€’åˆ°å¯¹åº”çš„Activityä¸­ï¼Œç„¶åé€šè¿‡getLastNonConfigurationInstance()æ¢å¤mViewModelStoreå®ä¾‹å¯¹è±¡ï¼Œæœ€åæ ¹æ®å¯¹åº”çš„keyæ‹¿åˆ°é”€æ¯å‰å¯¹åº”çš„ViewModelå®ä¾‹ã€‚ æ­¤å¤–ï¼Œå½“ç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œç³»ç»Ÿå°†åå°åº”ç”¨å›æ”¶åï¼ŒViewModelä¸­çš„æ•°æ®ä¸ä¼šæ¢å¤ã€‚ é™„ä¸Šæ€»ä½“æµç¨‹å›¾ï¼š","link":"/2023/10/10/ViewModel/"},{"title":"RenderBlock","text":"é“¾æ¥ï¼šhttps://juejin.cn/post/7062552765117136903 https://developer.android.com/topic/performance/rendering/profile-gpu?hl=zh-cn RenderThreadçš„ä½œç”¨ï¼šä¸»çº¿ç¨‹çš„ draw å‡½æ•°å¹¶æ²¡æœ‰çœŸæ­£çš„æ‰§è¡Œ drawCall ï¼Œè€Œæ˜¯æŠŠè¦ draw çš„å†…å®¹è®°å½•åˆ° DIsplayList é‡Œé¢ï¼ˆåœ¨ Measureã€Layoutã€Draw çš„ Draw è¿™ä¸ªç¯èŠ‚ï¼ŒAndroid ä½¿ç”¨ DisplayList è¿›è¡Œç»˜åˆ¶è€Œéç›´æ¥ä½¿ç”¨ CPU ç»˜åˆ¶æ¯ä¸€å¸§ã€‚ï¼‰ï¼ŒåŒæ­¥åˆ° RenderThread ä¸­ï¼Œä¸€æ—¦åŒæ­¥å®Œæˆï¼Œä¸»çº¿ç¨‹å°±å¯ä»¥è¢«é‡Šæ”¾å‡ºæ¥åšå…¶ä»–çš„äº‹æƒ…ï¼ŒRenderThread åˆ™ç»§ç»­è¿›è¡Œæ¸²æŸ“å·¥ä½œ 2.3 ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€… æˆ‘ä»¬å†å›åˆ° Vsync çš„è¯é¢˜ï¼Œæ¶ˆè´¹ Vsync çš„åŒæ–¹åˆ†åˆ«æ˜¯ App å’Œ sfï¼Œå…¶ä¸­ App ä»£è¡¨çš„æ˜¯ç”Ÿäº§è€…ï¼Œsf ä»£è¡¨çš„æ˜¯æ¶ˆè´¹è€…ï¼Œä¸¤è€…äº¤ä»˜çš„ä¸­é—´äº§ç‰©åˆ™æ˜¯ surface bufferã€‚ å†å…·ä½“ä¸€ç‚¹ï¼Œç”Ÿäº§è€…å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ä»¥ window ä¸ºä»£è¡¨çš„é¡µé¢ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶æ‰€çœ‹åˆ°çš„ view æ ‘è¿™ä¸€å¥—ï¼›å¦ä¸€ç±»æ˜¯ä»¥è§†é¢‘æµä¸ºä»£è¡¨çš„å¯ä»¥ç›´æ¥å’Œ surface å®Œæˆæ•°æ®äº¤æ¢çš„æ¥æºï¼Œæ¯”å¦‚ç›¸æœºé¢„è§ˆç­‰ã€‚ å¯¹äºä¸€èˆ¬çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼ï¼Œæˆ‘ä»¬çŸ¥é“ä¼šå­˜åœ¨ç›¸äº’é˜»å¡çš„é—®é¢˜ã€‚æ¯”å¦‚ç”Ÿäº§è€…é€Ÿåº¦å¿«ä½†æ˜¯æ¶ˆè´¹è€…é€Ÿåº¦æ…¢ï¼Œäº¦æˆ–æ˜¯ç”Ÿäº§è€…é€Ÿåº¦æ…¢æ¶ˆè´¹è€…é€Ÿåº¦å¿«ï¼Œéƒ½ä¼šå¯¼è‡´æ•´ä½“é€Ÿåº¦æ…¢ä¸”é€ æˆèµ„æºæµªè´¹ã€‚æ‰€ä»¥ Vsync çš„ååŒä»¥åŠåŒç¼“å†²ç”šè‡³ä¸‰ç¼“å†²çš„ä½œç”¨å°±ä½“ç°å‡ºæ¥äº†ã€‚ æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šæ˜¯å¦ç¼“å†²çš„ä¸ªæ•°è¶Šå¤šè¶Šå¥½ï¼Ÿè¿‡å¤šçš„ç¼“å†²ä¼šé€ æˆä»€ä¹ˆé—®é¢˜ï¼Ÿ ç­”æ¡ˆæ˜¯ä¼šé€ æˆå¦ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼šlagï¼Œå“åº”å»¶è¿Ÿ è¿™é‡Œç»“åˆ view çš„ä¸€ç”Ÿï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸¤ä¸ªæµç¨‹åˆåœ¨ä¸€èµ·ï¼Œè®©æˆ‘ä»¬çš„è§†è§’å†é«˜ä¸€å±‚ï¼š æˆ‘ä»¬ä¸€èˆ¬éƒ½æ¯”è¾ƒäº†è§£ view æ¸²æŸ“çš„ä¸‰å¤§æµç¨‹ï¼Œä½†æ˜¯ view çš„æ¸²æŸ“è¿œä¸æ­¢äºæ­¤ï¼š æ­¤å¤„ä»¥ä¸€ä¸ªé€šç”¨çš„ç¡¬ä»¶åŠ é€Ÿæµç¨‹æ¥è¡¨å¾ Vsync è°ƒåº¦ï¼šå¾ˆå¤šåŒå­¦çš„ä¸€ä¸ªè®¤çŸ¥è¯¯åŒºåœ¨äºè®¤ä¸º vsync æ˜¯æ¯ 16ms éƒ½ä¼šæœ‰çš„ï¼Œä½†æ˜¯å…¶å® vsync æ˜¯éœ€è¦è°ƒåº¦çš„ï¼Œæ²¡æœ‰è°ƒåº¦å°±ä¸ä¼šæœ‰å›è°ƒï¼› æ¶ˆæ¯è°ƒåº¦ï¼šä¸»è¦æ˜¯ doframe çš„æ¶ˆæ¯è°ƒåº¦ï¼Œå¦‚æœæ¶ˆæ¯è¢«é˜»å¡ï¼Œä¼šç›´æ¥é€ æˆå¡é¡¿ï¼› input å¤„ç†ï¼šè§¦æ‘¸äº‹ä»¶çš„å¤„ç†ï¼› åŠ¨ç”»å¤„ç†ï¼šanimator åŠ¨ç”»æ‰§è¡Œå’Œæ¸²æŸ“ï¼› view å¤„ç†ï¼šä¸»è¦æ˜¯ view ç›¸å…³çš„éå†å’Œä¸‰å¤§æµç¨‹ï¼› measureã€layoutã€drawï¼šview ä¸‰å¤§æµç¨‹çš„æ‰§è¡Œï¼› DisplayList æ›´æ–°ï¼šview ç¡¬ä»¶åŠ é€Ÿåçš„ draw opï¼› OpenGL æŒ‡ä»¤è½¬æ¢ï¼šç»˜åˆ¶æŒ‡ä»¤è½¬æ¢ä¸º OpenGL æŒ‡ä»¤ï¼› æŒ‡ä»¤ buffer äº¤æ¢ï¼šOpenGL çš„æŒ‡ä»¤äº¤æ¢åˆ° GPU å†…éƒ¨æ‰§è¡Œï¼› GPU å¤„ç†ï¼šGPU å¯¹æ•°æ®çš„å¤„ç†è¿‡ç¨‹ï¼› layer åˆæˆï¼šsurface buffer åˆæˆå±å¹•æ˜¾ç¤º buffer çš„æµç¨‹ï¼› å…‰æ …åŒ–ï¼šå°†çŸ¢é‡å›¾è½¬æ¢ä¸ºä½å›¾ï¼› Displayï¼šæ˜¾ç¤ºæ§åˆ¶ï¼› buffer åˆ‡æ¢ï¼šåˆ‡æ¢å±å¹•æ˜¾ç¤ºçš„å¸§ bufferï¼› 2.4 æœºåˆ¶ä¸Šçš„ä¿æŠ¤è¿™é‡Œæˆ‘ä»¬æ¥å›ç­”ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œä»ç³»ç»Ÿçš„æ¸²æŸ“æ¶æ„ä¸Šæ¥è¯´ï¼Œæœºåˆ¶ä¸Šçš„ä¿æŠ¤ä¸»è¦æœ‰å‡ æ–¹é¢ï¼š Vsync æœºåˆ¶çš„ååŒï¼› å¤šç¼“å†²è®¾è®¡ï¼› surface çš„æä¾›ï¼› åŒæ­¥å±éšœçš„ä¿æŠ¤ï¼› ç¡¬ä»¶ç»˜åˆ¶çš„æ”¯æŒï¼› æ¸²æŸ“çº¿ç¨‹çš„æ”¯æŒï¼› GPU åˆæˆåŠ é€Ÿï¼› 2.5 å†çœ‹å¡é¡¿çš„æˆå› æ¸²æŸ“æµç¨‹ Vsync è°ƒåº¦ï¼šè¿™ä¸ªæ˜¯èµ·å§‹ç‚¹ï¼Œä½†æ˜¯è°ƒåº¦çš„è¿‡ç¨‹ä¼šç»è¿‡çº¿ç¨‹åˆ‡æ¢ä»¥åŠä¸€äº›å§”æ´¾çš„é€»è¾‘ï¼Œæœ‰å¯èƒ½é€ æˆå¡é¡¿ï¼Œä½†æ˜¯ä¸€èˆ¬å¯èƒ½æ€§æ¯”è¾ƒå°ï¼Œæˆ‘ä»¬ä¹ŸåŸºæœ¬æ— æ³•ä»‹å…¥ï¼› æ¶ˆæ¯è°ƒåº¦ï¼šä¸»è¦æ˜¯ doframe Message çš„è°ƒåº¦ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ Handler è°ƒåº¦ï¼Œå¦‚æœè¿™ä¸ªè°ƒåº¦è¢«å…¶ä»–çš„ Message é˜»å¡äº§ç”Ÿäº†æ—¶å»¶ï¼Œä¼šç›´æ¥å¯¼è‡´åç»­çš„æ‰€æœ‰æµç¨‹ä¸ä¼šè¢«è§¦å‘ã€‚è¿™é‡Œç›´æ’­å»ºç«‹äº†ä¸€ä¸ª FWtachDog æœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡ä¼˜åŒ–æ¶ˆæ¯è°ƒåº¦è¾¾åˆ°æ’å¸§çš„æ•ˆæœï¼Œä½¿å¾—ç•Œé¢æ›´åŠ æµç•…ï¼› input å¤„ç†ï¼šinput æ˜¯ä¸€æ¬¡ Vsync è°ƒåº¦æœ€å…ˆæ‰§è¡Œçš„é€»è¾‘ï¼Œä¸»è¦å¤„ç† input äº‹ä»¶ã€‚å¦‚æœæœ‰å¤§é‡çš„äº‹ä»¶å †ç§¯æˆ–è€…åœ¨äº‹ä»¶åˆ†å‘é€»è¾‘ä¸­åŠ å…¥å¤§é‡è€—æ—¶ä¸šåŠ¡é€»è¾‘ï¼Œä¼šé€ æˆå½“å‰å¸§çš„æ—¶é•¿è¢«æ‹‰å¤§ï¼Œé€ æˆå¡é¡¿ã€‚æŠ–éŸ³åŸºç¡€æŠ€æœ¯åŒå­¦ä¹Ÿæœ‰å°è¯•è¿‡äº‹ä»¶é‡‡æ ·çš„æ–¹æ¡ˆï¼Œå‡å°‘ event çš„å¤„ç†ï¼Œå–å¾—äº†ä¸é”™çš„æ•ˆæœï¼› åŠ¨ç”»å¤„ç†ï¼šä¸»è¦æ˜¯ animator åŠ¨ç”»çš„æ›´æ–°ï¼ŒåŒç†ï¼ŒåŠ¨ç”»æ•°é‡è¿‡å¤šï¼Œæˆ–è€…åŠ¨ç”»çš„æ›´æ–°ä¸­æœ‰æ¯”è¾ƒè€—æ—¶çš„é€»è¾‘ï¼Œä¹Ÿä¼šé€ æˆå½“å‰å¸§çš„æ¸²æŸ“å¡é¡¿ã€‚å¯¹åŠ¨ç”»çš„é™å¸§å’Œé™å¤æ‚åº¦å…¶å®è§£å†³çš„å°±æ˜¯è¿™ä¸ªé—®é¢˜ï¼› view å¤„ç†ï¼šä¸»è¦æ˜¯æ¥ä¸‹æ¥çš„ä¸‰å¤§æµç¨‹ï¼Œè¿‡åº¦ç»˜åˆ¶ã€é¢‘ç¹åˆ·æ–°ã€å¤æ‚çš„è§†å›¾æ•ˆæœéƒ½æ˜¯æ­¤å¤„é€ æˆå¡é¡¿çš„ä¸»è¦åŸå› ã€‚æ¯”å¦‚æˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„é™ä½é¡µé¢å±‚çº§ï¼Œä¸»è¦è§£å†³çš„å°±æ˜¯è¿™ä¸ªé—®é¢˜ï¼› measure/layout/drawï¼šview æ¸²æŸ“çš„ä¸‰å¤§æµç¨‹ï¼Œå› ä¸ºæ¶‰åŠåˆ°éå†å’Œé«˜é¢‘æ‰§è¡Œï¼Œæ‰€ä»¥è¿™é‡Œæ¶‰åŠåˆ°çš„è€—æ—¶é—®é¢˜å‡ä¼šè¢«æ”¾å¤§ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¼šé™ä¸èƒ½åœ¨ draw é‡Œé¢è°ƒç”¨è€—æ—¶å‡½æ•°ï¼Œä¸èƒ½ new å¯¹è±¡ç­‰ç­‰ï¼› //ä»¥ä¸‹å¯¹åº”çš„æ˜¯**æ·¡è“è‰²ã€çº¢è‰²ã€æ©˜è‰²**è‰²å—å¯¹åº”çš„é˜¶æ®µ DisplayList çš„æ›´æ–°ï¼šè¿™é‡Œä¸»è¦æ˜¯ canvas å’Œ displaylist çš„æ˜ å°„ï¼Œä¸€èˆ¬ä¸ä¼šå­˜åœ¨å¡é¡¿é—®é¢˜ï¼Œåè€Œå¯èƒ½å­˜åœ¨æ˜ å°„å¤±è´¥å¯¼è‡´çš„æ˜¾ç¤ºé—®é¢˜ï¼› OpenGL æŒ‡ä»¤è½¬æ¢ï¼šè¿™é‡Œä¸»è¦æ˜¯å°† canvas çš„å‘½ä»¤è½¬æ¢ä¸º OpenGL çš„æŒ‡ä»¤ï¼Œä¸€èˆ¬ä¸å­˜åœ¨é—®é¢˜ã€‚ä¸è¿‡è¿™é‡Œå€’æ˜¯æœ‰ä¸€ä¸ªå¯ä»¥æ¢ç´¢çš„ç‚¹ï¼Œä¼šä¸ä¼šå­˜åœ¨ä¸€ç±»ç‰¹æ®Šçš„ canvas æŒ‡ä»¤ï¼Œè½¬æ¢åçš„ OpenGL æŒ‡ä»¤æ¶ˆè€—æ¯”è¾ƒå¤§ï¼Œè¿›è€Œå¯¼è‡´ GPU çš„æŸè€—ï¼Ÿæœ‰äº†è§£çš„åŒå­¦å¯ä»¥æ¢è®¨ä¸€ä¸‹ï¼› æŒ‡ä»¤buffer äº¤æ¢ï¼šè¿™é‡Œä¸»è¦æŒ‡ OpenGL æŒ‡ä»¤é›†äº¤æ¢ç»™ GPUï¼Œè¿™ä¸ªä¸€èˆ¬å’ŒæŒ‡ä»¤çš„å¤æ‚åº¦æœ‰å…³ã€‚ä¸€ä¸ªæœ‰æ„æ€çš„äº‹å„¿æ˜¯è¿™é‡Œä¸€åº¦è¢«æˆ‘ä»¬ä½œä¸ºçº¿ä¸Šé‡‡é›† GPU æŒ‡æ ‡çš„æ•°æ®æºï¼Œä½†æ˜¯ç”±äºå¤šç¼“å†²çš„å› ç´ æ•°æ®å‡†ç¡®åº¦ä¸å¤Ÿè¢«æ”¾å¼ƒäº†ï¼› GPU å¤„ç†ï¼šé¡¾åæ€ä¹‰ï¼Œè¿™é‡Œæ˜¯ GPU å¯¹æ•°æ®çš„å¤„ç†ï¼Œè€—æ—¶ä¸»è¦å’Œä»»åŠ¡é‡å’Œçº¹ç†å¤æ‚åº¦æœ‰å…³ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬é™ä½ GPU è´Ÿè½½æœ‰åŠ©äºé™ä½å¡é¡¿çš„åŸå› ï¼› layer åˆæˆï¼šè¿™é‡Œä¸»è¦æ˜¯ layer çš„ compose çš„å·¥ä½œï¼Œä¸€èˆ¬æ¥è§¦ä¸åˆ°ã€‚å¶å°”å‘ç° sf çš„ vsync ä¿¡å·è¢« delay çš„æƒ…å†µï¼Œé€ æˆ buffer ä¾›åº”ä¸åŠæ—¶ï¼Œæš‚æ—¶è¿˜ä¸æ¸…æ¥šåŸå› ï¼› å…‰æ …åŒ–ï¼šè¿™é‡Œæš‚æ—¶å¿½ç•¥ï¼Œåº•å±‚ç³»ç»Ÿè¡Œä¸ºï¼› Displayï¼šè¿™é‡Œæš‚æ—¶å¿½ç•¥ï¼Œåº•å±‚ç³»ç»Ÿè¡Œä¸ºï¼› Buffer åˆ‡æ¢ï¼šä¸»è¦æ˜¯å±å¹•çš„æ˜¾ç¤ºï¼Œè¿™é‡Œ buffer çš„æ•°é‡ä¹Ÿä¼šå½±å“å¸§çš„æ•´ä½“å»¶è¿Ÿï¼Œä¸è¿‡æ˜¯ç³»ç»Ÿè¡Œä¸ºï¼Œä¸èƒ½å¹²é¢„ã€‚ Google å°†è¿™ä¸ªè¿‡ç¨‹åˆ’åˆ†ä¸ºï¼šå…¶ä»–æ—¶é—´/VSync å»¶è¿Ÿã€è¾“å…¥å¤„ç†ã€åŠ¨ç”»ã€æµ‹é‡/å¸ƒå±€ã€ç»˜åˆ¶ã€åŒæ­¥å’Œä¸Šä¼ ã€å‘½ä»¤é—®é¢˜ã€äº¤æ¢ç¼“å†²åŒºã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ GPU ä¸¥æ ¼æ¨¡å¼ï¼Œå…¶å®é“ç†æ˜¯ä¸€æ ·çš„ã€‚åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå°±å›ç­”å‡ºæ¥äº†ç¬¬äºŒä¸ªé—®é¢˜ï¼š16ms å†…éƒ½éœ€è¦å®Œæˆä»€ä¹ˆï¼Ÿ å‡†ç¡®åœ°è¯´ï¼Œè¿™é‡Œä»å¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–ï¼š16ms å†…å®Œæˆ APP ä¾§æ•°æ®çš„ç”Ÿäº§ï¼›16ms å†…å®Œæˆ sf layer çš„åˆæˆ View çš„è§†è§‰æ•ˆæœæ­£æ˜¯é€šè¿‡è¿™ä¸€æ•´æ¡å¤æ‚çš„é“¾è·¯ä¸€æ­¥æ­¥å±•ç¤ºå‡ºæ¥çš„ï¼Œæœ‰äº†è¿™ä¸ªå‰æï¼Œé‚£å°±å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šä¸Šè¿°ä»»æ„é“¾è·¯å‘ç”Ÿå¡é¡¿ï¼Œå‡ä¼šé€ æˆå¡é¡¿ã€‚ è¡¥å……ç¡¬ä»¶ç»˜åˆ¶DisplayListæ›´æ–°è¯¦è§£ç¡¬ä»¶ç»˜åˆ¶è¿˜å¼•å…¥äº†ä¸€ä¸ª DisplayList çš„æ¦‚å¿µï¼ŒDisplayList æ¯ä¸ª View å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªDisplayListï¼Œå½“æŸä¸ª View éœ€è¦é‡ç»˜æ—¶ï¼Œå°†å®ƒæ ‡è®°ä¸º Dirtyã€‚å½“éœ€è¦é‡ç»˜æ—¶ï¼Œä»…ä»…åªéœ€è¦é‡ç»˜ä¸€ä¸ª View çš„ DisplayListï¼Œè€Œä¸æ˜¯åƒè½¯ä»¶ç»˜åˆ¶é‚£æ ·éœ€è¦å‘ä¸Šé€’å½’ã€‚è¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘ç»˜å›¾çš„æ“ä½œæ•°é‡ï¼Œå› è€Œæé«˜äº†æ¸²æŸ“æ•ˆç‡ Display List æ˜¯ä¸€ä¸ªç¼“å­˜ç»˜åˆ¶å‘½ä»¤çš„ Bufferï¼ŒDisplay List çš„æœ¬è´¨æ˜¯ä¸€ä¸ªç¼“å†²åŒºï¼Œå®ƒé‡Œé¢è®°å½•äº†å³å°†è¦æ‰§è¡Œçš„ç»˜åˆ¶å‘½ä»¤åºåˆ—ã€‚Display List æ˜¯è§†å›¾çš„åŸºæœ¬ç»˜åˆ¶å…ƒç´ ï¼ŒåŒ…å«å…ƒç´ åŸå§‹å±æ€§ï¼ˆä½ç½®ã€å°ºå¯¸ã€è§’åº¦ã€é€æ˜åº¦ç­‰ï¼‰ï¼Œå¯¹åº” Canvas çš„ drawXxx()æ–¹æ³•ã€‚ç±»ä¼¼äºå·¦è¾¹å›¾ä¸­æ‰€ç¤ºä¸€æ ·ï¼ŒonDrawä¼šè¢«DisplayListæ‰€è¡¨ç¤ºã€‚ViewTreeä¸­æ¯ä¸€ä¸ªViewéƒ½ä¼šæœ‰å¯¹åº”çš„DisplayListæ¥ä»£è¡¨ã€‚ æœ¬ä¾‹å­ä¸­ï¼Œç‚¹å‡»Item2ï¼Œè§¦å‘onDrawä¹‹åï¼ŒDisplayListå¼€å¯äº†å¦‚ä¸‹çš„æ“ä½œï¼š Syncåœ¨Javaå±‚ï¼ˆUI Threadï¼‰ï¼Œæˆ‘ä»¬æ”¶é›†ç»„åˆæ‰€æœ‰ä¿¡æ¯ï¼Œç„¶åæŠŠè¿™äº›ä¿¡æ¯syncç»™Nativeå±‚ï¼Œç”±RenderThreadç”¨GPUæ¸²æŸ“ã€‚ Damage Area: è¿™ä¸ªæ¦‚å¿µç±»ä¼¼äºDirty Regionï¼Œæ„æ€æ˜¯éœ€è¦è¢«é‡æ–°ç»˜åˆ¶çš„åŒºåŸŸï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­å°±æ˜¯item2çš„åŒºåŸŸã€‚ Upload non-HW Bitmaps: æŠŠnon-HW Bitmapsä¸Šä¼ åˆ°GPUçš„RAMé‡Œï¼Œæ­¤æ—¶ä¸€å¸§åˆšåˆšå¼€å§‹ï¼Œæœ‰æ¯”è¾ƒå……è¶³çš„æ—¶é—´ã€‚ç›¸åçš„æ˜¯ï¼Œ å¯¹Hardward Bitmapæ²¡æœ‰è¿™æ­¥æ“ä½œï¼ŒHardward Bitmapæ˜¯ä¸€ç§æ–°çš„ä½å›¾é…ç½®ï¼Œæ˜¯åœ¨Android Ohä¸­æ·»åŠ çš„ é€šå¸¸å½“ä½ æœ‰ä¸€ä¸ªä½å›¾æ—¶æˆ‘ä»¬å¿…é¡»åœ¨Javaç«¯åˆ†é…å†…å­˜ï¼Œç„¶ååœ¨éœ€è¦ç»˜åˆ¶çš„æ—¶å€™ æˆ‘ä»¬å¿…é¡»åœ¨GPUä¸Šå¤åˆ¶ä½å›¾ï¼Œè¿™åœ¨æ–‡æœ¬æ—¶é—´ä¸Šæ˜¯æ˜‚è´µçš„ï¼Œå®ƒä½¿æˆ‘ä»¬çš„RAMæ•°é‡å¢åŠ äº†ä¸€å€ã€‚ä½¿ç”¨Oreoä¸­å¯ç”¨çš„ç¡¬ä»¶ä½å›¾ï¼Œå®ƒå·²ç»å­˜åœ¨GPUä¸€ä¾§äº† å¦‚æœä½ ä¸æ‰“ç®—ä¿®æ”¹è¿™ä¸ªä½å›¾ï¼Œä»å†…å­˜è§’åº¦æ¥çœ‹ç¡®å®æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ•ˆçš„å­˜å‚¨ä½å›¾çš„æ–¹å¼ã€‚ RenderThreadAndroid 5.0 (Lollipop)å¼•å…¥çš„ï¼Œæ­¤çº¿ç¨‹åªåœ¨Nativeå±‚è·ŸGPUäº¤äº’ï¼Œåœ¨Javaå±‚æ²¡æœ‰ä»»ä½•è°ƒç”¨ã€‚æ¸²æŸ“ä¹‹å‰ï¼Œæˆ‘ä»¬ç”ŸæˆDisplayListï¼Œç„¶åæˆ‘ä»¬æŠŠè¿™äº›ä¿¡æ¯syncç»™GPUã€‚å®ƒæ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä½†æ˜¯RenderThreadåœ¨è¿™ä¹‹ä¸­èƒ½å¤Ÿä»¥åŸå­æ“ä½œï¼ˆAtomic Operationsï¼‰å½¢å¼æ‰§è¡Œ ä¾‹å¦‚æ³¢çº¹åŠ¨ç”»åŠ¨ç”»ï¼ŒçŸ¢é‡åŠ¨ç”»ç­‰ã€‚è¿™äº›æ¸²æŸ“è½¬ç§»åˆ°RenderThreadæ¥åˆ†æ‹…ä¹‹åï¼Œ UI Threadå°±å¯ä»¥åœ¨idleçš„æ—¶å€™åšäº›åˆ«çš„äº‹ï¼Œæ¯”å¦‚RecyclerViewçš„prefechæœºåˆ¶å°±æ˜¯è®¾è®¡åœ¨æ­¤æ—¶å‘ç”Ÿã€‚ **DLOps **ï¼ˆDisplay List Operationsï¼‰ åœ¨GPUå¾—åˆ° Display List åï¼ŒDL ä¼šè½¬æ¢æˆ DLOpsã€‚æ³¨æ„è¿™ä¸ªå˜æˆç»¿è‰²çš„Fillæ“ä½œï¼Œç»è¿‡ä¸€ç³»åˆ—**ä¼˜åŒ–é‡æ’åº(Optimization, Reordering and Batching)**åï¼Œå®ƒçš„ä½ç½®è¢«æåˆ°ä¸Šé¢è·Ÿå…¶ä»–çš„Fillæ”¾åœ¨ä¸€èµ·ã€‚ä¼˜åŒ–(Optimization)åŒ…æ‹¬å°†View setAlpha()ï¼ŒsetHarewareLayer()è¿™äº›æ“ä½œçš„æŒ‡ä»¤ç§»åˆ°æœ€å‰é¢æ‰§è¡Œï¼Œé¿å…åœ¨GPUå†…è¿›è¡Œæ˜‚è´µçš„Stateå˜æ›´æ“ä½œã€‚ é‡æ’åº(Reordering)æ„æ€æ˜¯å½“å­˜åœ¨ä¸€ç³»åˆ—çš„drawText(), drawRect()ä¹‹ç±»æŒ‡ä»¤ç©¿æ’å­˜åœ¨æ—¶ï¼Œç›¸åŒçš„æŒ‡ä»¤ä¼šè¢«æ”¾åœ¨ç›¸é‚»çš„é¡ºåºæ‰§è¡Œã€‚ è€ŒBatchingè¡¨ç¤ºä¸€ä¸ªdrawText callå°±å¯ä»¥æŠŠæ•´ä¸ªå±å¹•ä¸Šçš„éœ€è¦drawTextçš„åœ°æ–¹å…¨éƒ¨åšå®Œã€‚ Clip Rejectåœ¨ Clip Rejectä¸­ï¼Œæˆ‘ä»¬åˆ¤æ–­å“ªäº›æ“ä½œæ˜¯å¿…é¡»çš„ï¼Œæ¢å¥è¯è¯´å“ªäº›æ“ä½œæ˜¯ç›¸å…³è„åŒº(Damaged Area)çš„ã€‚ä¾‹å¦‚ä¸‹å›¾ä¸­ï¼Œåªæœ‰å³è¾¹çš„ä¸‰ä¸ªæ“ä½œæ˜¯è·ŸæŠŠitem2èƒŒæ™¯å˜ç»¿è¿™ä¸ªæ•ˆæœç›¸å…³çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ‰§è¡Œå³è¾¹ä¸‰ä¸ªDLOpsã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ‹¿åˆ°ç¼“å†²åŒºï¼Œè™½ç„¶è¿™é‡Œå†™çš„æ˜¯Get Bufferï¼Œä½†å®é™…æƒ…å†µæ˜¯bufferä¸æ˜¯ç”³è¯·æ¥çš„ï¼Œæœ‰å…³GPUçš„æ“ä½œä¸€æ‰§è¡Œï¼ŒSurfaceFlingerå°±ä¼šåˆ†é…Bufferè¿‡æ¥ï¼Œè®©æˆ‘ä»¬æ‰§è¡Œè¿™äº›æ“ä½œã€‚ ç„¶åæˆ‘ä»¬å‘å‡ºä¸€ç³»åˆ—GLæŒ‡ä»¤æ¥åšç”»èƒŒæ™¯ï¼Œç”»çº¿ï¼Œå¤åˆ¶bitmapä¹‹ç±»çš„å®é™…æ“ä½œã€‚å½“è¿™äº›æ“ä½œå…¨éƒ¨ç»“æŸæ—¶ï¼Œæˆ‘ä»¬ä¼šé€šçŸ¥SurfaceFlingerå»swap bufferã€‚è¿™æ—¶è¿™ä¸€å¸§å°±å®Œæˆäº†ï¼Œå®ƒå°†è¢«æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚åŒæ—¶ï¼Œåœ¨ SurfaceFlinger å’Œ HardwareCompositor ä¸­ä¼šè¿›è¡ŒSurfaceåˆæˆã€‚Status Barï¼ŒSystem Bar å’Œ Contentåœ¨è¿™é‡Œä¼šåˆæˆåœ¨ä¸€èµ·ï¼Œç„¶åå±•ç¤ºåœ¨å±å¹•ä¸Šã€‚ è¡¥å……Composition åœ¨ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­ä¸­ï¼Œéƒ½ç•¥è¿‡äº†compositionè¿™ä¸€æ­¥å…·ä½“é‡Œé¢å‘ç”Ÿäº†ä»€ä¹ˆã€‚åœ¨è¿™èŠ‚æˆ‘ä»¬ä¼šè¿›è¡Œè¿›ä¸€æ­¥è§£é‡Šï¼ŒSurfaceFlingerå’ŒHardwareCompositoræ˜¯æ€ä¹ˆæŠŠä¸åŒçš„windowåˆæˆï¼Œç„¶åå±•ç¤ºåˆ°å±å¹•ä¸Šçš„ã€‚åœ¨æˆ‘ä»¬å¼€å§‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆææ¸…æ¥šä¸‹é¢è¿™ä¸‰ä¸ªæ¦‚å¿µï¼šBufferQueue, Producer, Consumerã€‚ BufferQueueBufferQueueå°±æ˜¯æœ‰è‹¥å¹²ä¸ªBufferçš„Queueã€‚Graphic Bufferå­˜åœ¨åœ¨è¿™é‡Œã€‚ä¸€èˆ¬ä¼šæœ‰1ï½3ä¸ªBufferï¼Œå–å†³äºsetBufferQueueæ—¶çš„é…ç½®ã€‚ Producer å°±å’Œå…¶ä»–æ‰€æœ‰ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å‹ä¸€æ ·ï¼Œå®ƒè´Ÿè´£ç”Ÿäº§å†…å®¹ï¼Œå…·ä½“ä¸€ç‚¹ï¼Œåœ¨è¿™é‡Œå®ƒç”Ÿäº§è¦è¢«å±•ç¤ºåœ¨å±å¹•ä¸Šçš„æ•°æ®ã€‚ è°ƒç”¨dequeBuffer()æ¥ä»BufferQueueè·å¾—é˜Ÿé¦–Bufferã€‚è¿™æ—¶å®ƒå¯ä»¥ç›´æ¥åœ¨Bufferå†™å…¥Pixelæ•°æ®ï¼Œæˆ–è°ƒç”¨OpenGLï¼Œæˆ–è€…ä½¿ç”¨Canvasã€‚ å½“å†…å®¹ç”Ÿäº§å®Œä¹‹åï¼Œè°ƒç”¨queueBuffer()å°†è¿™ä¸ªBufferè¿˜ç»™BufferQueueï¼Œæ”¾åˆ°é˜Ÿå°¾ã€‚ Comsumer æ¶ˆè´¹è€…è¦æ¶ˆè´¹æ•°æ®æ¥å±•ç¤ºåˆ°å±å¹•ä¸Šã€‚ è°ƒç”¨acquireBuffer()æ‹¿åˆ°BufferQueueä¸­ç¬¬ä¸€ä¸ªå¯ç”¨çš„(ä¸€èˆ¬åœ¨é˜Ÿå°¾)Bufferï¼Œè¯»å–é‡Œé¢çš„æ•°æ®ã€‚ å†…å®¹æ¶ˆè´¹å®Œæˆåï¼Œè°ƒç”¨releaseBuffer()ç»™æ”¾å›é˜Ÿé¦–ã€‚ Create Windowå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªWindowæ—¶ï¼Œä¾‹å¦‚activityï¼Œdialogï¼Œpopup windowç­‰ã€‚åœ¨Producerä¾§ï¼ŒWindowManagerä¼šåœ¨å†…éƒ¨åˆ›å»ºä¸ªWindowå¯¹è±¡(è¿™é‡Œä¼šåˆ›å»ºViewRootImpæ¥å…³è”viewçš„æ“ä½œï¼Œsurfaceä¹Ÿæ˜¯è·Ÿwindowä¸€ä¸€ç»‘å®š)ã€‚è€Œåœ¨Consumerä¾§ï¼ŒSurfaceFlingerä¼šç®¡ç†å„ä¸ªSurfaceç›¸å¯¹åº”çš„ç”Ÿæˆä¸€ä¸ªLayerå¯¹è±¡ï¼ˆlayerçš„ä¸œè¥¿ä¹Ÿå¤ªå¤šäº†ï¼‰ã€‚Layeræ˜¯ç³»ç»Ÿç»„ä»¶ä¹‹ä¸€ï¼Œå®ƒåˆ›å»ºå’Œç®¡ç†BufferQueueã€‚ä¹‹ååœ¨Appä¸­ä¼šç”Ÿæˆä¸€ä¸ªSurfaceå¯¹è±¡ã€‚ Surface Surface å¯¹åº”äº†ä¸€å—å±å¹•ç¼“å†²åŒºï¼Œæ¯ä¸ª Window å¯¹åº”ä¸€ä¸ª Surfaceï¼Œä»»ä½• View éƒ½æ˜¯ç”»åœ¨ Surface ä¸Šçš„ï¼Œä¼ ç»Ÿçš„ View å…±äº«ä¸€å—å±å¹•ç¼“å†²åŒºã€‚ æ‰€æœ‰çš„ç»˜åˆ¶å¿…é¡»åœ¨ UI çº¿ç¨‹ä¸­è¿›è¡Œã€‚ æˆ‘ä»¬ä¸èƒ½ç›´æ¥æ“ä½œ Surface å®ä¾‹ï¼Œè¦é€šè¿‡ SurfaceHolderï¼Œåœ¨ SurfaceView ä¸­å¯ä»¥é€šè¿‡ getHolder() æ–¹æ³•è·å–åˆ° SurfaceHolder å®ä¾‹ã€‚ SurfaceViewç®€å•çš„è¯´ SurfaceView å°±æ˜¯ä¸€ä¸ªæœ‰ Surface çš„ Viewï¼ŒSurfaceView æ§åˆ¶è¿™ä¸ª Surface çš„æ ¼å¼å’Œå°ºå¯¸ä»¥åŠç»˜åˆ¶ä½ç½®ã€‚SurfaceViewçš„å®ç°åŸç†ç›¸å½“äºåœ¨Windowçš„Surfaceæ‰“ä¸ªæ´ï¼Œæ¼å‡ºSurfaceViewçš„Surfaceã€‚ä»–ä»¬ä¸¤ä¸ªçš„Surfaceæ˜¯å®Œå…¨ç›¸äº’ç‹¬ç«‹çš„å­˜åœ¨ã€‚ Surface TextureConsumeræ˜¯OpenGLã€‚SurfaceTexture ä¼šåˆ›å»º BufferQueue å’Œ Surfaceã€‚ TextureView åˆ›å»ºSurfaceTextureã€‚ RenderThreadæ˜¯Consumerï¼ŒProducerå¯ä»¥è‡ªå·±é€‰æ‹©ã€‚ å°±åƒä¸ªåŠŸèƒ½æ›´å¼ºå¤§çš„ImageViewä¸€æ ·ï¼Œæ›´æ–°å¾—æ›´å¿«é€Ÿã€‚ åœ¨Android Oæˆ–Nä¹‹å‰çš„ç‰ˆæœ¬ä¸Šï¼ŒTexutreViewæ˜¯æ¯”SurfaceViewæ›´æ¨èä½¿ç”¨çš„ï¼Œå› ä¸ºä¸€æ–¹é¢å¯ä»¥äº«å—æ›´å¿«é€Ÿçš„æ¸²æŸ“ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥é¿å…SurfaceViewçš„ç§ç§é—®é¢˜ï¼Œæ¯”å¦‚ä¸¤ä¸ªWindowé€ æˆçš„æ•ˆç‡æŠ˜æŸï¼Œæ¸²æŸ“ä¸åŒæ­¥å¯¼è‡´ç”»é¢å‰²è£‚ç­‰ã€‚ä½†æ˜¯è¿™äº›é—®é¢˜å·²ç»éƒ½è¢«è§£å†³äº†ï¼Œåœ¨18å¹´è°·æ­ŒI/Oå¤§ä¼šä¸Šæ›´æ¨èåœ¨æ–°ç‰ˆæœ¬çš„å®‰å“ä¸Šä½¿ç”¨SurfaceViewï¼Œè€Œä¸æ˜¯TextureViewã€‚ å›åˆ°æˆ‘ä»¬æœ¬èŠ‚çš„ä¸»é¢˜Compositionä¸Šã€‚æˆ‘ä»¬åœ¨åº”ç”¨ä¸­åˆ›å»ºå¾ˆå¤šwindowï¼Œæ¯ä¸ªéƒ½æœ‰è‡ªå·±çš„layerï¼ŒSurfaceFlingeræ¥æ”¶é›†è¿™äº›layerï¼ŒSurfaceFlingerå…¶å®ä¸æ˜¯ç›´æ¥è·ŸDisplayæ˜¾ç¤ºå™¨äº¤äº’ï¼Œè€Œæ˜¯è·ŸHardware Composeræ²Ÿé€šï¼ˆHWCï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªç¡¬ä»¶æŠ½è±¡å±‚ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ºäº†çœç”µï¼Œé¿å…GPUç›´æ¥åœ¨å±å¹•ä¸Šåˆæˆæ˜¾ç¤ºã€‚ Hardware Composer HALæ˜¯ä¸€ä¸ªç¡¬ä»¶æŠ½è±¡å±‚ç”¨äºç¡®å®šé€šè¿‡å¯ç”¨ç¡¬ä»¶æ¥åˆæˆç¼“å†²åŒºçš„æœ€æœ‰æ•ˆæ–¹æ³•ã€‚ ä½œä¸º HALï¼Œå…¶å®ç°æ˜¯ç‰¹å®šäºè®¾å¤‡çš„ï¼Œè€Œä¸”é€šå¸¸ç”±æ˜¾ç¤ºç¡¬ä»¶åŸå§‹è®¾å¤‡åˆ¶é€ å•† (OEM) å®Œæˆã€‚ å½“æ‚¨è€ƒè™‘ä½¿ç”¨å åŠ å¹³é¢æ—¶ï¼Œå¾ˆå®¹æ˜“å‘ç°è¿™ç§æ–¹æ³•çš„å¥½å¤„ï¼Œå®ƒä¼šåœ¨æ˜¾ç¤ºç¡¬ä»¶ï¼ˆè€Œä¸æ˜¯ GPUï¼‰ä¸­åˆæˆå¤šä¸ªç¼“å†²åŒºã€‚ä¾‹å¦‚ï¼Œå‡è®¾æœ‰ä¸€éƒ¨æ™®é€š Android æ‰‹æœºï¼Œå…¶å±å¹•æ–¹å‘ä¸ºçºµå‘ï¼ŒçŠ¶æ€æ åœ¨é¡¶éƒ¨ï¼Œå¯¼èˆªæ åœ¨åº•éƒ¨ï¼Œå…¶ä»–åŒºåŸŸæ˜¾ç¤ºåº”ç”¨å†…å®¹ã€‚æ¯ä¸ªå±‚çš„å†…å®¹éƒ½åœ¨å•ç‹¬çš„ç¼“å†²åŒºä¸­ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»»ä¸€æ–¹æ³•å¤„ç†åˆæˆï¼š å°†åº”ç”¨å†…å®¹æ¸²æŸ“åˆ°æš‚å­˜ç¼“å†²åŒºä¸­ï¼Œç„¶ååœ¨å…¶ä¸Šæ¸²æŸ“çŠ¶æ€æ ï¼Œå†åœ¨å…¶ä¸Šæ¸²æŸ“å¯¼èˆªæ ï¼Œæœ€åå°†æš‚å­˜ç¼“å†²åŒºä¼ é€åˆ°æ˜¾ç¤ºç¡¬ä»¶ã€‚ å°†ä¸‰ä¸ªç¼“å†²åŒºå…¨éƒ¨ä¼ é€åˆ°æ˜¾ç¤ºç¡¬ä»¶ï¼Œå¹¶æŒ‡ç¤ºå®ƒä»ä¸åŒçš„ç¼“å†²åŒºè¯»å–å±å¹•ä¸åŒéƒ¨åˆ†çš„æ•°æ®ã€‚ åä¸€ç§æ–¹æ³•å¯ä»¥æ˜¾è‘—æé«˜æ•ˆç‡ã€‚æ˜¾ç¤ºå¤„ç†å™¨æ€§èƒ½å·®å¼‚å¾ˆå¤§ã€‚å åŠ å±‚çš„æ•°é‡ï¼ˆæ— è®ºå±‚æ˜¯å¦å¯ä»¥æ—‹è½¬æˆ–æ··åˆï¼‰ä»¥åŠå¯¹å®šä½å’Œé‡å çš„é™åˆ¶å¾ˆéš¾é€šè¿‡ API è¡¨è¾¾ã€‚ä¸ºäº†é€‚åº”è¿™äº›é€‰é¡¹ï¼ŒHWC ä¼šæ‰§è¡Œä»¥ä¸‹è®¡ç®—ï¼š SurfaceFlinger å‘ HWC æä¾›ä¸€ä¸ªå®Œæ•´çš„Layeråˆ—è¡¨ï¼Œå¹¶è¯¢é—®â€œæ‚¨å¸Œæœ›å¦‚ä½•å¤„ç†è¿™äº›å±‚ï¼Ÿâ€ HWC çš„å“åº”æ–¹å¼æ˜¯å°†æ¯ä¸ªå±‚æ ‡è®°ä¸ºFrameBufferæˆ–OVERLAYã€‚ SurfaceFlinger ä¼šå¤„ç†ï¼ˆè®¡ç®—çš„å½“å‰æ˜¾ç¤ºè®¾å¤‡çš„è„åŒºåŸŸDirtyRegionç­‰å·¥ä½œï¼‰æ‰€æœ‰OVERLAYï¼Œå°†è¾“å‡ºbufferä¼ é€åˆ° HWCï¼Œå¹¶è®© HWC å¤„ç†å…¶ä½™éƒ¨åˆ†ã€‚ ä¸¾ä¸ªä¾‹å­ï¼šSurfaceFlingerå‘Šè¯‰HWCç°åœ¨æœ‰3ä¸ªLayerä½ æƒ³æ€ä¹ˆåŠã€‚HWCä¸€çœ‹ï¼Œç¬¬ä¸€ä¸ªç®€å•ï¼ŒOVERLAYå°±å¯ä»¥ï¼Œç¬¬äºŒä¸ªç¬¬ä¸‰ä¸ªæˆ‘å¤„ç†ä¸äº†ï¼Œéœ€è¦GPUå…ˆå¤„ç†ä¸‹æ‰è¡Œï¼Œå°±æ ‡è®°æˆFrameBufferã€‚ æ ‡è®°æˆFrameBufferçš„è¿™ä¸¤å±‚ä¼šè¢«å…ˆè¡Œå¤„ç†ï¼Œå¤„ç†è¿™ä¸¤å±‚æ—¶ï¼Œéœ€è¦å†æ·»åŠ ä¸€å±‚æ¥æ”¾outputï¼Œè¢«ç»¿ç®­å¤´æŒ‡ç€çš„è¿™å±‚å°±æ˜¯outputï¼Œå«åšScratch Layerï¼ˆå«ä»€ä¹ˆåä¸é‡è¦ï¼Œåé¢ä¸ä¼šå‡ºç°ï¼Œåªæ˜¯ä¸ºäº†é¿å…æ··æ·†ï¼‰ã€‚ ç°åœ¨ï¼Œå‰©ä¸‹è¿™ä¸¤å±‚Layerä¼šè¢«SurfaceFlingerç”¨set()ä¼ åˆ°HWCï¼Œä¹‹åè¢«æ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚æ„Ÿå…´è¶£çš„å¤§å®¶å¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤æ‰“å°å‡ºSurfaceFlingerçš„å¤§é‡ä¿¡æ¯ã€‚ 1adb shell dumpsys SurfaceFlinger åˆ°è¿™é‡Œï¼Œæ•´ä¸ªæ¸²æŸ“çš„æµç¨‹å°±å·²ç»ä¸²è”å®Œäº†ã€‚æˆ‘ä»¬åº”ç”¨çš„ UI æ˜¯å¦‚ä½•å˜æˆå±å¹•ä¸Šçš„åƒç´ çš„ï¼Œç›¸ä¿¡å¤§å®¶çœ‹åˆ°è¿™é‡Œå·²ç»æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„æ¦‚å¿µã€‚äº†è§£è¿™äº›çš„å·¥ä½œåŸç†å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¼„æ¸…æ¥šå¦‚ä½•ä¸ºAppè·å¾—æœ€ä½³æ€§èƒ½ã€‚","link":"/2022/03/10/RenderBlock/"},{"title":"VirtualMemory","text":"ç®€è¿°ï¼šcpuä»¥è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡MMUæŸ¥è¯¢ é¡µè¡¨ï¼Œ æ˜ å°„ é«˜4ä½(é¡µå·) åˆ°é¡µè¡¨ä¸­æŸ¥è¯¢å¾—åˆ° é¡µæ¡†å· å’Œ æœ‰æ•ˆä½ã€‚ å¦‚æœæœ‰æ•ˆä½ ä¸º1ï¼Œ åˆ™ç›´æ¥å°†é¡µæ¡†å·å’Œè™šæ‹Ÿå†…å­˜ä½12ä½ï¼ˆåç§»é‡ï¼‰ç»„åˆè¿”å›å³ä¸ºç‰©ç†åœ°å€ å¦‚æœæœ‰æ•ˆä½ä¸º0ï¼ˆæ„å‘³ç€è¯¥é¡µè¡¨é¡¹ä¸å­˜åœ¨MMUä¸­ï¼Œå³æœªå‘MMUæ³¨å†Œæˆ–ç›¸å…³é¡µæœªè¢«åŠ è½½å¦‚å†…å­˜ä¸­ï¼‰ï¼Œåˆ™äº§ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œç³»ç»Ÿå¤„ç†ä¸­æ–­ï¼Œé€šè¿‡å†…å­˜ç½®æ¢swapç®—æ³•ï¼ˆLRUï¼ŒOPTï¼ŒFIFOï¼‰ï¼Œä¹‹åé‡èµ°ä¸€éä»¥ä¸Šé€»è¾‘ è™šæ‹Ÿå†…å­˜æœºåˆ¶è®¡ç®—æœºçš„å­˜å‚¨ç³»ç»Ÿ ä¸ºä»€ä¹ˆè¦æœ‰è™šæ‹Ÿå†…å­˜ï¼Ÿåœ¨æ—©æœŸçš„è®¡ç®—æœºä¸­ï¼Œæ˜¯æ²¡æœ‰==è™šæ‹Ÿå†…å­˜==çš„æ¦‚å¿µçš„ã€‚æˆ‘ä»¬è¦è¿è¡Œä¸€ä¸ªç¨‹åºï¼Œä¼šæŠŠç¨‹åºå…¨éƒ¨è£…å…¥å†…å­˜ï¼Œç„¶åè¿è¡Œã€‚å½“è¿è¡Œå¤šä¸ªç¨‹åºæ—¶ï¼Œç»å¸¸ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š è¿›ç¨‹åœ°å€ç©ºé—´ä¸éš”ç¦»ï¼Œæ²¡æœ‰æƒé™ä¿æŠ¤ã€‚ç”±äºç¨‹åºéƒ½æ˜¯ç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼Œæ‰€ä»¥ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ä¿®æ”¹å…¶ä»–è¿›ç¨‹çš„å†…å­˜æ•°æ®ï¼Œ ç”šè‡³ä¿®æ”¹å†…æ ¸åœ°å€ç©ºé—´ä¸­çš„æ•°æ®ã€‚ å†…å­˜ä½¿ç”¨æ•ˆç‡ä½ å½“å†…å­˜ç©ºé—´ä¸è¶³æ—¶ï¼Œè¦å°†å…¶ä»–ç¨‹åºæš‚æ—¶æ‹·è´åˆ°ç¡¬ç›˜ï¼Œç„¶åå°†æ–°çš„ç¨‹åºè£…å…¥å†…å­˜è¿è¡Œã€‚ç”±äºå¤§é‡çš„æ•°æ®è£…å…¥è£…å‡ºï¼Œå†…å­˜ä½¿ç”¨æ•ˆç‡ä¼šååˆ†ä½ä¸‹ã€‚ ç¨‹åºè¿è¡Œçš„åœ°å€ä¸ç¡®å®š å› ä¸ºå†…å­˜åœ°å€æ˜¯éšæœºåˆ†é…çš„ï¼Œæ‰€ä»¥ç¨‹åºè¿è¡Œçš„åœ°å€ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ã€‚ è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„4Gå†…å­˜ç©ºé—´ è™šæ‹Ÿå†…å­˜ç©ºé—´é€šè¿‡MMUæ¥å’ŒçœŸå®çš„ç‰©ç†å†…å­˜äº§ç”Ÿè”ç³» è®¡ç®—æœºæ˜æ˜æ²¡æœ‰é‚£ä¹ˆå¤šå†…å­˜ï¼ˆnä¸ªè¿›ç¨‹çš„è¯å°±éœ€è¦n*4Gå†…å­˜ï¼‰ è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜å¦‚ä½•å»ºç«‹èµ·æ¥è”ç³»çš„å‘¢ï¼ŸLinuxçš„è™šæ‹Ÿå†…å­˜æŠ€æœ¯LinuxæŠŠè™šå­˜ç©ºé—´åˆ†æˆè‹¥å¹²ä¸ªå¤§å°ç›¸ç­‰çš„å­˜å‚¨åˆ†åŒºï¼ŒLinuxæŠŠè¿™æ ·çš„åˆ†åŒºå«åšé¡µã€‚ä¸ºäº†æ¢å…¥ã€æ¢å‡ºçš„æ–¹ä¾¿ï¼Œç‰©ç†å†…å­˜ä¹Ÿå°±å¾—æŒ‰å¤§å°åˆ†æˆè‹¥å¹²ä¸ªå—ã€‚ç”±äºç‰©ç†å†…å­˜ä¸­çš„å—ç©ºé—´æ˜¯ç”¨æ¥å®¹çº³è™šå­˜é¡µçš„å®¹å™¨ï¼Œæ‰€ä»¥ç‰©ç†å†…å­˜ä¸­çš„å—å«åšé¡µæ¡†ã€‚é¡µä¸é¡µæ¡†æ˜¯Linuxå®ç°è™šæ‹Ÿå†…å­˜æŠ€æœ¯çš„åŸºç¡€ã€‚ åˆ†é¡µå’Œåˆ†è¡¨æˆ‘ä»¬çŸ¥é“ç³»ç»Ÿé‡Œçš„åŸºæœ¬å•ä½éƒ½æ˜¯ Byte å­—èŠ‚ï¼Œå¦‚æœå°†æ¯ä¸€ä¸ªè™šæ‹Ÿå†…å­˜çš„ Byte éƒ½å¯¹åº”åˆ°ç‰©ç†å†…å­˜çš„åœ°å€ï¼Œæ¯ä¸ªæ¡ç›®æœ€å°‘éœ€è¦ 8å­—èŠ‚ï¼ˆ32ä½è™šæ‹Ÿåœ°å€-&gt;32ä½ç‰©ç†åœ°å€ï¼‰ï¼Œåœ¨ 4G å†…å­˜çš„æƒ…å†µä¸‹ï¼Œå°±éœ€è¦ 32GB çš„ç©ºé—´æ¥å­˜æ”¾å¯¹ç…§è¡¨ï¼Œé‚£ä¹ˆè¿™å¼ è¡¨å°±å¤§å¾—çœŸæ­£çš„ç‰©ç†åœ°å€ä¹Ÿæ”¾ä¸ä¸‹äº†ï¼Œäºæ˜¯æ“ä½œç³»ç»Ÿå¼•å…¥äº† é¡µï¼ˆPageï¼‰çš„æ¦‚å¿µã€‚ åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°†æ•´ä¸ªç‰©ç†å†…å­˜ä»¥ 4K ä¸ºå•ä½ï¼Œåˆ’åˆ†ä¸ºå„ä¸ªé¡µã€‚ä¹‹åè¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œéƒ½ä»¥é¡µä¸ºå•ä½ï¼Œé‚£ä¹ˆè™šæ‹Ÿå†…å­˜é¡µå¯¹åº”ç‰©ç†å†…å­˜é¡µçš„æ˜ å°„è¡¨å°±å¤§å¤§å‡å°äº†ï¼Œ4G å†…å­˜ï¼Œåªéœ€è¦ 8M çš„æ˜ å°„è¡¨å³å¯ï¼Œä¸€äº›è¿›ç¨‹æ²¡æœ‰ä½¿ç”¨åˆ°çš„è™šæ‹Ÿå†…å­˜ï¼Œä¹Ÿå¹¶ä¸éœ€è¦ä¿å­˜æ˜ å°„å…³ç³»ï¼Œè€Œä¸”Linux è¿˜ä¸ºå¤§å†…å­˜è®¾è®¡äº†å¤šçº§é¡µè¡¨ï¼Œå¯ä»¥è¿›ä¸€æ­¥å‡å°‘äº†å†…å­˜æ¶ˆè€—ã€‚æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„è¡¨ï¼Œå°±è¢«ç§°ä¸ºé¡µè¡¨ã€‚ è™šæ‹Ÿå†…å­˜çš„é¡µã€ç‰©ç†å†…å­˜çš„é¡µæ¡†åŠé¡µè¡¨ ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜è¢«åˆ†æˆäº†é¡µæ¡†ä¸é¡µä¹‹åï¼Œå…¶å­˜å‚¨å•å…ƒåŸæ¥çš„åœ°å€éƒ½è¢«è‡ªç„¶åœ°åˆ†æˆäº†ä¸¤æ®µï¼Œå¹¶ä¸”è¿™ä¸¤æ®µå„è‡ªä»£è¡¨ç€ä¸åŒçš„æ„ä¹‰ï¼šé«˜ä½æ®µåˆ†åˆ«å«åšé¡µæ¡†ç å’Œé¡µç ï¼Œå®ƒä»¬æ˜¯è¯†åˆ«é¡µæ¡†å’Œé¡µçš„ç¼–ç ï¼›ä½ä½æ®µåˆ†åˆ«å«åšé¡µæ¡†åç§»é‡å’Œé¡µå†…åç§»é‡ï¼Œå®ƒä»¬æ˜¯å­˜å‚¨å•å…ƒåœ¨é¡µæ¡†å’Œé¡µå†…çš„åœ°å€ç¼–ç ã€‚ä¸‹å›¾å°±æ˜¯ä¸¤æ®µè™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜åˆ†é¡µä¹‹åçš„æƒ…å†µï¼š ä¸ºäº†ä½¿ç³»ç»Ÿå¯ä»¥æ­£ç¡®çš„è®¿é—®è™šå­˜é¡µåœ¨å¯¹åº”é¡µæ¡†ä¸­çš„æ˜ åƒï¼Œåœ¨æŠŠä¸€ä¸ªé¡µæ˜ å°„åˆ°æŸä¸ªé¡µæ¡†ä¸Šçš„åŒæ—¶ï¼Œå°±å¿…é¡»æŠŠé¡µç å’Œå­˜æ”¾è¯¥é¡µæ˜ åƒçš„é¡µæ¡†ç å¡«å…¥ä¸€ä¸ªå«åšé¡µè¡¨çš„è¡¨é¡¹ä¸­ã€‚è¿™ä¸ªé¡µè¡¨å°±æ˜¯ä¹‹å‰æåˆ°çš„æ˜ å°„è®°å½•è¡¨ã€‚ä¸€ä¸ªé¡µè¡¨çš„ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š é¡µæ¨¡å¼ä¸‹ï¼Œè™šæ‹Ÿåœ°å€ã€ç‰©ç†åœ°å€è½¬æ¢å…³ç³»çš„ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š ä¹Ÿå°±æ˜¯è¯´ï¼šå¤„ç†å™¨é‡åˆ°çš„åœ°å€éƒ½æ˜¯è™šæ‹Ÿåœ°å€ã€‚è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€éƒ½åˆ†æˆé¡µç ï¼ˆé¡µæ¡†ç ï¼‰å’Œåç§»å€¼ä¸¤éƒ¨åˆ†ã€‚åœ¨ç”±è™šæ‹Ÿåœ°å€è½¬åŒ–æˆç‰©ç†åœ°å€çš„è¿‡ç¨‹ä¸­ï¼Œåç§»å€¼ä¸å˜ã€‚è€Œé¡µç å’Œé¡µæ¡†ç ä¹‹é—´çš„æ˜ å°„å°±åœ¨ä¸€ä¸ªæ˜ å°„è®°å½•è¡¨â€”â€”é¡µè¡¨ä¸­ã€‚ é¡µè¡¨å…±äº«åœ¨å¤šç¨‹åºç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸æœ‰å¤šä¸ªç¨‹åºéœ€è¦å…±äº«åŒä¸€æ®µä»£ç æˆ–æ•°æ®çš„æƒ…å†µã€‚åœ¨åˆ†é¡µç®¡ç†çš„å­˜å‚¨å™¨ä¸­ï¼Œè¿™ä¸ªäº‹æƒ…å¾ˆå¥½åŠï¼šè®©å¤šä¸ªç¨‹åºå…±äº«åŒä¸€ä¸ªé¡µé¢å³å¯ã€‚ å…·ä½“çš„æ–¹æ³•æ˜¯ï¼šä½¿è¿™äº›ç›¸å…³ç¨‹åºçš„è™šæ‹Ÿç©ºé—´çš„é¡µé¢åœ¨é¡µè¡¨ä¸­æŒ‡å‘å†…å­˜ä¸­çš„åŒä¸€ä¸ªé¡µæ¡†ã€‚è¿™æ ·ï¼Œå½“ç¨‹åºè¿è¡Œå¹¶è®¿é—®è¿™äº›ç›¸å…³é¡µé¢æ—¶ï¼Œå°±éƒ½æ˜¯å¯¹åŒä¸€ä¸ªé¡µæ¡†ä¸­çš„é¡µé¢è¿›è¡Œè®¿é—®ï¼Œè€Œè¯¥é¡µæ¡†ä¸­çš„é¡µå°±è¢«è¿™äº›ç¨‹åºæ‰€å…±äº«ã€‚ä¸‹å›¾æ˜¯3ä¸ªç¨‹åºå…±äº«ä¸€ä¸ªé¡µé¢çš„ä¾‹å­ï¼š è™šæ‹Ÿå†…å­˜å¸¦æ¥çš„å¥½å¤„è¿›ç¨‹å†…å­˜ç®¡ç†å®ƒæœ‰åŠ©äºè¿›ç¨‹è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œä¸»è¦ä½“ç°åœ¨ï¼š å†…å­˜å®Œæ•´æ€§ï¼šç”±äºè™šæ‹Ÿå†…å­˜å¯¹è¿›ç¨‹çš„â€æ¬ºéª—â€ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½è®¤ä¸ºè‡ªå·±è·å–çš„å†…å­˜æ˜¯ä¸€å—è¿ç»­çš„åœ°å€ã€‚æˆ‘ä»¬åœ¨ç¼–å†™åº”ç”¨ç¨‹åºæ—¶ï¼Œå°±ä¸ç”¨è€ƒè™‘å¤§å—åœ°å€çš„åˆ†é…ï¼Œæ€»æ˜¯è®¤ä¸ºç³»ç»Ÿæœ‰è¶³å¤Ÿçš„å¤§å—å†…å­˜å³å¯ã€‚ å®‰å…¨ï¼šç”±äºè¿›ç¨‹è®¿é—®å†…å­˜æ—¶ï¼Œéƒ½è¦é€šè¿‡é¡µè¡¨æ¥å¯»å€ï¼Œæ“ä½œç³»ç»Ÿåœ¨é¡µè¡¨çš„å„ä¸ªé¡¹ç›®ä¸Šæ·»åŠ å„ç§è®¿é—®æƒé™æ ‡è¯†ä½ï¼Œå°±å¯ä»¥å®ç°å†…å­˜çš„æƒé™æ§åˆ¶ã€‚ æ•°æ®å…±äº«é€šè¿‡è™šæ‹Ÿå†…å­˜æ›´å®¹æ˜“å®ç°å†…å­˜å’Œæ•°æ®çš„å…±äº«ã€‚ åœ¨è¿›ç¨‹åŠ è½½ç³»ç»Ÿåº“æ—¶ï¼Œæ€»æ˜¯å…ˆåˆ†é…ä¸€å—å†…å­˜ï¼Œå°†ç£ç›˜ä¸­çš„åº“æ–‡ä»¶åŠ è½½åˆ°è¿™å—å†…å­˜ä¸­ï¼Œåœ¨ç›´æ¥ä½¿ç”¨ç‰©ç†å†…å­˜æ—¶ï¼Œç”±äºç‰©ç†å†…å­˜åœ°å€å”¯ä¸€ï¼Œå³ä½¿ç³»ç»Ÿå‘ç°åŒä¸€ä¸ªåº“åœ¨ç³»ç»Ÿå†…åŠ è½½äº†ä¸¤æ¬¡ï¼Œä½†æ¯ä¸ªè¿›ç¨‹æŒ‡å®šçš„åŠ è½½å†…å­˜ä¸ä¸€æ ·ï¼Œç³»ç»Ÿä¹Ÿæ— èƒ½ä¸ºåŠ›ã€‚ è€Œåœ¨ä½¿ç”¨è™šæ‹Ÿå†…å­˜æ—¶ï¼Œç³»ç»Ÿåªéœ€è¦å°†è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åœ°å€æŒ‡å‘åº“æ–‡ä»¶æ‰€åœ¨çš„ç‰©ç†å†…å­˜åœ°å€å³å¯ã€‚å¦‚ä¸Šæ–‡å›¾ä¸­æ‰€ç¤ºï¼Œè¿›ç¨‹ P1 å’Œ P2 çš„ B åœ°å€éƒ½æŒ‡å‘äº†ç‰©ç†åœ°å€ Cã€‚ è€Œé€šè¿‡ä½¿ç”¨è™šæ‹Ÿå†…å­˜ä½¿ç”¨å…±äº«å†…å­˜ä¹Ÿå¾ˆç®€å•ï¼Œç³»ç»Ÿåªéœ€è¦å°†å„ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åœ°å€æŒ‡å‘ç³»ç»Ÿåˆ†é…çš„å…±äº«å†…å­˜åœ°å€å³å¯ã€‚ SWAPè™šæ‹Ÿå†…å­˜å¯ä»¥è®©å¸®è¿›ç¨‹â€æ‰©å……â€å†…å­˜ã€‚ æˆ‘ä»¬å‰æ–‡æåˆ°äº†è™šæ‹Ÿå†…å­˜é€šè¿‡ç¼ºé¡µä¸­æ–­ä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†å†…å­˜ï¼Œå†…å­˜æ€»æ˜¯æœ‰é™çš„ï¼Œå¦‚æœæ‰€æœ‰çš„ç‰©ç†å†…å­˜éƒ½è¢«å ç”¨äº†æ€ä¹ˆåŠå‘¢ï¼Ÿ Linux æå‡º SWAP çš„æ¦‚å¿µï¼ŒLinux ä¸­å¯ä»¥ä½¿ç”¨ SWAP åˆ†åŒºï¼Œåœ¨åˆ†é…ç‰©ç†å†…å­˜ï¼Œä½†å¯ç”¨å†…å­˜ä¸è¶³æ—¶ï¼Œå°†æš‚æ—¶ä¸ç”¨çš„å†…å­˜æ•°æ®å…ˆæ”¾åˆ°ç£ç›˜ä¸Šï¼Œè®©æœ‰éœ€è¦çš„è¿›ç¨‹å…ˆä½¿ç”¨ï¼Œç­‰è¿›ç¨‹å†éœ€è¦ä½¿ç”¨è¿™äº›æ•°æ®æ—¶ï¼Œå†å°†è¿™äº›æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œé€šè¿‡è¿™ç§â€äº¤æ¢â€æŠ€æœ¯ï¼ŒLinux å¯ä»¥è®©è¿›ç¨‹ä½¿ç”¨æ›´å¤šçš„å†…å­˜ã€‚ å®è·µå’Œç ”ç©¶éƒ½è¯æ˜ï¼šä¸€ä¸ªåº”ç”¨ç¨‹åºæ€»æ˜¯é€æ®µè¢«è¿è¡Œçš„ï¼Œè€Œä¸”åœ¨ä¸€æ®µæ—¶é—´å†…ä¼šç¨³å®šè¿è¡Œåœ¨æŸä¸€æ®µç¨‹åºé‡Œã€‚ è¿™ä¹Ÿå°±å‡ºç°äº†ä¸€ä¸ªæ–¹æ³•ï¼šå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæŠŠè¦è¿è¡Œçš„é‚£ä¸€æ®µç¨‹åºä»è¾…å­˜å¤åˆ¶åˆ°å†…å­˜ä¸­æ¥è¿è¡Œï¼Œè€Œå…¶ä»–æš‚æ—¶ä¸è¿è¡Œçš„ç¨‹åºæ®µå°±è®©å®ƒä»ç„¶ç•™åœ¨è¾…å­˜ã€‚ å½“éœ€è¦æ‰§è¡Œå¦ä¸€ç«¯å°šæœªåœ¨å†…å­˜çš„ç¨‹åºæ®µï¼ˆå¦‚ç¨‹åºæ®µ2ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå°±å¯ä»¥æŠŠå†…å­˜ä¸­ç¨‹åºæ®µ1çš„å‰¯æœ¬å¤åˆ¶å›è¾…å­˜ï¼Œåœ¨å†…å­˜è…¾å‡ºå¿…è¦çš„ç©ºé—´åï¼Œå†æŠŠè¾…å­˜ä¸­çš„ç¨‹åºæ®µ2å¤åˆ¶åˆ°å†…å­˜ç©ºé—´æ¥æ‰§è¡Œå³å¯ï¼š åœ¨è®¡ç®—æœºæŠ€æœ¯ä¸­ï¼ŒæŠŠå†…å­˜ä¸­çš„ç¨‹åºæ®µå¤åˆ¶å›è¾…å­˜çš„åšæ³•å«åšâ€œæ¢å‡ºâ€ï¼Œè€ŒæŠŠè¾…å­˜ä¸­ç¨‹åºæ®µæ˜ å°„åˆ°å†…å­˜çš„åšæ³•å«åšâ€œæ¢å…¥â€ã€‚ç»è¿‡ä¸æ–­æœ‰ç›®çš„çš„æ¢å…¥å’Œæ¢å‡ºï¼Œå¤„ç†å™¨å°±å¯ä»¥è¿è¡Œä¸€ä¸ªå¤§äºå®é™…ç‰©ç†å†…å­˜çš„åº”ç”¨ç¨‹åºäº†ã€‚ from: https://mp.weixin.qq.com/s/-1DHzkM--xgKIU1g71eQzQ åˆ†æ®µå’Œåˆ†é¡µï¼šç°ä»£æ“ä½œç³»ç»Ÿç®¡ç†å†…å­˜ï¼Œåˆ°åº•æ˜¯åˆ†æ®µè¿˜æ˜¯åˆ†é¡µï¼Œæ®µå¯„å­˜å™¨è¿˜æœ‰ç”¨å—ï¼Ÿ ç®€è¿°ï¼šç°åœ¨åŸºæœ¬ä¸Šéƒ½æ˜¯åˆ†é¡µäº†ï¼Œåˆ†æ®µç®¡ç†åå­˜å®äº¡ æ— è®ºæ˜¯åˆ†æ®µè¿˜æ˜¯åˆ†é¡µï¼Œè¿™æ˜¯CPUè‡ªèº«çš„æœºåˆ¶ï¼Œæ“ä½œç³»ç»Ÿåœ¨ç®¡ç†å†…å­˜æ—¶ç»•ä¸è¿‡å»ï¼Œä½†é€šè¿‡å·§å¦™çš„åˆ†æ®µå†…å­˜è®¾è®¡ï¼Œç›¸å½“äºæŠŠåˆ†æ®µçš„æ¦‚å¿µç»™å±è”½äº†ï¼Œç”±æ­¤é€ æˆäº†æˆ‘ä»¬å¹³æ—¶åœ¨è°ˆè®ºè™šæ‹Ÿåœ°å€ç¿»è¯‘æ—¶ï¼Œå¿˜è®°äº†æ®µçš„å­˜åœ¨ï¼Œä½†ä¸ä»£è¡¨å®ƒçœŸçš„ä¸å­˜åœ¨ã€‚ CPUç¡¬ä»¶å±‚é¢çš„å·¥ä½œå¿…é¡»æ˜¯ç»“åˆåˆ†æ®µ+åˆ†é¡µçš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œæ“ä½œç³»ç»Ÿæ˜¯è½¯ä»¶ç»•ä¸è¿‡å»ï¼Œæ‰€ä»¥é‡‡å–äº†ä¸Šé¢çš„æ–¹å¼åº”ä»˜CPUäº†äº‹ã€‚","link":"/2021/12/13/VirtualMemory/"},{"title":"Window","text":"https://www.cnblogs.com/huan89/p/14111360.html ä»æ¥éƒ½æ²¡ä»€ä¹ˆWindowï¼Œæœ‰çš„åªæ˜¯ä¸€ä¸ªä¸ªViewæ ‘ï¼Œæ¯ä¸ªçª—å£(activity/dialog/popupWindow)éƒ½æ˜¯ä¸€ä¸ªviewæ ‘ï¼ˆä»£ç ä¸­éƒ½æ˜¯å«addViewï¼Œç›´åˆ°WMSä¸­æ‰å«addWindowï¼‰ï¼Œåœ¨éœ€è¦æ˜¾ç¤ºæ—¶è¢«æ·»åŠ è¿›WMSä¸­ï¼Œæœ€åé€šè¿‡surfalceFlingeråˆæˆåæ¸²æŸ“åˆ°å±å¹•ä¸­ã€‚ æ¯ä¸ªçª—å£éƒ½å¯¹åº”ä¸€ä¸ªTokenï¼Œä¸€ä¸ªåº”ç”¨åªå¯¹åº”ä¸€ä¸ªsessionã€‚ ä»Windowè§†è§’çœ‹ActivityStartActivityç®€è¿°ï¼šé¦–å…ˆå›é¡¾ä¸€ä¸‹ï¼Œactivityæ˜¯æ€ä¹ˆæ˜¾ç¤ºå‡ºæ¥çš„ï¼š ä¸ºactivityåˆ›å»ºPhoneWindowå’ŒWindowManager(WindowManagerImpl)å¯¹è±¡ åœ¨handleLaunchActivity()è¢«å›è°ƒçš„æ—¶å€™ï¼Œè°ƒç”¨WindowManagerGlobal.initialize();åˆå§‹åŒ–WindoWindowManagerGlobalï¼Œä¹‹å Application app = r.packageInfo.makeApplication(false, mInstrumentation);åˆ›å»ºApplicationï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆ›å»ºè¿‡Applicationï¼‰ï¼Œç„¶åè°ƒç”¨activity.attach()ï¼Œè¿™é‡Œé¢ mWindow = new PhoneWindow(this, window, activityConfigCallback);åˆå§‹åŒ–PhoneWindowå¹¶ç»™å®ƒè®¾ç½®WindowManagerï¼Œ 1234mWindow.setWindowManager( (WindowManager)context.getSystemService(Context.WINDOW_SERVICE), mToken, mComponent.flattenToString(), (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0); Window.setWindowManager()ä¸­é€šè¿‡WMSåˆ›å»ºäº†WindowManagerImplï¼ˆå…¶å®å°±æ˜¯ä¸ªä¸€ç™¾å¤šè¡Œä»£ç çš„å£³ï¼‰ã€‚ ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯åˆ©ç”¨ç³»ç»ŸæœåŠ¡çš„windowManageræ¥åˆ›å»ºæ–°çš„windowManagerImplï¼Œå› è€Œè¿™ä¸ªåº”ç”¨æ‰€æœ‰çš„WindowManagerImpléƒ½æ˜¯åŒä¸ªå†…æ ¸windowManagerï¼Œè€Œåˆ›å»ºå‡ºæ¥çš„ä»…ä»…æ˜¯åŒ…äº†ä¸ªå£³ã€‚ setContentViewå®é™…ä¸Šæ‰çš„æ˜¯getWindow()ï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢çš„PhoneWindowï¼‰çš„setContentView()ï¼Œå…¶ä¸­è°ƒç”¨PhoneWindow.installDecor()ï¼Œ é¦–å…ˆçœ‹decorViewåˆ›å»ºäº†æ²¡æœ‰ï¼Œæ²¡æœ‰çš„è¯åˆ›å»ºDecorView æŠŠå¸ƒå±€åŠ è½½åˆ°DecorViewä¸­ï¼ˆLayoutInflateråŠ è½½é¢„è®¾æ¨¡æ¿å¸ƒå±€ï¼Œè§ä¸‹ï¼‰ DecorViewæ˜¯åœ¨PhoneWindowä¸­é¢„è®¾å¥½çš„ä¸€ä¸ªå¸ƒå±€ï¼Œè¿™ä¸ªå¸ƒå±€é•¿è¿™æ ·ï¼š ä»–æ˜¯ä¸€ä¸ªå‚ç›´æ’åˆ—çš„å¸ƒå±€ï¼Œä¸Šé¢æ˜¯ActionBarï¼Œä¸‹é¢æ˜¯ContentViewï¼Œä»–æ˜¯ä¸€ä¸ªFrameLayoutã€‚æˆ‘ä»¬çš„Activityå¸ƒå±€å°±åŠ è½½åˆ°ContentViewé‡Œè¿›è¡Œæ˜¾ç¤ºã€‚æ‰€ä»¥Decorviewæ˜¯Activityå¸ƒå±€æœ€é¡¶å±‚çš„viewGroupã€‚ // DecorViewåˆ›å»ºå®Œæˆäº†ï¼Œä½†è¿˜ç¼ºå°‘äº†æœ€é‡è¦çš„ä¸€æ­¥ï¼šæŠŠDecorViewä½œä¸ºwindowæ·»åŠ åˆ°å±å¹•ä¸Šã€‚ åœ¨handleResumeActivityä¸­ï¼Œæ‰§è¡Œäº†æœ€åçš„ wm.addView(mDecor, getWindow().getAttributes()); 123456789101112131415161718public void handleResumeActivity(IBinder token, boolean finalStateRequest, boolean isForward, String reason) { // è°ƒç”¨Activityçš„onResumeæ–¹æ³• final ActivityClientRecord r = performResumeActivity(token, finalStateRequest, reason); ... // è®©decorViewæ˜¾ç¤ºåˆ°å±å¹•ä¸Š if (r.activity.mVisibleFromClient) { r.activity.makeVisible();} void makeVisible() { if (!mWindowAdded) { ViewManager wm = getWindowManager(); wm.addView(mDecor, getWindow().getAttributes()); mWindowAdded = true; } mDecor.setVisibility(View.VISIBLE);} ç›´æ¥è°ƒç”¨WindowManagerImplçš„addViewæ–¹æ³•æ¥å§decorViewæ·»åŠ åˆ°å±å¹•ä¸Šï¼Œè‡³æ­¤ï¼Œæˆ‘ä»¬çš„Activityç•Œé¢å°±ä¼šæ˜¾ç¤ºåœ¨å±å¹•ä¸Šäº†ã€‚ è¿›ä¸€æ­¥éœ€è¦çœ‹WindowManagerImpl.addViewä¹‹åæ˜¯æ€ä¹ˆå°†Viewï¼ˆå³Windowï¼‰æ·»åŠ å…¥å±å¹•çš„ wm.addView(mDecor, getWindow().getAttributes());å…¶ä¸­wmæ˜¯WindowManagerImplå®ä¾‹ï¼ŒWindowManagerImpl.addViewå…¶å®æ˜¯é€šè¿‡æ¡¥æ¥ï¼Œè°ƒç”¨WindowManagerGlobalçš„å…¨å±€å•ä¾‹çš„æ–¹æ³•WindowManagerGlobal.addViewï¼Œè¯¥æ–¹æ³•ä¸­ä¼šæ–°å»ºä¸€ä¸ªViewRootImplï¼Œç„¶åå°†å…¥å‚çš„decorViewã€æ–°å»ºçš„ViewRootImpç­‰åŠ å…¥è‡ªèº«ç»´æŠ¤çš„mViewsã€mRootsåˆ—è¡¨ä¸­ï¼ŒåŒæ—¶å°†DecorViewæ³¨å…¥ViewRootImplroot.setView(view, wparams, panelParentView) 1234567891011121314151617181920212223242526272829303132WindowMangerGlobal.clssç»´æŠ¤ç€WMSå®ä¾‹sWindowManagerServiceå’Œä»¥ä¸‹åˆ—è¡¨ //åº”ç”¨æ‰€æœ‰çš„decorViewprivate final ArrayList&lt;View&gt; mViews = new ArrayList&lt;View&gt;();//åº”ç”¨æ‰€æœ‰çš„ViewRootImplprivate final ArrayList&lt;ViewRootImpl&gt; mRoots = new ArrayList&lt;ViewRootImpl&gt;();//åº”ç”¨æ‰€æœ‰çš„WindowManager.LayoutParamsprivate final ArrayList&lt;WindowManager.LayoutParams&gt; mParams = new ArrayList&lt;WindowManager.LayoutParams&gt;();public void addView(View view, ViewGroup.LayoutParams params, Display display, Window parentWindow) { //... ä¸»è¦æ˜¯æ ¡éªŒå‚æ•°å’Œè°ƒæ•´å­çª—å£çš„å‚æ•° synchronized (mLock) { ... // è¿™é‡Œæ–°å»ºäº†ä¸€ä¸ªviewRootImplï¼Œå¹¶è®¾ç½®å‚æ•° root = new ViewRootImpl(view.getContext(), display); view.setLayoutParams(wparams); // æ·»åŠ åˆ°windowManagerGlobalçš„ä¸‰ä¸ªé‡è¦listä¸­ï¼Œæ¯ä¸€ä¸ªwindowæ‰€å¯¹åº”çš„è¿™ä¸‰ä¸ªå¯¹è±¡éƒ½ä¼šä¿å­˜åœ¨è¿™é‡Œï¼Œä¹‹åå¯¹windowçš„ä¸€äº›æ“ä½œå°±å¯ä»¥ç›´æ¥æ¥è¿™é‡Œå–å¯¹è±¡äº†ã€‚å½“windowè¢«åˆ é™¤çš„æ—¶å€™ï¼Œè¿™äº›å¯¹è±¡ä¹Ÿä¼šè¢«ä»listä¸­ç§»é™¤ã€‚ mViews.add(view); mRoots.add(root); mParams.add(wparams); // æœ€åé€šè¿‡viewRootImplæ¥æ·»åŠ window try { root.setView(view, wparams, panelParentView); } ... } } â€‹ 5. ViewRootImpl.setView()å°†è°ƒç”¨åˆ° 1234res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes, getHostVisibility(), mDisplay.getDisplayId(), mWinFrame, mAttachInfo.mContentInsets, mAttachInfo.mStableInsets, mAttachInfo.mOutsets, mAttachInfo.mDisplayCutout, mInputChannel); è¿™ä¸ªmWindowSessionæ¥è‡ªäºæ„é€ å™¨çš„å…¥å‚ï¼Œæ˜¯ç”±WindowManagerGlobal.getWindowSessionä¸­æ¥çš„ï¼Œ 123456789101112131415public static IWindowSession getWindowSession() { synchronized (WindowManagerGlobal.class) { if (sWindowSession == null) { try { ... sWindowSession = windowManager.openSession( new IWindowSessionCallback.Stub() { ... }); } ... } return sWindowSession; }} å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªsessionæ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ªåº”ç”¨çš„æ‰€æœ‰viewRootImplçš„windowSessionéƒ½æ˜¯åŒä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ªwindowSessionã€‚ Session.addToDisplayå®é™…ä¸Šèµ°çš„æ˜¯WMSçš„addWindowæ–¹æ³•ï¼Œåé¢çš„é€»è¾‘å°±äº¤ç»™WMSå»å¤„ç†äº†ï¼ŒWMSå°±ä¼šåˆ›å»ºwindowï¼Œç„¶åç»“åˆå‚æ•°è®¡ç®—windowçš„é«˜åº¦ç­‰ç­‰ï¼Œæœ€åä½¿ç”¨viewRootImplè¿›è¡Œç»˜åˆ¶ã€‚ windowçš„æ·»åŠ è¿‡ç¨‹æ˜¯é€šè¿‡PhoneWindowå¯¹åº”çš„WindowManagerImplæ¥æ·»åŠ windowï¼Œå†…éƒ¨ä¼šè°ƒç”¨WindowManagerGlobalæ¥å®ç°ã€‚WindowManagerGlobalä¼šä½¿ç”¨viewRootImplæ¥è¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡è®©WMSæ‰§è¡Œåˆ›å»ºwindowçš„ä¸šåŠ¡ã€‚ æ¯ä¸ªåº”ç”¨éƒ½æœ‰ä¸€ä¸ªwindowSessionï¼Œç”¨äºè´Ÿè´£å’ŒWMSçš„é€šä¿¡ï¼Œå¦‚ApplicationThreadä¸AMSçš„é€šä¿¡ã€‚ Other Windowdialogå’Œpopupwindowçš„å±‚çº§æ˜¯10001999ï¼Œåœ¨è¿™ä¸ªå±‚çº§éƒ½å±äºå­windowè€Œä¸æ˜¯åº”ç”¨Window(199)ï¼Œå­Windowéœ€è¦é™„å±äºçˆ¶Windowï¼ˆActivityï¼Œä¹Ÿå°±æ˜¯åº”ç”¨Windowï¼‰æ‰èƒ½æ˜¾ç¤ºï¼Œdialogè™½ç„¶åˆ›å»ºäº†ä¸€ä¸ªPhoneWindowï¼Œä½†æ˜¯popupWindowæœ€ç»ˆä¹Ÿåˆ›å»ºäº†ä¸€ä¸ªWindowï¼Œåªæ˜¯å®ƒä¸æ˜¯PhoneWindowè€Œå·²ï¼ŒpopupWindowå’Œdialogçš„æ˜¾ç¤ºéƒ½éœ€è¦ä¾èµ–çˆ¶Windowçš„Tokenï¼Œå…¶å®ä¸¤è€…éƒ½éœ€è¦ä¾èµ–äºActiviy PopupWindowé‚£ä¹ˆï¼ŒPopupWindowåˆ™æ˜¯åœ¨æ„é€ å™¨ä¸­æ—¶å°†å…¥å‚çš„contentViewç›´æ¥æ‰§è¡Œ setContentView(contentView);ï¼Œç„¶ååœ¨showAtLocationï¼ˆï¼‰ä¸­è°ƒç”¨äº†preparePopup() åˆ›å»ºå®ƒçš„decorViewï¼ˆPopupDecorViewï¼‰ä¹‹åinvokePopup()è°ƒç”¨æ‰§è¡ŒmWindowManager.addView(decorView, p); æ ¹æ®å‚æ•°æ„å»ºpopupDecorView æŠŠpopupDecorViewæ·»åŠ åˆ°å±å¹•ä¸Š dismiss()ä¸­è°ƒç”¨mWindowManager.removeViewImmediate(decorView); Dialogdialogçš„åˆ›å»ºè¿‡ç¨‹Activityæ¯”è¾ƒåƒï¼šæ„é€ å™¨åˆ›å»ºPhoneWindowï¼ŒsetContentViewåˆå§‹åŒ–DecorViewï¼Œshowæ—¶å€™æ·»åŠ DecorViewã€‚ æ„é€ å‡½æ•°ä¸­åˆ›å»ºPhoneWindowï¼Œè®¾ç½®WindowMangerï¼ˆè¿™é‡Œæ‹¿çš„æ˜¯ä¼ å…¥çš„contextï¼Œå®é™…ä¸Šè¿™contextåªèƒ½æ˜¯actiivtyï¼Œçš„WindowManagerï¼‰ Dialog.setContentViewæ—¶æ‰PhoneWindow.setContentViewæ¥åˆå§‹åŒ–DecorView show()æ—¶å€™è°ƒç”¨äº†mWindowManager.addView(mDecor, l); dismiss()æ—¶å€™è°ƒç”¨mWindowManager.removeViewImmediate(mDecor); æ€»ç»“ dialogå’ŒpopupWindowä¸åŒï¼Œdialogåˆ›å»ºäº†æ–°çš„PhoneWindowï¼Œä½¿ç”¨äº†PhoneWindowçš„DecorViewæ¨¡æ¿ã€‚è€ŒpopupWindowæ²¡æœ‰ï¼ŒpopupWindowä»–ä¹Ÿå¯¹åº”ä¸€ä¸ªwindowï¼Œå› ä¸ºå®ƒä¹Ÿæ˜¯é€šè¿‡windowManageræ·»åŠ ä¸Šå»çš„ï¼Œä¸å±äºActivityçš„viewæ ‘ã€‚ dialogçš„æ˜¾ç¤ºå±‚çº§æ•°æ›´é«˜ï¼Œä¼šç›´æ¥æ˜¾ç¤ºåœ¨Activityä¸Šé¢ï¼Œåœ¨dialogåæ·»åŠ çš„popUpWindowä¹Ÿä¼šæ˜¾ç¤ºåœ¨dialogä¸‹ dialogçš„åˆ›å»ºæµç¨‹å’Œactivityéå¸¸åƒ æ¦‚å¿µæ¢³ç†//å¾…æ•´ç†å…³é”®ç±»å‰é¢çš„æºç æµç¨‹ä¸­æ¶‰åŠåˆ°å¾ˆå¤šçš„ç±»ï¼Œè¿™é‡ŒæŠŠç›¸å…³çš„ç±»ç»Ÿä¸€åˆ†æä¸€ä¸‹ã€‚å…ˆçœ‹ä¸€å¼ å›¾ï¼š è¿™åŸºæœ¬ä¸Šæ˜¯æˆ‘ä»¬è¿™ç¯‡æ–‡ç« æ¶‰åŠåˆ°çš„æ‰€æœ‰å…³é”®ç±»ã€‚ ï¼ˆå›¾ä¸­ç»¿è‰²çš„windowå¹¶ä¸æ˜¯ä¸€ä¸ªç±»ï¼Œè€Œæ˜¯è¡¨æ„ä¸Šçš„windowï¼‰ å¦å¤–ViewRootImplå¹¶ä¸åœ¨PhoneWindowä¸­ï¼Œè€Œæ˜¯åœ¨View.attachInfoä¸­ï¼Œä¹Ÿè¢«WindowManagerServiceä¸­æŒæœ‰ç»´æŠ¤ï¼‰ windowç›¸å…³windowçš„å®ç°ç±»åªæœ‰ä¸€ä¸ªï¼šPhoneWindowï¼Œä»–ç»§æ‰¿è‡ªWindowæŠ½è±¡ç±»ã€‚åé¢æˆ‘ä¼šé‡ç‚¹åˆ†æä»–ã€‚ WindowManagerç›¸å…³é¡¾åæ€ä¹‰ï¼ŒwindowManagerå°±æ˜¯windowç®¡ç†ç±»ã€‚è¿™ä¸€éƒ¨åˆ†çš„å…³é”®ç±»æœ‰windowManagerï¼ŒviewManagerï¼ŒwindowManagerImplï¼ŒwindowManagerGlobalã€‚windowManageræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç»§æ‰¿è‡ªviewManagerã€‚viewManagerä¸­åŒ…å«äº†æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„ä¸‰ä¸ªæ¥å£ï¼šaddView,removeView,updateViewã€‚windowManagerImplå’ŒPhoneWindowæ˜¯æˆå¯¹å‡ºç°çš„ï¼Œå‰è€…è´Ÿè´£ç®¡ç†åè€…ã€‚WindowManagerImplæ˜¯windowManagerçš„å®ç°ç±»ï¼Œä½†æ˜¯ä»–æœ¬èº«å¹¶æ²¡æœ‰çœŸæ­£å®ç°é€»è¾‘ï¼Œè€Œæ˜¯äº¤ç»™äº†WindowManagerGlobalã€‚WindowManagerGlobalæ˜¯å…¨å±€å•ä¾‹ï¼ŒwindowManagerImplå†…éƒ¨ä½¿ç”¨æ¡¥æ¥æ¨¡å¼ï¼Œä»–æ˜¯windowManageræ¥å£é€»è¾‘çš„çœŸæ­£å®ç° viewç›¸å…³è¿™é‡Œæœ‰ä¸ªå¾ˆå…³é”®çš„ç±»ï¼šViewRootImplã€‚æ¯ä¸ªviewæ ‘éƒ½ä¼šæœ‰ä¸€ä¸ªã€‚å½“æˆ‘ä½¿ç”¨windowManagerçš„addViewæ–¹æ³•æ—¶ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªViewRootImplã€‚ViewRootImplçš„ä½œç”¨å¾ˆå…³é”®ï¼š è´Ÿè´£è¿æ¥viewå’Œwindowçš„æ¡¥æ¢äº‹åŠ¡ è´Ÿè´£å’ŒWindowManagerServiceçš„è”ç³» è´Ÿè´£ç®¡ç†å’Œç»˜åˆ¶viewæ ‘ äº‹ä»¶çš„ä¸­è½¬ç«™ æ¯ä¸ªwindowéƒ½ä¼šæœ‰ä¸€ä¸ªViewRootImplï¼ŒviewRootImplæ˜¯è´Ÿè´£ç»˜åˆ¶è¿™ä¸ªviewæ ‘å’Œwindowä¸viewçš„æ¡¥æ¢ï¼Œæ¯ä¸ªwindowéƒ½ä¼šæœ‰ä¸€ä¸ªViewRootImplã€‚ WindowManagerServiceè¿™ä¸ªæ˜¯windowçš„çœŸæ­£ç®¡ç†è€…ï¼Œç±»ä¼¼äºAMSï¼ˆActivityManagerServiceï¼‰ç®¡ç†å››å¤§ç»„ä»¶ã€‚æ‰€æœ‰çš„windowåˆ›å»ºæœ€ç»ˆéƒ½è¦ç»è¿‡windowManagerServiceã€‚æ•´ä¸ªAndroidçš„windowæœºåˆ¶ä¸­ï¼ŒWMSç»å¯¹æ˜¯æ ¸å¿ƒï¼Œä»–å†³å®šäº†å±å¹•æ‰€æœ‰çš„windowè¯¥å¦‚ä½•æ˜¾ç¤ºå¦‚ä½•åˆ†å‘ç‚¹å‡»äº‹ä»¶ç­‰ç­‰ã€‚ ä»Androidæ¶æ„è§’åº¦çœ‹Windowå‰é¢æˆ‘ä»¬ä»‹ç»è¿‡å…³äºPhoneWindowå’Œwindowä¹‹é—´çš„å…³ç³»ï¼Œäº†è§£åˆ°PhoneWindowå…¶å®ä¸æ˜¯Windowï¼Œåªæ˜¯ä¸€ä¸ªwindowå®¹å™¨ã€‚ä¸çŸ¥è¯»è€…æœ‰æ²¡æƒ³è¿‡ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè°·æ­Œè¦å»ºä¸€ä¸ªä¸æ˜¯windowä½†å´åå­—æ˜¯windowçš„ç±»ï¼Ÿæ˜¯æ•…æ„è¦è¿·æƒ‘æˆ‘ä»¬å—ï¼Ÿè¦äº†è§£è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹æ•´ä¸ªandroidçš„windowæœºåˆ¶ç»“æ„ã€‚ é¦–å…ˆä»WindowManagerServiceå¼€å§‹ï¼Œæˆ‘ä»¬çŸ¥é“WMSæ˜¯windowçš„æœ€ç»ˆç®¡ç†è€…ï¼Œåœ¨WMSä¸­ä¸ºæ¯ä¸€ä¸ªåº”ç”¨æŒæœ‰ä¸€ä¸ªsessionï¼Œå…³äºsessionå‰é¢æˆ‘ä»¬è®²è¿‡ï¼Œæ¯ä¸ªåº”ç”¨éƒ½æ˜¯å…¨å±€å•ä¾‹ï¼Œè´Ÿè´£å’ŒWMSé€šä¿¡çš„binderå¯¹è±¡ã€‚WMSä¸ºæ¯ä¸ªwindowéƒ½å»ºç«‹äº†ä¸€ä¸ªwindowStatuså¯¹è±¡ï¼ŒåŒä¸€ä¸ªåº”ç”¨çš„windowä½¿ç”¨åŒä¸ªsessionè¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡ï¼Œç»“æ„å¤§æ¦‚å¦‚ä¸‹ï¼š è€Œè´Ÿè´£ä¸WMSé€šä¿¡çš„ï¼Œæ˜¯viewRootImplã€‚å‰é¢æˆ‘ä»¬è®²è¿‡æ¯ä¸ªviewæ ‘å³ä¸ºä¸€ä¸ªwindowï¼ŒviewRootImplè´Ÿè´£å’ŒWMSè¿›è¡Œé€šä¿¡ï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£viewçš„ç»˜åˆ¶ã€‚å¦‚æœæŠŠä¸Šé¢çš„å›¾ç”»ä»”ç»†ä¸€ç‚¹å°±æ˜¯ï¼š å›¾ä¸­æ¯ä¸€ä¸ªwindowStatuså¯¹åº”ä¸€ä¸ªviewRootImplï¼ŒWMSé€šè¿‡viewRootImplæ¥æ§åˆ¶viewã€‚è¿™ä¹Ÿå°±æ˜¯windowæœºåˆ¶çš„ç®¡ç†ç»“æ„ã€‚å½“æˆ‘ä»¬éœ€è¦æ·»åŠ windowçš„æ—¶å€™ï¼Œæœ€ç»ˆçš„é€»è¾‘å®ç°æ˜¯WindowManagerGlobalï¼Œä»–çš„å†…éƒ¨ä½¿ç”¨è‡ªå·±çš„sessionåˆ›å»ºä¸€ä¸ªviewRootImplï¼Œç„¶åå‘WMSç”³è¯·æ·»åŠ windowï¼Œç»“æ„å›¾å¤§æ¦‚å¦‚ä¸‹ï¼š windowManagerGlobalä½¿ç”¨è‡ªå·±çš„IWindowSessionåˆ›å»ºviewRootImplï¼Œè¿™ä¸ªIWindowSessionæ˜¯å…¨å±€å•ä¾‹ã€‚viewRootImplå’ŒWMSç”³è¯·åˆ›å»ºwindowï¼Œç„¶åWMSå…è®¸ä¹‹åï¼Œå†é€šçŸ¥viewRootImplç»˜åˆ¶viewï¼ŒåŒæ—¶WMSé€šè¿‡windowStatuså­˜å‚¨äº†viewRootImplçš„ç›¸å…³ä¿¡æ¯ï¼Œè¿™æ ·å¦‚æœWMSéœ€è¦ä¿®æ”¹viewï¼Œç›´æ¥é€šè¿‡viewRootImplå°±å¯ä»¥ä¿®æ”¹viewäº†ã€‚ ä»ä¸Šé¢çš„æè¿°ä¸­å¯ä»¥å‘ç°æˆ‘å…¨ç¨‹æ²¡æœ‰æåŠåˆ°PhoneWindowå’ŒWindowManagerImplã€‚è¿™æ˜¯å› ä¸ºä»–ä»¬ä¸å±äºwindowæœºåˆ¶å†…çš„ç±»ï¼Œè€Œæ˜¯å°è£…äºwindowæœºåˆ¶ä¹‹ä¸Šçš„æ¡†æ¶ã€‚å‡è®¾å¦‚æœæ²¡æœ‰PhoneWindowå’ŒWindowManageræˆ‘ä»¬è¯¥å¦‚ä½•æ·»åŠ ä¸€ä¸ªwindowï¼Ÿé¦–å…ˆéœ€è¦è°ƒç”¨WindowGlobalè·å–sessionï¼Œå†åˆ›å»ºviewRootImplï¼Œå†è®¿é—®wmsï¼Œç„¶åå†åˆ©ç”¨viewRootImplç»˜åˆ¶viewï¼Œæ˜¯ä¸æ˜¯å¾ˆå¤æ‚ï¼Œè€Œè¿™ä»…ä»…åªæ˜¯æ•´ä½“çš„æ­¥éª¤ã€‚è€ŒWindowManagerImplæ­£æ˜¯è¿™ä¸ªåŠŸèƒ½ã€‚ä»–å†…éƒ¨æ‹¥æœ‰WindowManagerGlobalçš„å•ä¾‹ï¼Œç„¶åå¸®åŠ©æˆ‘ä»¬å®Œæˆäº†è¿™ä¸€ç³»åˆ—çš„æ­¥éª¤ã€‚åŒæ—¶ï¼ŒwindowManagerImplä¹Ÿæ˜¯åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå…¶ä»–çš„windowManagerImpléƒ½æ˜¯å»ºç«‹åœ¨windowManagerImplå•ä¾‹ä¸Šã€‚è¿™ä¸€ç‚¹åœ¨å‰é¢æœ‰é€šè¿‡æºç ä»‹ç»åˆ°ã€‚ å¦å¤–ï¼Œä¸Šé¢æˆ‘è®²åˆ°PhoneWindowå¹¶ä¸æ˜¯windowè€Œæ˜¯ä¸€ä¸ªè¾…åŠ©Activityç®¡ç†çš„å·¥å…·ç±»ï¼Œé‚£ä¸ºä»€ä¹ˆä»–ä¸è¦å‘½åä¸ºwindowUtilså‘¢ï¼Ÿé¦–å…ˆï¼ŒPhoneWindowè¿™ä¸ªç±»æ˜¯è°·æ­Œç»™windowæœºåˆ¶è¿›è¡Œæ›´ä¸Šä¸€å±‚çš„å°è£…ã€‚PhoneWindowå†…éƒ¨æ‹¥æœ‰ä¸€ä¸ªDecorViewï¼Œæˆ‘ä»¬çš„å¸ƒå±€viewéƒ½æ˜¯æ·»åŠ åˆ°decorViewä¸­çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™decorViewè®¾ç½®èƒŒæ™¯ï¼Œå®½é«˜åº¦ï¼Œæ ‡é¢˜æ ï¼ŒæŒ‰é”®åé¦ˆç­‰ç­‰ï¼Œæ¥é—´æ¥ç»™æˆ‘ä»¬çš„å¸ƒå±€viewè®¾ç½®ã€‚è¿™æ ·ä¸€æ¥ï¼ŒPhoneWindowçš„å­˜åœ¨ï¼Œå‘å¼€å‘è€…å±è”½çœŸæ­£çš„windowï¼Œæš´éœ²ç»™å¼€å‘è€…ä¸€ä¸ªâ€œå­˜åœ¨çš„â€windowã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºPhoneWindowå°±æ˜¯ä¸€ä¸ªwindowï¼Œwindowæ˜¯viewå®¹å™¨ã€‚å½“æˆ‘ä»¬éœ€è¦åœ¨å±å¹•ä¸Šæ·»åŠ viewçš„æ—¶å€™ï¼Œåªéœ€è¦è·å¾—åº”ç”¨windowå¯¹åº”çš„windowManagerImplï¼Œç„¶åç›´æ¥è°ƒç”¨addViewæ–¹æ³•æ·»åŠ viewå³å¯ã€‚è¿™é‡Œä¹Ÿå¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆwindowManagerçš„æ¥å£æ–¹æ³•æ˜¯addViewè€Œä¸æ˜¯addWindowï¼Œä¸€æ˜¯windowç¡®å®æ˜¯ä»¥viewçš„å­˜åœ¨å½¢å¼æ²¡é”™ï¼ŒäºŒæ˜¯ä¸ºäº†å‘å¼€å‘è€…å±è”½çœŸæ­£çš„windowï¼Œè®©æˆ‘ä»¬ä»¥ä¸ºæ˜¯åœ¨å¾€windowä¸­æ·»åŠ viewï¼Œwindowæ˜¯çœŸå®å­˜åœ¨çš„ä¸œè¥¿ã€‚ä»–ä»¬çš„å…³ç³»ç”»ä¸ªå›¾å¦‚ä¸‹ï¼š é»„è‰²éƒ¨åˆ†è¾“äºè°·æ­Œæä¾›ç»™å¼€å‘è€…çš„windowæ¡†æ¶ï¼Œè€Œç»¿è‰²æ˜¯çœŸæ­£çš„windowæœºåˆ¶ç»“æ„ã€‚é€šè¿‡PhoneWindowæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œwindowæ“ä½œï¼Œè€Œä¸é¡»äº†è§£åº•å±‚ç©¶ç«Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚PhoneWindowçš„å­˜åœ¨ï¼Œæ›´æ˜¯è®©windowçš„â€œå¯è§æ€§â€å¾—åˆ°äº†å®ç°ï¼Œè®©windowå˜æˆäº†ä¸€ä¸ªâ€œviewå®¹å™¨â€ã€‚ å¥½äº†æœ€åæ¥æ€»ç»“ä¸€ä¸‹ï¼š Androidå†…éƒ¨çš„windowæœºåˆ¶ä¸è°·æ­Œæš´éœ²ç»™æˆ‘ä»¬çš„apiæ˜¯ä¸ä¸€æ ·çš„ï¼Œè°·æ­Œå°è£…çš„ç›®çš„æ˜¯ä¸ºäº†è®©æˆ‘ä»¬æ›´å¥½åœ°ä½¿ç”¨windowã€‚ dialogã€popupWindowç­‰æ¡†æ¶æ›´æ˜¯å¯¹å…·ä½“åœºæ™¯è¿›è¡Œæ›´è¿›ä¸€æ­¥çš„å°è£…ã€‚ æˆ‘ä»¬åœ¨äº†è§£windowæœºåˆ¶çš„æ—¶å€™ï¼Œéœ€è¦è·³è¿‡åº”ç”¨å±‚ï¼Œçœ‹åˆ°windowçš„æœ¬è´¨ï¼Œæ‰èƒ½æ›´å¥½åœ°å¸®åŠ©æˆ‘ä»¬ç†è§£windowã€‚ åœ¨androidçš„å…¶ä»–åœ°æ–¹ä¹Ÿæ˜¯ä¸€æ ·ï¼Œåˆ©ç”¨å°è£…å‘å¼€å‘è€…å±è”½åº•å±‚é€»è¾‘ï¼Œè®©æˆ‘ä»¬æ›´å¥½åœ°è¿ç”¨ã€‚ä½†å¦‚æœæˆ‘ä»¬éœ€è¦äº†è§£ä»–çš„æœºåˆ¶çš„æ—¶å€™ï¼Œå°±éœ€è¦ç»•è¿‡è¿™å±‚å°è£…ï¼Œçœ‹åˆ°æœ¬è´¨ã€‚ windowä¸PhoneWindowçš„å…³ç³» è§£é‡Šä¸€ä¸‹æ ‡é¢˜ï¼Œwindowæ˜¯æŒ‡windowæœºåˆ¶ä¸­windowè¿™ä¸ªæ¦‚å¿µï¼Œè€ŒPhoneWindowæ˜¯æŒ‡PhoneWindowè¿™ä¸ªç±»ã€‚åé¢æˆ‘åœ¨è®²çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯æŒ‡ç±»ï¼Œæˆ‘ä¼šåœ¨åé¢åŠ ä¸ªâ€˜ç±»â€™å­—ã€‚å¦‚windowæ˜¯æŒ‡windowæ¦‚å¿µï¼Œwindowç±»æ˜¯æŒ‡windowè¿™ä¸ªæŠ½è±¡ç±»ã€‚è¯»è€…ä¸è¦æ··æ·†ã€‚ è¿˜è®°å¾—æˆ‘åœ¨è®²windowçš„æ¦‚å¿µçš„æ—¶å€™ç•™äº†ä¸€ä¸ªæ€è€ƒå—ï¼Ÿ æ€è€ƒï¼šAndroidä¸­ä¸æ˜¯æœ‰ä¸€ä¸ªæŠ½è±¡ç±»å«åšwindowè¿˜æœ‰ä¸€ä¸ªPhoneWindowå®ç°ç±»å—ï¼Œä»–ä»¬ä¸å°±æ˜¯windowçš„å­˜åœ¨å½¢å¼ï¼Œä¸ºä»€ä¹ˆè¯´windowæ˜¯æŠ½è±¡ä¸å­˜åœ¨çš„ è¿™é‡Œæˆ‘å†æŠ›å‡ºå‡ ä¸ªé—®é¢˜ï¼š æœ‰ä¸€äº›èµ„æ–™è®¤ä¸ºPhoneWindowå°±æ˜¯windowï¼Œæ˜¯viewå®¹å™¨ï¼Œè´Ÿè´£ç®¡ç†å®¹å™¨å†…çš„viewï¼ŒwindowManagerImplå¯ä»¥å¾€é‡Œé¢æ·»åŠ viewï¼Œå¦‚ä¸Šé¢æˆ‘ä»¬è®²è¿‡çš„addViewæ–¹æ³•ã€‚ä½†æ˜¯ï¼ŒåŒæ—¶å®ƒåˆè¯´æ¯ä¸ªwindowå¯¹åº”ä¸€ä¸ªviewRootImplï¼Œä½†å´æ²¡è§£é‡Šä¸ºä»€ä¹ˆæ¯æ¬¡addViewéƒ½ä¼šæ–°å»ºä¸€ä¸ªviewRootImplï¼Œå‰åå‘é€çŸ›ç›¾ã€‚ æœ‰ä¸€äº›èµ„æ–™ä¹Ÿæ˜¯è®¤ä¸ºPhoneWindowæ˜¯windowï¼Œä½†æ˜¯ä»–è¯´addViewæ–¹æ³•ä¸æ˜¯æ·»åŠ viewè€Œæ˜¯æ·»åŠ windowï¼ŒåŒæ—¶æ‹¿è¿™ä¸ªæ–¹æ³•çš„åå­—ä½œä¸ºè®ºæ®è¯æ˜viewå°±æ˜¯windowï¼Œä½†æ˜¯ä»–æ²¡è§£é‡Šä¸ºä»€ä¹ˆåœ¨ä½¿ç”¨addViewæ–¹æ³•åˆ›å»ºwindowçš„è¿‡ç¨‹å´æ²¡æœ‰åˆ›å»ºPhoneWindowå¯¹è±¡ã€‚ æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥çœ‹ã€‚æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹æºç ä¸­å¯¹äºwindowæŠ½è±¡ç±»çš„æ³¨é‡Šï¼š å¤åˆ¶ä»£ç  1234567 Abstract base class for a top-level window look and behavior policy. An instance of this class should be used as the top-level view added to the window manager. It provides standard UI policies such as a background, title area, default key processing, etc. é¡¶å±‚çª—å£å¤–è§‚å’Œè¡Œä¸ºç­–ç•¥çš„æŠ½è±¡åŸºç±»ã€‚æ­¤ç±»çš„å®ä¾‹åº”ç”¨ä½œæ·»åŠ åˆ°çª—å£ç®¡ç†å™¨çš„é¡¶å±‚è§†å›¾ã€‚å®ƒæä¾›æ ‡å‡†çš„UIç­–ç•¥ï¼Œå¦‚èƒŒæ™¯ã€æ ‡é¢˜åŒºåŸŸã€é»˜è®¤é”®å¤„ç†ç­‰ã€‚ å¤§æ¦‚æ„æ€å°±æ˜¯ï¼šè¿™ä¸ªç±»æ˜¯é¡¶çº§çª—å£çš„æŠ½è±¡åŸºç±»ï¼Œé¡¶çº§çª—å£å¿…é¡»ç»§æ‰¿ä»–ï¼Œä»–è´Ÿè´£çª—å£çš„å¤–è§‚å¦‚èƒŒæ™¯ã€æ ‡é¢˜ã€é»˜è®¤æŒ‰é”®å¤„ç†ç­‰ã€‚è¿™ä¸ªç±»çš„å®ä¾‹è¢«æ·»åŠ åˆ°windowManagerä¸­ï¼Œè®©windowManagerå¯¹ä»–è¿›è¡Œç®¡ç†ã€‚PhoneWindowæ˜¯ä¸€ä¸ªtop-level windowï¼ˆé¡¶çº§çª—å£ï¼‰ï¼Œä»–è¢«æ·»åŠ åˆ°é¡¶çº§çª—å£ç®¡ç†å™¨çš„é¡¶å±‚è§†å›¾ï¼Œå…¶ä»–çš„windowï¼Œéƒ½éœ€è¦æ·»åŠ åˆ°è¿™ä¸ªé¡¶å±‚è§†å›¾ä¸­ï¼Œæ‰€ä»¥æ›´å‡†ç¡®çš„æ¥è¯´ï¼ŒPhoneWindowå¹¶ä¸æ˜¯viewå®¹å™¨ï¼Œè€Œæ˜¯windowå®¹å™¨ã€‚ PhoneWindowæ˜¯Windowå—ï¼ŸPhoneWindowå¹¶ä¸æ˜¯viewå®¹å™¨ï¼Œè€Œæ˜¯windowå®¹å™¨ã€‚ é‚£PhoneWindowçš„å­˜åœ¨æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ PhoneWindowåªæ˜¯æä¾›äº† token æœºåˆ¶æ¥æ ¡éªŒå­windowçš„åˆæ³•æ€§ ç¬¬ä¸€ã€æä¾›DecorViewæ¨¡æ¿ã€‚å¦‚ä¸‹å›¾ï¼š æˆ‘ä»¬çš„Activityæ˜¯é€šè¿‡setContentViewæŠŠå¸ƒå±€è®¾ç½®åˆ°DecorViewä¸­ï¼Œé‚£ä¹ˆDecorViewæœ¬èº«çš„å¸ƒå±€ï¼Œå°±æˆä¸ºäº†Activityç•Œé¢çš„èƒŒæ™¯ã€‚åŒæ—¶DecorViewæ˜¯åˆ†ä¸ºæ ‡é¢˜æ å’Œå†…å®¹ä¸¤éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥å¯ç•Œé¢è®¾ç½®æ ‡é¢˜æ ã€‚åŒæ—¶ï¼Œç”±äºæˆ‘ä»¬çš„ç•Œé¢æ˜¯æ·»åŠ åœ¨çš„DecorViewä¸­ï¼Œå±äºDecorViewçš„ä¸€éƒ¨åˆ†ã€‚é‚£ä¹ˆå¯¹äºDecorViewçš„windowå±æ€§è®¾ç½®ä¹Ÿä¼šå¯¹æˆ‘ä»¬çš„å¸ƒå±€ç•Œé¢ç”Ÿæ•ˆã€‚è¿˜è®°å¾—è°·æ­Œçš„å®˜æ–¹ç»™windowç±»æ³¨é‡Šçš„æœ€åä¸€å¥è¯å—ï¼šå®ƒæä¾›æ ‡å‡†çš„UIç­–ç•¥ï¼Œå¦‚èƒŒæ™¯ã€æ ‡é¢˜åŒºåŸŸã€é»˜è®¤é”®å¤„ç†ç­‰ã€‚è¿™äº›éƒ½å¯ä»¥é€šè¿‡DecorViewå®ç°ï¼Œè¿™æ˜¯PhoneWindowçš„ç¬¬ä¸€ä¸ªä½œç”¨ã€‚ ç¬¬äºŒã€æŠ½ç¦»Activityä¸­å…³äºwindowçš„é€»è¾‘ã€‚Activityçš„èŒè´£éå¸¸å¤šï¼Œå¦‚æœæ‰€æœ‰çš„äº‹æƒ…éƒ½è‡ªå·±åšï¼Œé‚£ä¹ˆä¼šé€ æˆæœ¬èº«ä»£ç æå…¶è‡ƒè‚¿ã€‚é˜…è¯»è¿‡Activityå¯åŠ¨çš„è¯»è€…å¯èƒ½çŸ¥é“ï¼ŒAMSä¹Ÿé€šè¿‡ActivityStarterè¿™ä¸ªç±»æ¥æŠ½ç¦»å¯åŠ¨Activityå¯åŠ¨çš„é€»è¾‘ã€‚è¿™æ ·å…³äºwindowç›¸å…³çš„äº‹æƒ…ï¼Œå°±äº¤ç»™PhoneWindowå»å¤„ç†äº†ã€‚ï¼ˆäº‹å®ä¸Šï¼ŒActivityè°ƒç”¨çš„æ˜¯WindowManagerImplï¼Œä½†å› PhoneWindowå’ŒWindowManagerImplä¸¤è€…æ˜¯æˆå¯¹å­˜åœ¨ï¼Œä»–ä»¬å…±åŒå¤„ç†windowç›¸å…³çš„äº‹åŠ¡ï¼Œæ‰€ä»¥è¿™é‡Œå°±ç®€å•å†™æˆäº¤ç»™PhoneWindowå¤„ç†ã€‚ï¼‰å½“Activityéœ€è¦æ·»åŠ ç•Œé¢æ—¶ï¼Œåªéœ€è¦ä¸€å¥setContentViewï¼Œè°ƒç”¨äº†PhoneWindowçš„setContentViewæ–¹æ³•ï¼Œå°±æŠŠå¸ƒå±€è®¾ç½®åˆ°å±å¹•ä¸Šäº†ã€‚å…·ä½“æ€ä¹ˆå®Œæˆï¼ŒActivityä¸å¿…ç®¡ã€‚ ç¬¬ä¸‰ã€PhoneWindowæä¾›äº† token æœºåˆ¶æ¥æ ¡éªŒå­windowçš„åˆæ³•æ€§æ·»åŠ windowéœ€è¦æœ‰tokenï¼Œè€Œtokenåªæœ‰PhoneWindowæ‹¥æœ‰ï¼›å› æ­¤å…¶ä»–çš„windowéƒ½å¿…é¡»ç›´æ¥æˆ–é—´æ¥ä¸Activityçš„PhoneWindowæœ‰è”ç³» PhoneWindowå†…éƒ¨æœ‰ä¸€ä¸ªtokenå±æ€§ï¼Œç”¨äºéªŒè¯ä¸€ä¸ªPhoneWindowæ˜¯å¦å…è®¸æ·»åŠ windowã€‚åœ¨Activityåˆ›å»ºPhoneWindowçš„æ—¶å€™ï¼Œå°±ä¼šæŠŠä»AMSä¼ è¿‡æ¥çš„tokenèµ‹å€¼ç»™ä»–ï¼Œä»è€Œä»–ä¹Ÿå°±æœ‰äº†æ·»åŠ tokençš„æƒé™ã€‚è€Œå…¶ä»–çš„PhoneWindowåˆ™æ²¡æœ‰è¿™ä¸ªæƒé™ï¼Œå› è€Œä¹Ÿæ— æ³•æ·»åŠ windowã€‚ æ ¡éªŒ token çš„è¿‡ç¨‹ä¸»è¦å‘ç”Ÿåœ¨ WindowManagerService ä¸­ã€‚å½“åº”ç”¨ç¨‹åºè¯·æ±‚æ“ä½œçª—å£æ—¶ï¼Œæ¯”å¦‚æ·»åŠ ã€ç§»åŠ¨ã€æ›´æ–°æˆ–è€…ç§»é™¤çª—å£ï¼Œç³»ç»Ÿä¼šé€šè¿‡ä¼ é€’ token æ¥ç¡®å®šè¯¥æ“ä½œæ˜¯å¦åˆæ³•ã€‚å¦‚æœ token æ˜¯æ— æ•ˆçš„ï¼Œç³»ç»Ÿå°†æ‹’ç»è¯¥æ“ä½œï¼Œæ ¡éªŒæ¡ä»¶åŒ…æ‹¬ æƒé™æ£€æŸ¥ï¼šç³»ç»Ÿä¼šæ£€æŸ¥å½“å‰åº”ç”¨ç¨‹åºæ˜¯å¦æœ‰æƒé™æ‰§è¡Œç‰¹å®šçš„çª—å£æ“ä½œã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªåº”ç”¨ç¨‹åºæ²¡æœ‰ SYSTEM_ALERT_WINDOW æƒé™ï¼Œå®ƒå°±æ— æ³•æ˜¾ç¤ºæ‚¬æµ®çª—å£ã€‚ å®‰å…¨æ€§æ£€æŸ¥ï¼šç³»ç»Ÿå¯èƒ½ä¼šæ£€æŸ¥çª—å£çš„ token æ˜¯å¦æœ‰æ•ˆã€æ˜¯å¦æ¥è‡ªå¯ä¿¡ä»»çš„åº”ç”¨ç¨‹åºç­‰ã€‚è¿™å¯ä»¥é˜²æ­¢æ¶æ„åº”ç”¨ç¨‹åºä¼ªé€ çª—å£ tokenï¼Œå°è¯•æ‰§è¡Œæœªç»æˆæƒçš„çª—å£æ“ä½œã€‚ ç„¦ç‚¹å’Œå±‚çº§æ£€æŸ¥ï¼šç³»ç»Ÿå¯èƒ½ä¼šæ£€æŸ¥çª—å£çš„ç„¦ç‚¹çŠ¶æ€å’Œå±‚çº§å…³ç³»ï¼Œä»¥ç¡®ä¿çª—å£çš„æ˜¾ç¤ºä¸ä¼šå¹²æ‰°åˆ°å…¶ä»–çª—å£æˆ–ç³»ç»ŸåŠŸèƒ½çš„æ­£å¸¸è¿è¡Œã€‚ é™„å½• å¸¸è§type&amp;flagAndroidDeveloper.Window flag and type windowçš„typeå±æ€§å‰é¢æˆ‘ä»¬è®²åˆ°windowæœºåˆ¶è§£å†³çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯viewçš„æ˜¾ç¤ºæ¬¡åºé—®é¢˜ï¼Œè¿™ä¸ªå±æ€§å°±å†³å®šäº†windowçš„æ˜¾ç¤ºæ¬¡åºã€‚windowæ˜¯æœ‰åˆ†ç±»çš„ï¼Œä¸åŒç±»åˆ«çš„æ˜¾ç¤ºé«˜åº¦èŒƒå›´ä¸åŒï¼Œä¾‹å¦‚æˆ‘æŠŠ1-1000mé«˜åº¦ç§°ä¸ºä½ç©ºï¼Œ1001-2000mé«˜åº¦ç§°ä¸ºä¸­ç©ºï¼Œ2000ä»¥ä¸Šç§°ä¸ºé«˜ç©ºã€‚windowä¹Ÿæ˜¯ä¸€æ ·æŒ‰ç…§é«˜åº¦èŒƒå›´è¿›è¡Œåˆ†ç±»ï¼Œä»–ä¹Ÿæœ‰ä¸€ä¸ªå˜é‡Z-Orderï¼Œå†³å®šäº†windowçš„é«˜åº¦ã€‚windowä¸€å…±å¯åˆ†ä¸ºä¸‰ç±»ï¼š åº”ç”¨ç¨‹åºçª—å£ï¼šåº”ç”¨ç¨‹åºçª—å£ä¸€èˆ¬ä½äºæœ€åº•å±‚ï¼ŒZ-Orderåœ¨1-99 å­çª—å£ï¼šå­çª—å£ä¸€èˆ¬æ˜¯æ˜¾ç¤ºåœ¨åº”ç”¨çª—å£ä¹‹ä¸Šï¼ŒZ-Orderåœ¨1000-1999 ç³»ç»Ÿçº§çª—å£ï¼šç³»ç»Ÿçº§çª—å£ä¸€èˆ¬ä½äºæœ€é¡¶å±‚ï¼Œä¸ä¼šè¢«å…¶ä»–çš„windowé®ä½ï¼Œå¦‚Toastï¼ŒZ-Orderåœ¨2000-2999ã€‚å¦‚æœè¦å¼¹å‡ºè‡ªå®šä¹‰ç³»ç»Ÿçº§çª—å£éœ€è¦åŠ¨æ€ç”³è¯·æƒé™ã€‚ Z-Orderè¶Šå¤§ï¼Œwindowè¶Šé è¿‘ç”¨æˆ·ï¼Œä¹Ÿå°±æ˜¾ç¤ºè¶Šé«˜ï¼Œé«˜åº¦é«˜çš„windowä¼šè¦†ç›–é«˜åº¦ä½çš„windowã€‚ windowçš„typeå±æ€§å°±æ˜¯Z-Orderçš„å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ç»™windowçš„typeå±æ€§èµ‹å€¼æ¥å†³å®šwindowçš„é«˜åº¦ã€‚ç³»ç»Ÿä¸ºæˆ‘ä»¬ä¸‰ç±»windowéƒ½é¢„è®¾äº†é™æ€å¸¸é‡ï¼Œå¦‚ä¸‹ï¼ˆä»¥ä¸‹å¸¸ç”¨å‚æ•°ä»‹ç»è½¬è‡ªå‚è€ƒæ–‡çŒ®ç¬¬ä¸€ç¯‡æ–‡ç« ï¼‰ï¼š åº”ç”¨çº§window å¤åˆ¶ä»£ç  1234567891011121314151617// åº”ç”¨ç¨‹åº Window çš„å¼€å§‹å€¼public static final int FIRST_APPLICATION_WINDOW = 1;// åº”ç”¨ç¨‹åº Window çš„åŸºç¡€å€¼public static final int TYPE_BASE_APPLICATION = 1;// æ™®é€šçš„åº”ç”¨ç¨‹åºpublic static final int TYPE_APPLICATION = 2;// ç‰¹æ®Šçš„åº”ç”¨ç¨‹åºçª—å£ï¼Œå½“ç¨‹åºå¯ä»¥æ˜¾ç¤º Window ä¹‹å‰ä½¿ç”¨è¿™ä¸ª Window æ¥æ˜¾ç¤ºä¸€äº›ä¸œè¥¿public static final int TYPE_APPLICATION_STARTING = 3;// TYPE_APPLICATION çš„å˜ä½“ï¼Œåœ¨åº”ç”¨ç¨‹åºæ˜¾ç¤ºä¹‹å‰ï¼ŒWindowManager ä¼šç­‰å¾…è¿™ä¸ª Window ç»˜åˆ¶å®Œæ¯•public static final int TYPE_DRAWN_APPLICATION = 4;// åº”ç”¨ç¨‹åº Window çš„ç»“æŸå€¼public static final int LAST_APPLICATION_WINDOW = 99; å­window å¤åˆ¶ä»£ç  1234567891011121314151617181920212223// å­ Window ç±»å‹çš„å¼€å§‹å€¼public static final int FIRST_SUB_WINDOW = 1000;// åº”ç”¨ç¨‹åº Window é¡¶éƒ¨çš„é¢æ¿ã€‚è¿™äº› Window å‡ºç°åœ¨å…¶é™„åŠ  Window çš„é¡¶éƒ¨ã€‚public static final int TYPE_APPLICATION_PANEL = FIRST_SUB_WINDOW;// ç”¨äºæ˜¾ç¤ºåª’ä½“(å¦‚è§†é¢‘)çš„ Windowã€‚è¿™äº› Window å‡ºç°åœ¨å…¶é™„åŠ  Window çš„åé¢ã€‚public static final int TYPE_APPLICATION_MEDIA = FIRST_SUB_WINDOW + 1;// åº”ç”¨ç¨‹åº Window é¡¶éƒ¨çš„å­é¢æ¿ã€‚è¿™äº› Window å‡ºç°åœ¨å…¶é™„åŠ  Window å’Œä»»ä½•Windowçš„é¡¶éƒ¨public static final int TYPE_APPLICATION_SUB_PANEL = FIRST_SUB_WINDOW + 2;// å½“å‰Windowçš„å¸ƒå±€å’Œé¡¶çº§Windowå¸ƒå±€ç›¸åŒæ—¶ï¼Œä¸èƒ½ä½œä¸ºå­ä»£çš„å®¹å™¨public static final int TYPE_APPLICATION_ATTACHED_DIALOG = FIRST_SUB_WINDOW + 3;// ç”¨æ˜¾ç¤ºåª’ä½“ Window è¦†ç›–é¡¶éƒ¨çš„ Windowï¼Œ è¿™æ˜¯ç³»ç»Ÿéšè—çš„ APIpublic static final int TYPE_APPLICATION_MEDIA_OVERLAY = FIRST_SUB_WINDOW + 4;// å­é¢æ¿åœ¨åº”ç”¨ç¨‹åºWindowçš„é¡¶éƒ¨ï¼Œè¿™äº›Windowæ˜¾ç¤ºåœ¨å…¶é™„åŠ Windowçš„é¡¶éƒ¨ï¼Œ è¿™æ˜¯ç³»ç»Ÿéšè—çš„ APIpublic static final int TYPE_APPLICATION_ABOVE_SUB_PANEL = FIRST_SUB_WINDOW + 5;// å­ Window ç±»å‹çš„ç»“æŸå€¼public static final int LAST_SUB_WINDOW = 1999; ç³»ç»Ÿçº§window å¤åˆ¶ä»£ç  1234567891011121314151617181920212223242526272829303132333435// ç³»ç»ŸWindowç±»å‹çš„å¼€å§‹å€¼public static final int FIRST_SYSTEM_WINDOW = 2000;// ç³»ç»ŸçŠ¶æ€æ ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçŠ¶æ€æ ï¼Œå®ƒè¢«æ”¾ç½®åœ¨å±å¹•çš„é¡¶éƒ¨ï¼Œæ‰€æœ‰å…¶ä»–çª—å£éƒ½å‘ä¸‹ç§»åŠ¨public static final int TYPE_STATUS_BAR = FIRST_SYSTEM_WINDOW;// ç³»ç»Ÿæœç´¢çª—å£ï¼Œåªèƒ½æœ‰ä¸€ä¸ªæœç´¢æ ï¼Œå®ƒè¢«æ”¾ç½®åœ¨å±å¹•çš„é¡¶éƒ¨public static final int TYPE_SEARCH_BAR = FIRST_SYSTEM_WINDOW+1;// å·²ç»ä»ç³»ç»Ÿä¸­è¢«ç§»é™¤ï¼Œå¯ä»¥ä½¿ç”¨ TYPE_KEYGUARD_DIALOG ä»£æ›¿public static final int TYPE_KEYGUARD = FIRST_SYSTEM_WINDOW+4;// ç³»ç»Ÿå¯¹è¯æ¡†çª—å£public static final int TYPE_SYSTEM_DIALOG = FIRST_SYSTEM_WINDOW+8;// é”å±æ—¶æ˜¾ç¤ºçš„å¯¹è¯æ¡†public static final int TYPE_KEYGUARD_DIALOG = FIRST_SYSTEM_WINDOW+9;// è¾“å…¥æ³•çª—å£ï¼Œä½äºæ™®é€š UI ä¹‹ä¸Šï¼Œåº”ç”¨ç¨‹åºå¯é‡æ–°å¸ƒå±€ä»¥å…è¢«æ­¤çª—å£è¦†ç›–public static final int TYPE_INPUT_METHOD = FIRST_SYSTEM_WINDOW+11;// è¾“å…¥æ³•å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºäºå½“å‰è¾“å…¥æ³•çª—å£ä¹‹ä¸Špublic static final int TYPE_INPUT_METHOD_DIALOG= FIRST_SYSTEM_WINDOW+12;// å¢™çº¸public static final int TYPE_WALLPAPER = FIRST_SYSTEM_WINDOW+13;// çŠ¶æ€æ çš„æ»‘åŠ¨é¢æ¿public static final int TYPE_STATUS_BAR_PANEL = FIRST_SYSTEM_WINDOW+14;// åº”ç”¨ç¨‹åºå åŠ çª—å£æ˜¾ç¤ºåœ¨æ‰€æœ‰çª—å£ä¹‹ä¸Špublic static final int TYPE_APPLICATION_OVERLAY = FIRST_SYSTEM_WINDOW + 38;// ç³»ç»ŸWindowç±»å‹çš„ç»“æŸå€¼public static final int LAST_SYSTEM_WINDOW = 2999; Windowçš„flagså‚æ•°flagæ ‡å¿—æ§åˆ¶windowçš„ä¸œè¥¿æ¯”è¾ƒå¤šï¼Œå¾ˆå¤šèµ„æ–™çš„æè¿°æ˜¯â€œæ§åˆ¶windowçš„æ˜¾ç¤ºâ€ï¼Œä½†æˆ‘è§‰å¾—ä¸å¤Ÿå‡†ç¡®ã€‚flagæ§åˆ¶çš„èŒƒå›´åŒ…æ‹¬äº†ï¼šå„ç§æƒ…æ™¯ä¸‹çš„æ˜¾ç¤ºé€»è¾‘ï¼ˆé”å±ï¼Œæ¸¸æˆç­‰ï¼‰è¿˜æœ‰è§¦æ§äº‹ä»¶çš„å¤„ç†é€»è¾‘ã€‚æ§åˆ¶æ˜¾ç¤ºç¡®å®æ˜¯ä»–çš„å¾ˆå¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯å…¨éƒ¨ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹ä¸€äº›å¸¸ç”¨çš„flagï¼Œå°±çŸ¥é“flagçš„åŠŸèƒ½äº†ï¼ˆä»¥ä¸‹å¸¸ç”¨å‚æ•°ä»‹ç»è½¬è‡ªå‚è€ƒæ–‡çŒ®ç¬¬ä¸€ç¯‡æ–‡ç« ï¼‰ï¼š å¤åˆ¶ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748// å½“ Window å¯è§æ—¶å…è®¸é”å±public static final int FLAG_ALLOW_LOCK_WHILE_SCREEN_ON = 0x00000001;// Window åé¢çš„å†…å®¹éƒ½å˜æš—public static final int FLAG_DIM_BEHIND = 0x00000002;// Window ä¸èƒ½è·å¾—è¾“å…¥ç„¦ç‚¹ï¼Œå³ä¸æ¥å—ä»»ä½•æŒ‰é”®æˆ–æŒ‰é’®äº‹ä»¶ï¼Œä¾‹å¦‚è¯¥ Window ä¸Š æœ‰ EditViewï¼Œç‚¹å‡» EditView æ˜¯ ä¸ä¼šå¼¹å‡ºè½¯é”®ç›˜çš„// Window èŒƒå›´å¤–çš„äº‹ä»¶ä¾æ—§ä¸ºåŸçª—å£å¤„ç†ï¼›ä¾‹å¦‚ç‚¹å‡»è¯¥çª—å£å¤–çš„viewï¼Œä¾ç„¶ä¼šæœ‰å“åº”ã€‚å¦å¤–åªè¦è®¾ç½®äº†æ­¤Flagï¼Œéƒ½å°†ä¼šå¯ç”¨FLAG_NOT_TOUCH_MODALpublic static final int FLAG_NOT_FOCUSABLE = 0x00000008;// è®¾ç½®äº†è¯¥ Flag,å°† Window ä¹‹å¤–çš„æŒ‰é”®äº‹ä»¶å‘é€ç»™åé¢çš„ Window å¤„ç†, è€Œè‡ªå·±åªä¼šå¤„ç† Window åŒºåŸŸå†…çš„è§¦æ‘¸äº‹ä»¶// Window ä¹‹å¤–çš„ view ä¹Ÿæ˜¯å¯ä»¥å“åº” touch äº‹ä»¶ã€‚public static final int FLAG_NOT_TOUCH_MODAL = 0x00000020;// è®¾ç½®äº†è¯¥Flagï¼Œè¡¨ç¤ºè¯¥ Window å°†ä¸ä¼šæ¥å—ä»»ä½• touch äº‹ä»¶ï¼Œä¾‹å¦‚ç‚¹å‡»è¯¥ Window ä¸ä¼šæœ‰å“åº”ï¼Œåªä¼šä¼ ç»™ä¸‹é¢æœ‰èšç„¦çš„çª—å£ã€‚public static final int FLAG_NOT_TOUCHABLE = 0x00000010;// åªè¦ Window å¯è§æ—¶å±å¹•å°±ä¼šä¸€ç›´äº®ç€public static final int FLAG_KEEP_SCREEN_ON = 0x00000080;// å…è®¸ Window å æ»¡æ•´ä¸ªå±å¹•public static final int FLAG_LAYOUT_IN_SCREEN = 0x00000100;// å…è®¸ Window è¶…è¿‡å±å¹•ä¹‹å¤–public static final int FLAG_LAYOUT_NO_LIMITS = 0x00000200;// å…¨å±æ˜¾ç¤ºï¼Œéšè—æ‰€æœ‰çš„ Window è£…é¥°ï¼Œæ¯”å¦‚åœ¨æ¸¸æˆã€æ’­æ”¾å™¨ä¸­çš„å…¨å±æ˜¾ç¤ºpublic static final int FLAG_FULLSCREEN = 0x00000400;// è¡¨ç¤ºæ¯”FLAG_FULLSCREENä½ä¸€çº§ï¼Œä¼šæ˜¾ç¤ºçŠ¶æ€æ public static final int FLAG_FORCE_NOT_FULLSCREEN = 0x00000800;// å½“ç”¨æˆ·çš„è„¸è´´è¿‘å±å¹•æ—¶ï¼ˆæ¯”å¦‚æ‰“ç”µè¯ï¼‰ï¼Œä¸ä¼šå»å“åº”æ­¤äº‹ä»¶public static final int FLAG_IGNORE_CHEEK_PRESSES = 0x00008000;// åˆ™å½“æŒ‰é”®åŠ¨ä½œå‘ç”Ÿåœ¨ Window ä¹‹å¤–æ—¶ï¼Œå°†æ¥æ”¶åˆ°ä¸€ä¸ªMotionEvent.ACTION_OUTSIDEäº‹ä»¶ã€‚public static final int FLAG_WATCH_OUTSIDE_TOUCH = 0x00040000;@Deprecated// çª—å£å¯ä»¥åœ¨é”å±çš„ Window ä¹‹ä¸Šæ˜¾ç¤º, ä½¿ç”¨ Activity#setShowWhenLocked(boolean) æ–¹æ³•ä»£æ›¿public static final int FLAG_SHOW_WHEN_LOCKED = 0x00080000;// è¡¨ç¤ºè´Ÿè´£ç»˜åˆ¶ç³»ç»Ÿæ èƒŒæ™¯ã€‚å¦‚æœè®¾ç½®ï¼Œç³»ç»Ÿæ å°†ä»¥é€æ˜èƒŒæ™¯ç»˜åˆ¶ï¼Œ// æ­¤ Window ä¸­çš„ç›¸åº”åŒºåŸŸå°†å¡«å…… Windowï¼ƒgetStatusBarColorï¼ˆï¼‰å’Œ Windowï¼ƒgetNavigationBarColorï¼ˆï¼‰ä¸­æŒ‡å®šçš„é¢œè‰²ã€‚public static final int FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS = 0x80000000;// è¡¨ç¤ºè¦æ±‚ç³»ç»Ÿå£çº¸æ˜¾ç¤ºåœ¨è¯¥ Window åé¢ï¼ŒWindow è¡¨é¢å¿…é¡»æ˜¯åŠé€æ˜çš„ï¼Œæ‰èƒ½çœŸæ­£çœ‹åˆ°å®ƒèƒŒåçš„å£çº¸public static final int FLAG_SHOW_WALLPAPER = 0x00100000; windowçš„solfInputModeå±æ€§è¿™ä¸€éƒ¨åˆ†å°±æ˜¯å½“è½¯ä»¶ç›˜å¼¹èµ·æ¥çš„æ—¶å€™ï¼Œwindowçš„å¤„ç†é€»è¾‘ï¼Œè¿™åœ¨æ—¥å¸¸ä¸­ä¹Ÿç»å¸¸é‡åˆ°ï¼Œå¦‚ï¼šæˆ‘ä»¬åœ¨å¾®ä¿¡èŠå¤©çš„æ—¶å€™ï¼Œç‚¹å‡»è¾“å…¥æ¡†ï¼Œå½“è½¯é”®ç›˜å¼¹èµ·æ¥çš„æ—¶å€™è¾“å…¥æ¡†ä¹Ÿä¼šè¢«é¡¶ä¸Šå»ã€‚å¦‚æœä½ ä¸æƒ³è¢«é¡¶ä¸Šå»ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸ºè¢«è½¯é”®ç›˜è¦†ç›–ã€‚ä¸‹é¢ä»‹ç»ä¸€ä¸‹å¸¸è§çš„å±æ€§ï¼ˆä»¥ä¸‹å¸¸è§å±æ€§ä»‹ç»é€‰è‡ªå‚è€ƒæ–‡çŒ®ç¬¬ä¸€ç¯‡æ–‡ç« ï¼‰ï¼š å¤åˆ¶ä»£ç  123456789101112131415161718192021222324252627282930313233// æ²¡æœ‰æŒ‡å®šçŠ¶æ€ï¼Œç³»ç»Ÿä¼šé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„çŠ¶æ€æˆ–è€…ä¾èµ–äºä¸»é¢˜çš„é…ç½®public static final int SOFT_INPUT_STATE_UNCHANGED = 1;// å½“ç”¨æˆ·è¿›å…¥è¯¥çª—å£æ—¶ï¼Œéšè—è½¯é”®ç›˜public static final int SOFT_INPUT_STATE_HIDDEN = 2;// å½“çª—å£è·å–ç„¦ç‚¹æ—¶ï¼Œéšè—è½¯é”®ç›˜public static final int SOFT_INPUT_STATE_ALWAYS_HIDDEN = 3;// å½“ç”¨æˆ·è¿›å…¥çª—å£æ—¶ï¼Œæ˜¾ç¤ºè½¯é”®ç›˜public static final int SOFT_INPUT_STATE_VISIBLE = 4;// å½“çª—å£è·å–ç„¦ç‚¹æ—¶ï¼Œæ˜¾ç¤ºè½¯é”®ç›˜public static final int SOFT_INPUT_STATE_ALWAYS_VISIBLE = 5;// windowä¼šè°ƒæ•´å¤§å°ä»¥é€‚åº”è½¯é”®ç›˜çª—å£public static final int SOFT_INPUT_MASK_ADJUST = 0xf0;// æ²¡æœ‰æŒ‡å®šçŠ¶æ€,ç³»ç»Ÿä¼šé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„çŠ¶æ€æˆ–ä¾èµ–äºä¸»é¢˜çš„è®¾ç½®public static final int SOFT_INPUT_ADJUST_UNSPECIFIED = 0x00;// å½“è½¯é”®ç›˜å¼¹å‡ºæ—¶ï¼Œçª—å£ä¼šè°ƒæ•´å¤§å°,ä¾‹å¦‚ç‚¹å‡»ä¸€ä¸ªEditViewï¼Œæ•´ä¸ªlayoutéƒ½å°†å¹³ç§»å¯è§ä¸”å¤„äºè½¯ä»¶ç›˜çš„ä¸Šæ–¹// åŒæ ·çš„è¯¥æ¨¡å¼ä¸èƒ½ä¸SOFT_INPUT_ADJUST_PANç»“åˆä½¿ç”¨ï¼›// å¦‚æœçª—å£çš„å¸ƒå±€å‚æ•°æ ‡å¿—åŒ…å«FLAG_FULLSCREENï¼Œåˆ™å°†å¿½ç•¥è¿™ä¸ªå€¼ï¼Œçª—å£ä¸ä¼šè°ƒæ•´å¤§å°ï¼Œä½†ä¼šä¿æŒå…¨å±ã€‚public static final int SOFT_INPUT_ADJUST_RESIZE = 0x10;// å½“è½¯é”®ç›˜å¼¹å‡ºæ—¶ï¼Œçª—å£ä¸éœ€è¦è°ƒæ•´å¤§å°, è¦ç¡®ä¿è¾“å…¥ç„¦ç‚¹æ˜¯å¯è§çš„,// ä¾‹å¦‚æœ‰ä¸¤ä¸ªEditViewçš„è¾“å…¥æ¡†ï¼Œä¸€ä¸ªä¸ºEv1ï¼Œä¸€ä¸ªä¸ºEv2ï¼Œå½“ä½ ç‚¹å‡»Ev1æƒ³è¦è¾“å…¥æ•°æ®æ—¶ï¼Œå½“å‰çš„Ev1çš„è¾“å…¥æ¡†ä¼šç§»åˆ°è½¯é”®ç›˜ä¸Šæ–¹// è¯¥æ¨¡å¼ä¸èƒ½ä¸SOFT_INPUT_ADJUST_RESIZEç»“åˆä½¿ç”¨public static final int SOFT_INPUT_ADJUST_PAN = 0x20;// å°†ä¸ä¼šè°ƒæ•´å¤§å°ï¼Œç›´æ¥è¦†ç›–åœ¨windowä¸Špublic static final int SOFT_INPUT_ADJUST_NOTHING = 0x30; windowçš„å…¶ä»–å±æ€§ä¸Šé¢çš„ä¸‰ä¸ªå±æ€§æ˜¯windowæ¯”è¾ƒé‡è¦ä¹Ÿæ˜¯æ¯”è¾ƒå¤æ‚ çš„ä¸‰ä¸ªï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰å‡ ä¸ªæ—¥å¸¸ç»å¸¸ä½¿ç”¨çš„å±æ€§ï¼š xä¸yå±æ€§ï¼šæŒ‡å®šwindowçš„ä½ç½® alphaï¼šwindowçš„é€æ˜åº¦ gravityï¼šwindowåœ¨å±å¹•ä¸­çš„ä½ç½®ï¼Œä½¿ç”¨çš„æ˜¯Gravityç±»çš„å¸¸é‡ formatï¼šwindowçš„åƒç´ ç‚¹æ ¼å¼ï¼Œå€¼å®šä¹‰åœ¨PixelFormatä¸­ å¦‚ä½•ç»™windowå±æ€§èµ‹å€¼windowå±æ€§çš„å¸¸é‡å€¼å¤§éƒ¨åˆ†å­˜å‚¨åœ¨WindowManager.LayoutParamsç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªç±»æ¥è·å¾—è¿™äº›å¸¸é‡ã€‚å½“ç„¶è¿˜æœ‰Gravityç±»å’ŒPixelFormatç±»ç­‰ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥å¾€å±å¹•ä¸­æ·»åŠ ä¸€ä¸ªwindowï¼š å¤åˆ¶ä»£ç  12345// åœ¨Activityä¸­è°ƒç”¨WindowManager.LayoutParams windowParams = new WindowManager.LayoutParams();windParams.flags = WindowManager.LayoutParams.FLAG_FULLSCREEN;TextView view = new TextView(this);getWindowManager.addview(view,windowParams); æˆ‘ä»¬å¯ä»¥ç›´æ¥ç»™WindowManager.LayoutParamså¯¹è±¡è®¾ç½®å±æ€§ã€‚ ç¬¬äºŒç§èµ‹å€¼æ–¹æ³•æ˜¯ç›´æ¥ç»™windowèµ‹å€¼ï¼Œå¦‚ å¤åˆ¶ä»£ç  1getWindow().flags = WindowManager.LayoutParams.FLAG_FULLSCREEN; é™¤æ­¤ä¹‹å¤–ï¼Œwindowçš„solfInputModeå±æ€§æ¯”è¾ƒç‰¹æ®Šï¼Œä»–å¯ä»¥ç›´æ¥åœ¨AndroidManifestä¸­æŒ‡å®šï¼Œå¦‚ä¸‹ï¼š å¤åˆ¶ä»£ç  1&lt;activity android:windowSoftInputMode=&quot;adjustNothing&quot; /&gt; æœ€åæ€»ç»“ä¸€ä¸‹ï¼š windowçš„é‡è¦å±æ€§æœ‰typeã€flagsã€solfInputModeã€gravityç­‰ æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸åŒçš„æ–¹å¼ç»™windowå±æ€§èµ‹å€¼ æ²¡å¿…è¦å»å…¨éƒ¨è®°ä¸‹æ¥ï¼Œç­‰é‡åˆ°éœ€æ±‚å†å»å¯»æ‰¾å¯¹åº”çš„å¸¸é‡å³å¯ æœªæ•´ç†http://3dobe.com/archives/89/ ä¸€ä¸ªActivityæˆ–ä¸€ä¸ªDialogå¯¹åº”ä¸€ä¸ªPhoneWindowï¼Œä¸€ä¸ªPhoneWindowå¯¹åº”ä¸€ä¸ªWindowMangerï¼Œå¯¹åº”ä¸€ä¸ªWindowManagerImpl æ‰€ä»¥å¾— mChoreographerï¼ŒChoreographerçš„å®ä¾‹ï¼Œåœ¨SampleWindowçš„ä¾‹å­ä¸­å·²ç»è§è¿‡äº†ã€‚Choreographerçš„æ„æ€æ˜¯ç¼–èˆæŒ‡å¯¼ã€‚å®ƒæ‹¥æœ‰ä»æ˜¾ç¤ºå­ç³»ç»Ÿè·å–VSYNCåŒæ­¥äº‹ä»¶çš„èƒ½åŠ›ï¼Œä»è€Œå¯ä»¥åœ¨åˆé€‚çš„æ—¶æœºé€šçŸ¥æ¸²æŸ“åŠ¨ä½œï¼Œé¿å…åœ¨æ¸²æŸ“çš„è¿‡ç¨‹ä¸­å› ä¸ºå‘ç”Ÿå±å¹•é‡ç»˜è€Œå¯¼è‡´çš„ç”»é¢æ’•è£‚ã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šè®²ï¼ŒChoreographerçš„ç¡®æ˜¯æŒ‡å¯¼Androidç¿©ç¿©èµ·èˆçš„å¤§å¸ˆã€‚WMSä½¿ç”¨Choreographerè´Ÿè´£é©±åŠ¨æ‰€æœ‰çš„çª—å£åŠ¨ç”»ã€å±å¹•æ—‹è½¬åŠ¨ç”»ã€å¢™çº¸åŠ¨ç”»çš„æ¸²æŸ“ã€‚ mAnimatorï¼ŒWindowAnimatorçš„å®ä¾‹ã€‚å®ƒæ˜¯æ‰€æœ‰çª—å£åŠ¨ç”»çš„æ€»ç®¡ï¼ˆçª—å£åŠ¨ç”»æ˜¯ä¸€ä¸ªWindowStateAnimatorå¯¹è±¡ï¼‰ã€‚åœ¨Choreographerçš„é©±åŠ¨ä¸‹ï¼Œé€ä¸ªæ¸²æŸ“æ‰€æœ‰çš„åŠ¨ç”»ã€‚ mPolicyï¼ŒWindowPolicyManagerçš„ä¸€ä¸ªå®ç°ã€‚ç›®å‰å®ƒåªæœ‰PhoneWindowManagerä¸€ä¸ªå®ç°ç±»ã€‚mPolicyå®šä¹‰äº†å¾ˆå¤šçª—å£ç›¸å…³çš„ç­–ç•¥ï¼Œå¯ä»¥è¯´æ˜¯WMSçš„é¦–å¸­é¡¾é—®ï¼æ¯å½“WMSè¦åšä»€ä¹ˆäº‹æƒ…çš„æ—¶å€™ï¼Œéƒ½éœ€è¦å‘è¿™ä¸ªé¡¾é—®è¯·æ•™åº”å½“å¦‚ä½•åšã€‚ä¾‹å¦‚ï¼Œå‘Šè¯‰WMSæŸä¸€ä¸ªç±»å‹çš„Windowçš„ZOrderçš„å€¼æ˜¯å¤šå°‘ï¼Œå¸®åŠ©WMSçŸ«æ­£ä¸åˆç†çš„çª—å£å±æ€§ï¼Œä¼šä¸ºWMSç›‘å¬å±å¹•æ—‹è½¬çš„çŠ¶æ€ï¼Œè¿˜ä¼šé¢„å¤„ç†ä¸€äº›ç³»ç»ŸæŒ‰é”®äº‹ä»¶ï¼ˆä¾‹å¦‚HOMEã€BACKé”®ç­‰çš„é»˜è®¤è¡Œä¸ºå°±æ˜¯åœ¨è¿™é‡Œå®ç°çš„ï¼‰ï¼Œç­‰ç­‰ã€‚æ‰€ä»¥ï¼ŒmPolicyå¯è°“æ˜¯WMSä¸­æœ€é‡è¦çš„ä¸€ä¸ªæˆå‘˜äº†ã€‚ mDisplayContentsï¼Œä¸€ä¸ªDisplayContentç±»å‹çš„åˆ—è¡¨ã€‚Android 4.2æ”¯æŒåŸºäºWi-Fi Displayçš„å¤šå±å¹•è¾“å‡ºï¼Œè€Œä¸€ä¸ªDisplayContentæè¿°äº†ä¸€å—å¯ä»¥ç»˜åˆ¶çª—å£çš„å±å¹•ã€‚æ¯ä¸ªDisplayContentéƒ½ç”¨ä¸€ä¸ªæ•´å‹å˜é‡ä½œä¸ºå…¶IDï¼Œå…¶ä¸­æ‰‹æœºé»˜è®¤å±å¹•çš„IDç”±Display.DEFAULT_DISPLAYå¸¸é‡æŒ‡å®šã€‚DisplayContentçš„ç®¡ç†æ˜¯ç”±DisplayManagerServiceå®Œæˆçš„ï¼Œåœ¨æœ¬ç« ä¸ä¼šå»æ¢è®¨DisplayContentçš„å®ç°ç»†èŠ‚ï¼Œè€Œæ˜¯å…³æ³¨DisplayContentå¯¹çª—å£ç®¡ç†ä¸å¸ƒå±€çš„å½±å“ mTokenMapï¼Œä¸€ä¸ªHashMapï¼Œä¿å­˜äº†æ‰€æœ‰çš„æ˜¾ç¤ºä»¤ç‰Œï¼ˆç±»å‹ä¸ºWindowTokenï¼‰ï¼Œç”¨äºçª—å£ç®¡ç†ã€‚åœ¨SampleWindowä¾‹å­ä¸­æ›¾ç»æåˆ°è¿‡ï¼Œä¸€ä¸ªçª—å£å¿…é¡»éš¶å±äºæŸä¸€ä¸ªæ˜¾ç¤ºä»¤ç‰Œã€‚åœ¨é‚£ä¸ªä¾‹å­ä¸­æ‰€æ·»åŠ çš„ä»¤ç‰Œå°±è¢«æ”¾è¿›äº†è¿™ä¸ªHashMapä¸­ã€‚ä»è¿™ä¸ªæˆå‘˜ä¸­è¿˜è¡ç”Ÿå‡ºå‡ ä¸ªè¾…åŠ©çš„æ˜¾ç¤ºä»¤ç‰Œçš„å­é›†ï¼Œä¾‹å¦‚mAppTokensä¿å­˜äº†æ‰€æœ‰å±äºActivityçš„æ˜¾ç¤ºä»¤ç‰Œï¼ˆWindowTokençš„å­ç±»AppWindowTokenï¼‰ï¼ŒmExitingTokensåˆ™ä¿å­˜äº†æ­£åœ¨é€€å‡ºè¿‡ç¨‹ä¸­çš„æ˜¾ç¤ºä»¤ç‰Œç­‰ã€‚å…¶ä¸­mAppTokensåˆ—è¡¨æ˜¯æœ‰åºçš„ï¼Œå®ƒä¸AMSä¸­çš„mHistoryåˆ—è¡¨çš„é¡ºåºä¿æŒä¸€è‡´ï¼Œåæ˜ äº†ç³»ç»Ÿä¸­Activityçš„é¡ºåºã€‚ mWindowMapï¼Œä¹Ÿæ˜¯ä¸€ä¸ªHashMapï¼Œä¿å­˜äº†æ‰€æœ‰çª—å£çš„çŠ¶æ€ä¿¡æ¯ï¼ˆç±»å‹ä¸ºWindowStateï¼‰ï¼Œç”¨äºçª—å£ç®¡ç†ã€‚åœ¨SampleWindowä¾‹å­ä¸­ï¼Œä½¿ç”¨IWindowSession.addï¼ˆï¼‰æ‰€æ·»åŠ çš„çª—å£çš„çŠ¶æ€å°†ä¼šè¢«ä¿å­˜åœ¨mWindowMapä¸­ã€‚ä¸mTokenMapä¸€æ ·ï¼ŒmWindowMapä¸€æ ·æœ‰è¡ç”Ÿå‡ºçš„å­é›†ã€‚ä¾‹å¦‚mPendingRemoveä¿å­˜äº†é‚£äº›é€€å‡ºåŠ¨ç”»æ’­æ”¾å®Œæˆå¹¶å³å°†è¢«ç§»é™¤çš„çª—å£ï¼ŒmLosingFocusåˆ™ä¿å­˜äº†é‚£äº›å¤±å»äº†è¾“å…¥ç„¦ç‚¹çš„çª—å£ã€‚åœ¨DisplayContentä¸­ï¼Œä¹Ÿæœ‰ä¸€ä¸ªwindowsåˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨å­˜å‚¨äº†æ˜¾ç¤ºåœ¨æ­¤Display-Contentä¸­çš„çª—å£ï¼Œå¹¶ä¸”å®ƒæ˜¯æœ‰åºçš„ã€‚çª—å£åœ¨è¿™ä¸ªåˆ—è¡¨ä¸­çš„ä½ç½®å†³å®šäº†å…¶æœ€ç»ˆæ˜¾ç¤ºæ—¶çš„Zåºã€‚ mSessionsï¼Œä¸€ä¸ªListï¼Œå…ƒç´ ç±»å‹ä¸ºSessionã€‚Sessionå…¶å®æ˜¯SampleWindowä¾‹å­ä¸­çš„IWindowSessionçš„Bnç«¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒmSessionsè¿™ä¸ªåˆ—è¡¨ä¿å­˜äº†å½“å‰æ‰€æœ‰æƒ³å‘WMSå¯»æ±‚çª—å£ç®¡ç†æœåŠ¡çš„å®¢æˆ·ç«¯ã€‚æ³¨æ„Sessionæ˜¯è¿›ç¨‹å”¯ä¸€çš„ã€‚ mRotationï¼Œåªæ˜¯ä¸€ä¸ªintå‹å˜é‡ã€‚å®ƒä¿å­˜äº†å½“å‰æ‰‹æœºçš„æ—‹è½¬çŠ¶æ€ Android ç³»ç»Ÿé‡‡ç”¨ä¸€ç§ç§°ä¸º Surface çš„å›¾å½¢æ¶æ„ï¼Œç®€è€Œè¨€ä¹‹ï¼Œæ¯ä¸€ä¸ª Activity éƒ½å…³è”æœ‰è‡³å°‘ä¸€ä¸ª Windowï¼ˆçª—å£ï¼‰ï¼Œæ¯ä¸€ä¸ª Window éƒ½å¯¹åº”æœ‰ä¸€ä¸ª Surfaceã€‚ Surface è¿™é‡Œç›´è¯‘è¿‡æ¥å«åš ç»˜å›¾è¡¨é¢ ï¼Œé¡¾åæ€ä¹‰ï¼Œå…¶å¯åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºé˜Ÿåˆ—ï¼Œç”¨äºæè¿° UIï¼Œç»ä¸ç³»ç»ŸæœåŠ¡çš„WindowServiceManager é€šä¿¡åã€é€šè¿‡ SurfaceFlinger æœåŠ¡æŒç»­åˆæˆå¹¶é€æ˜¾åˆ°æ˜¾ç¤ºå±ã€‚ ç”±æ­¤å¯è§ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ª Activity çš„ UI æ¸²æŸ“æœ¬è´¨æ˜¯ ç³»ç»Ÿæä¾›ä¸€å—å†…å­˜ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºè¿›è¡Œç»´æŠ¤ï¼›è¿™å—å†…å­˜å°±æ˜¯ Surfaceï¼Œæœ€ç»ˆé¡µé¢æ‰€æœ‰ View çš„ UI çŠ¶æ€æ•°æ®ï¼Œéƒ½ä¼šè¢«å¡«å……åˆ°åŒä¸€ä¸ª Surface ä¸­ã€‚","link":"/2022/02/16/Window/"},{"title":"Thread","text":"çº¿ç¨‹/è¿›ç¨‹è¿›ç¨‹ï¼šè¿›ç¨‹æ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„ä¸€ä¸ªç‹¬ç«‹å•ä½ (æ‹¥æœ‰ç‹¬ç«‹å†…å­˜ç©ºé—´)ï¼Œä¸€ä¸ªappå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹åŒ…å«çº¿ç¨‹ã€‚ çº¿ç¨‹ï¼šæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå®ä½“,æ˜¯CPUè°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½,å®ƒæ˜¯æ¯”è¿›ç¨‹æ›´å°çš„èƒ½ç‹¬ç«‹è¿è¡Œçš„åŸºæœ¬å•ä½ã€‚çº¿ç¨‹è‡ªå·±åŸºæœ¬ä¸Šä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æº,åªæ‹¥æœ‰ä¸€äº›åœ¨è¿è¡Œä¸­å¿…ä¸å¯å°‘çš„èµ„æº(å¦‚ç¨‹åºè®¡æ•°å™¨,ä¸€ç»„å¯„å­˜å™¨å’Œæ ˆ)ï¼Œä½†æ˜¯å®ƒå¯ä¸åŒå±ä¸€ä¸ªè¿›ç¨‹çš„å…¶ä»–çš„çº¿ç¨‹å…±äº«è¿›ç¨‹æ‰€æ‹¥æœ‰çš„å…¨éƒ¨èµ„æºã€‚ é™æ€çš„æ˜¯èµ„æºå’ŒåŠ¨æ€çš„æ˜¯è®¡ç®— è¿›ç¨‹æ˜¯ä¸€ä¸ªèµ„æºçš„å®¹å™¨ï¼Œä¸ºè¿›ç¨‹é‡Œçš„æ‰€æœ‰çº¿ç¨‹æä¾›å…±äº«èµ„æºï¼Œæ˜¯å¯¹ç¨‹åºçš„ä¸€ç§é™æ€æè¿° çº¿ç¨‹æ˜¯è®¡ç®—æœºæœ€å°çš„è°ƒåº¦å’Œè¿è¡Œï¼ˆè®¡ç®—ï¼‰å•ä½ï¼Œæ˜¯å¯¹ç¨‹åºçš„ä¸€ç§åŠ¨æ€æè¿° Javaé‡Œçš„çº¿ç¨‹æœ‰å“ªäº›çŠ¶æ€ï¼ŸJDKä¸­ï¼Œçº¿ç¨‹ï¼ˆThreadï¼‰å®šä¹‰äº†6ç§çŠ¶æ€ï¼š NEWï¼ˆæ–°å»ºï¼‰ã€RUNNABLEï¼ˆå¯æ‰§è¡Œï¼‰ã€BLOCKEDï¼ˆé˜»å¡ï¼‰ã€WAITINGï¼ˆç­‰å¾…ï¼‰ã€TIMED_WAITINGï¼ˆé™æ—¶ç­‰å¾…ï¼‰ã€TERMINATEDï¼ˆç»“æŸï¼‰ã€‚ æºç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899/** * A thread state. A thread can be in one of the following states: * &lt;ul&gt; * &lt;li&gt;{@link #NEW} * A thread that has not yet started is in this state. * &lt;/li&gt; * &lt;li&gt;{@link #RUNNABLE} * A thread executing in the Java virtual machine is in this state. * &lt;/li&gt; * &lt;li&gt;{@link #BLOCKED} * A thread that is blocked waiting for a monitor lock * is in this state. * &lt;/li&gt; * &lt;li&gt;{@link #WAITING} * A thread that is waiting indefinitely for another thread to * perform a particular action is in this state. * &lt;/li&gt; * &lt;li&gt;{@link #TIMED_WAITING} * A thread that is waiting for another thread to perform an action * for up to a specified waiting time is in this state. * &lt;/li&gt; * &lt;li&gt;{@link #TERMINATED} * A thread that has exited is in this state. * &lt;/li&gt; * &lt;/ul&gt; * * &lt;p&gt; * A thread can be in only one state at a given point in time. * These states are virtual machine states which do not reflect * any operating system thread states. * * @since 1.5 * @see #getState */public enum State { /** * Thread state for a thread which has not yet started. */ NEW, /** * Thread state for a runnable thread. A thread in the runnable * state is executing in the Java virtual machine but it may * be waiting for other resources from the operating system * such as processor. */ RUNNABLE, /** * Thread state for a thread blocked waiting for a monitor lock. * A thread in the blocked state is waiting for a monitor lock * to enter a synchronized block/method or * reenter a synchronized block/method after calling * {@link Object#wait() Object.wait}. */ BLOCKED, /** * Thread state for a waiting thread. * A thread is in the waiting state due to calling one of the * following methods: * &lt;ul&gt; * &lt;li&gt;{@link Object#wait() Object.wait} with no timeout&lt;/li&gt; * &lt;li&gt;{@link #join() Thread.join} with no timeout&lt;/li&gt; * &lt;li&gt;{@link LockSupport#park() LockSupport.park}&lt;/li&gt; * &lt;/ul&gt; * * &lt;p&gt;A thread in the waiting state is waiting for another thread to * perform a particular action. * * For example, a thread that has called &lt;tt&gt;Object.wait()&lt;/tt&gt; * on an object is waiting for another thread to call * &lt;tt&gt;Object.notify()&lt;/tt&gt; or &lt;tt&gt;Object.notifyAll()&lt;/tt&gt; on * that object. A thread that has called &lt;tt&gt;Thread.join()&lt;/tt&gt; * is waiting for a specified thread to terminate. */ WAITING, /** * Thread state for a waiting thread with a specified waiting time. * A thread is in the timed waiting state due to calling one of * the following methods with a specified positive waiting time: * &lt;ul&gt; * &lt;li&gt;{@link #sleep Thread.sleep}&lt;/li&gt; * &lt;li&gt;{@link Object#wait(long) Object.wait} with timeout&lt;/li&gt; * &lt;li&gt;{@link #join(long) Thread.join} with timeout&lt;/li&gt; * &lt;li&gt;{@link LockSupport#parkNanos LockSupport.parkNanos}&lt;/li&gt; * &lt;li&gt;{@link LockSupport#parkUntil LockSupport.parkUntil}&lt;/li&gt; * &lt;/ul&gt; */ TIMED_WAITING, /** * Thread state for a terminated thread. * The thread has completed execution. */ TERMINATED;} çŠ¶æ€è¯´æ˜çº¿ç¨‹åœ¨ä¸€ä¸ªç»™å®šçš„æ—¶é—´ç‚¹åªèƒ½å¤„äºä¸‹é¢å…¶ä¸­ä¸€ç§çŠ¶æ€ï¼š è¿™äº›çŠ¶æ€æ˜¯è™šæ‹ŸæœºçŠ¶æ€ï¼Œå¹¶ä¸èƒ½åæ˜ ä»»ä½•æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹çŠ¶æ€ã€‚ NEWï¼šå°šæœªå¯åŠ¨çš„çº¿ç¨‹å¤„äºè¿™ä¸ªçŠ¶æ€ã€‚Thread thread = new Thread(new Runnable(){â€¦});å¤„äºè¿™ä¸ªçŠ¶æ€ã€‚ RUNNABLEï¼šå¯è¿è¡Œçš„çº¿ç¨‹å¤„äºè¿™ä¸ªçŠ¶æ€ã€‚å¯¹åº”æ“ä½œç³»ç»Ÿä¸­çš„ä¸¤ç§çŠ¶æ€ï¼šreadyå’Œrunningï¼Œä¹Ÿå°±æ˜¯è¯´RUNNABLEçŠ¶æ€æ—¢å¯ä»¥æ˜¯å¯è¿è¡Œçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å®é™…è¿è¡Œä¸­çš„ï¼Œæœ‰å¯èƒ½æ­£åœ¨æ‰§è¡Œï¼Œä¹Ÿæœ‰å¯èƒ½æ²¡æœ‰æ­£åœ¨æ‰§è¡Œã€‚å…³äºè¿™ä¸ªé—®é¢˜çš„ç†è§£ï¼Œå¯ä»¥å¯¹æ¯”æƒ³ä¸€ä¸‹ï¼Œthread.start()è°ƒç”¨ä¹‹åçº¿ç¨‹ä¼šç«‹åˆ»æ‰§è¡Œå—ï¼Ÿ BLOCKEDï¼šé˜»å¡ï¼Œè¿›å…¥synchronizedä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—ï¼Œç­‰å¾…ç›‘è§†å™¨é”çš„çº¿ç¨‹å¤„äºè¿™ä¸ªçŠ¶æ€ã€‚ WAITINGï¼šæ— é™æœŸç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç‰¹å®šæ“ä½œçš„çº¿ç¨‹å¤„äºè¿™ç§çŠ¶æ€ã€‚ TIMED_WAITINGï¼šæ­£åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒæŸä¸ªæ“ä½œçš„çº¿ç¨‹åœ¨æŒ‡å®šçš„ç­‰å¾…æ—¶é—´å†…å¤„äºè¿™ç§çŠ¶æ€ã€‚ TERMINATEDï¼šå·²ç»é€€å‡ºçš„çº¿ç¨‹å¤„äºè¿™ä¸ªçŠ¶æ€ã€‚ çŠ¶æ€è½¬ç§»NEWï¼šçº¿ç¨‹å°šæœªå¯åŠ¨çš„çº¿ç¨‹çŠ¶æ€ã€‚å½“åœ¨ç¨‹åºä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™Thread t = new Thread(Runnable);ï¼Œçº¿ç¨‹å¤„äºNEWçŠ¶æ€ã€‚ RUNNABLEï¼šå¯è¿è¡Œçº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ã€‚å¤„äºå¯è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹æ­£åœ¨Javaè™šæ‹Ÿæœºä¸­æ‰§è¡Œï¼Œä½†å®ƒå¯èƒ½æ­£åœ¨ç­‰å¾…æ“ä½œç³»ç»Ÿä¸­çš„å…¶ä»–èµ„æºï¼Œæ¯”å¦‚å¤„ç†å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ è¿™ä¸ªçŠ¶æ€å°±æ˜¯å¯è¿è¡Œä¹Ÿå¯ä¸è¿è¡Œçš„çŠ¶æ€ã€‚æ³¨æ„Runnable â‰  Runningã€‚ BLOCKEDï¼šè¿›å…¥synchronizedä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—ï¼Œç­‰å¾…ç›‘è§†å™¨é”çš„é˜»å¡çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ã€‚æ¯”å¦‚ï¼Œçº¿ç¨‹è¯•å›¾é€šè¿‡synchronizedå»è·å–ç›‘è§†å™¨é”ï¼Œä½†æ˜¯å…¶ä»–çº¿ç¨‹å·²ç»ç‹¬å äº†ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±ä¼šå¤„äºé˜»å¡çŠ¶æ€ã€‚ç­‰åˆ°è·å¾—äº†ç›‘è§†å™¨é”ä¹‹åä¼šå†æ¬¡è¿›å…¥RUNNABLEçŠ¶æ€ã€‚ WAITINGï¼šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€ï¼Œçº¿ç¨‹ä¼šå¤„äºç­‰å¾…çŠ¶æ€ï¼š Object.wait()æ³¨æ„ï¼šæ‹¬å·å†…ä¸å¸¦å‚æ•°ï¼› Thread.join()æ³¨æ„ï¼šæ‰©å·å†…ä¸å¸¦å‚æ•°ï¼› LockSupport.park()ï¼› å…¶å®wait()æ–¹æ³•æœ‰å¤šé‡å½¢å¼ï¼Œå¯ä»¥ä¸å¸¦å‚æ•°ï¼Œå¯ä»¥å¸¦å‚æ•°ï¼Œå‚æ•°è¡¨ç¤ºç­‰å¾…æ—¶é—´ï¼ˆå•ä½msï¼‰ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š â€œBLOCKEDï¼ˆé˜»å¡çŠ¶æ€ï¼‰â€å’Œâ€œWAITINGï¼ˆç­‰å¾…çŠ¶æ€ï¼‰â€çš„åŒºåˆ«ï¼šé˜»å¡çŠ¶æ€åœ¨ç­‰å¾…è·å–ä¸€ä¸ªæ’å®ƒé”ï¼Œè¿™ä¸ªäº‹ä»¶å°†ä¼šåœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ”¾å¼ƒè¿™ä¸ªé”çš„æ—¶å€™å‘ç”Ÿï¼Œç„¶åç”±é˜»å¡çŠ¶æ€å˜ä¸ºå¯æ‰§è¡ŒçŠ¶æ€ï¼›è€Œç­‰å¾…çŠ¶æ€åˆ™æ˜¯åœ¨ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…ç­‰å¾…å”¤é†’åŠ¨ä½œçš„å‘ç”Ÿã€‚ TIMED_WAITINGï¼šä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€ï¼ˆæ–¹æ³•éœ€è¦å¸¦å…·ä½“çš„ç­‰å¾…æ—¶é—´ï¼‰ï¼Œä¼šå¤„äºå®šæ—¶ç­‰å¾…çŠ¶æ€ï¼š Thread.sleep(long timeout) Object.wait(long timeout) Thread.join(long timeout) LockSupport.parkNanos() LockSupport.parkUntil() TERMINATEDï¼š è¯¥çº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚æ‰§è¡Œå®Œæ¯•æŒ‡çš„æ˜¯çº¿ç¨‹æ­£å¸¸æ‰§è¡Œå®Œäº†runæ–¹æ³•ä¹‹åé€€å‡ºï¼Œä¹Ÿå¯ä»¥æ˜¯é‡åˆ°äº†æœªæ•è·çš„å¼‚å¸¸è€Œé€€å‡ºã€‚ åˆå§‹(NEW)æ–°åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œä½†è¿˜æ²¡æœ‰è°ƒç”¨start()æ–¹æ³•ã€‚ è¿è¡Œ(RUNNABLE)ReadyRunningJavaçº¿ç¨‹ä¸­å°†å°±ç»ªï¼ˆreadyï¼‰å’Œè¿è¡Œä¸­ï¼ˆrunningï¼‰ä¸¤ç§çŠ¶æ€ç¬¼ç»Ÿ çš„ç§°ä¸ºâ€œè¿è¡Œâ€ã€‚çº¿ç¨‹å¯¹è±¡åˆ›å»ºåï¼Œå…¶ä»–çº¿ç¨‹(æ¯”å¦‚mainçº¿ç¨‹ï¼‰è°ƒç”¨äº†è¯¥å¯¹è±¡çš„start()æ–¹ æ³•ã€‚è¯¥çŠ¶æ€çš„çº¿ç¨‹ä½äºå¯è¿è¡Œçº¿ç¨‹æ± ä¸­ï¼Œç­‰å¾…è¢«çº¿ç¨‹è°ƒåº¦é€‰ä¸­ï¼Œè·å–CPUçš„ä½¿ç”¨æƒï¼Œæ­¤ æ—¶å¤„äºå°±ç»ªçŠ¶æ€ï¼ˆreadyï¼‰ã€‚å°±ç»ªçŠ¶æ€çš„çº¿ç¨‹åœ¨è·å¾—CPUæ—¶é—´ç‰‡åå˜ä¸ºè¿è¡Œä¸­çŠ¶æ€ ï¼ˆrunningï¼‰ã€‚ é˜»å¡(BLOCKED)è¡¨ç¤ºçº¿ç¨‹é˜»å¡äºé”ã€‚æˆ–ç§°â€œæŒ‚èµ·â€ é˜»å¡æˆ–å”¤é†’ä¸€ä¸ªJavaçº¿ç¨‹éœ€è¦æ“ä½œç³»ç»Ÿåˆ‡æ¢CPUçŠ¶æ€æ¥å®Œæˆï¼Œè¿™ç§çŠ¶æ€è½¬æ¢éœ€è¦è€—è´¹å¤„ç†å™¨æ—¶é—´ ç­‰å¾…(WAITING)ç­‰å¾…çŠ¶æ€ï¼Œå¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹æ˜¯ç”±äºæ‰§è¡Œäº†Thread.joinæˆ–Object.waitæ–¹æ³• å¤„äºwaitingçŠ¶æ€çš„çº¿ç¨‹ä¼šç­‰å¾…å¦å¤–ä¸€ä¸ªçº¿ç¨‹å¤„ç†ç‰¹æ®Šçš„è¡Œä¸ºã€‚ å†ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†ä¸€ä¸ªå¯¹è±¡çš„waitæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±ä¼šå¤„äºwaitingçŠ¶æ€ç›´åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„notifyæˆ–è€…notifyAllæ–¹æ³•åæ‰ä¼šè§£é™¤è¿™ä¸ªçŠ¶æ€ è¶…æ—¶ç­‰å¾…(TIMED_WAITING)æœ‰ç­‰å¾…æ—¶é—´çš„ç­‰å¾…çŠ¶æ€ï¼Œæ¯”å¦‚è°ƒç”¨äº†**Thread.sleep(long timeout)ã€Thread.join(long timeout)ã€Object.wait(long timeout)**ï¼Œå¹¶ä¸”æŒ‡å®šäº†ç­‰å¾…æ—¶é—´ï¼Œçº¿ç¨‹å°±ä¼šå¤„äºè¿™ä¸ªçŠ¶æ€ã€‚ ç»ˆæ­¢(TERMINATED)è¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚ å¯¹æ¯”åˆ†æJavaä¸­çš„å„ä¸ªçº¿ç¨‹ç›¸å…³çš„wait()ã€notify()ã€sleep()ã€interrupt()æ–¹æ³• çº¿ç¨‹ç›¸å…³æ–¹æ³•Threadç±»sleepï¼šæš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼›ï¼ˆç±»æ–¹æ³•ï¼‰â€‹ æ˜¯Threadçš„é™æ€æ–¹æ³•ï¼Œå¾ˆæ˜¾ç„¶å®ƒæ˜¯è®©å½“å‰çº¿ç¨‹æŒ‰ç…§æŒ‡å®šçš„æ—¶é—´ä¼‘çœ ï¼Œå…¶ä¼‘çœ æ—¶é—´çš„ç²¾åº¦å–å†³äºå¤„ç†å™¨çš„è®¡æ—¶å™¨å’Œè°ƒåº¦å™¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœå½“å‰çº¿ç¨‹è·å¾—äº†é”ï¼Œsleepæ–¹æ³•å¹¶ä¸ä¼šå¤±å»é”ã€‚sleepæ–¹æ³•ç»å¸¸æ‹¿æ¥ä¸Object.wait()æ–¹æ³•è¿›è¡Œæ¯”ä»·ï¼Œè¿™ä¹Ÿæ˜¯é¢è¯•ç»å¸¸è¢«é—®çš„åœ°æ–¹ã€‚ sleep() VS wait() ä¸¤è€…ä¸»è¦çš„åŒºåˆ«ï¼š 1. sleep()æ–¹æ³•æ˜¯Threadçš„é™æ€æ–¹æ³•ï¼Œè€Œwaitæ˜¯Objectå®ä¾‹æ–¹æ³• 2. wait()æ–¹æ³•å¿…é¡»è¦åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»å·²ç»è·å¾—å¯¹è±¡é”ã€‚è€Œsleep()æ–¹æ³•æ²¡æœ‰è¿™ä¸ªé™åˆ¶å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ç§ä½¿ç”¨ã€‚å¦å¤–ï¼Œwait()æ–¹æ³•ä¼šé‡Šæ”¾å æœ‰çš„å¯¹è±¡é”ï¼Œä½¿å¾—è¯¥çº¿ç¨‹è¿›å…¥ç­‰å¾…æ± ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è·å–èµ„æºã€‚è€Œsleep()æ–¹æ³•åªæ˜¯ä¼šè®©å‡ºCPUå¹¶ä¸ä¼šé‡Šæ”¾æ‰å¯¹è±¡é”ï¼› 3. sleep()æ–¹æ³•åœ¨ä¼‘çœ æ—¶é—´è¾¾åˆ°åå¦‚æœå†æ¬¡è·å¾—CPUæ—¶é—´ç‰‡å°±ä¼šç»§ç»­æ‰§è¡Œï¼Œè€Œwait()æ–¹æ³•å¿…é¡»ç­‰å¾…Object.notift/Object.notifyAllé€šçŸ¥åï¼Œæ‰ä¼šç¦»å¼€ç­‰å¾…æ± ï¼Œå¹¶ä¸”å†æ¬¡è·å¾—CPUæ—¶é—´ç‰‡æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚ yieldï¼šæš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œå…¶ä»–çº¿ç¨‹ï¼›ï¼ˆç±»æ–¹æ³•ï¼‰â€‹ æ˜¯Threadçš„é™æ€æ–¹æ³•ï¼Œä¸€æ—¦æ‰§è¡Œï¼Œå®ƒä¼šæ˜¯å½“å‰çº¿ç¨‹è®©å‡ºCPUï¼Œä½†æ˜¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè®©å‡ºçš„CPUå¹¶ä¸æ˜¯ä»£è¡¨å½“å‰çº¿ç¨‹ä¸å†è¿è¡Œäº†ï¼Œå¦‚æœåœ¨ä¸‹ä¸€æ¬¡ç«äº‰ä¸­ï¼Œåˆè·å¾—äº†CPUæ—¶é—´ç‰‡å½“å‰çº¿ç¨‹ä¾ç„¶ä¼šç»§ç»­è¿è¡Œã€‚å¦å¤–ï¼Œè®©å‡ºçš„æ—¶é—´ç‰‡åªä¼šåˆ†é…ç»™å½“å‰çº¿ç¨‹ç›¸åŒä¼˜å…ˆçº§çš„çº¿ç¨‹ã€‚ â€‹ yield()æ–¹æ³•ä½¿å½“å‰çº¿ç¨‹å‡ºè®©CPUæ‰§è¡Œæ—¶é—´ï¼Œä½†å¹¶ä¸ä¼šé‡Šæ”¾å½“å‰çº¿ç¨‹æ‰€æŒæœ‰çš„é”ã€‚æ‰§è¡Œå®Œyield()æ–¹æ³•åï¼Œçº¿ç¨‹ä»RunningçŠ¶æ€è½¬å˜ä¸ºRunnableçŠ¶æ€ï¼Œæ—¢ç„¶æ˜¯RunnableçŠ¶æ€ï¼Œé‚£ä¹ˆä¹Ÿå¾ˆå¯èƒ½é©¬ä¸Šä¼šè¢«CPUè°ƒåº¦å†æ¬¡è¿›å…¥RunningçŠ¶æ€ã€‚ ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¼˜å…ˆçº§äº†ï¼Ÿä¸‹é¢å°±æ¥å…·ä½“èŠä¸€èŠã€‚ ç°ä»£æ“ä½œç³»ç»ŸåŸºæœ¬é‡‡ç”¨æ—¶åˆ†çš„å½¢å¼è°ƒåº¦è¿è¡Œçš„çº¿ç¨‹ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†å‡ºä¸€ä¸ªä¸ªæ—¶é—´ç‰‡ï¼Œçº¿ç¨‹ä¼šåˆ†é…åˆ°è‹¥å¹²æ—¶é—´ç‰‡ï¼Œå½“å‰æ—¶é—´ç‰‡ç”¨å®Œåå°±ä¼šå‘ç”Ÿçº¿ç¨‹è°ƒåº¦ï¼Œå¹¶ç­‰å¾…è¿™ä¸‹æ¬¡åˆ†é…ã€‚çº¿ç¨‹åˆ†é…åˆ°çš„æ—¶é—´å¤šå°‘ä¹Ÿå°±å†³å®šäº†çº¿ç¨‹ä½¿ç”¨å¤„ç†å™¨èµ„æºçš„å¤šå°‘ï¼Œè€Œçº¿ç¨‹ä¼˜å…ˆçº§å°±æ˜¯å†³å®šçº¿ç¨‹éœ€è¦æˆ–å¤šæˆ–å°‘åˆ†é…ä¸€äº›å¤„ç†å™¨èµ„æºçš„çº¿ç¨‹å±æ€§ã€‚ åœ¨Javaç¨‹åºä¸­ï¼Œé€šè¿‡ä¸€ä¸ªæ•´å‹æˆå‘˜å˜é‡Priorityæ¥æ§åˆ¶ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§çš„èŒƒå›´ä»1~10.åœ¨æ„å»ºçº¿ç¨‹çš„æ—¶å€™å¯ä»¥é€šè¿‡**setPriority(int)**æ–¹æ³•è¿›è¡Œè®¾ç½®ï¼Œé»˜è®¤ä¼˜å…ˆçº§ä¸º5ï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ç›¸è¾ƒäºä¼˜å…ˆçº§ä½çš„çº¿ç¨‹ä¼˜å…ˆè·å¾—å¤„ç†å™¨æ—¶é—´ç‰‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ä¸åŒJVMä»¥åŠæ“ä½œç³»ç»Ÿä¸Šï¼Œçº¿ç¨‹è§„åˆ’å­˜åœ¨å·®å¼‚ï¼Œæœ‰äº›æ“ä½œç³»ç»Ÿç”šè‡³ä¼šå¿½ç•¥çº¿ç¨‹ä¼˜å…ˆçº§çš„è®¾å®šã€‚ å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œsleep()å’Œyield()æ–¹æ³•ï¼ŒåŒæ ·éƒ½æ˜¯å½“å‰çº¿ç¨‹ä¼šäº¤å‡ºå¤„ç†å™¨èµ„æºï¼Œè€Œå®ƒä»¬ä¸åŒçš„æ˜¯ï¼Œsleep()äº¤å‡ºæ¥çš„æ—¶é—´ç‰‡å…¶ä»–çº¿ç¨‹éƒ½å¯ä»¥å»ç«äº‰ï¼Œä¹Ÿå°±æ˜¯è¯´éƒ½æœ‰æœºä¼šè·å¾—å½“å‰çº¿ç¨‹è®©å‡ºçš„æ—¶é—´ç‰‡ã€‚è€Œyield()æ–¹æ³•åªå…è®¸ä¸å½“å‰çº¿ç¨‹å…·æœ‰ç›¸åŒä¼˜å…ˆçº§çš„çº¿ç¨‹èƒ½å¤Ÿè·å¾—é‡Šæ”¾å‡ºæ¥çš„CPUæ—¶é—´ç‰‡ã€‚ joinï¼šç­‰å¾…è¯¥çº¿ç¨‹ç»ˆæ­¢ï¼›â€‹ join()æ–¹æ³•çš„ä½œç”¨ï¼Œæ˜¯ç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸï¼Œæ˜¯ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹çš„ç»ˆæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸»çº¿ç¨‹çš„ä»£ç å—ä¸­ï¼Œå¦‚æœç¢°åˆ°äº†t.join()æ–¹æ³•ï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼ˆé˜»å¡ï¼‰ï¼Œç­‰å¾…å­çº¿ç¨‹ç»“æŸäº†(Waits for this thread to die.),æ‰èƒ½ç»§ç»­æ‰§è¡Œt.join()ä¹‹åçš„ä»£ç å—ã€‚ interruptï¼šä¸­æ–­è¯¥çº¿ç¨‹ï¼Œinterrupt()æ–¹æ³•çš„å·¥ä½œä»…ä»…æ˜¯æ”¹å˜ä¸­æ–­çŠ¶æ€ï¼Œå¹¶ä¸æ˜¯ç›´æ¥ä¸­æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ã€‚ä¸­æ–­çš„çœŸæ­£åŸç†æ˜¯å½“çº¿ç¨‹è¢«Object.wait(),Thread.join()æˆ–sleep()æ–¹æ³•é˜»å¡æ—¶ï¼Œè°ƒç”¨interrupt()æ–¹æ³•åæ”¹å˜ä¸­æ–­çŠ¶æ€ï¼Œè€Œwait/join/sleepè¿™äº›æ–¹æ³•å†…éƒ¨ä¼šä¸æ–­åœ°æ£€æŸ¥çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å€¼ï¼Œå½“å‘ç°ä¸­æ–­çŠ¶æ€å€¼æ”¹å˜æ—¶åˆ™æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ï¼›å¯¹äºæ²¡æœ‰é˜»å¡çš„çº¿ç¨‹ï¼Œè°ƒç”¨interrupt()æ–¹æ³•æ˜¯æ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚ Objectç±» waitï¼šæš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œç›´åˆ°è°ƒç”¨notify()æˆ–notifyAll()æ–¹æ³•æˆ–è¶…æ—¶ï¼Œé€€å‡ºç­‰å¾…çŠ¶æ€ï¼› notifyï¼šå”¤é†’åœ¨è¯¥å¯¹è±¡ä¸Šç­‰å¾…çš„ä¸€ä¸ªçº¿ç¨‹ï¼› notifyAllï¼šå”¤é†’åœ¨è¯¥å¯¹è±¡ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹ï¼› å¯¹æ¯”sleep VS waitsleep()å’Œwait()æ–¹æ³•éƒ½æ˜¯æš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œå‡ºè®©CPUèµ„æºã€‚ æ–¹æ³• æ‰€å±ç±» æ–¹æ³•ç±»å‹ é” è§£é™¤æ–¹æ³• åœºæ™¯ ç”¨é€” sleep Thread é™æ€æ–¹æ³• ä¸é‡Šæ”¾é” timeout,interrupt æ— é™åˆ¶ çº¿ç¨‹å†…çš„æ§åˆ¶ wait Object éé™æ€æ–¹æ³• é‡Šæ”¾é” timeout,notify,interrupt åŒæ­¥è¯­å¥å— çº¿ç¨‹é—´çš„é€šä¿¡ 123456public static void sleep(long millis) throws InterruptedException public static void sleep(long millis, int nanos) throws InterruptedException public final void wait() throws InterruptedException public final void wait(long timeout) throws InterruptedException public final void wait(long timeout, int nanos) throws InterruptedException wait &amp;&amp; notifyè°ƒç”¨å¯¹è±¡çš„wait()ã€notify()ã€notifyAll()æ–¹æ³•çš„çº¿ç¨‹ï¼Œå¿…é¡»æ˜¯ä½œä¸ºæ­¤å¯¹è±¡ç›‘è§†å™¨çš„æ‰€æœ‰è€…ã€‚å¸¸è§çš„åœºæ™¯ä¾¿æ˜¯å°±æ˜¯synchronizedå…³é”®å­—çš„è¯­å¥å—å†…éƒ¨ä½¿ç”¨è¿™3ä¸ªæ–¹æ³•ï¼Œå¦‚æœç›´æ¥åœ¨çº¿ç¨‹ä¸­ä½¿ç”¨wait()ã€notify()ã€notifyAll()æ–¹æ³•ï¼Œé‚£ä¹ˆä¼šæŠ›å‡ºå¼‚å¸¸IllegalMonitorStateExceptionï¼ŒæŠ›å‡ºçš„å¼‚å¸¸è¡¨æ˜æŸä¸€çº¿ç¨‹å·²ç»è¯•å›¾ç­‰å¾…å¯¹è±¡çš„ç›‘è§†å™¨ï¼Œæˆ–è€…è¯•å›¾é€šçŸ¥å…¶ä»–æ­£åœ¨ç­‰å¾…å¯¹è±¡çš„ç›‘è§†å™¨è€Œæœ¬èº«æ²¡æœ‰æŒ‡å®šç›‘è§†å™¨çš„çº¿ç¨‹ã€‚ã€‚ è°ƒç”¨wait()æ–¹æ³•çš„çº¿ç¨‹ï¼Œåœ¨è°ƒç”¨è¯¥çº¿ç¨‹çš„interrupt()æ–¹æ³•ï¼Œåˆ™ä¼šé‡æ–°å°è¯•è·å–å¯¹è±¡é”ã€‚åªæœ‰å½“è·å–åˆ°å¯¹è±¡é”ï¼Œæ‰å¼€å§‹æŠ›å‡ºç›¸åº”çš„å¼‚å¸¸ï¼Œåˆ™æ‰§è¡Œè¯¥çº¿ç¨‹ä¹‹åçš„ç¨‹åºã€‚ æ€ä¹ˆç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹é¦–å…ˆï¼Œä¸€ä¸ªçº¿ç¨‹ä¸åº”è¯¥ç”±å…¶ä»–çº¿ç¨‹æ¥å¼ºåˆ¶ä¸­æ–­æˆ–åœæ­¢ï¼Œè€Œæ˜¯åº”è¯¥ç”±çº¿ç¨‹è‡ªå·±è‡ªè¡Œåœæ­¢ã€‚ æ‰€ä»¥ï¼ŒThread.stop, Thread.suspend, Thread.resume éƒ½å·²ç»è¢«åºŸå¼ƒäº†ã€‚ interruptï¼šThread.interrupt çš„ä½œç”¨å…¶å®ä¹Ÿä¸æ˜¯ä¸­æ–­çº¿ç¨‹ï¼Œè€Œæ˜¯ã€Œé€šçŸ¥çº¿ç¨‹åº”è¯¥ä¸­æ–­äº†ã€ï¼Œ å…·ä½“åˆ°åº•ä¸­æ–­è¿˜æ˜¯ç»§ç»­è¿è¡Œï¼Œåº”è¯¥ç”±è¢«é€šçŸ¥çš„çº¿ç¨‹è‡ªå·±å¤„ç†ã€‚ å…·ä½“æ¥è¯´ï¼Œå½“å¯¹ä¸€ä¸ªçº¿ç¨‹ï¼Œè°ƒç”¨ interrupt() æ—¶ï¼Œ â‘  å¦‚æœçº¿ç¨‹å¤„äºè¢«é˜»å¡çŠ¶æ€ï¼ˆä¾‹å¦‚å¤„äºsleep, wait, join ç­‰çŠ¶æ€ï¼‰ï¼Œé‚£ä¹ˆçº¿ç¨‹å°†ç«‹å³é€€å‡ºè¢«é˜»å¡çŠ¶æ€ï¼Œå¹¶æŠ›å‡ºä¸€ä¸ªInterruptedExceptionå¼‚å¸¸ã€‚ä»…æ­¤è€Œå·²ã€‚ â‘¡ å¦‚æœçº¿ç¨‹å¤„äºæ­£å¸¸æ´»åŠ¨çŠ¶æ€ï¼Œé‚£ä¹ˆä¼šå°†è¯¥çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—è®¾ç½®ä¸º trueï¼Œä»…æ­¤è€Œå·²ã€‚è¢«è®¾ç½®ä¸­æ–­æ ‡å¿—çš„çº¿ç¨‹å°†ç»§ç»­æ­£å¸¸è¿è¡Œï¼Œä¸å—å½±å“ã€‚ interrupt() å¹¶ä¸èƒ½çœŸæ­£çš„ä¸­æ–­çº¿ç¨‹ï¼Œéœ€è¦è¢«è°ƒç”¨çš„çº¿ç¨‹è‡ªå·±è¿›è¡Œé…åˆæ‰è¡Œã€‚ â‘  åœ¨æ­£å¸¸è¿è¡Œä»»åŠ¡æ—¶ï¼Œç»å¸¸æ£€æŸ¥æœ¬çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ï¼Œå¦‚æœè¢«è®¾ç½®äº†ä¸­æ–­æ ‡å¿—å°±è‡ªè¡Œåœæ­¢çº¿ç¨‹ã€‚ â‘¡ åœ¨è°ƒç”¨é˜»å¡æ–¹æ³•æ—¶æ­£ç¡®å¤„ç†InterruptedExceptionå¼‚å¸¸ã€‚ï¼ˆä¾‹å¦‚ï¼Œcatchå¼‚å¸¸åå°±ç»“æŸçº¿ç¨‹ã€‚ï¼‰ 123456789Thread thread = new Thread(() -&gt; { while (!Thread.interrupted()) { // do more work. }});thread.start();// ä¸€æ®µæ—¶é—´ä»¥åthread.interrupt(); stop():å¼ƒç”¨ï¼Œå› ä¸ºåœ¨stopæ—¶ä¼šé‡Šæ”¾æ‰€æœ‰çš„é”ï¼Œå¯èƒ½å¯¼è‡´çº¿ç¨‹ä¸åŒæ­¥ï¼Œå¦ä¸€ä¸ªä¹Ÿå¯èƒ½å¯¼è‡´èµ„æºå¦‚æ–‡ä»¶æ–‡ä»¶æ•°æ®åº“çš„å…³é—­è¡Œä¸ºä¸è¢«æ‰§è¡Œ è°ƒç”¨ stop() æ–¹æ³•ä¼šç«‹åˆ»åœæ­¢ run() æ–¹æ³•ä¸­å‰©ä½™çš„å…¨éƒ¨å·¥ä½œï¼ŒåŒ…æ‹¬åœ¨ catch æˆ– finally è¯­å¥ä¸­çš„ï¼Œå¹¶æŠ›å‡ºThreadDeathå¼‚å¸¸(é€šå¸¸æƒ…å†µä¸‹æ­¤å¼‚å¸¸ä¸éœ€è¦æ˜¾ç¤ºçš„æ•è·)ï¼Œå› æ­¤å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ¸…ç†æ€§çš„å·¥ä½œçš„å¾—ä¸åˆ°å®Œæˆï¼Œå¦‚æ–‡ä»¶ï¼Œæ•°æ®åº“ç­‰çš„å…³é—­ã€‚ è°ƒç”¨ stop() æ–¹æ³•ä¼šç«‹å³é‡Šæ”¾è¯¥çº¿ç¨‹æ‰€æŒæœ‰çš„æ‰€æœ‰çš„é”ï¼Œå¯¼è‡´æ•°æ®å¾—ä¸åˆ°åŒæ­¥ï¼Œå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ ä½¿ç”¨volatileæ ‡å¿—ä½ä»¥æ ‡å¿—ä½ä¸ºå¾ªç¯æ¡ä»¶","link":"/2024/07/26/Tread/"},{"title":".bash_profile","text":"#jdk#jdk-11.0.12.jdk or jdk1.8.0_291.jdkexport JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_291.jdk/Contents/Home#export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk-11.0.12.jdk/Contents/Homeexport PATH=$JAVA_HOME/bin:$PATHexport CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar#android sdkexport ANDROID_HOME=/Users/crow/Library/Android/sdkexport PATH=${PATH}:${ANDROID_HOME}/toolsexport PATH=${PATH}:${ANDROID_HOME}/platform-tools#android ndkexport ANDROID_NDK_HOME=/Users/crow/Library/Android/sdk/ndk-bundleexport PATH=$PATH:$ANDROID_NDK_HOME #alias#screen shot phonealias ss=â€™adb shell screencap /sdcard/screenshot.png &amp;&amp; adb pull /sdcard/screenshot.png . &amp;&amp; open ./screenshot.pngâ€™alias screenShot=â€™adb shell screencap /sdcard/screenshot.png &amp;&amp; adb pull /sdcard/screenshot.png . &amp;&amp; open ./screenshot.pngâ€™ #screen recordalias sr=â€™adb shell screenrecord /sdcard/video.mp4â€™alias startRecord=â€™adb shell screenrecord /sdcard/video.mp4â€™#control + c to stopalias showRecord=â€™adb pull /sdcard/video.mp4 . &amp;&amp; open ./video.mp4â€™ #adb input text to phonemyinput() { adb shell input text â€œ$1â€ }alias input=â€™myinput â€˜ #adb stop/start appalias stopApp=â€™adb shell am force-stop com.alibaba.aliexpresshdâ€™alias startApp=â€™adb shell am start â€œcom.alibaba.aliexpresshd/com.alibaba.aliexpresshd.home.ui.MainActivityâ€â€˜ #adb debug appalias debugApp=â€™adb shell am start -D â€œcom.alibaba.aliexpresshd/com.alibaba.aliexpresshd.home.ui.MainActivityâ€â€˜ #gradledependencies() { ./gradlew â€œ$1â€:dependencies â€“configuration debugRuntimeClasspath }alias depen=â€™dependenciesâ€™ #incremental commandalias increment=â€™bash &lt;(curl -s https://gitlab.alibaba-inc.com/chenzhong.cz/incremental_scripts/raw/dev_parallel_aliexpress_mtl4/incremental.sh)'","link":"/2023/02/22/bash-profile/"},{"title":"WorkNote","text":"APMåŸºå»ºæ–¹æ¡ˆæœ‰dokitå’Œmatrixï¼ŒdokitåŠŸèƒ½æ›´å¤šï¼Œçº¿ä¸‹ç›‘æ§ï¼›Matrixä¼˜åŒ–æ›´å¥½ï¼Œæ”¯æŒçº¿ä¸Šç›‘æ§ï¼› æœ€ç»ˆé€‰æ‹©äº†åŠŸèƒ½æ›´å…¨ä¸€ç‚¹çš„dokitï¼Œä»¥æœŸè¾¾åˆ°çº¿ä¸‹ç›‘æ§ï¼Œçº¿ä¸‹å¤„ç†ï¼Œçº¿ä¸Šé¢„é˜²ã€‚ åŸºäºæ»´æ»´å¼€æºæ¡†æ¶Dokit + è‡ªå®šä¹‰æ‰©å±•çš„æ€§èƒ½ç›‘æ§ï¼ˆå¦‚å›¾ç‰‡å°ºå¯¸æµªè´¹ã€å†…å­˜æ³„éœ²è¯¯æŠ¥ã€ï¼‰ å…¶ä¸­dokitä¸­åŒ…æ‹¬äº†åŸç†ä¸BlockCanaryç±»ä¼¼çš„è€—æ—¶æ–¹æ³•ç›‘æ§ã€Choreographerå¸§è€—æ—¶ç»Ÿè®¡ã€å›¾ç‰‡å°ºå¯¸è¶…é™ã€å‡½æ•°è€—æ—¶ã€å¯åŠ¨è€—æ—¶ è€—æ—¶æ–¹æ³•ç›‘æ§æ ¸å¿ƒæ˜¯æ ¹æ®handleråŸç†ï¼Œé€šè¿‡ç»™Looper.loop() ä¸­è®¾ç½®printer(æ— è®ºæ˜¯é€šè¿‡åå°„æ›¿æ¢Looperçš„mLoggingè¿˜æ˜¯é€šè¿‡setMessageLoggingè®¾ç½®printer)ï¼Œç›‘æ§è¶…è¿‡ è®¾å®šé˜ˆå€¼(matrix700ms) çš„ä¸»çº¿ç¨‹æ¶ˆæ¯ï¼ˆè¶…è¿‡5sæŠ¥ä¸ºANRï¼‰ï¼Œprinter ä¸­åˆ¤æ–­startå’Œendï¼Œæ¥è·å–ä¸»çº¿ç¨‹dispatchè¯¥messageçš„å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œå¹¶åˆ¤å®šè¯¥æ—¶é—´è¶…è¿‡é˜ˆå€¼ä¸ºä¸»çº¿ç¨‹å¡æ…¢å‘ç”Ÿï¼Œå¹¶ æ‰“å°å½“æ—¶å †æ ˆ + æ–¹æ³•è€—æ—¶(matrix/dokit) å †æ ˆå’Œæ–¹æ³•è€—æ—¶ dokitå’Œmatrixæ˜¯æ¯ä¸ªæ–¹æ³•æ’æ¡©ï¼Œä½†matrixçš„ä¼˜åŒ–æ›´ç»†èŠ‚ å¸§ç‡æ£€æµ‹æ ¸å¿ƒæ˜¯åˆ©ç”¨ç³»ç»Ÿ Choreographer æ¨¡å—ï¼Œå‘è¯¥æ¨¡å—æ³¨å†Œä¸€ä¸ª FrameCallback ç›‘å¬å¯¹è±¡ï¼ŒåŒæ—¶é€šè¿‡å¦å¤–ä¸€æ¡çº¿ç¨‹å¾ªç¯è®°å½•ä¸»çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼Œå¹¶åœ¨æ¯æ¬¡ Vsync äº‹ä»¶ doFrame é€šçŸ¥å›æ¥æ—¶ï¼Œå¾ªç¯æ³¨å†Œè¯¥ç›‘å¬å¯¹è±¡ï¼Œé—´æ¥ç»Ÿè®¡ä¸¤æ¬¡ Vsync äº‹ä»¶çš„æ—¶é—´é—´éš”ï¼Œå½“è¶…å‡ºé˜ˆå€¼æ—¶ï¼Œå–å‡ºè®°å½•çš„å †æ ˆè¿›è¡Œåˆ†æä¸ŠæŠ¥ã€‚ å¸§ç‡æ£€æµ‹æ–°ç‰ˆæœ¬å¯ä»¥è€ƒè™‘ç”¨ ä¸€æ¬¡å®Œæ•´çš„å›¾ç‰‡ä¼˜åŒ–è¿‡ç¨‹ åŸŸåæ”¶æ•›ï¼Œä½¿ç”¨æ­£åˆ™å°†å¤šä¸ªåŸŸåæ”¶æ•›æˆä¸€ä¸ªï¼Œæé«˜é“¾æ¥å¤ç”¨ï¼› æ¨æœåŠ¡ç«¯ä½¿ç”¨Http2ï¼Œå‡å°‘å µå¡ åŒæ—¶æ”¶æ•›webpæ ¼å¼ï¼Œè‹¥è¯¥å›¾ç‰‡å­˜åœ¨webpåˆ™æ›¿æ¢ä¸ºwebpé“¾æ¥ï¼Œå…œåº•ä¸ºåŸé“¾æ¥ï¼ŒèŠ‚çœä¸‹è½½æµé‡å’ŒåŠ è½½é€Ÿåº¦ï¼› è°ƒæ•´é“¾æ¥ä¸­å›¾ç‰‡å°ºå¯¸ä»¥ç¬¦åˆCDNè£åˆ‡å°ºå¯¸ï¼ˆ300ï¼Œ500ç­‰ï¼‰ï¼› å•å…ƒæµ‹è¯•è¦†ç›–ï¼ˆå¦‚æœæ˜¯ç°åœ¨æˆ‘ä¼šç”¨chatgptå†™ï¼‰ å¼€å‘ç½‘ç»œå›¾ç‰‡å¤§å°ä¸å½“æŠ¥è­¦ï¼Œé€šè¿‡æ’æ¡©å›¾ç‰‡åŠ è½½æ¡†æ¶ï¼Œä¸ŠæŠ¥å›¾ç‰‡ä¸‹è½½å°ºå¯¸ä¸å®é™…å°ºå¯¸ä¸ç¬¦çš„caseï¼ˆé¡µé¢ç±»å+view idï¼‰ ç›®æ ‡ï¼šç›‘æ§å›¾ç‰‡ä¸‹è½½å°ºå¯¸æµªè´¹ï¼Œä¼˜åŒ–å›¾ç‰‡æ¸²æŸ“é€Ÿåº¦ï¼Œå‡å°‘å›¾ç‰‡ä¸‹è¡Œæµé‡ï¼ˆä¼˜åŒ–ç£ç›˜å¤§å°ï¼Œfrescoæœ¬èº«èƒ½å¤Ÿè£å‰ªå›¾ç‰‡è·å¾—é€‚å½“çš„å†…å­˜å¤§å°ã€‚ï¼‰ ç»†èŠ‚ï¼š ä» è°ƒç”¨å›¾ç‰‡åŠ è½½ åˆ° å›¾ç‰‡çœŸæ­£åŠ è½½å®Œæˆ çš„æ—¶æœºå’Œä»£ç æ˜¯åˆ†ç¦»çš„ï¼Œé‚£ä¹ˆ è°ƒç”¨å›¾ç‰‡åŠ è½½æ—¶å€™æ‹¿åˆ°çš„viewä¿¡æ¯ éœ€è¦å’Œ å›¾ç‰‡åŠ è½½å®Œæˆæ—¶æ‹¿åˆ°çš„ä¸‹è½½å°ºå¯¸ åŒ¹é…ï¼Œäºæ˜¯ç»´æŠ¤äº†ä¸€ä¸ªkeyä¸ºurlï¼Œvalueä¸ºviewä¿¡æ¯çš„ConcurrentHashMapï¼Œåœ¨åŠ è½½å®Œæˆæ—¶ä»ä¸­å–å‡ºå¯¹åº”å€¼åˆ¤æ–­ å…¶ä»–ï¼šè¿™ä¸ªåŠŸèƒ½åŒæ—¶ä¹Ÿèƒ½è¯†åˆ«å›¾ç‰‡è¿‡å°å¸¦æ¥çš„å°ºå¯¸æ‹‰ä¼¸å¯¼è‡´çš„å›¾ç‰‡æ¨¡ç³Šé—®é¢˜ã€‚ ä¿®å¤äº†frescoåŠ è½½gifå›¾ç‰‡bugå¸¦æ¥çš„å†…å­˜æš´æ¶¨ ç»†èŠ‚ï¼šé¦–å…ˆæè¿°ä¸€ä¸‹ç°è±¡ï¼ŒfrescoåŠ è½½gifå›¾ç‰‡ï¼Œå½“è¯¥gifå›¾æ˜¯å¤šæ¬¡è½®æ’­æ—¶ï¼Œé€šè¿‡Android profileçš„å†…å­˜ç›‘æ§å¯çœ‹åˆ°å†…å­˜ä¸€è·¯ä¸Šå‡ï¼Œç›´åˆ°gcååˆç»§ç»­ä¸Šæ¶¨ï¼›åŸå› ï¼šgifå›¾ä¸­çš„æ¯ä¸€å¸§ä¼šåœ¨è§£ææ—¶åŒ…è£¹æˆä¸€ä¸ªå†…éƒ¨å¯¹è±¡AnimatedImageResultï¼Œå¤ç”¨gifå›¾å¸§çš„å¼€å…³é»˜è®¤æ˜¯å…³é—­çš„ï¼Œä¸”å¤ç”¨ä»£ç æœ‰bugï¼Œå¤ç”¨ç¼“å­˜çš„keyè¢«è®¾ç½®ä¸ºAnimatedImageResultçš„hashcodeå€¼ï¼Œå¯¼è‡´æ¯æ¬¡æ’­æ”¾åŒä¸€å¸§æ—¶ï¼Œæ¯æ¬¡éƒ½ä¼šé‡æ–°è§£æåŠ è½½åˆ°å†…å­˜ï¼Œæ¯ä¸€å¸§ä¼šæœ‰å¤šä»½å†…å­˜å­˜åœ¨ï¼› è§£å†³æ–¹æ¡ˆï¼š1ã€æ‰“å¼€å¤ç”¨å¼€å…³ï¼›2ã€ä¿®æ”¹å¤ç”¨çš„keyï¼Œä¸ºè§£æåByteBufferçš„System.identityHashCodeå€¼ + optionçš„hashcodeå€¼ ç›¸å½“äºç”¨è§£æåå•å¸§çš„hashcodeä½œä¸ºç¼“å­˜key PS:fresco åç»­è¡¥å……ï¼š https://github.com/facebook/fresco/commit/40937a700e76e0f68353857f5bd0b567b6e909f1 frescoå°†ä¹‹å‰è¯•éªŒæ€§è´¨çš„ä»£ç ç§»é™¤ï¼Œæœ‰è¾ƒå¤§çš„ç¼“å­˜æ”¹åŠ¨ã€‚æ•…PRä¸å†ä¼šè¢«æ¥æ”¶ï¼ˆå¦‚ExperimentalBitmapAnimationDrawableFactoryè¿™ä¸ªç±»å·²ç»è¢«æ›¿æ¢äº†ï¼‰ï¼ŒåŒæ—¶gifå›¾ç¼“å­˜æ–°å¢ä¸€ä¸ªAnimatedCache.ktçš„ç±»ï¼Œé€šè¿‡source(gifå›¾url)+frameIndexNumberçš„æ–¹å¼ç”Ÿæˆç¼“å­˜keyã€‚ ç°åœ¨é€šè¿‡æ›´æ–°frascoç‰ˆæœ¬åº”è¯¥å°±å¯ä»¥æœ‰æ­£å¸¸çš„gifå›¾ç¼“å­˜äº† åŸºäºå†…éƒ¨æ¡†æ¶å¥¥åˆ›å®Œæˆäº†è´­ç‰©è½¦ã€è®¢å•é¡µé¢çš„é‡æ„ å®Œæˆä¸€æ¬¡å®Œæ•´çš„é¡µé¢ç›´å¼€ä¼˜åŒ– ä¸€æ¬¡åŸºäºå†…éƒ¨æ¡†æ¶å¥¥åˆ›ã€MVVMè®¾è®¡çš„è´­ç‰©è½¦ã€è®¢å•é‡æ„èƒŒæ™¯æ˜¯é¡¹ç›®æ˜¯14å¹´å·¦å³å¼€å§‹è¿­ä»£çš„ï¼Œæ¨¡å—çš„è€¦åˆå¾ˆé‡ï¼Œè®¾è®¡è½åï¼Œç»´æŠ¤æ€§å¾ˆå·®ï¼Œäºæ˜¯å½“æ—¶å€ŸåŠ©ä¸€æ¬¡äº§å“å‘èµ·çš„æ”¹ç‰ˆæ–¹æ¡ˆï¼Œé‡æ„äº†è®¢å•ã€‚ å¥¥åˆ›æ˜¯ä¸€ä¸ªå‰åç«¯åä½œçš„ç»„ä»¶åŒ–åè®®ï¼Œå°†é¡µé¢æ ¹æ®å„è‡ªåŠŸèƒ½æ‹†åˆ†ä¸ºå¤šä¸ªç»„ä»¶ï¼Œå¥¥åˆ›åè®®ä¸‹å‘æ¯ä¸ªç»„ä»¶æ‰€éœ€çš„å­—æ®µã€ç»„ä»¶å¯¹åº”çš„é¡µé¢å±‚çº§ä½ç½®ç­‰ã€‚ ç«¯ä¾§å¯ä»¥è·å¾—ä¸€ä»½æ¸…æ™°çš„ç»„ä»¶åˆ—è¡¨ã€ç»„ä»¶ä½ç½®ï¼ˆåªåˆ†ç²˜é¡¶ã€æ»‘åŠ¨ã€ç²˜åº•ï¼‰ã€‚ç«¯ä¾§åœ¨RecyclerViewä¸­æ³¨å†Œæ¯ä¸ªç»„ä»¶å¯¹åº”çš„ViewModelå’ŒViewHolderï¼Œè§£æåè®®ä¸­ç»„ä»¶çš„æ•°æ®å¾—åˆ°ç»„ä»¶ViewModelï¼ŒrecyclerViewä¸­æ¯ä¸ªç»„ä»¶ViewHodleå°†æ ¹æ®ç»„ä»¶å”¯ä¸€Idå–åˆ°å¯¹åº”çš„ViewModelã€‚ æ•´ä½“è®¾è®¡æ˜¯ç”±æ•°æ®é©±åŠ¨ï¼ŒMVVMæ¶æ„ä¸‹ï¼Œviewmodelä¸­çš„æ•°æ®ç”±ç”Ÿå‘½å‘¨æœŸå®‰å…¨çš„LiveDataæŒæœ‰ï¼ŒViewHolderä½œä¸ºViewå±‚ç›‘å¬ç›¸å¯¹åº”æ•°æ®çš„å˜åŒ–ã€‚ç½‘ç»œè¯·æ±‚æ”¾åœ¨é¡µé¢ViewModelçš„Repositoryå±‚ä¸­ã€‚ ä¸€æ¬¡å®Œæ•´çš„é¡µé¢ç§’å¼€æ–¹æ¡ˆé¢„æµ‹è¯·æ±‚æœ¬é¡µé¢åˆ·æ–°å®Œæ•°æ®åé€šè¿‡å¯¹ç”¨æˆ·è¡Œä¸ºçš„é¢„æµ‹ï¼Œç›´æ¥å‘èµ·ä¸‹ä¸ªé¡µé¢çš„è¯·æ±‚å¹¶ç¼“å­˜å†…å­˜LRUCacheï¼Œè¿™ç§æƒ…å†µè¿›å…¥ä¸‹ä¸ªé¡µé¢æ—¶å¤§æ¦‚ç‡èƒ½ç›´æ¥æ‹¿åˆ°ç¼“å­˜ã€‚èŠ‚çœäº†æ•´ä¸ªè¯·æ±‚æ—¶é—´ã€‚ ä¼˜ç‚¹æ˜¯é€Ÿåº¦å¾ˆå¿«ï¼Œç¼ºç‚¹æ˜¯å¿…ä¸å¯å…çš„å­˜åœ¨æµé‡æµªè´¹ï¼Œéœ€è¦æ ¹æ®çº¿ä¸Šçš„æ•°æ®è°ƒæ•´è§„åˆ™ï¼Œä»¥è¾¾åˆ°æœ€ä½³çš„è¯·æ±‚èƒ½æ•ˆã€‚ æå‰è¯·æ±‚è·¯ç”±å±‚æ‹¦æˆªé¡µé¢å°†ç›®æ ‡é¡µé¢çš„è¯·æ±‚æŠ½ç¦»åˆ°é¢„è¯·æ±‚æ¡†æ¶æä¾›çš„æ¥å£å®ç°ç±»ä¸­ï¼Œè·¯ç”±å±‚æä¾›æ³¨å†Œå¯¹åº”é¡µé¢çš„urlå¤„ç†çš„èƒ½åŠ›ï¼Œä¸€æ—¦ç›‘å¬åˆ°è·¯ç”±å±‚æœ‰ç›¸å…³çš„urlè·³è½¬ï¼Œé¢„è¯·æ±‚æ¥å£å®ç°ç±»å‘èµ·ä¸€æ¬¡é¢„è¯·æ±‚ï¼Œåœ¨é¡µé¢å®é™…å‘èµ·è¯·æ±‚æ—¶ï¼Œè½¬ä¸ºå‘é¢„è¯·æ±‚æ¡†æ¶è¯·æ±‚æ•°æ®ã€‚å¦‚æœ‰å·²å‘èµ·é¢„è¯·æ±‚çš„æ ‡è®°åˆ™èµ°é¢„è¯·æ±‚æ¡†æ¶ï¼Œå¦åˆ™ç»§ç»­èµ°æ­£å¸¸å‘èµ·è¯·æ±‚é€»è¾‘ã€‚ èŠ‚çœäº†è·¯ç”±è€—æ—¶+activityå¯åŠ¨è€—ï¼ˆåå‡ msï¼‰ã€inflateè€—æ—¶(å‡ ååˆ°å‡ ç™¾ms) é¡µé¢è¯·æ±‚å‰ç½®ç›´æ¥å°†è¯·æ±‚å‰ç½®ï¼Œåœ¨onCreateæœ€å‰é¢å°±å‘èµ·è¯·æ±‚ï¼ŒèŠ‚çœäº†inflateLayoutçš„å¼€é”€(å‡ ååˆ°å‡ ç™¾ms)ï¼Œï¼ˆä¸ºä»€ä¹ˆä¸ç”¨AsyncLayoutInflaterï¼šé™åˆ¶è¾ƒå¤šï¼Œå¦‚å¼‚æ­¥çº¿ç¨‹ä¸­æ²¡æœ‰åˆå§‹åŒ–looperï¼Œviewéœ€æ‰‹åŠ¨åŠ åˆ°Viewparentç­‰ï¼‰ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¯·æ±‚ç›´æ¥å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œç”±äºå¸ƒå±€æœªinflateå®Œæˆå¯èƒ½å¯¼è‡´å¤±è´¥è§†å›¾å±•ç¤ºæœ‰é—®é¢˜ï¼Œè¿™ç§æƒ…å†µä¸‹å¤±è´¥è§†å›¾æ“ä½œéœ€è¦postä¸€ä¸‹ã€‚ ä¼˜ç‚¹æ˜¯æ”¹åŠ¨å°ï¼Œé€‚ç”¨æ€§å¹¿ï¼› è¡¥å……ï¼šä¸€ã€é¦–å±çš„å®šä¹‰ï¼šèµ·ç‚¹ä¸€å®šæ˜¯ä»ç‚¹å‡»å¼€å§‹ï¼› ç»“æŸå¯ä¸ºï¼š ä¸‹ä¸ªé¡µé¢onResumeæ‰§è¡Œä¸€ä¸ªhandle.post() ä¸‹ä¸ªé¡µé¢recyclerViewç¬¬ä¸€ä¸ªitemæ‰§è¡ŒonBindeç»“æŸ ï¼ˆæ·˜å®å®šä¹‰ï¼‰åœ¨å›ºå®šæœºå‹(æœ€å¤šçš„å æ¯”)ä¸‹ï¼Œä¸‹ä¸ªé¡µé¢å‰ä¸‰å¼ å›¾åŠ è½½å®Œæˆï¼ˆç”¨æˆ·ä½“éªŒè§†è§’å®šä¹‰é¦–å±æ—¶é—´ï¼‰ äºŒã€ä¼˜åŒ–é¦–å±çš„æ‰‹æ®µï¼š é¢„åŠ è½½ ä¸Šè¿°å‡ ç§æ–¹æ¡ˆï¼Œå¯ä»¥æ™®éä½¿ç”¨è·¯ç”±æ‹¦æˆªè¯·æ±‚æ–¹æ¡ˆ æœ¬åœ°ç¼“å­˜ å¦‚è´­ç‰©è½¦ä½¿ç”¨æœ¬åœ°ç¼“å­˜ é—²æ—¶èµ„æºé¢„çƒ­ ä¸»è¦é’ˆå¯¹dxæ¨¡æ¿ä¹‹ç±»çš„ å¼•æ“é¢„çƒ­ dxå¼•æ“é¢„çƒ­ æ¨åç«¯ä¼˜åŒ– å‡å°‘æœºå™¨å†…RT ä¸Šä¸‹è¡ŒåŒ…å¤§å°ä¼˜åŒ– ç²¾ç®€åè®®ï¼Œå‡å°‘åŒ…å¤§å° ä¸Šä¸ªé¡µé¢onPauseæ—¶é—´æ’æŸ¥ æ¯”å¦‚ä¸Šä¸ªé¡µé¢onPauseä¸­å¤„ç†å¤ªå¤šäº‹æƒ…å¯¼è‡´ä¸‹ä¸€é¡µé¢å”¤èµ·å»¶è¿Ÿ å¸ƒå±€åŠ è½½ä¼˜åŒ– ä¸€æ¬¡rtlå¼•å‘çš„æƒ¨æ¡ˆCase 1ï¼šåŸå§‹æ•°æ®ä¸º ç«¯ä¾§æ˜¾ç¤ºä¸º å‰æï¼š æ•°å­—18,186.37ã€ç¾å…ƒ$ã€å†’å·ã€é€—å·ã€å°æ•°ç‚¹æ˜¯å¼±å­—ç¬¦ï¼› ç©ºæ ¼æ˜¯ä¸­æ€§å­—ç¬¦ï¼› é˜¿æ‹‰ä¼¯è¯­æ˜¯å¼ºrtlå­—ç¬¦ï¼› å­—æ¯MXNæ˜¯å¼ºltrå­—ç¬¦ï¼› BIDIç®—æ³•åŸºæœ¬è§„åˆ™ï¼š æ–‡æœ¬çš„å…¨å±€æ–¹å‘å–å†³äºå¥å­ä¸­é¦–ä¸ªå¼ºå­—ç¬¦ ç¡®å®šäº†æ–‡æœ¬çš„å…¨å±€æ˜¾ç¤ºæ–¹å‘åï¼Œè‹¥å±€éƒ¨å‡ºç°äº†åå‘å­—ç¬¦ï¼Œåˆ™è¿ç»­çš„åå‘å­—ç¬¦ä¿æŒå…¶å±€éƒ¨é¡ºåºe.g: è‹¥åœ¨è¿ç»­çš„é˜¿æ‹‰ä¼¯æ–‡ä¸­å‡ºç°äº†ä¸­æ–‡å•è¯ï¼Œå¦‚â€å¥”è·‘å§â€ï¼Œåˆ™å…¶ä»æŒ‰ç…§ä¸­æ–‡é¡ºåºæ˜¾ç¤ºï¼Œä¸ä¼šæ˜¾ç¤ºä¸ºâ€å§è·‘å¥”â€ å¼±å­—ç¬¦ä¿æŒè‡ªèº«æ–¹å‘ æ²¡æœ‰è¢«å¼ºå­—ç¬¦åŒ…è£¹çš„ä¸­æ€§å­—ç¬¦è¿½éšå…¨å±€æ–¹å‘ è§£æï¼š é¦–å…ˆï¼Œæ•´ä½“çš„æ–‡æœ¬æ–¹å‘æ˜¯ç”±ç¬¬ä¸€ä¸ªå¼ºå­—ç¬¦å†³å®šçš„ï¼Œä¹Ÿå°±æ˜¯rtlæ–¹å‘ï¼› é˜¿æ‹‰ä¼¯æ–‡æœ¬å¼ºrtlå­—ç¬¦ å†’å· ä¸ºå¼±å­—ç¬¦ä¿æŒè‡ªèº«æ–¹å‘(å•ä¸ªçœ‹ä¸å‡ºæ¥)ï¼ŒæŒ‰å…¨å±€æ–¹å‘æ‘†æ”¾åœ¨å…¶å·¦ ç©ºæ ¼ ä¸ºä¸­æ€§å­—ç¬¦è¿½éšå…¨å±€æ–¹å‘(å•ä¸ªçœ‹ä¸å‡ºæ¥)ï¼ŒæŒ‰å…¨å±€æ–¹å‘æ‘†æ”¾åœ¨å…¶å·¦ 18,186.37 æ•´ä¸ªå¼±å­—ç¬¦æ–¹å‘ä¸²ä¿æŒè‡ªèº«æ–¹å‘ï¼Œä¸ºltrï¼ŒæŒ‰å…¨å±€æ–¹å‘æ‘†æ”¾åœ¨å…¶å·¦ MXNä¸ºå¼ºltrå­—ç¬¦ï¼ŒæŒ‰å…¨å±€æ–¹å‘æ‘†æ”¾åœ¨å…¶å·¦ $ä¸ºå¼±å­—ç¬¦æ–¹å‘ï¼ŒæŒ‰å…¨å±€æ–¹å‘æ‘†æ”¾åœ¨å…¶å è§£å†³ï¼š ä½¿ç”¨å¼ºåˆ¶ltrçš„é¢†å®½åº¦å­—ç¬¦ u202A å’Œ ç»ˆæ­¢ç¬¦u202C ä½¿ Total + â€œ\\u202Aâ€ + ä»·æ ¼ + â€œ\\u202Câ€ å¼ºåˆ¶ä»·æ ¼ï¼ˆé‡‘é¢+è´§å¸å•ä½ï¼‰ä½œä¸ºä¸€ä¸ªæ–¹å‘ä¸²èµ° ltr Case2:","link":"/2024/02/21/WorkNote/"},{"title":"å¡é¡¿ç›‘æ§","text":"https://mp.weixin.qq.com/s/3dubi2GVW_rVFZZztCpsKg ä¸»çº¿ç¨‹å¡é¡¿ç›‘æ§æ–¹æ¡ˆä¸€ã€Looper Printerç›‘æ§æ¯æ¬¡ dispatchMessage çš„æ‰§è¡Œè€—æ—¶ï¼šDoKit &amp; BlockCanary &amp; Matrixæ»´æ»´çš„å“†å•¦Aæ¢¦çš„å¡é¡¿æ£€æµ‹å…¶å®å°±æ˜¯blockCanaryï¼Œå’ŒMatrix çš„EvilMethodTracerå’ŒAnrTracer ï¼ˆå½“ç„¶åæ¥Matrixè¿˜å¢åŠ äº†nativeçš„Signalä¿¡å·ç›‘å¬ï¼‰ä½¿ç”¨çš„ æ–¹æ¡ˆä¹Ÿå°±æ˜¯Looperè®¾ç½®Printerç›‘å¬å¡é¡¿ éƒ½æ˜¯æ ¹æ®handleråŸç†ï¼Œé€šè¿‡ç»™Looper.loop() ä¸­è®¾ç½®printer(æ— è®ºæ˜¯é€šè¿‡åå°„æ›¿æ¢Looperçš„mLoggingè¿˜æ˜¯é€šè¿‡setMessageLoggingè®¾ç½®printer)ï¼Œç›‘æ§è¶…è¿‡ è®¾å®šé˜ˆå€¼(matrix700ms) çš„ä¸»çº¿ç¨‹æ¶ˆæ¯ï¼ˆè¶…è¿‡5sæŠ¥ä¸ºANRï¼‰ï¼Œprinter ä¸­åˆ¤æ–­startå’Œendï¼Œæ¥è·å–ä¸»çº¿ç¨‹dispatchè¯¥messageçš„å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œå¹¶åˆ¤å®šè¯¥æ—¶é—´è¶…è¿‡é˜ˆå€¼ä¸ºä¸»çº¿ç¨‹å¡æ…¢å‘ç”Ÿï¼Œå¹¶ æ‰“å°å½“æ—¶å †æ ˆ + æ–¹æ³•è€—æ—¶(matrix/dokit) 123456789101112131415161718192021222324252627282930Looper.loop() { for (;;) { Message msg = queue.next(); // might block if (msg == null) { ... // æ‰§è¡ŒdispatchMessageå‰ï¼Œæ‰§è¡ŒPrinterçš„printlnæ–¹æ³• final Printer logging = me.mLogging; if (logging != null) { logging.println(&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot; + msg.target + &quot; &quot; + msg.callback + &quot;: &quot; + msg.what); } ... try { msg.target.dispatchMessage(msg); dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : 0; } finally { ... } ... // æ‰§è¡ŒdispatchMessageåï¼Œæ‰§è¡ŒPrinterçš„printlnæ–¹æ³• if (logging != null) { logging.println(&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot; + msg.target + &quot; &quot; + msg.callback); } ... }} Matrixï¼šæ— è®ºæ˜¯é€šè¿‡åå°„æ›¿æ¢Looperçš„mLoggingè¿˜æ˜¯é€šè¿‡setMessageLoggingè®¾ç½®printerï¼Œæˆ‘ä»¬åªéœ€è¦æ›¿æ¢ä¸»çº¿ç¨‹Looperçš„printerå¯¹è±¡ï¼Œé€šè¿‡è®¡ç®—æ‰§è¡ŒdispatchMessageæ–¹æ³•ä¹‹åå’Œä¹‹å‰æ‰“å°å­—ç¬¦ä¸²çš„æ—¶é—´çš„å·®å€¼ï¼Œå°±å¯ä»¥æ‹¿åˆ°åˆ°dispatchMessageæ–¹æ³•æ‰§è¡Œçš„æ—¶é—´ã€‚è€Œå¤§éƒ¨åˆ†çš„ä¸»çº¿ç¨‹çš„æ“ä½œæœ€ç»ˆéƒ½ä¼šæ‰§è¡Œåˆ°è¿™ä¸ªdispatchMessageæ–¹æ³•ä¸­ã€‚ Looper.loop()è®¾ç½®Printerç›‘æ§æ–¹æ¡ˆå­˜åœ¨é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼šç®€è¿°ï¼šLooper.loop()ä¸­è®¾ç½®printerçš„æ–¹æ³•ç›‘æ§è€—æ—¶è¿˜ä¼šé—æ¼è¿™å‡ ä¸ªåœºæ™¯ï¼š é¦–å…ˆå¤§è‡´ä»£ç ï¼š 1234567891011121314151617181920Looper.loop() { for(;;) { Message msg = queue.next(); // might block logging(Printer).println() // æ¶ˆæ¯å¤„ç†å‰çš„printeræ‰“å° msg.target.dispatchMessage(msg); //æ¶ˆæ¯å¤„ç† logging(Printer).println() // æ¶ˆæ¯å¤„ç†åçš„printeræ‰“å° }}//-----------------------------------------------------------------------MessageQueue.next(){ for (;;) { nativePollOnce(ptr, nextPollTimeoutMillis); //touchæ¶ˆæ¯å¤„ç† //ä¸»çº¿ç¨‹ç©ºé—²&amp;idleæ¶ˆæ¯å¤„ç† for(int i = 0; i &lt; pendingIdleHandlerCount; i++) { keep = idler.queueIdle( } }} å¦‚ä¸Šæ‰€ç¤ºå°±å¯ä»¥çœ‹åˆ°è®¾ç½®printerç›‘æ§æ–¹æ¡ˆåœ¨è¿™é‡Œæœ‰ç›‘æ§ä¸åˆ°çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯queue.nexté˜»å¡çš„æƒ…å†µï¼Œåˆ†ä¸¤ç§ï¼š 1ã€ä¸»çº¿ç¨‹ç©ºé—²æ—¶idleHandlerå¤„ç†çš„æƒ…å†µã€‚ â€”â€” å¯ä»¥é€šè¿‡åå°„MessageQueueä¸­çš„mIdleHandlers(ArrayList)ï¼Œæ›¿ä»£æˆè‡ªå®šä¹‰çš„ArrayListç±»ï¼Œåœ¨é‡å†™çš„addæ–¹æ³•ä¸­è·å¾—æ‰€æœ‰çš„idleHandelr 2ã€Touchäº‹ä»¶çš„è¯å¯ä»¥é€šè¿‡PLT hookï¼Œhook native frameworkä¸­çš„äº‹ä»¶æœºåˆ¶ã€‚ è¿˜æœ‰å¦ä¸€ç§æ˜¯barrieræ¶ˆæ¯æ³„éœ²çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µå¾ˆå°‘è§ã€‚ Qï¼šå¦‚æœæ’é™¤ä¸»çº¿ç¨‹ç©ºé—²çš„æƒ…å†µï¼Œç©¶ç«Ÿä¼šæ˜¯ä»€ä¹ˆåŸå› ä¼šå¡åœ¨MessageQueueçš„nextæ–¹æ³•ä¸­å‘¢ï¼Ÿä¸‹å›¾æ˜¯nextæ–¹æ³•ç®€åŒ–è¿‡åçš„æºç ï¼Œ*frameworks/base/core/java/android/os/MessageQueue.java:next()* 1234567891011121314151617181920212223242526272829303132333435for (;;) { if (nextPollTimeoutMillis != 0) { Binder.flushPendingCommands(); } nativePollOnce(ptr, nextPollTimeoutMillis); //...... // Run the idle handlers. // We only ever reach this code block during the first iteration. for (int i = 0; i &lt; pendingIdleHandlerCount; i++) { final IdleHandler idler = mPendingIdleHandlers[i]; mPendingIdleHandlers[i] = null; // release the reference to the handler boolean keep = false; try { keep = idler.queueIdle(); } catch (Throwable t) { Log.wtf(TAG, &quot;IdleHandler threw exception&quot;, t); } if (!keep) { synchronized (this) { mIdleHandlers.remove(idler); } } } //......}/*1. å¦‚æœæœ¬æ¬¡å¾ªç¯æ‹¿åˆ°çš„Messageä¸ºç©ºï¼Œæˆ–è€…ï¼è¿™ä¸ªMessageæ˜¯ä¸€ä¸ªå»¶æ—¶çš„æ¶ˆæ¯è€Œä¸”è¿˜æ²¡åˆ°æŒ‡å®šçš„è§¦å‘æ—¶é—´ï¼Œé‚£ä¹ˆï¼Œå°±è®¤å®šå½“å‰çš„é˜Ÿåˆ—ä¸ºç©ºé—²çŠ¶æ€ï¼Œ2. æ¥ç€å°±ä¼šéå†mPendingIdleHandlersæ•°ç»„(è¿™ä¸ªæ•°ç»„é‡Œé¢çš„å…ƒç´ æ¯æ¬¡éƒ½ä¼šåˆ°mIdleHandlersä¸­å»æ‹¿)æ¥è°ƒç”¨æ¯ä¸€ä¸ªIdleHandlerå®ä¾‹çš„queueIdleæ–¹æ³•ï¼Œ3. æœè¿™ä¸ªæ–¹æ³•è¿”å›falseçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå®ä¾‹å°±ä¼šä»mIdleHandlersä¸­ç§»é™¤ï¼Œä¹Ÿå°±æ˜¯å½“ä¸‹æ¬¡é˜Ÿåˆ—ç©ºé—²çš„æ—¶å€™ï¼Œä¸ä¼šç»§ç»­å›è°ƒå®ƒçš„queueIdleæ–¹æ³•äº†ã€‚*/ å› ä¸ºæœ‰äº›æƒ…å†µçš„å¡é¡¿ï¼Œè¿™ç§æ–¹æ¡ˆä»åŸç†ä¸Šå°±æ— æ³•ç›‘æ§åˆ°ã€‚çœ‹åˆ°ä¸Šé¢çš„queue.next()ï¼Œè¿™é‡Œç»™äº†æ³¨é‡Šï¼šmight blockï¼Œç›´æ¥è·Ÿä½ è¯´è¿™é‡Œæ˜¯å¯èƒ½ä¼šå¡ä½çš„ï¼Œè¿™æ—¶å€™å†è®¡ç®—dispatchMessageæ–¹æ³•çš„è€—æ—¶æ˜¾ç„¶å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚æœ‰çš„åŒå­¦å¯èƒ½ä¼šæƒ³ï¼Œé‚£æˆ‘æ”¹æˆè®¡ç®—ç›¸é‚»ä¸¤æ¬¡dispatchMessageæ‰§è¡Œä¹‹å‰æ‰“å°å­—ç¬¦ä¸²çš„æ—¶é—´å·®å€¼ä¸å°±å¥½äº†ï¼Ÿè¿™æ ·å°±å¯ä»¥æŠŠnextæ–¹æ³•çš„è€—æ—¶ä¹Ÿè®¡ç®—åœ¨å†…ã€‚ 1ã€ä¸»çº¿ç¨‹ç©ºé—²ä¹Ÿå°±æ˜¯queue.next()é˜»å¡çš„æ—¶å€™ï¼ŒåŒæ—¶ä¹Ÿæ˜¯åº”ç”¨çš„Touchäº‹ä»¶ã€‚ä¸å¹¸çš„æ˜¯ï¼Œä¸»çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¹Ÿä¼šé˜»å¡åœ¨MessageQueueçš„nextæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¾ˆéš¾åŒºåˆ†ç©¶ç«Ÿæ˜¯å‘ç”Ÿäº†å¡é¡¿è¿˜æ˜¯ä¸»çº¿ç¨‹ç©ºé—²ï¼Œé™¤äº†ä¸»çº¿ç¨‹ç©ºé—²æ—¶å°±æ˜¯é˜»å¡åœ¨nativePollOnceä¹‹å¤–ï¼Œéå¸¸é‡è¦çš„æ˜¯ï¼Œåº”ç”¨çš„Touchäº‹ä»¶ä¹Ÿæ˜¯åœ¨è¿™é‡Œè¢«å¤„ç†çš„ã€‚è¿™å°±æ„å‘³ç€ï¼ŒViewçš„TouchEventä¸­çš„å¡é¡¿è¿™ç§æ–¹æ¡ˆæ˜¯æ— æ³•ç›‘æ§çš„ã€‚ï¼ˆå¾®ä¿¡ä¸­æœ‰å¤§é‡çš„è‡ªå®šä¹‰Viewï¼Œè¿™äº›Viewä¸­å……æ»¡äº†å„ç§å„æ ·å¾ˆå¤šçš„onTouchå›è°ƒï¼Œå¡åœ¨è¿™é‡Œé¢çš„æƒ…å†µéå¸¸æ™®éï¼Œè¿™ç§æƒ…å†µçš„å¡é¡¿ç›‘æ§ä¸åˆ°æ˜¯å¾ˆéš¾æ¥å—çš„ï¼‰ 2ã€IdleHandlerçš„queueIdle()å›è°ƒæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šåœ¨ä¸»çº¿ç¨‹ç©ºé—²çš„æ—¶å€™è¢«è°ƒç”¨ã€‚ç„¶è€Œå®é™…ä¸Šï¼Œå¾ˆå¤šå¼€å‘åŒå­¦éƒ½å…ˆå…¥ä¸ºä¸»çš„è®¤ä¸ºè¿™ä¸ªæ—¶å€™åæ­£ä¸»çº¿ç¨‹ç©ºé—²ï¼Œåšä¸€äº›è€—æ—¶æ“ä½œä¹Ÿæ²¡æ‰€è°“ã€‚å…¶å®ä¸»çº¿ç¨‹MessageQueueçš„queueIdleé»˜è®¤å½“ç„¶ä¹Ÿæ˜¯æ‰§è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œçš„è€—æ—¶æ“ä½œå…¶å®æ˜¯å¾ˆå®¹æ˜“å¼•èµ·å¡é¡¿å’ŒANRçš„ã€‚ï¼ˆä¾‹å¦‚å¾®ä¿¡ä¹‹å‰å°±ä½¿ç”¨IdleHandleråœ¨è¿›å…¥å¾®ä¿¡çš„ä¸»ç•Œé¢åï¼Œåšä¸€äº›è¯»å†™æ–‡ä»¶çš„IOæ“ä½œï¼Œå°±é€ æˆäº†ä¸€äº›å¡é¡¿å’ŒANRé—®é¢˜ï¼‰ 3ã€SyncBarrieræ³„éœ²ã€‚è¿˜æœ‰ä¸€ç±»ç›¸å¯¹å°‘è§çš„é—®é¢˜æ˜¯SyncBarrierï¼ˆåŒæ­¥å±éšœï¼‰çš„æ³„æ¼åŒæ ·æ— æ³•è¢«ç›‘æ§åˆ° å½“æˆ‘ä»¬æ¯æ¬¡é€šè¿‡invalidateæ¥åˆ·æ–°UIæ—¶ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°ViewRootImplä¸­çš„scheduleTraversalsæ–¹æ³•ï¼Œä¼šå‘ä¸»çº¿ç¨‹çš„Looperä¸­postä¸€ä¸ªSyncBarrierï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†åœ¨åˆ·æ–°UIæ—¶ï¼Œä¸»çº¿ç¨‹çš„åŒæ­¥æ¶ˆæ¯éƒ½è¢«è·³è¿‡ï¼Œæ­¤æ—¶æ¸²æŸ“UIçš„å¼‚æ­¥æ¶ˆæ¯å°±å¯ä»¥å¾—åˆ°ä¼˜å…ˆå¤„ç†ã€‚ä½†æ˜¯æˆ‘ä»¬æ³¨æ„åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¦‚æœåœ¨éä¸»çº¿ç¨‹ä¸­è°ƒç”¨åˆ°äº†è¿™é‡Œï¼Œå°±æœ‰å¯èƒ½ä¼šåŒæ—¶postå¤šä¸ªSyncBarrierï¼Œä½†åªèƒ½removeæ‰æœ€åä¸€ä¸ªï¼Œä»è€Œæœ‰ä¸€ä¸ªSyncBarrierå°±æ°¸è¿œæ— æ³•è¢«removeï¼Œå°±å¯¼è‡´äº†ä¸»çº¿ç¨‹Looperæ— æ³•å¤„ç†åŒæ­¥æ¶ˆæ¯ï¼ˆMessageé»˜è®¤å°±æ˜¯åŒæ­¥æ¶ˆæ¯ï¼‰ï¼Œå¯¼è‡´å¡æ­» Aï¼šA.1. ç›‘æ§IdleHandlerå¡é¡¿é¦–å…ˆä»ç®€å•çš„ä¸‹æ‰‹ï¼Œå¯¹äºIdleHandlerçš„queueIdleå›è°ƒæ–¹æ³•çš„ç›‘æ§ã€‚æˆ‘ä»¬æƒŠå–œçš„å‘ç°MessageQueueä¸­çš„mIdleHandlersæ˜¯å¯ä»¥è¢«åå°„çš„ï¼Œè¿™ä¸ªå˜é‡ä¿å­˜äº†æ‰€æœ‰å°†è¦æ‰§è¡Œçš„IdleHandlerï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠArrayListç±»å‹çš„mIdleHandlersï¼Œé€šè¿‡åå°„ï¼Œæ›¿æ¢ä¸ºMyArrayListï¼Œåœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„MyArrayListä¸­é‡å†™addæ–¹æ³•ï¼Œå†å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„MyIdleHandleræ·»åŠ åˆ°MyArrayListä¸­ï¼Œå°±å®Œæˆäº†â€œå·å¤©æ¢æ—¥â€ã€‚ä»æ­¤ä¹‹åMessageQueueæ¯æ¬¡æ‰§è¡ŒqueueIdleå›è°ƒæ–¹æ³•ï¼Œéƒ½ä¼šæ‰§è¡Œåˆ°æˆ‘ä»¬çš„MyIdleHandlerä¸­çš„çš„queueIdleæ–¹æ³•ï¼Œå°±å¯ä»¥åœ¨è¿™é‡Œç›‘æ§queueIdleçš„æ‰§è¡Œæ—¶é—´äº†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940private static void detectIdleHandler() { try { MessageQueue mainQueue = Looper.getMainLooper().getQueue(); Field field = MessageQueue.class.getDeclaredField(&quot;mIdleHandlers&quot;); field.setAccessible(true); MyArrayList&lt;MessageQueue.IdleHandler&gt; myIdleHandlerArrayList = new MyArrayList&lt;&gt;(); field.set(mainQueue, myIdleHandlerArrayList); } catch (Throwable t) { t.printStackTrace(); }}static class MyArrayList&lt;T&gt; extends ArrayList { Map&lt;MessageQueue.IdleHandler, MyIdleHandler&gt; map = new HashMap&lt;&gt;(); @Override public boolean add(Object o) { if (o instanceof MessageQueue.IdleHandler) { MyIdleHandler myIdleHandler = new MyIdleHandler((MessageQueue.IdleHandler) o); map.put((MessageQueue.IdleHandler) o, myIdleHandler); return super.add(myIdleHandler); } return super.add(o); } @Override public boolean remove(@Nullable Object o) { if (o instanceof MyIdleHandler) { MessageQueue.IdleHandler idleHandler = ((MyIdleHandler) o).idleHandler; map.remove(idleHandler); return super.remove(o); } else { MyIdleHandler myIdleHandler = map.remove(o); if (myIdleHandler != null) { return super.remove(myIdleHandler); } return super.remove(o); } }} A.2. ç›‘æ§TouchEventå¡é¡¿é‚£ä¹ˆTouchEventæˆ‘ä»¬æœ‰ä»€ä¹ˆåŠæ³•ç›‘æ§å—ï¼Ÿé¦–å…ˆæƒ³åˆ°çš„å¯èƒ½æ˜¯åå°„Viewçš„mListenerInfoï¼Œç„¶åè¿›ä¸€æ­¥æ›¿æ¢å…¶ä¸­çš„mTouchListenrï¼Œä½†æ˜¯è¿™éœ€è¦æˆ‘ä»¬æšä¸¾æ‰€æœ‰éœ€è¦è¢«ç›‘æ§çš„Viewï¼Œå…¨éƒ¨åå°„æ›¿æ¢ä¸€éï¼Œè¿™å®Œå…¨æ˜¯æ†¨æ†¨è¡Œä¸ºã€‚é‚£æœ‰æ²¡æœ‰æ›´åŠ æ ¹æœ¬ï¼Œå…¨å±€æ€§çš„æ–¹æ³•å‘¢ï¼Ÿ ç†Ÿæ‚‰inputç³»ç»Ÿçš„åŒå­¦åº”è¯¥çŸ¥é“ï¼ŒTouchäº‹ä»¶æœ€ç»ˆæ˜¯é€šè¿‡serverç«¯çš„InputDispatcherçº¿ç¨‹ä¼ é€’ç»™Clientç«¯çš„UIçº¿ç¨‹çš„ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ˜¯ä¸€å¯¹Socketè¿›è¡Œé€šè®¯çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡PLT Hookï¼Œå»Hookè¿™å¯¹Socketçš„sendå’Œrecvæ–¹æ³•æ¥ç›‘æ§Touchäº‹ä»¶å•Šï¼æˆ‘ä»¬å…ˆæ‹ä¸€ä¸‹ä¸€æ¬¡Touchäº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ï¼š æˆ‘ä»¬é€šè¿‡PLT Hookï¼ŒæˆåŠŸhookåˆ°libinput.soä¸­çš„recvfromå’Œsendtoæ–¹æ³•ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„æ–¹æ³•è¿›è¡Œæ›¿æ¢ã€‚å½“è°ƒç”¨åˆ°äº†recvfromæ—¶ï¼Œè¯´æ˜æˆ‘ä»¬çš„åº”ç”¨æ¥æ”¶åˆ°äº†Touchäº‹ä»¶ï¼Œå½“è°ƒç”¨åˆ°äº†sendtoæ—¶ï¼Œè¯´æ˜è¿™ä¸ªTouchäº‹ä»¶å·²ç»è¢«æˆåŠŸæ¶ˆè´¹æ‰äº†ï¼Œå½“ä¸¤è€…çš„æ—¶é—´ç›¸å·®è¿‡å¤§æ—¶å³è¯´æ˜äº§ç”Ÿäº†ä¸€æ¬¡Touchäº‹ä»¶çš„å¡é¡¿ã€‚è¿™ç§æ–¹æ¡ˆç»è¿‡éªŒè¯æ˜¯å¯è¡Œçš„ï¼ A.3. ç›‘æ§SyncBarrieræ³„æ¼æœ€åï¼ŒSyncBarrieræ³„æ¼çš„é—®é¢˜ï¼Œæœ‰ä»€ä¹ˆå¥½åŠæ³•èƒ½ç›‘æ§åˆ°å—ï¼Ÿç›®å‰æˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯ä¸æ–­è½®è¯¢ä¸»çº¿ç¨‹Looperçš„MessageQueueçš„mMessage(ä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹å½“å‰æ­£åœ¨å¤„ç†çš„Message)ã€‚è€ŒSyncBarrieræœ¬èº«ä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„Messageï¼Œå…¶ç‰¹æ®Šåœ¨å®ƒçš„targetæ˜¯nullã€‚å¦‚æœæˆ‘ä»¬é€šè¿‡åå°„mMessageï¼Œå‘ç°å½“å‰çš„Messageçš„targetä¸ºnullï¼Œå¹¶ä¸”é€šè¿‡è¿™ä¸ªMessageçš„whenå‘ç°å…¶å·²ç»å­˜åœ¨å¾ˆä¹…äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆç†æ€€ç–‘äº§ç”Ÿäº†SyncBarrierçš„æ³„æ¼ï¼ˆä½†è¿˜ä¸èƒ½å®Œå…¨ç¡®å®šï¼Œå› ä¸ºå¦‚æœå½“æ—¶å› ä¸ºå…¶ä»–åŸå› å¯¼è‡´ä¸»çº¿ç¨‹å¡æ­»ï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´è¿™ç§ç°è±¡ï¼‰ï¼Œç„¶åå†å‘é€ä¸€ä¸ªåŒæ­¥æ¶ˆæ¯å’Œä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œå¦‚æœå¼‚æ­¥æ¶ˆæ¯è¢«å¤„ç†äº†ï¼Œä½†æ˜¯åŒæ­¥æ¶ˆæ¯ä¸€ç›´æ— æ³•è¢«å¤„ç†ï¼Œè¿™æ—¶å€™å°±è¯´æ˜äº§ç”Ÿäº†SyncBarrierçš„æ³„æ¼ã€‚å¦‚æœæ¿€è¿›ä¸€äº›ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ç”šè‡³å¯ä»¥åå°„è°ƒç”¨*MessageQueue*çš„*removeSyncBarrier*æ–¹æ³•ï¼Œæ‰‹åŠ¨æŠŠè¿™ä¸ªSyncBarrierç§»é™¤æ‰ï¼Œä»è€Œä»é”™è¯¯çŠ¶æ€ä¸­æ¢å¤ã€‚ åæ¶ˆæ¯æ˜¯ï¼Œè¿™ç§æ–¹æ¡ˆåªèƒ½ç›‘æ§åˆ°é—®é¢˜çš„äº§ç”Ÿï¼Œä¹Ÿå¯ä»¥ç›´æ¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯æ— æ³•æº¯æºé—®é¢˜ç©¶ç«Ÿæ˜¯å“ªä¸ªViewå¯¼è‡´çš„ã€‚å…¶å®æˆ‘ä»¬ä¹Ÿå°è¯•è¿‡ï¼Œé€šè¿‡æ’æ¡©æˆ–è€…Java hookçš„æ–¹æ³•ï¼Œç›‘æ§invalidateæ–¹æ³•æ˜¯å¦åœ¨éä¸»çº¿ç¨‹ä¸­è¿›è¡Œï¼Œä½†æ˜¯è€ƒè™‘åˆ°é£é™©ä»¥åŠå¯¹æ€§èƒ½å½±å“éƒ½æ¯”è¾ƒå¤§ï¼Œæ²¡æœ‰åœ¨çº¿ä¸Šä½¿ç”¨ã€‚æ‰€å¹¸ï¼Œé€šè¿‡ç›‘æ§å‘ç°ï¼Œè¿™ä¸ªé—®é¢˜å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œå‘ç”Ÿçš„æ¦‚ç‡å¹¶ä¸é«˜ã€‚å¦‚æœå‘ç°æŸä¸ªåœºæ™¯ä¸‹è¯¥é—®é¢˜ç¡®å®è¾ƒä¸ºä¸¥é‡ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ’æ¡©æˆ–è€…Java hookåœ¨æµ‹è¯•ç¯å¢ƒä¸‹debugè¯¥é—®é¢˜ã€‚ æ–¹æ¡ˆäºŒã€ä¾èµ– Choreographer æ¨¡å—ï¼Œç›‘æ§ç›¸é‚»ä¸¤æ¬¡ Vsync äº‹ä»¶é€šçŸ¥çš„æ—¶é—´å·®åˆ©ç”¨ç³»ç»Ÿ Choreographer æ¨¡å—ï¼Œå‘è¯¥æ¨¡å—æ³¨å†Œä¸€ä¸ª FrameCallback ç›‘å¬å¯¹è±¡ï¼ŒåŒæ—¶é€šè¿‡å¦å¤–ä¸€æ¡çº¿ç¨‹å¾ªç¯è®°å½•ä¸»çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼Œå¹¶åœ¨æ¯æ¬¡ Vsync äº‹ä»¶ doFrame é€šçŸ¥å›æ¥æ—¶ï¼Œå¾ªç¯æ³¨å†Œè¯¥ç›‘å¬å¯¹è±¡ï¼Œé—´æ¥ç»Ÿè®¡ä¸¤æ¬¡ Vsync äº‹ä»¶çš„æ—¶é—´é—´éš”ï¼Œå½“è¶…å‡ºé˜ˆå€¼æ—¶ï¼Œå–å‡ºè®°å½•çš„å †æ ˆè¿›è¡Œåˆ†æä¸ŠæŠ¥ã€‚ 12345678910Choreographer.getInstance().postFrameCallback(new Choreographer.FrameCallback() { @Override public void doFrame(long frameTimeNanos) { if(frameTimeNanos - mLastFrameNanos &gt; 100) { ... } mLastFrameNanos = frameTimeNanos; Choreographer.getInstance().postFrameCallback(this); }}); å¡é¡¿å‘ç”Ÿæ—¶å †æ ˆçš„æ”¶é›†BlocakCanaryï¼šåœ¨æ‰§è¡Œå‰åˆ©ç”¨å¦å¤–ä¸€æ¡çº¿ç¨‹ï¼Œé€šè¿‡ Thread#getStackTrace æ¥å£ï¼Œä»¥è½®è¯¢çš„æ–¹å¼è·å–ä¸»çº¿ç¨‹æ‰§è¡Œå †æ ˆä¿¡æ¯å¹¶è®°å½•èµ·æ¥ï¼ŒåŒæ—¶ç»Ÿè®¡æ¯æ¬¡ dispatchMessage æ–¹æ³•æ‰§è¡Œè€—æ—¶ï¼Œå½“è¶…å‡ºé˜ˆå€¼æ—¶ï¼Œå°†è¯¥æ¬¡è·å–çš„å †æ ˆè¿›è¡Œåˆ†æä¸ŠæŠ¥ï¼Œä»è€Œæ¥æ•æ‰å¡é¡¿ä¿¡æ¯ï¼Œå¦åˆ™ä¸¢å¼ƒæ­¤æ¬¡è®°å½•çš„å †æ ˆä¿¡æ¯ã€‚ Matrixï¼šæ ¹æ®ç¼–è¯‘æœŸæ’æ¡©è®°å½•å‡½æ•°è€—æ—¶ï¼Œåœ¨å¡é¡¿å‘ç”Ÿæ—¶è·å–ä¹‹å‰ä¸€æ®µæ—¶é—´çš„å‡½æ•°è¿›è¡Œå½’å †ï¼Œæ€§èƒ½æ›´ä½³ï¼Œ ä¸ä»…åœ¨ç¼–è¯‘æœŸæ—¶å¯¹ç‰¹æ®Šæ— éœ€æ’æ¡©å‡½æ•°æ’é™¤ï¼ˆæ–¹æ³•å­—èŠ‚ç ä¸­æ˜¯å¦åªåŒ…å«PUT/READ FIELDç­‰ç®€å•æŒ‡ä»¤ã€é»˜è®¤æˆ–åŒ¿åæ„é€ å‡½æ•°ï¼‰ã€æ’æ¡©å‡½æ•°ç”¨IDæ˜ å°„ è¿˜åœ¨è¿è¡ŒæœŸæ—¶ç”¨long[]æ•°ç»„è®°å½•å‡½æ•°idå’Œå‡½æ•°å‡½æ•°ï¼Œæå¤§ç¨‹åº¦çš„å‡å°‘å ç”¨å†…å­˜ã€å¦ä¸€ä¸ªçº¿ç¨‹æ¯5msæ›´æ–°æ—¶é—´å‡å°‘è°ƒç”¨System.nanoTimeçš„è€—æ—¶ Dokitï¼šä¹Ÿæ˜¯æ’æ¡©ï¼Œä½†ä¼˜åŒ–ä¸ç»†ã€‚ åŠ¨ç”»ä¼˜åŒ–ç®€è¿°ï¼šTODO å¯¹äºåŒæ ·æœºå™¨ç¯å¢ƒä¸Šçš„åº”ç”¨æ¥è¯´ï¼ŒæŠ›å»å—CPUã€å±å¹•å’Œç³»ç»ŸGUIç³»ç»Ÿçš„å›ºæœ‰æ—¶é—´æ¶ˆè€—å¤–ï¼Œè¦å®ç°æµç•…çš„åŠ¨ç”»çš„æ ¸å¿ƒä¹Ÿå°±æ˜¯å‡å°‘è§†å›¾Drawçš„æ—¶é—´ã€‚ è¿™é‡Œæœ‰å‡ ç‚¹ç»éªŒå¯ä»¥è·Ÿå¤§å®¶åˆ†äº«ä¸€ä¸‹ï¼š å°½é‡ä¸è¦åœ¨åˆ·æ–°æ—¶åšè€—æ—¶æ“ä½œï¼Œå¿…é¡»å‡†å¤‡æ•°æ®ï¼Œåˆ›å»ºå›¾ç‰‡ï¼Œå›¾ç‰‡å˜æ¢ç­‰ï¼Œæ•°æ®å’Œå›¾ç‰‡éƒ½åº”è¯¥åœ¨ä¹‹é—´å°±åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå›¾ç‰‡å˜æ¢ç”¨canvasçš„å˜æ¢æ¥å®ç°ã€‚ åŒä¸€ä¸ªç•Œé¢ä¸­å¤šä¸ªåŠ¨ç”»é‡å å‡ºç°æ—¶ï¼Œå°½é‡å°†åŠ¨ç”»çš„åˆ·æ–°è¿‡ç¨‹ç»Ÿä¸€è¿›è¡Œåˆ·æ–°ï¼Œé¿å…é¢‘ç¹çš„invalidateï¼Œå°¤å…¶æ˜¯å¤šä¸ªåŠ¨ç”»æœ‰æ—¶åºä¸Šçš„å…³ç³»æ—¶æ›´åº”è¯¥ç»Ÿä¸€ã€‚ å°½é‡ä½¿ç”¨å¸¦æœ‰å‚æ•°çš„invalidateæ¥åˆ·æ–°ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¾ˆå¤šè¿ç®—é‡ã€‚ åˆç†çš„ç¯å¢ƒä¸‹ä½¿ç”¨surfaceviewæ¥æ“ä½œï¼Œæ¯”å¦‚æ’­æ”¾è§†é¢‘ç­‰ï¼Œè¿™ç§åˆ·æ–°è€—æ—¶æ¯”è¾ƒå¤§çš„æƒ…å†µã€‚ å¼€å¯ç¡¬ä»¶åŠ é€Ÿï¼Œç¡¬ä»¶åŠ é€Ÿç”±äºé‡‡ç”¨äº†æ˜¾ç¤ºåˆ—è¡¨çš„æ¦‚å¿µï¼Œæ‰€ä»¥åˆ·æ–°è¿‡ç¨‹ä¹Ÿæœ‰å¾ˆå¤§çš„ä¼˜åŒ–ï¼Œä½†æ˜¯ä¼šå¢åŠ é¢å¤–çš„8Må†…å­˜å ç”¨ã€‚ Animationæµç•…åº¦åŠ¨ç”»çº¿ç¨‹ä¸­ï¼Œå°‘åšåŠ¨ç”»å¤–çš„äº‹æƒ…(æ¯”å¦‚æ‹–åŠ¨çš„æ—¶å€™åŒæ—¶åšäº†å›¾ç‰‡åŠ è½½ï¼Œæˆ–è¿›åº¦è½¬åœˆ)ï¼Œæˆ–ç”¨å­çº¿ç¨‹å»åšè¿™ä¸€ä»¶äº‹ï¼› å¤šä¸ªViewåšåŠ¨ç”»ï¼Œå˜æˆä¸€ä¸ªViewåšå¤šä¸ªåŠ¨ç”»ï¼Œä»è€Œå‡å°‘View Treeé€’å½’è°ƒç”¨ï¼›æ¶ˆå¤±çš„æˆ–ä¸åœ¨å±å¹•ä¸­çš„bgï¼Œviewä¸ç»˜åˆ¶ï¼Œå‡å°ç»˜åˆ¶é¢ç§¯(bgç»˜åˆ¶å‰ç”¨clipRectæ§åˆ¶)ï¼Œå‡å°ç¼“å­˜å°ºå¯¸ï¼› ä¸è¦ç”¨requestLayoutå®ç°åŠ¨ç”»ï¼Œç”¨çŸ©é˜µå˜æ¢ä»£æ›¿ï¼Œå°‘ç”¨clipPathå‰ªåˆ‡å›¾ç‰‡ï¼› ä¸è¦è®¾ç½®listviewçš„selectorï¼› åŠ¨ç”»æ—¶é—´æ§åˆ¶åœ¨400msä»¥å†…ï¼› åˆ©ç”¨å¥½ç¡¬ä»¶åŠ é€Ÿï¼› åŠ¨ç”»ç”¨nineoldandroidæˆ–è€…åœ¨å®ç°çš„æ—¶å€™å°½é‡æŠŠåŠ¨ç”»çš„ç»˜åˆ¶éƒ½æ”¾åˆ°ä¸€ä¸ªæ¶ˆæ¯å¾ªç¯é‡Œé¢ï¼› LayoutåŠ è½½é€Ÿåº¦ ç®€åŒ–åŠ¨ç”»å¸ƒå±€(åŒ…æ‹¬viewå±‚çº§å’Œæ•°é‡)ï¼Œä¸ç”¨çš„å¸ƒå±€å¯ä»¥ç”¨viewstubåŒ…ä½åœ¨ç”¨çš„æ—¶å€™inflateï¼› æå‰å°†å¸ƒå±€inflateä¼ å…¥ï¼Œè®°å¾—å¤„ç†staticå¼•ç”¨ï¼›","link":"/2021/10/19/%E5%8D%A1%E9%A1%BF%E7%9B%91%E6%8E%A7/"}],"tags":[{"name":"CoreProcess","slug":"CoreProcess","link":"/tags/CoreProcess/"},{"name":"Core","slug":"Core","link":"/tags/Core/"},{"name":"SystemService","slug":"SystemService","link":"/tags/SystemService/"},{"name":"Graphic","slug":"Graphic","link":"/tags/Graphic/"}],"categories":[{"name":"Android","slug":"Android","link":"/categories/Android/"},{"name":"Framework","slug":"Android/Framework","link":"/categories/Android/Framework/"},{"name":"Other","slug":"Android/Other","link":"/categories/Android/Other/"},{"name":"Common","slug":"Common","link":"/categories/Common/"},{"name":"BuildTool","slug":"Android/Other/BuildTool","link":"/categories/Android/Other/BuildTool/"},{"name":"JavaBasic","slug":"Common/JavaBasic","link":"/categories/Common/JavaBasic/"},{"name":"Code","slug":"Common/Code","link":"/categories/Common/Code/"},{"name":"ThirdPartyLib","slug":"Android/ThirdPartyLib","link":"/categories/Android/ThirdPartyLib/"},{"name":"Jvm","slug":"Common/Jvm","link":"/categories/Common/Jvm/"},{"name":"Network","slug":"Common/Network","link":"/categories/Common/Network/"},{"name":"Kotlin","slug":"Android/Kotlin","link":"/categories/Android/Kotlin/"},{"name":"AAC","slug":"Android/AAC","link":"/categories/Android/AAC/"}]}